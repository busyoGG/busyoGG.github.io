{"meta":{"title":"Busyo's Blog","subtitle":"Busyo çš„åšå®¢","description":"Busyo çš„åšå®¢ï¼Œåˆ†äº«è®°å½•ä¸Žæ€è€ƒ","author":"Busyo","url":"https://busyogg.github.io","root":"/"},"pages":[{"title":"æ‰€æœ‰åˆ†ç±»","date":"2023-08-24T10:07:23.840Z","updated":"2023-08-24T10:07:23.840Z","comments":true,"path":"categories/index.html","permalink":"https://busyogg.github.io/categories/index.html","excerpt":"","text":""},{"title":"","date":"2024-05-31T11:40:49.268Z","updated":"2024-05-31T11:40:49.268Z","comments":true,"path":"script/AfterProcess.js","permalink":"https://busyogg.github.io/script/AfterProcess.js","excerpt":"","text":"window.AfterProcess = { ResetCodeStyle: () => { var eles = document.getElementsByClassName(\"highlight\"); var colors = [\"#ed6a5e\", \"#f5bd4f\", \"#61c454\"]; for (let i = 0, len = eles.length; i < len; i++) { let child = eles[i].firstChild; //åˆ›å»ºæŒ‰é’® let customDiv = document.createElement(\"div\"); customDiv.style.display = \"flex\"; customDiv.style.height = \"40px\"; customDiv.style.width = \"100%\"; for (let j = 0; j < 3; j++) { let btn = document.createElement(\"div\"); btn.style.backgroundColor = colors[j]; btn.style.height = \"20px\"; btn.style.width = \"20px\"; btn.style.border = \"1px solid \" + colors[j]; btn.style.borderRadius = \"10px\"; btn.style.margin = \"10px 5px 10px 5px\"; customDiv.appendChild(btn); } console.log(\"æ˜¯å¦åŒ¹é…\", child.nodeName); if (child.nodeName != \"FIGCAPTION\") { //æ²¡æœ‰æ ‡é¢˜ eles[i].insertBefore(customDiv, child); } else { eles[i].replaceChild(customDiv, child); //æœ‰æ ‡é¢˜ let p = document.createElement(\"p\"); p.style.width = customDiv.offsetWidth - 40 * 3 + \"px\"; p.style.height = \"40px\"; p.style.textAlign = \"center\"; p.style.margin = \"0px\"; p.style.lineHeight = \"40px\"; p.innerText = child.firstChild.innerText; p.style.fontSize = \"20px\"; customDiv.appendChild(p); } } }, ResetTitle: () => { let colors = { H1: \"#61c454\", H2: \"#61c454\", H3: \"#f5bd4f\", H4: \"#ed6a5e\", H5: \"#e40056\", H6: \"#029ae2\", }; var eles = document.querySelectorAll(\"h1,h2,h3,h4,h5,h6\"); var picker = window.getComputedStyle; for (let i = 1, len = eles.length; i < len; i++) { let child = eles[i].firstChild; let eleStyle = picker(eles[i]); //åˆ›å»ºæ ‡è¯† let customDiv = document.createElement(\"div\"); customDiv.style.display = \"flex\"; customDiv.style.width = \"15px\"; customDiv.style.backgroundColor = colors[eles[i].tagName]; customDiv.style.height = eleStyle.fontSize; customDiv.style.marginRight = \"10px\"; customDiv.style.marginTop = (parseFloat(eleStyle.lineHeight) - parseFloat(eleStyle.fontSize)) * 0.5 + \"px\"; customDiv.style.borderRadius = \"5px\"; // console.log(\"å­—ä½“å¤§å°\",eleStyle.fontSize,parseFloat(eleStyle.lineHeight),parseFloat(eleStyle.fontSize)) // customDiv.style.verticalAlign eles[i].style.display = \"flex\"; eles[i].style.verticalAlign = \"center\"; eles[i].insertBefore(customDiv, child); } }, InitVideo: () => { let videos = document.getElementsByTagName(\"video\"); for (let index = 0; index < videos.length; index++) { let ele = videos[index]; let player = new Plyr(ele, { controls: [ \"play-large\", // The large play button in the center \"play\", // Play/pause playback \"restart\", // Restart playback \"progress\", // The progress bar and scrubber for playback and buffering \"current-time\", // The current time of playback \"duration\", // The full duration of the media \"mute\", // Toggle mute \"volume\", // Volume control \"captions\", // Toggle captions \"settings\", // Settings menu \"pip\", // Picture-in-picture (currently Safari only) \"airplay\", // Airplay (currently Safari only) \"download\", // Show a download button with a link to either the current source or a custom URL you specify in your options \"fullscreen\", // Toggle fullscreen ], }); } // ç›‘å¬å…¨å±çŠ¶æ€å˜åŒ– document.addEventListener(\"fullscreenchange\", handleFullscreenChange); document.addEventListener(\"webkitfullscreenchange\", handleFullscreenChange); document.addEventListener(\"mozfullscreenchange\", handleFullscreenChange); document.addEventListener(\"MSFullscreenChange\", handleFullscreenChange); function handleFullscreenChange() { var fullscreenElement = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement; if (fullscreenElement) { // fullscreenStateDiv.textContent = 'å½“å‰æ˜¯å…¨å±çŠ¶æ€'; for (let index = 0; index < videos.length; index++) { let ele = videos[index]; ele.classList.add(\"full-screen\"); } } else { // fullscreenStateDiv.textContent = 'å½“å‰ä¸æ˜¯å…¨å±çŠ¶æ€'; for (let index = 0; index < videos.length; index++) { let ele = videos[index]; ele.classList.remove(\"full-screen\"); } } } }, Init: () => { console.log(\"åˆå§‹åŒ–ç•Œé¢\"); AfterProcess.ResetCodeStyle(); AfterProcess.ResetTitle(); AfterProcess.InitVideo(); mermaid.init(undefined, \".mermaid\"); }, }; AfterProcess.Init();"},{"title":"","date":"2024-06-01T08:34:42.897Z","updated":"2024-06-01T08:34:42.897Z","comments":true,"path":"script/HomeScript.js","permalink":"https://busyogg.github.io/script/HomeScript.js","excerpt":"","text":"window.HomeScript = { InitCard: () => { var targetDiv = document.getElementsByClassName(\"post-wrapper\"); for (var i = 0; i < targetDiv.length; i++) { var element = targetDiv[i]; element.classList.add(\"card-ani\"); var targetDivTop = element.getBoundingClientRect().top; if (targetDivTop < window.innerHeight + 260) { // å½“ç›®æ ‡divè¿›å…¥è§†å£æ—¶ï¼Œæ·»åŠ åŠ¨ç”»æ•ˆæžœ // element.classList.add(\"animated\"); element.classList.add(\"card-in\"); } else { // å½“ç›®æ ‡divç¦»å¼€è§†å£æ—¶ï¼Œç§»é™¤åŠ¨ç”»æ•ˆæžœ // element.classList.remove(\"animated\"); element.classList.remove(\"card-in\"); } } }, CardAni: () => { var targetDiv = document.getElementsByClassName(\"post-wrapper\"); for (var i = 0; i < targetDiv.length; i++) { var element = targetDiv[i]; var targetDivTop = element.getBoundingClientRect().top; // if (targetDivTop < window.innerHeight) { // // å½“ç›®æ ‡divè¿›å…¥è§†å£æ—¶ï¼Œæ·»åŠ åŠ¨ç”»æ•ˆæžœ // // element.classList.add(\"animated\"); // element.classList.add(\"card-in\"); // } else { // // å½“ç›®æ ‡divç¦»å¼€è§†å£æ—¶ï¼Œç§»é™¤åŠ¨ç”»æ•ˆæžœ // // element.classList.remove(\"animated\"); // element.classList.remove(\"card-in\"); // } if (targetDivTop >= window.innerHeight) { element.classList.remove(\"card-in\"); } else { element.classList.add(\"card-in\"); } } }, Init: () => { HomeScript.InitCard(); window.removeEventListener(\"scroll\", HomeScript.CardAni); window.addEventListener(\"scroll\", HomeScript.CardAni); }, }; HomeScript.Init();"},{"title":"","date":"2024-06-01T09:08:33.097Z","updated":"2024-06-01T09:08:33.097Z","comments":true,"path":"script/NavBarScript.js","permalink":"https://busyogg.github.io/script/NavBarScript.js","excerpt":"","text":"window.NavBarScript = { obj: null, InitLock: () => { var isLock = localStorage.getItem(\"isLock\") || false; var ele = document.getElementsByClassName(\"head-bar\")[0]; var head = document.getElementsByClassName(\"l_header\")[0]; if (isLock == \"true\") { ele.classList.remove(\"head-bar-hover\"); head.classList.remove(\"l_header-hover\"); ele.classList.add(\"head-bar-focus\"); obj.innerHTML = \"ðŸ”’\"; } else { ele.classList.add(\"head-bar-hover\"); head.classList.add(\"l_header-hover\"); ele.classList.remove(\"head-bar-focus\"); obj.innerHTML = \"ðŸ”“\"; } console.log(\"åˆå§‹åŒ–\", isLock); }, ChangeLock: () => { var isLock = localStorage.getItem(\"isLock\") || false; console.log(\"åˆ‡æ¢\"); var ele = document.getElementsByClassName(\"head-bar\")[0]; var head = document.getElementsByClassName(\"l_header\")[0]; if (isLock == \"false\") { ele.classList.remove(\"head-bar-hover\"); head.classList.remove(\"l_header-hover\"); ele.classList.add(\"head-bar-focus\"); obj.innerHTML = \"ðŸ”’\"; } else { ele.classList.add(\"head-bar-hover\"); head.classList.add(\"l_header-hover\"); ele.classList.remove(\"head-bar-focus\"); obj.innerHTML = \"ðŸ”“\"; } isLock = isLock == \"false\" ? \"true\" : \"false\"; console.log(isLock); localStorage.setItem(\"isLock\", isLock); }, Init: () => { obj = document.getElementsByClassName(\"lock-emoji\")[0]; NavBarScript.InitLock(); obj.addEventListener(\"click\", () => { NavBarScript.ChangeLock(); }); }, }; NavBarScript.Init();"},{"title":"","date":"2023-08-31T17:58:45.623Z","updated":"2023-08-31T17:58:45.623Z","comments":true,"path":"script/marked.min.js","permalink":"https://busyogg.github.io/script/marked.min.js","excerpt":"","text":"/** * marked v4.3.0 - a markdown parser * Copyright (c) 2011-2023, Christopher Jeffrey. (MIT Licensed) * https://github.com/markedjs/marked */ !function(e,t){\"object\"==typeof exports&&\"undefined\"!=typeof module?t(exports):\"function\"==typeof define&&define.amd?define([\"exports\"],t):t((e=\"undefined\"!=typeof globalThis?globalThis:e||self).marked={})}(this,function(r){\"use strict\";function i(e,t){for(var u=0;u"},{"title":"æ‰€æœ‰æ ‡ç­¾","date":"2023-08-24T10:08:12.138Z","updated":"2023-08-24T10:08:12.138Z","comments":true,"path":"tags/index.html","permalink":"https://busyogg.github.io/tags/index.html","excerpt":"","text":""},{"title":"","date":"2024-01-29T17:35:51.351Z","updated":"2024-01-29T17:35:51.351Z","comments":true,"path":"script/plyr.js","permalink":"https://busyogg.github.io/script/plyr.js","excerpt":"","text":"\"object\"==typeof navigator&&function(e,t){\"object\"==typeof exports&&\"undefined\"!=typeof module?module.exports=t():\"function\"==typeof define&&define.amd?define(\"Plyr\",t):(e=\"undefined\"!=typeof globalThis?globalThis:e||self).Plyr=t()}(this,(function(){\"use strict\";!function(){if(\"undefined\"!=typeof window)try{var e=new window.CustomEvent(\"test\",{cancelable:!0});if(e.preventDefault(),!0!==e.defaultPrevented)throw new Error(\"Could not prevent default\")}catch(e){var t=function(e,t){var i,s;return(t=t||{}).bubbles=!!t.bubbles,t.cancelable=!!t.cancelable,(i=document.createEvent(\"CustomEvent\")).initCustomEvent(e,t.bubbles,t.cancelable,t.detail),s=i.preventDefault,i.preventDefault=function(){s.call(this);try{Object.defineProperty(this,\"defaultPrevented\",{get:function(){return!0}})}catch(e){this.defaultPrevented=!0}},i};t.prototype=window.Event.prototype,window.CustomEvent=t}}();var e=\"undefined\"!=typeof globalThis?globalThis:\"undefined\"!=typeof window?window:\"undefined\"!=typeof global?global:\"undefined\"!=typeof self?self:{};function t(e,t,i){return(t=function(e){var t=function(e,t){if(\"object\"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var s=i.call(e,t||\"default\");if(\"object\"!=typeof s)return s;throw new TypeError(\"@@toPrimitive must return a primitive value.\")}return(\"string\"===t?String:Number)(e)}(e,\"string\");return\"symbol\"==typeof t?t:String(t)}(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function i(e,t){for(var i=0;i\"function\"==typeof e,E=e=>Array.isArray(e),C=e=>b(e,NodeList),S=e=>v(e)||(T(e)||E(e)||C(e))&&!e.length||w(e)&&!Object.keys(e).length;var A={nullOrUndefined:v,object:w,number:e=>y(e)===Number&&!Number.isNaN(e),string:T,boolean:e=>y(e)===Boolean,function:k,array:E,weakMap:e=>b(e,WeakMap),nodeList:C,element:e=>null!==e&&\"object\"==typeof e&&1===e.nodeType&&\"object\"==typeof e.style&&\"object\"==typeof e.ownerDocument,textNode:e=>y(e)===Text,event:e=>b(e,Event),keyboardEvent:e=>b(e,KeyboardEvent),cue:e=>b(e,window.TextTrackCue)||b(e,window.VTTCue),track:e=>b(e,TextTrack)||!v(e)&&T(e.kind),promise:e=>b(e,Promise)&&k(e.then),url:e=>{if(b(e,window.URL))return!0;if(!T(e))return!1;let t=e;e.startsWith(\"http://\")&&e.startsWith(\"https://\")||(t=`http://${e}`);try{return!S(new URL(t).hostname)}catch(e){return!1}},empty:S};const P=(()=>{const e=document.createElement(\"span\"),t={WebkitTransition:\"webkitTransitionEnd\",MozTransition:\"transitionend\",OTransition:\"oTransitionEnd otransitionend\",transition:\"transitionend\"},i=Object.keys(t).find((t=>void 0!==e.style[t]));return!!A.string(i)&&t[i]})();function M(e,t){setTimeout((()=>{try{e.hidden=!0,e.offsetHeight,e.hidden=!1}catch(e){}}),t)}var x={isIE:Boolean(window.document.documentMode),isEdge:/Edge/g.test(navigator.userAgent),isWebKit:\"WebkitAppearance\"in document.documentElement.style&&!/Edge/g.test(navigator.userAgent),isIPhone:/iPhone|iPod/gi.test(navigator.userAgent)&&navigator.maxTouchPoints>1,isIPadOS:\"MacIntel\"===navigator.platform&&navigator.maxTouchPoints>1,isIos:/iPad|iPhone|iPod/gi.test(navigator.userAgent)&&navigator.maxTouchPoints>1};function L(e,t){return t.split(\".\").reduce(((e,t)=>e&&e[t]),e)}function N(e={},...t){if(!t.length)return e;const i=t.shift();return A.object(i)?(Object.keys(i).forEach((t=>{A.object(i[t])?(Object.keys(e).includes(t)||Object.assign(e,{[t]:{}}),N(e[t],i[t])):Object.assign(e,{[t]:i[t]})})),N(e,...t)):e}function _(e,t){const i=e.length?e:[e];Array.from(i).reverse().forEach(((e,i)=>{const s=i>0?t.cloneNode(!0):t,n=e.parentNode,a=e.nextSibling;s.appendChild(e),a?n.insertBefore(s,a):n.appendChild(s)}))}function I(e,t){A.element(e)&&!A.empty(t)&&Object.entries(t).filter((([,e])=>!A.nullOrUndefined(e))).forEach((([t,i])=>e.setAttribute(t,i)))}function O(e,t,i){const s=document.createElement(e);return A.object(t)&&I(s,t),A.string(i)&&(s.innerText=i),s}function $(e,t,i,s){A.element(t)&&t.appendChild(O(e,i,s))}function j(e){A.nodeList(e)||A.array(e)?Array.from(e).forEach(j):A.element(e)&&A.element(e.parentNode)&&e.parentNode.removeChild(e)}function R(e){if(!A.element(e))return;let{length:t}=e.childNodes;for(;t>0;)e.removeChild(e.lastChild),t-=1}function D(e,t){return A.element(t)&&A.element(t.parentNode)&&A.element(e)?(t.parentNode.replaceChild(e,t),e):null}function q(e,t){if(!A.string(e)||A.empty(e))return{};const i={},s=N({},t);return e.split(\",\").forEach((e=>{const t=e.trim(),n=t.replace(\".\",\"\"),a=t.replace(/[[\\]]/g,\"\").split(\"=\"),[r]=a,o=a.length>1?a[1].replace(/[\"']/g,\"\"):\"\";switch(t.charAt(0)){case\".\":A.string(s.class)?i.class=`${s.class} ${n}`:i.class=n;break;case\"#\":i.id=t.replace(\"#\",\"\");break;case\"[\":i[r]=o}})),N(s,i)}function H(e,t){if(!A.element(e))return;let i=t;A.boolean(i)||(i=!e.hidden),e.hidden=i}function F(e,t,i){if(A.nodeList(e))return Array.from(e).map((e=>F(e,t,i)));if(A.element(e)){let s=\"toggle\";return void 0!==i&&(s=i?\"add\":\"remove\"),e.classList[s](t),e.classList.contains(t)}return!1}function U(e,t){return A.element(e)&&e.classList.contains(t)}function V(e,t){const{prototype:i}=Element;return(i.matches||i.webkitMatchesSelector||i.mozMatchesSelector||i.msMatchesSelector||function(){return Array.from(document.querySelectorAll(t)).includes(this)}).call(e,t)}function B(e){return this.elements.container.querySelectorAll(e)}function W(e){return this.elements.container.querySelector(e)}function z(e=null,t=!1){A.element(e)&&e.focus({preventScroll:!0,focusVisible:t})}const K={\"audio/ogg\":\"vorbis\",\"audio/wav\":\"1\",\"video/webm\":\"vp8, vorbis\",\"video/mp4\":\"avc1.42E01E, mp4a.40.2\",\"video/ogg\":\"theora\"},Y={audio:\"canPlayType\"in document.createElement(\"audio\"),video:\"canPlayType\"in document.createElement(\"video\"),check(e,t){const i=Y[e]||\"html5\"!==t;return{api:i,ui:i&&Y.rangeInput}},pip:!(x.isIPhone||!A.function(O(\"video\").webkitSetPresentationMode)&&(!document.pictureInPictureEnabled||O(\"video\").disablePictureInPicture)),airplay:A.function(window.WebKitPlaybackTargetAvailabilityEvent),playsinline:\"playsInline\"in document.createElement(\"video\"),mime(e){if(A.empty(e))return!1;const[t]=e.split(\"/\");let i=e;if(!this.isHTML5||t!==this.type)return!1;Object.keys(K).includes(i)&&(i+=`; codecs=\"${K[e]}\"`);try{return Boolean(i&&this.media.canPlayType(i).replace(/no/,\"\"))}catch(e){return!1}},textTracks:\"textTracks\"in document.createElement(\"video\"),rangeInput:(()=>{const e=document.createElement(\"input\");return e.type=\"range\",\"range\"===e.type})(),touch:\"ontouchstart\"in document.documentElement,transitions:!1!==P,reducedMotion:\"matchMedia\"in window&&window.matchMedia(\"(prefers-reduced-motion)\").matches},Q=(()=>{let e=!1;try{const t=Object.defineProperty({},\"passive\",{get:()=>(e=!0,null)});window.addEventListener(\"test\",null,t),window.removeEventListener(\"test\",null,t)}catch(e){}return e})();function X(e,t,i,s=!1,n=!0,a=!1){if(!e||!(\"addEventListener\"in e)||A.empty(t)||!A.function(i))return;const r=t.split(\" \");let o=a;Q&&(o={passive:n,capture:a}),r.forEach((t=>{this&&this.eventListeners&&s&&this.eventListeners.push({element:e,type:t,callback:i,options:o}),e[s?\"addEventListener\":\"removeEventListener\"](t,i,o)}))}function J(e,t=\"\",i,s=!0,n=!1){X.call(this,e,t,i,!0,s,n)}function G(e,t=\"\",i,s=!0,n=!1){X.call(this,e,t,i,!1,s,n)}function Z(e,t=\"\",i,s=!0,n=!1){const a=(...r)=>{G(e,t,a,s,n),i.apply(this,r)};X.call(this,e,t,a,!0,s,n)}function ee(e,t=\"\",i=!1,s={}){if(!A.element(e)||A.empty(t))return;const n=new CustomEvent(t,{bubbles:i,detail:{...s,plyr:this}});e.dispatchEvent(n)}function te(){this&&this.eventListeners&&(this.eventListeners.forEach((e=>{const{element:t,type:i,callback:s,options:n}=e;t.removeEventListener(i,s,n)})),this.eventListeners=[])}function ie(){return new Promise((e=>this.ready?setTimeout(e,0):J.call(this,this.elements.container,\"ready\",e))).then((()=>{}))}function se(e){A.promise(e)&&e.then(null,(()=>{}))}function ne(e){return A.array(e)?e.filter(((t,i)=>e.indexOf(t)===i)):e}function ae(e,t){return A.array(e)&&e.length?e.reduce(((e,i)=>Math.abs(i-t)({...e,[t/i]:[t,i]})),{});function le(e){if(!(A.array(e)||A.string(e)&&e.includes(\":\")))return!1;return(A.array(e)?e:e.split(\":\")).map(Number).every(A.number)}function ce(e){if(!A.array(e)||!e.every(A.number))return null;const[t,i]=e,s=(e,t)=>0===t?e:s(t,e%t),n=s(t,i);return[t/n,i/n]}function ue(e){const t=e=>le(e)?e.split(\":\").map(Number):null;let i=t(e);if(null===i&&(i=t(this.config.ratio)),null===i&&!A.empty(this.embed)&&A.array(this.embed.ratio)&&({ratio:i}=this.embed),null===i&&this.isHTML5){const{videoWidth:e,videoHeight:t}=this.media;i=[e,t]}return ce(i)}function he(e){if(!this.isVideo)return{};const{wrapper:t}=this.elements,i=ue.call(this,e);if(!A.array(i))return{};const[s,n]=ce(i),a=100/s*n;if(re(`aspect-ratio: ${s}/${n}`)?t.style.aspectRatio=`${s}/${n}`:t.style.paddingBottom=`${a}%`,this.isVimeo&&!this.config.vimeo.premium&&this.supported.ui){const e=100/this.media.offsetWidth*parseInt(window.getComputedStyle(this.media).paddingBottom,10),i=(e-a)/(e/50);this.fullscreen.active?t.style.paddingBottom=null:this.media.style.transform=`translateY(-${i}%)`}else this.isHTML5&&t.classList.add(this.config.classNames.videoFixedRatio);return{padding:a,ratio:i}}function de(e,t,i=.05){const s=e/t,n=ae(Object.keys(oe),s);return Math.abs(n-s){const t=e.getAttribute(\"type\");return!!A.empty(t)||Y.mime.call(this,t)}))},getQualityOptions(){return this.config.quality.forced?this.config.quality.options:me.getSources.call(this).map((e=>Number(e.getAttribute(\"size\")))).filter(Boolean)},setup(){if(!this.isHTML5)return;const e=this;e.options.speed=e.config.speed.options,A.empty(this.config.ratio)||he.call(e),Object.defineProperty(e.media,\"quality\",{get(){const t=me.getSources.call(e).find((t=>t.getAttribute(\"src\")===e.source));return t&&Number(t.getAttribute(\"size\"))},set(t){if(e.quality!==t){if(e.config.quality.forced&&A.function(e.config.quality.onChange))e.config.quality.onChange(t);else{const i=me.getSources.call(e).find((e=>Number(e.getAttribute(\"size\"))===t));if(!i)return;const{currentTime:s,paused:n,preload:a,readyState:r,playbackRate:o}=e.media;e.media.src=i.getAttribute(\"src\"),(\"none\"!==a||r)&&(e.once(\"loadedmetadata\",(()=>{e.speed=o,e.currentTime=s,n||se(e.play())})),e.media.load())}ee.call(e,e.media,\"qualitychange\",!1,{quality:t})}}})},cancelRequests(){this.isHTML5&&(j(me.getSources.call(this)),this.media.setAttribute(\"src\",this.config.blankVideo),this.media.load(),this.debug.log(\"Cancelled network requests\"))}};function pe(e,...t){return A.empty(e)?e:e.toString().replace(/{(\\d+)}/g,((e,i)=>t[i].toString()))}const ge=(e=\"\",t=\"\",i=\"\")=>e.replace(new RegExp(t.toString().replace(/([.*+?^=!:${}()|[\\]/\\\\])/g,\"\\\\$1\"),\"g\"),i.toString()),fe=(e=\"\")=>e.toString().replace(/\\w\\S*/g,(e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()));function ye(e=\"\"){let t=e.toString();return t=function(e=\"\"){let t=e.toString();return t=ge(t,\"-\",\" \"),t=ge(t,\"_\",\" \"),t=fe(t),ge(t,\" \",\"\")}(t),t.charAt(0).toLowerCase()+t.slice(1)}function be(e){const t=document.createElement(\"div\");return t.appendChild(e),t.innerHTML}const ve={pip:\"PIP\",airplay:\"AirPlay\",html5:\"HTML5\",vimeo:\"Vimeo\",youtube:\"YouTube\"},we={get(e=\"\",t={}){if(A.empty(e)||A.empty(t))return\"\";let i=L(t.i18n,e);if(A.empty(i))return Object.keys(ve).includes(e)?ve[e]:\"\";const s={\"{seektime}\":t.seekTime,\"{title}\":t.title};return Object.entries(s).forEach((([e,t])=>{i=ge(i,e,t)})),i}};class Te{constructor(e){t(this,\"get\",(e=>{if(!Te.supported||!this.enabled)return null;const t=window.localStorage.getItem(this.key);if(A.empty(t))return null;const i=JSON.parse(t);return A.string(e)&&e.length?i[e]:i})),t(this,\"set\",(e=>{if(!Te.supported||!this.enabled)return;if(!A.object(e))return;let t=this.get();A.empty(t)&&(t={}),N(t,e);try{window.localStorage.setItem(this.key,JSON.stringify(t))}catch(e){}})),this.enabled=e.config.storage.enabled,this.key=e.config.storage.key}static get supported(){try{if(!(\"localStorage\"in window))return!1;const e=\"___test\";return window.localStorage.setItem(e,e),window.localStorage.removeItem(e),!0}catch(e){return!1}}}function ke(e,t=\"text\"){return new Promise(((i,s)=>{try{const s=new XMLHttpRequest;if(!(\"withCredentials\"in s))return;s.addEventListener(\"load\",(()=>{if(\"text\"===t)try{i(JSON.parse(s.responseText))}catch(e){i(s.responseText)}else i(s.response)})),s.addEventListener(\"error\",(()=>{throw new Error(s.status)})),s.open(\"GET\",e,!0),s.responseType=t,s.send()}catch(e){s(e)}}))}function Ee(e,t){if(!A.string(e))return;const i=\"cache\",s=A.string(t);let n=!1;const a=()=>null!==document.getElementById(t),r=(e,t)=>{e.innerHTML=t,s&&a()||document.body.insertAdjacentElement(\"afterbegin\",e)};if(!s||!a()){const a=Te.supported,o=document.createElement(\"div\");if(o.setAttribute(\"hidden\",\"\"),s&&o.setAttribute(\"id\",t),a){const e=window.localStorage.getItem(`${i}-${t}`);if(n=null!==e,n){const t=JSON.parse(e);r(o,t.content)}}ke(e).then((e=>{if(!A.empty(e)){if(a)try{window.localStorage.setItem(`${i}-${t}`,JSON.stringify({content:e}))}catch(e){}r(o,e)}})).catch((()=>{}))}}const Ce=e=>Math.trunc(e/60/60%60,10),Se=e=>Math.trunc(e/60%60,10),Ae=e=>Math.trunc(e%60,10);function Pe(e=0,t=!1,i=!1){if(!A.number(e))return Pe(void 0,t,i);const s=e=>`0${e}`.slice(-2);let n=Ce(e);const a=Se(e),r=Ae(e);return n=t||n>0?`${n}:`:\"\",`${i&&e>0?\"-\":\"\"}${n}${s(a)}:${s(r)}`}const Me={getIconUrl(){const e=new URL(this.config.iconUrl,window.location),t=window.location.host?window.location.host:window.top.location.host,i=e.host!==t||x.isIE&&!window.svg4everybody;return{url:this.config.iconUrl,cors:i}},findElements(){try{return this.elements.controls=W.call(this,this.config.selectors.controls.wrapper),this.elements.buttons={play:B.call(this,this.config.selectors.buttons.play),pause:W.call(this,this.config.selectors.buttons.pause),restart:W.call(this,this.config.selectors.buttons.restart),rewind:W.call(this,this.config.selectors.buttons.rewind),fastForward:W.call(this,this.config.selectors.buttons.fastForward),mute:W.call(this,this.config.selectors.buttons.mute),pip:W.call(this,this.config.selectors.buttons.pip),airplay:W.call(this,this.config.selectors.buttons.airplay),settings:W.call(this,this.config.selectors.buttons.settings),captions:W.call(this,this.config.selectors.buttons.captions),fullscreen:W.call(this,this.config.selectors.buttons.fullscreen)},this.elements.progress=W.call(this,this.config.selectors.progress),this.elements.inputs={seek:W.call(this,this.config.selectors.inputs.seek),volume:W.call(this,this.config.selectors.inputs.volume)},this.elements.display={buffer:W.call(this,this.config.selectors.display.buffer),currentTime:W.call(this,this.config.selectors.display.currentTime),duration:W.call(this,this.config.selectors.display.duration)},A.element(this.elements.progress)&&(this.elements.display.seekTooltip=this.elements.progress.querySelector(`.${this.config.classNames.tooltip}`)),!0}catch(e){return this.debug.warn(\"It looks like there is a problem with your custom controls HTML\",e),this.toggleNativeControls(!0),!1}},createIcon(e,t){const i=\"http://www.w3.org/2000/svg\",s=Me.getIconUrl.call(this),n=`${s.cors?\"\":s.url}#${this.config.iconPrefix}`,a=document.createElementNS(i,\"svg\");I(a,N(t,{\"aria-hidden\":\"true\",focusable:\"false\"}));const r=document.createElementNS(i,\"use\"),o=`${n}-${e}`;return\"href\"in r&&r.setAttributeNS(\"http://www.w3.org/1999/xlink\",\"href\",o),r.setAttributeNS(\"http://www.w3.org/1999/xlink\",\"xlink:href\",o),a.appendChild(r),a},createLabel(e,t={}){const i=we.get(e,this.config);return O(\"span\",{...t,class:[t.class,this.config.classNames.hidden].filter(Boolean).join(\" \")},i)},createBadge(e){if(A.empty(e))return null;const t=O(\"span\",{class:this.config.classNames.menu.value});return t.appendChild(O(\"span\",{class:this.config.classNames.menu.badge},e)),t},createButton(e,t){const i=N({},t);let s=ye(e);const n={element:\"button\",toggle:!1,label:null,icon:null,labelPressed:null,iconPressed:null};switch([\"element\",\"icon\",\"label\"].forEach((e=>{Object.keys(i).includes(e)&&(n[e]=i[e],delete i[e])})),\"button\"!==n.element||Object.keys(i).includes(\"type\")||(i.type=\"button\"),Object.keys(i).includes(\"class\")?i.class.split(\" \").some((e=>e===this.config.classNames.control))||N(i,{class:`${i.class} ${this.config.classNames.control}`}):i.class=this.config.classNames.control,e){case\"play\":n.toggle=!0,n.label=\"play\",n.labelPressed=\"pause\",n.icon=\"play\",n.iconPressed=\"pause\";break;case\"mute\":n.toggle=!0,n.label=\"mute\",n.labelPressed=\"unmute\",n.icon=\"volume\",n.iconPressed=\"muted\";break;case\"captions\":n.toggle=!0,n.label=\"enableCaptions\",n.labelPressed=\"disableCaptions\",n.icon=\"captions-off\",n.iconPressed=\"captions-on\";break;case\"fullscreen\":n.toggle=!0,n.label=\"enterFullscreen\",n.labelPressed=\"exitFullscreen\",n.icon=\"enter-fullscreen\",n.iconPressed=\"exit-fullscreen\";break;case\"play-large\":i.class+=` ${this.config.classNames.control}--overlaid`,s=\"play\",n.label=\"play\",n.icon=\"play\";break;default:A.empty(n.label)&&(n.label=s),A.empty(n.icon)&&(n.icon=e)}const a=O(n.element);return n.toggle?(a.appendChild(Me.createIcon.call(this,n.iconPressed,{class:\"icon--pressed\"})),a.appendChild(Me.createIcon.call(this,n.icon,{class:\"icon--not-pressed\"})),a.appendChild(Me.createLabel.call(this,n.labelPressed,{class:\"label--pressed\"})),a.appendChild(Me.createLabel.call(this,n.label,{class:\"label--not-pressed\"}))):(a.appendChild(Me.createIcon.call(this,n.icon)),a.appendChild(Me.createLabel.call(this,n.label))),N(i,q(this.config.selectors.buttons[s],i)),I(a,i),\"play\"===s?(A.array(this.elements.buttons[s])||(this.elements.buttons[s]=[]),this.elements.buttons[s].push(a)):this.elements.buttons[s]=a,a},createRange(e,t){const i=O(\"input\",N(q(this.config.selectors.inputs[e]),{type:\"range\",min:0,max:100,step:.01,value:0,autocomplete:\"off\",role:\"slider\",\"aria-label\":we.get(e,this.config),\"aria-valuemin\":0,\"aria-valuemax\":100,\"aria-valuenow\":0},t));return this.elements.inputs[e]=i,Me.updateRangeFill.call(this,i),f.setup(i),i},createProgress(e,t){const i=O(\"progress\",N(q(this.config.selectors.display[e]),{min:0,max:100,value:0,role:\"progressbar\",\"aria-hidden\":!0},t));if(\"volume\"!==e){i.appendChild(O(\"span\",null,\"0\"));const t={played:\"played\",buffer:\"buffered\"}[e],s=t?we.get(t,this.config):\"\";i.innerText=`% ${s.toLowerCase()}`}return this.elements.display[e]=i,i},createTime(e,t){const i=q(this.config.selectors.display[e],t),s=O(\"div\",N(i,{class:`${i.class?i.class:\"\"} ${this.config.classNames.display.time} `.trim(),\"aria-label\":we.get(e,this.config),role:\"timer\"}),\"00:00\");return this.elements.display[e]=s,s},bindMenuItemShortcuts(e,t){J.call(this,e,\"keydown keyup\",(i=>{if(![\" \",\"ArrowUp\",\"ArrowDown\",\"ArrowRight\"].includes(i.key))return;if(i.preventDefault(),i.stopPropagation(),\"keydown\"===i.type)return;const s=V(e,'[role=\"menuitemradio\"]');if(!s&&[\" \",\"ArrowRight\"].includes(i.key))Me.showMenuPanel.call(this,t,!0);else{let t;\" \"!==i.key&&(\"ArrowDown\"===i.key||s&&\"ArrowRight\"===i.key?(t=e.nextElementSibling,A.element(t)||(t=e.parentNode.firstElementChild)):(t=e.previousElementSibling,A.element(t)||(t=e.parentNode.lastElementChild)),z.call(this,t,!0))}}),!1),J.call(this,e,\"keyup\",(e=>{\"Return\"===e.key&&Me.focusFirstMenuItem.call(this,null,!0)}))},createMenuItem({value:e,list:t,type:i,title:s,badge:n=null,checked:a=!1}){const r=q(this.config.selectors.inputs[i]),o=O(\"button\",N(r,{type:\"button\",role:\"menuitemradio\",class:`${this.config.classNames.control} ${r.class?r.class:\"\"}`.trim(),\"aria-checked\":a,value:e})),l=O(\"span\");l.innerHTML=s,A.element(n)&&l.appendChild(n),o.appendChild(l),Object.defineProperty(o,\"checked\",{enumerable:!0,get:()=>\"true\"===o.getAttribute(\"aria-checked\"),set(e){e&&Array.from(o.parentNode.children).filter((e=>V(e,'[role=\"menuitemradio\"]'))).forEach((e=>e.setAttribute(\"aria-checked\",\"false\"))),o.setAttribute(\"aria-checked\",e?\"true\":\"false\")}}),this.listeners.bind(o,\"click keyup\",(t=>{if(!A.keyboardEvent(t)||\" \"===t.key){switch(t.preventDefault(),t.stopPropagation(),o.checked=!0,i){case\"language\":this.currentTrack=Number(e);break;case\"quality\":this.quality=e;break;case\"speed\":this.speed=parseFloat(e)}Me.showMenuPanel.call(this,\"home\",A.keyboardEvent(t))}}),i,!1),Me.bindMenuItemShortcuts.call(this,o,i),t.appendChild(o)},formatTime(e=0,t=!1){if(!A.number(e))return e;return Pe(e,Ce(this.duration)>0,t)},updateTimeDisplay(e=null,t=0,i=!1){A.element(e)&&A.number(t)&&(e.innerText=Me.formatTime(t,i))},updateVolume(){this.supported.ui&&(A.element(this.elements.inputs.volume)&&Me.setRange.call(this,this.elements.inputs.volume,this.muted?0:this.volume),A.element(this.elements.buttons.mute)&&(this.elements.buttons.mute.pressed=this.muted||0===this.volume))},setRange(e,t=0){A.element(e)&&(e.value=t,Me.updateRangeFill.call(this,e))},updateProgress(e){if(!this.supported.ui||!A.event(e))return;let t=0;const i=(e,t)=>{const i=A.number(t)?t:0,s=A.element(e)?e:this.elements.display.buffer;if(A.element(s)){s.value=i;const e=s.getElementsByTagName(\"span\")[0];A.element(e)&&(e.childNodes[0].nodeValue=i)}};if(e)switch(e.type){case\"timeupdate\":case\"seeking\":case\"seeked\":s=this.currentTime,n=this.duration,t=0===s||0===n||Number.isNaN(s)||Number.isNaN(n)?0:(s/n*100).toFixed(2),\"timeupdate\"===e.type&&Me.setRange.call(this,this.elements.inputs.seek,t);break;case\"playing\":case\"progress\":i(this.elements.display.buffer,100*this.buffered)}var s,n},updateRangeFill(e){const t=A.event(e)?e.target:e;if(A.element(t)&&\"range\"===t.getAttribute(\"type\")){if(V(t,this.config.selectors.inputs.seek)){t.setAttribute(\"aria-valuenow\",this.currentTime);const e=Me.formatTime(this.currentTime),i=Me.formatTime(this.duration),s=we.get(\"seekLabel\",this.config);t.setAttribute(\"aria-valuetext\",s.replace(\"{currentTime}\",e).replace(\"{duration}\",i))}else if(V(t,this.config.selectors.inputs.volume)){const e=100*t.value;t.setAttribute(\"aria-valuenow\",e),t.setAttribute(\"aria-valuetext\",`${e.toFixed(1)}%`)}else t.setAttribute(\"aria-valuenow\",t.value);(x.isWebKit||x.isIPadOS)&&t.style.setProperty(\"--value\",t.value/t.max*100+\"%\")}},updateSeekTooltip(e){var t,i;if(!this.config.tooltips.seek||!A.element(this.elements.inputs.seek)||!A.element(this.elements.display.seekTooltip)||0===this.duration)return;const s=this.elements.display.seekTooltip,n=`${this.config.classNames.tooltip}--visible`,a=e=>F(s,n,e);if(this.touch)return void a(!1);let r=0;const o=this.elements.progress.getBoundingClientRect();if(A.event(e))r=100/o.width*(e.pageX-o.left);else{if(!U(s,n))return;r=parseFloat(s.style.left,10)}r100&&(r=100);const l=this.duration/100*r;s.innerText=Me.formatTime(l);const c=null===(t=this.config.markers)||void 0===t||null===(i=t.points)||void 0===i?void 0:i.find((({time:e})=>e===Math.round(l)));c&&s.insertAdjacentHTML(\"afterbegin\",`${c.label}`),s.style.left=`${r}%`,A.event(e)&&[\"mouseenter\",\"mouseleave\"].includes(e.type)&&a(\"mouseenter\"===e.type)},timeUpdate(e){const t=!A.element(this.elements.display.duration)&&this.config.invertTime;Me.updateTimeDisplay.call(this,this.elements.display.currentTime,t?this.duration-this.currentTime:this.currentTime,t),e&&\"timeupdate\"===e.type&&this.media.seeking||Me.updateProgress.call(this,e)},durationUpdate(){if(!this.supported.ui||!this.config.invertTime&&this.currentTime)return;if(this.duration>=2**32)return H(this.elements.display.currentTime,!0),void H(this.elements.progress,!0);A.element(this.elements.inputs.seek)&&this.elements.inputs.seek.setAttribute(\"aria-valuemax\",this.duration);const e=A.element(this.elements.display.duration);!e&&this.config.displayDuration&&this.paused&&Me.updateTimeDisplay.call(this,this.elements.display.currentTime,this.duration),e&&Me.updateTimeDisplay.call(this,this.elements.display.duration,this.duration),this.config.markers.enabled&&Me.setMarkers.call(this),Me.updateSeekTooltip.call(this)},toggleMenuButton(e,t){H(this.elements.settings.buttons[e],!t)},updateSetting(e,t,i){const s=this.elements.settings.panels[e];let n=null,a=t;if(\"captions\"===e)n=this.currentTrack;else{if(n=A.empty(i)?this[e]:i,A.empty(n)&&(n=this.config[e].default),!A.empty(this.options[e])&&!this.options[e].includes(n))return void this.debug.warn(`Unsupported value of '${n}' for ${e}`);if(!this.config[e].options.includes(n))return void this.debug.warn(`Disabled value of '${n}' for ${e}`)}if(A.element(a)||(a=s&&s.querySelector('[role=\"menu\"]')),!A.element(a))return;this.elements.settings.buttons[e].querySelector(`.${this.config.classNames.menu.value}`).innerHTML=Me.getLabel.call(this,e,n);const r=a&&a.querySelector(`[value=\"${n}\"]`);A.element(r)&&(r.checked=!0)},getLabel(e,t){switch(e){case\"speed\":return 1===t?we.get(\"normal\",this.config):`${t}&times;`;case\"quality\":if(A.number(t)){const e=we.get(`qualityLabel.${t}`,this.config);return e.length?e:`${t}p`}return fe(t);case\"captions\":return Ne.getLabel.call(this);default:return null}},setQualityMenu(e){if(!A.element(this.elements.settings.panels.quality))return;const t=\"quality\",i=this.elements.settings.panels.quality.querySelector('[role=\"menu\"]');A.array(e)&&(this.options.quality=ne(e).filter((e=>this.config.quality.options.includes(e))));const s=!A.empty(this.options.quality)&&this.options.quality.length>1;if(Me.toggleMenuButton.call(this,t,s),R(i),Me.checkMenu.call(this),!s)return;const n=e=>{const t=we.get(`qualityBadge.${e}`,this.config);return t.length?Me.createBadge.call(this,t):null};this.options.quality.sort(((e,t)=>{const i=this.config.quality.options;return i.indexOf(e)>i.indexOf(t)?1:-1})).forEach((e=>{Me.createMenuItem.call(this,{value:e,list:i,type:t,title:Me.getLabel.call(this,\"quality\",e),badge:n(e)})})),Me.updateSetting.call(this,t,i)},setCaptionsMenu(){if(!A.element(this.elements.settings.panels.captions))return;const e=\"captions\",t=this.elements.settings.panels.captions.querySelector('[role=\"menu\"]'),i=Ne.getTracks.call(this),s=Boolean(i.length);if(Me.toggleMenuButton.call(this,e,s),R(t),Me.checkMenu.call(this),!s)return;const n=i.map(((e,i)=>({value:i,checked:this.captions.toggled&&this.currentTrack===i,title:Ne.getLabel.call(this,e),badge:e.language&&Me.createBadge.call(this,e.language.toUpperCase()),list:t,type:\"language\"})));n.unshift({value:-1,checked:!this.captions.toggled,title:we.get(\"disabled\",this.config),list:t,type:\"language\"}),n.forEach(Me.createMenuItem.bind(this)),Me.updateSetting.call(this,e,t)},setSpeedMenu(){if(!A.element(this.elements.settings.panels.speed))return;const e=\"speed\",t=this.elements.settings.panels.speed.querySelector('[role=\"menu\"]');this.options.speed=this.options.speed.filter((e=>e>=this.minimumSpeed&&e1;Me.toggleMenuButton.call(this,e,i),R(t),Me.checkMenu.call(this),i&&(this.options.speed.forEach((i=>{Me.createMenuItem.call(this,{value:i,list:t,type:e,title:Me.getLabel.call(this,\"speed\",i)})})),Me.updateSetting.call(this,e,t))},checkMenu(){const{buttons:e}=this.elements.settings,t=!A.empty(e)&&Object.values(e).some((e=>!e.hidden));H(this.elements.settings.menu,!t)},focusFirstMenuItem(e,t=!1){if(this.elements.settings.popup.hidden)return;let i=e;A.element(i)||(i=Object.values(this.elements.settings.panels).find((e=>!e.hidden)));const s=i.querySelector('[role^=\"menuitem\"]');z.call(this,s,t)},toggleMenu(e){const{popup:t}=this.elements.settings,i=this.elements.buttons.settings;if(!A.element(t)||!A.element(i))return;const{hidden:s}=t;let n=s;if(A.boolean(e))n=e;else if(A.keyboardEvent(e)&&\"Escape\"===e.key)n=!1;else if(A.event(e)){const s=A.function(e.composedPath)?e.composedPath()[0]:e.target,a=t.contains(s);if(a||!a&&e.target!==i&&n)return}i.setAttribute(\"aria-expanded\",n),H(t,!n),F(this.elements.container,this.config.classNames.menu.open,n),n&&A.keyboardEvent(e)?Me.focusFirstMenuItem.call(this,null,!0):n||s||z.call(this,i,A.keyboardEvent(e))},getMenuSize(e){const t=e.cloneNode(!0);t.style.position=\"absolute\",t.style.opacity=0,t.removeAttribute(\"hidden\"),e.parentNode.appendChild(t);const i=t.scrollWidth,s=t.scrollHeight;return j(t),{width:i,height:s}},showMenuPanel(e=\"\",t=!1){const i=this.elements.container.querySelector(`#plyr-settings-${this.id}-${e}`);if(!A.element(i))return;const s=i.parentNode,n=Array.from(s.children).find((e=>!e.hidden));if(Y.transitions&&!Y.reducedMotion){s.style.width=`${n.scrollWidth}px`,s.style.height=`${n.scrollHeight}px`;const e=Me.getMenuSize.call(this,i),t=e=>{e.target===s&&[\"width\",\"height\"].includes(e.propertyName)&&(s.style.width=\"\",s.style.height=\"\",G.call(this,s,P,t))};J.call(this,s,P,t),s.style.width=`${e.width}px`,s.style.height=`${e.height}px`}H(n,!0),H(i,!1),Me.focusFirstMenuItem.call(this,i,t)},setDownloadUrl(){const e=this.elements.buttons.download;A.element(e)&&e.setAttribute(\"href\",this.download)},create(e){const{bindMenuItemShortcuts:t,createButton:i,createProgress:s,createRange:n,createTime:a,setQualityMenu:r,setSpeedMenu:o,showMenuPanel:l}=Me;this.elements.controls=null,A.array(this.config.controls)&&this.config.controls.includes(\"play-large\")&&this.elements.container.appendChild(i.call(this,\"play-large\"));const c=O(\"div\",q(this.config.selectors.controls.wrapper));this.elements.controls=c;const u={class:\"plyr__controls__item\"};return ne(A.array(this.config.controls)?this.config.controls:[]).forEach((r=>{if(\"restart\"===r&&c.appendChild(i.call(this,\"restart\",u)),\"rewind\"===r&&c.appendChild(i.call(this,\"rewind\",u)),\"play\"===r&&c.appendChild(i.call(this,\"play\",u)),\"fast-forward\"===r&&c.appendChild(i.call(this,\"fast-forward\",u)),\"progress\"===r){const t=O(\"div\",{class:`${u.class} plyr__progress__container`}),i=O(\"div\",q(this.config.selectors.progress));if(i.appendChild(n.call(this,\"seek\",{id:`plyr-seek-${e.id}`})),i.appendChild(s.call(this,\"buffer\")),this.config.tooltips.seek){const e=O(\"span\",{class:this.config.classNames.tooltip},\"00:00\");i.appendChild(e),this.elements.display.seekTooltip=e}this.elements.progress=i,t.appendChild(this.elements.progress),c.appendChild(t)}if(\"current-time\"===r&&c.appendChild(a.call(this,\"currentTime\",u)),\"duration\"===r&&c.appendChild(a.call(this,\"duration\",u)),\"mute\"===r||\"volume\"===r){let{volume:t}=this.elements;if(A.element(t)&&c.contains(t)||(t=O(\"div\",N({},u,{class:`${u.class} plyr__volume`.trim()})),this.elements.volume=t,c.appendChild(t)),\"mute\"===r&&t.appendChild(i.call(this,\"mute\")),\"volume\"===r&&!x.isIos&&!x.isIPadOS){const i={max:1,step:.05,value:this.config.volume};t.appendChild(n.call(this,\"volume\",N(i,{id:`plyr-volume-${e.id}`})))}}if(\"captions\"===r&&c.appendChild(i.call(this,\"captions\",u)),\"settings\"===r&&!A.empty(this.config.settings)){const s=O(\"div\",N({},u,{class:`${u.class} plyr__menu`.trim(),hidden:\"\"}));s.appendChild(i.call(this,\"settings\",{\"aria-haspopup\":!0,\"aria-controls\":`plyr-settings-${e.id}`,\"aria-expanded\":!1}));const n=O(\"div\",{class:\"plyr__menu__container\",id:`plyr-settings-${e.id}`,hidden:\"\"}),a=O(\"div\"),r=O(\"div\",{id:`plyr-settings-${e.id}-home`}),o=O(\"div\",{role:\"menu\"});r.appendChild(o),a.appendChild(r),this.elements.settings.panels.home=r,this.config.settings.forEach((i=>{const s=O(\"button\",N(q(this.config.selectors.buttons.settings),{type:\"button\",class:`${this.config.classNames.control} ${this.config.classNames.control}--forward`,role:\"menuitem\",\"aria-haspopup\":!0,hidden:\"\"}));t.call(this,s,i),J.call(this,s,\"click\",(()=>{l.call(this,i,!1)}));const n=O(\"span\",null,we.get(i,this.config)),r=O(\"span\",{class:this.config.classNames.menu.value});r.innerHTML=e[i],n.appendChild(r),s.appendChild(n),o.appendChild(s);const c=O(\"div\",{id:`plyr-settings-${e.id}-${i}`,hidden:\"\"}),u=O(\"button\",{type:\"button\",class:`${this.config.classNames.control} ${this.config.classNames.control}--back`});u.appendChild(O(\"span\",{\"aria-hidden\":!0},we.get(i,this.config))),u.appendChild(O(\"span\",{class:this.config.classNames.hidden},we.get(\"menuBack\",this.config))),J.call(this,c,\"keydown\",(e=>{\"ArrowLeft\"===e.key&&(e.preventDefault(),e.stopPropagation(),l.call(this,\"home\",!0))}),!1),J.call(this,u,\"click\",(()=>{l.call(this,\"home\",!1)})),c.appendChild(u),c.appendChild(O(\"div\",{role:\"menu\"})),a.appendChild(c),this.elements.settings.buttons[i]=s,this.elements.settings.panels[i]=c})),n.appendChild(a),s.appendChild(n),c.appendChild(s),this.elements.settings.popup=n,this.elements.settings.menu=s}if(\"pip\"===r&&Y.pip&&c.appendChild(i.call(this,\"pip\",u)),\"airplay\"===r&&Y.airplay&&c.appendChild(i.call(this,\"airplay\",u)),\"download\"===r){const e=N({},u,{element:\"a\",href:this.download,target:\"_blank\"});this.isHTML5&&(e.download=\"\");const{download:t}=this.config.urls;!A.url(t)&&this.isEmbed&&N(e,{icon:`logo-${this.provider}`,label:this.provider}),c.appendChild(i.call(this,\"download\",e))}\"fullscreen\"===r&&c.appendChild(i.call(this,\"fullscreen\",u))})),this.isHTML5&&r.call(this,me.getQualityOptions.call(this)),o.call(this),c},inject(){if(this.config.loadSprite){const e=Me.getIconUrl.call(this);e.cors&&Ee(e.url,\"sprite-plyr\")}this.id=Math.floor(1e4*Math.random());let e=null;this.elements.controls=null;const t={id:this.id,seektime:this.config.seekTime,title:this.config.title};let i=!0;A.function(this.config.controls)&&(this.config.controls=this.config.controls.call(this,t)),this.config.controls||(this.config.controls=[]),A.element(this.config.controls)||A.string(this.config.controls)?e=this.config.controls:(e=Me.create.call(this,{id:this.id,seektime:this.config.seekTime,speed:this.speed,quality:this.quality,captions:Ne.getLabel.call(this)}),i=!1);let s;i&&A.string(this.config.controls)&&(e=(e=>{let i=e;return Object.entries(t).forEach((([e,t])=>{i=ge(i,`{${e}}`,t)})),i})(e)),A.string(this.config.selectors.controls.container)&&(s=document.querySelector(this.config.selectors.controls.container)),A.element(s)||(s=this.elements.container);if(s[A.element(e)?\"insertAdjacentElement\":\"insertAdjacentHTML\"](\"afterbegin\",e),A.element(this.elements.controls)||Me.findElements.call(this),!A.empty(this.elements.buttons)){const e=e=>{const t=this.config.classNames.controlPressed;e.setAttribute(\"aria-pressed\",\"false\"),Object.defineProperty(e,\"pressed\",{configurable:!0,enumerable:!0,get:()=>U(e,t),set(i=!1){F(e,t,i),e.setAttribute(\"aria-pressed\",i?\"true\":\"false\")}})};Object.values(this.elements.buttons).filter(Boolean).forEach((t=>{A.array(t)||A.nodeList(t)?Array.from(t).filter(Boolean).forEach(e):e(t)}))}if(x.isEdge&&M(s),this.config.tooltips.controls){const{classNames:e,selectors:t}=this.config,i=`${t.controls.wrapper} ${t.labels} .${e.hidden}`,s=B.call(this,i);Array.from(s).forEach((e=>{F(e,this.config.classNames.hidden,!1),F(e,this.config.classNames.tooltip,!0)}))}},setMediaMetadata(){try{\"mediaSession\"in navigator&&(navigator.mediaSession.metadata=new window.MediaMetadata({title:this.config.mediaMetadata.title,artist:this.config.mediaMetadata.artist,album:this.config.mediaMetadata.album,artwork:this.config.mediaMetadata.artwork}))}catch(e){}},setMarkers(){var e,t;if(!this.duration||this.elements.markers)return;const i=null===(e=this.config.markers)||void 0===e||null===(t=e.points)||void 0===t?void 0:t.filter((({time:e})=>e>0&&eF(a,r,e);i.forEach((e=>{const t=O(\"span\",{class:this.config.classNames.marker},\"\"),i=e.time/this.duration*100+\"%\";a&&(t.addEventListener(\"mouseenter\",(()=>{e.label||(a.style.left=i,a.innerHTML=e.label,o(!0))})),t.addEventListener(\"mouseleave\",(()=>{o(!1)}))),t.addEventListener(\"click\",(()=>{this.currentTime=e.time})),t.style.left=i,n.appendChild(t)})),s.appendChild(n),this.config.tooltips.seek||(a=O(\"span\",{class:this.config.classNames.tooltip},\"\"),s.appendChild(a)),this.elements.markers={points:n,tip:a},this.elements.progress.appendChild(s)}};function xe(e,t=!0){let i=e;if(t){const e=document.createElement(\"a\");e.href=i,i=e.href}try{return new URL(i)}catch(e){return null}}function Le(e){const t=new URLSearchParams;return A.object(e)&&Object.entries(e).forEach((([e,i])=>{t.set(e,i)})),t}const Ne={setup(){if(!this.supported.ui)return;if(!this.isVideo||this.isYouTube||this.isHTML5&&!Y.textTracks)return void(A.array(this.config.controls)&&this.config.controls.includes(\"settings\")&&this.config.settings.includes(\"captions\")&&Me.setCaptionsMenu.call(this));var e,t;if(A.element(this.elements.captions)||(this.elements.captions=O(\"div\",q(this.config.selectors.captions)),this.elements.captions.setAttribute(\"dir\",\"auto\"),e=this.elements.captions,t=this.elements.wrapper,A.element(e)&&A.element(t)&&t.parentNode.insertBefore(e,t.nextSibling)),x.isIE&&window.URL){const e=this.media.querySelectorAll(\"track\");Array.from(e).forEach((e=>{const t=e.getAttribute(\"src\"),i=xe(t);null!==i&&i.hostname!==window.location.href.hostname&&[\"http:\",\"https:\"].includes(i.protocol)&&ke(t,\"blob\").then((t=>{e.setAttribute(\"src\",window.URL.createObjectURL(t))})).catch((()=>{j(e)}))}))}const i=ne((navigator.languages||[navigator.language||navigator.userLanguage||\"en\"]).map((e=>e.split(\"-\")[0])));let s=(this.storage.get(\"language\")||this.config.captions.language||\"auto\").toLowerCase();\"auto\"===s&&([s]=i);let n=this.storage.get(\"captions\");if(A.boolean(n)||({active:n}=this.config.captions),Object.assign(this.captions,{toggled:!1,active:n,language:s,languages:i}),this.isHTML5){const e=this.config.captions.update?\"addtrack removetrack\":\"removetrack\";J.call(this,this.media.textTracks,e,Ne.update.bind(this))}setTimeout(Ne.update.bind(this),0)},update(){const e=Ne.getTracks.call(this,!0),{active:t,language:i,meta:s,currentTrackNode:n}=this.captions,a=Boolean(e.find((e=>e.language===i)));this.isHTML5&&this.isVideo&&e.filter((e=>!s.get(e))).forEach((e=>{this.debug.log(\"Track added\",e),s.set(e,{default:\"showing\"===e.mode}),\"showing\"===e.mode&&(e.mode=\"hidden\"),J.call(this,e,\"cuechange\",(()=>Ne.updateCues.call(this)))})),(a&&this.language!==i||!e.includes(n))&&(Ne.setLanguage.call(this,i),Ne.toggle.call(this,t&&a)),this.elements&&F(this.elements.container,this.config.classNames.captions.enabled,!A.empty(e)),A.array(this.config.controls)&&this.config.controls.includes(\"settings\")&&this.config.settings.includes(\"captions\")&&Me.setCaptionsMenu.call(this)},toggle(e,t=!0){if(!this.supported.ui)return;const{toggled:i}=this.captions,s=this.config.classNames.captions.active,n=A.nullOrUndefined(e)?!i:e;if(n!==i){if(t||(this.captions.active=n,this.storage.set({captions:n})),!this.language&&n&&!t){const e=Ne.getTracks.call(this),t=Ne.findTrack.call(this,[this.captions.language,...this.captions.languages],!0);return this.captions.language=t.language,void Ne.set.call(this,e.indexOf(t))}this.elements.buttons.captions&&(this.elements.buttons.captions.pressed=n),F(this.elements.container,s,n),this.captions.toggled=n,Me.updateSetting.call(this,\"captions\"),ee.call(this,this.media,n?\"captionsenabled\":\"captionsdisabled\")}setTimeout((()=>{n&&this.captions.toggled&&(this.captions.currentTrackNode.mode=\"hidden\")}))},set(e,t=!0){const i=Ne.getTracks.call(this);if(-1!==e)if(A.number(e))if(e in i){if(this.captions.currentTrack!==e){this.captions.currentTrack=e;const s=i[e],{language:n}=s||{};this.captions.currentTrackNode=s,Me.updateSetting.call(this,\"captions\"),t||(this.captions.language=n,this.storage.set({language:n})),this.isVimeo&&this.embed.enableTextTrack(n),ee.call(this,this.media,\"languagechange\")}Ne.toggle.call(this,!0,t),this.isHTML5&&this.isVideo&&Ne.updateCues.call(this)}else this.debug.warn(\"Track not found\",e);else this.debug.warn(\"Invalid caption argument\",e);else Ne.toggle.call(this,!1,t)},setLanguage(e,t=!0){if(!A.string(e))return void this.debug.warn(\"Invalid language argument\",e);const i=e.toLowerCase();this.captions.language=i;const s=Ne.getTracks.call(this),n=Ne.findTrack.call(this,[i]);Ne.set.call(this,s.indexOf(n),t)},getTracks(e=!1){return Array.from((this.media||{}).textTracks||[]).filter((t=>!this.isHTML5||e||this.captions.meta.has(t))).filter((e=>[\"captions\",\"subtitles\"].includes(e.kind)))},findTrack(e,t=!1){const i=Ne.getTracks.call(this),s=e=>Number((this.captions.meta.get(e)||{}).default),n=Array.from(i).sort(((e,t)=>s(t)-s(e)));let a;return e.every((e=>(a=n.find((t=>t.language===e)),!a))),a||(t?n[0]:void 0)},getCurrentTrack(){return Ne.getTracks.call(this)[this.currentTrack]},getLabel(e){let t=e;return!A.track(t)&&Y.textTracks&&this.captions.toggled&&(t=Ne.getCurrentTrack.call(this)),A.track(t)?A.empty(t.label)?A.empty(t.language)?we.get(\"enabled\",this.config):e.language.toUpperCase():t.label:we.get(\"disabled\",this.config)},updateCues(e){if(!this.supported.ui)return;if(!A.element(this.elements.captions))return void this.debug.warn(\"No captions element to render to\");if(!A.nullOrUndefined(e)&&!Array.isArray(e))return void this.debug.warn(\"updateCues: Invalid input\",e);let t=e;if(!t){const e=Ne.getCurrentTrack.call(this);t=Array.from((e||{}).activeCues||[]).map((e=>e.getCueAsHTML())).map(be)}const i=t.map((e=>e.trim())).join(\"\\n\");if(i!==this.elements.captions.innerHTML){R(this.elements.captions);const e=O(\"span\",q(this.config.selectors.caption));e.innerHTML=i,this.elements.captions.appendChild(e),ee.call(this,this.media,\"cuechange\")}}},_e={enabled:!0,title:\"\",debug:!1,autoplay:!1,autopause:!0,playsinline:!0,seekTime:10,volume:1,muted:!1,duration:null,displayDuration:!0,invertTime:!0,toggleInvert:!0,ratio:null,clickToPlay:!0,hideControls:!0,resetOnEnd:!1,disableContextMenu:!0,loadSprite:!0,iconPrefix:\"plyr\",iconUrl:\"https://cdn.plyr.io/3.7.8/plyr.svg\",blankVideo:\"https://cdn.plyr.io/static/blank.mp4\",quality:{default:576,options:[4320,2880,2160,1440,1080,720,576,480,360,240],forced:!1,onChange:null},loop:{active:!1},speed:{selected:1,options:[.5,.75,1,1.25,1.5,1.75,2,4]},keyboard:{focused:!0,global:!1},tooltips:{controls:!1,seek:!0},captions:{active:!1,language:\"auto\",update:!1},fullscreen:{enabled:!0,fallback:!0,iosNative:!1},storage:{enabled:!0,key:\"plyr\"},controls:[\"play-large\",\"play\",\"progress\",\"current-time\",\"mute\",\"volume\",\"captions\",\"settings\",\"pip\",\"airplay\",\"fullscreen\"],settings:[\"captions\",\"quality\",\"speed\"],i18n:{restart:\"Restart\",rewind:\"Rewind {seektime}s\",play:\"Play\",pause:\"Pause\",fastForward:\"Forward {seektime}s\",seek:\"Seek\",seekLabel:\"{currentTime} of {duration}\",played:\"Played\",buffered:\"Buffered\",currentTime:\"Current time\",duration:\"Duration\",volume:\"Volume\",mute:\"Mute\",unmute:\"Unmute\",enableCaptions:\"Enable captions\",disableCaptions:\"Disable captions\",download:\"Download\",enterFullscreen:\"Enter fullscreen\",exitFullscreen:\"Exit fullscreen\",frameTitle:\"Player for {title}\",captions:\"Captions\",settings:\"Settings\",pip:\"PIP\",menuBack:\"Go back to previous menu\",speed:\"Speed\",normal:\"Normal\",quality:\"Quality\",loop:\"Loop\",start:\"Start\",end:\"End\",all:\"All\",reset:\"Reset\",disabled:\"Disabled\",enabled:\"Enabled\",advertisement:\"Ad\",qualityBadge:{2160:\"4K\",1440:\"HD\",1080:\"HD\",720:\"HD\",576:\"SD\",480:\"SD\"}},urls:{download:null,vimeo:{sdk:\"https://player.vimeo.com/api/player.js\",iframe:\"https://player.vimeo.com/video/{0}?{1}\",api:\"https://vimeo.com/api/oembed.json?url={0}\"},youtube:{sdk:\"https://www.youtube.com/iframe_api\",api:\"https://noembed.com/embed?url=https://www.youtube.com/watch?v={0}\"},googleIMA:{sdk:\"https://imasdk.googleapis.com/js/sdkloader/ima3.js\"}},listeners:{seek:null,play:null,pause:null,restart:null,rewind:null,fastForward:null,mute:null,volume:null,captions:null,download:null,fullscreen:null,pip:null,airplay:null,speed:null,quality:null,loop:null,language:null},events:[\"ended\",\"progress\",\"stalled\",\"playing\",\"waiting\",\"canplay\",\"canplaythrough\",\"loadstart\",\"loadeddata\",\"loadedmetadata\",\"timeupdate\",\"volumechange\",\"play\",\"pause\",\"error\",\"seeking\",\"seeked\",\"emptied\",\"ratechange\",\"cuechange\",\"download\",\"enterfullscreen\",\"exitfullscreen\",\"captionsenabled\",\"captionsdisabled\",\"languagechange\",\"controlshidden\",\"controlsshown\",\"ready\",\"statechange\",\"qualitychange\",\"adsloaded\",\"adscontentpause\",\"adscontentresume\",\"adstarted\",\"adsmidpoint\",\"adscomplete\",\"adsallcomplete\",\"adsimpression\",\"adsclick\"],selectors:{editable:\"input, textarea, select, [contenteditable]\",container:\".plyr\",controls:{container:null,wrapper:\".plyr__controls\"},labels:\"[data-plyr]\",buttons:{play:'[data-plyr=\"play\"]',pause:'[data-plyr=\"pause\"]',restart:'[data-plyr=\"restart\"]',rewind:'[data-plyr=\"rewind\"]',fastForward:'[data-plyr=\"fast-forward\"]',mute:'[data-plyr=\"mute\"]',captions:'[data-plyr=\"captions\"]',download:'[data-plyr=\"download\"]',fullscreen:'[data-plyr=\"fullscreen\"]',pip:'[data-plyr=\"pip\"]',airplay:'[data-plyr=\"airplay\"]',settings:'[data-plyr=\"settings\"]',loop:'[data-plyr=\"loop\"]'},inputs:{seek:'[data-plyr=\"seek\"]',volume:'[data-plyr=\"volume\"]',speed:'[data-plyr=\"speed\"]',language:'[data-plyr=\"language\"]',quality:'[data-plyr=\"quality\"]'},display:{currentTime:\".plyr__time--current\",duration:\".plyr__time--duration\",buffer:\".plyr__progress__buffer\",loop:\".plyr__progress__loop\",volume:\".plyr__volume--display\"},progress:\".plyr__progress\",captions:\".plyr__captions\",caption:\".plyr__caption\"},classNames:{type:\"plyr--{0}\",provider:\"plyr--{0}\",video:\"plyr__video-wrapper\",embed:\"plyr__video-embed\",videoFixedRatio:\"plyr__video-wrapper--fixed-ratio\",embedContainer:\"plyr__video-embed__container\",poster:\"plyr__poster\",posterEnabled:\"plyr__poster-enabled\",ads:\"plyr__ads\",control:\"plyr__control\",controlPressed:\"plyr__control--pressed\",playing:\"plyr--playing\",paused:\"plyr--paused\",stopped:\"plyr--stopped\",loading:\"plyr--loading\",hover:\"plyr--hover\",tooltip:\"plyr__tooltip\",cues:\"plyr__cues\",marker:\"plyr__progress__marker\",hidden:\"plyr__sr-only\",hideControls:\"plyr--hide-controls\",isTouch:\"plyr--is-touch\",uiSupported:\"plyr--full-ui\",noTransition:\"plyr--no-transition\",display:{time:\"plyr__time\"},menu:{value:\"plyr__menu__value\",badge:\"plyr__badge\",open:\"plyr--menu-open\"},captions:{enabled:\"plyr--captions-enabled\",active:\"plyr--captions-active\"},fullscreen:{enabled:\"plyr--fullscreen-enabled\",fallback:\"plyr--fullscreen-fallback\"},pip:{supported:\"plyr--pip-supported\",active:\"plyr--pip-active\"},airplay:{supported:\"plyr--airplay-supported\",active:\"plyr--airplay-active\"},previewThumbnails:{thumbContainer:\"plyr__preview-thumb\",thumbContainerShown:\"plyr__preview-thumb--is-shown\",imageContainer:\"plyr__preview-thumb__image-container\",timeContainer:\"plyr__preview-thumb__time-container\",scrubbingContainer:\"plyr__preview-scrubbing\",scrubbingContainerShown:\"plyr__preview-scrubbing--is-shown\"}},attributes:{embed:{provider:\"data-plyr-provider\",id:\"data-plyr-embed-id\",hash:\"data-plyr-embed-hash\"}},ads:{enabled:!1,publisherId:\"\",tagUrl:\"\"},previewThumbnails:{enabled:!1,src:\"\"},vimeo:{byline:!1,portrait:!1,title:!1,speed:!0,transparent:!1,customControls:!0,referrerPolicy:null,premium:!1},youtube:{rel:0,showinfo:0,iv_load_policy:3,modestbranding:1,customControls:!0,noCookie:!1},mediaMetadata:{title:\"\",artist:\"\",album:\"\",artwork:[]},markers:{enabled:!1,points:[]}},Ie=\"picture-in-picture\",Oe=\"inline\",$e={html5:\"html5\",youtube:\"youtube\",vimeo:\"vimeo\"},je=\"audio\",Re=\"video\";const De=()=>{};class qe{constructor(e=!1){this.enabled=window.console&&e,this.enabled&&this.log(\"Debugging enabled\")}get log(){return this.enabled?Function.prototype.bind.call(console.log,console):De}get warn(){return this.enabled?Function.prototype.bind.call(console.warn,console):De}get error(){return this.enabled?Function.prototype.bind.call(console.error,console):De}}class He{constructor(e){t(this,\"onChange\",(()=>{if(!this.supported)return;const e=this.player.elements.buttons.fullscreen;A.element(e)&&(e.pressed=this.active);const t=this.target===this.player.media?this.target:this.player.elements.container;ee.call(this.player,t,this.active?\"enterfullscreen\":\"exitfullscreen\",!0)})),t(this,\"toggleFallback\",((e=!1)=>{if(e?this.scrollPosition={x:window.scrollX??0,y:window.scrollY??0}:window.scrollTo(this.scrollPosition.x,this.scrollPosition.y),document.body.style.overflow=e?\"hidden\":\"\",F(this.target,this.player.config.classNames.fullscreen.fallback,e),x.isIos){let t=document.head.querySelector('meta[name=\"viewport\"]');const i=\"viewport-fit=cover\";t||(t=document.createElement(\"meta\"),t.setAttribute(\"name\",\"viewport\"));const s=A.string(t.content)&&t.content.includes(i);e?(this.cleanupViewport=!s,s||(t.content+=`,${i}`)):this.cleanupViewport&&(t.content=t.content.split(\",\").filter((e=>e.trim()!==i)).join(\",\"))}this.onChange()})),t(this,\"trapFocus\",(e=>{if(x.isIos||x.isIPadOS||!this.active||\"Tab\"!==e.key)return;const t=document.activeElement,i=B.call(this.player,\"a[href], button:not(:disabled), input:not(:disabled), [tabindex]\"),[s]=i,n=i[i.length-1];t!==n||e.shiftKey?t===s&&e.shiftKey&&(n.focus(),e.preventDefault()):(s.focus(),e.preventDefault())})),t(this,\"update\",(()=>{if(this.supported){let e;e=this.forceFallback?\"Fallback (forced)\":He.nativeSupported?\"Native\":\"Fallback\",this.player.debug.log(`${e} fullscreen enabled`)}else this.player.debug.log(\"Fullscreen not supported and fallback disabled\");F(this.player.elements.container,this.player.config.classNames.fullscreen.enabled,this.supported)})),t(this,\"enter\",(()=>{this.supported&&(x.isIos&&this.player.config.fullscreen.iosNative?this.player.isVimeo?this.player.embed.requestFullscreen():this.target.webkitEnterFullscreen():!He.nativeSupported||this.forceFallback?this.toggleFallback(!0):this.prefix?A.empty(this.prefix)||this.target[`${this.prefix}Request${this.property}`]():this.target.requestFullscreen({navigationUI:\"hide\"}))})),t(this,\"exit\",(()=>{if(this.supported)if(x.isIos&&this.player.config.fullscreen.iosNative)this.player.isVimeo?this.player.embed.exitFullscreen():this.target.webkitEnterFullscreen(),se(this.player.play());else if(!He.nativeSupported||this.forceFallback)this.toggleFallback(!1);else if(this.prefix){if(!A.empty(this.prefix)){const e=\"moz\"===this.prefix?\"Cancel\":\"Exit\";document[`${this.prefix}${e}${this.property}`]()}}else(document.cancelFullScreen||document.exitFullscreen).call(document)})),t(this,\"toggle\",(()=>{this.active?this.exit():this.enter()})),this.player=e,this.prefix=He.prefix,this.property=He.property,this.scrollPosition={x:0,y:0},this.forceFallback=\"force\"===e.config.fullscreen.fallback,this.player.elements.fullscreen=e.config.fullscreen.container&&function(e,t){const{prototype:i}=Element;return(i.closest||function(){let e=this;do{if(V.matches(e,t))return e;e=e.parentElement||e.parentNode}while(null!==e&&1===e.nodeType);return null}).call(e,t)}(this.player.elements.container,e.config.fullscreen.container),J.call(this.player,document,\"ms\"===this.prefix?\"MSFullscreenChange\":`${this.prefix}fullscreenchange`,(()=>{this.onChange()})),J.call(this.player,this.player.elements.container,\"dblclick\",(e=>{A.element(this.player.elements.controls)&&this.player.elements.controls.contains(e.target)||this.player.listeners.proxy(e,this.toggle,\"fullscreen\")})),J.call(this,this.player.elements.container,\"keydown\",(e=>this.trapFocus(e))),this.update()}static get nativeSupported(){return!!(document.fullscreenEnabled||document.webkitFullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled)}get useNative(){return He.nativeSupported&&!this.forceFallback}static get prefix(){if(A.function(document.exitFullscreen))return\"\";let e=\"\";return[\"webkit\",\"moz\",\"ms\"].some((t=>!(!A.function(document[`${t}ExitFullscreen`])&&!A.function(document[`${t}CancelFullScreen`]))&&(e=t,!0))),e}static get property(){return\"moz\"===this.prefix?\"FullScreen\":\"Fullscreen\"}get supported(){return[this.player.config.fullscreen.enabled,this.player.isVideo,He.nativeSupported||this.player.config.fullscreen.fallback,!this.player.isYouTube||He.nativeSupported||!x.isIos||this.player.config.playsinline&&!this.player.config.fullscreen.iosNative].every(Boolean)}get active(){if(!this.supported)return!1;if(!He.nativeSupported||this.forceFallback)return U(this.target,this.player.config.classNames.fullscreen.fallback);const e=this.prefix?this.target.getRootNode()[`${this.prefix}${this.property}Element`]:this.target.getRootNode().fullscreenElement;return e&&e.shadowRoot?e===this.target.getRootNode().host:e===this.target}get target(){return x.isIos&&this.player.config.fullscreen.iosNative?this.player.media:this.player.elements.fullscreen??this.player.elements.container}}function Fe(e,t=1){return new Promise(((i,s)=>{const n=new Image,a=()=>{delete n.onload,delete n.onerror,(n.naturalWidth>=t?i:s)(n)};Object.assign(n,{onload:a,onerror:a,src:e})}))}const Ue={addStyleHook(){F(this.elements.container,this.config.selectors.container.replace(\".\",\"\"),!0),F(this.elements.container,this.config.classNames.uiSupported,this.supported.ui)},toggleNativeControls(e=!1){e&&this.isHTML5?this.media.setAttribute(\"controls\",\"\"):this.media.removeAttribute(\"controls\")},build(){if(this.listeners.media(),!this.supported.ui)return this.debug.warn(`Basic support only for ${this.provider} ${this.type}`),void Ue.toggleNativeControls.call(this,!0);A.element(this.elements.controls)||(Me.inject.call(this),this.listeners.controls()),Ue.toggleNativeControls.call(this),this.isHTML5&&Ne.setup.call(this),this.volume=null,this.muted=null,this.loop=null,this.quality=null,this.speed=null,Me.updateVolume.call(this),Me.timeUpdate.call(this),Me.durationUpdate.call(this),Ue.checkPlaying.call(this),F(this.elements.container,this.config.classNames.pip.supported,Y.pip&&this.isHTML5&&this.isVideo),F(this.elements.container,this.config.classNames.airplay.supported,Y.airplay&&this.isHTML5),F(this.elements.container,this.config.classNames.isTouch,this.touch),this.ready=!0,setTimeout((()=>{ee.call(this,this.media,\"ready\")}),0),Ue.setTitle.call(this),this.poster&&Ue.setPoster.call(this,this.poster,!1).catch((()=>{})),this.config.duration&&Me.durationUpdate.call(this),this.config.mediaMetadata&&Me.setMediaMetadata.call(this)},setTitle(){let e=we.get(\"play\",this.config);if(A.string(this.config.title)&&!A.empty(this.config.title)&&(e+=`, ${this.config.title}`),Array.from(this.elements.buttons.play||[]).forEach((t=>{t.setAttribute(\"aria-label\",e)})),this.isEmbed){const e=W.call(this,\"iframe\");if(!A.element(e))return;const t=A.empty(this.config.title)?\"video\":this.config.title,i=we.get(\"frameTitle\",this.config);e.setAttribute(\"title\",i.replace(\"{title}\",t))}},togglePoster(e){F(this.elements.container,this.config.classNames.posterEnabled,e)},setPoster(e,t=!0){return t&&this.poster?Promise.reject(new Error(\"Poster already set\")):(this.media.setAttribute(\"data-poster\",e),this.elements.poster.removeAttribute(\"hidden\"),ie.call(this).then((()=>Fe(e))).catch((t=>{throw e===this.poster&&Ue.togglePoster.call(this,!1),t})).then((()=>{if(e!==this.poster)throw new Error(\"setPoster cancelled by later call to setPoster\")})).then((()=>(Object.assign(this.elements.poster.style,{backgroundImage:`url('${e}')`,backgroundSize:\"\"}),Ue.togglePoster.call(this,!0),e))))},checkPlaying(e){F(this.elements.container,this.config.classNames.playing,this.playing),F(this.elements.container,this.config.classNames.paused,this.paused),F(this.elements.container,this.config.classNames.stopped,this.stopped),Array.from(this.elements.buttons.play||[]).forEach((e=>{Object.assign(e,{pressed:this.playing}),e.setAttribute(\"aria-label\",we.get(this.playing?\"pause\":\"play\",this.config))})),A.event(e)&&\"timeupdate\"===e.type||Ue.toggleControls.call(this)},checkLoading(e){this.loading=[\"stalled\",\"waiting\"].includes(e.type),clearTimeout(this.timers.loading),this.timers.loading=setTimeout((()=>{F(this.elements.container,this.config.classNames.loading,this.loading),Ue.toggleControls.call(this)}),this.loading?250:0)},toggleControls(e){const{controls:t}=this.elements;if(t&&this.config.hideControls){const i=this.touch&&this.lastSeekTime+2e3>Date.now();this.toggleControls(Boolean(e||this.loading||this.paused||t.pressed||t.hover||i))}},migrateStyles(){Object.values({...this.media.style}).filter((e=>!A.empty(e)&&A.string(e)&&e.startsWith(\"--plyr\"))).forEach((e=>{this.elements.container.style.setProperty(e,this.media.style.getPropertyValue(e)),this.media.style.removeProperty(e)})),A.empty(this.media.style)&&this.media.removeAttribute(\"style\")}};class Ve{constructor(e){t(this,\"firstTouch\",(()=>{const{player:e}=this,{elements:t}=e;e.touch=!0,F(t.container,e.config.classNames.isTouch,!0)})),t(this,\"global\",((e=!0)=>{const{player:t}=this;t.config.keyboard.global&&X.call(t,window,\"keydown keyup\",this.handleKey,e,!1),X.call(t,document.body,\"click\",this.toggleMenu,e),Z.call(t,document.body,\"touchstart\",this.firstTouch)})),t(this,\"container\",(()=>{const{player:e}=this,{config:t,elements:i,timers:s}=e;!t.keyboard.global&&t.keyboard.focused&&J.call(e,i.container,\"keydown keyup\",this.handleKey,!1),J.call(e,i.container,\"mousemove mouseleave touchstart touchmove enterfullscreen exitfullscreen\",(t=>{const{controls:n}=i;n&&\"enterfullscreen\"===t.type&&(n.pressed=!1,n.hover=!1);let a=0;[\"touchstart\",\"touchmove\",\"mousemove\"].includes(t.type)&&(Ue.toggleControls.call(e,!0),a=e.touch?3e3:2e3),clearTimeout(s.controls),s.controls=setTimeout((()=>Ue.toggleControls.call(e,!1)),a)}));const n=()=>{if(!e.isVimeo||e.config.vimeo.premium)return;const t=i.wrapper,{active:s}=e.fullscreen,[n,a]=ue.call(e),r=re(`aspect-ratio: ${n} / ${a}`);if(!s)return void(r?(t.style.width=null,t.style.height=null):(t.style.maxWidth=null,t.style.margin=null));const[o,l]=[Math.max(document.documentElement.clientWidth||0,window.innerWidth||0),Math.max(document.documentElement.clientHeight||0,window.innerHeight||0)],c=o/l>n/a;r?(t.style.width=c?\"auto\":\"100%\",t.style.height=c?\"100%\":\"auto\"):(t.style.maxWidth=c?l/a*n+\"px\":null,t.style.margin=c?\"0 auto\":null)},a=()=>{clearTimeout(s.resized),s.resized=setTimeout(n,50)};J.call(e,i.container,\"enterfullscreen exitfullscreen\",(t=>{const{target:s}=e.fullscreen;if(s!==i.container)return;if(!e.isEmbed&&A.empty(e.config.ratio))return;n();(\"enterfullscreen\"===t.type?J:G).call(e,window,\"resize\",a)}))})),t(this,\"media\",(()=>{const{player:e}=this,{elements:t}=e;if(J.call(e,e.media,\"timeupdate seeking seeked\",(t=>Me.timeUpdate.call(e,t))),J.call(e,e.media,\"durationchange loadeddata loadedmetadata\",(t=>Me.durationUpdate.call(e,t))),J.call(e,e.media,\"ended\",(()=>{e.isHTML5&&e.isVideo&&e.config.resetOnEnd&&(e.restart(),e.pause())})),J.call(e,e.media,\"progress playing seeking seeked\",(t=>Me.updateProgress.call(e,t))),J.call(e,e.media,\"volumechange\",(t=>Me.updateVolume.call(e,t))),J.call(e,e.media,\"playing play pause ended emptied timeupdate\",(t=>Ue.checkPlaying.call(e,t))),J.call(e,e.media,\"waiting canplay seeked playing\",(t=>Ue.checkLoading.call(e,t))),e.supported.ui&&e.config.clickToPlay&&!e.isAudio){const i=W.call(e,`.${e.config.classNames.video}`);if(!A.element(i))return;J.call(e,t.container,\"click\",(s=>{([t.container,i].includes(s.target)||i.contains(s.target))&&(e.touch&&e.config.hideControls||(e.ended?(this.proxy(s,e.restart,\"restart\"),this.proxy(s,(()=>{se(e.play())}),\"play\")):this.proxy(s,(()=>{se(e.togglePlay())}),\"play\")))}))}e.supported.ui&&e.config.disableContextMenu&&J.call(e,t.wrapper,\"contextmenu\",(e=>{e.preventDefault()}),!1),J.call(e,e.media,\"volumechange\",(()=>{e.storage.set({volume:e.volume,muted:e.muted})})),J.call(e,e.media,\"ratechange\",(()=>{Me.updateSetting.call(e,\"speed\"),e.storage.set({speed:e.speed})})),J.call(e,e.media,\"qualitychange\",(t=>{Me.updateSetting.call(e,\"quality\",null,t.detail.quality)})),J.call(e,e.media,\"ready qualitychange\",(()=>{Me.setDownloadUrl.call(e)}));const i=e.config.events.concat([\"keyup\",\"keydown\"]).join(\" \");J.call(e,e.media,i,(i=>{let{detail:s={}}=i;\"error\"===i.type&&(s=e.media.error),ee.call(e,t.container,i.type,!0,s)}))})),t(this,\"proxy\",((e,t,i)=>{const{player:s}=this,n=s.config.listeners[i];let a=!0;A.function(n)&&(a=n.call(s,e)),!1!==a&&A.function(t)&&t.call(s,e)})),t(this,\"bind\",((e,t,i,s,n=!0)=>{const{player:a}=this,r=a.config.listeners[s],o=A.function(r);J.call(a,e,t,(e=>this.proxy(e,i,s)),n&&!o)})),t(this,\"controls\",(()=>{const{player:e}=this,{elements:t}=e,i=x.isIE?\"change\":\"input\";if(t.buttons.play&&Array.from(t.buttons.play).forEach((t=>{this.bind(t,\"click\",(()=>{se(e.togglePlay())}),\"play\")})),this.bind(t.buttons.restart,\"click\",e.restart,\"restart\"),this.bind(t.buttons.rewind,\"click\",(()=>{e.lastSeekTime=Date.now(),e.rewind()}),\"rewind\"),this.bind(t.buttons.fastForward,\"click\",(()=>{e.lastSeekTime=Date.now(),e.forward()}),\"fastForward\"),this.bind(t.buttons.mute,\"click\",(()=>{e.muted=!e.muted}),\"mute\"),this.bind(t.buttons.captions,\"click\",(()=>e.toggleCaptions())),this.bind(t.buttons.download,\"click\",(()=>{ee.call(e,e.media,\"download\")}),\"download\"),this.bind(t.buttons.fullscreen,\"click\",(()=>{e.fullscreen.toggle()}),\"fullscreen\"),this.bind(t.buttons.pip,\"click\",(()=>{e.pip=\"toggle\"}),\"pip\"),this.bind(t.buttons.airplay,\"click\",e.airplay,\"airplay\"),this.bind(t.buttons.settings,\"click\",(t=>{t.stopPropagation(),t.preventDefault(),Me.toggleMenu.call(e,t)}),null,!1),this.bind(t.buttons.settings,\"keyup\",(t=>{[\" \",\"Enter\"].includes(t.key)&&(\"Enter\"!==t.key?(t.preventDefault(),t.stopPropagation(),Me.toggleMenu.call(e,t)):Me.focusFirstMenuItem.call(e,null,!0))}),null,!1),this.bind(t.settings.menu,\"keydown\",(t=>{\"Escape\"===t.key&&Me.toggleMenu.call(e,t)})),this.bind(t.inputs.seek,\"mousedown mousemove\",(e=>{const i=t.progress.getBoundingClientRect(),s=100/i.width*(e.pageX-i.left);e.currentTarget.setAttribute(\"seek-value\",s)})),this.bind(t.inputs.seek,\"mousedown mouseup keydown keyup touchstart touchend\",(t=>{const i=t.currentTarget,s=\"play-on-seeked\";if(A.keyboardEvent(t)&&![\"ArrowLeft\",\"ArrowRight\"].includes(t.key))return;e.lastSeekTime=Date.now();const n=i.hasAttribute(s),a=[\"mouseup\",\"touchend\",\"keyup\"].includes(t.type);n&&a?(i.removeAttribute(s),se(e.play())):!a&&e.playing&&(i.setAttribute(s,\"\"),e.pause())})),x.isIos){const t=B.call(e,'input[type=\"range\"]');Array.from(t).forEach((e=>this.bind(e,i,(e=>M(e.target)))))}this.bind(t.inputs.seek,i,(t=>{const i=t.currentTarget;let s=i.getAttribute(\"seek-value\");A.empty(s)&&(s=i.value),i.removeAttribute(\"seek-value\"),e.currentTime=s/i.max*e.duration}),\"seek\"),this.bind(t.progress,\"mouseenter mouseleave mousemove\",(t=>Me.updateSeekTooltip.call(e,t))),this.bind(t.progress,\"mousemove touchmove\",(t=>{const{previewThumbnails:i}=e;i&&i.loaded&&i.startMove(t)})),this.bind(t.progress,\"mouseleave touchend click\",(()=>{const{previewThumbnails:t}=e;t&&t.loaded&&t.endMove(!1,!0)})),this.bind(t.progress,\"mousedown touchstart\",(t=>{const{previewThumbnails:i}=e;i&&i.loaded&&i.startScrubbing(t)})),this.bind(t.progress,\"mouseup touchend\",(t=>{const{previewThumbnails:i}=e;i&&i.loaded&&i.endScrubbing(t)})),x.isWebKit&&Array.from(B.call(e,'input[type=\"range\"]')).forEach((t=>{this.bind(t,\"input\",(t=>Me.updateRangeFill.call(e,t.target)))})),e.config.toggleInvert&&!A.element(t.display.duration)&&this.bind(t.display.currentTime,\"click\",(()=>{0!==e.currentTime&&(e.config.invertTime=!e.config.invertTime,Me.timeUpdate.call(e))})),this.bind(t.inputs.volume,i,(t=>{e.volume=t.target.value}),\"volume\"),this.bind(t.controls,\"mouseenter mouseleave\",(i=>{t.controls.hover=!e.touch&&\"mouseenter\"===i.type})),t.fullscreen&&Array.from(t.fullscreen.children).filter((e=>!e.contains(t.container))).forEach((i=>{this.bind(i,\"mouseenter mouseleave\",(i=>{t.controls&&(t.controls.hover=!e.touch&&\"mouseenter\"===i.type)}))})),this.bind(t.controls,\"mousedown mouseup touchstart touchend touchcancel\",(e=>{t.controls.pressed=[\"mousedown\",\"touchstart\"].includes(e.type)})),this.bind(t.controls,\"focusin\",(()=>{const{config:i,timers:s}=e;F(t.controls,i.classNames.noTransition,!0),Ue.toggleControls.call(e,!0),setTimeout((()=>{F(t.controls,i.classNames.noTransition,!1)}),0);const n=this.touch?3e3:4e3;clearTimeout(s.controls),s.controls=setTimeout((()=>Ue.toggleControls.call(e,!1)),n)})),this.bind(t.inputs.volume,\"wheel\",(t=>{const i=t.webkitDirectionInvertedFromDevice,[s,n]=[t.deltaX,-t.deltaY].map((e=>i?-e:e)),a=Math.sign(Math.abs(s)>Math.abs(n)?s:n);e.increaseVolume(a/50);const{volume:r}=e.media;(1===a&&r0)&&t.preventDefault()}),\"volume\",!1)})),this.player=e,this.lastKey=null,this.focusTimer=null,this.lastKeyDown=null,this.handleKey=this.handleKey.bind(this),this.toggleMenu=this.toggleMenu.bind(this),this.firstTouch=this.firstTouch.bind(this)}handleKey(e){const{player:t}=this,{elements:i}=t,{key:s,type:n,altKey:a,ctrlKey:r,metaKey:o,shiftKey:l}=e,c=\"keydown\"===n,u=c&&s===this.lastKey;if(a||r||o||l)return;if(!s)return;if(c){const n=document.activeElement;if(A.element(n)){const{editable:s}=t.config.selectors,{seek:a}=i.inputs;if(n!==a&&V(n,s))return;if(\" \"===e.key&&V(n,'button, [role^=\"menuitem\"]'))return}switch([\" \",\"ArrowLeft\",\"ArrowUp\",\"ArrowRight\",\"ArrowDown\",\"0\",\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"c\",\"f\",\"k\",\"l\",\"m\"].includes(s)&&(e.preventDefault(),e.stopPropagation()),s){case\"0\":case\"1\":case\"2\":case\"3\":case\"4\":case\"5\":case\"6\":case\"7\":case\"8\":case\"9\":u||(h=parseInt(s,10),t.currentTime=t.duration/10*h);break;case\" \":case\"k\":u||se(t.togglePlay());break;case\"ArrowUp\":t.increaseVolume(.1);break;case\"ArrowDown\":t.decreaseVolume(.1);break;case\"m\":u||(t.muted=!t.muted);break;case\"ArrowRight\":t.forward();break;case\"ArrowLeft\":t.rewind();break;case\"f\":t.fullscreen.toggle();break;case\"c\":u||t.toggleCaptions();break;case\"l\":t.loop=!t.loop}\"Escape\"===s&&!t.fullscreen.usingNative&&t.fullscreen.active&&t.fullscreen.toggle(),this.lastKey=s}else this.lastKey=null;var h}toggleMenu(e){Me.toggleMenu.call(this.player,e)}}var Be=function(e,t){return e(t={exports:{}},t.exports),t.exports}((function(e,t){e.exports=function(){var e=function(){},t={},i={},s={};function n(e,t){e=e.push?e:[e];var n,a,r,o=[],l=e.length,c=l;for(n=function(e,i){i.length&&o.push(e),--c||t(o)};l--;)a=e[l],(r=i[a])?n(a,r):(s[a]=s[a]||[]).push(n)}function a(e,t){if(e){var n=s[e];if(i[e]=t,n)for(;n.length;)n[0](e,t),n.splice(0,1)}}function r(t,i){t.call&&(t={success:t}),i.length?(t.error||e)(i):(t.success||e)(t)}function o(t,i,s,n){var a,r,l=document,c=s.async,u=(s.numRetries||0)+1,h=s.before||e,d=t.replace(/[\\?|#].*$/,\"\"),m=t.replace(/^(css|img)!/,\"\");n=n||0,/(^css!|\\.css$)/.test(d)?((r=l.createElement(\"link\")).rel=\"stylesheet\",r.href=m,(a=\"hideFocus\"in r)&&r.relList&&(a=0,r.rel=\"preload\",r.as=\"style\")):/(^img!|\\.(png|gif|jpg|svg|webp)$)/.test(d)?(r=l.createElement(\"img\")).src=m:((r=l.createElement(\"script\")).src=t,r.async=void 0===c||c),r.onload=r.onerror=r.onbeforeload=function(e){var l=e.type[0];if(a)try{r.sheet.cssText.length||(l=\"e\")}catch(e){18!=e.code&&(l=\"e\")}if(\"e\"==l){if((n+=1){Ke.ready.call(e)})).catch((t=>{e.debug.warn(\"Vimeo SDK (player.js) failed to load\",t)}))},ready(){const e=this,t=e.config.vimeo,{premium:i,referrerPolicy:s,...n}=t;let a=e.media.getAttribute(\"src\"),r=\"\";A.empty(a)?(a=e.media.getAttribute(e.config.attributes.embed.id),r=e.media.getAttribute(e.config.attributes.embed.hash)):r=function(e){const t=e.match(/^.*(vimeo.com\\/|video\\/)(\\d+)(\\?.*&*h=|\\/)+([\\d,a-f]+)/);return t&&5===t.length?t[4]:null}(a);const o=r?{h:r}:{};i&&Object.assign(n,{controls:!1,sidedock:!1});const l=Le({loop:e.config.loop.active,autoplay:e.autoplay,muted:e.muted,gesture:\"media\",playsinline:e.config.playsinline,...o,...n}),c=(u=a,A.empty(u)?null:A.number(Number(u))?u:u.match(/^.*(vimeo.com\\/|video\\/)(\\d+).*/)?RegExp.$2:u);var u;const h=O(\"iframe\"),d=pe(e.config.urls.vimeo.iframe,c,l);if(h.setAttribute(\"src\",d),h.setAttribute(\"allowfullscreen\",\"\"),h.setAttribute(\"allow\",[\"autoplay\",\"fullscreen\",\"picture-in-picture\",\"encrypted-media\",\"accelerometer\",\"gyroscope\"].join(\"; \")),A.empty(s)||h.setAttribute(\"referrerPolicy\",s),i||!t.customControls)h.setAttribute(\"data-poster\",e.poster),e.media=D(h,e.media);else{const t=O(\"div\",{class:e.config.classNames.embedContainer,\"data-poster\":e.poster});t.appendChild(h),e.media=D(t,e.media)}t.customControls||ke(pe(e.config.urls.vimeo.api,d)).then((t=>{!A.empty(t)&&t.thumbnail_url&&Ue.setPoster.call(e,t.thumbnail_url).catch((()=>{}))})),e.embed=new window.Vimeo.Player(h,{autopause:e.config.autopause,muted:e.muted}),e.media.paused=!0,e.media.currentTime=0,e.supported.ui&&e.embed.disableTextTrack(),e.media.play=()=>(ze.call(e,!0),e.embed.play()),e.media.pause=()=>(ze.call(e,!1),e.embed.pause()),e.media.stop=()=>{e.pause(),e.currentTime=0};let{currentTime:m}=e.media;Object.defineProperty(e.media,\"currentTime\",{get:()=>m,set(t){const{embed:i,media:s,paused:n,volume:a}=e,r=n&&!i.hasPlayed;s.seeking=!0,ee.call(e,s,\"seeking\"),Promise.resolve(r&&i.setVolume(0)).then((()=>i.setCurrentTime(t))).then((()=>r&&i.pause())).then((()=>r&&i.setVolume(a))).catch((()=>{}))}});let p=e.config.speed.selected;Object.defineProperty(e.media,\"playbackRate\",{get:()=>p,set(t){e.embed.setPlaybackRate(t).then((()=>{p=t,ee.call(e,e.media,\"ratechange\")})).catch((()=>{e.options.speed=[1]}))}});let{volume:g}=e.config;Object.defineProperty(e.media,\"volume\",{get:()=>g,set(t){e.embed.setVolume(t).then((()=>{g=t,ee.call(e,e.media,\"volumechange\")}))}});let{muted:f}=e.config;Object.defineProperty(e.media,\"muted\",{get:()=>f,set(t){const i=!!A.boolean(t)&&t;e.embed.setMuted(!!i||e.config.muted).then((()=>{f=i,ee.call(e,e.media,\"volumechange\")}))}});let y,{loop:b}=e.config;Object.defineProperty(e.media,\"loop\",{get:()=>b,set(t){const i=A.boolean(t)?t:e.config.loop.active;e.embed.setLoop(i).then((()=>{b=i}))}}),e.embed.getVideoUrl().then((t=>{y=t,Me.setDownloadUrl.call(e)})).catch((e=>{this.debug.warn(e)})),Object.defineProperty(e.media,\"currentSrc\",{get:()=>y}),Object.defineProperty(e.media,\"ended\",{get:()=>e.currentTime===e.duration}),Promise.all([e.embed.getVideoWidth(),e.embed.getVideoHeight()]).then((t=>{const[i,s]=t;e.embed.ratio=de(i,s),he.call(this)})),e.embed.setAutopause(e.config.autopause).then((t=>{e.config.autopause=t})),e.embed.getVideoTitle().then((t=>{e.config.title=t,Ue.setTitle.call(this)})),e.embed.getCurrentTime().then((t=>{m=t,ee.call(e,e.media,\"timeupdate\")})),e.embed.getDuration().then((t=>{e.media.duration=t,ee.call(e,e.media,\"durationchange\")})),e.embed.getTextTracks().then((t=>{e.media.textTracks=t,Ne.setup.call(e)})),e.embed.on(\"cuechange\",(({cues:t=[]})=>{const i=t.map((e=>function(e){const t=document.createDocumentFragment(),i=document.createElement(\"div\");return t.appendChild(i),i.innerHTML=e,t.firstChild.innerText}(e.text)));Ne.updateCues.call(e,i)})),e.embed.on(\"loaded\",(()=>{if(e.embed.getPaused().then((t=>{ze.call(e,!t),t||ee.call(e,e.media,\"playing\")})),A.element(e.embed.element)&&e.supported.ui){e.embed.element.setAttribute(\"tabindex\",-1)}})),e.embed.on(\"bufferstart\",(()=>{ee.call(e,e.media,\"waiting\")})),e.embed.on(\"bufferend\",(()=>{ee.call(e,e.media,\"playing\")})),e.embed.on(\"play\",(()=>{ze.call(e,!0),ee.call(e,e.media,\"playing\")})),e.embed.on(\"pause\",(()=>{ze.call(e,!1)})),e.embed.on(\"timeupdate\",(t=>{e.media.seeking=!1,m=t.seconds,ee.call(e,e.media,\"timeupdate\")})),e.embed.on(\"progress\",(t=>{e.media.buffered=t.percent,ee.call(e,e.media,\"progress\"),1===parseInt(t.percent,10)&&ee.call(e,e.media,\"canplaythrough\"),e.embed.getDuration().then((t=>{t!==e.media.duration&&(e.media.duration=t,ee.call(e,e.media,\"durationchange\"))}))})),e.embed.on(\"seeked\",(()=>{e.media.seeking=!1,ee.call(e,e.media,\"seeked\")})),e.embed.on(\"ended\",(()=>{e.media.paused=!0,ee.call(e,e.media,\"ended\")})),e.embed.on(\"error\",(t=>{e.media.error=t,ee.call(e,e.media,\"error\")})),t.customControls&&setTimeout((()=>Ue.build.call(e)),0)}};function Ye(e){e&&!this.embed.hasPlayed&&(this.embed.hasPlayed=!0),this.media.paused===e&&(this.media.paused=!e,ee.call(this,this.media,e?\"play\":\"pause\"))}function Qe(e){return e.noCookie?\"https://www.youtube-nocookie.com\":\"http:\"===window.location.protocol?\"http://www.youtube.com\":void 0}const Xe={setup(){if(F(this.elements.wrapper,this.config.classNames.embed,!0),A.object(window.YT)&&A.function(window.YT.Player))Xe.ready.call(this);else{const e=window.onYouTubeIframeAPIReady;window.onYouTubeIframeAPIReady=()=>{A.function(e)&&e(),Xe.ready.call(this)},We(this.config.urls.youtube.sdk).catch((e=>{this.debug.warn(\"YouTube API failed to load\",e)}))}},getTitle(e){ke(pe(this.config.urls.youtube.api,e)).then((e=>{if(A.object(e)){const{title:t,height:i,width:s}=e;this.config.title=t,Ue.setTitle.call(this),this.embed.ratio=de(s,i)}he.call(this)})).catch((()=>{he.call(this)}))},ready(){const e=this,t=e.config.youtube,i=e.media&&e.media.getAttribute(\"id\");if(!A.empty(i)&&i.startsWith(\"youtube-\"))return;let s=e.media.getAttribute(\"src\");A.empty(s)&&(s=e.media.getAttribute(this.config.attributes.embed.id));const n=(a=s,A.empty(a)?null:a.match(/^.*(youtu.be\\/|v\\/|u\\/\\w\\/|embed\\/|watch\\?v=|&v=)([^#&?]*).*/)?RegExp.$2:a);var a;const r=O(\"div\",{id:`${e.provider}-${Math.floor(1e4*Math.random())}`,\"data-poster\":t.customControls?e.poster:void 0});if(e.media=D(r,e.media),t.customControls){const t=e=>`https://i.ytimg.com/vi/${n}/${e}default.jpg`;Fe(t(\"maxres\"),121).catch((()=>Fe(t(\"sd\"),121))).catch((()=>Fe(t(\"hq\")))).then((t=>Ue.setPoster.call(e,t.src))).then((t=>{t.includes(\"maxres\")||(e.elements.poster.style.backgroundSize=\"cover\")})).catch((()=>{}))}e.embed=new window.YT.Player(e.media,{videoId:n,host:Qe(t),playerVars:N({},{autoplay:e.config.autoplay?1:0,hl:e.config.hl,controls:e.supported.ui&&t.customControls?0:1,disablekb:1,playsinline:e.config.playsinline&&!e.config.fullscreen.iosNative?1:0,cc_load_policy:e.captions.active?1:0,cc_lang_pref:e.config.captions.language,widget_referrer:window?window.location.href:null},t),events:{onError(t){if(!e.media.error){const i=t.data,s={2:\"The request contains an invalid parameter value. For example, this error occurs if you specify a video ID that does not have 11 characters, or if the video ID contains invalid characters, such as exclamation points or asterisks.\",5:\"The requested content cannot be played in an HTML5 player or another error related to the HTML5 player has occurred.\",100:\"The video requested was not found. This error occurs when a video has been removed (for any reason) or has been marked as private.\",101:\"The owner of the requested video does not allow it to be played in embedded players.\",150:\"The owner of the requested video does not allow it to be played in embedded players.\"}[i]||\"An unknown error occurred\";e.media.error={code:i,message:s},ee.call(e,e.media,\"error\")}},onPlaybackRateChange(t){const i=t.target;e.media.playbackRate=i.getPlaybackRate(),ee.call(e,e.media,\"ratechange\")},onReady(i){if(A.function(e.media.play))return;const s=i.target;Xe.getTitle.call(e,n),e.media.play=()=>{Ye.call(e,!0),s.playVideo()},e.media.pause=()=>{Ye.call(e,!1),s.pauseVideo()},e.media.stop=()=>{s.stopVideo()},e.media.duration=s.getDuration(),e.media.paused=!0,e.media.currentTime=0,Object.defineProperty(e.media,\"currentTime\",{get:()=>Number(s.getCurrentTime()),set(t){e.paused&&!e.embed.hasPlayed&&e.embed.mute(),e.media.seeking=!0,ee.call(e,e.media,\"seeking\"),s.seekTo(t)}}),Object.defineProperty(e.media,\"playbackRate\",{get:()=>s.getPlaybackRate(),set(e){s.setPlaybackRate(e)}});let{volume:a}=e.config;Object.defineProperty(e.media,\"volume\",{get:()=>a,set(t){a=t,s.setVolume(100*a),ee.call(e,e.media,\"volumechange\")}});let{muted:r}=e.config;Object.defineProperty(e.media,\"muted\",{get:()=>r,set(t){const i=A.boolean(t)?t:r;r=i,s[i?\"mute\":\"unMute\"](),s.setVolume(100*a),ee.call(e,e.media,\"volumechange\")}}),Object.defineProperty(e.media,\"currentSrc\",{get:()=>s.getVideoUrl()}),Object.defineProperty(e.media,\"ended\",{get:()=>e.currentTime===e.duration});const o=s.getAvailablePlaybackRates();e.options.speed=o.filter((t=>e.config.speed.options.includes(t))),e.supported.ui&&t.customControls&&e.media.setAttribute(\"tabindex\",-1),ee.call(e,e.media,\"timeupdate\"),ee.call(e,e.media,\"durationchange\"),clearInterval(e.timers.buffering),e.timers.buffering=setInterval((()=>{e.media.buffered=s.getVideoLoadedFraction(),(null===e.media.lastBuffered||e.media.lastBufferedUe.build.call(e)),50)},onStateChange(i){const s=i.target;clearInterval(e.timers.playing);switch(e.media.seeking&&[1,2].includes(i.data)&&(e.media.seeking=!1,ee.call(e,e.media,\"seeked\")),i.data){case-1:ee.call(e,e.media,\"timeupdate\"),e.media.buffered=s.getVideoLoadedFraction(),ee.call(e,e.media,\"progress\");break;case 0:Ye.call(e,!1),e.media.loop?(s.stopVideo(),s.playVideo()):ee.call(e,e.media,\"ended\");break;case 1:t.customControls&&!e.config.autoplay&&e.media.paused&&!e.embed.hasPlayed?e.media.pause():(Ye.call(e,!0),ee.call(e,e.media,\"playing\"),e.timers.playing=setInterval((()=>{ee.call(e,e.media,\"timeupdate\")}),50),e.media.duration!==s.getDuration()&&(e.media.duration=s.getDuration(),ee.call(e,e.media,\"durationchange\")));break;case 2:e.muted||e.embed.unMute(),Ye.call(e,!1);break;case 3:ee.call(e,e.media,\"waiting\")}ee.call(e,e.elements.container,\"statechange\",!1,{code:i.data})}}})}},Je={setup(){this.media?(F(this.elements.container,this.config.classNames.type.replace(\"{0}\",this.type),!0),F(this.elements.container,this.config.classNames.provider.replace(\"{0}\",this.provider),!0),this.isEmbed&&F(this.elements.container,this.config.classNames.type.replace(\"{0}\",\"video\"),!0),this.isVideo&&(this.elements.wrapper=O(\"div\",{class:this.config.classNames.video}),_(this.media,this.elements.wrapper),this.elements.poster=O(\"div\",{class:this.config.classNames.poster}),this.elements.wrapper.appendChild(this.elements.poster)),this.isHTML5?me.setup.call(this):this.isYouTube?Xe.setup.call(this):this.isVimeo&&Ke.setup.call(this)):this.debug.warn(\"No media element found!\")}};class Ge{constructor(e){t(this,\"load\",(()=>{this.enabled&&(A.object(window.google)&&A.object(window.google.ima)?this.ready():We(this.player.config.urls.googleIMA.sdk).then((()=>{this.ready()})).catch((()=>{this.trigger(\"error\",new Error(\"Google IMA SDK failed to load\"))})))})),t(this,\"ready\",(()=>{var e;this.enabled||((e=this).manager&&e.manager.destroy(),e.elements.displayContainer&&e.elements.displayContainer.destroy(),e.elements.container.remove()),this.startSafetyTimer(12e3,\"ready()\"),this.managerPromise.then((()=>{this.clearSafetyTimer(\"onAdsManagerLoaded()\")})),this.listeners(),this.setupIMA()})),t(this,\"setupIMA\",(()=>{this.elements.container=O(\"div\",{class:this.player.config.classNames.ads}),this.player.elements.container.appendChild(this.elements.container),google.ima.settings.setVpaidMode(google.ima.ImaSdkSettings.VpaidMode.ENABLED),google.ima.settings.setLocale(this.player.config.ads.language),google.ima.settings.setDisableCustomPlaybackForIOS10Plus(this.player.config.playsinline),this.elements.displayContainer=new google.ima.AdDisplayContainer(this.elements.container,this.player.media),this.loader=new google.ima.AdsLoader(this.elements.displayContainer),this.loader.addEventListener(google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED,(e=>this.onAdsManagerLoaded(e)),!1),this.loader.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR,(e=>this.onAdError(e)),!1),this.requestAds()})),t(this,\"requestAds\",(()=>{const{container:e}=this.player.elements;try{const t=new google.ima.AdsRequest;t.adTagUrl=this.tagUrl,t.linearAdSlotWidth=e.offsetWidth,t.linearAdSlotHeight=e.offsetHeight,t.nonLinearAdSlotWidth=e.offsetWidth,t.nonLinearAdSlotHeight=e.offsetHeight,t.forceNonLinearFullSlot=!1,t.setAdWillPlayMuted(!this.player.muted),this.loader.requestAds(t)}catch(e){this.onAdError(e)}})),t(this,\"pollCountdown\",((e=!1)=>{if(!e)return clearInterval(this.countdownTimer),void this.elements.container.removeAttribute(\"data-badge-text\");this.countdownTimer=setInterval((()=>{const e=Pe(Math.max(this.manager.getRemainingTime(),0)),t=`${we.get(\"advertisement\",this.player.config)} - ${e}`;this.elements.container.setAttribute(\"data-badge-text\",t)}),100)})),t(this,\"onAdsManagerLoaded\",(e=>{if(!this.enabled)return;const t=new google.ima.AdsRenderingSettings;t.restoreCustomPlaybackStateOnAdBreakComplete=!0,t.enablePreloading=!0,this.manager=e.getAdsManager(this.player,t),this.cuePoints=this.manager.getCuePoints(),this.manager.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR,(e=>this.onAdError(e))),Object.keys(google.ima.AdEvent.Type).forEach((e=>{this.manager.addEventListener(google.ima.AdEvent.Type[e],(e=>this.onAdEvent(e)))})),this.trigger(\"loaded\")})),t(this,\"addCuePoints\",(()=>{A.empty(this.cuePoints)||this.cuePoints.forEach((e=>{if(0!==e&&-1!==e&&e{const{container:t}=this.player.elements,i=e.getAd(),s=e.getAdData();switch((e=>{ee.call(this.player,this.player.media,`ads${e.replace(/_/g,\"\").toLowerCase()}`)})(e.type),e.type){case google.ima.AdEvent.Type.LOADED:this.trigger(\"loaded\"),this.pollCountdown(!0),i.isLinear()||(i.width=t.offsetWidth,i.height=t.offsetHeight);break;case google.ima.AdEvent.Type.STARTED:this.manager.setVolume(this.player.volume);break;case google.ima.AdEvent.Type.ALL_ADS_COMPLETED:this.player.ended?this.loadAds():this.loader.contentComplete();break;case google.ima.AdEvent.Type.CONTENT_PAUSE_REQUESTED:this.pauseContent();break;case google.ima.AdEvent.Type.CONTENT_RESUME_REQUESTED:this.pollCountdown(),this.resumeContent();break;case google.ima.AdEvent.Type.LOG:s.adError&&this.player.debug.warn(`Non-fatal ad error: ${s.adError.getMessage()}`)}})),t(this,\"onAdError\",(e=>{this.cancel(),this.player.debug.warn(\"Ads error\",e)})),t(this,\"listeners\",(()=>{const{container:e}=this.player.elements;let t;this.player.on(\"canplay\",(()=>{this.addCuePoints()})),this.player.on(\"ended\",(()=>{this.loader.contentComplete()})),this.player.on(\"timeupdate\",(()=>{t=this.player.currentTime})),this.player.on(\"seeked\",(()=>{const e=this.player.currentTime;A.empty(this.cuePoints)||this.cuePoints.forEach(((i,s)=>{t{const{container:e}=this.player.elements;this.managerPromise||this.resumeContent(),this.managerPromise.then((()=>{this.manager.setVolume(this.player.volume),this.elements.displayContainer.initialize();try{this.initialized||(this.manager.init(e.offsetWidth,e.offsetHeight,google.ima.ViewMode.NORMAL),this.manager.start()),this.initialized=!0}catch(e){this.onAdError(e)}})).catch((()=>{}))})),t(this,\"resumeContent\",(()=>{this.elements.container.style.zIndex=\"\",this.playing=!1,se(this.player.media.play())})),t(this,\"pauseContent\",(()=>{this.elements.container.style.zIndex=3,this.playing=!0,this.player.media.pause()})),t(this,\"cancel\",(()=>{this.initialized&&this.resumeContent(),this.trigger(\"error\"),this.loadAds()})),t(this,\"loadAds\",(()=>{this.managerPromise.then((()=>{this.manager&&this.manager.destroy(),this.managerPromise=new Promise((e=>{this.on(\"loaded\",e),this.player.debug.log(this.manager)})),this.initialized=!1,this.requestAds()})).catch((()=>{}))})),t(this,\"trigger\",((e,...t)=>{const i=this.events[e];A.array(i)&&i.forEach((e=>{A.function(e)&&e.apply(this,t)}))})),t(this,\"on\",((e,t)=>(A.array(this.events[e])||(this.events[e]=[]),this.events[e].push(t),this))),t(this,\"startSafetyTimer\",((e,t)=>{this.player.debug.log(`Safety timer invoked from: ${t}`),this.safetyTimer=setTimeout((()=>{this.cancel(),this.clearSafetyTimer(\"startSafetyTimer()\")}),e)})),t(this,\"clearSafetyTimer\",(e=>{A.nullOrUndefined(this.safetyTimer)||(this.player.debug.log(`Safety timer cleared from: ${e}`),clearTimeout(this.safetyTimer),this.safetyTimer=null)})),this.player=e,this.config=e.config.ads,this.playing=!1,this.initialized=!1,this.elements={container:null,displayContainer:null},this.manager=null,this.loader=null,this.cuePoints=null,this.events={},this.safetyTimer=null,this.countdownTimer=null,this.managerPromise=new Promise(((e,t)=>{this.on(\"loaded\",e),this.on(\"error\",t)})),this.load()}get enabled(){const{config:e}=this;return this.player.isHTML5&&this.player.isVideo&&e.enabled&&(!A.empty(e.publisherId)||A.url(e.tagUrl))}get tagUrl(){const{config:e}=this;if(A.url(e.tagUrl))return e.tagUrl;return`https://go.aniview.com/api/adserver6/vast/?${Le({AV_PUBLISHERID:\"58c25bb0073ef448b1087ad6\",AV_CHANNELID:\"5a0458dc28a06145e4519d21\",AV_URL:window.location.hostname,cb:Date.now(),AV_WIDTH:640,AV_HEIGHT:480,AV_CDIM2:e.publisherId})}`}}function Ze(e=0,t=0,i=255){return Math.min(Math.max(e,t),i)}const et=e=>{const t=[];return e.split(/\\r\\n\\r\\n|\\n\\n|\\r\\r/).forEach((e=>{const i={};e.split(/\\r\\n|\\n|\\r/).forEach((e=>{if(A.number(i.startTime)){if(!A.empty(e.trim())&&A.empty(i.text)){const t=e.trim().split(\"#xywh=\");[i.text]=t,t[1]&&([i.x,i.y,i.w,i.h]=t[1].split(\",\"))}}else{const t=e.match(/([0-9]{2})?:?([0-9]{2}):([0-9]{2}).([0-9]{2,3})( ?--> ?)([0-9]{2})?:?([0-9]{2}):([0-9]{2}).([0-9]{2,3})/);t&&(i.startTime=60*Number(t[1]||0)*60+60*Number(t[2])+Number(t[3])+Number(`0.${t[4]}`),i.endTime=60*Number(t[6]||0)*60+60*Number(t[7])+Number(t[8])+Number(`0.${t[9]}`))}})),i.text&&t.push(i)})),t},tt=(e,t)=>{const i={};return e>t.width/t.height?(i.width=t.width,i.height=1/e*t.width):(i.height=t.height,i.width=e*t.height),i};class it{constructor(e){t(this,\"load\",(()=>{this.player.elements.display.seekTooltip&&(this.player.elements.display.seekTooltip.hidden=this.enabled),this.enabled&&this.getThumbnails().then((()=>{this.enabled&&(this.render(),this.determineContainerAutoSizing(),this.listeners(),this.loaded=!0)}))})),t(this,\"getThumbnails\",(()=>new Promise((e=>{const{src:t}=this.player.config.previewThumbnails;if(A.empty(t))throw new Error(\"Missing previewThumbnails.src config attribute\");const i=()=>{this.thumbnails.sort(((e,t)=>e.height-t.height)),this.player.debug.log(\"Preview thumbnails\",this.thumbnails),e()};if(A.function(t))t((e=>{this.thumbnails=e,i()}));else{const e=(A.string(t)?[t]:t).map((e=>this.getThumbnail(e)));Promise.all(e).then(i)}})))),t(this,\"getThumbnail\",(e=>new Promise((t=>{ke(e).then((i=>{const s={frames:et(i),height:null,urlPrefix:\"\"};s.frames[0].text.startsWith(\"/\")||s.frames[0].text.startsWith(\"http://\")||s.frames[0].text.startsWith(\"https://\")||(s.urlPrefix=e.substring(0,e.lastIndexOf(\"/\")+1));const n=new Image;n.onload=()=>{s.height=n.naturalHeight,s.width=n.naturalWidth,this.thumbnails.push(s),t()},n.src=s.urlPrefix+s.frames[0].text}))})))),t(this,\"startMove\",(e=>{if(this.loaded&&A.event(e)&&[\"touchmove\",\"mousemove\"].includes(e.type)&&this.player.media.duration){if(\"touchmove\"===e.type)this.seekTime=this.player.media.duration*(this.player.elements.inputs.seek.value/100);else{var t,i;const s=this.player.elements.progress.getBoundingClientRect(),n=100/s.width*(e.pageX-s.left);this.seekTime=this.player.media.duration*(n/100),this.seekTimethis.player.media.duration-1&&(this.seekTime=this.player.media.duration-1),this.mousePosX=e.pageX,this.elements.thumb.time.innerText=Pe(this.seekTime);const a=null===(t=this.player.config.markers)||void 0===t||null===(i=t.points)||void 0===i?void 0:i.find((({time:e})=>e===Math.round(this.seekTime)));a&&this.elements.thumb.time.insertAdjacentHTML(\"afterbegin\",`${a.label}`)}this.showImageAtCurrentTime()}})),t(this,\"endMove\",(()=>{this.toggleThumbContainer(!1,!0)})),t(this,\"startScrubbing\",(e=>{(A.nullOrUndefined(e.button)||!1===e.button||0===e.button)&&(this.mouseDown=!0,this.player.media.duration&&(this.toggleScrubbingContainer(!0),this.toggleThumbContainer(!1,!0),this.showImageAtCurrentTime()))})),t(this,\"endScrubbing\",(()=>{this.mouseDown=!1,Math.ceil(this.lastTime)===Math.ceil(this.player.media.currentTime)?this.toggleScrubbingContainer(!1):Z.call(this.player,this.player.media,\"timeupdate\",(()=>{this.mouseDown||this.toggleScrubbingContainer(!1)}))})),t(this,\"listeners\",(()=>{this.player.on(\"play\",(()=>{this.toggleThumbContainer(!1,!0)})),this.player.on(\"seeked\",(()=>{this.toggleThumbContainer(!1)})),this.player.on(\"timeupdate\",(()=>{this.lastTime=this.player.media.currentTime}))})),t(this,\"render\",(()=>{this.elements.thumb.container=O(\"div\",{class:this.player.config.classNames.previewThumbnails.thumbContainer}),this.elements.thumb.imageContainer=O(\"div\",{class:this.player.config.classNames.previewThumbnails.imageContainer}),this.elements.thumb.container.appendChild(this.elements.thumb.imageContainer);const e=O(\"div\",{class:this.player.config.classNames.previewThumbnails.timeContainer});this.elements.thumb.time=O(\"span\",{},\"00:00\"),e.appendChild(this.elements.thumb.time),this.elements.thumb.imageContainer.appendChild(e),A.element(this.player.elements.progress)&&this.player.elements.progress.appendChild(this.elements.thumb.container),this.elements.scrubbing.container=O(\"div\",{class:this.player.config.classNames.previewThumbnails.scrubbingContainer}),this.player.elements.wrapper.appendChild(this.elements.scrubbing.container)})),t(this,\"destroy\",(()=>{this.elements.thumb.container&&this.elements.thumb.container.remove(),this.elements.scrubbing.container&&this.elements.scrubbing.container.remove()})),t(this,\"showImageAtCurrentTime\",(()=>{this.mouseDown?this.setScrubbingContainerSize():this.setThumbContainerSizeAndPos();const e=this.thumbnails[0].frames.findIndex((e=>this.seekTime>=e.startTime&&this.seekTime=0;let i=0;this.mouseDown||this.toggleThumbContainer(t),t&&(this.thumbnails.forEach(((t,s)=>{this.loadedImages.includes(t.frames[e].text)&&(i=s)})),e!==this.showingThumb&&(this.showingThumb=e,this.loadImage(i)))})),t(this,\"loadImage\",((e=0)=>{const t=this.showingThumb,i=this.thumbnails[e],{urlPrefix:s}=i,n=i.frames[t],a=i.frames[t].text,r=s+a;if(this.currentImageElement&&this.currentImageElement.dataset.filename===a)this.showImage(this.currentImageElement,n,e,t,a,!1),this.currentImageElement.dataset.index=t,this.removeOldImages(this.currentImageElement);else{this.loadingImage&&this.usingSprites&&(this.loadingImage.onload=null);const i=new Image;i.src=r,i.dataset.index=t,i.dataset.filename=a,this.showingThumbFilename=a,this.player.debug.log(`Loading image: ${r}`),i.onload=()=>this.showImage(i,n,e,t,a,!0),this.loadingImage=i,this.removeOldImages(i)}})),t(this,\"showImage\",((e,t,i,s,n,a=!0)=>{this.player.debug.log(`Showing thumb: ${n}. num: ${s}. qual: ${i}. newimg: ${a}`),this.setImageSizeAndOffset(e,t),a&&(this.currentImageContainer.appendChild(e),this.currentImageElement=e,this.loadedImages.includes(n)||this.loadedImages.push(n)),this.preloadNearby(s,!0).then(this.preloadNearby(s,!1)).then(this.getHigherQuality(i,e,t,n))})),t(this,\"removeOldImages\",(e=>{Array.from(this.currentImageContainer.children).forEach((t=>{if(\"img\"!==t.tagName.toLowerCase())return;const i=this.usingSprites?500:1e3;if(t.dataset.index!==e.dataset.index&&!t.dataset.deleting){t.dataset.deleting=!0;const{currentImageContainer:e}=this;setTimeout((()=>{e.removeChild(t),this.player.debug.log(`Removing thumb: ${t.dataset.filename}`)}),i)}}))})),t(this,\"preloadNearby\",((e,t=!0)=>new Promise((i=>{setTimeout((()=>{const s=this.thumbnails[0].frames[e].text;if(this.showingThumbFilename===s){let n;n=t?this.thumbnails[0].frames.slice(e):this.thumbnails[0].frames.slice(0,e).reverse();let a=!1;n.forEach((e=>{const t=e.text;if(t!==s&&!this.loadedImages.includes(t)){a=!0,this.player.debug.log(`Preloading thumb filename: ${t}`);const{urlPrefix:e}=this.thumbnails[0],s=e+t,n=new Image;n.src=s,n.onload=()=>{this.player.debug.log(`Preloaded thumb filename: ${t}`),this.loadedImages.includes(t)||this.loadedImages.push(t),i()}}})),a||i()}}),300)})))),t(this,\"getHigherQuality\",((e,t,i,s)=>{if(e{const i=this.player.config.classNames.previewThumbnails.thumbContainerShown;this.elements.thumb.container.classList.toggle(i,e),!e&&t&&(this.showingThumb=null,this.showingThumbFilename=null)})),t(this,\"toggleScrubbingContainer\",((e=!1)=>{const t=this.player.config.classNames.previewThumbnails.scrubbingContainerShown;this.elements.scrubbing.container.classList.toggle(t,e),e||(this.showingThumb=null,this.showingThumbFilename=null)})),t(this,\"determineContainerAutoSizing\",(()=>{(this.elements.thumb.imageContainer.clientHeight>20||this.elements.thumb.imageContainer.clientWidth>20)&&(this.sizeSpecifiedInCSS=!0)})),t(this,\"setThumbContainerSizeAndPos\",(()=>{const{imageContainer:e}=this.elements.thumb;if(this.sizeSpecifiedInCSS){if(e.clientHeight>20&&e.clientWidth{const e=this.player.elements.progress.getBoundingClientRect(),t=this.player.elements.container.getBoundingClientRect(),{container:i}=this.elements.thumb,s=t.left-e.left+10,n=t.right-e.left-i.clientWidth-10,a=this.mousePosX-e.left-i.clientWidth/2,r=Ze(a,s,n);i.style.left=`${r}px`,i.style.setProperty(\"--preview-arrow-offset\",a-r+\"px\")})),t(this,\"setScrubbingContainerSize\",(()=>{const{width:e,height:t}=tt(this.thumbAspectRatio,{width:this.player.media.clientWidth,height:this.player.media.clientHeight});this.elements.scrubbing.container.style.width=`${e}px`,this.elements.scrubbing.container.style.height=`${t}px`})),t(this,\"setImageSizeAndOffset\",((e,t)=>{if(!this.usingSprites)return;const i=this.thumbContainerHeight/t.h;e.style.height=e.naturalHeight*i+\"px\",e.style.width=e.naturalWidth*i+\"px\",e.style.left=`-${t.x*i}px`,e.style.top=`-${t.y*i}px`})),this.player=e,this.thumbnails=[],this.loaded=!1,this.lastMouseMoveTime=Date.now(),this.mouseDown=!1,this.loadedImages=[],this.elements={thumb:{},scrubbing:{}},this.load()}get enabled(){return this.player.isHTML5&&this.player.isVideo&&this.player.config.previewThumbnails.enabled}get currentImageContainer(){return this.mouseDown?this.elements.scrubbing.container:this.elements.thumb.imageContainer}get usingSprites(){return Object.keys(this.thumbnails[0].frames[0]).includes(\"w\")}get thumbAspectRatio(){return this.usingSprites?this.thumbnails[0].frames[0].w/this.thumbnails[0].frames[0].h:this.thumbnails[0].width/this.thumbnails[0].height}get thumbContainerHeight(){if(this.mouseDown){const{height:e}=tt(this.thumbAspectRatio,{width:this.player.media.clientWidth,height:this.player.media.clientHeight});return e}return this.sizeSpecifiedInCSS?this.elements.thumb.imageContainer.clientHeight:Math.floor(this.player.media.clientWidth/this.thumbAspectRatio/4)}get currentImageElement(){return this.mouseDown?this.currentScrubbingImageElement:this.currentThumbnailImageElement}set currentImageElement(e){this.mouseDown?this.currentScrubbingImageElement=e:this.currentThumbnailImageElement=e}}const st={insertElements(e,t){A.string(t)?$(e,this.media,{src:t}):A.array(t)&&t.forEach((t=>{$(e,this.media,t)}))},change(e){L(e,\"sources.length\")?(me.cancelRequests.call(this),this.destroy.call(this,(()=>{this.options.quality=[],j(this.media),this.media=null,A.element(this.elements.container)&&this.elements.container.removeAttribute(\"class\");const{sources:t,type:i}=e,[{provider:s=$e.html5,src:n}]=t,a=\"html5\"===s?i:\"div\",r=\"html5\"===s?{}:{src:n};Object.assign(this,{provider:s,type:i,supported:Y.check(i,s,this.config.playsinline),media:O(a,r)}),this.elements.container.appendChild(this.media),A.boolean(e.autoplay)&&(this.config.autoplay=e.autoplay),this.isHTML5&&(this.config.crossorigin&&this.media.setAttribute(\"crossorigin\",\"\"),this.config.autoplay&&this.media.setAttribute(\"autoplay\",\"\"),A.empty(e.poster)||(this.poster=e.poster),this.config.loop.active&&this.media.setAttribute(\"loop\",\"\"),this.config.muted&&this.media.setAttribute(\"muted\",\"\"),this.config.playsinline&&this.media.setAttribute(\"playsinline\",\"\")),Ue.addStyleHook.call(this),this.isHTML5&&st.insertElements.call(this,\"source\",t),this.config.title=e.title,Je.setup.call(this),this.isHTML5&&Object.keys(e).includes(\"tracks\")&&st.insertElements.call(this,\"track\",e.tracks),(this.isHTML5||this.isEmbed&&!this.supported.ui)&&Ue.build.call(this),this.isHTML5&&this.media.load(),A.empty(e.previewThumbnails)||(Object.assign(this.config.previewThumbnails,e.previewThumbnails),this.previewThumbnails&&this.previewThumbnails.loaded&&(this.previewThumbnails.destroy(),this.previewThumbnails=null),this.config.previewThumbnails.enabled&&(this.previewThumbnails=new it(this))),this.fullscreen.update()}),!0)):this.debug.warn(\"Invalid source format\")}};class nt{constructor(e,i){if(t(this,\"play\",(()=>A.function(this.media.play)?(this.ads&&this.ads.enabled&&this.ads.managerPromise.then((()=>this.ads.play())).catch((()=>se(this.media.play()))),this.media.play()):null)),t(this,\"pause\",(()=>this.playing&&A.function(this.media.pause)?this.media.pause():null)),t(this,\"togglePlay\",(e=>(A.boolean(e)?e:!this.playing)?this.play():this.pause())),t(this,\"stop\",(()=>{this.isHTML5?(this.pause(),this.restart()):A.function(this.media.stop)&&this.media.stop()})),t(this,\"restart\",(()=>{this.currentTime=0})),t(this,\"rewind\",(e=>{this.currentTime-=A.number(e)?e:this.config.seekTime})),t(this,\"forward\",(e=>{this.currentTime+=A.number(e)?e:this.config.seekTime})),t(this,\"increaseVolume\",(e=>{const t=this.media.muted?0:this.volume;this.volume=t+(A.number(e)?e:0)})),t(this,\"decreaseVolume\",(e=>{this.increaseVolume(-e)})),t(this,\"airplay\",(()=>{Y.airplay&&this.media.webkitShowPlaybackTargetPicker()})),t(this,\"toggleControls\",(e=>{if(this.supported.ui&&!this.isAudio){const t=U(this.elements.container,this.config.classNames.hideControls),i=void 0===e?void 0:!e,s=F(this.elements.container,this.config.classNames.hideControls,i);if(s&&A.array(this.config.controls)&&this.config.controls.includes(\"settings\")&&!A.empty(this.config.settings)&&Me.toggleMenu.call(this,!1),s!==t){const e=s?\"controlshidden\":\"controlsshown\";ee.call(this,this.media,e)}return!s}return!1})),t(this,\"on\",((e,t)=>{J.call(this,this.elements.container,e,t)})),t(this,\"once\",((e,t)=>{Z.call(this,this.elements.container,e,t)})),t(this,\"off\",((e,t)=>{G(this.elements.container,e,t)})),t(this,\"destroy\",((e,t=!1)=>{if(!this.ready)return;const i=()=>{document.body.style.overflow=\"\",this.embed=null,t?(Object.keys(this.elements).length&&(j(this.elements.buttons.play),j(this.elements.captions),j(this.elements.controls),j(this.elements.wrapper),this.elements.buttons.play=null,this.elements.captions=null,this.elements.controls=null,this.elements.wrapper=null),A.function(e)&&e()):(te.call(this),me.cancelRequests.call(this),D(this.elements.original,this.elements.container),ee.call(this,this.elements.original,\"destroyed\",!0),A.function(e)&&e.call(this.elements.original),this.ready=!1,setTimeout((()=>{this.elements=null,this.media=null}),200))};this.stop(),clearTimeout(this.timers.loading),clearTimeout(this.timers.controls),clearTimeout(this.timers.resized),this.isHTML5?(Ue.toggleNativeControls.call(this,!0),i()):this.isYouTube?(clearInterval(this.timers.buffering),clearInterval(this.timers.playing),null!==this.embed&&A.function(this.embed.destroy)&&this.embed.destroy(),i()):this.isVimeo&&(null!==this.embed&&this.embed.unload().then(i),setTimeout(i,200))})),t(this,\"supports\",(e=>Y.mime.call(this,e))),this.timers={},this.ready=!1,this.loading=!1,this.failed=!1,this.touch=Y.touch,this.media=e,this.config=N({},_e,nt.defaults,i||{},(()=>{try{return JSON.parse(this.media.getAttribute(\"data-plyr-config\"))}catch(e){return{}}})()),this.elements={container:null,fullscreen:null,captions:null,buttons:{},display:{},progress:{},inputs:{},settings:{popup:null,menu:null,panels:{},buttons:{}}},this.captions={active:null,currentTrack:-1,meta:new WeakMap},this.fullscreen={active:!1},this.options={speed:[],quality:[]},this.debug=new qe(this.config.debug),this.debug.log(\"Config\",this.config),this.debug.log(\"Support\",Y),A.nullOrUndefined(this.media)||!A.element(this.media))return void this.debug.error(\"Setup failed: no suitable element passed\");if(this.media.plyr)return void this.debug.warn(\"Target already setup\");if(!this.config.enabled)return void this.debug.error(\"Setup failed: disabled by config\");if(!Y.check().api)return void this.debug.error(\"Setup failed: no support\");const s=this.media.cloneNode(!0);s.autoplay=!1,this.elements.original=s;const n=this.media.tagName.toLowerCase();let a=null,r=null;switch(n){case\"div\":if(a=this.media.querySelector(\"iframe\"),A.element(a)){if(r=xe(a.getAttribute(\"src\")),this.provider=function(e){return/^(https?:\\/\\/)?(www\\.)?(youtube\\.com|youtube-nocookie\\.com|youtu\\.?be)\\/.+$/.test(e)?$e.youtube:/^https?:\\/\\/player.vimeo.com\\/video\\/\\d{0,9}(?=\\b|\\/)/.test(e)?$e.vimeo:null}(r.toString()),this.elements.container=this.media,this.media=a,this.elements.container.className=\"\",r.search.length){const e=[\"1\",\"true\"];e.includes(r.searchParams.get(\"autoplay\"))&&(this.config.autoplay=!0),e.includes(r.searchParams.get(\"loop\"))&&(this.config.loop.active=!0),this.isYouTube?(this.config.playsinline=e.includes(r.searchParams.get(\"playsinline\")),this.config.youtube.hl=r.searchParams.get(\"hl\")):this.config.playsinline=!0}}else this.provider=this.media.getAttribute(this.config.attributes.embed.provider),this.media.removeAttribute(this.config.attributes.embed.provider);if(A.empty(this.provider)||!Object.values($e).includes(this.provider))return void this.debug.error(\"Setup failed: Invalid provider\");this.type=Re;break;case\"video\":case\"audio\":this.type=n,this.provider=$e.html5,this.media.hasAttribute(\"crossorigin\")&&(this.config.crossorigin=!0),this.media.hasAttribute(\"autoplay\")&&(this.config.autoplay=!0),(this.media.hasAttribute(\"playsinline\")||this.media.hasAttribute(\"webkit-playsinline\"))&&(this.config.playsinline=!0),this.media.hasAttribute(\"muted\")&&(this.config.muted=!0),this.media.hasAttribute(\"loop\")&&(this.config.loop.active=!0);break;default:return void this.debug.error(\"Setup failed: unsupported type\")}this.supported=Y.check(this.type,this.provider),this.supported.api?(this.eventListeners=[],this.listeners=new Ve(this),this.storage=new Te(this),this.media.plyr=this,A.element(this.elements.container)||(this.elements.container=O(\"div\"),_(this.media,this.elements.container)),Ue.migrateStyles.call(this),Ue.addStyleHook.call(this),Je.setup.call(this),this.config.debug&&J.call(this,this.elements.container,this.config.events.join(\" \"),(e=>{this.debug.log(`event: ${e.type}`)})),this.fullscreen=new He(this),(this.isHTML5||this.isEmbed&&!this.supported.ui)&&Ue.build.call(this),this.listeners.container(),this.listeners.global(),this.config.ads.enabled&&(this.ads=new Ge(this)),this.isHTML5&&this.config.autoplay&&this.once(\"canplay\",(()=>se(this.play()))),this.lastSeekTime=0,this.config.previewThumbnails.enabled&&(this.previewThumbnails=new it(this))):this.debug.error(\"Setup failed: no support\")}get isHTML5(){return this.provider===$e.html5}get isEmbed(){return this.isYouTube||this.isVimeo}get isYouTube(){return this.provider===$e.youtube}get isVimeo(){return this.provider===$e.vimeo}get isVideo(){return this.type===Re}get isAudio(){return this.type===je}get playing(){return Boolean(this.ready&&!this.paused&&!this.ended)}get paused(){return Boolean(this.media.paused)}get stopped(){return Boolean(this.paused&&0===this.currentTime)}get ended(){return Boolean(this.media.ended)}set currentTime(e){if(!this.duration)return;const t=A.number(e)&&e>0;this.media.currentTime=t?Math.min(e,this.duration):0,this.debug.log(`Seeking to ${this.currentTime} seconds`)}get currentTime(){return Number(this.media.currentTime)}get buffered(){const{buffered:e}=this.media;return A.number(e)?e:e&&e.length&&this.duration>0?e.end(0)/this.duration:0}get seeking(){return Boolean(this.media.seeking)}get duration(){const e=parseFloat(this.config.duration),t=(this.media||{}).duration,i=A.number(t)&&t!==1/0?t:0;return e||i}set volume(e){let t=e;A.string(t)&&(t=Number(t)),A.number(t)||(t=this.storage.get(\"volume\")),A.number(t)||({volume:t}=this.config),t>1&&(t=1),t0&&(this.muted=!1)}get volume(){return Number(this.media.volume)}set muted(e){let t=e;A.boolean(t)||(t=this.storage.get(\"muted\")),A.boolean(t)||(t=this.config.muted),this.config.muted=t,this.media.muted=t}get muted(){return Boolean(this.media.muted)}get hasAudio(){return!this.isHTML5||(!!this.isAudio||(Boolean(this.media.mozHasAudio)||Boolean(this.media.webkitAudioDecodedByteCount)||Boolean(this.media.audioTracks&&this.media.audioTracks.length)))}set speed(e){let t=null;A.number(e)&&(t=e),A.number(t)||(t=this.storage.get(\"speed\")),A.number(t)||(t=this.config.speed.selected);const{minimumSpeed:i,maximumSpeed:s}=this;t=Ze(t,i,s),this.config.speed.selected=t,setTimeout((()=>{this.media&&(this.media.playbackRate=t)}),0)}get speed(){return Number(this.media.playbackRate)}get minimumSpeed(){return this.isYouTube?Math.min(...this.options.speed):this.isVimeo?.5:.0625}get maximumSpeed(){return this.isYouTube?Math.max(...this.options.speed):this.isVimeo?2:16}set quality(e){const t=this.config.quality,i=this.options.quality;if(!i.length)return;let s=[!A.empty(e)&&Number(e),this.storage.get(\"quality\"),t.selected,t.default].find(A.number),n=!0;if(!i.includes(s)){const e=ae(i,s);this.debug.warn(`Unsupported quality option: ${s}, using ${e} instead`),s=e,n=!1}t.selected=s,this.media.quality=s,n&&this.storage.set({quality:s})}get quality(){return this.media.quality}set loop(e){const t=A.boolean(e)?e:this.config.loop.active;this.config.loop.active=t,this.media.loop=t}get loop(){return Boolean(this.media.loop)}set source(e){st.change.call(this,e)}get source(){return this.media.currentSrc}get download(){const{download:e}=this.config.urls;return A.url(e)?e:this.source}set download(e){A.url(e)&&(this.config.urls.download=e,Me.setDownloadUrl.call(this))}set poster(e){this.isVideo?Ue.setPoster.call(this,e,!1).catch((()=>{})):this.debug.warn(\"Poster can only be set for video\")}get poster(){return this.isVideo?this.media.getAttribute(\"poster\")||this.media.getAttribute(\"data-poster\"):null}get ratio(){if(!this.isVideo)return null;const e=ce(ue.call(this));return A.array(e)?e.join(\":\"):e}set ratio(e){this.isVideo?A.string(e)&&le(e)?(this.config.ratio=ce(e),he.call(this)):this.debug.error(`Invalid aspect ratio specified (${e})`):this.debug.warn(\"Aspect ratio can only be set for video\")}set autoplay(e){this.config.autoplay=A.boolean(e)?e:this.config.autoplay}get autoplay(){return Boolean(this.config.autoplay)}toggleCaptions(e){Ne.toggle.call(this,e,!1)}set currentTrack(e){Ne.set.call(this,e,!1),Ne.setup.call(this)}get currentTrack(){const{toggled:e,currentTrack:t}=this.captions;return e?t:-1}set language(e){Ne.setLanguage.call(this,e,!1)}get language(){return(Ne.getCurrentTrack.call(this)||{}).language}set pip(e){if(!Y.pip)return;const t=A.boolean(e)?e:!this.pip;A.function(this.media.webkitSetPresentationMode)&&this.media.webkitSetPresentationMode(t?Ie:Oe),A.function(this.media.requestPictureInPicture)&&(!this.pip&&t?this.media.requestPictureInPicture():this.pip&&!t&&document.exitPictureInPicture())}get pip(){return Y.pip?A.empty(this.media.webkitPresentationMode)?this.media===document.pictureInPictureElement:this.media.webkitPresentationMode===Ie:null}setPreviewThumbnails(e){this.previewThumbnails&&this.previewThumbnails.loaded&&(this.previewThumbnails.destroy(),this.previewThumbnails=null),Object.assign(this.config.previewThumbnails,e),this.config.previewThumbnails.enabled&&(this.previewThumbnails=new it(this))}static supported(e,t){return Y.check(e,t)}static loadSprite(e,t){return Ee(e,t)}static setup(e,t={}){let i=null;return A.string(e)?i=Array.from(document.querySelectorAll(e)):A.nodeList(e)?i=Array.from(e):A.array(e)&&(i=e.filter(A.element)),A.empty(i)?null:i.map((e=>new nt(e,t)))}}var at;return nt.defaults=(at=_e,JSON.parse(JSON.stringify(at))),nt}));"}],"posts":[{"title":"Unity-ç¼–è¾‘å™¨ UI å¼€å‘ä¼˜åŒ–æ¡†æž¶ EditorUIExtension VE ç¯‡","slug":"Unity-ç¼–è¾‘å™¨-UI-å¼€å‘ä¼˜åŒ–æ¡†æž¶-EditorUIExtension-VisuelElement-ç¯‡","date":"2024-05-30T11:53:07.000Z","updated":"2024-05-31T17:58:47.337Z","comments":true,"path":"article/78043d7e1c5e/","link":"","permalink":"https://busyogg.github.io/article/78043d7e1c5e/","excerpt":"","text":"ç®€ä»‹åŸºäºŽ VisualElement çš„ç¼–è¾‘å™¨ UI æ¡†æž¶ï¼Œç›®çš„æ˜¯ç®€åŒ–ç¼–è¾‘å™¨å¼€å‘æ—¶çš„ UI æž„å»ºã€‚åˆ©ç”¨ç‰¹æ€§æ ‡ç­¾è¿›è¡Œ UI çš„åˆå§‹åŒ–ã€‚ å¯¹äºŽå˜é‡ï¼Œæˆ‘ä»¬åªéœ€è¦æ‰“ä¸Šå¯¹åº”çš„æ ‡ç­¾ï¼Œå°±èƒ½å¤Ÿåœ¨ UI é¢æ¿ä¸Šæ˜¾ç¤ºå¯¹åº”çš„ UIã€‚ å¯¹äºŽæ–¹æ³•ï¼Œæˆ‘ä»¬åªéœ€è¦æ‰“ä¸Š Button æ ‡ç­¾ï¼Œå°±èƒ½å¤Ÿç”Ÿæˆä¸€ä¸ªå®žçŽ°è¯¥æ–¹æ³•çš„æŒ‰é’®ã€‚ åŒæ—¶ï¼Œæœ¬æ¡†æž¶è¿˜æ”¯æŒå¯¹ UI çš„æ ·å¼å’Œå¸ƒå±€è¿›è¡Œæœ‰é™çš„ä¿®æ”¹ï¼ŒåŒæ ·ä¹Ÿæ˜¯é€šè¿‡ç‰¹æ€§å®žçŽ°ã€‚ UI ç•Œé¢çš„æ¸²æŸ“é¡ºåºæŒ‰ç…§ç¼–è¾‘å™¨è„šæœ¬å¯¹è±¡çš„å£°æ˜Žé¡ºåºæŽ’åºï¼Œå¸ƒå±€çš„ç»“æž„ä¹Ÿè¦æŒ‰ç…§é¡ºåºå£°æ˜Žï¼Œå¯ä»¥çœ‹ä½œæ˜¯ä»¥ä»£ç çš„å½¢å¼ç»˜åˆ¶ UIã€‚ æœ¬æ¡†æž¶æ”¯æŒè‡ªå®šä¹‰æ‹“å±•åŠŸèƒ½ï¼Œå…·ä½“çš„ä½¿ç”¨è¯´æ˜Žå’Œæ‹“å±•è§„åˆ™è§ï¼š EditorUIExtention æ–‡æ¡£ åŽŸç†åˆå§‹åŒ–ç‰¹æ€§æˆ‘ä»¬é€šè¿‡åŸºç±»åˆå§‹åŒ–èŽ·å– Typeï¼Œç„¶åŽé€šè¿‡ Type èŽ·å– members å¹¶ä¸”æŒ‰ç…§å£°æ˜Žé¡ºåºæŽ’åºï¼Œä¹‹åŽé€šè¿‡éåŽ†ï¼Œåœ¨å…¶å¾ªçŽ¯ä½“å†…æ ¹æ®å¯¹åº”çš„ç‰¹æ€§ç±»åˆ«è¿›è¡Œ UI çš„æ¸²æŸ“å‡½æ•°åˆå§‹åŒ–ã€‚ åˆå§‹åŒ–åˆ†ä¸ºä¸‰ç§æƒ…å†µï¼š æ™®é€š UIã€‚ åˆ—è¡¨ã€‚ Boxã€‚ æ‰€æœ‰åˆå§‹åŒ–çš„ UI å…ƒç´ éƒ½ä¼šå­˜å‚¨åˆ°åŸºç±»ä¸­ï¼Œé€šè¿‡å­—æ®µåå¯ä»¥èŽ·å–åˆ°å¯¹åº”çš„ UIã€‚ åˆå§‹åŒ– UIåˆå§‹åŒ– UI å°±æ˜¯åˆ¤æ–­ member ç‰¹æ€§æ˜¯å¦åŒ…å« E_Editor ï¼Œå¹¶ä¸”å­—æ®µä¸æ˜¯ List ç±»åž‹ã€‚ ç„¶åŽæˆ‘ä»¬æ ¹æ® E_Editor çš„ç±»åž‹æ¥ç”Ÿæˆä¸åŒçš„ UIã€‚æ¯ä¸ª UI æˆ‘ä»¬éƒ½è¦è°ƒç”¨æ ·å¼çš„åˆå§‹åŒ–æ–¹æ³•ï¼Œè¿™æ ·æ‰èƒ½å®žçŽ°é€šè¿‡ç‰¹æ€§ä¿®æ”¹æ ·å¼ã€‚ç”±äºŽ VisualElement å…·æœ‰å¤æ‚çš„åµŒå¥—å…³ç³»ï¼Œå› æ­¤åœ¨è°ƒç”¨æ ·å¼åˆå§‹åŒ–æ–¹æ³•çš„æ—¶å€™è¦æ³¨æ„ä¼ å…¥çš„ UI ä¸»ä½“æ˜¯æ­£ç¡®çš„ã€‚ UI çš„å½¢å¼å¦‚ä¸‹ï¼š graph LR; table_1[\"çˆ¶å®¹å™¨æ ‡ç­¾è¾“å…¥æ¡†\"] æ¯ä¸ª UI éƒ½æœ‰çˆ¶å®¹å™¨ï¼Œçˆ¶å®¹å™¨æœ¬èº«ä¸æä¾›æ ·å¼ä¿®æ”¹ï¼Œåªæ˜¯æž„æˆ UI çš„æœ€ä¸Šå±‚å•ä½ã€‚å¦‚æžœæœ‰éœ€è¦çš„è¯å¯ä»¥è‡ªå·±æ·»åŠ æ ·å¼ä¿®æ”¹çš„é€»è¾‘ã€‚ åˆå§‹åŒ–åˆ—è¡¨åˆå§‹åŒ– UI å°±æ˜¯åˆ¤æ–­ member ç‰¹æ€§æ˜¯å¦åŒ…å« E_Editor ï¼Œå¹¶ä¸”å­—æ®µæ˜¯ List ç±»åž‹ã€‚ åˆ—è¡¨çš„åˆå§‹åŒ–ä¸Žæ™®é€š UI åˆå§‹åŒ–ç•¥æœ‰ä¸åŒï¼Œä¸è¿‡å…¶å†…éƒ¨ Item çš„ç”Ÿæˆé€»è¾‘å’Œæ™®é€š UI æ˜¯ç›¸åŒçš„ã€‚ ç›®å‰åˆ—è¡¨ä¸æ”¯æŒè™šæ‹ŸåŒ–ã€‚ åˆ—è¡¨ç»“æž„å¦‚ä¸‹ï¼š graph TD; subgraph outerTable[\"çˆ¶å®¹å™¨\"] subgraph innerTable1[\"åˆ—è¡¨\"] table_1[\"åˆ—è¡¨å…ƒç´ 1\"] table_2[\"åˆ—è¡¨å…ƒç´ 2\"] end end åˆ—è¡¨è¿˜è¡ç”Ÿäº†æ·»åŠ åˆ—è¡¨å…ƒç´ å’Œç§»é™¤åˆ—è¡¨å…ƒç´ ä¸¤ä¸ªæ–¹æ³•ã€‚ æ·»åŠ åˆ—è¡¨å…ƒç´ é€šè¿‡å­—æ®µåèŽ·å–å¯¹åº”çš„åˆ—è¡¨å’Œå­—æ®µï¼Œç„¶åŽé€šè¿‡å’Œåˆ—è¡¨åˆå§‹åŒ–ä¸€æ ·çš„æ–¹æ³•æ¥æ·»åŠ åˆ—è¡¨å…ƒç´ ï¼›ç§»é™¤åˆ—è¡¨å…ƒç´ çš„é€»è¾‘å’Œæ·»åŠ ç±»ä¼¼ï¼Œåªæ˜¯é€»è¾‘æ¯”æ·»åŠ ç®€å•ä¸€ç‚¹ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647/// &lt;summary&gt;/// æ·»åŠ åˆ—è¡¨å…ƒç´ /// &lt;/summary&gt;/// &lt;param name=&quot;id&quot;&gt;&lt;/param&gt;protected void ListAdd(string id)&#123; VisualElement element = GetElement(id); VisualElement list = element.Children().ElementAt(1); FieldInfo field = _type.GetField(id, _flag); E_Editor editor = field.GetCustomAttribute&lt;E_Editor&gt;(); IList data = field.GetValue(this) as IList; data.Add(null); Action&lt;object&gt; setData = o =&gt; &#123; data[data.Count - 1] = o; &#125;; VisualElement subBox = new VisualElement(); list.Add(subBox); GenerateItem(subBox, field, editor.GetEType(), null, setData, true); RegisterDrag(subBox, list, data);&#125;/// &lt;summary&gt;/// ç§»é™¤æœ€åŽä¸€ä¸ªæ•°ç»„å…ƒç´ /// &lt;/summary&gt;/// &lt;param name=&quot;id&quot;&gt;&lt;/param&gt;protected void ListRemove(string id)&#123; VisualElement element = GetElement(id); VisualElement list = element.Children().ElementAt(1); if (list.childCount == 0) &#123; Debug.LogWarning(&quot;æ²¡æœ‰å…ƒç´ äº†&quot;); return; &#125; list.RemoveAt(list.childCount - 1); FieldInfo field = _type.GetField(id, _flag); IList data = field.GetValue(this) as IList; data.RemoveAt(data.Count - 1);&#125; åˆå§‹åŒ– Boxåˆå§‹åŒ– Box éœ€è¦åˆ¤æ–­æ˜¯å¦å…·æœ‰ VE_Box ç‰¹æ€§ï¼Œä¸€èˆ¬æ¥è¯´ VE_Box ä¸ä¼šä¸Ž E_Editor æ··ç”¨ã€‚ åˆå§‹åŒ– Box éœ€è¦å•ç‹¬ä¸€ä¸ªå­—æ®µæ¥åˆ›å»º Boxï¼Œå­—æ®µä¸º string ç±»åž‹ï¼Œå­—æ®µçš„å€¼å°±æ˜¯ Box çš„åç§°ï¼Œç”¨äºŽåŽé¢æŸ¥æ‰¾ Boxã€‚Box çš„æ˜¾ç¤ºåç§°éœ€è¦é…åˆ E_Name æ¥è®¾ç½®ã€‚ å¦‚æžœæœ‰ä¼ å…¥ _boxName ï¼Œé‚£ä¹ˆåˆ›å»ºçš„ Box å°±ä¼šåŽ»æŸ¥æ‰¾ç›¸å…³çš„ Boxï¼Œç„¶åŽæ·»åŠ åˆ°é‡Œé¢ï¼Œå¦åˆ™æ·»åŠ åˆ°æ ¹èŠ‚ç‚¹ã€‚ å¯¹äºŽ UI å…ƒç´ æ·»åŠ åˆ° Box æ¥è¯´ï¼Œåªéœ€è¦æ‰“ä¸Š VE_Box çš„ç‰¹æ€§ï¼Œç„¶åŽåœ¨æž„é€ å‡½æ•°ä¼ å…¥ Box çš„åå­—å°±å¯ä»¥ã€‚ åˆå§‹åŒ–æ ·å¼æ ·å¼çš„åˆå§‹åŒ–åˆ†ä¸ºä¸¤ç§ï¼š UI å…ƒç´ æ ·å¼åˆå§‹åŒ–ã€‚ Box æ ·å¼åˆå§‹åŒ–ã€‚ Box æ ·å¼åˆå§‹åŒ–ç›¸å¯¹ç®€å•ï¼Œåªéœ€è¦æ ¹æ®å¯¹åº”çš„ç‰¹æ€§è®¾ç½® style å³å¯ã€‚ UI å…ƒç´ æ ·å¼ä¸ä»…éœ€è¦è®¾ç½® styleï¼Œè¿˜å› ä¸ºè®¾ç½® style åŽä¼šå½±å“åŽŸæ¥çš„ä¼ªç±»çš„æ ·å¼ï¼Œå› æ­¤éœ€è¦é‡æ–°è®¾ç½®ç›‘å¬å¹¶ä¿®æ”¹ä¸åŒæƒ…å†µä¸‹çš„ UI å…ƒç´ æ ·å¼ã€‚ Button UI å› ä¸ºæœ¬èº«åŠ«æŒäº†æ‰€æœ‰å·¦é”®äº‹ä»¶ï¼Œå› æ­¤éœ€è¦é¢å¤–çš„å¤„ç†ï¼Œè¯¦æƒ…è§æºç  åˆå§‹åŒ–æ‹–æ‹½åˆå§‹åŒ–æ‹–æ‹½æˆ‘ä»¬å¯¹æ¯ä¸ªåˆ—è¡¨å…ƒç´ ç›‘å¬ä¸‰ä¸ªäº‹ä»¶ï¼š é¼ æ ‡æŒ‰ä¸‹ã€‚ é¼ æ ‡ç§»åŠ¨ã€‚ é¼ æ ‡æŠ¬èµ·ã€‚ é¼ æ ‡æŒ‰ä¸‹çš„æ—¶å€™æˆ‘ä»¬è®°å½•å½“å‰é¼ æ ‡çš„ä½ç½®ã€å½“å‰çš„å…ƒç´ ï¼ˆæ‹–æ‹½å…ƒç´ ï¼‰å’Œå½“å‰å…ƒç´ çš„ left å’Œ topã€‚ é¼ æ ‡ç§»åŠ¨çš„æ—¶å€™æˆ‘ä»¬åˆ¤æ–­æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡æ‰§è¡Œç§»åŠ¨å‡½æ•°ï¼Œæ˜¯çš„è¯æˆ‘ä»¬æŠŠæ‰€æœ‰å…ƒç´ éƒ½å˜æˆç»å¯¹å¸ƒå±€ï¼Œå¹¶ä¸”è®¾ç½®å¥½ left å’Œ topã€‚ ç„¶åŽæˆ‘ä»¬æ·»åŠ ä¸€ä¸ªç©ºçš„å…ƒç´ åˆ°æ‹–æ‹½å…ƒç´ çš„ç´¢å¼•ä½ç½®ä½œä¸ºå ä½å…ƒç´ ï¼Œæ‹–æ‹½å…ƒç´ ç§»åŠ¨åˆ°å®¹å™¨æœ€å°¾ç«¯ã€‚è¿™æ ·åšæ˜¯ä¸ºäº†è®©æ‹–æ‹½å…ƒç´ æ˜¾ç¤ºåœ¨ UI å±‚çº§çš„æœ€ä¸Šå±‚ï¼Œå¹¶ä¸”ä¸ä¼šæ‰°ä¹±åŽŸæ¥åˆ—è¡¨çš„ç´¢å¼•ï¼ˆå› ä¸º VisualElement æ²¡æœ‰ zIndexï¼‰ã€‚ æŽ¥ç€æˆ‘ä»¬æ•æ‰é¼ æ ‡ï¼Œè¿™æ ·å…¶ä»– UI å…ƒç´ ä¸ä¼šè¢«é¼ æ ‡äº‹ä»¶å½±å“ï¼Œé¼ æ ‡è¶…å‡ºå½“å‰å…ƒç´ ä¹Ÿèƒ½å¤Ÿç»§ç»­æ•èŽ·äº‹ä»¶ã€‚ä¸ºä»€ä¹ˆä¸æ”¾åœ¨é¼ æ ‡æŒ‰ä¸‹çš„æ—¶å€™ï¼Œæ˜¯å› ä¸ºå½“åˆ—è¡¨éœ€è¦æ‰“å¼€å¯¹è±¡é€‰æ‹©å™¨çš„æ—¶å€™ï¼Œæ•èŽ·é¼ æ ‡å°±æ— æ³•è§¦å‘è¿™ä¸ªäº‹ä»¶ã€‚ é¼ æ ‡åœ¨ç§»åŠ¨çš„æ—¶å€™å®žæ—¶ä¿®æ”¹æ‹–æ‹½å…ƒç´ çš„ left å’Œ topï¼Œå°±å¯ä»¥å®žçŽ°å…ƒç´ è·Ÿç€é¼ æ ‡ç§»åŠ¨äº†ã€‚ åœ¨é¼ æ ‡æŠ¬èµ·çš„æ—¶å€™ï¼Œæˆ‘ä»¬éåŽ†åˆ—è¡¨å­å¯¹è±¡ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰å’Œæ‹–æ‹½å…ƒç´ åŒ…å›´ç›’ç›¸äº¤çš„å¯¹è±¡ï¼Œå¦‚æžœæœ‰çš„è¯äº¤æ¢ä¸¤ä¸ªå…ƒç´ ã€‚ äº¤æ¢çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š graph TD; A[\"æŸ¥æ‰¾ç›¸äº¤å…ƒç´ ç´¢å¼•\"] B[\"ç§»é™¤æ‹–æ‹½å…ƒç´ \"] C[\"æ’å…¥æ‹–æ‹½å…ƒç´ åˆ°ç›¸äº¤å…ƒç´ ç´¢å¼•å¤„\"] D[\"æ’å…¥ç›¸äº¤å…ƒç´ åˆ°æ‹–æ‹½å…ƒç´ çš„åŽŸç´¢å¼•å¤„\"] E[\"äº¤æ¢åˆ—è¡¨ä¸­ä¸¤ä¸ªå…ƒç´ çš„å€¼\"] A --> B --> C --> D --> E ç„¶åŽæˆ‘ä»¬æŠŠæ‰€æœ‰å…ƒç´ éƒ½å˜ä¸ºç›¸å¯¹å¸ƒå±€ï¼Œç½® left å’Œ top ä¸º 0ã€‚ å¦‚æžœçˆ¶å®¹å™¨ä¸­å­˜åœ¨å ä½å…ƒç´ ï¼Œå°±ç§»é™¤ï¼ˆå› ä¸ºæœ‰å¯èƒ½åªæœ‰æŒ‰ä¸‹æ²¡æœ‰ç§»åŠ¨ï¼Œå°±ä¸å­˜åœ¨å ä½å…ƒç´ ï¼‰ã€‚åœ¨æœ‰å ä½å…ƒç´ çš„æƒ…å†µä¸‹ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰ç»è¿‡å…ƒç´ äº¤æ¢ï¼Œæ²¡æœ‰çš„è¯å°±æŠŠæ‹–æ‹½å…ƒç´ æ’å…¥å›žåŽŸæ¥çš„ç´¢å¼•ã€‚ æœ€åŽé‡ç½®å„ç§çŠ¶æ€ï¼ŒåŒ…æ‹¬é‡Šæ”¾é¼ æ ‡ã€‚ ç”±äºŽfocusäº‹ä»¶ä¼šé˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œä¼šå¯¼è‡´é¼ æ ‡æŠ¬èµ·äº‹ä»¶æ— æ³•è§¦å‘ï¼Œæ‹–æ‹½çŠ¶æ€æ— æ³•é‡ç½®ï¼Œå› æ­¤æˆ‘ä»¬åœ¨æ ¹èŠ‚ç‚¹ç›‘å¬é¼ æ ‡å·¦é”®æŒ‰ä¸‹çš„äº‹ä»¶ï¼Œç„¶åŽåœ¨æ‹–æ‹½çš„é¼ æ ‡ç§»åŠ¨äº‹ä»¶ä¸­æ·»åŠ è¯¥åˆ¤æ–­æ¡ä»¶ï¼Œå½“focusçš„æ—¶å€™æ ¹èŠ‚ç‚¹çš„é¼ æ ‡æŒ‰ä¸‹ç›‘å¬è¢«é˜»æ­¢ï¼Œæ­¤æ—¶åˆ¤å®šé¼ æ ‡ç§»åŠ¨çš„æ—¶å€™å°±åˆ¤å®šä¸ºæ²¡æœ‰æ‹–æ‹½ï¼Œä»Žè€Œè§£å†³è¿™ä¸ªé—®é¢˜ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697/// &lt;summary&gt;/// æ³¨å†Œæ‹–æ‹½/// &lt;/summary&gt;/// &lt;param name=&quot;ele&quot;&gt;&lt;/param&gt;/// &lt;param name=&quot;parent&quot;&gt;&lt;/param&gt;private void RegisterDrag(VisualElement ele, VisualElement parent, IList data)&#123; VisualElement empty = new VisualElement(); int defIndex = 0; bool isCapture = false; ele.RegisterCallback&lt;PointerDownEvent&gt;(evt =&gt; &#123; if (evt.button == 0) // å·¦é”® &#123; _dragElement = ele; _defPos = evt.position; _defTL = new Vector2(_dragElement.resolvedStyle.left - _dragElement.resolvedStyle.marginLeft, _dragElement.resolvedStyle.top - _dragElement.resolvedStyle.marginTop); &#125; &#125;); ele.RegisterCallback&lt;PointerMoveEvent&gt;(evt =&gt; &#123; if (!isCapture &amp;&amp; _dragElement != null) &#123; ele.CapturePointer(evt.pointerId); isCapture = true; foreach (var child in parent.Children()) &#123; child.style.position = Position.Absolute; // Debug.Log(child.resolvedStyle.left); child.style.left = child.resolvedStyle.left - child.resolvedStyle.marginLeft; child.style.top = child.resolvedStyle.top - child.resolvedStyle.marginTop; &#125; //å ä½ defIndex = parent.IndexOf(_dragElement); parent.Insert(defIndex, empty); _dragElement.BringToFront(); &#125; if (_dragElement != null &amp;&amp; ele.HasPointerCapture(evt.pointerId)) &#123; Vector2 delta = new Vector2(evt.position.x, evt.position.y) - _defPos; _dragElement.style.top = _defTL.y + delta.y; _dragElement.style.left = _defTL.x + delta.x; &#125; &#125;); ele.RegisterCallback&lt;PointerUpEvent&gt;(evt =&gt; &#123; if (_dragElement != null) &#123; bool isExchange = false; foreach (var child in parent.Children()) &#123; if (child != _dragElement &amp;&amp; child.worldBound.Contains(evt.position)) &#123; //UI äº¤æ¢ int insertIndex = parent.IndexOf(child); parent.Remove(_dragElement); parent.Insert(insertIndex, _dragElement); parent.Insert(defIndex, child); //æ•°æ®äº¤æ¢ (data[defIndex], data[insertIndex]) = (data[insertIndex], data[defIndex]); isExchange = true; break; &#125; &#125; foreach (var child in parent.Children()) &#123; child.style.position = Position.Relative; child.style.left = 0; child.style.top = 0; &#125; if (parent.IndexOf(empty) != -1) &#123; parent.Remove(empty); if (!isExchange) &#123; parent.Insert(defIndex, _dragElement); &#125; &#125; _dragElement.ReleasePointer(evt.pointerId); _dragElement = null; isCapture = false; &#125; &#125;);&#125; é¡¹ç›® æ›´æ–°æ—¥å¿—2024-05-31 æ›´æ–°åŸºç¡€å†…å®¹ã€‚","categories":[{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/categories/Unity/"},{"name":"ç¼–è¾‘å™¨","slug":"Unity/ç¼–è¾‘å™¨","permalink":"https://busyogg.github.io/categories/Unity/%E7%BC%96%E8%BE%91%E5%99%A8/"}],"tags":[{"name":"C#","slug":"C","permalink":"https://busyogg.github.io/tags/C/"},{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/tags/Unity/"},{"name":"ç¼–è¾‘å™¨","slug":"ç¼–è¾‘å™¨","permalink":"https://busyogg.github.io/tags/%E7%BC%96%E8%BE%91%E5%99%A8/"},{"name":"æ¡†æž¶","slug":"æ¡†æž¶","permalink":"https://busyogg.github.io/tags/%E6%A1%86%E6%9E%B6/"},{"name":"VisualElement","slug":"VisualElement","permalink":"https://busyogg.github.io/tags/VisualElement/"}]},{"title":"ç¢°æ’žæ£€æµ‹ä¹‹çº¿æ®µæ£€æµ‹","slug":"ç¢°æ’žæ£€æµ‹ä¹‹çº¿æ®µæ£€æµ‹","date":"2024-05-18T12:29:43.000Z","updated":"2024-05-30T12:26:28.659Z","comments":true,"path":"article/ae332e92ff44/","link":"","permalink":"https://busyogg.github.io/article/ae332e92ff44/","excerpt":"","text":"ç®€ä»‹æœ¬æ–‡ä¸»è¦é˜è¿°çº¿æ®µä¹‹é—´çš„ç¢°æ’žæ£€æµ‹åŽŸç†å’Œå®žçŽ°æ–¹å¼ä»¥åŠçº¿æ®µä¹‹é—´æœ€å°è·ç¦»ï¼ˆæœ¬æ–‡æ–¹æ³•è¿”å›žçš„ç»“æžœæ˜¯è·ç¦»çš„å¹³æ–¹ï¼‰çš„è®¡ç®—æ–¹å¼ã€‚ åŽŸç†åœ¨æ±‚çº¿æ®µæœ€å°è·ç¦»ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆè¡¥å……ä¸€ä¸ªæ±‚ä¸€ç‚¹åœ¨çº¿æ®µä¸Šçš„æœ€è¿‘ç‚¹çš„æ–¹æ³•ã€‚ æˆ‘ä»¬è®¡ç®—è¯¥ç‚¹åœ¨çº¿æ®µä¸Šçš„æŠ•å½±å¤§å°ï¼Œæ ¹æ®æŠ•å½±å¤§å°æˆ‘ä»¬å¯ä»¥çŸ¥é“è¯¥ç‚¹åœ¨çº¿æ®µä¸Šçš„æ¯”ä¾‹ï¼Œç„¶åŽé€šè¿‡è¿™ä¸ªæ¯”ä¾‹æ±‚å‡ºçº¿æ®µä¸Šçš„æœ€åˆé€‚çš„æ£€æµ‹ç‚¹ï¼Œå³è¯¥ç‚¹åœ¨çº¿æ®µä¸Šçš„æœ€è¿‘ç‚¹ã€‚å¦‚æžœæ£€æµ‹ç‚¹è¶…å‡ºçº¿æ®µèŒƒå›´ï¼Œé‚£æˆ‘ä»¬å°±è¦ä½¿å…¶ç§»åŠ¨åˆ°çº¿æ®µæžé™ä½ç½®ã€‚ æ±‚ç‚¹åœ¨çº¿æ®µä¸Šæœ€è¿‘ç‚¹çš„ä»£ç å¦‚ä¸‹ï¼š 12345678private Vector3 GetClosestPointOnLineSegment(Vector3 start, Vector3 end, Vector3 point)&#123; Vector3 line = end - start; //dot line line æ±‚é•¿åº¦å¹³æ–¹ float ratio = Vector3.Dot(point - start, line) / Vector3.Dot(line, line); ratio = Mathf.Min(Mathf.Max(ratio, 0), 1); return start + ratio * line;&#125; è¯¥æ–¹æ³•åœ¨æ±‚çº¿æ®µæœ€å°è·ç¦»çš„æ—¶å€™ä¼šç”¨åˆ°ã€‚ æ±‚çº¿æ®µä¹‹é—´çš„æœ€å°è·ç¦»åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š çº¿æ®µå¹³è¡Œã€‚ çº¿æ®µä¸å¹³è¡Œã€‚ é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•åˆ¤æ–­çº¿æ®µæ˜¯å¦å¹³è¡Œï¼Ÿ æˆ‘ä»¬å¯ä»¥æ¯”è¾ƒä¸¤æ¡çº¿æ®µçš„æ–¹å‘å‘é‡ï¼Œå¦‚æžœä¸¤æ¡çº¿æ®µçš„æ–¹å‘å‘é‡ç›¸ç­‰çš„è¯ï¼Œè¿™ä¸¤æ¡çº¿æ®µå°±å¹³è¡Œã€‚ 12//åˆ¤æ–­å®Œå…¨å¹³è¡Œbool isParallel = line1.normalized == line2.normalized; çº¿æ®µå¹³è¡Œåœ¨çº¿æ®µå¹³è¡Œçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªéœ€è¦è®¡ç®—ä¸€æ¡çº¿æ®µçš„ä¸¤ä¸ªç«¯ç‚¹ç›¸å¯¹äºŽå¦ä¸€æ¡çº¿æ®µçš„è·ç¦»ï¼Œå–å…¶ä¸­æœ€å°çš„è·ç¦»å³å¯ã€‚ å› ä¸ºä¸¤çº¿æ®µå¹³è¡Œï¼Œæ‰€ä»¥åªéœ€è¦è¿›è¡Œä¸€æ¬¡è¿™æ ·çš„è®¡ç®—å°±è¡Œï¼Œåè¿‡æ¥è®¡ç®—çš„ä¸¤ä¸ªç«¯ç‚¹è·ç¦»å’Œå½“å‰è®¡ç®—çš„ä¸¤ä¸ªç«¯ç‚¹è·ç¦»æ˜¯ä¸€æ ·çš„ã€‚ è®¡ç®—ä¸¤ä¸ªç«¯ç‚¹çš„åŽŸå› æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¸€æ¡çº¿æ®µçš„ä¸¤ä¸ªç«¯ç‚¹ä¸Žå¦ä¸€æ¡çº¿æ®µçš„è·ç¦»æ˜¯ä¸ä¸€æ ·çš„ã€‚ ä¸€è‡´çš„æƒ…å†µä¸ä¸€è‡´çš„æƒ…å†µ 12345//å®Œå…¨å¹³è¡Œfloat disStart1 = (GetClosestPointOnLineSegment(start1, end1, start2) - start2).sqrMagnitude;float disEnd1 = (GetClosestPointOnLineSegment(start1, end1, end2) - end2).sqrMagnitude;dis = Mathf.Min(disStart1, disEnd1); çº¿æ®µä¸å¹³è¡Œåœ¨çº¿æ®µä¸å¹³è¡Œçš„æƒ…å†µä¸‹ï¼Œåˆåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š çº¿æ®µåŒé¢ã€‚ çº¿æ®µä¸åŒé¢ã€‚ åˆ¤æ–­çº¿æ®µæ˜¯å¦åŒé¢ï¼Œæˆ‘ä»¬å°±éœ€è¦çŸ¥é“ä¸¤æ¡çº¿æ®µä¹‹é—´çš„è·ç¦»æ˜¯å¦ä¸º 0ï¼Œå¦‚æžœä¸º 0 çš„è¯ï¼Œä¸¤æ¡çº¿æ®µå°±åŒé¢ã€‚ é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•åˆ¤æ–­ä¸¤æ¡çº¿æ®µä¹‹é—´çš„è·ç¦»æ˜¯å¦ä¸º 0 å‘¢ï¼Ÿ æ ¹æ®å®šç†ï¼Œä¸¤æ¡ç›´çº¿ä¹‹é—´çš„æœ€çŸ­è·ç¦»ç­‰äºŽä¸¤æ¡ç›´çº¿çš„ä¸­åž‚çº¿çš„é•¿åº¦ã€‚å› æ­¤æˆ‘ä»¬åªéœ€è¦å¾—åˆ°ä¸­åž‚çº¿å°±èƒ½è®¡ç®—å‡ºä¸¤æ¡ç›´çº¿ä¹‹é—´çš„è·ç¦»ã€‚ ä¸­åž‚çº¿çš„æ–¹å‘å‘é‡æˆ‘ä»¬å¯ä»¥é€šè¿‡å‘é‡å‰ä¹˜æ¥å¾—åˆ°ã€‚ åˆæ ¹æ® $ä¸­åž‚çº¿é•¿åº¦&#x3D;\\dfrac{å‰ä¹˜å‘é‡å’Œä¸¤ç›´çº¿ä»»æ„ä¸¤ç‚¹è¿žçº¿çš„ç‚¹ç§¯}{å‰ä¹˜å‘é‡çš„æ¨¡é•¿}$ å³ $Bçš„æŠ•å½±é•¿åº¦&#x3D;\\dfrac{AB çš„ç‚¹ç§¯}{A çš„æ¨¡é•¿}$ æˆ‘ä»¬å°±èƒ½å¾—åˆ°ä¸¤ç›´çº¿ä¹‹é—´çš„è·ç¦»ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸¤çº¿æ®µå¹³é¢ä¹‹é—´çš„è·ç¦»ï¼Œä¹Ÿå°±æ˜¯ä¸¤çº¿æ®µä¹‹é—´çš„è·ç¦»ã€‚ 123Vector3 normal = Vector3.Cross(line1, line2);float len = normal.sqrMagnitude;float dis2Line = Mathf.Pow(Mathf.Abs(Vector3.Dot(start2 - start1, normal)), 2) / len; çº¿æ®µåŒé¢åœ¨çº¿æ®µåŒé¢çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦åˆ¤æ–­ä¸¤æ¡çº¿æ®µæ˜¯å¦ç›¸äº¤ï¼Œå¦‚æžœç›¸äº¤çš„è¯ï¼Œè·ç¦»å°±ä¸º 0ï¼›ä¸ç›¸äº¤çš„è¯ï¼Œæˆ‘ä»¬åˆ†åˆ«è®¡ç®—æ¯æ¡çº¿æ®µçš„ä¸¤ä¸ªé¡¶ç‚¹ç›¸å¯¹äºŽå¦ä¸€æ¡çº¿æ®µçš„è·ç¦»ï¼Œæœ€åŽé€‰æ‹©æœ€å°çš„è·ç¦»ã€‚ 123456789101112131415//åŒé¢// æ£€æµ‹çº¿æ®µç›¸äº¤bool isLineCross = CheckLineCross(start1, end1, start2, end2);if (isLineCross)&#123; dis = 0;&#125;else&#123; float disStart1 = (GetClosestPointOnLineSegment(start1, end1, start2) - start2).sqrMagnitude; float disEnd1 = (GetClosestPointOnLineSegment(start1, end1, end2) - end2).sqrMagnitude; float disStart2 = (GetClosestPointOnLineSegment(start2, end2, start1) - start1).sqrMagnitude; float disEnd2 = (GetClosestPointOnLineSegment(start2, end2, end1) - end1).sqrMagnitude; dis = Mathf.Min(disStart1, disEnd1, disStart2, disEnd2);&#125; çº¿æ®µä¸åŒé¢åœ¨çº¿æ®µä¸åŒé¢çš„æ—¶å€™ï¼Œæˆ‘ä»¬æŠŠå…¶ä¸­ä¸€æ¡çº¿æ®µå¹³ç§»åˆ°å¦ä¸€æ¡çº¿æ®µçš„å¹³é¢ä¸Šï¼Œç„¶åŽæŒ‰ç…§çº¿æ®µåŒé¢çš„æ–¹æ³•æ¥å¾—åˆ°æœ€å°çš„è·ç¦»ã€‚ä¸è¿‡åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œçº¿æ®µäº¤å‰æ—¶å€™çš„è·ç¦»ä¸ºä¸¤ä¸ªçº¿æ®µçš„ä¸­åž‚çº¿çš„é•¿åº¦ã€‚ ä¸ºä»€ä¹ˆä¸æ˜¯ç›´æŽ¥ç”¨ä¸­åž‚çº¿é•¿åº¦å‘¢ï¼Ÿ å› ä¸ºä¸­åž‚çº¿é•¿åº¦æ˜¯ç›´çº¿ä¹‹é—´çš„æœ€çŸ­è·ç¦»ï¼Œè€Œçº¿æ®µæ˜¯æœ‰èŒƒå›´çš„ï¼Œè¿™ä¸ªèŒƒå›´ä¸ä¸€å®šç»è¿‡ä¸­åž‚çº¿çš„ç«¯ç‚¹ï¼Œåœ¨çº¿æ®µå…±é¢äº¤å‰çš„æ—¶å€™ï¼Œä¸­åž‚çº¿çš„é•¿åº¦æ‰æ˜¯æœ‰æ•ˆçš„ã€‚ å¦‚ä½•å¹³ç§»åˆ°åŒä¸€ä¸ªå¹³é¢ï¼Ÿ åªéœ€è¦è®© line2 æ ¹æ®ä¸­åž‚çº¿æ–¹å‘ç§»åŠ¨ä¸­åž‚çº¿é•¿åº¦å³å¯ã€‚ä¸è¿‡æˆ‘ä»¬è¦æ³¨æ„ç§»åŠ¨çš„æ˜¯æ­£æ–¹å‘è¿˜æ˜¯è´Ÿæ–¹å‘ï¼Œå¯ä»¥æ ¹æ®ä¸¤çº¿æ®µä»»æ„ä¸¤ç‚¹çš„æ–¹å‘å‘é‡æ¥å†³å®šã€‚ 1234567891011121314151617181920float offset = Mathf.Sqrt(dis2Line);//è®¡ç®—line2ç›¸å¯¹line1çš„æ–¹ä½Vector3 directionStart = start2 - start1;float direction = Vector3.Dot(directionStart, normal) &gt; 0 ? 1 : -1;// æ£€æµ‹çº¿æ®µç›¸äº¤bool isLineCross = CheckLineCross(start1, end1, start2 - normal.normalized * (offset * direction), end2 - normal.normalized * (offset * direction));if (isLineCross)&#123; dis = dis2Line;&#125;else&#123; float disStart1 = (GetClosestPointOnLineSegment(start1, end1, start2) - start2).sqrMagnitude; float disEnd1 = (GetClosestPointOnLineSegment(start1, end1, end2) - end2).sqrMagnitude; float disStart2 = (GetClosestPointOnLineSegment(start2, end2, start1) - start1).sqrMagnitude; float disEnd2 = (GetClosestPointOnLineSegment(start2, end2, end1) - end1).sqrMagnitude; dis = Mathf.Min(disStart1, disEnd1, disStart2, disEnd2);&#125; çº¿æ®µäº¤å‰æ£€æµ‹ä¸Šæ–‡æˆ‘ä»¬æåˆ°éœ€è¦æ£€æµ‹çº¿æ®µæ˜¯å¦äº¤å‰ï¼Œäº¤å‰æ£€æµ‹éœ€è¦è¿›è¡Œä¸¤ä¸ªæ­¥éª¤ï¼š å¿«é€ŸæŽ’æ–¥ã€‚ è·¨ç«‹æ£€æµ‹ã€‚ å¿«é€ŸæŽ’æ–¥æ˜¯ä¸ºäº†èƒ½å¤Ÿä»¥ç®€å•çš„åˆ¤å®šå¿«é€ŸåŽ»é™¤ä¸ç›¸äº¤çš„æƒ…å†µã€‚åŽŸç†å’Œ SAT æœ‰ç‚¹ç±»ä¼¼ï¼Œåœ¨ XYZ ä¸‰è½´æ–¹å‘ä¸Šå¦‚æžœæœ‰ä¸€ä¸ªè½´å­˜åœ¨æŠ•å½±ä¸ç›¸äº¤çš„æƒ…å†µï¼Œåˆ™ä¸¤çº¿æ®µä¸€å®šä¸ç›¸äº¤ã€‚ è·¨ç«‹æ£€æµ‹çš„æ–¹æ³•å’Œå‰ä¹˜æœ‰å…³ï¼Œå¦‚æžœä¸¤æ¡çº¿æ®µäº’ç›¸è·¨ç«‹ï¼Œåˆ™å…¶ä¸­ä¸€æ¡çº¿æ®µçš„ç«¯ç‚¹åœ¨å¦ä¸€æ¡çº¿æ®µçš„ä¸¤ä¾§ã€‚ å¯¹äºŽ A1A2 çº¿æ®µæ¥è¯´ï¼Œåˆ¤æ–­ B1A2 å’Œ B2A2 ç›¸å¯¹äºŽ A1A2 çš„å·¦å³æ–¹å‘æ¥è¯´æ˜¯å¦ç›¸åï¼Œæ˜¯çš„è¯å°±è¯æ˜Ž B1ã€B2 åœ¨ A1A2 ä¸¤è¾¹ï¼›åŒç†å¯¹äºŽ B1B2 çº¿æ®µæ¥è¯´ï¼Œåˆ¤æ–­ A1B1 å’Œ A2B1 ç›¸å¯¹äºŽ A1A2 çš„å·¦å³æ–¹å‘æ¥è¯´æ˜¯å¦ç›¸åï¼Œæ˜¯çš„è¯å°±è¯æ˜Ž A1ã€A2 åœ¨ B1B2 ä¸¤è¾¹ã€‚ 12345678910111213141516171819202122232425private bool CheckLineCross(Vector3 start1, Vector3 end1, Vector3 start2, Vector3 end2)&#123; //å¿«é€ŸæŽ’æ–¥ if (Mathf.Min(start1.x, end1.x) - Mathf.Max(start2.x, end2.x) &gt; 0.01 || Mathf.Min(start1.y, end1.y) - Mathf.Max(start2.y, end2.y) &gt; 0.01 || Mathf.Min(start1.z, end1.z) - Mathf.Max(start2.z, end2.z) &gt; 0.01 || Mathf.Min(start2.x, end2.x) - Mathf.Max(start1.x, end1.x) &gt; 0.01 || Mathf.Min(start2.y, end2.y) - Mathf.Max(start1.y, end1.y) &gt; 0.01 || Mathf.Min(start2.z, end2.z) - Mathf.Max(start1.z, end1.z) &gt; 0.01) &#123; return false; &#125; Vector3 line1 = end1 - start1; Vector3 line2 = end2 - start2; //è·¨ç«‹ if (Vector3.Cross(line1, start2 - start1).normalized == Vector3.Cross(line1, end2 - start1).normalized || Vector3.Cross(line2, start1 - start2).normalized == Vector3.Cross(line2, end1 - start2).normalized) &#123; return false; &#125; return true;&#125; è¿™éƒ¨åˆ†ä¹Ÿå¯ä»¥ç›´æŽ¥ç”¨äºŽçº¿æ®µçš„ç¢°æ’žæ£€æµ‹ã€‚ ä»£ç çº¿æ®µç›¸äº¤æ£€æµ‹12345678910111213141516171819202122232425private bool CheckLineCross(Vector3 start1, Vector3 end1, Vector3 start2, Vector3 end2)&#123; //å¿«é€ŸæŽ’æ–¥ if (Mathf.Min(start1.x, end1.x) - Mathf.Max(start2.x, end2.x) &gt; 0.01 || Mathf.Min(start1.y, end1.y) - Mathf.Max(start2.y, end2.y) &gt; 0.01 || Mathf.Min(start1.z, end1.z) - Mathf.Max(start2.z, end2.z) &gt; 0.01 || Mathf.Min(start2.x, end2.x) - Mathf.Max(start1.x, end1.x) &gt; 0.01 || Mathf.Min(start2.y, end2.y) - Mathf.Max(start1.y, end1.y) &gt; 0.01 || Mathf.Min(start2.z, end2.z) - Mathf.Max(start1.z, end1.z) &gt; 0.01) &#123; return false; &#125; Vector3 line1 = end1 - start1; Vector3 line2 = end2 - start2; //è·¨ç«‹ if (Vector3.Cross(line1, start2 - start1).normalized == Vector3.Cross(line1, end2 - start1).normalized || Vector3.Cross(line2, start1 - start2).normalized == Vector3.Cross(line2, end1 - start2).normalized) &#123; return false; &#125; return true;&#125; 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475/// &lt;summary&gt;/// æ±‚ä¸¤æ¡çº¿æ®µçš„æœ€çŸ­è·ç¦»/// &lt;/summary&gt;/// &lt;param name=&quot;start1&quot;&gt;&lt;/param&gt;/// &lt;param name=&quot;end1&quot;&gt;&lt;/param&gt;/// &lt;param name=&quot;start2&quot;&gt;&lt;/param&gt;/// &lt;param name=&quot;end2&quot;&gt;&lt;/param&gt;/// &lt;returns&gt;&lt;/returns&gt;private float GetClosestDistanceBetweenLinesSqr(Vector3 start1, Vector3 end1, Vector3 start2, Vector3 end2)&#123; Vector3 line1 = end1 - start1; Vector3 line2 = end2 - start2; float dis = 0; //åˆ¤æ–­å®Œå…¨å¹³è¡Œ bool isParallel = line1.normalized == line2.normalized; if (isParallel) &#123; //å®Œå…¨å¹³è¡Œ float disStart1 = (GetClosestPointOnLineSegment(start1, end1, start2) - start2).sqrMagnitude; float disEnd1 = (GetClosestPointOnLineSegment(start1, end1, end2) - end2).sqrMagnitude; dis = Mathf.Min(disStart1, disEnd1); &#125; else &#123; Vector3 normal = Vector3.Cross(line1, line2); float len = normal.sqrMagnitude; float dis2Line = Mathf.Pow(Mathf.Abs(Vector3.Dot(start2 - start1, normal)), 2) / len; //åˆ¤æ–­åŒé¢ if (dis2Line == 0) &#123; //åŒé¢ // æ£€æµ‹çº¿æ®µç›¸äº¤ bool isLineCross = CheckLineCross(start1, end1, start2, end2); if (isLineCross) &#123; dis = 0; &#125; else &#123; float disStart1 = (GetClosestPointOnLineSegment(start1, end1, start2) - start2).sqrMagnitude; float disEnd1 = (GetClosestPointOnLineSegment(start1, end1, end2) - end2).sqrMagnitude; float disStart2 = (GetClosestPointOnLineSegment(start2, end2, start1) - start1).sqrMagnitude; float disEnd2 = (GetClosestPointOnLineSegment(start2, end2, end1) - end1).sqrMagnitude; dis = Mathf.Min(disStart1, disEnd1, disStart2, disEnd2); &#125; &#125; else &#123; float offset = Mathf.Sqrt(dis2Line); //è®¡ç®—line2ç›¸å¯¹line1çš„æ–¹ä½ Vector3 directionStart = start2 - start1; float direction = Vector3.Dot(directionStart, normal) &gt; 0 ? 1 : -1; // æ£€æµ‹çº¿æ®µç›¸äº¤ bool isLineCross = CheckLineCross(start1, end1, start2 - normal.normalized * (offset * direction), end2 - normal.normalized * (offset * direction)); if (isLineCross) &#123; dis = dis2Line; &#125; else &#123; float disStart1 = (GetClosestPointOnLineSegment(start1, end1, start2) - start2).sqrMagnitude; float disEnd1 = (GetClosestPointOnLineSegment(start1, end1, end2) - end2).sqrMagnitude; float disStart2 = (GetClosestPointOnLineSegment(start2, end2, start1) - start1).sqrMagnitude; float disEnd2 = (GetClosestPointOnLineSegment(start2, end2, end1) - end1).sqrMagnitude; dis = Mathf.Min(disStart1, disEnd1, disStart2, disEnd2); &#125; &#125; &#125; return dis;&#125; é¡¹ç›®åœ°å€ æ›´æ–°æ—¥å¿—2024-05-19 æ›´æ–°åŸºç¡€å†…å®¹ã€‚","categories":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://busyogg.github.io/categories/%E7%AE%97%E6%B3%95/"},{"name":"ç¢°æ’žæ£€æµ‹","slug":"ç®—æ³•/ç¢°æ’žæ£€æµ‹","permalink":"https://busyogg.github.io/categories/%E7%AE%97%E6%B3%95/%E7%A2%B0%E6%92%9E%E6%A3%80%E6%B5%8B/"}],"tags":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://busyogg.github.io/tags/%E7%AE%97%E6%B3%95/"},{"name":"ç¢°æ’žæ£€æµ‹","slug":"ç¢°æ’žæ£€æµ‹","permalink":"https://busyogg.github.io/tags/%E7%A2%B0%E6%92%9E%E6%A3%80%E6%B5%8B/"},{"name":"çº¿æ®µ","slug":"çº¿æ®µ","permalink":"https://busyogg.github.io/tags/%E7%BA%BF%E6%AE%B5/"}]},{"title":"Untiy-èŠ‚ç‚¹ç¼–è¾‘å™¨å¼€å‘ä¼˜åŒ–æ¡†æž¶ GraphViewExtension","slug":"Untiy-èŠ‚ç‚¹ç¼–è¾‘å™¨å¼€å‘ä¼˜åŒ–æ¡†æž¶GraphViewExtension","date":"2024-05-12T13:57:08.000Z","updated":"2024-05-31T09:21:23.289Z","comments":true,"path":"article/1166dedab522/","link":"","permalink":"https://busyogg.github.io/article/1166dedab522/","excerpt":"","text":"ç®€ä»‹é€šè¿‡ Attribute æ ‡ç­¾ç®€åŒ–èŠ‚ç‚¹ç¼–è¾‘å™¨å¼€å‘ã€‚ æ”¯æŒé€‰ä¸­æè¾¹ï¼Œè‡ªå®šä¹‰èŠ‚ç‚¹å¤§å°ï¼Œæœªæ‰‹åŠ¨ä¿®æ”¹å¤§å°çš„æ—¶å€™è‡ªé€‚åº”èŠ‚ç‚¹å¤§å°ã€‚ æ”¯æŒæ‰“å¼€ã€ä¿å­˜ã€å…³é—­èŠ‚ç‚¹å›¾ã€‚æ”¯æŒ Ctrl+S ä¿å­˜å½“å‰èŠ‚ç‚¹å›¾ã€‚ æœ¬æ–‡åªé˜è¿°åŽŸç†ï¼Œå…·ä½“çš„ä½¿ç”¨æ–¹æ³•è¯·è§è¯´æ˜Žæ–‡æ¡£ GraphViewExtension æ–‡æ¡£ æ¼”ç¤ºè§†é¢‘èŠ‚ç‚¹æ“ä½œ æ–‡ä»¶æ“ä½œ åŽŸç†èŠ‚ç‚¹UIèŠ‚ç‚¹çš„ UI åˆå§‹åŒ–æ˜¯é€šè¿‡ç»™å­—æ®µæ‰“ Attribute æ ‡ç­¾ï¼Œç„¶åŽåœ¨åˆ›å»ºèŠ‚ç‚¹çš„æ—¶å€™è¿›è¡Œåå°„åˆå§‹åŒ–ã€‚ å› ä¸º GraphView ç”¨çš„æ˜¯ UI ToolKit çš„ä½“ç³»ï¼Œæ‰€ä»¥æ‰€æœ‰çš„ UI éƒ½æ˜¯ VisualElement èŠ‚ç‚¹ã€‚è¯¥ä½“ç³»å’Œ Editor çš„ UI ä¸åŒï¼Œå› æ­¤æ­¤å¤„ä¸å¥—ç”¨ EditorUIExtension çš„åˆå§‹åŒ–æ–¹å¼ã€‚ ä¸ºäº†ä¿æŒ UI åˆå§‹åŒ–çš„ä¸€è‡´æ€§ï¼Œæœ¬é¡¹ç›®é‡‡ç”¨ VisualElement ä½œä¸ºä¸€ä¸ª UI çš„çˆ¶å®¹å™¨ï¼Œé‡Œé¢å†æ·»åŠ å…·ä½“çš„ UIã€‚è¿™æ ·åœ¨ UI æž„é€ ä¸º æ ‡ç­¾ + è¾“å…¥æ¡† çš„ç±»åž‹çš„æ—¶å€™ï¼Œå°±å¯ä»¥åœ¨è¿™ä¸ªçˆ¶å®¹å™¨é‡Œé¢è¿›è¡Œæ¨ªå‘æŽ’å¸ƒè€Œä¸å½±å“åˆ°æœ€ä¸Šå±‚çš„å®¹å™¨ã€‚ æ³¨æ„ï¼šçˆ¶å®¹å™¨æ–¹å‘é»˜è®¤æ˜¯ç«–å‘æŽ’åˆ—ï¼Œéœ€è¦è‡ªå·±è®¾ç½®æ ·å¼ä¸ºæ¨ªå‘ graph LR; table_1[\"çˆ¶å®¹å™¨æ ‡ç­¾è¾“å…¥æ¡†\"] å…·ä½“å®žçŽ°å¦‚ä¸‹ï¼š 12345678910111213141516171819case NodeTypeEnum.Input: ele.style.flexDirection = FlexDirection.Row; //foreLabel ä¸ºåœ¨ switch ä¹‹å¤–å®šä¹‰çš„è¾…åŠ©æ ‡ç­¾ï¼Œåœ¨æ­¤å¤„ä»£ç çœç•¥å®šä¹‰è¿‡ç¨‹ foreLabel = new Label(); foreLabel.style.fontSize = _fontSize; foreLabel.text = subName; ele.Add(foreLabel); TextField text = new TextField(); text.style.flexGrow = 1; text.style.height = _fontSize * 1.2f; var fontChild = text.Children().FirstOrDefault().Children().FirstOrDefault(); fontChild.style.fontSize = _fontSize; text.RegisterValueChangedCallback(evt =&gt; &#123; setValue(this, evt.newValue); &#125;); ele.Add(text); break; åŒæ—¶ä¸ºäº†èƒ½å¤ŸæŠŠè‡ªå®šä¹‰æ•°é‡çš„ UI æ¡†åœ¨åŒä¸€ä¸ªçŸ©å½¢é‡Œï¼Œé¢å¤–å®šä¹‰ä¸€ç§ Box ç±»åž‹çš„ UIï¼Œåœ¨è¯¥ UI åˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„é¡¶å±‚å®¹å™¨æ¥å®¹çº³ UIã€‚å®¹çº³ä¸€å®šæ•°é‡çš„ UI ä¹‹åŽï¼ˆBox è®¾ç½®çš„æ•°é‡ï¼‰ï¼Œä¸‹ä¸€æ¬¡åˆ›å»º UI ä¼šå†æ–°å»ºä¸€ä¸ªé¡¶å±‚å®¹å™¨ï¼ŒåŽé¢çš„ UI éƒ½åœ¨è¿™ä¸ªæ–°çš„å®¹å™¨é‡Œå®¹çº³ã€‚ graph TD; table_1[\"é»˜è®¤é¡¶å±‚å®¹å™¨UI1UI2UI3\"] table_2[\"Box åˆ›å»ºçš„é¡¶å±‚å®¹å™¨UI4UI5\"] table_3[\"Box ä¹‹åŽçš„æ–°é¡¶å±‚å®¹å™¨UI6UI7UI8\"] table_1 --> table_2 table_2 --> table_3 å…·ä½“çš„å®žçŽ°å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132//ui box åˆ†å‰²ã€‚æ²¡æœ‰ box æ ‡ç­¾çš„æƒ…å†µä¸‹éƒ½åœ¨é»˜è®¤çš„ç¬¬ä¸€ä¸ª box ä¸­æ·»åŠ  uiint boxCount = -1;var box = new VisualElement();//extensionContainer ä¸ºæ‰€æœ‰é¡¶å±‚å®¹å™¨çš„çˆ¶å®¹å™¨extensionContainer.Add(box);foreach (var field in fields)&#123; GraphNode attr = field.GetCustomAttribute&lt;GraphNode&gt;(); if (attr != null) &#123; // åˆ¤æ–­æ˜¯å¦éœ€è¦å¢žåŠ  ui box if (boxCount == 0) &#123; box = new VisualElement(); extensionContainer.Add(box); &#125; if (boxCount &gt; -1) &#123; boxCount--; &#125; switch (attr.Type())&#123; case NodeTypeEnum.Box: box = new VisualElement(); extensionContainer.Add(box); boxCount = int.Parse(extra[0]); // æ­¤å¤„çœç•¥ box æ ·å¼è®¾ç½® break; &#125; &#125;&#125; é€šè¿‡ boxCount æ¥è®¡æ•°ï¼Œæœ‰æ–°çš„ Box çš„æ—¶å€™æ‰ä¼šèµ‹å€¼å¹¶ä¸”æ‰§è¡Œåˆ¤æ–­å’Œè‡ªå‡ï¼Œè‡ªå‡åˆ° 0 ä»£è¡¨å®Œå…¨å¡«å…¥è¶³é‡çš„ UIï¼Œè¿™æ—¶å€™å°±éœ€è¦æ–°å»ºä¸€ä¸ª VisualElement æ¥è£… Box å¤–çš„ UIã€‚ å¦‚æžœä»¥ä¸Šæ–¹æ³•æ— æ³•æ»¡è¶³ä½ çš„ UI æž„å»ºéœ€è¦çš„è¯ï¼Œé€šè¿‡é‡å†™ CustomUI æ¥å®žçŽ°å®¢åˆ¶åŒ– UIã€‚ æ•°æ®èŠ‚ç‚¹å†…è®¾æœ‰ä¸€ä¸ª ExpandoObject ç±»åž‹å­—æ®µ _data æ¥å­˜å‚¨æ•°æ®ã€‚ ExpandoObject æ˜¯ä¸ª dynamic ç±»åž‹ï¼Œå¯ä»¥é€šè¿‡ç‚¹æ¥è®¾ç½®å’Œè¯»å–å±žæ€§ã€‚ ä¾‹å¦‚ï¼š 123dynamic obj = new ExpandoObject();obj.a = 1;obj.b = &quot;str&quot;; å› æ­¤æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªåŠ¨æ€ç±»åž‹æ¥ä¿å­˜ä»»æ„ç±»åž‹çš„æ•°æ®ã€‚ ä¿å­˜æ•°æ®é™¤äº†å½“å‰èŠ‚ç‚¹çš„æ•°æ®ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¿å­˜èŠ‚ç‚¹çš„å…³ç³»ã€‚å› æ­¤æˆ‘ä»¬ç”¨æ ‘æ¥å­˜å‚¨ã€‚ æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªç®€å•çš„æ•°æ®èŠ‚ç‚¹ç±» GDataNode ï¼Œè¯¥ç±»ä¿å­˜æ•°æ®å’Œå­èŠ‚ç‚¹åˆ—è¡¨ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546using System.Collections.Generic;namespace GraphViewExtension&#123; public class GDataNode &#123; private List&lt;GDataNode&gt; _children = new List&lt;GDataNode&gt;(); private dynamic _data; private string _type; public void SetData(dynamic data) &#123; _data = data; &#125; public void SetNodeType(string type) &#123; _type = type; &#125; public void AddChild(GDataNode node) &#123; if (!_children.Contains(node)) &#123; _children.Add(node); &#125; &#125; public List&lt;GDataNode&gt; GetChildren() &#123; return _children; &#125; public dynamic GetData() &#123; return _data; &#125; public string GetNodeType() &#123; return _type; &#125; &#125;&#125; ç„¶åŽæˆ‘ä»¬åœ¨ä¿å­˜æ•°æ®çš„æ—¶å€™ï¼Œé€šè¿‡éåŽ† _outputPort çš„ connections ï¼Œä¹Ÿå°±æ˜¯è¾“å‡ºèŠ‚ç‚¹çš„è¿žæŽ¥ï¼Œé€’å½’åœ°ä¿å­˜åˆ°æœ¬èŠ‚ç‚¹çš„ GDataNode ä¸­ã€‚ å…·ä½“çš„æµç¨‹å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324/// &lt;summary&gt;/// ä¿å­˜æ•°æ®/// &lt;/summary&gt;/// &lt;returns&gt;&lt;/returns&gt;public GDataNode SaveData()&#123; // ä¿å­˜åŸºæœ¬æ•°æ® _data.guid = guid; _data.pos = _defPos.ToString(); _data.size = (_curSize.Equals(Vector2.zero) ? _defSize : _curSize).ToString(); _dataNode.SetNodeType(_type.FullName); // ä¿å­˜é¢å¤–æ•°æ®ï¼Œç”¨æˆ·è‡ªå®šä¹‰ SetData(); _dataNode.SetData(_data); // éåŽ†å­èŠ‚ç‚¹ var connections = _outputPort.connections; foreach (var edge in connections) &#123; RootNode node = edge.input.node as RootNode; _dataNode.AddChild(node?.SaveData()); &#125; return _dataNode;&#125; å…¶ä¸­ SetData æ˜¯ç”¨æˆ·è‡ªå®šä¹‰ä¿å­˜æ•°æ®çš„æ–¹æ³•ã€‚ è¯»å–æ•°æ®å’Œç”¨æˆ·è‡ªå®šä¹‰ä¿å­˜æ•°æ®ä¸€æ ·ï¼Œæˆ‘ä»¬è¯»å–æ•°æ®çš„æ—¶å€™ä¹Ÿéœ€è¦è‡ªå·±å®žçŽ°æ•°æ®çš„åˆå§‹åŒ–ã€‚å…·ä½“çš„å‡½æ•°ä¸º ResetData ã€‚ èŠ‚ç‚¹å°ºå¯¸æœ¬é¡¹ç›®å…è®¸ç”¨æˆ·é€šè¿‡æ‹–æ‹½èŠ‚ç‚¹å³ä¸‹è§’è¿›è¡ŒèŠ‚ç‚¹å°ºå¯¸çš„ä¿®æ”¹ã€‚ å°ºå¯¸åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š _defSize ï¼Œç”¨äºŽå­˜å‚¨æœ€å°çš„å¤§å°ã€‚ _curSize ï¼Œç”¨äºŽå­˜å‚¨å½“å‰å¤§å°ã€‚ å½“æ‰‹åŠ¨ä¿®æ”¹è¿‡å¤§å°åŽï¼Œéƒ¨åˆ†åŠŸèƒ½å°±è¯»å– _curSize ï¼Œå¦åˆ™è¯»å– _defSize çš„æ•°æ®ã€‚ ä¸»è¦çš„åŽŸç†å°±æ˜¯ç›‘å¬é¼ æ ‡çš„æŒ‰ä¸‹ã€ç§»åŠ¨å’ŒæŠ¬èµ·äº‹ä»¶ï¼Œç„¶åŽè¿›è¡Œç›¸åº”çš„æ“ä½œã€‚ é¼ æ ‡æŒ‰ä¸‹é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶æ˜¯åœ¨èŠ‚ç‚¹å†…ç›‘å¬çš„ã€‚ é¼ æ ‡æŒ‰ä¸‹çš„æ—¶å€™æˆ‘ä»¬åˆ¤æ–­é¼ æ ‡åœ¨èŠ‚ç‚¹çš„åæ ‡æ˜¯å¦åœ¨èŠ‚ç‚¹å³ä¸‹è§’çš„èŒƒå›´å†…ï¼Œæœ¬é¡¹ç›®ç»™äº† 10 ä¸ªåƒç´ çš„ç©ºä½™ã€‚ 1234567891011121314151617/// &lt;summary&gt;/// èŠ‚ç‚¹å°ºå¯¸è°ƒèŠ‚é¼ æ ‡æŒ‰ä¸‹å›žè°ƒ/// &lt;/summary&gt;/// &lt;param name=&quot;evt&quot;&gt;&lt;/param&gt;private void ResizeStart(MouseDownEvent evt)&#123; if (evt.button == 0) &#123; // åˆ¤æ–­æ”¹å¤§å° if (IsResizeArea(evt.localMousePosition)) &#123; _mouseOffset = evt.mousePosition - layout.size; _isResizing = true; evt.StopPropagation(); &#125; &#125;&#125; evt çš„ localMousePosition æ˜¯é¼ æ ‡åœ¨å½“å‰èŠ‚ç‚¹çš„åæ ‡ï¼Œä»¥èŠ‚ç‚¹å·¦ä¸Šè§’ä¸º (0,0)ã€‚ mousePosition æ˜¯é¼ æ ‡çš„ä¸–ç•Œåæ ‡ï¼Œlayout.size æ˜¯å½“å‰èŠ‚ç‚¹çš„å°ºå¯¸ã€‚é€šè¿‡ç›¸å‡å¾—åˆ°å½“å‰èŠ‚ç‚¹å·¦ä¸Šè§’çš„ä¸–ç•Œåæ ‡ã€‚ é¼ æ ‡ç§»åŠ¨é¼ æ ‡ç§»åŠ¨äº‹ä»¶æ˜¯åœ¨ GraphView ç›‘å¬çš„ã€‚å¦‚æžœåœ¨èŠ‚ç‚¹ç›‘å¬ï¼Œåˆ™åœ¨é¼ æ ‡ç§»å‡ºèŠ‚ç‚¹çš„æ—¶å€™ä¼šæŽ¥æ”¶ä¸åˆ°äº‹ä»¶ã€‚ é¼ æ ‡ç§»åŠ¨çš„æ—¶å€™ï¼Œå¦‚æžœæ˜¯å°ºå¯¸ä¿®æ”¹çŠ¶æ€ï¼Œåˆ™è®¡ç®—æ–°çš„å¤§å°å¹¶æ›´æ–°ã€‚è®¡ç®—å¤§å°çš„æ—¶å€™ä¼šå’Œæœ€å°å¤§å°è¿›è¡Œæ¯”è¾ƒé€‰æ‹©å…¶ä¸­è¾ƒå¤§çš„ä¸€æ–¹ã€‚ 12345678910111213141516/// &lt;summary&gt;/// èŠ‚ç‚¹å°ºå¯¸è°ƒèŠ‚é¼ æ ‡ç§»åŠ¨å›žè°ƒ/// &lt;/summary&gt;/// &lt;param name=&quot;evt&quot;&gt;&lt;/param&gt;private void ResizeMove(MouseMoveEvent evt)&#123; if (_isResizing) &#123; Vector2 newSize = evt.mousePosition - _mouseOffset; newSize = Vector2.Max(_defSize, newSize); // æ›´æ–°èŠ‚ç‚¹çš„å¤§å° UpdateSize(newSize); evt.StopPropagation(); &#125;&#125; é¼ æ ‡æŠ¬èµ·é¼ æ ‡æŠ¬èµ·äº‹ä»¶æ˜¯åœ¨ GraphView ç›‘å¬çš„ã€‚å¦‚æžœåœ¨èŠ‚ç‚¹ç›‘å¬ï¼Œåˆ™åœ¨é¼ æ ‡ç§»å‡ºèŠ‚ç‚¹çš„æ—¶å€™ä¼šæŽ¥æ”¶ä¸åˆ°äº‹ä»¶ã€‚ é¼ æ ‡æŠ¬èµ·çš„æ—¶å€™ç½®å°ºå¯¸è°ƒèŠ‚çŠ¶æ€ä¸º false ã€‚ 1234567891011121314151617/// &lt;summary&gt;/// èŠ‚ç‚¹å°ºå¯¸è°ƒèŠ‚é¼ æ ‡æŠ¬èµ·å›žè°ƒ/// &lt;/summary&gt;/// &lt;param name=&quot;evt&quot;&gt;&lt;/param&gt;private void ResizeEnd(MouseUpEvent evt)&#123; // å°ºå¯¸è°ƒèŠ‚éƒ¨åˆ†çš„ä»£ç  if (_isResizing) &#123; Debug.Log(layout.size); _isResizing = false; evt.StopPropagation(); &#125; // æè¾¹ç”¨çš„å€¼ _defPos = layout.position + new Vector2(_borderOffset * 0.5f, _borderOffset * 0.5f);&#125; æè¾¹æœ¬é¡¹ç›®æ”¯æŒåœ¨ç‚¹å‡»èŠ‚ç‚¹çš„æ—¶å€™å¯¹èŠ‚ç‚¹è¿›è¡Œæè¾¹ï¼Œå¦‚æžœèŠ‚ç‚¹æœ‰å‰ç½®èŠ‚ç‚¹ï¼Œåˆ™å‰ç½®èŠ‚ç‚¹ä¹Ÿä¼šæè¾¹ï¼Œè¿™æ ·å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°è¯¥èŠ‚ç‚¹çš„è·¯çº¿ã€‚ ç‚¹å‡»æè¾¹æ˜¯åœ¨ GraphView ç›‘å¬çš„ï¼Œå…·ä½“çš„é€»è¾‘è¯·çœ‹ [å›¾](# å›¾) éƒ¨åˆ†ã€‚ æè¾¹çš„å®žçŽ°æè¾¹çš„å®žçŽ°å¾ˆç®€å•ï¼Œåªéœ€è¦ä¿®æ”¹èŠ‚ç‚¹çš„ style çš„ border ç›¸å…³çš„æ ·å¼å°±å¯ä»¥ã€‚ ç”±äºŽæè¾¹çš„æ—¶å€™ VisualElement æ˜¯å†…æè¾¹ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ‰©å¤§èŠ‚ç‚¹çš„å¤§å°ã€‚ æ‰©å¤§å¤§å°çš„æ—¶å€™éœ€è¦ç”¨ _curSize æˆ– _defSize åŠ ä¸Šæè¾¹çš„ ** å®½åº¦ *2**ï¼Œè¯¥å€¼æœ¬é¡¹ç›®å­˜å‚¨ä¸º _borderOffset ã€‚è¿˜åŽŸçš„æ—¶å€™å°±æŠŠèŠ‚ç‚¹å°ºå¯¸è®¾ä¸º _curSize æˆ– _defSize å³å¯ã€‚ ä½ç½®åç§»å› ä¸ºæˆ‘ä»¬ä¿®æ”¹äº†èŠ‚ç‚¹å¤§å°ï¼Œå› æ­¤èŠ‚ç‚¹ä¼šäº§ç”Ÿè§†è§‰ä¸Šçš„åç§»ï¼ˆèŠ‚ç‚¹å†…å¤§å°ä¸å˜ï¼Œæ‰©å¤§çš„éƒ¨åˆ†ä¸ºæè¾¹ï¼Œæ•´ä¸ªèŠ‚ç‚¹å·¦ä¸Šè§’åæ ‡ä¸å˜ï¼Œå› æ­¤è§†è§‰ä¸Šä¼šå¾€å³ä¸‹åç§»ä¸€ç‚¹è·ç¦»ï¼Œè·ç¦»ä¸ºæè¾¹å®½åº¦ï¼‰ã€‚ æ‰€ä»¥æˆ‘ä»¬è¦å¯¹è¿™ä¸ªåç§»è¿›è¡Œä¿®æ­£ã€‚ ä¿®æ­£çš„åŽŸç†ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦åœ¨æè¾¹çš„æ—¶å€™å¾€å·¦ä¸Šç§»åŠ¨æè¾¹å®½åº¦çš„è·ç¦»ï¼Œå–æ¶ˆæè¾¹çš„æ—¶å€™æŠŠèŠ‚ç‚¹ä½ç½®è¿˜åŽŸå³å¯ã€‚ å› æ­¤æˆ‘ä»¬éœ€è¦è®°å½•èŠ‚ç‚¹çš„åŽŸå§‹åæ ‡ _defPos ã€‚ è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªé¢å¤–æƒ…å†µï¼Œç”±äºŽæœ¬é¡¹ç›®çš„ å¤‡æ³¨ UI ä¼šåœ¨æ²¡æ‰‹åŠ¨è°ƒæ•´èŠ‚ç‚¹å°ºå¯¸çš„æƒ…å†µä¸‹è‡ªåŠ¨æ›´æ–°èŠ‚ç‚¹å°ºå¯¸ï¼Œå› æ­¤ä¼šåœ¨æè¾¹çš„æ—¶å€™é€ æˆé‡å¤ä¿®æ­£åç§»çš„æƒ…å†µï¼Œå› æ­¤å¢žåŠ ä¸€ä¸ªæ ‡è¯† _lastBordered åˆ¤æ–­æ˜¯å¦ä¿®æ­£è¿‡åæ ‡ã€‚ å…·ä½“çš„å®žçŽ°å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647/// &lt;summary&gt;/// æè¾¹/// &lt;/summary&gt;private void DrawBorder()&#123; if (_isBordered) &#123; if (_curSize.Equals(Vector2.zero)) &#123; style.width = _defSize.x + _borderOffset; style.height = _defSize.y + _borderOffset; &#125; else &#123; style.width = _curSize.x + _borderOffset; style.height = _curSize.y + _borderOffset; &#125; _defPos = new Vector2(style.left.value.value, style.top.value.value); // å¦‚æžœæ²¡æè¿‡è¾¹ï¼Œåˆ™è°ƒæ•´èŠ‚ç‚¹åæ ‡ä½ç½®ä»¥é˜²æ­¢é”™ä½ if (_lastBordered != _isBordered) &#123; style.left = _defPos.x - _borderOffset * 0.5f; style.top = _defPos.y - _borderOffset * 0.5f; &#125; &#125; else &#123; if (_curSize.Equals(Vector2.zero)) &#123; style.width = _defSize.x; style.height = _defSize.y; &#125; else &#123; style.width = _curSize.x; style.height = _curSize.y; &#125; // è¿˜åŽŸèŠ‚ç‚¹é»˜è®¤ä½ç½® style.left = _defPos.x; style.top = _defPos.y; &#125; _lastBordered = _isBordered;&#125; å›¾ï¼ˆGraphViewï¼‰èœå•æœ¬é¡¹ç›®åœ¨åˆ›å»ºå›¾çš„æ—¶å€™å¼•å…¥è‡ªå®šä¹‰çš„å¤šçº§æœç´¢èœå•ï¼Œå¹¶åœ¨èœå•ä¸­æ³¨å†Œé€‰æ‹©ç›‘å¬äº‹ä»¶ã€‚å…·ä½“é€»è¾‘è§ [å¤šçº§æœç´¢èœå•](# å¤šçº§æœç´¢èœå•) é¡¹ã€‚ ç„¶åŽæˆ‘ä»¬æ³¨å†Œå›¾çš„ nodeCreationRequest å§”æ‰˜ï¼Œä½¿å…¶åœ¨åˆ›å»ºèŠ‚ç‚¹çš„æ—¶å€™æ‰“å¼€è¯¥èœå•ã€‚ 123456789101112public GGraph(EditorWindow editorWindow, GSearchWindow provider)&#123; // ç›‘å¬åˆ›å»ºèŠ‚ç‚¹ nodeCreationRequest += (context) =&gt; &#123; // æ‰“å¼€æœç´¢æ¡† SearchWindow.Open( new SearchWindowContext(context.screenMousePosition), provider ); &#125;;&#125; ç›‘å¬äº‹ä»¶æœ¬é¡¹ç›®é™¤äº† Unity æä¾›çš„åŸºç¡€çš„æ»šè½®ç¼©æ”¾ã€çª—å£æ‹–åŠ¨ã€é€‰ä¸­èŠ‚ç‚¹ç§»åŠ¨ã€å¤šèŠ‚ç‚¹æ¡†é€‰åŠŸèƒ½å¤–ï¼Œé¢å¤–ç›‘å¬äº†é¼ æ ‡æŒ‰ä¸‹ã€é¼ æ ‡ç§»åŠ¨ã€ç‚¹å‡»å’ŒæŒ‰é”®æŠ¬èµ·ã€‚ åŸºç¡€åŠŸèƒ½1234567891011public GGraph(EditorWindow editorWindow, GSearchWindow provider)&#123; // æ»šè½®ç¼©æ”¾ SetupZoom(ContentZoomer.DefaultMinScale, ContentZoomer.DefaultMaxScale); // çª—å£å†…å®¹æ‹–åŠ¨ this.AddManipulator(new ContentDragger()); // é€‰ä¸­ Node ç§»åŠ¨åŠŸèƒ½ this.AddManipulator(new SelectionDragger()); // å¤šä¸ª node æ¡†é€‰åŠŸèƒ½ this.AddManipulator(new RectangleSelector());&#125; ç‚¹å‡»æè¾¹å…¶ä¸­ç›‘å¬é¼ æ ‡æŒ‰ä¸‹ã€é¼ æ ‡ç§»åŠ¨å’Œç‚¹å‡»æ˜¯ä¸ºäº†å®žçŽ°èŠ‚ç‚¹ç‚¹å‡»æè¾¹çš„åŠŸèƒ½ã€‚ å…¶ä¸­é¼ æ ‡ç§»åŠ¨æ˜¯ä¸ºäº†åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦äº§ç”Ÿäº†æ‹–æ‹½ï¼Œåœ¨æ‹–æ‹½çš„æ—¶å€™ä¸äº§ç”Ÿæè¾¹ã€‚é¼ æ ‡æŒ‰ä¸‹æ˜¯ä¸ºäº†åˆ¤æ–­æ˜¯å¦å¯¹èŠ‚ç‚¹è¿›è¡Œäº†æ“ä½œï¼Œå¦åˆ™åªç›‘å¬ç§»åŠ¨çš„è¯ä¸ç®¡é¼ æ ‡æ˜¯å¦æŒ‰ä¸‹éƒ½ä¼šåˆ¤å®šã€‚ æè¾¹åˆ¤æ–­çš„ä¸»è¦é€»è¾‘åœ¨ç‚¹å‡»ç›‘å¬å†…ï¼Œå…·ä½“é€»è¾‘å¦‚ä¸‹ã€‚ flowchart TB; A[\"èŽ·å–ç‚¹å‡»çš„ UI\"] --> B[\"åˆ¤æ–­æ˜¯å¦ä¸ºç©º\"] B --> C[\"ä¸ºç©ºï¼Œå–æ¶ˆåŽŸèŠ‚ç‚¹æè¾¹\"] B --> D[\"ä¸ä¸ºç©ºï¼Œå¾ªçŽ¯åˆ¤æ–­èŠ‚ç‚¹æˆ–èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹æ˜¯å¦ä¸º RootNode\"] D --> E[\"ä¸æ˜¯ï¼Œå–æ¶ˆåŽŸèŠ‚ç‚¹æè¾¹\"] D --> F[\"æ˜¯ï¼Œåˆ¤æ–­èŠ‚ç‚¹æˆ–èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹æ˜¯å¦å¯äº¤äº’\"] F --> G[\"æ˜¯ï¼Œä¸åšä»»ä½•æ“ä½œ\"] F --> H[\"ä¸æ˜¯ï¼Œåˆ¤æ–­åŽŸèŠ‚ç‚¹æ˜¯å¦å­˜åœ¨å¹¶ä¸”å½“å‰èŠ‚ç‚¹ä¸ç­‰äºŽåŽŸèŠ‚ç‚¹å¹¶ä¸”ä¸æ˜¯ RootNode\"] H --> I[\"æ˜¯ï¼Œå–æ¶ˆåŽŸèŠ‚ç‚¹æè¾¹\"] H --> J[\"ä¸æ˜¯ï¼Œæè¾¹å½“å‰èŠ‚ç‚¹ï¼Œå¹¶ä¿å­˜\"] ä»£ç å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879public GGraph(EditorWindow editorWindow, GSearchWindow provider)&#123; RegisterCallback&lt;PointerDownEvent&gt;(evt =&gt; &#123; if (evt.button == 0) &#123; _isDown = true; &#125; &#125;); RegisterCallback&lt;PointerMoveEvent&gt;(evt =&gt; &#123; if (_isDown) &#123; _isMoved = true; &#125; &#125;); // ç›‘å¬ç‚¹å‡»çš„èŠ‚ç‚¹ RegisterCallback&lt;ClickEvent&gt;(evt =&gt; &#123; if (!_isMoved) &#123; Vector2 localMousePosition = evt.position - new Vector3(layout.xMin, layout.yMin); // èŽ·å–å½“å‰è¢«é€‰ä¸­çš„å¯¹è±¡ var currentSelection = panel.Pick(localMousePosition); if (currentSelection == null) &#123; if (_clickNode != null) &#123; _clickNode.UnSelected(); _clickNode = null; &#125; &#125; else &#123; bool isInput = false; while (currentSelection != null &amp;&amp; currentSelection is not RootNode) &#123; if (IsInputField(currentSelection)) &#123; isInput = true; break; &#125; currentSelection = currentSelection.parent; &#125; if (currentSelection == null) &#123; if (_clickNode != null) &#123; _clickNode.UnSelected(); _clickNode = null; &#125; &#125; else &#123; if (isInput) return; if (_clickNode != null &amp;&amp; currentSelection != _clickNode &amp;&amp; currentSelection is not RootNode) &#123; _clickNode.UnSelected(); _clickNode = null; &#125; else &#123; _clickNode?.UnSelected(); _clickNode = currentSelection as RootNode; _clickNode?.Selected(); &#125; &#125; &#125; &#125; _isMoved = false; _isDown = false; &#125;);&#125; ç»„åˆé”®ç›‘å¬ç›‘å¬ç»„åˆé”®ä¸»è¦æ˜¯ä¸ºäº†ç›‘å¬ Ctrl+S æ¥ä¿å­˜æ–‡ä»¶ï¼ˆç„¦ç‚¹éœ€è¦åœ¨ GraphView å†…ï¼‰ã€‚ ä¿å­˜æ–‡ä»¶çš„é€»è¾‘å’Œä¸‹ä¸€å°èŠ‚çš„é€»è¾‘ç›¸åŒï¼Œä¸è¿‡è¿™é‡Œä¸ä¼šé€‰æ‹©ä¿å­˜çš„è·¯å¾„ï¼Œè€Œæ˜¯ç›´æŽ¥ä½¿ç”¨æ‰“å¼€çš„è·¯å¾„ã€‚ å¦‚æžœæ˜¯æ–°çš„æ–‡ä»¶çš„è¯ï¼Œä¼šèµ°åˆæ¬¡ä¿å­˜æ–‡ä»¶çš„é€»è¾‘ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243public GGraph(EditorWindow editorWindow, GSearchWindow provider)&#123; // ç›‘å¬ä¿å­˜ç»„åˆé”® RegisterCallback&lt;KeyUpEvent&gt;(OnKeyUp);&#125;private void OnKeyUp(KeyUpEvent evt)&#123; // æ£€æŸ¥æ˜¯å¦æŒ‰ä¸‹äº† Ctrl é”®å’Œ S é”® if (evt.keyCode == KeyCode.S &amp;&amp; evt.ctrlKey) &#123; if (_filePath == &quot;&quot;) &#123; Save(); return; &#125; Debug.Log(&quot;Ctrl + S pressed. Saving...&quot;); // æ‰§è¡Œä¿å­˜æ“ä½œ List&lt;GDataNode&gt; list = SaveData(); List&lt;SaveJson&gt; listJson = new List&lt;SaveJson&gt;(); foreach (var data in list) &#123; listJson.Add(ToJson(data)); &#125; string jsonData = JsonConvert.SerializeObject(listJson); FileInfo myFile = new FileInfo(_filePath); StreamWriter sw = myFile.CreateText(); foreach (var s in jsonData) &#123; sw.Write(s); &#125; sw.Close(); // è¿™é‡Œå¯ä»¥æ·»åŠ ä½ çš„ä¿å­˜é€»è¾‘ evt.StopPropagation (); // é˜»æ­¢äº‹ä»¶ä¼ é€’ï¼Œé¿å…è§¦å‘å…¶ä»–äº‹ä»¶ &#125;&#125; æ•°æ®å­˜å‚¨ä¸Žè¯»å–æ•°æ®å­˜å‚¨ä¸Žè¯»å–ï¼Œé‡ç‚¹åœ¨äºŽæ•°æ®çš„åºåˆ—åŒ–ä¸Žååºåˆ—åŒ–ã€‚ åºåˆ—åŒ–æ•°æ®é¦–å…ˆæˆ‘ä»¬è€ƒè™‘èŠ‚ç‚¹å¯èƒ½å¹¶ä¸ä¸€å®šä»ŽåŒä¸€ä¸ªæ ¹èŠ‚ç‚¹å±•å¼€ï¼Œå› æ­¤éœ€è¦ä¿å­˜æˆä¸€ä¸ªæ ¹èŠ‚ç‚¹åˆ—è¡¨ã€‚ ç”±äºŽæˆ‘ä»¬å®šä¹‰çš„ GDataNode å…·æœ‰é¢å¤–çš„æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬æå–å…¶å­—æ®µæž„æˆæ–°çš„æ•°æ®ç±» SaveJson ã€‚ 12345678910111213using System.Collections.Generic;namespace GraphViewExtension&#123; public class SaveJson &#123; public List&lt;SaveJson&gt; children = new List&lt;SaveJson&gt;(); public dynamic data; public string type; &#125;&#125; æœ¬é¡¹ç›®æŠŠæ•°æ®ä¿å­˜ä¸º Json æ ¼å¼ï¼Œåˆ©ç”¨ Unity è‡ªå¸¦çš„ Newtonsoft.Json æ¥å®žçŽ°åºåˆ—åŒ–ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950private void Save()&#123; string filePath = EditorUtility.SaveFilePanel (&quot;ä¿å­˜åˆ°æœ¬åœ°&quot;, Application.dataPath + &quot;/Json&quot;, &quot;NewFile&quot;, &quot;json&quot;); if (filePath != &quot;&quot;) &#123; SetFilePath(filePath); List&lt;GDataNode&gt; list = SaveData(); List&lt;SaveJson&gt; listJson = new List&lt;SaveJson&gt;(); foreach (var data in list) &#123; listJson.Add(ToJson(data)); &#125; string jsonData = JsonConvert.SerializeObject(listJson); FileInfo myFile = new FileInfo(filePath); StreamWriter sw = myFile.CreateText(); foreach (var s in jsonData) &#123; sw.Write(s); &#125; sw.Close(); _editorWindow.ShowNotification (new GUIContent (&quot;ä¿å­˜æˆåŠŸï¼Œè·¯å¾„ä¸º:&quot; + filePath)); &#125;&#125;/// &lt;summary&gt;/// è½¬æ¢ä¸º JSON/// &lt;/summary&gt;/// &lt;param name=&quot;data&quot;&gt;&lt;/param&gt;/// &lt;returns&gt;&lt;/returns&gt;public SaveJson ToJson(GDataNode data)&#123; SaveJson save = new SaveJson(); save.type = data.GetNodeType(); save.data = data.GetData(); foreach (var child in data.GetChildren()) &#123; save.children.Add(ToJson(child)); &#125; return save;&#125; ååºåˆ—åŒ–æ•°æ®ååºåˆ—åŒ–åŒç†ï¼Œæˆ‘ä»¬éœ€è¦æŠŠ SaveJson è½¬ä¸º GDataNode ã€‚ ç”±äºŽæ•°æ®åœ¨è¯»å–çš„æ—¶å€™éƒ½æ˜¯ JObject æ ¼å¼ï¼Œå¹¶ä¸”åœ¨éåŽ†èµ‹å€¼çš„æ—¶å€™éƒ½æ˜¯ JProperty æ ¼å¼ï¼Œå­˜å…¥ ExpandoObject çš„è¯ä¼šå¤±åŽ»æ•°æ®ç±»åž‹ï¼Œå› æ­¤æˆ‘ä»¬æ ¹æ®æ•°æ®çš„ JTokenType æ‰‹åŠ¨è½¬æ¢ä¸ºå¯¹åº”çš„ç±»åž‹ã€‚ è¯»å–æ•°æ®è¿˜å­˜åœ¨ä¸€ç§æƒ…å†µï¼šå·²ç»è¯»å–è¿‡ä¸€æ¬¡æ•°æ®ã€‚ è¿™æ—¶å€™æˆ‘ä»¬å°±è¦å¼¹çª—æç¤ºç”¨æˆ·æ˜¯å¦é‡æ–°æ‰“å¼€ï¼Œç¡®å®šå°±æ¸…ç©ºå½“å‰å†…å®¹å¹¶æ‰“å¼€æ–°çš„å†…å®¹ï¼Œå–æ¶ˆå°±æ— äº‹å‘ç”Ÿã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081private void Open()&#123; bool isOpen = GetOpen(); if (isOpen) &#123; bool res = EditorUtility.DisplayDialog (&quot;æ‰“å¼€æ–°æ–‡ä»¶&quot;, &quot;æ˜¯å¦æ‰“å¼€ä¸€ä¸ªæ–°çš„æ–‡ä»¶ï¼Œå½“å‰å†…å®¹æœªä¿å­˜çš„éƒ¨åˆ†ä¼šæ¶ˆå¤±ã€‚&quot;, &quot;ç¡®å®š&quot;, &quot;å–æ¶ˆ&quot;); if (res) &#123; ClearGraph(); &#125; else &#123; return; &#125; &#125; string filePath = EditorUtility.OpenFilePanel (&quot;æ‰“å¼€ ScriptableObject&quot;, &quot;Assets/Json&quot;, &quot;json&quot;); if (filePath != &quot;&quot;) &#123; string jsonData = &quot;&quot;; StreamReader sr = File.OpenText(filePath); while (sr.ReadLine() is &#123; &#125; nextLine) &#123; jsonData += nextLine; &#125; sr.Close(); List&lt;SaveJson&gt; json = JsonConvert.DeserializeObject&lt;List&lt;SaveJson&gt;&gt;(jsonData); List&lt;GDataNode&gt; list = new List&lt;GDataNode&gt;(); foreach (var data in json) &#123; list.Add(ToGDataNode(data)); &#125; SetFilePath(filePath); OpenData(list); &#125;&#125;/// &lt;summary&gt;/// è½¬æ¢ä¸ºèŠ‚ç‚¹æ•°æ®/// &lt;/summary&gt;/// &lt;param name=&quot;json&quot;&gt;&lt;/param&gt;/// &lt;returns&gt;&lt;/returns&gt;public GDataNode ToGDataNode(SaveJson json)&#123; GDataNode data = new GDataNode(); data.SetNodeType(json.type); dynamic obj = new ExpandoObject(); foreach (var res in (json.data as JObject).Properties()) &#123; JTokenType jType = res.Value.Type; switch (jType) &#123; case JTokenType.String: ((IDictionary&lt;string, object&gt;)obj)[res.Name] = res.Value.Value&lt;string&gt;(); break; case JTokenType.Float: ((IDictionary&lt;string, object&gt;)obj)[res.Name] = res.Value.Value&lt;float&gt;(); break; case JTokenType.Boolean: ((IDictionary&lt;string, object&gt;)obj)[res.Name] = res.Value.Value&lt;bool&gt;(); break; &#125; &#125; data.SetData(obj); foreach (var child in json.children) &#123; data.AddChild(ToGDataNode(child)); &#125; return data;&#125; å·¥å…·æ å·¥å…·æ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Unity æä¾›çš„ Toolbar å’Œ ToolbarButton æ¥åˆ›å»ºã€‚ 1234567891011121314protected virtual void SetupToolbar()&#123; var toolbar = new Toolbar(); var openBtn = new ToolbarButton &#123;text = &quot;æ‰“å¼€&quot;&#125;; openBtn.clicked += Open; var saveBtn = new ToolbarButton &#123;text = &quot;ä¿å­˜&quot;&#125;; saveBtn.clicked += Save; var closeBtn = new ToolbarButton &#123;text = &quot;å…³é—­&quot;&#125;; closeBtn.clicked += Close; toolbar.Add(openBtn); toolbar.Add(saveBtn); toolbar.Add(closeBtn); Add(toolbar);&#125; å¤šçº§æœç´¢èœå•å¤šçº§æœç´¢èœå•ç±»ç»§æ‰¿è‡ª ScriptableObject å’Œ ISearchWindowProviderã€‚ æœ¬ç±»å®šä¹‰ä¸€ä¸ªèœå•æ•°ç»„ entries ï¼Œå¹¶ä¸”é»˜è®¤ä¼ å…¥ä¸€ä¸ªèœå•ç»„ï¼Œä¹Ÿå°±æ˜¯ä¸€æ‰“å¼€æ˜¾ç¤ºçš„ç•Œé¢ã€‚ 1234public List&lt;SearchTreeEntry&gt; entries = new List&lt;SearchTreeEntry&gt;()&#123; new SearchTreeGroupEntry (new GUIContent (&quot;åˆ›å»ºèŠ‚ç‚¹&quot;))&#125;; ç„¶åŽæˆ‘ä»¬åœ¨æž„é€ å‡½æ•°ä¸­åˆå§‹åŒ–èœå•çš„é…ç½®æ–‡ä»¶ï¼ŒåŒæ ·ä¹Ÿæ˜¯é€šè¿‡ Newtonsoft.Json å®žçŽ°ã€‚ 12345private void InitJson()&#123; string json = EditorGUIUtility.Load(&quot;Assets/Editor/GraphViewExtension/Graph/Menu.json&quot;).ToString(); _menu = JArray.Parse(json);&#125; æœ€åŽæˆ‘ä»¬æ ¹æ®ç»“æž„åˆ›å»ºèœå•ï¼Œå…¶ä¸­ level ä»£è¡¨å±‚çº§ï¼Œé«˜å±‚çº§çš„ level è¢«ä½Žå±‚çº§çš„ level åµŒå¥—ã€‚ 123456789101112131415161718192021private void CreateMenu(JToken obj, int level = 1)&#123; string menuName = obj[&quot;name&quot;].ToString(); string menuType = &quot;GraphViewExtension.&quot; + obj[&quot;type&quot;]; JToken children = obj[&quot;child&quot;]; bool isChild = children?.Count() &gt; 0; if (isChild) &#123; entries.Add(new SearchTreeGroupEntry(new GUIContent(menuName)) &#123; level = level &#125;); foreach (var child in children) &#123; CreateMenu(child, level + 1); &#125; &#125; else &#123; entries.Add(new SearchTreeEntry(new GUIContent(menuName)) &#123; level = level, userData = Type.GetType(menuType) &#125;); &#125;&#125; æ•´ä½“ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384using System;using System.Collections.Generic;using System.Linq;using Unity.Plastic.Newtonsoft.Json;using Unity.Plastic.Newtonsoft.Json.Linq;using UnityEditor;using UnityEditor.Experimental.GraphView;using UnityEngine;namespace GraphViewExtension&#123; public class GSearchWindow: ScriptableObject,ISearchWindowProvider &#123; public delegate bool SelectHandle(SearchTreeEntry searchTreeEntry, SearchWindowContext context); public SelectHandle onSelectEntryHandler; private bool _inited; private JArray _menu; public List&lt;SearchTreeEntry&gt; entries = new List&lt;SearchTreeEntry&gt;() &#123; new SearchTreeGroupEntry (new GUIContent (&quot;åˆ›å»ºèŠ‚ç‚¹&quot;)) &#125;; private void BuildTree() &#123; InitJson(); foreach (var token in _menu) &#123; CreateMenu(token); &#125; _inited = true; &#125; private void InitJson() &#123; string json = EditorGUIUtility.Load(&quot;Assets/Editor/GraphViewExtension/Graph/Menu.json&quot;).ToString(); _menu = JArray.Parse(json); &#125; private void CreateMenu(JToken obj,int level = 1) &#123; string menuName = obj[&quot;name&quot;].ToString(); string menuType = &quot;GraphViewExtension.&quot; + obj[&quot;type&quot;]; JToken children = obj[&quot;child&quot;]; bool isChild = children?.Count() &gt; 0; if (isChild) &#123; entries.Add(new SearchTreeGroupEntry(new GUIContent(menuName))&#123;level = level&#125;); foreach (var child in children) &#123; CreateMenu(child, level + 1); &#125; &#125; else &#123; entries.Add(new SearchTreeEntry(new GUIContent(menuName))&#123;level = level,userData = Type.GetType(menuType)&#125;); &#125; &#125; public List&lt;SearchTreeEntry&gt; CreateSearchTree(SearchWindowContext context) &#123; if (!_inited) &#123; BuildTree(); &#125; return entries; &#125; public bool OnSelectEntry(SearchTreeEntry searchTreeEntry, SearchWindowContext context) &#123; if (onSelectEntryHandler == null) return false; return onSelectEntryHandler(searchTreeEntry, context); &#125; &#125;&#125; é‡åˆ°çš„é—®é¢˜æè¾¹é—®é¢˜style çš„æè¾¹æ˜¯è¾¹çº¿å®½åº¦ï¼Œå› æ­¤åœ¨å¤§å°ä¸å˜çš„æƒ…å†µä¸‹ä¼šå½±å“åŽŸæ¥å†…å®¹çš„å¤§å°ï¼Œæ‰€ä»¥æè¾¹åŽå¯¹åŽŸå¤§å°å’Œä½ç½®éƒ½åšäº†ä¿®æ­£ã€‚ è¾“å…¥æ¡†æ–‡å­—æ ·å¼ä¿®æ”¹è¾“å…¥æ¡† TextField æœ¬èº«æ˜¯ç”±ä¸¤ä¸ªå…ƒç´ ç»„æˆï¼Œä¸€ä¸ªæ˜¯ Label , å¦ä¸€ä¸ªæ˜¯ TextInput ã€‚ å› æ­¤ä¿®æ”¹è¾“å…¥æ¡†æ ·å¼å°±ä¸èƒ½åœ¨ TextField ç›´æŽ¥ä¿®æ”¹ã€‚ å­—ä½“çš„é¢œè‰²å¯ä»¥åœ¨ TextInput ä¿®æ”¹ï¼Œä½†æ˜¯å­—ä½“å¤§å°å°±è¦åœ¨ä¸‹ä¸€å±‚çš„ TextElement ä¿®æ”¹ã€‚ å¦‚æžœå…è®¸å¤šè¡Œæ˜¾ç¤ºçš„è¯ï¼ŒTextInput ä¸‹é¢ä¼šå¤šä¸€å±‚ VisualElement ï¼Œå› æ­¤ä¸ºäº†æ­£ç¡®èŽ·å–ä¿®æ”¹çš„å¯¹è±¡ï¼Œå‰é¢è¦å¤šèŽ·å–ä¸€å±‚ UI å…ƒç´ ã€‚ å³ï¼šå•è¡Œè¾“å…¥æ¡†å…±ä¸‰å±‚åµŒå¥—ï¼Œå¤šè¡Œè¾“å…¥æ¡†å…±å››å±‚åµŒå¥—ã€‚å¤šè¡Œæ¯”å•è¡Œå¤šçš„ä¸€å±‚åµŒå¥—åœ¨ TextInput å’Œ TextElement ä¹‹é—´ã€‚ ç‚¹å‡»äº‹ä»¶çš„å…ƒç´ ClickEvent è¿”å›žçš„ target ä¸æ˜¯çœŸæ­£ç‚¹å‡»åˆ°çš„å¯¹è±¡ã€‚ å› æ­¤æœ¬é¡¹ç›®ä½¿ç”¨ panel.Pick (Vector2) æ¥èŽ·å–ç‚¹å‡»çš„ç›®æ ‡å¯¹è±¡ã€‚ GraphView çš„é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶GraphView æ— æ³•ç›‘å¬ MouseDownEvent çš„é¼ æ ‡å·¦é”®äº‹ä»¶ï¼Œå› æ­¤æœ¬é¡¹ç›®ä½¿ç”¨ PointerDownEvent æ¥ç›‘å¬æŒ‡é’ˆäº‹ä»¶ã€‚ æ•°æ®ååºåˆ—åŒ–ååºåˆ—åŒ–ä¸€å¼€å§‹æ²¡æœ‰å•ç‹¬åšç±»åž‹å¤„ç†ï¼Œç»“æžœè¿”å›žçš„éƒ½æ˜¯ JToken æ•°æ®ï¼Œåœ¨ä½¿ç”¨æ•°æ®çš„æ—¶å€™è¿˜éœ€è¦æ‰‹åŠ¨åšè½¬æ¢ã€‚åŽé¢åœ¨ååºåˆ—åŒ–çš„æ—¶å€™ç›´æŽ¥å¤„ç†äº†æ•°æ®ç±»åž‹ã€‚ ä»£ç AttributeNodeGraphæ•°æ®ç±» GraphNode GraphNode12345678910111213141516171819202122232425262728using System;namespace GraphViewExtension&#123; [AttributeUsage(AttributeTargets.Field)] public class GraphNode: Attribute &#123; private NodeTypeEnum _type; private string[] _extra; public GraphNode(NodeTypeEnum type,params string[] extra) &#123; _type = type; _extra = extra; &#125; public NodeTypeEnum Type() &#123; return _type; &#125; public string[] GetExtra() &#123; return _extra; &#125; &#125;&#125; GName 1234567891011121314151617181920using System;namespace GraphViewExtension&#123; [AttributeUsage(AttributeTargets.Field)] public class GName: Attribute &#123; private string _name; public GName(string name) &#123; _name = name; &#125; public string GetName() &#123; return _name; &#125; &#125;&#125; GColor GColor123456789101112131415161718192021using System;using UnityEngine;namespace GraphViewExtension&#123; [AttributeUsage(AttributeTargets.Field)] public class GColor: Attribute &#123; private Color color; public GColor(float r,float g,float b,float a = 1) &#123; color = new Color(r, g, b, a); &#125; public Color GetColor() &#123; return color; &#125; &#125;&#125; GWidth GWidth123456789101112131415161718192021using System;using UnityEngine.UIElements;namespace GraphViewExtension&#123; [AttributeUsage(AttributeTargets.Field)] public class GWidth: Attribute &#123; private Length _length; public GWidth(float width,LengthUnit type) &#123; _length = new Length(width,type); &#125; public Length GetLength() &#123; return _length; &#125; &#125;&#125; NodeTypeEnum NodeTypeEnum12345678910111213141516namespace GraphViewExtension&#123; public enum NodeTypeEnum &#123; Label, Input, Note, Enum, Slide, Toggle, Radio, Box, Color, Texture &#125;&#125; RootNode RootNode123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578579580581582583584585586587588589590591592593594595596597598599600601602603604605606607608609610611612613614615616617618619620621622623624625626627628629630631632633634635636637638639640641642643644645646647648649650651652653654655656657658659660661662663664665666667668669670671672673674675676677678679680681682683684685686687688689690691692693694695696697698699700701702703704705706707708709710711712713714715716717718719720721722723724725726727728729730731732733734735736737738739740741742743744745746747748749750751752753754755756757758759760761762763764765766767768769770771772773774775776777778779780781782783784785786787788789790791792793794795796797798799800801802803804805806807808809810811812813814815816817818819820821822823824825826827828829830831832833834835836837838839840841842843844845846847848849850851852853854855856857858859860861862863864865866867868869870871872873874875876877878879880881882883884885886887888889890891892893894895896897898899900901902903904905906907908909910911912913914915916917918919920using System;using System.Dynamic;using System.Linq;using System.Reflection;using UnityEditor;using UnityEditor.Experimental.GraphView;using UnityEngine;using UnityEngine.UIElements;namespace GraphViewExtension&#123; public delegate void SetFieldDelegate(object target, object value); public class RootNode : Node &#123; /// &lt;summary&gt; /// æ‰€å±žçš„ GraphView /// &lt;/summary&gt; private GGraph _graph; Port _inputPort; Port _outputPort; /// &lt;summary&gt; /// åå°„èŒƒå›´æ ‡è®° /// &lt;/summary&gt; private readonly BindingFlags _flag = BindingFlags.Public | BindingFlags.NonPublic | BindingFlags.Static | BindingFlags.Instance | BindingFlags.DeclaredOnly; /// &lt;summary&gt; /// å”¯ä¸€æ ‡è¯†ç¬¦ /// &lt;/summary&gt; public string guid; /// &lt;summary&gt; /// æ˜¯å¦å®Œæˆæ¸²æŸ“åˆå§‹åŒ– /// &lt;/summary&gt; private bool _inited = false; /// &lt;summary&gt; /// å½“å‰ç±»ç±»åž‹ /// &lt;/summary&gt; private Type _type; /// &lt;summary&gt; /// é»˜è®¤å°ºå¯¸ /// &lt;/summary&gt; private Vector2 _defSize; /// &lt;summary&gt; /// å½“å‰å°ºå¯¸ /// &lt;/summary&gt; private Vector2 _curSize; /// &lt;summary&gt; /// é»˜è®¤ä½ç½® /// &lt;/summary&gt; private Vector2 _defPos; /// &lt;summary&gt; /// é»˜è®¤é«˜åº¦ /// &lt;/summary&gt; private float _defHeight; /// &lt;summary&gt; /// é¼ æ ‡æŒ‰ä¸‹æ—¶åæ ‡ /// &lt;/summary&gt; private Vector2 _mouseOffset; /// &lt;summary&gt; /// æ˜¯å¦æ­£åœ¨è°ƒæ•´å¤§å° /// &lt;/summary&gt; private bool _isResizing = false; /// &lt;summary&gt; /// æ˜¯å¦å·²æè¾¹ /// &lt;/summary&gt; private bool _isBordered = false; /// &lt;summary&gt; /// ä¹‹å‰çš„çŠ¶æ€æ˜¯å¦æè¾¹ /// &lt;/summary&gt; private bool _lastBordered = false; /// &lt;summary&gt; /// é»˜è®¤å­—ä½“å°ºå¯¸ /// &lt;/summary&gt; private int _fontSize = 16; /// &lt;summary&gt; /// æè¾¹è¡¥æ­£ /// &lt;/summary&gt; private float _borderOffset = 0; /// &lt;summary&gt; /// æ˜¯å¦æ‰§è¡Œåˆ°å½“å‰èŠ‚ç‚¹ /// &lt;/summary&gt; private bool _isRun = false; /// &lt;summary&gt; /// æ˜¯å¦é€‰ä¸­å½“å‰èŠ‚ç‚¹ /// &lt;/summary&gt; private bool _isSelected = false; //----- æè¾¹é¢œè‰² ------ start protected Color _selectColor = Color.red; protected Color _parentColor = Color.green; protected Color _runColor = Color.green; protected Color _passColor = Color.yellow; //----- æè¾¹é¢œè‰² ------ end /// &lt;summary&gt; /// èŠ‚ç‚¹æ•°æ® /// &lt;/summary&gt; protected dynamic _data = new ExpandoObject(); /// &lt;summary&gt; /// æ˜¯å¦è®¾ç½®äº†æ•°æ® /// &lt;/summary&gt; protected bool _isSet = false; /// &lt;summary&gt; /// æ•°æ®èŠ‚ç‚¹ /// &lt;/summary&gt; GDataNode _dataNode = new GDataNode(); public RootNode() &#123; title = &quot;é»˜è®¤èŠ‚ç‚¹&quot;; _type = GetType(); // ç”Ÿæˆå”¯ä¸€æ ‡è¯† guid = GUID.Generate().ToString(); // æ·»åŠ è¾“å…¥ç«¯å£ _inputPort = InstantiatePort(Orientation.Horizontal, Direction.Input, Port.Capacity.Multi, typeof(Node)); _inputPort.portName = &quot;Parent&quot;; inputContainer.Add(_inputPort); // æ·»åŠ è¾“å‡ºç«¯å£ _outputPort = InstantiatePort(Orientation.Horizontal, Direction.Output, Port.Capacity.Multi, typeof(Node)); _outputPort.portName = &quot;Child&quot;; outputContainer.Add(_outputPort); // æ³¨å†Œé¼ æ ‡æŒ‰ä¸‹ç›‘å¬ RegisterCallback&lt;MouseDownEvent&gt;(ResizeStart); // æ³¨å†Œç•Œé¢æ”¹å˜ç›‘å¬ RegisterCallback&lt;GeometryChangedEvent&gt;(OnEnable); &#125; /// &lt;summary&gt; /// ç•Œé¢æ”¹å˜å›žè°ƒ /// &lt;/summary&gt; /// &lt;param name=&quot;evt&quot;&gt;&lt;/param&gt; private void OnEnable(GeometryChangedEvent evt) &#123; Debug.Log (&quot;åˆ›å»ºå®Œæˆï¼Œå¼€å§‹æ¸²æŸ“&quot; + layout.size); // ä¿å­˜é»˜è®¤é«˜åº¦ _defHeight = titleContainer.layout.height + _outputPort.layout.height; // ä¿å­˜é»˜è®¤ä½ç½® _defPos = layout.position; // å¦‚æžœè®¾ç½®äº†æ•°æ®ï¼ˆå³é€šè¿‡æ‰“å¼€æ–‡ä»¶åˆ›å»ºçš„èŠ‚ç‚¹ï¼‰ï¼Œåˆ™æŠŠæ•°æ®å¡«å……åˆ° UI if (_isSet) &#123; ResetData(); &#125; // åˆå§‹åŒ– UI Init(); CustomUI(); // å»¶è¿Ÿæ›´æ–°èŠ‚ç‚¹å¤§å° schedule.Execute(() =&gt; &#123; UpdateNodeSize(); _inited = true; &#125;).StartingIn(1); // åˆ·æ–° ä¸ç„¶ä¼šæœ‰æ˜¾ç¤º BUG RefreshExpandedState(); RefreshPorts(); // æ³¨é”€ç•Œé¢æ”¹å˜ç›‘å¬ï¼Œä½¿è¯¥æ–¹æ³•åªæ‰§è¡Œä¸€æ¬¡ UnregisterCallback&lt;GeometryChangedEvent&gt;(OnEnable); &#125; /// &lt;summary&gt; /// è®¾ç½®æ•°æ® /// &lt;/summary&gt; /// &lt;param name=&quot;data&quot;&gt;&lt;/param&gt; public void SetData(ExpandoObject data) &#123; _data = data; _isSet = true; &#125; /// &lt;summary&gt; /// è®¾ç½®å°ºå¯¸ï¼Œè¯¥æ–¹æ³•ä¼šä¿å­˜é»˜è®¤å°ºå¯¸ /// &lt;/summary&gt; /// &lt;param name=&quot;size&quot;&gt;&lt;/param&gt; public void SetSize(Vector2 size) &#123; style.width = size.x; style.height = size.y; _defSize = size; &#125; /// &lt;summary&gt; /// åœ¨ GraphView æ³¨å†Œé¼ æ ‡ç§»åŠ¨å’ŒæŠ¬èµ·äº‹ä»¶ /// ç”¨äºŽèŠ‚ç‚¹ç•Œé¢å°ºå¯¸çš„ä¿®æ”¹ /// åœ¨ GraphView æ˜¯ä¸ºäº†èƒ½å¤Ÿåœ¨èŠ‚ç‚¹å¤–å“åº”äº‹ä»¶ /// &lt;/summary&gt; /// &lt;param name=&quot;graph&quot;&gt;&lt;/param&gt; public void RegistResize(GGraph graph) &#123; _graph = graph; _graph.RegisterCallback&lt;MouseMoveEvent&gt;(ResizeMove); _graph.RegisterCallback&lt;MouseUpEvent&gt;(ResizeEnd); &#125; /// &lt;summary&gt; /// èŽ·å–è¾“å…¥ç«¯å£ /// &lt;/summary&gt; /// &lt;returns&gt;&lt;/returns&gt; public Port GetInput() &#123; return _inputPort; &#125; /// &lt;summary&gt; /// èŽ·å–è¾“å‡ºç«¯å£ /// &lt;/summary&gt; /// &lt;returns&gt;&lt;/returns&gt; public Port GetOutput() &#123; return _outputPort; &#125; /// &lt;summary&gt; /// è®¾ç½®è¿è¡ŒçŠ¶æ€ï¼Œè¯·åœ¨æ‰§è¡Œåˆ°è¯¥èŠ‚ç‚¹æ—¶è°ƒç”¨ /// &lt;/summary&gt; /// &lt;param name=&quot;run&quot;&gt;&lt;/param&gt; public void SetRun(bool run) &#123; if (run) &#123; _isRun = true; SetBorder(_runColor, 5); &#125; else &#123; if (_isRun) &#123; SetBorder(_passColor, 5); &#125; else &#123; SetBorder(Color.white, 0); &#125; _isRun = false; &#125; &#125; /// &lt;summary&gt; /// æ¸…é™¤æ‰€æœ‰è¿è¡ŒçŠ¶æ€ /// &lt;/summary&gt; public void ClearRunState() &#123; // æ‰§è¡Œä¸¤æ¬¡ç¡®ä¿å®Œå…¨æ¸…é™¤ SetRun(false); SetRun(false); // éåŽ†èŠ‚ç‚¹ var connections = _outputPort.connections; foreach (var edge in connections) &#123; RootNode node = edge.input.node as RootNode; node?.ClearRunState(); &#125; &#125; /// &lt;summary&gt; /// é€‰ä¸­èŠ‚ç‚¹æè¾¹ /// &lt;/summary&gt; /// &lt;param name=&quot;leaf&quot;&gt;&lt;/param&gt; public void Selected(RootNode leaf = null) &#123; if (leaf == null) &#123; SetBorder(_selectColor, 5); &#125; else &#123; SetBorder(_parentColor, 5); &#125; // éåŽ†èŠ‚ç‚¹ var connections = _inputPort.connections; foreach (var edge in connections) &#123; RootNode node = edge.output.node as RootNode; node?.Selected(node); &#125; &#125; /// &lt;summary&gt; /// å–æ¶ˆé€‰ä¸­èŠ‚ç‚¹æè¾¹ /// &lt;/summary&gt; public void UnSelected() &#123; SetBorder(_selectColor, 0); // éåŽ†èŠ‚ç‚¹ var connections = _inputPort.connections; foreach (var edge in connections) &#123; RootNode node = edge.output.node as RootNode; node?.UnSelected(); &#125; &#125; /// &lt;summary&gt; /// åˆ¤æ–­æ˜¯å¦æœ‰å‰ç½®èŠ‚ç‚¹ /// &lt;/summary&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool HasParent() &#123; return _inputPort.connections.Any(); &#125; /// &lt;summary&gt; /// ä¿å­˜æ•°æ® /// &lt;/summary&gt; /// &lt;returns&gt;&lt;/returns&gt; public GDataNode SaveData() &#123; // ä¿å­˜åŸºæœ¬æ•°æ® _data.guid = guid; _data.pos = _defPos.ToString(); _data.size = (_curSize.Equals(Vector2.zero) ? _defSize : _curSize).ToString(); _dataNode.SetNodeType(_type.FullName); // ä¿å­˜é¢å¤–æ•°æ®ï¼Œç”¨æˆ·è‡ªå®šä¹‰ SetData(); _dataNode.SetData(_data); // éåŽ†å­èŠ‚ç‚¹ var connections = _outputPort.connections; foreach (var edge in connections) &#123; RootNode node = edge.input.node as RootNode; _dataNode.AddChild(node?.SaveData()); &#125; return _dataNode; &#125; /// &lt;summary&gt; /// è®¾ç½®æè¾¹é¢œè‰²ï¼Œæœ€å¥½æ˜¯åœ¨æ‰€æœ‰åˆå§‹åŒ–å®ŒæˆåŽå†è°ƒç”¨ /// &lt;/summary&gt; /// &lt;param name=&quot;color&quot;&gt;&lt;/param&gt; private void SetBorder(Color color, float width) &#123; style.borderBottomWidth = width; style.borderBottomColor = color; style.borderLeftWidth = width; style.borderLeftColor = color; style.borderRightWidth = width; style.borderRightColor = color; style.borderTopWidth = width; style.borderTopColor = color; style.borderBottomLeftRadius = 10; style.borderBottomRightRadius = 10; style.borderTopLeftRadius = 10; style.borderTopRightRadius = 10; _borderOffset = width * 2; if (_inited) &#123; UpdateBorderSize(); &#125; &#125; /// &lt;summary&gt; /// ç§»é™¤è¿žçº¿ /// &lt;/summary&gt; public void RemoveEdges() &#123; foreach (var edge in _outputPort.connections) &#123; _graph.RemoveElement(edge); &#125; &#125; /// &lt;summary&gt; /// èŠ‚ç‚¹å°ºå¯¸è°ƒèŠ‚é¼ æ ‡æŒ‰ä¸‹å›žè°ƒ /// &lt;/summary&gt; /// &lt;param name=&quot;evt&quot;&gt;&lt;/param&gt; private void ResizeStart(MouseDownEvent evt) &#123; if (evt.button == 0) &#123; // åˆ¤æ–­æ”¹å¤§å° if (IsResizeArea(evt.localMousePosition)) &#123; _mouseOffset = evt.mousePosition - layout.size; _isResizing = true; evt.StopPropagation(); &#125; &#125; &#125; /// &lt;summary&gt; /// èŠ‚ç‚¹å°ºå¯¸è°ƒèŠ‚é¼ æ ‡ç§»åŠ¨å›žè°ƒ /// &lt;/summary&gt; /// &lt;param name=&quot;evt&quot;&gt;&lt;/param&gt; private void ResizeMove(MouseMoveEvent evt) &#123; if (_isResizing) &#123; Vector2 newSize = evt.mousePosition - _mouseOffset; newSize = Vector2.Max(_defSize, newSize); // æ›´æ–°èŠ‚ç‚¹çš„å¤§å° UpdateSize(newSize); evt.StopPropagation(); &#125; &#125; /// &lt;summary&gt; /// èŠ‚ç‚¹å°ºå¯¸è°ƒèŠ‚é¼ æ ‡æŠ¬èµ·å›žè°ƒ /// &lt;/summary&gt; /// &lt;param name=&quot;evt&quot;&gt;&lt;/param&gt; private void ResizeEnd(MouseUpEvent evt) &#123; if (_isResizing) &#123; Debug.Log(layout.size); _isResizing = false; evt.StopPropagation(); &#125; _defPos = layout.position + new Vector2(_borderOffset * 0.5f, _borderOffset * 0.5f); &#125; /// &lt;summary&gt; /// æ˜¯å¦åœ¨èŠ‚ç‚¹å³ä¸‹è§’åŒºåŸŸ /// &lt;/summary&gt; /// &lt;param name=&quot;position&quot;&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; private bool IsResizeArea(Vector2 position) &#123; // æ ¹æ®éœ€è¦å®šä¹‰ resizer åŒºåŸŸï¼Œè¿™é‡Œä»¥å³ä¸‹è§’ä¸ºä¾‹ return position.x &gt;= layout.width - 10f - _borderOffset &amp;&amp; position.y &gt;= layout.height - 10f - _borderOffset; &#125; /// &lt;summary&gt; /// åˆå§‹åŒ– UI /// &lt;/summary&gt; private void Init() &#123; InitConfig(); // æ·»åŠ  GUID Label lbGuid = new Label(guid); lbGuid.style.position = Position.Absolute; lbGuid.style.top = -20; lbGuid.style.alignSelf = Align.Center; Add(lbGuid); // èŽ·å¾—ç±»åž‹ _type = GetType(); FieldInfo[] fields = _type.GetFields(_flag); // è®¾ç½®æ ‡é¢˜é¢œè‰² Label lbTitle = mainContainer.Q&lt;Label&gt;(&quot;title-label&quot;, (string)null); lbTitle.style.color = Color.black; lbTitle.style.fontSize = 18; lbTitle.style.unityFontStyleAndWeight = FontStyle.Bold; // å›ºå®š titleContainer å¤§å° titleContainer.style.minHeight = 25; titleContainer.style.maxHeight = 25; //mainContainer ç€è‰² mainContainer.style.backgroundColor = new Color(0.5f, 0.5f, 0.5f, 1f); mainContainer.style.color = Color.black; mainContainer.style.flexGrow = 1; //extensionContainer è‡ªåŠ¨é«˜åº¦ extensionContainer.style.height = StyleKeyword.Auto; // extensionContainer.style.backgroundColor = new Color(0.55f, 1.00f, 0.78f, 0.8f); //ui box åˆ†å‰²ã€‚æ²¡æœ‰ box æ ‡ç­¾çš„æƒ…å†µä¸‹éƒ½åœ¨é»˜è®¤çš„ç¬¬ä¸€ä¸ª box ä¸­æ·»åŠ  ui int boxCount = -1; var box = new VisualElement(); extensionContainer.Add(box); foreach (var field in fields) &#123; GraphNode attr = field.GetCustomAttribute&lt;GraphNode&gt;(); if (attr != null) &#123; // è¾…åŠ©åç§° GName gName = field.GetCustomAttribute&lt;GName&gt;(); string fieldName = field.Name.Replace(&quot;_&quot;, &quot;&quot;); string subName = gName != null ? gName.GetName() : fieldName.Substring(0, 1).ToUpper() + fieldName.Substring(1); // å®¹å™¨å®½åº¦ GWidth gWidth = field.GetCustomAttribute&lt;GWidth&gt;(); Length len = gWidth != null ? gWidth.GetLength() : new Length(96, LengthUnit.Percent); // åˆ¤æ–­æ˜¯å¦éœ€è¦å¢žåŠ  ui box if (boxCount == 0) &#123; box = new VisualElement(); extensionContainer.Add(box); &#125; if (boxCount &gt; -1) &#123; boxCount--; &#125; object value = field.GetValue(this); // æ·»åŠ å½“å‰ UI ç±»åž‹çš„çˆ¶å®¹å™¨ VisualElement ele = new VisualElement(); ele.style.width = len; ele.style.marginTop = 8; ele.style.alignSelf = Align.Center; // è¾…åŠ©æ ‡ç­¾ Label foreLabel; // éžæ³¨é‡Š UI æƒ…å†µä¸‹ï¼ŒUI çˆ¶å®¹å™¨åº•éƒ¨æç™½è¾¹ if (attr.Type() != NodeTypeEnum.Note) &#123; ele.style.borderBottomColor = Color.white; ele.style.borderBottomWidth = 2; ele.style.paddingBottom = 3; &#125; // è®¾ç½®å€¼çš„å§”æ‰˜å‡½æ•° SetFieldDelegate setValue = (SetFieldDelegate)Delegate.CreateDelegate(typeof(SetFieldDelegate), field, &quot;SetValue&quot;, false); string[] extra = attr.GetExtra(); // åˆ›å»º UI switch (attr.Type()) &#123; case NodeTypeEnum.Label: Label label = new Label(); label.style.fontSize = _fontSize; label.text = value.ToString(); ele.Add(label); break; case NodeTypeEnum.Input: ele.style.flexDirection = FlexDirection.Row; foreLabel = new Label(); foreLabel.style.fontSize = _fontSize; foreLabel.text = subName; ele.Add(foreLabel); TextField text = new TextField(); text.style.flexGrow = 1; text.style.height = _fontSize * 1.2f; var fontChild = text.Children().FirstOrDefault().Children().FirstOrDefault(); fontChild.style.fontSize = _fontSize; text.RegisterValueChangedCallback(evt =&gt; &#123; setValue(this, evt.newValue); &#125;); ele.Add(text); break; case NodeTypeEnum.Note: // åˆ›å»ºæ³¨é‡ŠèƒŒæ™¯ ele.style.flexDirection = FlexDirection.Column; ele.style.alignItems = Align.Center; ele.style.justifyContent = Justify.Center; ele.style.backgroundColor = new Color(0.64f, 0.78f, 1f, 1f); ele.style.borderBottomLeftRadius = 5; ele.style.borderBottomRightRadius = 5; ele.style.borderTopLeftRadius = 5; ele.style.borderTopRightRadius = 5; // å›ºå®šæ³¨é‡Šå’Œå¯ä¿®æ”¹æ³¨é‡Šçš„æƒ…å†µ if (extra.Length &gt; 0 &amp;&amp; extra[0] == &quot;Custom&quot;) &#123; TextField note = new TextField(); note.value = value.ToString(); note.style.width = ele.style.width; note.style.height = StyleKeyword.Auto; note.multiline = true; note.style.whiteSpace = WhiteSpace.Normal; note.style.height = StyleKeyword.Auto; var child = note.Children().FirstOrDefault(); child.style.backgroundColor = Color.clear; child.style.borderBottomColor = Color.clear; child.style.borderTopColor = Color.clear; child.style.borderLeftColor = Color.clear; child.style.borderRightColor = Color.clear; child.style.borderBottomWidth = 0; child.style.borderTopWidth = 0; child.style.borderLeftWidth = 0; child.style.borderRightWidth = 0; child.style.color = Color.black; child.style.unityTextAlign = TextAnchor.MiddleCenter; fontChild = child.Children().FirstOrDefault().Children().FirstOrDefault(); fontChild.style.fontSize = _fontSize; note.RegisterValueChangedCallback((evt) =&gt; &#123; setValue(this, evt.newValue); &#125;); note.RegisterCallback&lt;FocusOutEvent&gt;(evt =&gt; &#123; UpdateNodeSize(); &#125;); ele.Add(note); &#125; else &#123; Label note = new Label(); note.style.fontSize = _fontSize; note.style.width = StyleKeyword.Auto; note.style.height = StyleKeyword.Auto; note.text = value.ToString(); note.style.whiteSpace = WhiteSpace.Normal; ele.Add(note); &#125; break; case NodeTypeEnum.Enum: ele.style.flexDirection = FlexDirection.Row; foreLabel = new Label(); foreLabel.style.fontSize = _fontSize; foreLabel.text = subName; ele.Add(foreLabel); EnumField enumField = new EnumField(value as Enum); enumField.style.flexGrow = 1; enumField.RegisterValueChangedCallback(evt =&gt; setValue(this, evt.newValue)); ele.Add(enumField); break; case NodeTypeEnum.Slide: ele.style.flexDirection = FlexDirection.Row; foreLabel = new Label(); foreLabel.style.fontSize = _fontSize; foreLabel.text = subName; ele.Add(foreLabel); bool isInt = extra[0] == &quot;Int&quot;; Label num = new Label(); num.style.fontSize = _fontSize; num.style.width = _fontSize * 3; num.style.unityTextAlign = TextAnchor.MiddleRight; if (isInt) &#123; SliderInt slider = new SliderInt(int.Parse(extra[1]), int.Parse(extra[2])); num.text = extra[1]; slider.value = 0; slider.style.flexGrow = 1; slider.RegisterValueChangedCallback(evt =&gt; &#123; setValue(this, evt.newValue); num.text = evt.newValue.ToString(); &#125;); ele.Add(slider); &#125; else &#123; Slider slider = new Slider(float.Parse(extra[0]), float.Parse(extra[1])); num.text = extra[0]; slider.value = 0; slider.style.flexGrow = 1; slider.RegisterValueChangedCallback(evt =&gt; &#123; setValue(this, evt.newValue); num.text = evt.newValue.ToString(); &#125;); ele.Add(slider); &#125; ele.Add(num); break; case NodeTypeEnum.Radio: RadioButtonGroup radioButtonGroup = new RadioButtonGroup(); radioButtonGroup.value = 0; ele.Add(radioButtonGroup); foreach (var selection in extra) &#123; RadioButton radio = new RadioButton(); radio.Children().FirstOrDefault().style.flexGrow = 0; Label lbRadio = new Label(); lbRadio.style.fontSize = _fontSize; lbRadio.text = selection; radio.Add(lbRadio); radioButtonGroup.Add(radio); &#125; radioButtonGroup.RegisterValueChangedCallback(evt =&gt; &#123; setValue(this, evt.newValue); &#125;); break; case NodeTypeEnum.Toggle: Toggle toggle = new Toggle(); toggle.style.width = StyleKeyword.Auto; toggle.Children().FirstOrDefault().style.flexGrow = 0; toggle.RegisterValueChangedCallback(evt =&gt; &#123; setValue(this, evt.newValue); &#125;); ele.Add(toggle); foreLabel = new Label(); foreLabel.style.fontSize = _fontSize; foreLabel.text = subName; toggle.Add(foreLabel); break; case NodeTypeEnum.Box: if (gName != null) &#123; foreLabel = new Label(); foreLabel.style.fontSize = _fontSize * 0.8f; foreLabel.text = subName; ele.Add(foreLabel); &#125; Color color = Color.yellow; GColor gColor = field.GetCustomAttribute&lt;GColor&gt;(); if (gColor != null) &#123; color = gColor.GetColor(); &#125; box = new VisualElement(); box.style.backgroundColor = color; box.style.marginTop = 8; box.style.width = new Length(96, LengthUnit.Percent); box.style.alignSelf = Align.Center; box.style.borderBottomLeftRadius = 5; box.style.borderBottomRightRadius = 5; box.style.borderTopLeftRadius = 5; box.style.borderTopRightRadius = 5; box.style.flexDirection = extra.Length &gt; 1 &amp;&amp; extra[1] == &quot;Column&quot; ? FlexDirection.Column : FlexDirection.Row; box.style.flexWrap = Wrap.Wrap; extensionContainer.Add(box); boxCount = int.Parse(extra[0]); break; &#125; box.Add(ele); &#125; &#125; &#125; /// &lt;summary&gt; /// åˆ·æ–°å°ºå¯¸ /// &lt;/summary&gt; /// &lt;param name=&quot;size&quot;&gt;&lt;/param&gt; public void UpdateSize(Vector2 size) &#123; style.width = size.x; style.height = size.y; if (_isBordered) &#123; _curSize = size - new Vector2(_borderOffset, _borderOffset); &#125; else &#123; _curSize = size; &#125; &#125; /// &lt;summary&gt; /// æ›´æ–°èŠ‚ç‚¹å°ºå¯¸ /// &lt;/summary&gt; private void UpdateNodeSize() &#123; // æœªæ‰‹åŠ¨è°ƒæ•´è¿‡å¤§å°æ‰è‡ªåŠ¨æ›´æ–° if (_curSize.Equals(Vector2.zero)) &#123; // è®¡ç®—å†…å®¹çš„æ€»é«˜åº¦ float contentHeight = _defHeight + extensionContainer.layout.height + 10; // è®¾ç½® Node çš„æ–°é«˜åº¦ SetSize(new Vector2(_defSize.x, contentHeight)); DrawBorder(); &#125; &#125; /// &lt;summary&gt; /// æ›´æ–°å¸¦æè¾¹çš„èŠ‚ç‚¹å°ºå¯¸ /// &lt;/summary&gt; private void UpdateBorderSize() &#123; if (_borderOffset == 0) &#123; _isBordered = false; DrawBorder(); &#125; else if (!_isBordered) &#123; _isBordered = true; DrawBorder(); &#125; &#125; /// &lt;summary&gt; /// æè¾¹ /// &lt;/summary&gt; private void DrawBorder() &#123; if (_isBordered) &#123; if (_curSize.Equals(Vector2.zero)) &#123; style.width = _defSize.x + _borderOffset; style.height = _defSize.y + _borderOffset; &#125; else &#123; style.width = _curSize.x + _borderOffset; style.height = _curSize.y + _borderOffset; &#125; _defPos = new Vector2(style.left.value.value, style.top.value.value); // å¦‚æžœæ²¡æè¿‡è¾¹ï¼Œåˆ™è°ƒæ•´èŠ‚ç‚¹åæ ‡ä½ç½®ä»¥é˜²æ­¢é”™ä½ if (_lastBordered != _isBordered) &#123; style.left = _defPos.x - _borderOffset * 0.5f; style.top = _defPos.y - _borderOffset * 0.5f; &#125; &#125; else &#123; if (_curSize.Equals(Vector2.zero)) &#123; style.width = _defSize.x; style.height = _defSize.y; &#125; else &#123; style.width = _curSize.x; style.height = _curSize.y; &#125; // è¿˜åŽŸèŠ‚ç‚¹é»˜è®¤ä½ç½® style.left = _defPos.x; style.top = _defPos.y; &#125; _lastBordered = _isBordered; &#125; /// &lt;summary&gt; /// åˆå§‹åŒ–é…ç½® /// &lt;/summary&gt; protected virtual void InitConfig() &#123; &#125; /// &lt;summary&gt; /// ä¿å­˜æ•°æ® /// &lt;/summary&gt; protected virtual void SetData() &#123; &#125; /// &lt;summary&gt; /// è¿˜åŽŸæ•°æ® /// &lt;/summary&gt; protected virtual void ResetData() &#123; &#125; /// &lt;summary&gt; /// è‡ªå®šä¹‰ UIï¼Œå¦‚æžœæœ‰å¤æ‚çš„éœ€æ±‚æ— æ³•é€šè¿‡ Attribute å®Œæˆï¼Œåˆ™å¯ä»¥åœ¨è¿™é‡Œæ‹“å±• /// &lt;/summary&gt; protected virtual void CustomUI() &#123; &#125; &#125;&#125; GSearchWindow GSearchWindow123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384using System;using System.Collections.Generic;using System.Linq;using Unity.Plastic.Newtonsoft.Json;using Unity.Plastic.Newtonsoft.Json.Linq;using UnityEditor;using UnityEditor.Experimental.GraphView;using UnityEngine;namespace GraphViewExtension&#123; public class GSearchWindow: ScriptableObject,ISearchWindowProvider &#123; public delegate bool SelectHandle(SearchTreeEntry searchTreeEntry, SearchWindowContext context); public SelectHandle onSelectEntryHandler; private bool _inited; private JArray _menu; public List&lt;SearchTreeEntry&gt; entries = new List&lt;SearchTreeEntry&gt;() &#123; new SearchTreeGroupEntry (new GUIContent (&quot;åˆ›å»ºèŠ‚ç‚¹&quot;)) &#125;; private void BuildTree() &#123; InitJson(); foreach (var token in _menu) &#123; CreateMenu(token); &#125; _inited = true; &#125; private void InitJson() &#123; string json = EditorGUIUtility.Load(&quot;Assets/Editor/GraphViewExtension/Graph/Menu.json&quot;).ToString(); _menu = JArray.Parse(json); &#125; private void CreateMenu(JToken obj,int level = 1) &#123; string menuName = obj[&quot;name&quot;].ToString(); string menuType = &quot;GraphViewExtension.&quot; + obj[&quot;type&quot;]; JToken children = obj[&quot;child&quot;]; bool isChild = children?.Count() &gt; 0; if (isChild) &#123; entries.Add(new SearchTreeGroupEntry(new GUIContent(menuName))&#123;level = level&#125;); foreach (var child in children) &#123; CreateMenu(child, level + 1); &#125; &#125; else &#123; entries.Add(new SearchTreeEntry(new GUIContent(menuName))&#123;level = level,userData = Type.GetType(menuType)&#125;); &#125; &#125; public List&lt;SearchTreeEntry&gt; CreateSearchTree(SearchWindowContext context) &#123; if (!_inited) &#123; BuildTree(); &#125; return entries; &#125; public bool OnSelectEntry(SearchTreeEntry searchTreeEntry, SearchWindowContext context) &#123; if (onSelectEntryHandler == null) return false; return onSelectEntryHandler(searchTreeEntry, context); &#125; &#125;&#125; GGraph GGraph123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558using System;using System.Collections.Generic;using System.Dynamic;using System.IO;using Unity.Plastic.Newtonsoft.Json;using Unity.Plastic.Newtonsoft.Json.Linq;using UnityEditor;using UnityEditor.Experimental.GraphView;using UnityEditor.UIElements;using UnityEngine;using UnityEngine.UIElements;namespace GraphViewExtension&#123; public class GGraph : GraphView &#123; /// &lt;summary&gt; /// æ‰€å±žç¼–è¾‘å™¨ /// &lt;/summary&gt; private EditorWindow _editorWindow; /// &lt;summary&gt; /// å³é”®åˆ›å»ºèŠ‚ç‚¹çš„å¯æœç´¢å¤šçº§èœå• /// &lt;/summary&gt; private GSearchWindow _seachWindow; /// &lt;summary&gt; /// é»˜è®¤èŠ‚ç‚¹å¤§å° /// &lt;/summary&gt; private Vector2 _defaultNodeSize = new Vector2(200, 102); /// &lt;summary&gt; /// å½“å‰ç‚¹å‡»èŠ‚ç‚¹ /// &lt;/summary&gt; private RootNode _clickNode; /// &lt;summary&gt; /// æ‰“å¼€çš„æ–‡ä»¶è·¯å¾„ /// &lt;/summary&gt; private string _filePath = &quot;&quot;; /// &lt;summary&gt; /// æ˜¯å¦æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ /// &lt;/summary&gt; private bool _isOpen = false; /// &lt;summary&gt; /// æ˜¯å¦åœ¨é€‰æ‹© /// &lt;/summary&gt; private bool _isSelect = false; /// &lt;summary&gt; /// é¼ æ ‡æ˜¯å¦æŒ‰ä¸‹ /// &lt;/summary&gt; private bool _isDown = false; /// &lt;summary&gt; /// é¼ æ ‡æ˜¯å¦ç§»åŠ¨äº† /// &lt;/summary&gt; private bool _isMoved = false; private Dictionary&lt;string, RootNode&gt; _allNodes = new Dictionary&lt;string, RootNode&gt;(); public GGraph(EditorWindow editorWindow, GSearchWindow provider) &#123; _editorWindow = editorWindow; _seachWindow = provider; // åœ¨å³é”®èœå•ä¸­æ·»åŠ èŠ‚ç‚¹ provider.onSelectEntryHandler = (searchTreeEntry, searchWindowContext) =&gt; &#123; var windowRoot = _editorWindow.rootVisualElement; var windowMousePosition = windowRoot.ChangeCoordinatesTo(windowRoot, searchWindowContext.screenMousePosition - _editorWindow.position.position); var graphMousePosition = contentViewContainer.WorldToLocal(windowMousePosition); var type = searchTreeEntry.userData as Type; CreateNode(type, graphMousePosition); return true; &#125;; // ç›‘å¬åˆ›å»ºèŠ‚ç‚¹ nodeCreationRequest += context =&gt; &#123; // æ‰“å¼€æœç´¢æ¡† SearchWindow.Open(new SearchWindowContext(context.screenMousePosition), provider); &#125;; // ç›‘å¬èŠ‚ç‚¹åˆ é™¤ graphViewChanged += evt =&gt; &#123; if (evt.elementsToRemove != null) &#123; foreach (var element in evt.elementsToRemove) &#123; if (element is RootNode node) &#123; _allNodes.Remove(node.guid); &#125; &#125; &#125; return evt; &#125;; // å°ºå¯¸å’Œçˆ¶æŽ§ä»¶ç›¸åŒ this.StretchToParentSize(); // æ»šè½®ç¼©æ”¾ SetupZoom(ContentZoomer.DefaultMinScale, ContentZoomer.DefaultMaxScale); // çª—å£å†…å®¹æ‹–åŠ¨ this.AddManipulator(new ContentDragger()); // é€‰ä¸­ Node ç§»åŠ¨åŠŸèƒ½ this.AddManipulator(new SelectionDragger()); // å¤šä¸ª node æ¡†é€‰åŠŸèƒ½ this.AddManipulator(new RectangleSelector()); // åŠ è½½æ ·å¼è¡¨å’Œç½‘æ ¼ var styleSheet = EditorGUIUtility.Load(&quot;Assets/Editor/GraphViewExtension/Graph/GridBackground.uss&quot;) as StyleSheet; styleSheets.Add(styleSheet); var grid = new GridBackground(); Insert(0, grid); grid.StretchToParentSize(); SetupToolbar(); RegisterCallback&lt;PointerDownEvent&gt;(evt =&gt; &#123; if (evt.button == 0) &#123; _isDown = true; &#125; &#125;); RegisterCallback&lt;PointerMoveEvent&gt;(evt =&gt; &#123; if (_isDown) &#123; _isMoved = true; &#125; &#125;); // ç›‘å¬ç‚¹å‡»çš„èŠ‚ç‚¹ RegisterCallback&lt;ClickEvent&gt;(evt =&gt; &#123; if (!_isMoved) &#123; Vector2 localMousePosition = evt.position - new Vector3(layout.xMin, layout.yMin); // èŽ·å–å½“å‰è¢«é€‰ä¸­çš„å¯¹è±¡ var currentSelection = panel.Pick(localMousePosition); if (currentSelection == null) &#123; if (_clickNode != null) &#123; _clickNode.UnSelected(); _clickNode = null; &#125; &#125; else &#123; bool isInput = false; while (currentSelection != null &amp;&amp; currentSelection is not RootNode) &#123; if (IsInputField(currentSelection)) &#123; isInput = true; break; &#125; currentSelection = currentSelection.parent; &#125; if (currentSelection == null) &#123; if (_clickNode != null) &#123; _clickNode.UnSelected(); _clickNode = null; &#125; &#125; else &#123; if (isInput) return; if (_clickNode != null &amp;&amp; currentSelection != _clickNode &amp;&amp; currentSelection is not RootNode) &#123; _clickNode.UnSelected(); _clickNode = null; &#125; else &#123; _clickNode?.UnSelected(); _clickNode = currentSelection as RootNode; _clickNode?.Selected(); &#125; &#125; &#125; &#125; _isMoved = false; _isDown = false; &#125;); // ç›‘å¬ä¿å­˜ç»„åˆé”® RegisterCallback&lt;KeyUpEvent&gt;(OnKeyUp); &#125; public override List&lt;Port&gt; GetCompatiblePorts(Port startPort, NodeAdapter nodeAdapter) &#123; // å­˜å‚¨ç¬¦åˆæ¡ä»¶çš„å…¼å®¹çš„ç«¯å£ List&lt;Port&gt; compatiblePorts = new List&lt;Port&gt;(); // éåŽ† Graphview ä¸­æ‰€æœ‰çš„ Port ä»Žä¸­å¯»æ‰¾ ports.ForEach( (port) =&gt; &#123; if (startPort.node != port.node &amp;&amp; startPort.direction != port.direction) &#123; compatiblePorts.Add(port); &#125; &#125; ); return compatiblePorts; &#125; public RootNode CreateNode(Type type, Vector2 position) &#123; RootNode node = Activator.CreateInstance(type) as RootNode; // è¿™é‡Œåªç”¨åˆ°äº† position node.SetPosition(new Rect(position, Vector2.zero)); node.RegistResize(this); node.SetSize(_defaultNodeSize); AddElement(node); _allNodes.Add(node.guid, node); return node; &#125; public RootNode CreateNode(Type type, string guid, Vector2 position, Vector2 size) &#123; RootNode node = Activator.CreateInstance(type) as RootNode; // è¿™é‡Œåªç”¨åˆ°äº† position node.SetPosition(new Rect(position, Vector2.zero)); node.RegistResize(this); node.SetSize(_defaultNodeSize); node.UpdateSize(size); AddElement(node); node.guid = guid; _allNodes.Add(guid, node); // åˆ›å»ºèŠ‚ç‚¹æ ‡è®°ä¸ºæ‰“å¼€æ–‡ä»¶ _isOpen = true; return node; &#125; public Edge MakeEdge(Port oput, Port iput) &#123; var edge = new Edge &#123; output = oput, input = iput &#125;; edge?.input.Connect(edge); edge?.output.Connect(edge); AddElement(edge); return edge; &#125; public void ClearGraph() &#123; foreach (var node in _allNodes) &#123; node.Value.RemoveEdges(); RemoveElement(node.Value); &#125; _allNodes.Clear(); _isOpen = false; _filePath = &quot;&quot;; &#125; /// &lt;summary&gt; /// æ˜¯å¦å¯è¾“å…¥ UI /// &lt;/summary&gt; /// &lt;param name=&quot;element&quot;&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; private bool IsInputField(VisualElement element) &#123; // åˆ¤æ–­å…ƒç´ æ˜¯å¦æ˜¯ BaseField&lt;T&gt; æˆ–å…¶æ´¾ç”Ÿç±»çš„å®žä¾‹ return HasBaseField(element.GetType()); &#125; bool HasBaseField(Type type) &#123; if (type.Name.IndexOf(&quot;BaseField&quot;) != -1) &#123; return true; &#125; // æ£€æŸ¥å½“å‰ç±»åž‹çš„åŸºç±»çš„å­—æ®µ if (type.BaseType != null) &#123; return HasBaseField(type.BaseType); &#125; return false; &#125; /// &lt;summary&gt; /// ä¿å­˜æ•°æ® /// &lt;/summary&gt; public List&lt;GDataNode&gt; SaveData() &#123; List&lt;GDataNode&gt; list = new List&lt;GDataNode&gt;(); foreach (var nodeData in _allNodes) &#123; RootNode node = nodeData.Value; if (!node.HasParent()) &#123; GDataNode dataNode = node.SaveData(); list.Add(dataNode); &#125; &#125; return list; &#125; /// &lt;summary&gt; /// å½“å‰æ˜¯å¦æ‰“å¼€æ–‡ä»¶ /// &lt;/summary&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool GetOpen() &#123; return _isOpen; &#125; public void SetFilePath(string filePath) &#123; _filePath = filePath; &#125; public void OpenData(List&lt;GDataNode&gt; datas, RootNode parent = null) &#123; foreach (var data in datas) &#123; Type type = Type.GetType(data.GetNodeType()); dynamic nodeData = data.GetData(); string[] pos = nodeData.pos.Trim(&#x27;(&#x27;, &#x27;)&#x27;).Split(&#x27;,&#x27;); string[] size = nodeData.size.Trim(&#x27;(&#x27;, &#x27;)&#x27;).Split(&#x27;,&#x27;); RootNode newNode = CreateNode(type, nodeData.guid, new Vector2(float.Parse(pos[0]), float.Parse(pos[1])), new Vector2(float.Parse(size[0]), float.Parse(size[1]))); newNode.SetData(nodeData); if (parent != null) &#123; // è¿žçº¿ MakeEdge(parent.GetOutput(), newNode.GetInput()); &#125; OpenData(data.GetChildren(), newNode); &#125; &#125; protected virtual void SetupToolbar() &#123; var toolbar = new Toolbar(); var openBtn = new ToolbarButton &#123;text = &quot;æ‰“å¼€&quot;&#125;; openBtn.clicked += Open; var saveBtn = new ToolbarButton &#123;text = &quot;ä¿å­˜&quot;&#125;; saveBtn.clicked += Save; var closeBtn = new ToolbarButton &#123;text = &quot;å…³é—­&quot;&#125;; closeBtn.clicked += Close; toolbar.Add(openBtn); toolbar.Add(saveBtn); toolbar.Add(closeBtn); Add(toolbar); &#125; private void Open() &#123; bool isOpen = GetOpen(); if (isOpen) &#123; bool res = EditorUtility.DisplayDialog (&quot;æ‰“å¼€æ–°æ–‡ä»¶&quot;, &quot;æ˜¯å¦æ‰“å¼€ä¸€ä¸ªæ–°çš„æ–‡ä»¶ï¼Œå½“å‰å†…å®¹æœªä¿å­˜çš„éƒ¨åˆ†ä¼šæ¶ˆå¤±ã€‚&quot;, &quot;ç¡®å®š&quot;, &quot;å–æ¶ˆ&quot;); if (res) &#123; ClearGraph(); &#125; else &#123; return; &#125; &#125; string filePath = EditorUtility.OpenFilePanel (&quot;æ‰“å¼€ ScriptableObject&quot;, &quot;Assets/Json&quot;, &quot;json&quot;); if (filePath != &quot;&quot;) &#123; string jsonData = &quot;&quot;; StreamReader sr = File.OpenText(filePath); while (sr.ReadLine() is &#123; &#125; nextLine) &#123; jsonData += nextLine; &#125; sr.Close(); List&lt;SaveJson&gt; json = JsonConvert.DeserializeObject&lt;List&lt;SaveJson&gt;&gt;(jsonData); List&lt;GDataNode&gt; list = new List&lt;GDataNode&gt;(); foreach (var data in json) &#123; list.Add(ToGDataNode(data)); &#125; SetFilePath(filePath); OpenData(list); &#125; &#125; private void Save() &#123; string filePath = EditorUtility.SaveFilePanel (&quot;ä¿å­˜åˆ°æœ¬åœ°&quot;, Application.dataPath + &quot;/Json&quot;, &quot;NewFile&quot;, &quot;json&quot;); if (filePath != &quot;&quot;) &#123; SetFilePath(filePath); List&lt;GDataNode&gt; list = SaveData(); List&lt;SaveJson&gt; listJson = new List&lt;SaveJson&gt;(); foreach (var data in list) &#123; listJson.Add(ToJson(data)); &#125; string jsonData = JsonConvert.SerializeObject(listJson); FileInfo myFile = new FileInfo(filePath); StreamWriter sw = myFile.CreateText(); foreach (var s in jsonData) &#123; sw.Write(s); &#125; sw.Close(); _editorWindow.ShowNotification (new GUIContent (&quot;ä¿å­˜æˆåŠŸï¼Œè·¯å¾„ä¸º:&quot; + filePath)); &#125; &#125; private void Close() &#123; ClearGraph(); &#125; private void OnKeyUp(KeyUpEvent evt) &#123; // æ£€æŸ¥æ˜¯å¦æŒ‰ä¸‹äº† Ctrl é”®å’Œ S é”® if (evt.keyCode == KeyCode.S &amp;&amp; evt.ctrlKey) &#123; if (_filePath == &quot;&quot;) &#123; Save(); return; &#125; Debug.Log(&quot;Ctrl + S pressed. Saving...&quot;); // æ‰§è¡Œä¿å­˜æ“ä½œ List&lt;GDataNode&gt; list = SaveData(); List&lt;SaveJson&gt; listJson = new List&lt;SaveJson&gt;(); foreach (var data in list) &#123; listJson.Add(ToJson(data)); &#125; string jsonData = JsonConvert.SerializeObject(listJson); FileInfo myFile = new FileInfo(_filePath); StreamWriter sw = myFile.CreateText(); foreach (var s in jsonData) &#123; sw.Write(s); &#125; sw.Close(); // è¿™é‡Œå¯ä»¥æ·»åŠ ä½ çš„ä¿å­˜é€»è¾‘ evt.StopPropagation (); // é˜»æ­¢äº‹ä»¶ä¼ é€’ï¼Œé¿å…è§¦å‘å…¶ä»–äº‹ä»¶ &#125; &#125; /// &lt;summary&gt; /// è½¬æ¢ä¸º JSON /// &lt;/summary&gt; /// &lt;param name=&quot;data&quot;&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public SaveJson ToJson(GDataNode data) &#123; SaveJson save = new SaveJson(); save.type = data.GetNodeType(); save.data = data.GetData(); foreach (var child in data.GetChildren()) &#123; save.children.Add(ToJson(child)); &#125; return save; &#125; /// &lt;summary&gt; /// è½¬æ¢ä¸ºèŠ‚ç‚¹æ•°æ® /// &lt;/summary&gt; /// &lt;param name=&quot;json&quot;&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public GDataNode ToGDataNode(SaveJson json) &#123; GDataNode data = new GDataNode(); data.SetNodeType(json.type); dynamic obj = new ExpandoObject(); foreach (var res in (json.data as JObject).Properties()) &#123; JTokenType jType = res.Value.Type; switch (jType) &#123; case JTokenType.String: ((IDictionary&lt;string, object&gt;)obj)[res.Name] = res.Value.Value&lt;string&gt;(); break; case JTokenType.Float: ((IDictionary&lt;string, object&gt;)obj)[res.Name] = res.Value.Value&lt;float&gt;(); break; case JTokenType.Boolean: ((IDictionary&lt;string, object&gt;)obj)[res.Name] = res.Value.Value&lt;bool&gt;(); break; &#125; &#125; data.SetData(obj); foreach (var child in json.children) &#123; data.AddChild(ToGDataNode(child)); &#125; return data; &#125; &#125;&#125; èƒŒæ™¯ uss GridBackground123456GridBackground &#123; --grid-background-color : #222222; --line-color: rgba(193,196,192,0.1); --thick-line-color: rgba(193,196,192,0.1); --spacing: 25;&#125; èœå•é…ç½®æ–‡ä»¶æ ¼å¼ èœå•é…ç½®æ–‡ä»¶1234567891011121314151617181920212223[ &#123; &quot;name&quot;: &quot;è£…é¥°èŠ‚ç‚¹&quot;, &quot;child&quot;: [ &#123; &quot;name&quot;: &quot;èƒœåˆ©èŠ‚ç‚¹&quot;, &quot;type&quot;: &quot;DNodeSuccess&quot; &#125;, &#123; &quot;name&quot;: &quot;å¤±è´¥èŠ‚ç‚¹&quot;, &quot;type&quot;: &quot;DNodeFail&quot; &#125;, &#123; &quot;name&quot;: &quot;åè½¬èŠ‚ç‚¹&quot;, &quot;type&quot;: &quot;DNodeReverse&quot; &#125; ] &#125;, &#123; &quot;name&quot;: &quot;æµ‹è¯•èŠ‚ç‚¹&quot;, &quot;type&quot;: &quot;TestNode&quot; &#125;] GDataNode GDataNode12345678910111213141516171819202122232425262728293031323334353637383940414243444546using System.Collections.Generic;namespace GraphViewExtension&#123; public class GDataNode &#123; private List&lt;GDataNode&gt; _children = new List&lt;GDataNode&gt;(); private dynamic _data; private string _type; public void SetData(dynamic data) &#123; _data = data; &#125; public void SetNodeType(string type) &#123; _type = type; &#125; public void AddChild(GDataNode node) &#123; if (!_children.Contains(node)) &#123; _children.Add(node); &#125; &#125; public List&lt;GDataNode&gt; GetChildren() &#123; return _children; &#125; public dynamic GetData() &#123; return _data; &#125; public string GetNodeType() &#123; return _type; &#125; &#125;&#125; SaveJson SaveJson12345678910111213using System.Collections.Generic;namespace GraphViewExtension&#123; public class SaveJson &#123; public List&lt;SaveJson&gt; children = new List&lt;SaveJson&gt;(); public dynamic data; public string type; &#125;&#125; æµ‹è¯•ç¼–è¾‘å™¨ ç¼–è¾‘å™¨1234567891011121314151617181920212223242526using UnityEditor;namespace GraphViewExtension&#123; [EName (&quot;æµ‹è¯•å·¥å…·&quot;)] public class TestEditor : BaseEditor&lt;TestEditor&gt; &#123; private GGraph _view; [MenuItem(&quot;GraphView/Editor&quot;)] public static void ShowWindow() &#123; var window = GetWindow&lt;TestEditor&gt;(); window.Show(); window.InitGraph(); &#125; public void InitGraph() &#123; var provider = CreateInstance&lt;GSearchWindow&gt;(); var graph = new GGraph(this, provider); rootVisualElement.Add(graph); _view = graph; &#125; &#125;&#125; é¡¹ç›®ä»“åº“ æ›´æ–°æ—¥å¿—2024-05-13 æ›´æ–°åŸºæœ¬å†…å®¹ã€‚","categories":[{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/categories/Unity/"},{"name":"ç¼–è¾‘å™¨","slug":"Unity/ç¼–è¾‘å™¨","permalink":"https://busyogg.github.io/categories/Unity/%E7%BC%96%E8%BE%91%E5%99%A8/"}],"tags":[{"name":"C#","slug":"C","permalink":"https://busyogg.github.io/tags/C/"},{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/tags/Unity/"},{"name":"ç¼–è¾‘å™¨","slug":"ç¼–è¾‘å™¨","permalink":"https://busyogg.github.io/tags/%E7%BC%96%E8%BE%91%E5%99%A8/"},{"name":"æ¡†æž¶","slug":"æ¡†æž¶","permalink":"https://busyogg.github.io/tags/%E6%A1%86%E6%9E%B6/"},{"name":"GraphView","slug":"GraphView","permalink":"https://busyogg.github.io/tags/GraphView/"}]},{"title":"è§†é¢‘æ‰¹é‡è½¬æ¢è„šæœ¬","slug":"è§†é¢‘æ‰¹é‡è½¬æ¢è„šæœ¬","date":"2024-04-27T10:37:09.000Z","updated":"2024-05-18T15:38:22.229Z","comments":true,"path":"article/f07bd054d1b2/","link":"","permalink":"https://busyogg.github.io/article/f07bd054d1b2/","excerpt":"","text":"ç®€ä»‹ç”¨äºŽæŠŠè§†é¢‘è½¬ä¸ºä»¥æ—¶é—´ä¸ºæ ‡é¢˜çš„ MOV æ ¼å¼ã€‚é€šè¿‡ ffmpeg å®žçŽ°ã€‚ æ”¯æŒæ‰¹é‡æ“ä½œï¼Œä½†æ˜¯ä»»åŠ¡ä¹‹é—´ä»¥å•çº¿ç¨‹å½¢å¼æ‰§è¡Œã€‚ æ¼”ç¤º åŠŸèƒ½ é‡å‘½åæ ‡é¢˜ã€‚ è½¬æ¢æ ¼å¼ä¸º MOVã€‚ å¯ä»¥é€šè¿‡ä¿®æ”¹æºä»£ç å®žçŽ°è‡ªå·±éœ€è¦çš„éœ€æ±‚ã€‚ ä»£ç 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162@echo offsetlocal enabledelayedexpansionREM æ£€æŸ¥æ˜¯å¦æ‹–æ‹½äº†æ–‡ä»¶åˆ°è„šæœ¬ä¸Šif &quot;%~1&quot;==&quot;&quot; ( echo Usage: %0 ^&lt;input_file1^&gt; [^&lt;input_file2^&gt; ...] exit /b 1)REM èŽ·å–æ‰¹å¤„ç†æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•set &quot;script_dir=%~dp0&quot;:process_filesREM å¦‚æžœæœ‰æ–‡ä»¶å¾…å¤„ç†åˆ™ç»§ç»­ï¼Œå¦åˆ™é€€å‡ºè„šæœ¬if &quot;%~1&quot;==&quot;&quot; ( exit /b 0)REM èŽ·å–å½“å‰æ—¥æœŸå’Œæ—¶é—´ï¼Œå¹¶åŽ»é™¤ç©ºæ ¼set year=%date:~0,4%set month=%date:~5,2%set day=%date:~8,2%set hour=%time:~0,2%if &quot;!hour:~0,1!&quot;==&quot; &quot; set &quot;hour=0!hour:~1,1!&quot;set minute=%time:~3,2%set second=%time:~6,2%set datetime=!year!-!month!-!day!-!hour!-!minute!-!second!REM èŽ·å–ç¬¬ä¸€ä¸ªå¾…å¤„ç†çš„æ–‡ä»¶set &quot;input_file=%~1&quot;REM ä½¿ç”¨å½“å‰æ—¶é—´ç”Ÿæˆæ–‡ä»¶åset &quot;output_file=%datetime%&quot;REM ç§»é™¤æ–‡ä»¶åä¸­ä¸åˆæ³•çš„å­—ç¬¦set &quot;output_file=%output_file:&quot;=%&quot; REM ç§»é™¤åŒå¼•å·set &quot;output_file=%output_file:&amp;=and%&quot; REM æ›¿æ¢ &amp; ç¬¦å·ä¸º &quot;and&quot;REM æ£€æŸ¥è¾“å‡ºæ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨ï¼Œå¦‚æžœå­˜åœ¨åˆ™å¢žåŠ åŽç¼€if exist &quot;%script_dir%!output_file!.mov&quot; ( set /a count=1 :loop if exist &quot;%script_dir%!output_file%_!count!.mov&quot; ( set /a count+=1 goto :loop ) set &quot;output_file=!output_file!_!count!&quot;) else ( REM æ·»åŠ æ–‡ä»¶æ‰©å±•å set &quot;output_file=%output_file%.mov&quot;)REM ä½¿ç”¨FFmpegè¿›è¡Œè½¬ç ï¼Œå¹¶ä¿å­˜åœ¨æ‰¹å¤„ç†æ–‡ä»¶å¤¹ä¸‹ffmpeg -i &quot;!input_file!&quot; -c:v libx264 -crf 24 -c:a copy &quot;%script_dir%!output_file!&quot;REM ç­‰å¾…ä¸€ç§’timeout /t 1 &gt;nulREM å¤„ç†ä¸‹ä¸€ä¸ªæ–‡ä»¶shiftgoto :process_files","categories":[{"name":"åˆ†äº«","slug":"åˆ†äº«","permalink":"https://busyogg.github.io/categories/%E5%88%86%E4%BA%AB/"}],"tags":[{"name":"è„šæœ¬","slug":"è„šæœ¬","permalink":"https://busyogg.github.io/tags/%E8%84%9A%E6%9C%AC/"},{"name":"ffmpeg","slug":"ffmpeg","permalink":"https://busyogg.github.io/tags/ffmpeg/"}]},{"title":"Shader-è‰åœ°","slug":"Shader-è‰åœ°","date":"2024-04-17T09:06:29.000Z","updated":"2024-05-30T12:28:06.218Z","comments":true,"path":"article/3306b5965f83/","link":"","permalink":"https://busyogg.github.io/article/3306b5965f83/","excerpt":"","text":"ç®€ä»‹è‰åœ° Shaderï¼Œæ ¹æ®å™ªå£°å›¾æŽ§åˆ¶æ‘†åŠ¨ï¼Œæ”¯æŒé£Žå‘å’Œé£ŽåŠ›è°ƒæ•´ï¼Œå¯äº¤äº’ã€‚æœ‰è‹¥å¹²å¯ä»¥æŽ§åˆ¶çš„å‚æ•°è°ƒæ•´æ•´ä½“çš„æ•ˆæžœã€‚ åŽŸç†é£Žåœºåˆ©ç”¨å™ªå£°å›¾ä¿å­˜çš„å‘é‡ä¿¡æ¯ä½¿é¡¶ç‚¹è¿›è¡Œåç§»ã€‚å™ªå£°å›¾çš„é¢œè‰²ä¿¡æ¯çš„ rgb åˆ†é‡å³å¯¹åº”æ–¹å‘å‘é‡çš„ xyz åˆ†é‡ã€‚ åœ¨é¡¶ç‚¹ç€è‰²å™¨ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ tex2Dlod æ–¹æ³•å¯¹å™ªå£°å›¾è¿›è¡Œé‡‡æ ·ï¼Œé‡‡æ ·çš„ uv ä½¿ç”¨é¡¶ç‚¹çš„ä¸–ç•Œåæ ‡ï¼Œè¿™æ ·å¯ä»¥åœ¨æ‰€æœ‰æ¨¡åž‹ä¸Šä¿æŒè¿žè´¯æ€§ã€‚ åˆ©ç”¨å†…ç½® _Time å‚æ•°è¿›è¡Œé‡‡æ ·æ•°æ®çš„å˜åŒ–ï¼š 123456//è®¡ç®—ä¸–ç•Œåæ ‡float4 worldPos = mul(unity_ObjectToWorld, v.vertex);//è®¡ç®—uvfloat2 offsetUV = (worldPos.xz * 1 / _sampleScale) * _Time.x;//é‡‡æ ·float4 sample = tex2Dlod(_sample, float4(offsetUV, 0, 0)); å…¶ä¸­ _sampleScale ç”¨äºŽç¼©æ”¾é‡‡æ ·å°ºåº¦ï¼Œè¶Šå°å˜åŒ–è¶Šå¿«ã€‚ ä¸ºäº†èƒ½å¤Ÿæ”¹å˜é£Žå‘ï¼Œæˆ‘ä»¬è®¾ç½®ä¸€ä¸ªé£Žå‘å‚æ•°ï¼ˆèŒƒå›´ä¸º 0 - 360 åº¦ï¼‰ï¼Œå› ç»• Y è½´çš„æ—‹è½¬çŸ©é˜µä¸ºï¼š $$ \\left[ \\begin{matrix} cos(Î¸) &amp; 0 &amp; sin(Î¸) &amp; 0 \\\\ 0 &amp; 1 &amp; 0 &amp; 0 \\\\ -sin(Î¸) &amp; 0 &amp; cos(Î¸) &amp; 0 \\\\ 0 &amp; 0 &amp; 0 &amp; 1 \\end{matrix} \\right]$$ æŠŠé£Žå‘è½¬ä¸ºå¼§åº¦å¹¶å¡«å…¥å…¶ä¸­å°±èƒ½å¾—åˆ°è¯¥æ–¹å‘çš„æ—‹è½¬çŸ©é˜µã€‚ æœ€åŽæŠŠæ—‹è½¬çŸ©é˜µä¹˜ä»¥åç§»é‡å°±èƒ½å¾—åˆ°æ­£ç¡®çš„æ–¹å‘äº†ã€‚ ä¸ºäº†ä½¿è‰åœ°åº•éƒ¨é¡¶ç‚¹ä¸åç§»ï¼Œæˆ‘ä»¬è®¡ç®—é¡¶ç‚¹ç›¸å¯¹äºŽåº•éƒ¨çš„é«˜åº¦ï¼Œä¸ºäº†é€‚é…ä¸åŒä¸­å¿ƒç‚¹çš„æ¨¡åž‹ï¼Œæˆ‘ä»¬å•ç‹¬è®¾ç½®ä¸€ä¸ªå‚æ•° _Bottom æ¥æ ¡å‡†ã€‚ 12345678//è®¡ç®—æ¨¡åž‹é¡¶ç‚¹ç›¸å¯¹äºŽåº•éƒ¨é¡¶ç‚¹çš„é«˜åº¦float bottom = v.vertex.y - _Bottom;//è®¡ç®—xzæ–¹å‘åç§»float2 offset = sample.xz * bottom * _WindStrength;//æ”¹å˜xzé¡¶ç‚¹åæ ‡v.vertex.xz += offset * 0.1;//æ”¹å˜yé¡¶ç‚¹åæ ‡v.vertex.y -= sample.y * bottom * 0.1 * _WindStrength; é¡¶ç‚¹åç§»çš„è§„åˆ™å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦ä¿®æ”¹ã€‚ äº¤äº’æ­¤å¤„äº¤äº’åªåšäº†å•ä¸ªå¯¹è±¡çš„äº¤äº’ï¼Œä½¿ç”¨å…¨å±€åæ ‡ã€‚å¤šä¸ªå¯¹è±¡å¯ä»¥ä½¿ç”¨ RenderTexture æ¥å®žçŽ°ã€‚ é€šè¿‡èŽ·å–éšæ„ä¸€ä¸ªè‰åœ°æè´¨çš„ sharedMaterial å¹¶è®¾ç½® _GlobalPos å‚æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨æ‰€æœ‰çš„è‰åœ° shader ä¸ŠåŒæ­¥äº¤äº’ç‰©ä½“åæ ‡ã€‚ ç„¶åŽé€šè¿‡è‡ªå®šä¹‰çš„è§„åˆ™è¿›è¡Œé¡¶ç‚¹äº¤äº’åç§»ã€‚ 123456789101112131415//èŽ·å–æ”¹å˜åŽé¡¶ç‚¹åæ ‡çš„ä¸–ç•Œç©ºé—´float3 newWoldPos = mul(unity_ObjectToWorld, v.vertex);//è®¡ç®—äº¤äº’æ–¹å‘float2 interactiveVec = newWoldPos.xz - _GlobalPos.xz;//è®¡ç®—é¡¶ç‚¹ä¸Žäº¤äº’ç‰©ä½“åæ ‡çš„è·ç¦»float dist = length(interactiveVec);//è®¡ç®—äº¤äº’è·ç¦»æ¯”çŽ‡float distRatio = clamp(0, 1, dist / _InteractiveRadius);//è®¡ç®—äº¤äº’æ–¹å‘æ³•çº¿float2 interactiveOffset = normalize(interactiveVec.xy);//è®¡ç®—æœ€ç»ˆäº¤äº’å‘é‡float2 interactiveOffsetFinal = clamp(0,0.4,interactiveOffset * (1 - distRatio) * bottom);//æ›´æ–°é¡¶ç‚¹åæ ‡v.vertex.xz += interactiveOffsetFinal;v.vertex.y -= bottom * (1 - distRatio); å¦‚æžœæœ‰ä¸æ­¢ä¸€ç§è‰åœ° Shader çš„è¯ï¼Œè¿˜æ˜¯ä½¿ç”¨ RenderTexture æ¥å®žçŽ°æ¯”è¾ƒå¥½ï¼Œä»¥åŽæœ‰ç©ºå†æ›´æ–°ã€‚ æŠ•å½±æŠ•å½±éœ€è¦æ–°å¢žä¸€ä¸ª Passï¼Œé¡¶ç‚¹ç€è‰²å™¨ä¹Ÿè¦è¿›è¡Œé¡¶ç‚¹å˜åŒ–ï¼Œè¿™æ ·æ‰èƒ½æ˜¾ç¤ºæ­£ç¡®çš„é˜´å½±ã€‚ ä»£ç è‰åœ°Shader123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226Shader &quot;Custom/Plant&quot;&#123; Properties &#123; _Diffuse (&quot;Diffuse&quot;, Color) = (1, 1, 1, 1) _Specular (&quot;Specular&quot;, Color) = (1, 1, 1, 1) _Gloss (&quot;Gloss&quot;, Range(8.0, 256)) = 20 _MainTex (&quot;Albedo (RGB)&quot;, 2D) = &quot;white&quot; &#123;&#125; _Bottom(&quot;Bottom&quot;,Range(-1,0)) = 0.0 _WindStrength(&quot;WindStrength&quot;,Range(0,45)) = 0.0 _WindDirection(&quot;WindDirection&quot;,Range(0,360)) = 0.0 _sample(&quot;sample (RGB)&quot;,2D) = &quot;black&quot; &#123;&#125; _sampleScale(&quot;sampleScale&quot;,Range(0,100)) = 1.0 _InteractiveRadius(&quot;InteractiveRadius&quot;,Float) = 1.0 _GlobalPos(&quot;GlobalPos&quot;,Vector) = (0,0,0) &#125; SubShader &#123; Pass &#123; Tags &#123; &quot;LightMode&quot;=&quot;ForwardBase&quot; &#125; Cull Back CGPROGRAM #pragma vertex vert #pragma fragment frag #pragma multi_compile_fwdbase #include &quot;UnityCG.cginc&quot; #include &quot;Lighting.cginc&quot; #include &quot;AutoLight.cginc&quot; fixed4 _Diffuse; fixed4 _Specular; float _Gloss; sampler2D _MainTex; sampler2D _sample; float _WindStrength; float _WindDirection; float _sampleScale; float _InteractiveRadius; float3 _GlobalPos; float _Bottom; struct v2f &#123; float4 pos : SV_POSITION; fixed4 uv : TEXCOORD0; fixed4 worldPos : TEXCOORD1; float3 worldNormal : TEXCOORD2; SHADOW_COORDS(3) &#125;; v2f vert(appdata_base v) &#123; v2f o; //è®¡ç®—ä¸–ç•Œåæ ‡ float4 worldPos = mul(unity_ObjectToWorld, v.vertex); //è®¡ç®—uv float2 offsetUV = (worldPos.xz * 1 / _sampleScale) * _Time.x; //é‡‡æ · float4 sample = tex2Dlod(_sample, float4(offsetUV, 0, 0)); //é£Žå‘ float rad = _WindDirection * UNITY_PI / 180; float4x4 rot = float4x4( cos(rad),0,sin(rad),0, 0,1,0,0, -sin(rad),0,cos(rad),0, 0,0,0,1 ); //æ—‹è½¬é‡‡æ · sample = mul(rot,sample); //è®¡ç®—æ¨¡åž‹é¡¶ç‚¹ç›¸å¯¹äºŽåº•éƒ¨é¡¶ç‚¹çš„é«˜åº¦ float bottom = v.vertex.y - _Bottom; //è®¡ç®—xzæ–¹å‘åç§» float2 offset = sample.xz * bottom * _WindStrength; //æ”¹å˜xzé¡¶ç‚¹åæ ‡ v.vertex.xz += offset * 0.1; //æ”¹å˜yé¡¶ç‚¹åæ ‡ v.vertex.y -= sample.y * bottom * 0.1 * _WindStrength; //èŽ·å–æ”¹å˜åŽé¡¶ç‚¹åæ ‡çš„ä¸–ç•Œç©ºé—´ float3 newWoldPos = mul(unity_ObjectToWorld, v.vertex); //è®¡ç®—äº¤äº’æ–¹å‘ float2 interactiveVec = newWoldPos.xz - _GlobalPos.xz; //è®¡ç®—é¡¶ç‚¹ä¸Žäº¤äº’ç‰©ä½“åæ ‡çš„è·ç¦» float dist = length(interactiveVec); //è®¡ç®—äº¤äº’è·ç¦»æ¯”çŽ‡ float distRatio = clamp(0, 1, dist / _InteractiveRadius); //è®¡ç®—äº¤äº’æ–¹å‘æ³•çº¿ float2 interactiveOffset = normalize(interactiveVec.xy); //è®¡ç®—æœ€ç»ˆäº¤äº’å‘é‡ float2 interactiveOffsetFinal = clamp(0,0.4,interactiveOffset * (1 - distRatio) * bottom); //æ›´æ–°é¡¶ç‚¹åæ ‡ v.vertex.xz += interactiveOffsetFinal; v.vertex.y -= bottom * (1 - distRatio); o.pos = UnityObjectToClipPos(v.vertex); o.uv = v.texcoord; o.worldPos = worldPos; o.worldNormal = UnityObjectToWorldNormal(v.normal); // o.worldNormal = UnityObjectToWorldNormal(mul(rotX, mul(rotZ, v.normal))); TRANSFER_SHADOW(o); return o; &#125; float4 frag(v2f i) : SV_Target &#123; //textureé‡‡æ · fixed4 color = tex2D(_MainTex, i.uv); // color *= _Diffuse; fixed3 worldNormal = normalize(i.worldNormal); fixed3 worldLightDir = normalize(_WorldSpaceLightPos0.xyz); fixed3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz; fixed3 diffuse = _LightColor0.rgb * _Diffuse.rgb * max(0, dot(worldNormal, worldLightDir)); fixed3 viewDir = normalize(_WorldSpaceCameraPos.xyz - i.worldPos.xyz); fixed3 halfDir = normalize(worldLightDir + viewDir); fixed3 specular = _LightColor0.rgb * _Specular.rgb * pow(max(0, dot(worldNormal, halfDir)), _Gloss); fixed atten = 1.0; //å…‰ç…§è¡°å‡ fixed shadow = SHADOW_ATTENUATION(i); return fixed4(color.xyz * (ambient + (diffuse + specular) * atten * shadow), 1.0); &#125; ENDCG &#125; Pass &#123; Tags &#123; &quot;LightMode&quot; = &quot;ShadowCaster&quot; &#125; CGPROGRAM #pragma vertex vert #pragma fragment frag #pragma multi_compile_shadowcaster #include &quot;UnityCG.cginc&quot; struct v2f &#123; V2F_SHADOW_CASTER; // float4 pos : SV_POSITION; // float3 worldPos : TEXCOORD0; &#125;; sampler2D _sample; float _WindStrength; float _WindDirection; float _sampleScale; float _InteractiveRadius; float3 _GlobalPos; float _Bottom; v2f vert(appdata_base v) &#123; v2f o; float4 worldPos = mul(unity_ObjectToWorld, v.vertex); float2 offsetUV = (worldPos.xz * 1 / _sampleScale) * _Time.x; //é‡‡æ · float4 sample = tex2Dlod(_sample, float4(offsetUV, 0, 0)); float rad = _WindDirection * UNITY_PI / 180; //é£Žå‘ float4x4 rot = float4x4( cos(rad),0,sin(rad),0, 0,1,0,0, -sin(rad),0,cos(rad),0, 0,0,0,1 ); sample = mul(rot,sample); float bottom = v.vertex.y - _Bottom; float2 offset = sample.xz * bottom * _WindStrength; v.vertex.xz += offset * 0.1; v.vertex.y -= sample.y * bottom * 0.1 * _WindStrength; float3 newWoldPos = mul(unity_ObjectToWorld, v.vertex); //è®¡ç®—äº¤äº’æ–¹å‘ float2 interactiveVec = newWoldPos.xz - _GlobalPos.xz; //è®¡ç®—é¡¶ç‚¹ä¸Žäº¤äº’ç‰©ä½“åæ ‡çš„è·ç¦» float dist = length(interactiveVec); //è®¡ç®—äº¤äº’è·ç¦»æ¯”çŽ‡ float distRatio = clamp(0, 1, dist / _InteractiveRadius); float2 interactiveOffset = normalize(interactiveVec.xy); float2 interactiveOffsetFinal = clamp(0,0.4,interactiveOffset * (1 - distRatio) * bottom); v.vertex.xz += interactiveOffsetFinal; v.vertex.y -= bottom * (1 - distRatio); TRANSFER_SHADOW_CASTER(o); return o; &#125; float4 frag(v2f i) : SV_Target &#123; SHADOW_CASTER_FRAGMENT(i) &#125; ENDCG &#125; &#125; FallBack &quot;Diffuse&quot;&#125; äº¤äº’åæ ‡æ›´æ–°123456789101112131415161718using System;using UnityEngine;public class PosUpdate : MonoBehaviour&#123; private Material _grass; private void Awake() &#123; //è‡ªå·±èŽ·å–è‰åœ°çš„sharedMaterialï¼Œæ­¤å¤„å·æ‡’ç›´æŽ¥æŸ¥æ‰¾äº† _grass = GameObject.Find(&quot;uploads_files_3639591_Grass&quot;).transform.GetChild(0).GetComponent&lt;Renderer&gt;().sharedMaterial; &#125; private void Update() &#123; _grass.SetVector(&quot;_GlobalPos&quot;,transform.position); &#125;&#125; é¡¹ç›®å·¥ç¨‹ æ›´æ–°æ—¥å¿—2024-04-17 æ›´æ–°åŸºç¡€å†…å®¹ã€‚","categories":[{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/categories/Unity/"},{"name":"Shader","slug":"Unity/Shader","permalink":"https://busyogg.github.io/categories/Unity/Shader/"}],"tags":[{"name":"Shader","slug":"Shader","permalink":"https://busyogg.github.io/tags/Shader/"},{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/tags/Unity/"}]},{"title":"Shader-è¿›åº¦æ¡","slug":"Shader-è¿›åº¦æ¡","date":"2024-04-01T12:29:36.000Z","updated":"2024-05-30T12:28:01.898Z","comments":true,"path":"article/919acd35c6df/","link":"","permalink":"https://busyogg.github.io/article/919acd35c6df/","excerpt":"","text":"ç®€ä»‹è¿›åº¦æ¡ Shaderï¼Œæ‹¥æœ‰å¦‚ä¸‹ç‰¹æ€§ï¼š å¯ä»¥æŽ§åˆ¶è¿›åº¦æ¡çš„é¢œè‰²å’ŒèƒŒæ™¯é¢œè‰²ï¼ŒåŒ…æ‹¬é€æ˜Žåº¦æŽ§åˆ¶ã€‚ å¯ä»¥é€‰æ‹©è¿›åº¦æ¡çš„æ–¹å‘ã€‚ é€šè¿‡ä¼ å…¥è¿›åº¦å€¼æ¥æ›´æ–°è¿›åº¦æ¡ã€‚ æ•ˆæžœå¦‚ä¸‹ï¼š åŽŸç†é™å®šå½¢çŠ¶ä¼ å…¥å¸¦æœ‰é€æ˜Žé€šé“çš„è´´å›¾å¹¶é‡‡æ ·ï¼Œåˆ¤æ–­å½“å‰ uv æ˜¯å¦ä¸ºé€æ˜Žåƒç´ ï¼Œæ˜¯çš„è¯å°±æ¸²æŸ“ä¸ºé€æ˜Žï¼Œä¸æ˜¯çš„è¯å°±æŒ‰ç…§ç›¸åº”çš„è§„åˆ™æ¸²æŸ“ã€‚ æ¸²æŸ“è¿›åº¦æ¡é€šè¿‡ atan2 å‡½æ•°è®¡ç®—å½“å‰ XZ å¹³é¢çš„æ¨¡åž‹åæ ‡ç›¸å¯¹äºŽ x è½´çš„æ—‹è½¬è§’åº¦ã€‚ å› ä¸º atan2 å‡½æ•°åœ¨ Z æ–¹å‘ä¸Šä¸ºæ­£çš„æ—¶å€™ï¼Œå¤¹è§’ä¸º 0 - 180ï¼Œä¸ºè´Ÿæ—¶å¤¹è§’ä¸º 0 - -180ï¼Œå› æ­¤æˆ‘ä»¬åœ¨å¤¹è§’ä¸ºè´Ÿçš„æ—¶å€™åŠ ä¸Š 360ï¼Œä½¿å…¶åœ¨æ€»ä½“ä¸Šå¤¹è§’ä¸º 0 - 360 èŒƒå›´ã€‚ ä»¥ä¸Šæ˜¯æ­£æ–¹å‘è¿›åº¦æ¡çš„è°ƒæ•´ï¼Œå¦‚æžœæ˜¯è´Ÿæ–¹å‘çš„è¯å°±åœ¨å¤¹è§’ä¸ºæ­£çš„æ—¶å€™å‡åŽ» 360ï¼Œç„¶åŽå–ç»å¯¹å€¼ã€‚ é€æ˜Žåº¦æ··åˆ å‰æ™¯è‰²é€æ˜Žåº¦å’ŒèƒŒæ™¯è‰²é€æ˜Žåº¦ç›¸åŠ ï¼Œå¹¶é™åˆ¶èŒƒå›´ä¸º 0 - 255ã€‚ åˆ¤æ–­å½“å‰åƒç´ å±žäºŽå·²ç»èµ°è¿‡çš„è¿›åº¦æ¡è¿˜æ˜¯æ²¡èµ°è¿‡çš„ï¼Œå·²èµ°è¿‡å°±å–æ­¥éª¤ 1 çš„é€æ˜Žåº¦ï¼Œå¦åˆ™ç”¨èƒŒæ™¯è‰²é€æ˜Žåº¦ã€‚ åˆ¤æ–­å½“å‰ uv æ˜¯å¦ä¸ºé€æ˜Žåƒç´ ï¼Œå³é™å®šå½¢çŠ¶ï¼Œä¸é€æ˜Žå°±ç”¨æ­¥éª¤ 2 çš„é€æ˜Žåº¦ï¼Œå¦åˆ™é€æ˜Žåº¦ä¸º 0ã€‚ ä»£ç è¿›åº¦æ¡Shader1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889Shader &quot;Unlit/Progress&quot;&#123; Properties &#123; _MainTex (&quot;Texture&quot;, 2D) = &quot;white&quot; &#123;&#125; _Progress (&quot;Progress&quot;,Range(0,1)) = 0 _BackgroundColor (&quot;BackgroundColor&quot;,Color) = (0,0,0,0) _ForegroundColor (&quot;ForegroundColor&quot;,Color) = (0,1,0,1) [Toggle(_True)]_Forward(&quot;Forward&quot;, Int) = 1 &#125; SubShader &#123; Tags &#123; &quot;RenderType&quot;=&quot;Transparent&quot; &#125; Blend SrcAlpha OneMinusSrcAlpha // ä½¿ç”¨æ ‡å‡†çš„é€æ˜Žæ··åˆæ¨¡å¼ LOD 100 Pass &#123; CGPROGRAM #pragma vertex vert #pragma fragment frag // make fog work #pragma multi_compile_fog #include &quot;UnityCG.cginc&quot; struct appdata &#123; float4 vertex : POSITION; float2 uv : TEXCOORD0; &#125;; struct v2f &#123; float2 uv : TEXCOORD0; float4 vertex : SV_POSITION; float3 pos: TEXCOORD1; &#125;; sampler2D _MainTex; float4 _MainTex_ST; float _Progress; float4 _BackgroundColor; float4 _ForegroundColor; int _Forward; v2f vert(appdata v) &#123; v2f o; o.vertex = UnityObjectToClipPos(v.vertex); o.uv = TRANSFORM_TEX(v.uv, _MainTex); o.pos = v.vertex.xyz; return o; &#125; fixed4 frag(v2f i) : SV_Target &#123; //è´´å›¾é‡‡æ · åªç”¨è´´å›¾çš„aé€šé“ fixed4 col = tex2D(_MainTex, i.uv); //è®¡ç®—å‰æ™¯è‰²å’ŒèƒŒæ™¯è‰²çš„é€æ˜Žåº¦å’Œ fixed4 final = fixed4(0, 0, 0, 0); //è®¡ç®—åŽŸç‚¹åˆ°åæ ‡ç‚¹ç›¸å¯¹äºŽxè½´çš„è§’åº¦ float angle = atan2(i.pos.z, i.pos.x) * (180 / 3.14159); //è®¡ç®—é¡ºæ—¶é’ˆå’Œé€†æ—¶é’ˆè§’åº¦ angle = _Forward == 0 ? (angle &lt; 0 ? angle + 360 : angle) : abs(angle &gt; 0 ? angle - 360 : angle); //æ ¹æ®å½“å‰åæ ‡è§’åº¦å’Œç›®æ ‡è§’åº¦çš„å¤§å°å…³ç³»æ¸²æŸ“è¿›åº¦æ¡ const float curAngle = _Progress * 360; final.rgb = curAngle &gt;= angle ? _ForegroundColor.xyz * _ForegroundColor.a + _BackgroundColor.xyz * (1 - _ForegroundColor.a) : _BackgroundColor.xyz; //è®¡ç®—é€æ˜Žåº¦å’Œæ··è‰² const float quadFinalAlpha = clamp(0,255,_BackgroundColor.a + _ForegroundColor.a) ; const float semiFinalAlpha = curAngle &gt;= angle ? quadFinalAlpha: _BackgroundColor.a; final.a = step(1 - col.a, 0.5) == 1 ? semiFinalAlpha : 0; return final; &#125; ENDCG &#125; &#125;&#125; é¡¹ç›®å·¥ç¨‹ æ›´æ–°æ—¥å¿—2024-04-01 æ›´æ–°åŸºæœ¬å†…å®¹ã€‚","categories":[{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/categories/Unity/"},{"name":"Shader","slug":"Unity/Shader","permalink":"https://busyogg.github.io/categories/Unity/Shader/"}],"tags":[{"name":"Shader","slug":"Shader","permalink":"https://busyogg.github.io/tags/Shader/"},{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/tags/Unity/"}]},{"title":"Shader-æè¾¹","slug":"Shader-æè¾¹","date":"2024-04-01T09:30:30.000Z","updated":"2024-05-30T12:27:58.483Z","comments":true,"path":"article/b7477ac748d2/","link":"","permalink":"https://busyogg.github.io/article/b7477ac748d2/","excerpt":"","text":"ç®€ä»‹ç»™ç‰©ä½“æè¾¹çš„ Shaderï¼Œå®žçŽ°çš„æ–¹æ³•æœ‰å¤šç§ï¼Œä¾‹å¦‚é¡¶ç‚¹æ‰©å¤§ã€æ³•çº¿ä¸Žè§†çº¿ç‚¹ç§¯ã€åŽå¤„ç†ç­‰ã€‚ä¸åŒçš„æ–¹æ³•æœ‰å…¶å¯¹åº”çš„ä¼˜ç¼ºç‚¹å’Œé€‚ç”¨èŒƒå›´ã€‚ æœ¬æ–‡é‡‡ç”¨é¡¶ç‚¹æ‰©å¤§çš„æ–¹æ³•ã€‚ åŽŸç†é¡¶ç‚¹æ‰©å¤§é¡¶ç‚¹æ‰©å¤§çš„åŽŸç†å¾ˆç®€å•ã€‚ æè¾¹ Shader åŒ…å«ä¸¤ä¸ª Passï¼Œä¸€ä¸ª Pass æ­£å¸¸æ¸²æŸ“ç‰©ä½“ï¼Œå¦ä¸€ä¸ª Pass æ¸²æŸ“æè¾¹ã€‚ æ­£å¸¸çš„ Pass å‰”é™¤èƒŒé¢ï¼Œæè¾¹çš„ Pass å‰”é™¤æ­£é¢ã€‚ æè¾¹çš„ Pass æŠŠåŽŸæ¥æ¨¡åž‹çš„é¡¶ç‚¹æ²¿æ³•çº¿æ–¹å‘ç§»åŠ¨ä¸€å®šè·ç¦»ï¼Œä¹Ÿå°±æ˜¯æ‰©å¤§æ¨¡åž‹é¡¶ç‚¹ï¼Œè¿™æ ·å°±æœ‰ä¸€ä¸ªè½®å»“å¥—åœ¨åŽŸæ¥çš„æ¨¡åž‹å¤–é¢ã€‚ å¦‚å›¾æ‰€ç¤ºï¼ŒæŠŠåŽŸæ¨¡åž‹ï¼ˆè“è‰²ï¼‰é¡¶ç‚¹å‘å¤–æ‰©å±•åˆ°çº¢è‰²å¤§å°ï¼Œè¿™æ ·çº¢è‰²å’Œè“è‰²ä¹‹é—´çš„åŒºåŸŸå°±æ˜¯æè¾¹ã€‚ æè¾¹ç²—ç»†å›ºå®šç”±äºŽé¡¶ç‚¹çš„å˜åŒ–åœ¨ NDCï¼ˆæ ‡å‡†è®¾å¤‡åæ ‡ï¼‰ç©ºé—´ä¸­çš„å˜åŒ–ä¸ä¼šå—åˆ°ç›¸æœºè·ç¦»çš„å½±å“ï¼Œå› æ­¤æˆ‘ä»¬æŠŠé¡¶ç‚¹æ‰©å¤§æ”¾åœ¨è¿™é‡Œè¿›è¡Œã€‚ åˆå› ä¸º NDC ç©ºé—´æ˜¯ -1 åˆ° 1 çš„å½’ä¸€åŒ–åæ ‡ç©ºé—´ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦è®¡ç®—å±å¹•çš„å®½é«˜æ¯”ï¼Œç„¶åŽä»¤å˜åŒ–åŽçš„é¡¶ç‚¹ X åæ ‡ä¹˜ä»¥å®½é«˜æ¯”å¾—åˆ°æ­£ç¡®çš„åæ ‡ï¼Œå¦åˆ™åœ¨çŽ°å®žçš„æ—¶å€™ X æ–¹å‘çš„ç²—ç»†ä¼šä¸å‡åŒ€ã€‚ å¸¸è§é—®é¢˜å½“æ¨¡åž‹æŸäº›é¡¶ç‚¹åœ¨å¤šä¸ªé¢å­˜åœ¨çš„æ—¶å€™ï¼Œæè¾¹å°±ä¼šäº§ç”Ÿæ–­å¼€çš„çŽ°è±¡ã€‚æœ€å…¸åž‹çš„ä¾‹å­å°±æ˜¯ç«‹æ–¹ä½“ã€‚ ç½‘å›¾ å¦‚å›¾æ‰€ç¤ºã€‚ è¿™æ—¶å€™æˆ‘ä»¬å°±è¦å¹³æ»‘æ³•çº¿ã€‚æˆ‘ä»¬æŠŠå­˜åœ¨äºŽå¤šä¸ªé¢çš„é¡¶ç‚¹çš„æ³•çº¿ç›¸åŠ ï¼Œå¾—åˆ°ä¸€ä¸ªæœ€ç»ˆçš„æ³•çº¿æ–¹å‘ï¼Œè¿™æ ·å°±èƒ½é¿å…è¿™ä¸ªé—®é¢˜ã€‚ å¹³æ»‘æ³•çº¿çš„è¿‡ç¨‹å¯ä»¥æ”¾åœ¨è¿è¡Œå‰ï¼Œæå‰å¤„ç†æ¨¡åž‹æ•°æ®ï¼Œä¹Ÿå¯ä»¥æ”¾åœ¨è¿è¡Œæ—¶ï¼Œä¸è¿‡è¿è¡Œæ—¶å¤„ç†ä¼šé€ æˆé¢å¤–çš„æ€§èƒ½å¼€é”€ã€‚ æœ¬æ–‡æŠŠå¹³æ»‘æ³•çº¿çš„è¿‡ç¨‹æ”¾åœ¨è¿è¡Œæ—¶ï¼Œç»“æžœå†™å…¥åˆ‡çº¿ä¸­ï¼ˆå†™å…¥æ³•çº¿å¯èƒ½ä¼šé€ æˆå…‰å½±è®¡ç®—å‡ºé—®é¢˜ï¼‰ï¼Œè¯»å–çš„æ—¶å€™ä¹Ÿæ˜¯ä»Žåˆ‡çº¿è¯»å–ã€‚ ä»£ç æè¾¹Shader123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129Shader &quot;Custom/Outline&quot;&#123; Properties &#123; _Diffuse (&quot;Diffuse&quot;, Color) = (1, 1, 1, 1) _Specular (&quot;Specular&quot;, Color) = (1, 1, 1, 1) _Gloss (&quot;Gloss&quot;, Range(8.0, 256)) = 20 _MainTex (&quot;Albedo (RGB)&quot;, 2D) = &quot;white&quot; &#123;&#125; _OutlineWidth (&quot;OutlineWidth&quot;, Range(0,1)) = 0.1 _OutlineColor (&quot;OutlineColor&quot;, Color) = (0,0,0,1) &#125; SubShader &#123; Pass &#123; Tags &#123; &quot;LightMode&quot;=&quot;ForwardBase&quot; &#125; Cull Back CGPROGRAM #pragma vertex vert #pragma fragment frag #pragma multi_compile_fwdbase #include &quot;UnityCG.cginc&quot; #include &quot;Lighting.cginc&quot; #include &quot;AutoLight.cginc&quot; fixed4 _Diffuse; fixed4 _Specular; float _Gloss; sampler2D _MainTex; struct v2f &#123; float4 pos : SV_POSITION; fixed4 uv : TEXCOORD0; fixed4 worldPos : TEXCOORD1; float3 worldNormal : TEXCOORD2; SHADOW_COORDS(3) &#125;; v2f vert(appdata_base v) &#123; v2f o; //é¡¶ç‚¹è½¬ä¸ºè£å‰ªç©ºé—´åæ ‡ o.pos = UnityObjectToClipPos(v.vertex); o.uv = v.texcoord; o.worldPos = mul(unity_ObjectToWorld,v.vertex.xyz); o.worldNormal = UnityObjectToWorldNormal(v.normal); TRANSFER_SHADOW(o); return o; &#125; float4 frag(v2f i) : SV_Target &#123; //textureé‡‡æ · fixed4 color = tex2D(_MainTex,i.uv); //å…‰å½±è®¡ç®— fixed3 worldNormal = normalize(i.worldNormal); fixed3 worldLightDir = normalize(_WorldSpaceLightPos0.xyz); fixed3 ambient = UNITY_LIGHTMODEL_AMBIENT.xyz; fixed3 diffuse = _LightColor0.rgb * _Diffuse.rgb * max(0, dot(worldNormal, worldLightDir)); fixed3 viewDir = normalize(_WorldSpaceCameraPos.xyz - i.worldPos.xyz); fixed3 halfDir = normalize(worldLightDir + viewDir); fixed3 specular = _LightColor0.rgb * _Specular.rgb * pow(max(0, dot(worldNormal, halfDir)), _Gloss); fixed atten = 1.0;//å…‰ç…§è¡°å‡ fixed shadow = SHADOW_ATTENUATION(i); return fixed4(color * (ambient + (diffuse + specular) * atten * shadow), 1.0); &#125; ENDCG &#125; Pass &#123; Cull Front CGPROGRAM #pragma vertex vert #pragma fragment frag #include &quot;UnityCG.cginc&quot; struct v2f &#123; float4 pos : SV_POSITION; &#125;; float _OutlineWidth; fixed4 _OutlineColor; v2f vert(appdata_tan v) &#123; v2f o; //æŠŠé¡¶ç‚¹è½¬æ¢åˆ°è£å‰ªç©ºé—´ float4 pos = UnityObjectToClipPos(v.vertex); //æŠŠæ³•çº¿è½¬æ¢åˆ°ndcç©ºé—´ float3 ndcNormal = normalize(mul((float3x3)unity_MatrixMVP, v.tangent.xyz)) * pos.w; //å°†è¿‘è£å‰ªé¢å³ä¸Šè§’ä½ç½®çš„é¡¶ç‚¹å˜æ¢åˆ°è§‚å¯Ÿç©ºé—´ float4 nearUpperRight = mul(unity_CameraInvProjection, float2(1, 1)); //æ±‚å¾—å±å¹•å®½é«˜æ¯” const float aspect = abs(nearUpperRight.y / nearUpperRight.x); //ä½¿æ³•çº¿æ–¹å‘æ­£ç¡®é€‚é…å±å¹•å®½é«˜æ¯” ndcNormal.x *= aspect; //é¡¶ç‚¹æ‰©å¼  pos.xy += 0.1 * _OutlineWidth * ndcNormal.xy; o.pos = pos; return o; &#125; float4 frag(v2f i) : SV_Target &#123; return _OutlineColor; &#125; ENDCG &#125; &#125; FallBack &quot;Diffuse&quot;&#125; å¹³æ»‘æ³•çº¿è¿è¡Œæ—¶è„šæœ¬1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859using System.Collections.Generic;using UnityEngine;public class SmoothOutline : MonoBehaviour&#123; Mesh MeshNormalAverage(Mesh mesh) &#123; //å­˜å‚¨é¡¶ç‚¹å’Œå¯¹åº”çš„ç´¢å¼• Dictionary&lt;Vector3, List&lt;int&gt;&gt; map = new Dictionary&lt;Vector3, List&lt;int&gt;&gt;(); for (int v = 0; v &lt; mesh.vertexCount; ++v) &#123; if (!map.ContainsKey(mesh.vertices[v])) &#123; map.Add(mesh.vertices[v], new List&lt;int&gt;()); &#125; map[mesh.vertices[v]].Add(v); &#125; Vector3[] normals = mesh.normals; Vector3 normal; foreach(var p in map) &#123; normal = Vector3.zero; //æ ¹æ®é¡¶ç‚¹æ‰€æœ‰å¯¹åº”ç´¢å¼•è®¡ç®—æ³•çº¿æ€»æ–¹å‘ foreach (var n in p.Value) &#123; normal += mesh.normals[n]; &#125; //å½’ä¸€åŒ– normal /= p.Value.Count; foreach (var n in p.Value) &#123; normals[n] = normal; &#125; &#125; //æŠŠå¹³æ»‘åŽçš„é¡¶ç‚¹æ³•çº¿ä¿¡æ¯å­˜å…¥åˆ‡çº¿ä¿¡æ¯ var tangents = new Vector4[mesh.vertexCount]; for (var j = 0; j &lt; mesh.vertexCount; j++) &#123; tangents[j] = new Vector4(normals[j].x, normals[j].y, normals[j].z, 0); &#125; mesh.tangents= tangents; return mesh; &#125; void Awake() &#123; if (GetComponent&lt;MeshFilter&gt;()) &#123; Mesh tempMesh = (Mesh)Instantiate(GetComponent&lt;MeshFilter&gt;().sharedMesh); tempMesh=MeshNormalAverage(tempMesh); gameObject.GetComponent&lt;MeshFilter&gt;().sharedMesh = tempMesh; &#125; if (GetComponent&lt;SkinnedMeshRenderer&gt;()) &#123; Mesh tempMesh = (Mesh)Instantiate(GetComponent&lt;SkinnedMeshRenderer&gt;().sharedMesh); tempMesh = MeshNormalAverage(tempMesh); gameObject.GetComponent&lt;SkinnedMeshRenderer&gt;().sharedMesh = tempMesh; &#125; &#125;&#125; é¡¹ç›®å·¥ç¨‹ æ›´æ–°æ—¥å¿—2024-04-01 æ›´æ–°åŸºæœ¬å†…å®¹ã€‚","categories":[{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/categories/Unity/"},{"name":"Shader","slug":"Unity/Shader","permalink":"https://busyogg.github.io/categories/Unity/Shader/"}],"tags":[{"name":"Shader","slug":"Shader","permalink":"https://busyogg.github.io/tags/Shader/"},{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/tags/Unity/"}]},{"title":"Cloudflare ä¼˜é€‰ IP","slug":"Cloudflareä¼˜é€‰IP","date":"2024-03-20T11:09:10.000Z","updated":"2024-05-30T12:27:33.047Z","comments":true,"path":"article/8583c53078ec/","link":"","permalink":"https://busyogg.github.io/article/8583c53078ec/","excerpt":"","text":"ç®€ä»‹åˆ©ç”¨ä¼˜é€‰ IP åŠ å¿« Cloudflare çš„è®¿é—®é€Ÿåº¦ï¼Œé˜²æ­¢å› ä¸º IP è¢«å¢™å¯¼è‡´çš„æ— æ³•è®¿é—®æˆ–è€…è®¿é—®ç¼“æ…¢ã€‚ åŽŸç†é€šè¿‡ä¿®æ”¹ Cloudflare çš„ A è®°å½• IP åœ°å€ï¼Œæˆ–è€… CNAME åŸŸååœ°å€ä¸¤ç§æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿å¥—äº† CF çš„ç½‘ç«™çš„è®¿é—®é€Ÿåº¦è¾¾åˆ°æ­£å¸¸çš„æ°´å¹³ã€‚ ä¼˜é€‰ IPé¦–å…ˆæˆ‘ä»¬éœ€è¦ä¸€ä¸ªä¼˜é€‰ IPï¼Œæœ¬æ–‡ä½¿ç”¨ monitor.gacjie.cn æä¾›çš„ API æ¥èŽ·å–ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å…¶ä»–æ–¹å¼èŽ·å–ã€‚ æ‰‹åŠ¨æ›´æ–°çš„æƒ…å†µæˆ‘ä»¬ç›´æŽ¥è®¿é—®è¯¥ç½‘ç«™æŸ¥çœ‹å³å¯ã€‚ æ›´æ–° Cloudflare åŸŸå DNSä¸Šæ–‡è¯´åˆ°æˆ‘ä»¬å¯ä»¥æ›´æ–° A è®°å½•ï¼Œä¹Ÿå¯ä»¥æ›´æ–° CNAMEï¼Œæ­¤å¤„æˆ‘ä»¬é€‰æ‹©æ›´æ–° A è®°å½•ã€‚ è¿›å…¥ç½‘ç«™åŽä¿®æ”¹ç®­å¤´å¤„çš„æ•°æ®ã€‚CNAME çš„ä¿®æ”¹ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡å‰é¢çš„ A è®°å½•æ”¹æˆ CNAMEã€‚ä¿®æ”¹å®ŒæˆåŽä¿å­˜å³å¯ã€‚ ä½ å¯ä»¥é€‰æ‹©è‡ªå·±æƒ³è¦ä¿®æ”¹çš„ç½‘å€ï¼Œæ­¤å¤„æˆ‘ä¿®æ”¹çš„æ˜¯ root è®°å½•ã€‚ å®šæ—¶è‡ªåŠ¨æ›´æ–°è¦å®žçŽ°å®šæ—¶è‡ªåŠ¨æ›´æ–°ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ© Cloudflare çš„ API æ¥ä¿®æ”¹ A è®°å½•ã€‚ åŸºæœ¬æ‰§è¡Œå•å…ƒ æœ¬æ–‡ä½¿ç”¨ python ä»£ç æ¥æ›´æ–°ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889import requestsimport json# Cloudflare API å¯†é’¥API_KEY = &#x27;æœ¬æ–‡ä½¿ç”¨ Global API Key&#x27;# Cloudflare è´¦æˆ·é‚®ç®±EMAIL = &#x27;ä½ çš„ CF è´¦æˆ·é‚®ç®±&#x27;# åŸŸåDOMAIN = &#x27;ä½ çš„åŸŸå&#x27;# A è®°å½•åç§°RECORD_NAME = &#x27;ä½ çš„ A è®°å½•åç§°&#x27;# Cloudflare Zone IDZONE_ID = &#x27;ä½ çš„åŸŸåçš„ ZONE ID&#x27;# Cloudflare API è¯·æ±‚å¤´headers = &#123; &#x27;X-Auth-Email&#x27;: EMAIL, &#x27;X-Auth-Key&#x27;: API_KEY, &#x27;Content-Type&#x27;: &#x27;application/json&#x27;&#125;# å‘é€è¯·æ±‚èŽ·å– IP åœ°å€response = requests.get(&#x27;https://monitor.gacjie.cn/api/client/get_ip_address&#x27;)if response.status_code == 200: data = response.json() if data[&#x27;status&#x27;]: # ä»Žè¿”å›žçš„æ•°æ®ä¸­é€‰æ‹© delay æœ€å°çš„ IP åœ°å€ min_delay_ip = min(data[&#x27;info&#x27;][&#x27;CM&#x27;] + data[&#x27;info&#x27;][&#x27;CU&#x27;] + data[&#x27;info&#x27;][&#x27;CT&#x27;], key=lambda x: x[&#x27;delay&#x27;]) NEW_IP = min_delay_ip[&#x27;ip&#x27;] print(&#x27;API è¯·æ±‚æˆåŠŸ æ–° IP:&#x27;, NEW_IP) else: print(&#x27;API è¯·æ±‚å¤±è´¥ï¼š&#x27;, data[&#x27;msg&#x27;])else: print(&#x27;èŽ·å– IP åœ°å€å¤±è´¥ï¼š&#x27;, response.status_code)# èŽ·å– DNS# Cloudflare API è¯·æ±‚å¤´headers_get = &#123; &#x27;X-Auth-Email&#x27;: EMAIL, &#x27;Content-Type&#x27;: &#x27;application/json&#x27;&#125;url = &#x27;https://api.cloudflare.com/client/v4/zones/&#123;ZONE_ID&#125;/dns_records&#x27;;url = url.replace(&#x27;&#123;ZONE_ID&#125;&#x27;, ZONE_ID)response = requests.request(&quot;GET&quot;, url, headers=headers)resJson = json.loads(response.text)# print(resJson)if resJson[&#x27;result&#x27;]: data = resJson if data[&#x27;result&#x27;]: # ä»Žè¿”å›žçš„æ•°æ®ä¸­é€‰æ‹© åŸŸå for record in data[&#x27;result&#x27;]: if record[&#x27;name&#x27;] == RECORD_NAME and record[&#x27;type&#x27;] == &#x27;A&#x27;: # æ‰¾åˆ°åŒ¹é…çš„è®°å½•ï¼Œæ‰“å°å…¶ ID DNS_ID=record[&#x27;id&#x27;] print(&quot;A è®°å½•åç§°ä¸º&quot;,RECORD_NAME,&quot;çš„ ID ä¸ºï¼š&quot;, record[&#x27;id&#x27;]) break # print(&#x27;DNS è¯·æ±‚æˆåŠŸ :&#x27;, data[&#x27;result&#x27;]) else: print(&#x27;DNS è¯·æ±‚å¤±è´¥ï¼š&#x27;, data[&#x27;msg&#x27;])else: print(&#x27;èŽ·å– DNS å¤±è´¥ï¼š&#x27;, response.status_code)# è®¾ç½® DNS# æž„å»º API è¯·æ±‚ä½“data = &#123; &#x27;type&#x27;: &#x27;A&#x27;, &#x27;name&#x27;: RECORD_NAME, &#x27;content&#x27;: NEW_IP, &quot;proxied&quot;: True&#125;url = &#x27;https://api.cloudflare.com/client/v4/zones/&#123;ZONE_ID&#125;/dns_records/&#123;RECORD_ID&#125;&#x27;url = url.replace(&#x27;&#123;ZONE_ID&#125;&#x27;, ZONE_ID)url = url.replace(&#x27;&#123;RECORD_ID&#125;&#x27;, DNS_ID)# å‘é€ API è¯·æ±‚response = requests.request(&quot;PUT&quot;,url, json=data, headers=headers)# å¤„ç† API å“åº”if response.status_code == 200: print(&#x27;A è®°å½• IP ä¿®æ”¹æˆåŠŸï¼&#x27;)else: print(f&#x27;é”™è¯¯ï¼š&#123;response.status_code&#125; - &#123;response.text&#125;&#x27;) å…¶ä¸­ API_KEY å¯ä»¥åœ¨å¦‚ä¸‹åœ°å€æ‰¾åˆ°ï¼š ZONE_ID å¯ä»¥åœ¨å¦‚ä¸‹åœ°å€æ‰¾åˆ°ï¼š è¿™æ ·æˆ‘ä»¬å°±æœ‰äº†ä¸€ä¸ªåŸºæœ¬æ‰§è¡Œå•å…ƒäº†ã€‚ å®šæ—¶ä»»åŠ¡ ç„¶åŽæˆ‘ä»¬å°±éœ€è¦è®¾ç½®å®šæ—¶ä»»åŠ¡ã€‚æˆ‘ä»¬å¯ä»¥åœ¨æœ¬åœ°æˆ–è€… VPS ä¸Šæ‰§è¡Œå®šæ—¶ä»»åŠ¡ï¼Œä¸è¿‡æœ¬æ–‡é€‰æ‹©æ‰˜ç®¡åˆ° Github ä¸Šï¼Œå¹¶ä½¿ç”¨ Action æ¥å®šæ—¶æ‰§è¡Œä»»åŠ¡ã€‚ è¦å¯ç”¨ Github çš„ Action å·¥ä½œæµï¼Œæˆ‘ä»¬éœ€è¦è¿›è¡Œå¦‚ä¸‹æ­¥éª¤ï¼š åˆ›å»ºä»“åº“ï¼Œå¯ä»¥é€‰æ‹©ç§æœ‰ä»“åº“ã€‚ å…‹éš†é¡¹ç›®åˆ°æœ¬åœ°ï¼Œåœ¨æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª .github æ–‡ä»¶å¤¹ï¼Œç„¶åŽåœ¨ .github æ–‡ä»¶å¤¹é‡Œé¢åˆ›å»ºä¸€ä¸ª workflows æ–‡ä»¶å¤¹ã€‚ åœ¨ workflows æ–‡ä»¶å¤¹åˆ›å»ºä¸€ä¸ª yaml æ–‡ä»¶ï¼Œåå­—éšæ„ã€‚ ç¼–å†™å·¥ä½œæµä»£ç ï¼š 12345678910111213141516171819202122232425name: Update Scripton: # push schedule: - cron: &quot;*/15 * * * *&quot; # æ¯ 15 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡jobs: update: runs-on: ubuntu-latest steps: - name: Checkout repository uses: actions/checkout@v4 - name: Set up Python uses: actions/setup-python@v4 with: python-version: &quot;3.8&quot; # æŒ‡å®š Python ç‰ˆæœ¬ - name: Install dependencies run: pip install -r requirements.txt # å¦‚æžœæœ‰ä¾èµ–ï¼Œéœ€å®‰è£… - name: Execute Python script run: python update.py # è¿è¡Œä½ çš„ Python è„šæœ¬ æŠŠåˆšåˆšçš„ python è„šæœ¬æ”¾åˆ°æ ¹ç›®å½•ä¸‹ï¼Œæ­¤å¤„æˆ‘ python è„šæœ¬çš„åå­—å« updateã€‚ åœ¨æ ¹ç›®å½•æ–°å»º requirements.txt æ–‡ä»¶ï¼Œé‡Œé¢å†™æˆ‘ä»¬éœ€è¦å¼•ç”¨çš„åº“ï¼Œåªéœ€è¦åœ¨é‡Œé¢å†™ requests å°±è¡Œäº†ã€‚ æŽ¨é€åˆ° Githubã€‚ è¿™æ ·æ¯éš” 15 åˆ†é’Ÿå°±ä¼šæ›´æ–°ä¸€æ¬¡ IP äº†ã€‚å¦‚æžœä½ éœ€è¦ä¿®æ”¹é—´éš”æ—¶é—´ï¼Œè¯·æœç´¢ crontab ç›¸å…³å†…å®¹ï¼ŒGithub çš„ cron å’Œ Linux çš„ cron æ˜¯ä¸€è‡´çš„ã€‚ ä»£ç åŸºæœ¬æ‰§è¡Œå•å…ƒ1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889import requestsimport json# Cloudflare API å¯†é’¥API_KEY = &#x27;æœ¬æ–‡ä½¿ç”¨ Global API Key&#x27;# Cloudflare è´¦æˆ·é‚®ç®±EMAIL = &#x27;ä½ çš„ CF è´¦æˆ·é‚®ç®±&#x27;# åŸŸåDOMAIN = &#x27;ä½ çš„åŸŸå&#x27;# A è®°å½•åç§°RECORD_NAME = &#x27;ä½ çš„ A è®°å½•åç§°&#x27;# Cloudflare Zone IDZONE_ID = &#x27;ä½ çš„åŸŸåçš„ ZONE ID&#x27;# Cloudflare API è¯·æ±‚å¤´headers = &#123; &#x27;X-Auth-Email&#x27;: EMAIL, &#x27;X-Auth-Key&#x27;: API_KEY, &#x27;Content-Type&#x27;: &#x27;application/json&#x27;&#125;# å‘é€è¯·æ±‚èŽ·å– IP åœ°å€response = requests.get(&#x27;https://monitor.gacjie.cn/api/client/get_ip_address&#x27;)if response.status_code == 200: data = response.json() if data[&#x27;status&#x27;]: # ä»Žè¿”å›žçš„æ•°æ®ä¸­é€‰æ‹© delay æœ€å°çš„ IP åœ°å€ min_delay_ip = min(data[&#x27;info&#x27;][&#x27;CM&#x27;] + data[&#x27;info&#x27;][&#x27;CU&#x27;] + data[&#x27;info&#x27;][&#x27;CT&#x27;], key=lambda x: x[&#x27;delay&#x27;]) NEW_IP = min_delay_ip[&#x27;ip&#x27;] print(&#x27;API è¯·æ±‚æˆåŠŸ æ–° IP:&#x27;, NEW_IP) else: print(&#x27;API è¯·æ±‚å¤±è´¥ï¼š&#x27;, data[&#x27;msg&#x27;])else: print(&#x27;èŽ·å– IP åœ°å€å¤±è´¥ï¼š&#x27;, response.status_code)# èŽ·å– DNS# Cloudflare API è¯·æ±‚å¤´headers_get = &#123; &#x27;X-Auth-Email&#x27;: EMAIL, &#x27;Content-Type&#x27;: &#x27;application/json&#x27;&#125;url = &#x27;https://api.cloudflare.com/client/v4/zones/&#123;ZONE_ID&#125;/dns_records&#x27;;url = url.replace(&#x27;&#123;ZONE_ID&#125;&#x27;, ZONE_ID)response = requests.request(&quot;GET&quot;, url, headers=headers)resJson = json.loads(response.text)# print(resJson)if resJson[&#x27;result&#x27;]: data = resJson if data[&#x27;result&#x27;]: # ä»Žè¿”å›žçš„æ•°æ®ä¸­é€‰æ‹© åŸŸå for record in data[&#x27;result&#x27;]: if record[&#x27;name&#x27;] == RECORD_NAME and record[&#x27;type&#x27;] == &#x27;A&#x27;: # æ‰¾åˆ°åŒ¹é…çš„è®°å½•ï¼Œæ‰“å°å…¶ ID DNS_ID=record[&#x27;id&#x27;] print(&quot;A è®°å½•åç§°ä¸º&quot;,RECORD_NAME,&quot;çš„ ID ä¸ºï¼š&quot;, record[&#x27;id&#x27;]) break # print(&#x27;DNS è¯·æ±‚æˆåŠŸ :&#x27;, data[&#x27;result&#x27;]) else: print(&#x27;DNS è¯·æ±‚å¤±è´¥ï¼š&#x27;, data[&#x27;msg&#x27;])else: print(&#x27;èŽ·å– DNS å¤±è´¥ï¼š&#x27;, response.status_code)# è®¾ç½® DNS# æž„å»º API è¯·æ±‚ä½“data = &#123; &#x27;type&#x27;: &#x27;A&#x27;, &#x27;name&#x27;: RECORD_NAME, &#x27;content&#x27;: NEW_IP, &quot;proxied&quot;: True&#125;url = &#x27;https://api.cloudflare.com/client/v4/zones/&#123;ZONE_ID&#125;/dns_records/&#123;RECORD_ID&#125;&#x27;url = url.replace(&#x27;&#123;ZONE_ID&#125;&#x27;, ZONE_ID)url = url.replace(&#x27;&#123;RECORD_ID&#125;&#x27;, DNS_ID)# å‘é€ API è¯·æ±‚response = requests.request(&quot;PUT&quot;,url, json=data, headers=headers)# å¤„ç† API å“åº”if response.status_code == 200: print(&#x27;A è®°å½• IP ä¿®æ”¹æˆåŠŸï¼&#x27;)else: print(f&#x27;é”™è¯¯ï¼š&#123;response.status_code&#125; - &#123;response.text&#125;&#x27;) Action å·¥ä½œæµè„šæœ¬12345678910111213141516171819202122232425name: Update Scripton: # push schedule: - cron: &quot;*/15 * * * *&quot; # æ¯ 15 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡jobs: update: runs-on: ubuntu-latest steps: - name: Checkout repository uses: actions/checkout@v4 - name: Set up Python uses: actions/setup-python@v4 with: python-version: &quot;3.8&quot; # æŒ‡å®š Python ç‰ˆæœ¬ - name: Install dependencies run: pip install -r requirements.txt # å¦‚æžœæœ‰ä¾èµ–ï¼Œéœ€å®‰è£… - name: Execute Python script run: python update.py # è¿è¡Œä½ çš„ Python è„šæœ¬ æ›´æ–°æ—¥å¿—2024-03-20 æ›´æ–°åŸºæœ¬å†…å®¹ã€‚","categories":[{"name":"æ•™ç¨‹","slug":"æ•™ç¨‹","permalink":"https://busyogg.github.io/categories/%E6%95%99%E7%A8%8B/"}],"tags":[{"name":"æ•™ç¨‹","slug":"æ•™ç¨‹","permalink":"https://busyogg.github.io/tags/%E6%95%99%E7%A8%8B/"},{"name":"Cloudflare","slug":"Cloudflare","permalink":"https://busyogg.github.io/tags/Cloudflare/"}]},{"title":"Unity-ç¼–è¾‘å™¨ UI å¼€å‘ä¼˜åŒ–æ¡†æž¶ EditorUIExtension IMGUI ç¯‡","slug":"Unity-ç¼–è¾‘å™¨UIå¼€å‘ä¼˜åŒ–æ¡†æž¶EditorUIExtension","date":"2024-03-16T19:59:41.000Z","updated":"2024-05-31T08:26:21.870Z","comments":true,"path":"article/497b56da32cd/","link":"","permalink":"https://busyogg.github.io/article/497b56da32cd/","excerpt":"","text":"ç®€ä»‹åŸºäºŽ IMGUI çš„ç¼–è¾‘å™¨ UI æ¡†æž¶ï¼Œç›®çš„æ˜¯ç®€åŒ–ç¼–è¾‘å™¨å¼€å‘æ—¶çš„ UI æž„å»ºã€‚åˆ©ç”¨ç‰¹æ€§æ ‡ç­¾è¿›è¡Œ UI çš„åˆå§‹åŒ–ã€‚ å¯¹äºŽå˜é‡ï¼Œæˆ‘ä»¬åªéœ€è¦æ‰“ä¸Šå¯¹åº”çš„æ ‡ç­¾ï¼Œå°±èƒ½å¤Ÿåœ¨ UI é¢æ¿ä¸Šæ˜¾ç¤ºå¯¹åº”çš„ UIã€‚ å¯¹äºŽæ–¹æ³•ï¼Œæˆ‘ä»¬åªéœ€è¦æ‰“ä¸Š Button æ ‡ç­¾ï¼Œå°±èƒ½å¤Ÿç”Ÿæˆä¸€ä¸ªå®žçŽ°è¯¥æ–¹æ³•çš„æŒ‰é’®ã€‚ åŒæ—¶ï¼Œæœ¬æ¡†æž¶è¿˜æ”¯æŒå¯¹ UI çš„æ ·å¼å’Œå¸ƒå±€è¿›è¡Œæœ‰é™çš„ä¿®æ”¹ï¼ŒåŒæ ·ä¹Ÿæ˜¯é€šè¿‡ç‰¹æ€§å®žçŽ°ã€‚ UI ç•Œé¢çš„æ¸²æŸ“é¡ºåºæŒ‰ç…§ç¼–è¾‘å™¨è„šæœ¬å¯¹è±¡çš„å£°æ˜Žé¡ºåºæŽ’åºï¼Œå¸ƒå±€çš„ç»“æž„ä¹Ÿè¦æŒ‰ç…§é¡ºåºå£°æ˜Žï¼Œå¯ä»¥çœ‹ä½œæ˜¯ä»¥ä»£ç çš„å½¢å¼ç»˜åˆ¶ UIã€‚ æœ¬æ¡†æž¶æ”¯æŒè‡ªå®šä¹‰æ‹“å±•åŠŸèƒ½ï¼Œå…·ä½“çš„ä½¿ç”¨è¯´æ˜Žå’Œæ‹“å±•è§„åˆ™è§ï¼š EditorUIExtention æ–‡æ¡£ åŽŸç†åˆå§‹åŒ–ç‰¹æ€§æˆ‘ä»¬é€šè¿‡åŸºç±»åˆå§‹åŒ–èŽ·å– Typeï¼Œç„¶åŽé€šè¿‡ Type èŽ·å– members å¹¶ä¸”æŒ‰ç…§å£°æ˜Žé¡ºåºæŽ’åºï¼Œä¹‹åŽé€šè¿‡éåŽ†ï¼Œåœ¨å…¶å¾ªçŽ¯ä½“å†…æ ¹æ®å¯¹åº”çš„ç‰¹æ€§ç±»åˆ«è¿›è¡Œ UI çš„æ¸²æŸ“å‡½æ•°åˆå§‹åŒ–ã€‚ ä¸ºäº†é˜²æ­¢é¢‘ç¹åå°„ï¼Œå› æ­¤æ‰€æœ‰çš„ UI éƒ½åœ¨ç¼–è¾‘å™¨å±•ç¤ºçš„æ—¶å€™æž„é€ ï¼Œæ•°æ®çš„èŽ·å–å’Œå­˜å‚¨éƒ½ä»Žåå°„è½¬ä¸ºå§”æ‰˜ã€‚åˆå› ä¸º IMGUI æž„é€  UI çš„æ–¹æ³•æ— æ³•åœ¨ OnGUI ä»¥å¤–çš„åœ°æ–¹ä½¿ç”¨ï¼Œå› æ­¤æˆ‘ä»¬åœ¨åˆå§‹åŒ–æ—¶å¾—åˆ°çš„æ˜¯æž„é€ å¯¹åº” UI çš„æ–¹æ³•å‡½æ•°ã€‚ ç‰¹æ€§å£°æ˜Žæˆ‘ä»¬åœ¨å®šä¹‰ç‰¹æ€§çš„æ—¶å€™éœ€è¦ä¼ å…¥ä¸€ä¸ª [CallerLineNumber] int ç±»åž‹çš„å˜é‡ï¼Œè¯¥å˜é‡ç”¨äºŽèŽ·å–è°ƒç”¨ç‰¹æ€§æž„é€ å‡½æ•°çš„è¡Œå·ï¼Œå…¶ä¸­ [CallerLineNumber] ä¹Ÿæ˜¯ä¸€ä¸ªç‰¹æ€§ï¼Œç”¨äºŽèŽ·å–è°ƒç”¨æ–¹ä»£ç çš„è¡Œå·ã€‚ åªæœ‰é€šè¿‡è¿™ä¸ªæ–¹æ³•æ‰èƒ½è‡ªåŠ¨èŽ·å–åˆ°æ­£ç¡®çš„å£°æ˜Žé¡ºåºã€‚å¦‚æžœä½ ä¸æƒ³ç”¨è¿™ä¸ªæ–¹æ³•ï¼Œä¹Ÿå¯ä»¥åœ¨ç‰¹æ€§æ˜¾ç¤ºå£°æ˜Žä¸€ä¸ªè¡¨æ˜Žé¡ºåºçš„å˜é‡ï¼Œç„¶åŽæ‰‹åŠ¨ä¼ å‚ï¼Œå¹¶ä¸”ä¿®æ”¹ç¼–è¾‘å™¨åˆå§‹åŒ–å‡½æ•°ä¸­çš„æŽ’åºæ–¹æ³•ã€‚ æ¸²æŸ“æ¸²æŸ“å‡½æ•°åˆå§‹åŒ–UI æ¸²æŸ“ç»“æž„ ä¸ºäº†æ”¯æŒå¸ƒå±€çš„ä¿®æ”¹ï¼Œæˆ‘ä»¬å°±è¦è§„åˆ’å¥½æ•´ä¸ªæ¸²æŸ“çš„ç»“æž„å’Œé¡ºåºã€‚ å¸ƒå±€ä½œä¸ºæœ€å¤–å±‚çš„æ¡†æž¶ï¼Œéœ€è¦æŠŠå±žäºŽè¯¥å¸ƒå±€çš„ UI åŒ…è£¹åœ¨å…¶ä¸­ï¼Œå¹¶ä¸”å¯èƒ½å­˜åœ¨å¸ƒå±€å¥—å¸ƒå±€çš„æƒ…å†µã€‚å› æ­¤æˆ‘ä»¬ä½¿ç”¨æ ‘ç»“æž„æ¥å­˜å‚¨å¸ƒå±€ä»¥åŠå¯¹åº”çš„ UIã€‚ æˆ‘ä»¬æŠŠ UI çš„æ¸²æŸ“å‡½æ•°æˆ–å¸ƒå±€çš„èŠ‚ç‚¹å­˜å‚¨åœ¨åŒä¸€ä¸ª object åˆ—è¡¨ä¸­ï¼Œä»¥ä¾¿åœ¨æ¸²æŸ“æ—¶æŒ‰ç…§æ­£ç¡®çš„é¡ºåºæ¸²æŸ“ã€‚ åŒæ—¶ï¼Œæˆ‘ä»¬è®¾ç½®ä¸€ä¸ªå‡½æ•°å§”æ‰˜ï¼Œç”¨äºŽåœ¨æ¸²æŸ“å¸ƒå±€çš„æ—¶å€™å…ˆæŠŠå¤–å±‚çš„å¸ƒå±€ UI æ¸²æŸ“å¥½ï¼Œç„¶åŽæˆ‘ä»¬å†æ¸²æŸ“å†…éƒ¨çš„å…·ä½“ UIã€‚ UI æ¸²æŸ“å…·ä½“è¿‡ç¨‹ ä¸ºäº†èƒ½å¤Ÿåœ¨ OnGUI ä¹‹å¤–çš„åœ°æ–¹ä½¿ç”¨ GUI ç›¸å…³çš„æ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦æŠŠå…·ä½“çš„æ¸²æŸ“è¡Œä¸ºå°è£…ä¸ºå‡½æ•°ï¼Œä¹‹åŽåœ¨ OnGUI ä¸­æ‰§è¡Œã€‚ æœ¬æ¡†æž¶æŠŠå‡½æ•°æ¸²æŸ“åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š UI æ¸²æŸ“ã€‚ Style æ¸²æŸ“ã€‚ GUILayout æ¸²æŸ“ã€‚ UI æ¸²æŸ“è´Ÿè´£ç”Ÿæˆ UI å¯¹è±¡ï¼ŒStyle æ¸²æŸ“è´Ÿè´£ç”Ÿæˆ GUIStyle å¯¹è±¡ï¼Œè€Œ GUILayout æ¸²æŸ“è´Ÿè´£ç”Ÿæˆ GUILayout æ•°ç»„ã€‚ æœ€åŽåœ¨ç»„åˆ UI çš„æ—¶å€™æŠŠ GUIStyle å’Œ GUILayout æ•°ç»„ä¼ å…¥ UI æ¸²æŸ“å‡½æ•°ã€‚ ä¾‹ï¼š 1234Action&lt;GUIStyle, GUILayoutOption[]&gt; label = (GUIStyle style, GUILayoutOption[] options) =&gt;&#123; GUILayout.Label(labelName(), style, options);&#125;; åœ¨ä¸Šé¢çš„å‡½æ•°ä¸­ï¼ŒUI æ¸²æŸ“å‡½æ•°å°±æ˜¯è¿™ä¸ª Action å§”æ‰˜ï¼ŒStyle æ¸²æŸ“å‡½æ•°åœ¨ OnGUI æ‰§è¡Œä¼ å…¥ GUIStyle style ï¼ŒGUILayout æ¸²æŸ“å‡½æ•°åœ¨ OnGUI æ‰§è¡Œä¼ å…¥ GUILayoutOption[] optionsã€‚æœ€åŽæˆ‘ä»¬æ‰§è¡Œå®Œ UI æ¸²æŸ“å‡½æ•°å°±èƒ½å¤Ÿå¾—åˆ°å¯¹åº”çš„ UIã€‚ å¸ƒå±€æ¸²æŸ“å‡½æ•°çš„åˆå§‹åŒ–éœ€è¦ä¼ å…¥å…·ä½“çš„æ¸²æŸ“æ–¹æ³•ï¼Œé»˜è®¤æœ‰ä¸¤ç§ï¼Œä¸€ç§ NormalRenderï¼›å¦ä¸€ç§æ˜¯ FlexRender ã€‚è¿™ä¸¤ç§éƒ½åœ¨ BaseEditor ä¸­å®šä¹‰ã€‚ä¸€èˆ¬æƒ…å†µä¸‹åªéœ€è¦ç”¨åˆ°ç¬¬ä¸€ç§ï¼Œç¬¬äºŒç§æ˜¯æµå¼å¸ƒå±€ä¸“ç”¨çš„ã€‚å¦‚æžœæœ‰å…¶ä»–éœ€è¦ä¹Ÿå¯ä»¥è‡ªå·±æ–°å¢žæ¸²æŸ“å‡½æ•°ã€‚ å…·ä½“çš„ç”Ÿæˆè¿‡ç¨‹è¯·å‚è€ƒé¡¹ç›®å·¥ç¨‹å’Œé¡¹ç›®æ–‡æ¡£ã€‚ æ¸²æŸ“å‡½æ•°æ‰§è¡Œæ¸²æŸ“å‡½æ•°åœ¨ OnGUI ä¸­æ‰§è¡Œï¼Œåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š å½“å‰å¯¹è±¡ä¸ºå¸ƒå±€èŠ‚ç‚¹ï¼Œåˆ™æ‰§è¡ŒèŠ‚ç‚¹å†…çš„ _layout å‡½æ•°ã€‚ å½“å‰å¯¹è±¡ä¸º UIï¼Œåˆ™æ‰§è¡Œ NormalRenderã€‚ æ¸²æŸ“æ‰§è¡Œå‡½æ•°123456789101112private void Render(LayoutNode node)&#123; if (node._layout != null) &#123; node._layout(); &#125; else &#123; NormalRender(node)(); &#125;&#125; ä»¥ NormalRender æ¥è¯´ï¼ŒéåŽ†å¯¹è±¡ Listï¼Œå¦‚æžœæ˜¯å¸ƒå±€èŠ‚ç‚¹ï¼Œåˆ™é€’å½’è°ƒç”¨ Render æ–¹æ³•æ¸²æŸ“ï¼›å¦‚æžœæ˜¯ UIï¼Œåˆ™æ‰§è¡Œå¯¹åº”çš„æ¸²æŸ“å§”æ‰˜å‡½æ•°ã€‚ æ™®é€šæ¸²æŸ“å‡½æ•°123456789101112131415161718192021222324/// &lt;summary&gt;/// æ™®é€šæ¸²æŸ“/// &lt;/summary&gt;/// &lt;param name=&quot;node&quot;&gt;&lt;/param&gt;/// &lt;returns&gt;&lt;/returns&gt;private Action NormalRender(LayoutNode node)&#123; Action action = () =&gt; &#123; foreach (var ui in node._list) &#123; if (ui is LayoutNode) &#123; Render((LayoutNode)ui); &#125; else &#123; UIListData data = (UIListData)ui; data.action(data.style(), data.options()); &#125; &#125; &#125;; return action;&#125; é¡¹ç›®ç”±äºŽæœ¬é¡¹ç›®ä»£ç è¾ƒå¤šï¼Œå› æ­¤è¯·ç§»æ­¥ GitHub æŸ¥çœ‹è¯¦ç»†ä»£ç ã€‚ æ›´æ–°æ—¥å¿—2024-05-30 ä¿®æ”¹éƒ¨åˆ†è¯´æ˜Žã€‚ 2024-03-18 æ›´æ–°åŸºç¡€å†…å®¹ã€‚","categories":[{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/categories/Unity/"},{"name":"ç¼–è¾‘å™¨","slug":"Unity/ç¼–è¾‘å™¨","permalink":"https://busyogg.github.io/categories/Unity/%E7%BC%96%E8%BE%91%E5%99%A8/"}],"tags":[{"name":"C#","slug":"C","permalink":"https://busyogg.github.io/tags/C/"},{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/tags/Unity/"},{"name":"ç¼–è¾‘å™¨","slug":"ç¼–è¾‘å™¨","permalink":"https://busyogg.github.io/tags/%E7%BC%96%E8%BE%91%E5%99%A8/"},{"name":"æ¡†æž¶","slug":"æ¡†æž¶","permalink":"https://busyogg.github.io/tags/%E6%A1%86%E6%9E%B6/"},{"name":"IMGUI","slug":"IMGUI","permalink":"https://busyogg.github.io/tags/IMGUI/"}]},{"title":"Unity-Inspector åºåˆ—åŒ–å­—å…¸","slug":"Unity-Inspectoråºåˆ—åŒ–å­—å…¸","date":"2024-03-10T15:56:13.000Z","updated":"2024-05-30T12:19:36.207Z","comments":true,"path":"article/e8fee5b5f443/","link":"","permalink":"https://busyogg.github.io/article/e8fee5b5f443/","excerpt":"","text":"ç®€ä»‹ä¼—æ‰€å‘¨çŸ¥ï¼ŒUnity æ— æ³•åœ¨ Inspector é¢æ¿ä¸Šåºåˆ—åŒ–æ˜¾ç¤ºå­—å…¸çš„å†…å®¹ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ç”¨åˆ«çš„æ–¹æ³•æ›²çº¿æ•‘å›½ã€‚ Unity æ˜¯å¯ä»¥åºåˆ—åŒ–æ˜¾ç¤º List çš„ï¼Œå› æ­¤æˆ‘ä»¬çš„ç›®æ ‡å°±æ˜¯ç”¨ List çš„æ–¹å¼æ¥åºåˆ—åŒ–å­—å…¸ã€‚ åŽŸç†ä½¿ç”¨ List æ¨¡æ‹Ÿå­—å…¸çš„é”®å€¼å¯¹ï¼Œå†…éƒ¨ä½¿ç”¨ä¸€ä¸ªå­—å…¸å­˜å‚¨é”®çš„ç´¢å¼•ï¼Œåœ¨è¿è¡Œæ—¶æ›´æ”¹å­—å…¸å¯å°†ä¿®æ”¹åæ˜ åˆ° Listï¼ˆInspectorï¼‰ä¸Šï¼Œå¹¶ä½¿ç”¨ ReorderableList å’Œ PropertyDrawer è‡ªå®šä¹‰ç»˜åˆ¶æ–¹æ³•ã€‚ï¼ˆå‚è€ƒæ–‡çŒ®åŽŸæ–‡ï¼‰ åºåˆ—åŒ–å­—å…¸ç®€å•æ¥è¯´å°±æ˜¯æŠŠå­—å…¸åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š æ–°çš„åºåˆ—åŒ–å­—å…¸ç±»å†…éƒ¨çš„ Listã€‚ ä¸€ä¸ªæ˜¯ List å†…æ¨¡æ‹Ÿé”®å€¼å¯¹çš„ç±»ã€‚ ç„¶åŽ List çš„ç±»åž‹è®¾ä¸ºæ¨¡æ‹Ÿé”®å€¼å¯¹çš„ç±»ã€‚è¿™æ ·æˆ‘ä»¬å°±å¾—åˆ°äº†ä¸€ä¸ªåŸºæœ¬å®¹å™¨ã€‚ ä¸ºäº†æ–¹ä¾¿æ‹“å±•ï¼Œæˆ‘æŠŠåŽŸæ–‡æ¨¡æ‹Ÿé”®å€¼å¯¹çš„ç±»æå–å‡ºæ¥ï¼š SKeyValue1234567891011121314using System;[Serializable]public struct SKeyValue&lt;TKey,TValue&gt;&#123; public TKey Key; public TValue Value; public SKeyValue(TKey key, TValue value) &#123; Key = key; Value = value; &#125;&#125; è¯¥ç±»æ ‡è®°ä¸ºå¯åºåˆ—åŒ–ï¼Œé‡Œé¢çš„å†…å®¹å°±å¯ä»¥åœ¨ Inspector é¢æ¿ä¸Šæ˜¾ç¤ºã€‚ ç„¶åŽæˆ‘ä»¬åœ¨åºåˆ—åŒ–å­—å…¸ç±»ä¸­å®šä¹‰ Listï¼š 1[SerializeField] private List&lt;SKeyValue&lt;TKey,TValue&gt;&gt; list = new List&lt;SKeyValue&lt;TKey, TValue&gt;&gt;(); ç„¶åŽæˆ‘ä»¬éœ€è¦é¢å¤–å®šä¹‰ä¸€ä¸ªå­—å…¸æ¥å­˜å‚¨ Key åœ¨ List ä¸­çš„ç´¢å¼•ã€‚ 1234//å±žæ€§private Dictionary&lt;TKey, int&gt; KeyPositions =&gt; _keyPositions.Value;//æ‡’å­—å…¸private Lazy&lt;Dictionary&lt;TKey, int&gt;&gt; _keyPositions; è¿™æ ·æˆ‘ä»¬å¯¹äºŽå­—å…¸çš„æ“ä½œå°±å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š èŽ·å– Key åœ¨ List ä¸­çš„ç´¢å¼•ã€‚ èŽ·å–å¯¹åº”ç´¢å¼•çš„ Valueã€‚ å…¶ä»–æ“ä½œå°±å’Œæ™®é€šçš„å­—å…¸ä¸€æ ·äº†ã€‚ é¢æ¿ç»˜åˆ¶å¦‚æžœä½¿ç”¨é»˜è®¤çš„ç»˜åˆ¶ï¼ŒValue å€¼å¦‚æžœæ˜¯åµŒå¥—çš„åˆ—è¡¨æˆ–å­—å…¸ï¼Œå°±ä¼šé¢å¤–å¤šå‡ºä¸€ä¸ª List æ ‡è¯†ã€‚ åŽŸæ–‡ä¾‹å›¾ è¦åŽ»æŽ‰ Listï¼Œæˆ‘ä»¬å°±éœ€è¦è‡ªå·±é‡æ–°ç»˜åˆ¶é¢æ¿ã€‚ åˆ©ç”¨ EditorGUI.PropertyField æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ç»˜åˆ¶å‡ºå¯¹åº”ç±»åž‹çš„é¢æ¿ã€‚ æˆ‘ä»¬è¿˜è¦é‡å†™ GetPropertyHeight æ–¹æ³•ï¼Œä½¿å…¶èƒ½å¤Ÿé€’å½’çš„èŽ·å–å±žæ€§çš„é«˜åº¦ã€‚ 123public override float GetPropertyHeight(SerializedProperty property, GUIContent label) &#123; return EditorGUI.GetPropertyHeight(getListProperty(property), true); &#125; æœ€åŽçš„æ•ˆæžœå°±æ˜¯è¿™æ ·ï¼š åŽŸæ–‡ä¾‹å›¾ ç•ªå¤–Unity çš„ List åœ¨åµŒå¥—çš„æƒ…å†µä¸‹ä¹Ÿæ— æ³•åœ¨é¢æ¿ä¸Šè¿›è¡Œåºåˆ—åŒ–ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä»¿ç…§åºåˆ—åŒ–å­—å…¸çš„åšæ³•å®šä¹‰åºåˆ—åŒ– Listã€‚ å®šä¹‰å€¼ç±»ï¼š 123456789101112using System;[Serializable]public struct SValue&lt;TValue&gt;&#123; public TValue Value; public SValue(TValue value) &#123; Value = value; &#125;&#125; åºåˆ—åŒ– List ä¸éœ€è¦å­˜å‚¨ Key ç´¢å¼•ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦ [SerializeField] private List&lt;SValue&lt;TValue&gt;&gt; list = new List&lt;SValue&lt;TValue&gt;&gt;(); æ³¨æ„ å¦‚æžœä½ ä¸éœ€è¦å¯¹é¢æ¿è¿›è¡Œé¢å¤–æ‹“å±•çš„è¯ï¼Œå¯ä»¥ç›´æŽ¥ä½¿ç”¨åŽŸæ–‡çš„ä»£ç ã€‚ éœ€è¦åºåˆ—åŒ–å¤æ‚çš„æ•°æ®ä¸è¦ç”¨ Unity åŽŸç”Ÿçš„ Dictionary å’Œ List ä½œä¸ºç±»åž‹ä¼ é€’ã€‚ ä»£ç æ ‡è®°ä¸º Editor çš„éœ€è¦æ”¾åœ¨ Editor æ–‡ä»¶å¤¹ä¸‹ã€‚ åºåˆ—åŒ–å­—å…¸åºåˆ—åŒ– ListSKeyValue1234567891011121314using System;[Serializable]public struct SKeyValue&lt;TKey,TValue&gt;&#123; public TKey Key; public TValue Value; public SKeyValue(TKey key, TValue value) &#123; Key = key; Value = value; &#125;&#125; SDictionary123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160using System;using System.Collections;using System.Collections.Generic;using System.Linq;using UnityEngine;public class SDictionary &#123; &#125;[Serializable]public class SDictionary&lt;TKey, TValue&gt; : SDictionary, ISerializationCallbackReceiver, IDictionary&lt;TKey, TValue&gt;&#123; [SerializeField] private List&lt;SKeyValue&lt;TKey,TValue&gt;&gt; list = new List&lt;SKeyValue&lt;TKey, TValue&gt;&gt;(); private Dictionary&lt;TKey, int&gt; KeyPositions =&gt; _keyPositions.Value; private Lazy&lt;Dictionary&lt;TKey, int&gt;&gt; _keyPositions; public SDictionary() &#123; _keyPositions = new Lazy&lt;Dictionary&lt;TKey, int&gt;&gt;(MakeKeyPositions); &#125; private Dictionary&lt;TKey, int&gt; MakeKeyPositions() &#123; var dictionary = new Dictionary&lt;TKey, int&gt;(list.Count); for (var i = 0; i &lt; list.Count; i++) &#123; dictionary[list[i].Key] = i; &#125; return dictionary; &#125; public void OnBeforeSerialize() &#123; &#125; public void OnAfterDeserialize() &#123; _keyPositions = new Lazy&lt;Dictionary&lt;TKey, int&gt;&gt;(MakeKeyPositions); &#125; #region IDictionary&lt;TKey, TValue&gt; public TValue this[TKey key] &#123; get =&gt; list[KeyPositions[key]].Value; set &#123; var pair = new SKeyValue&lt;TKey,TValue&gt;(key, value); if (KeyPositions.ContainsKey(key)) &#123; list[KeyPositions[key]] = pair; &#125; else &#123; KeyPositions[key] = list.Count; list.Add(pair); &#125; &#125; &#125; public ICollection&lt;TKey&gt; Keys =&gt; list.Select(tuple =&gt; tuple.Key).ToArray(); public ICollection&lt;TValue&gt; Values =&gt; list.Select(tuple =&gt; tuple.Value).ToArray(); public void Add(TKey key, TValue value) &#123; if (KeyPositions.ContainsKey(key)) throw new ArgumentException(&quot;An element with the same key already exists in the dictionary.&quot;); else &#123; KeyPositions[key] = list.Count; list.Add(new SKeyValue&lt;TKey, TValue&gt;(key, value)); &#125; &#125; public bool ContainsKey(TKey key) =&gt; KeyPositions.ContainsKey(key); public bool Remove(TKey key) &#123; if (KeyPositions.TryGetValue(key, out var index)) &#123; KeyPositions.Remove(key); list.RemoveAt(index); for (var i = index; i &lt; list.Count; i++) KeyPositions[list[i].Key] = i; return true; &#125; else return false; &#125; public bool TryGetValue(TKey key, out TValue value) &#123; if (KeyPositions.TryGetValue(key, out var index)) &#123; value = list[index].Value; return true; &#125; else &#123; value = default; return false; &#125; &#125; #endregion #region ICollection &lt;KeyValuePair&lt;TKey, TValue&gt;&gt; public int Count =&gt; list.Count; public bool IsReadOnly =&gt; false; public void Add(KeyValuePair&lt;TKey, TValue&gt; kvp) =&gt; Add(kvp.Key, kvp.Value); public void Clear() =&gt; list.Clear(); public bool Contains(KeyValuePair&lt;TKey, TValue&gt; kvp) =&gt; KeyPositions.ContainsKey(kvp.Key); public void CopyTo(KeyValuePair&lt;TKey, TValue&gt;[] array, int arrayIndex) &#123; var numKeys = list.Count; if (array.Length - arrayIndex &lt; numKeys) throw new ArgumentException(&quot;arrayIndex&quot;); for (var i = 0; i &lt; numKeys; i++, arrayIndex++) &#123; var entry = list[i]; array[arrayIndex] = new KeyValuePair&lt;TKey, TValue&gt;(entry.Key, entry.Value); &#125; &#125; public bool Remove(KeyValuePair&lt;TKey, TValue&gt; kvp) =&gt; Remove(kvp.Key); public Dictionary&lt;TKey, TValue&gt; ToDictionary() &#123; Dictionary&lt;TKey, TValue&gt; dic = new Dictionary&lt;TKey, TValue&gt;(); foreach(var kvp in list) &#123; dic.Add(kvp.Key, kvp.Value); &#125; return dic; &#125; #endregion #region IEnumerable &lt;KeyValuePair&lt;TKey, TValue&gt;&gt; public IEnumerator&lt;KeyValuePair&lt;TKey, TValue&gt;&gt; GetEnumerator() &#123; return list.Select(ToKeyValuePair).GetEnumerator(); static KeyValuePair&lt;TKey, TValue&gt; ToKeyValuePair(SKeyValue&lt;TKey, TValue&gt; skvp) &#123; return new KeyValuePair&lt;TKey, TValue&gt;(skvp.Key, skvp.Value); &#125; &#125; IEnumerator IEnumerable.GetEnumerator() =&gt; GetEnumerator(); #endregion&#125; Editor SDictionaryDrawer123456789101112131415161718192021using UnityEngine;using UnityEditor;[CustomPropertyDrawer(typeof(SDictionary&lt;,&gt;))]public class SDictionaryDrawer : PropertyDrawer&#123; private SerializedProperty listProperty; private SerializedProperty getListProperty(SerializedProperty property) =&gt; listProperty ??= property.FindPropertyRelative(&quot;list&quot;); public override void OnGUI(Rect position, SerializedProperty property, GUIContent label) &#123; EditorGUI.PropertyField(position, getListProperty(property), label, true); &#125; public override float GetPropertyHeight(SerializedProperty property, GUIContent label) &#123; return EditorGUI.GetPropertyHeight(getListProperty(property), true); &#125;&#125;SValue12345678910111213using System;[Serializable]public struct SValue&lt;TValue&gt;&#123; public TValue Value; public SValue(TValue value) &#123; Value = value; &#125;&#125; SList123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137using System;using System.Collections;using System.Collections.Generic;using System.Linq;using System.Runtime.InteropServices.WindowsRuntime;using UnityEngine;[Serializable]public class SList&lt;TValue&gt; : ISerializationCallbackReceiver, IList&lt;TValue&gt;&#123; [SerializeField] private List&lt;SValue&lt;TValue&gt;&gt; list = new List&lt;SValue&lt;TValue&gt;&gt;(); public SList() &#123; &#125; public void OnBeforeSerialize() &#123; &#125; public void OnAfterDeserialize() &#123; &#125; public int Count =&gt; list.Count; public bool IsReadOnly =&gt; false; public TValue this[int index] &#123; get =&gt; list[index].Value; set &#123; if (index &lt; list.Count) &#123; SValue&lt;TValue&gt; v = list[index]; v.Value = value; list[index] = v; &#125; else &#123; list.Add(new SValue&lt;TValue&gt;(value)); &#125; &#125; &#125; #region IEnumerable &lt;KeyValuePair&lt;TKey, TValue&gt;&gt; public IEnumerator&lt;TValue&gt; GetEnumerator() &#123; return list.Select(ToKeyValuePair).GetEnumerator(); static TValue ToKeyValuePair(SValue&lt;TValue&gt; sb) &#123; return sb.Value; &#125; &#125; IEnumerator IEnumerable.GetEnumerator() =&gt; GetEnumerator(); #endregion public int IndexOf(TValue item) &#123; for (int i = 0; i &lt; list.Count; i++) &#123; if (list[i].Value.Equals(item)) &#123; return i; &#125; &#125; return -1; &#125; public void Insert(int index, TValue item) &#123; list.Insert(index, new SValue&lt;TValue&gt;(item)); &#125; public void RemoveAt(int index) &#123; list.RemoveAt(index); &#125; public void Add(TValue item) &#123; list.Add(new SValue&lt;TValue&gt;(item)); &#125; public void Clear() &#123; list.Clear(); &#125; public bool Contains(TValue item) &#123; int res = IndexOf(item); return res != -1; &#125; public void CopyTo(TValue[] array, int arrayIndex) &#123; var numKeys = list.Count; if (array.Length - arrayIndex &lt; numKeys) throw new ArgumentException(&quot;arrayIndex&quot;); for (var i = 0; i &lt; numKeys; i++, arrayIndex++) &#123; var entry = list[i]; array[arrayIndex] = entry.value; &#125; &#125; public bool Remove(TValue item) &#123; int res = IndexOf(item); if (res != -1) &#123; list.RemoveAt(res); return true; &#125; return false; &#125; public List&lt;TValue&gt; ToList() &#123; List&lt;TValue&gt; l = new List&lt;TValue&gt;(); foreach (var item in list) &#123; l.Add(item.Value); &#125; return l; &#125;&#125; Editor SListDrawer123456789101112131415161718192021using UnityEngine;using UnityEditor;[CustomPropertyDrawer(typeof(SList&lt;&gt;))]public class SListDrawer : PropertyDrawer&#123; private SerializedProperty listProperty; private SerializedProperty getListProperty(SerializedProperty property) =&gt; listProperty ??= property.FindPropertyRelative(&quot;list&quot;); public override void OnGUI(Rect position, SerializedProperty property, GUIContent label) &#123; EditorGUI.PropertyField(position, getListProperty(property), label, true); &#125; public override float GetPropertyHeight(SerializedProperty property, GUIContent label) &#123; return EditorGUI.GetPropertyHeight(getListProperty(property), true); &#125;&#125; é¡¹ç›®å·¥ç¨‹ æ›´æ–°æ—¥å¿— 2024-03-22 ä¿®å¤ SList æ–¹æ³• CopyTo é”™è¯¯ã€‚ 2024-03-11 æ–°å¢žåŸºæœ¬å†…å®¹ã€‚","categories":[{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/categories/Unity/"},{"name":"è§£å†³æ–¹æ¡ˆ","slug":"Unity/è§£å†³æ–¹æ¡ˆ","permalink":"https://busyogg.github.io/categories/Unity/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"}],"tags":[{"name":"C#","slug":"C","permalink":"https://busyogg.github.io/tags/C/"},{"name":"Untiy","slug":"Untiy","permalink":"https://busyogg.github.io/tags/Untiy/"},{"name":"ç¼–è¾‘å™¨","slug":"ç¼–è¾‘å™¨","permalink":"https://busyogg.github.io/tags/%E7%BC%96%E8%BE%91%E5%99%A8/"},{"name":"åºåˆ—åŒ–","slug":"åºåˆ—åŒ–","permalink":"https://busyogg.github.io/tags/%E5%BA%8F%E5%88%97%E5%8C%96/"},{"name":"å­—å…¸","slug":"å­—å…¸","permalink":"https://busyogg.github.io/tags/%E5%AD%97%E5%85%B8/"}]},{"title":"Unity-ECS æ¡†æž¶","slug":"Unity-ECSæ¡†æž¶","date":"2024-03-07T16:03:54.000Z","updated":"2024-05-30T12:29:01.952Z","comments":true,"path":"article/2f23b744011e/","link":"","permalink":"https://busyogg.github.io/article/2f23b744011e/","excerpt":"","text":"ç®€ä»‹ECS æž¶æž„æ˜¯ å®žä½“ï¼ˆEntityï¼‰- ç»„ä»¶ï¼ˆComponentï¼‰- ç³»ç»Ÿï¼ˆSystemï¼‰ç»„æˆçš„æž¶æž„ï¼Œä¸»è¦ç›®çš„æ˜¯å¯¹æ•°æ®å’Œé€»è¾‘è¿›è¡Œè§£è€¦ä»¥ä¾¿æ›´å¥½çš„ç»´æŠ¤ç³»ç»Ÿã€‚å…¶è¿è¡Œçš„åŽŸç†ä¹Ÿèƒ½æé«˜ CPU çš„ç¼“å­˜å‘½ä¸­ï¼Œå³å¯ä»¥æé«˜æ¸¸æˆè¿è¡Œçš„æ€§èƒ½ã€‚ åŽŸç†ECS æž¶æž„ç®€å•æ¥è¯´å°±æ˜¯ç”¨å®žä½“æ¥ç»„åˆç»„ä»¶ï¼Œç”¨ç»„ä»¶æ¥ä¿å­˜æ•°æ®ï¼Œç”¨ç³»ç»Ÿæ¥è¿›è¡Œè¿ç®—ã€‚å•ä¸€çš„å®žä½“æ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼Œåªæœ‰åœ¨ç»„åˆç»„ä»¶ä¹‹åŽè¿™ä¸ªå®žä½“æ‰æœ‰æ„ä¹‰ã€‚ç»„ä»¶åªèƒ½ç”¨äºŽä¿å­˜æ•°æ®ï¼Œä¸èƒ½è‡ªå·±è¿›è¡Œä»»ä½•çš„è¿ç®—ã€‚ç³»ç»Ÿåªè´Ÿè´£è¿ç®—ï¼Œä¸ä¼šæŒä¹…åŒ–ä¿å­˜ä»»ä½•æ•°æ®ã€‚è¿™æ ·å°±æŠŠæ•°æ®å’Œé€»è¾‘åˆ†ç¦»å¼€æ¥ï¼Œé€šè¿‡ç»„åˆçš„æ–¹å¼å®žçŽ°ç‰¹å®šçš„åŠŸèƒ½ï¼Œå®žçŽ°æ•°æ®å’Œé€»è¾‘çš„è§£è€¦ï¼Œä»¥åŠé€»è¾‘ä¸Žé€»è¾‘ä¹‹é—´çš„è§£è€¦ã€‚ å¤§è‡´ç¤ºæ„å›¾å¦‚ä¸‹ï¼š ç»„ä»¶ç»„ä»¶æ˜¯ ECS æž¶æž„çš„åŸºç¡€ï¼Œå®žä½“éœ€è¦ç»„ä»¶ï¼Œç³»ç»Ÿä¹Ÿæ ¹æ®ç»„ä»¶å¤„ç†é€»è¾‘ã€‚ç»„ä»¶çš„è®¾è®¡å¾ˆç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦ä»¥ä¸‹åŸºç¡€å±žæ€§å’Œæ–¹æ³•ï¼š ç»„ä»¶ idï¼Œæ¯ä¸ªç»„ä»¶éƒ½æ‹¥æœ‰ä¸€ä¸ªå±žäºŽè‡ªå·±çš„ idï¼Œè¿™ä¸ª id æ˜¯å…¨å±€å”¯ä¸€çš„ã€‚ ç»„ä»¶åï¼Œæ¯ä¸ªç»„ä»¶éƒ½æ‹¥æœ‰ä¸€ä¸ªå±žäºŽè‡ªå·±çš„åå­—ï¼Œè¿™ä¸ªåå­—æ˜¯å…¨å±€å”¯ä¸€çš„ã€‚ æ˜¯å¦å¯ä»¥è¢«å›žæ”¶ï¼Œæœ‰äº›ç»„ä»¶åœ¨å®žä½“ç§»é™¤åŽéœ€è¦å›žæ”¶ï¼Œæœ‰äº›åˆ™ä¸ä»Žå®žä½“å›žæ”¶ã€‚ é‡ç½®æ–¹æ³•ï¼Œç”¨äºŽå›žæ”¶ç»„ä»¶ä¹‹åŽè¿›è¡Œç»„ä»¶çš„é‡ç½®ã€‚ å› æ­¤æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªç»„ä»¶æŠ½è±¡ç±» Compï¼ŒComp ç±»ä¸å…³å¿ƒç»„ä»¶çš„å…·ä½“ä¿¡æ¯ï¼Œåªå…³å¿ƒç»„ä»¶çš„åŸºæœ¬å±žæ€§ã€ç»„ä»¶çš„åˆå§‹åŒ–å’Œé‡ç½®æ–¹æ³•ã€‚ Comp12345678910public abstract class Comp&#123; public int compId &#123; get; set; &#125; public string compName &#123; get; set; &#125; public Comp() &#123; Reset(); &#125; public abstract void Reset();&#125; ç„¶åŽæˆ‘ä»¬å°±å¯ä»¥å®šä¹‰å®žé™…çš„ Comp ç±»æ¥ä¿å­˜æˆ‘ä»¬éœ€è¦çš„æ•°æ®ã€‚ å®žä½“å®žä½“æ˜¯ç»„ä»¶çš„åˆé›†ï¼Œè™½ç„¶å®žä½“çš„æ¦‚å¿µå¾ˆç®€å•ï¼Œä½†æ˜¯å®žä½“çš„å®žçŽ°å´æ¯”è¾ƒå¤æ‚ã€‚å®žä½“éœ€è¦å®žçŽ°ç»„ä»¶çš„æ·»åŠ å’Œç§»é™¤ï¼Œä¹Ÿè¦åœ¨æ·»åŠ ç§»é™¤ç»„ä»¶çš„æ—¶å€™é€šçŸ¥å¯¹åº”ç³»ç»Ÿè¿›è¡Œå¤„ç†ï¼ŒåŒæ—¶å®žä½“ä¹Ÿè¦æä¾›ç»„ä»¶çš„æŸ¥è¯¢åŠŸèƒ½ã€‚å½“ç„¶ï¼Œå®žä½“è‡ªèº«ä¹Ÿè¦æä¾›ç§»é™¤çš„æ–¹æ³•ã€‚ æŽ©ç å·¥å…·ç”±äºŽå®žä½“éœ€è¦æŸ¥è¯¢ç»„ä»¶ï¼Œç³»ç»Ÿä¹Ÿéœ€è¦æŸ¥è¯¢ç»„ä»¶ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å…ˆè®¾è®¡å¯¹åº”çš„åŠŸèƒ½ã€‚æ­¤å¤„æˆ‘ä»¬é€‰æ‹©ç”¨äºŒè¿›åˆ¶æ•°æ¥åˆ¶ä½œæŽ©ç ç³»ç»Ÿä¿å­˜ç»„ä»¶ä¿¡æ¯ã€‚ è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªäºŒè¿›åˆ¶æ•°ç»„æ¥ä¿å­˜ï¼Œç”¨æ•°ç»„çš„ç›®çš„æ˜¯å¦‚æžœç»„ä»¶æ•°è¶…è¿‡äºŒè¿›åˆ¶æ•°å¤§å°ï¼Œå°±åœ¨æ•°ç»„å¢žåŠ ä¸€ä¸ªäºŒè¿›åˆ¶æ•°æ¥ä¿å­˜ã€‚åœ¨ 32 ä½äºŒè¿›åˆ¶æ•°ä¸­ï¼Œç”±äºŽä¸Žï¼ˆ&amp;ï¼‰æ“ä½œç¬¦æœ€å¤§åªèƒ½æ“ä½œ 30 ä½æ•°ï¼ˆä¸€ä½ç¬¦å·ä½ï¼Œä¸€ä½è¿›ä½ï¼‰ï¼Œå› æ­¤ä¸€ä¸ªæ•°åªä¿å­˜ 30 ä¸ªç»„ä»¶ã€‚ ç”±äºŽç»„ä»¶çš„æ•°é‡åœ¨æ¸¸æˆçš„æœ€å¼€å§‹å°±åˆå§‹åŒ–å®Œæˆï¼Œå› æ­¤ Mask å®žä¾‹çš„ç»„ä»¶æ€»æ•°æ˜¯å›ºå®šçš„ã€‚ å½“æˆ‘ä»¬è¿›è¡ŒæŽ©ç è¿ç®—æ—¶ï¼Œä¼ å…¥çš„ç»„ä»¶ id è½¬ä¸ºäºŒè¿›åˆ¶æ•°å’Œå½“å‰çš„æŽ©ç è¿›è¡Œæ¯”è¾ƒï¼Œä¾‹å¦‚æˆ‘ä»¬è®¾ç½®ç»„ä»¶æ—¶ï¼Œå‡è®¾å½“å‰æŽ©ç ä¸º 0000 0000 0000 0000 ï¼Œä¼ å…¥çš„ç»„ä»¶ id ä¸º 3ï¼Œåˆ™æˆ‘ä»¬æŠŠç»„ä»¶ id åŒ–ä¸º 1 &lt;&lt; (3 % 31)ï¼Œå³ 1 å·¦ç§» 3 ä½ï¼Œå¾—åˆ° 1000 ï¼Œ0000 0000 0000 0000 &amp; 1000 = 0000 0000 0000 1000ï¼Œæœ€ç»ˆçš„ç»„ä»¶å°±ä¿å­˜ä¸‹æ¥äº†ã€‚ ä¹Ÿå°±æ˜¯è¯´ 32 ä½æŽ©ç å°±æ˜¯æ’æ§½ï¼Œç»„ä»¶çš„ id å°±æ˜¯å¾€å“ªä¸ªæ’æ§½æ’å…¥ç»„ä»¶ï¼Œè¿™æ ·å°±èƒ½è¡¨ç¤ºä¿å­˜çš„ç»„ä»¶äº†ã€‚ ECSMask123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566using System.Collections.Generic;using UnityEngine;public class ECSMask&#123; private List&lt;int&gt; _mask; private int _size; public ECSMask() &#123; _size = Mathf.CeilToInt(ECSManager.Ins().GetTotalCompNum() / 31f); _mask = new List&lt;int&gt;(_size); int data = 0; _mask.Add(data); &#125; public void Set(int id) &#123; _mask[id / 31] |= (1 &lt;&lt; (id % 31)); &#125; public void Remove(int id) &#123; _mask[id / 31] &amp;= ~(1 &lt;&lt; (id % 31)); &#125; public bool Has(int id) &#123; return (_mask[id / 31] &amp; (1 &lt;&lt; (id % 31))) &gt; 0; &#125; //å’Œå…¶ä»–maskæ¯”è¾ƒ public bool Or(ECSMask other) &#123; for (int i = 0; i &lt; _size; ++i) &#123; if ((_mask[i] &amp; other._mask[i]) &gt; 0) &#123; return true; &#125; &#125; return false; &#125; public bool And(ECSMask other) &#123; for (int i = 0; i &lt; _size; ++i) &#123; if ((_mask[i] &amp; other._mask[i]) != _mask[i]) &#123; return false; &#125; &#125; return true; &#125; public void Clear() &#123; for(int i = 0; i &lt; _size; ++i) &#123; _mask[i] = 0; &#125; &#125;&#125; ç­›é€‰å·¥å…·å› ä¸ºç³»ç»Ÿä»¥å®žä½“è¿›è¡ŒéåŽ†çš„ï¼Œæ‰€ä»¥æœ‰äº†æŽ©ç ä¹‹åŽï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯¹å®žä½“è¿›è¡Œç­›é€‰äº†ï¼Œé€šè¿‡æ¯”è¾ƒå®žä½“çš„ç»„ä»¶æŽ©ç å’Œç­›é€‰å·¥å…·çš„ç»„ä»¶æŽ©ç ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç­›é€‰å‡ºç³»ç»Ÿéœ€è¦çš„å®žä½“ã€‚ é¦–å…ˆæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªåŒ¹é…è§„åˆ™ç±»ï¼ŒåŒ¹é…è§„åˆ™ç±»çš„æž„é€ å‡½æ•°æ ¹æ®ä¼ å…¥çš„è§„åˆ™å’Œç»„ä»¶è®¾ç½®æŽ©ç ï¼Œå¹¶ä¸”æŒ‰é¡ºåºä¿å­˜ç»„ä»¶ idã€‚ åˆ¤æ–­æ˜¯å¦åŒ¹é…åªéœ€è¦è°ƒç”¨æŽ©ç å®šä¹‰çš„è§„åˆ™å³å¯ã€‚ ECSRule12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273using System;using System.Collections.Generic;/// &lt;summary&gt;/// ECSè§„åˆ™åŒ¹é…ç±»åž‹/// &lt;/summary&gt;public enum ECSRuleType&#123; AllOf, AnyOf, ExcludeOf&#125;public class ECSRule&#123; int compId = -1; private ECSMask _mask = new ECSMask(); private ECSRuleType _type; private List&lt;int&gt; _compIds = new List&lt;int&gt;(); public ECSRule(ECSRuleType ecsType, params Type[] comps) &#123; _type = ecsType; foreach (var comp in comps) &#123; compId = ECSManager.Ins().GetCompId(comp); if (compId == -1) &#123; ConsoleUtils.Warn(&quot;å­˜åœ¨æœªæ³¨å†Œç»„ä»¶&quot;, compId); &#125; else &#123; _mask.Set(compId); _compIds.Add(compId); &#125; &#125; if(_compIds.Count &gt; 0) &#123; _compIds.Sort((a,b) =&gt; &#123; return a.CompareTo(b); &#125;); &#125; &#125; public List&lt;int&gt; GetCompIds() &#123; return _compIds; &#125; /// &lt;summary&gt; /// æ˜¯å¦åŒ¹é… /// &lt;/summary&gt; /// &lt;param name=&quot;entity&quot;&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool isMatch(Entity entity) &#123; switch (_type) &#123; case ECSRuleType.AllOf: return _mask.And(entity.mask); case ECSRuleType.AnyOf: return _mask.Or(entity.mask); case ECSRuleType.ExcludeOf: return !_mask.Or(entity.mask); &#125; return false; &#125;&#125; ç„¶åŽæˆ‘ä»¬å®šä¹‰åŒ¹é…å™¨ï¼ŒåŒ¹é…å™¨å¯ä»¥åŒ…å«å¤æ•°è§„åˆ™ï¼Œå³åŒ¹é…å™¨æ˜¯è§„åˆ™çš„é›†åˆï¼Œæ˜¯æ‰€æœ‰åŒ¹é…çš„å®žé™…æ‰§è¡Œç±»ã€‚åŒ¹é…å™¨ä¹Ÿéœ€è¦ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ idï¼Œç»™åŽé¢çš„ Group ä½¿ç”¨ã€‚ ECSMatcher1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677using System;using System.Collections.Generic;using System.Linq;public class ECSMatcher&#123; public static int _matcherId = 0; public int _mid = _matcherId++; private List&lt;ECSRule&gt; _rules = new List&lt;ECSRule&gt;(); public ECSMatcher AnyOf(params Type[] comps) &#123; _rules.Add(new ECSRule(ECSRuleType.AnyOf, comps)); return this; &#125; public ECSMatcher AllOf(params Type[] comps) &#123; _rules.Add(new ECSRule(ECSRuleType.AllOf, comps)); return this; &#125; public ECSMatcher ExcludeOf(params Type[] comps) &#123; _rules.Add(new ECSRule(ECSRuleType.ExcludeOf, comps)); return this; &#125; public ECSMatcher OnlyOf(params Type[] comps) &#123; _rules.Add(new ECSRule(ECSRuleType.AllOf, comps)); List&lt;Type&gt; compList = new List&lt;Type&gt;(); foreach (var comp in comps) &#123; if (!comps.Contains(comp)) &#123; compList.Add(comp); &#125; &#125; Type[] compArray = compList.ToArray(); _rules.Add(new ECSRule(ECSRuleType.ExcludeOf,compArray)); return this; &#125; public bool IsMatch(Entity entity) &#123; foreach (var rule in _rules) &#123; if (!rule.isMatch(entity)) &#123; return false; &#125; &#125; return true; &#125; public List&lt;int&gt; GetCompIds() &#123; List&lt;int&gt; result = null; foreach (var rule in _rules) &#123; List&lt;int&gt; ids = rule.GetCompIds(); if(result == null) &#123; result = ids; &#125; else &#123; result.AddRange(ids); &#125; &#125; return result; &#125;&#125; å¤§è‡´çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤º å®žä½“ç±»çŽ°åœ¨æˆ‘ä»¬å¯ä»¥å®žçŽ°å®žä½“ç±»äº†ã€‚ å¤§æ¦‚çš„æ€è·¯å¦‚å›¾æ‰€ç¤ºï¼ˆæœ¬å›¾ä¸º TS ç‰ˆæœ¬ï¼ŒUnity ç‰ˆæœ¬æ²¡æœ‰é‡æ–°æ·»åŠ ç»„ä»¶ï¼Œä¹Ÿæ²¡æœ‰è®¾ç½®ç»„ä»¶å®žä¾‹ä¸º nullï¼‰ é¦–å…ˆæ˜¯ç»„ä»¶çš„å¢žåŠ ã€‚ æˆ‘ä»¬è®¾ç½®ä¸€ä¸ªå­—å…¸ _compsInEntity æ¥ä¿å­˜å½“å‰å®žä½“çš„ç»„ä»¶ï¼Œè®¾ç½®ä¸€ä¸ªå­—å…¸ _compsRemoved ç”¨æ¥ä¿å­˜å·²ç»ç§»é™¤ä½†æ²¡æœ‰å›žæ”¶çš„ç»„ä»¶ã€‚ é¦–å…ˆæˆ‘ä»¬åˆ¤æ–­ç»„ä»¶æ˜¯å¦å·²æ³¨å†Œï¼Œå·²æ³¨å†Œå¹¶ä¸”å·²å­˜åœ¨çš„æƒ…å†µä¸‹è¿”å›žå½“å‰ç»„ä»¶ï¼Œå¦åˆ™å°±åˆ›å»ºæ–°ç»„ä»¶ï¼Œç„¶åŽæŠŠç»„ä»¶æ·»åŠ åˆ°å®žä½“æŽ©ç ï¼Œå¹¶ä¸”æ·»åŠ åˆ°å·²ä¿å­˜çš„ç»„ä»¶å­—å…¸ä¸­ã€‚ æ·»åŠ å®Œæˆä¹‹åŽï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¹¿æ’­å¢žåˆ äº‹ä»¶ç»™ç³»ç»Ÿã€‚ ç„¶åŽæ˜¯ç»„ä»¶çš„ç§»é™¤ã€‚ ç»„ä»¶çš„ç§»é™¤å’Œæ·»åŠ ç±»ä¼¼ã€‚ é¦–å…ˆåˆ¤æ–­ç»„ä»¶æ˜¯å¦å­˜åœ¨ï¼Œæ˜¯çš„è¯æ ‡è®°å­˜åœ¨ï¼Œå–å‡ºå½“å‰ç»„ä»¶çš„å®žä¾‹ï¼Œç„¶åŽåˆ¤æ–­æ˜¯å¦éœ€è¦å›žæ”¶ï¼Œéœ€è¦å›žæ”¶çš„è¯æ‰§è¡Œç»„ä»¶åˆå§‹åŒ–æ“ä½œå¹¶å›žæ”¶ï¼Œä¸éœ€è¦çš„è¯å°±æŠŠç»„ä»¶æ”¾åˆ°ç§»é™¤åˆ—è¡¨ä¸­ã€‚ æœ€åŽæˆ‘ä»¬æ‰§è¡ŒæŽ©ç çš„ç§»é™¤å’Œç»„ä»¶å­˜åœ¨åˆ—è¡¨çš„ç§»é™¤ï¼Œå¹¶ä¸”å¹¿æ’­é€šçŸ¥ç³»ç»Ÿæ‰§è¡Œå¯¹åº”æ“ä½œã€‚ æŽ¥ç€æ˜¯ç»„ä»¶çš„æŸ¥æ‰¾ã€‚ ç»„ä»¶çš„æŸ¥æ‰¾å¾ˆç®€å•ï¼Œå¯ä»¥ç”¨æŽ©ç ä¹Ÿå¯ä»¥ç”¨å­—å…¸ï¼Œæ ¹æ®è‡ªå·±çš„éœ€è¦å³å¯ã€‚ç»„ä»¶çš„èŽ·å–åŒç†ï¼Œå¯ä»¥ç”¨å­—å…¸ä¹Ÿå¯ä»¥ç”¨å±žæ€§ï¼Œè‡ªå·±å†³å®šå³å¯ã€‚ æœ€åŽæ˜¯å®žä½“çš„ç§»é™¤ã€‚ å®žä½“ç§»é™¤çš„æ—¶å€™è¦ç§»é™¤æ‰€æœ‰ç»„ä»¶ï¼ŒåŒ…æ‹¬å­˜åœ¨çš„å’Œç§»é™¤çš„åˆ—è¡¨ã€‚ç„¶åŽå®žä½“å¯ä»¥æ”¾å…¥å¯¹è±¡æ± ã€‚ Entity123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236using System;using System.Collections;using System.Collections.Generic;using System.Linq;using UnityEngine;using static Unity.Burst.Intrinsics.X86.Avx;public class Entity&#123; public int id &#123; get; set; &#125; public string name &#123; get; set; &#125; public ECSMask mask &#123; get; set; &#125; private Dictionary&lt;Type, Comp&gt; _compsInEntity = new Dictionary&lt;Type, Comp&gt;(); private Dictionary&lt;Type, Comp&gt; _compsRemoved = new Dictionary&lt;Type, Comp&gt;(); public Entity() &#123; mask = new ECSMask(); &#125; /// &lt;summary&gt; /// æ·»åŠ ç»„ä»¶ /// &lt;/summary&gt; /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt; /// &lt;param name=&quot;comp&quot;&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public T Add&lt;T&gt;() where T : Comp &#123; //Comp comp; Type comp = typeof(T); Comp instance; int compId = ECSManager.Ins().GetCompId(comp); if (mask.Has(compId)) &#123; instance = _compsInEntity[comp]; return instance as T; &#125; if (_compsRemoved.ContainsKey(comp)) &#123; instance = _compsRemoved[comp]; _compsRemoved.Remove(comp); &#125; else &#123; instance = ECSManager.Ins().CreateComp(comp); &#125; if (instance == null) &#123; ConsoleUtils.Warn(&quot;ç»„ä»¶æœªæ³¨å†Œ&quot;); &#125; else &#123; _compsInEntity.Add(comp, instance); mask.Set(compId); ECSManager.Ins().CompChangeBroadcast(this, compId); &#125; return instance as T; &#125; /// &lt;summary&gt; /// æ·»åŠ ç»„ä»¶ /// &lt;/summary&gt; /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt; /// &lt;param name=&quot;comp&quot;&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public void Add(Type comp) &#123; //Comp comp; Comp instance; int compId = ECSManager.Ins().GetCompId(comp); if (mask.Has(compId)) &#123; return; &#125; if (_compsRemoved.ContainsKey(comp)) &#123; instance = _compsRemoved[comp]; _compsRemoved.Remove(comp); &#125; else &#123; instance = ECSManager.Ins().CreateComp(comp); &#125; if (instance == null) &#123; ConsoleUtils.Warn(&quot;ç»„ä»¶æœªæ³¨å†Œ&quot;); &#125; else &#123; _compsInEntity.Add(comp, instance); mask.Set(compId); ECSManager.Ins().CompChangeBroadcast(this, compId); &#125; &#125; /// &lt;summary&gt; /// æ·»åŠ ç»„ä»¶ /// &lt;/summary&gt; /// &lt;param name=&quot;compIds&quot;&gt;&lt;/param&gt; public void AddComps(params Type[] comps) &#123; foreach (Type comp in comps) &#123; Add(comp); &#125; &#125; /// &lt;summary&gt; /// èŽ·å–ç»„ä»¶ /// &lt;/summary&gt; /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt; /// &lt;param name=&quot;compId&quot;&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public T Get&lt;T&gt;() where T : Comp &#123; Comp instance; _compsInEntity.TryGetValue(typeof(T), out instance); return instance as T; &#125; /// &lt;summary&gt; /// æ˜¯å¦æœ‰ç»„ä»¶ /// &lt;/summary&gt; /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool Has&lt;T&gt;() &#123; Type comp = typeof(T); int compId = ECSManager.Ins().GetCompId(comp); return mask.Has(compId); &#125; /// &lt;summary&gt; /// ç§»é™¤ç»„ä»¶ /// &lt;/summary&gt; /// &lt;param name=&quot;compId&quot;&gt;&lt;/param&gt; /// &lt;param name=&quot;recycle&quot;&gt;&lt;/param&gt; public void Remove&lt;T&gt;(bool recycle = true) &#123; Type comp = typeof(T); int compId = ECSManager.Ins().GetCompId(comp); if (mask.Has(compId)) &#123; Comp instance = _compsInEntity[comp]; if (recycle) &#123; ECSManager.Ins().RemoveComp(instance); &#125; else &#123; _compsRemoved.Add(comp, instance); &#125; _compsInEntity.Remove(comp); mask.Remove(compId); ECSManager.Ins().CompChangeBroadcast(this, compId); &#125; else &#123; ConsoleUtils.Warn(&quot;ç»„ä»¶ä¸å­˜åœ¨&quot;); &#125; &#125; /// &lt;summary&gt; /// ç§»é™¤ç»„ä»¶ /// &lt;/summary&gt; /// &lt;param name=&quot;compId&quot;&gt;&lt;/param&gt; /// &lt;param name=&quot;recycle&quot;&gt;&lt;/param&gt; public void Remove(Type comp, bool recycle = true) &#123; int compId = ECSManager.Ins().GetCompId(comp); if (mask.Has(compId)) &#123; Comp instance = _compsInEntity[comp]; if (recycle) &#123; ECSManager.Ins().RemoveComp(instance); &#125; else &#123; _compsRemoved.Add(comp, instance); &#125; _compsInEntity.Remove(comp); mask.Remove(compId); ECSManager.Ins().CompChangeBroadcast(this, compId); &#125; else &#123; ConsoleUtils.Warn(&quot;ç»„ä»¶ä¸å­˜åœ¨&quot;); &#125; &#125; public void RemoveComps(bool recycle, params Type[] comps) &#123; foreach (Type comp in comps) &#123; Remove(comp, recycle); &#125; &#125; public void Clear() &#123; foreach(var data in _compsInEntity.ToList()) &#123; Remove(data.Key); &#125; foreach(var data in _compsRemoved.ToList()) &#123; ECSManager.Ins().RemoveComp(data.Value); &#125; _compsInEntity.Clear(); _compsRemoved.Clear(); mask.Clear(); &#125;&#125; ç³»ç»Ÿç³»ç»Ÿæ ¹æ®æ‰€éœ€è¦çš„ç»„ä»¶æ¥ç­›é€‰å®žä½“ï¼Œæœ‰æ—¶å€™ä¸åŒç³»ç»Ÿéœ€è¦çš„ç»„ä»¶ç›¸åŒï¼Œå› æ­¤æˆ‘ä»¬ä½¿ç”¨ç»„ Group æ¥ç®¡ç†ç³»ç»Ÿã€‚ ç³»ç»Ÿçš„ç»“æž„å¦‚ä¸‹å›¾æ‰€ç¤º ç¾¤ç»„ç¾¤ç»„åŒ…å«ä¸€ä¸ªåŒ¹é…å™¨ï¼Œå¦‚å‰æ–‡æ‰€è¯´ï¼ŒåŒ¹é…å™¨çš„ id ä¹Ÿæ˜¯ç¾¤ç»„çš„ idã€‚ç¾¤ç»„åªå…³å¿ƒç»„ä»¶åŒ¹é…çš„å®žä½“ï¼Œæ“ä½œçš„å¯¹è±¡ä¹Ÿéƒ½æ˜¯å®žä½“ã€‚ æˆ‘ä»¬ä¿å­˜ä¸€ä¸ªå­—å…¸ _entities ç”¨äºŽåœ¨ç³»ç»Ÿè¿è¡Œæ—¶éåŽ†å½“å‰ç»„å†…çš„æ‰€æœ‰å®žä½“ã€‚ æˆ‘ä»¬å®šä¹‰ä¸¤ä¸ªå§”æ‰˜ï¼Œç”¨äºŽç›‘å¬å®žä½“å˜åŒ–ï¼Œä¸€ä¸ªæ˜¯å®žä½“è¿›å…¥è¯¥ç»„ï¼Œä¸€ä¸ªæ˜¯å®žä½“ç§»å‡ºè¯¥ç»„ï¼š 123public delegate void EnterListener(Entity entity);public delegate void RemoveListener(Entity entity); ç„¶åŽæˆ‘ä»¬é€šè¿‡å¦‚ä¸‹æ–¹æ³•æ·»åŠ å’Œç§»é™¤å§”æ‰˜ï¼š 1234567891011public void AddEntityListener(EnterListener enter, RemoveListener remove)&#123; _enterListener += enter; _removeListener += remove;&#125;public void RemoveEntityListener(EnterListener enter, RemoveListener remove)&#123; _enterListener -= enter; _removeListener -= remove;&#125; æ•´ä¸ªç»„çš„ç±»å¦‚ä¸‹ï¼š Group12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061using System;using System.Collections;using System.Collections.Generic;using UnityEngine;public delegate void EnterListener(Entity entity);public delegate void RemoveListener(Entity entity);public class Group&#123; private ECSMatcher _matcher; private EnterListener _enterListener; private RemoveListener _removeListener; private List&lt;Entity&gt; _entities = new List&lt;Entity&gt;(); public Group(ECSMatcher matcher) &#123; _matcher = matcher; &#125; public void OnCompChange(Entity entity) &#123; if(_matcher.IsMatch(entity)) &#123; _enterListener.Invoke(entity); _entities.Add(entity); &#125; else &#123; _removeListener.Invoke(entity); _entities.Remove(entity); &#125; &#125; public void AddEntityListener(EnterListener enter, RemoveListener remove) &#123; _enterListener += enter; _removeListener += remove; &#125; public void RemoveEntityListener(EnterListener enter, RemoveListener remove) &#123; _enterListener -= enter; _removeListener -= remove; &#125; public List&lt;Entity&gt; GetEntities() &#123; return _entities; &#125; public void Clear() &#123; _entities.Clear(); &#125;&#125; ç³»ç»Ÿå®žçŽ°ç³»ç»Ÿå®žçŽ°åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªéƒ¨åˆ†æ˜¯ç³»ç»Ÿçš„å…·ä½“å®žçŽ°ï¼Œè¿˜æœ‰ä¸€ä¸ªéƒ¨åˆ†æ˜¯ä¸–ç•Œã€‚ ç³»ç»Ÿçš„å…·ä½“å®žçŽ°æ ¸å¿ƒç›®æ ‡æ˜¯å®žçŽ°å®žä½“è¿›å…¥æ—¶çš„é€»è¾‘å¤„ç†ï¼Œæ¯å¸§é€»è¾‘å¤„ç†å’Œå®žä½“ç§»é™¤æ—¶çš„é€»è¾‘å¤„ç†ã€‚ é¦–å…ˆæˆ‘ä»¬å®šä¹‰ä¸¤ä¸ªæ•°ç»„ _enters å’Œ _removes ç”¨äºŽä¿å­˜è¿›å…¥å’Œç§»å‡ºå½“å‰ç³»ç»Ÿçš„å®žä½“ã€‚ ç„¶åŽæˆ‘ä»¬é€šè¿‡å¦‚ä¸‹æ–¹æ³•æ³¨å†Œå’Œåæ³¨å†Œå®žä½“è¿›å…¥å’Œç§»å‡ºæ•°ç»„çš„ç›‘å¬ï¼š 12345678910111213141516171819202122232425public ECSSystem()&#123; _group = ECSManager.Ins().CreateGroup(Filter()); _group.AddEntityListener(EntityEnter, EntityRemove);&#125;private void EntityRemove(Entity entity)&#123; List&lt;Entity&gt; entities = _group.GetEntities(); if (entities.Contains(entity)) &#123; _removes.Add(entity); &#125;&#125;private void EntityEnter(Entity entity)&#123; _enters.Add(entity);&#125;public virtual void OnDestroy()&#123; _group.RemoveEntityListener(EntityEnter, EntityRemove);&#125; é€šè¿‡åœ¨æž„é€ å‡½æ•°ä¸­æ³¨å†Œç›‘å¬ï¼Œæ¯å½“ç»„å†…å®žä½“å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œç»„å†…æ³¨å†Œçš„æ‰€æœ‰ç³»ç»Ÿçš„å®žä½“è¿›å…¥å’Œç§»å‡ºæ•°ç»„çš„æ–¹æ³•ï¼Œ EntityEnter å’Œ EntityRemoveï¼Œéƒ½ä¼šæ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯æŠŠå®žä½“æ·»åŠ æˆ–ç§»é™¤åˆ°å½“å‰ç³»ç»Ÿä¸­ã€‚ ç„¶åŽå°±æ˜¯ç³»ç»Ÿçš„éåŽ†å¤„ç†äº†ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465using System.Collections.Generic;public abstract class ECSSystem&#123; private Group _group; protected float _dt = 0; private List&lt;Entity&gt; _enters = new List&lt;Entity&gt;(); private List&lt;Entity&gt; _removes = new List&lt;Entity&gt;(); public ECSSystem() &#123; _group = ECSManager.Ins().CreateGroup(Filter()); _group.AddEntityListener(EntityEnter, EntityRemove); &#125; public void Execute(float dt) &#123; _dt = dt; List&lt;Entity&gt; entities = _group.GetEntities(); OnEnter(_enters); OnUpdate(entities); OnRemove(_removes); _removes.Clear(); _enters.Clear(); &#125; public void DrawGizmos() &#123; List&lt;Entity&gt; entities = _group.GetEntities(); OnDrawGizmos(entities); &#125; private void EntityEnter(Entity entity) &#123; _enters.Add(entity); &#125; private void EntityRemove(Entity entity) &#123; List&lt;Entity&gt; entities = _group.GetEntities(); if (entities.Contains(entity)) &#123; _removes.Add(entity); &#125; &#125; public virtual void Init() &#123; &#125; public virtual void OnDestroy() &#123; _group.RemoveEntityListener(EntityEnter, EntityRemove); &#125; public virtual void OnEnter(List&lt;Entity&gt; entities) &#123; &#125; public virtual void OnRemove(List&lt;Entity&gt; entities) &#123; &#125; public virtual void OnDrawGizmos(List&lt;Entity&gt; entities) &#123; &#125; public abstract ECSMatcher Filter(); public abstract void OnUpdate(List&lt;Entity&gt; entities);&#125; åœ¨æ ¸å¿ƒå¤„ç†å‡½æ•° Execute ä¸­æˆ‘ä»¬æŒ‰ç…§é¡ºåºå¤„ç† OnEnterã€OnUpdate å’Œ OnRemove ï¼Œç„¶åŽæˆ‘ä»¬æŠŠ _enters å’Œ _removes æ¸…ç©ºï¼Œé˜²æ­¢å¤šæ¬¡æ‰§è¡Œã€‚ æ‰€æœ‰çš„ç³»ç»Ÿå®žçŽ°ï¼Œæœ€åŽæˆ‘ä»¬éƒ½è¦ç”¨ä¸–ç•Œæ¥ä½¿ç”¨ã€‚ ä¸–ç•Œç”Ÿå‘½å‘¨æœŸæä¾›ä¸€ä¸ª Init æ–¹æ³•ï¼Œæ¥éåŽ†æ‰€æœ‰ç³»ç»Ÿå¹¶ä¸”è°ƒç”¨å¯¹åº”ç³»ç»Ÿçš„åˆå§‹åŒ–ï¼›æä¾›ä¸€ä¸ª Update æ–¹æ³•æ¥éåŽ†æ‰€æœ‰ç³»ç»Ÿï¼Œæ‰§è¡Œæ¯å¸§æ›´æ–°çš„å†…å®¹ï¼›æä¾›ä¸€ä¸ª Clear æ–¹æ³•æ¥éåŽ†æ‰€æœ‰ç³»ç»Ÿï¼Œè°ƒç”¨ç³»ç»Ÿé”€æ¯æ—¶çš„ OnDestroy æ–¹æ³•ã€‚ ç„¶åŽå°±æ˜¯ Add æ–¹æ³•ï¼Œä¼ å…¥ç³»ç»Ÿæ—¶ç›´æŽ¥åŠ å…¥ _systems ã€‚æ·»åŠ æ–°ç³»ç»Ÿæˆ‘ä»¬éœ€è¦é‡å†™ SystemAdd æ–¹æ³•ï¼Œæ‰€æœ‰çš„æ·»åŠ è¡Œä¸ºéƒ½åœ¨è¿™ä¸ªæ–¹æ³•é‡Œæ‰§è¡Œã€‚ æ‰€æœ‰çš„æ–¹æ³•åœ¨æˆ‘ä»¬è‡ªå®šä¹‰ä¸–ç•Œçš„æ—¶å€™éƒ½ä¸éœ€è¦ä¿®æ”¹ï¼Œåªéœ€è¦åœ¨ SystemAdd ä¸­ Add æ–°çš„ç³»ç»Ÿå³å¯ã€‚ ECSWorld123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960using System.Collections.Generic;using UnityEngine;public abstract class ECSWorld&#123; private List&lt;ECSSystem&gt; _systems = new List&lt;ECSSystem&gt;(); private float _time = 0; public ECSWorld() &#123; SystemAdd(); Init(); &#125; public void Init() &#123; _time = Time.time; foreach (var system in _systems) &#123; system.Init(); &#125; &#125; public abstract void SystemAdd(); public void Update() &#123; float dt = Time.time - _time; foreach (var system in _systems) &#123; system.Execute(dt); &#125; _time += dt; //ConsoleUtils.Log(&quot;é—´éš”æ—¶é—´&quot;,dt); &#125; public void DrawGrizmos() &#123; foreach (var system in _systems) &#123; system.DrawGizmos(); &#125; &#125; public void Add(ECSSystem system) &#123; _systems.Add(system); &#125; public void Remove(ECSSystem system) &#123; _systems.Remove(system); &#125; public void Clear() &#123; _systems.Clear(); &#125;&#125; ç®¡ç†å™¨ECS çš„åŸºæœ¬æ¡†æž¶æ­å»ºå¥½åŽï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªç®¡ç†å™¨æ¥ç®¡ç† ECS æ¡†æž¶çš„ä¸€äº›æ“ä½œã€‚ä¸‹é¢æ˜¯æœ¬é¡¹ç›®çš„åˆ†ç±»ï¼Œä¹Ÿå¯ä»¥æ ¹æ®éœ€æ±‚è‡ªå·±è®¾è®¡ã€‚ ECS ç®¡ç†å™¨çš„æ ¸å¿ƒåŠŸèƒ½ç®€å•æ¦‚æ‹¬å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆUnity ç‰ˆæœ¬å–æ¶ˆæ ‡ç­¾ï¼Œå–æ¶ˆåˆ¤æ–­å®žä¾‹åŒ–å¹¶ç›´æŽ¥èµ°æ˜¯åˆ†æ”¯ï¼‰ ç»„ä»¶æ³¨å†Œæˆ‘ä»¬åœ¨ä½¿ç”¨ç»„ä»¶ä¹‹å‰ï¼Œéƒ½è¦å¯¹ç»„ä»¶è¿›è¡Œæ³¨å†Œã€‚ æˆ‘ä»¬é€šè¿‡ç‰¹æ€§ Attribute æ¥å®žçŽ°ç»„ä»¶ç±»çš„é¢„æ³¨å†Œã€‚ CompRegister123456789101112131415161718using System;[System.AttributeUsage(System.AttributeTargets.Class | System.AttributeTargets.Struct)]public class CompRegister : Attribute&#123; public CompRegister(Type type) &#123; Register(type); &#125; public void Register(Type type) &#123; int id = ECSManager.Ins().GetCompId(); ECSManager.Ins().CompRegister(type, id); &#125;&#125; å¯åŠ¨Attribute1234567891011121314public void Init()&#123; Assembly assembly = Assembly.GetAssembly(typeof(ECSManager)); Type[] types = assembly.GetTypes(); foreach (Type type in types) &#123; //èŽ·å–è‡ªå®šä¹‰ç‰¹æ€§çš„è¿‡ç¨‹ä¸­è‡ªåŠ¨æ‰§è¡Œæž„é€ å‡½æ•° var attr = type.GetCustomAttribute&lt;CompRegister&gt;(); if (attr != null) &#123; _total++; &#125; &#125;&#125; ç»„ä»¶åŠŸèƒ½ç»„ä»¶çš„åŠŸèƒ½å¾ˆç®€å•ï¼Œåªæ˜¯è¿ç”¨äº†å¯¹è±¡æ± çš„æ¦‚å¿µã€‚æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå®žä½“æ± _compsç”¨äºŽä¿å­˜å½“å‰æ‰€æœ‰çš„ç»„ä»¶ idï¼Œå®šä¹‰ä¸€ä¸ªç»„ä»¶å®žä¾‹ç¼“å­˜æ± _compPoolç”¨æ¥å½“ç»„ä»¶çš„å¯¹è±¡æ± ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162/// &lt;summary&gt;/// æ³¨å†Œç»„ä»¶/// &lt;/summary&gt;/// &lt;param name=&quot;comp&quot;&gt;&lt;/param&gt;/// &lt;param name=&quot;compId&quot;&gt;&lt;/param&gt;public void CompRegister(Type comp, int compId)&#123; _comps.Add(comp, compId); _compPool.Add(compId, new Stack&lt;Comp&gt;()); ConsoleUtils.Log(&quot;æ³¨å†Œç±»:&quot;, compId, comp);&#125;/// &lt;summary&gt;/// åˆ›å»ºç»„ä»¶/// &lt;/summary&gt;/// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;/// &lt;param name=&quot;comp&quot;&gt;&lt;/param&gt;/// &lt;returns&gt;&lt;/returns&gt;public Comp CreateComp(Type comp)&#123; if (!_comps.ContainsKey(comp)) &#123; ConsoleUtils.Warn(&quot;æœªæ‰¾åˆ°å¯¹åº”ç»„ä»¶:&quot;, comp); return null; &#125; else &#123; int compId = _comps[comp]; Comp instance; Stack&lt;Comp&gt; queue; _compPool.TryGetValue(compId, out queue); if (queue == null || queue.Count == 0) &#123; instance = ClassFactory.CreateClass&lt;Comp&gt;(comp); instance.compId = compId; &#125; else &#123; instance = queue.Pop(); &#125; return instance; &#125;&#125;/// &lt;summary&gt;/// å›žæ”¶ç»„ä»¶/// &lt;/summary&gt;/// &lt;param name=&quot;comp&quot;&gt;&lt;/param&gt;public void RemoveComp(Comp comp)&#123; Stack&lt;Comp&gt; queue; _compPool.TryGetValue(comp.compId, out queue); if (queue == null) &#123; queue = new Stack&lt;Comp&gt;(); _compPool.Add(comp.compId, queue); &#125; comp.Reset(); queue.Push(comp);&#125; å®žä½“åŠŸèƒ½å®žä½“çš„åŠŸèƒ½ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå®žä½“æ± _entitiesç”¨äºŽä¿å­˜å½“å‰æ‰€æœ‰çš„å®žä½“å®žä¾‹ï¼Œå®šä¹‰ä¸€ä¸ªå®žä½“å®žä¾‹ç¼“å­˜æ± _entityPoolç”¨æ¥å½“å®žä½“çš„å¯¹è±¡æ± ã€‚ 123456789101112131415161718192021222324252627282930public Entity CreateEntity()&#123; if (_entityPool.Count == 0) &#123; Entity entity = new Entity(); entity.id = _entityId++; _entities.Add(entity.id,entity); return entity; &#125; else &#123; Entity entity = _entityPool.Pop(); _entities.Add(entity.id, entity); return _entityPool.Pop(); &#125;&#125;public Entity GetEntity(int id)&#123; Entity entity; _entities.TryGetValue(id, out entity); return entity;&#125;public void RemoveEntity(Entity entity)&#123; entity.Clear(); _entityPool.Push(entity); _entities.Remove(entity.id);&#125; ç³»ç»ŸåŠŸèƒ½ç³»ç»ŸåŠŸèƒ½åŒ…æ‹¬ç¾¤ç»„åŠŸèƒ½ï¼Œè¿‡æ»¤åŠŸèƒ½å’Œç»„ä»¶å˜åŒ–çš„é€šçŸ¥ã€‚ ç»„ä»¶å˜åŒ–çš„ç›‘å¬æ˜¯åœ¨åˆ›å»ºç¾¤ç»„çš„æ—¶å€™å°±ç»‘å®šå¥½çš„ã€‚é€šè¿‡èŽ·å–å¯¹åº”ç»„ä»¶ id çš„ç»„ä»¶å˜åŒ–æ•°ç»„ï¼Œå­˜å…¥ç¾¤ç»„çš„ç›‘å¬å‡½æ•°ï¼Œå°±å¯ä»¥åœ¨æ¯æ¬¡ç»„ä»¶å˜åŒ–çš„æ—¶å€™é€šçŸ¥æ‰€æœ‰ç›‘å¬è¯¥ç»„ä»¶çš„ç¾¤ç»„æ‰§è¡Œå¯¹åº”çš„å‡½æ•°ã€‚ å…¶ä»–åŠŸèƒ½å°±æ˜¯å¯¹ä¸Šæ–‡çŽ°æœ‰åŠŸèƒ½çš„å†åŒ…è£…ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556public Group CreateGroup(ECSMatcher matcher)&#123; Group res; _groups.TryGetValue(matcher, out res); if (res == null) &#123; res = new Group(matcher); _groups.Add(matcher, res); List&lt;int&gt; compIds = matcher.GetCompIds(); foreach (int compId in compIds) &#123; List&lt;Action&lt;Entity&gt;&gt; actionList; _onCompChangeAction.TryGetValue(compId, out actionList); if (actionList == null) &#123; actionList = new List&lt;Action&lt;Entity&gt;&gt;(); _onCompChangeAction.Add(compId, actionList); &#125; actionList.Add(res.OnCompChange); &#125; &#125; return res;&#125;public void CompChangeBroadcast(Entity entity, int compId)&#123; List&lt;Action&lt;Entity&gt;&gt; actionList; _onCompChangeAction.TryGetValue(compId, out actionList); if (actionList != null) &#123; foreach (Action&lt;Entity&gt; action in actionList) &#123; action.Invoke(entity); &#125; &#125;&#125;public ECSMatcher AnyOf(params Type[] comps)&#123; return new ECSMatcher().AnyOf(comps);&#125;public ECSMatcher AllOf(params Type[] comps)&#123; return new ECSMatcher().AllOf(comps);&#125;public ECSMatcher ExcludeOf(params Type[] comps)&#123; return new ECSMatcher().ExcludeOf(comps);&#125;public ECSMatcher OnlyOf(params Type[] comps)&#123; return new ECSMatcher().OnlyOf(comps);&#125; æ€»çš„ ECS ç®¡ç†ç±»ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229using System;using System.Collections.Generic;using System.Reflection;using System.Runtime.Remoting.Metadata.W3cXsd2001;using System.Security.Cryptography;using Unity.VisualScripting;public class ECSManager : Singleton&lt;ECSManager&gt;&#123; private int _compId = 1; private int _entityId = 0; private int _total = 0; private Dictionary&lt;Type, int&gt; _comps = new Dictionary&lt;Type, int&gt;(); private Dictionary&lt;ECSMatcher, Group&gt; _groups = new Dictionary&lt;ECSMatcher, Group&gt;(); /// &lt;summary&gt; /// ç»„ä»¶å˜åŒ–ç›‘å¬å­—å…¸ /// &lt;/summary&gt; private Dictionary&lt;int, List&lt;Action&lt;Entity&gt;&gt;&gt; _onCompChangeAction = new Dictionary&lt;int, List&lt;Action&lt;Entity&gt;&gt;&gt;(); /// &lt;summary&gt; /// å®žä½“å¯¹è±¡æ±  /// &lt;/summary&gt; private Stack&lt;Entity&gt; _entityPool = new Stack&lt;Entity&gt;(); /// &lt;summary&gt; /// å®žä½“å¯¹è±¡ /// &lt;/summary&gt; private Dictionary&lt;int, Entity&gt; _entities = new Dictionary&lt;int, Entity&gt;(); private Dictionary&lt;int, Stack&lt;Comp&gt;&gt; _compPool = new Dictionary&lt;int, Stack&lt;Comp&gt;&gt;(); public void Init() &#123; Assembly assembly = Assembly.GetAssembly(typeof(ECSManager)); Type[] types = assembly.GetTypes(); foreach (Type type in types) &#123; //èŽ·å–è‡ªå®šä¹‰ç‰¹æ€§çš„è¿‡ç¨‹ä¸­è‡ªåŠ¨æ‰§è¡Œæž„é€ å‡½æ•° var attr = type.GetCustomAttribute&lt;CompRegister&gt;(); if(attr != null) &#123; _total++; &#125; &#125; &#125; public void SetTotalCompNum(int num) &#123; _total = num; &#125; public int GetTotalCompNum() &#123; return _total; &#125; public int GetCompId() &#123; return _compId++; &#125; public int GetCompId(Type comp) &#123; return _comps[comp]; &#125; public Dictionary&lt;Type, int&gt; GetAllCompTypes() &#123; return _comps; &#125; /// &lt;summary&gt; /// æ³¨å†Œç»„ä»¶ /// &lt;/summary&gt; /// &lt;param name=&quot;comp&quot;&gt;&lt;/param&gt; /// &lt;param name=&quot;compId&quot;&gt;&lt;/param&gt; public void CompRegister(Type comp, int compId) &#123; _comps.Add(comp, compId); _compPool.Add(compId, new Stack&lt;Comp&gt;()); ConsoleUtils.Log(&quot;æ³¨å†Œç±»:&quot;, compId, comp); &#125; /// &lt;summary&gt; /// åˆ›å»ºç»„ä»¶ /// &lt;/summary&gt; /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt; /// &lt;param name=&quot;comp&quot;&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public Comp CreateComp(Type comp) &#123; if (!_comps.ContainsKey(comp)) &#123; ConsoleUtils.Warn(&quot;æœªæ‰¾åˆ°å¯¹åº”ç»„ä»¶:&quot;, comp); return null; &#125; else &#123; int compId = _comps[comp]; Comp instance; Stack&lt;Comp&gt; queue; _compPool.TryGetValue(compId, out queue); if (queue == null || queue.Count == 0) &#123; instance = ClassFactory.CreateClass&lt;Comp&gt;(comp); instance.compId = compId; &#125; else &#123; instance = queue.Pop(); &#125; return instance; &#125; &#125; /// &lt;summary&gt; /// å›žæ”¶ç»„ä»¶ /// &lt;/summary&gt; /// &lt;param name=&quot;comp&quot;&gt;&lt;/param&gt; public void RemoveComp(Comp comp) &#123; Stack&lt;Comp&gt; queue; _compPool.TryGetValue(comp.compId, out queue); if (queue == null) &#123; queue = new Stack&lt;Comp&gt;(); _compPool.Add(comp.compId, queue); &#125; comp.Reset(); queue.Push(comp); &#125; public Group CreateGroup(ECSMatcher matcher) &#123; Group res; _groups.TryGetValue(matcher, out res); if (res == null) &#123; res = new Group(matcher); _groups.Add(matcher, res); List&lt;int&gt; compIds = matcher.GetCompIds(); foreach (int compId in compIds) &#123; List&lt;Action&lt;Entity&gt;&gt; actionList; _onCompChangeAction.TryGetValue(compId, out actionList); if (actionList == null) &#123; actionList = new List&lt;Action&lt;Entity&gt;&gt;(); _onCompChangeAction.Add(compId, actionList); &#125; actionList.Add(res.OnCompChange); &#125; &#125; return res; &#125; public Entity CreateEntity() &#123; if (_entityPool.Count == 0) &#123; Entity entity = new Entity(); entity.id = _entityId++; _entities.Add(entity.id,entity); return entity; &#125; else &#123; Entity entity = _entityPool.Pop(); _entities.Add(entity.id, entity); return _entityPool.Pop(); &#125; &#125; public Entity GetEntity(int id) &#123; Entity entity; _entities.TryGetValue(id, out entity); return entity; &#125; public void RemoveEntity(Entity entity) &#123; entity.Clear(); _entityPool.Push(entity); _entities.Remove(entity.id); &#125; public void CompChangeBroadcast(Entity entity, int compId) &#123; List&lt;Action&lt;Entity&gt;&gt; actionList; _onCompChangeAction.TryGetValue(compId, out actionList); if (actionList != null) &#123; foreach (Action&lt;Entity&gt; action in actionList) &#123; action.Invoke(entity); &#125; &#125; &#125; public ECSMatcher AnyOf(params Type[] comps) &#123; return new ECSMatcher().AnyOf(comps); &#125; public ECSMatcher AllOf(params Type[] comps) &#123; return new ECSMatcher().AllOf(comps); &#125; public ECSMatcher ExcludeOf(params Type[] comps) &#123; return new ECSMatcher().ExcludeOf(comps); &#125; public ECSMatcher OnlyOf(params Type[] comps) &#123; return new ECSMatcher().OnlyOf(comps); &#125;&#125; ä½¿ç”¨æ–¹æ³•Compç¤ºä¾‹12345678910111213141516171819202122232425262728[CompRegister(typeof(TransformComp))]public class TransformComp : Comp&#123; public Vector3 position; public Quaternion rotation; public Vector3 scale; public Vector3 lastPosition; public Quaternion lastRotation; public Vector3 lastScale; public bool changed = false; public override void Reset() &#123; position = Vector3.zero; rotation = Quaternion.identity; scale = Vector3.one; lastPosition = Vector3.zero; lastRotation = Quaternion.identity; lastScale = Vector3.one; changed = false; &#125;&#125; Systemç¤ºä¾‹1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950using System.Collections.Generic;using UnityEngine;public class MoveSystem : ECSSystem&#123; public override ECSMatcher Filter() &#123; return ECSManager.Ins().AllOf(typeof(TransformComp), typeof(MoveComp)); &#125; public override void OnUpdate(List&lt;Entity&gt; entities) &#123; foreach (Entity entity in entities) &#123; MoveComp move = entity.Get&lt;MoveComp&gt;(); if (move.inputForward != Vector3.zero &amp;&amp; !entity.Has&lt;ClimbUpComp&gt;() &amp;&amp; (!move.isClimb || move.isClimb &amp;&amp; move.climbJump == 0)) &#123; if (move.isClimb) &#123; move.curForwad = move.inputForward; &#125; else &#123; move.curForwad = move.forward; move.fixedForward = move.up * move.forward; &#125; move.nextPostition += move.fixedForward * move.speed; &#125; &#125; &#125; /// &lt;summary&gt; /// è¾…åŠ©çº¿ /// &lt;/summary&gt; /// &lt;param name=&quot;entities&quot;&gt;&lt;/param&gt; public override void OnDrawGizmos(List&lt;Entity&gt; entities) &#123; foreach (Entity entity in entities) &#123; MoveComp move = entity.Get&lt;MoveComp&gt;(); TransformComp transform = entity.Get&lt;TransformComp&gt;(); Gizmos.DrawLine(transform.position, transform.position + move.fixedForward * 100); &#125; &#125;&#125; Worldç¤ºä¾‹12345678910111213141516public class LogicWorld : ECSWorld&#123; public override void SystemAdd() &#123; Add(new TransformSystem()); Add(new ClimbSystem()); Add(new MoveSystem()); Add(new JumpSystem()); Add(new ClimbUpSystem()); Add(new QTreeSystem()); Add(new QObjFindingSystem()); Add(new WeaponSystem()); Add(new LogicAniSystem()); Add(new AniSystem()); &#125;&#125; ä¸»å¾ªçŽ¯ç¤ºä¾‹123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107using System;using System.Collections.Generic;using UnityEditor;using UnityEngine;public class Launcher : MonoBehaviour&#123; private bool _inited = false; private int _initIndex = 0; private LogicWorld _logicWorld; private PhysicWorld _physicWorld; private RenderWorld _renderWorld; void Start() &#123; InitNext(); &#125; private void Update() &#123; if (_inited) &#123; _renderWorld.Update(); &#125; &#125; private void FixedUpdate() &#123; if (_inited) &#123; _logicWorld.Update(); _physicWorld.Update(); &#125; &#125; void OnDrawGizmos() &#123; if (_inited) &#123; _logicWorld.DrawGrizmos(); _physicWorld.DrawGrizmos(); _renderWorld.DrawGrizmos(); &#125; &#125; private void InitNext() &#123; ConsoleUtils.Log(&quot;å½“å‰æ­¥éª¤&quot;,_initIndex); switch (_initIndex++) &#123; case 0: InitUtils(); break; case 1: LoadRes(); break; case 2: InitManager(); break; case 3: StartGame(); break; case 4: InitGlobals(); break; case 5: _inited = true; UIManager.Ins().Hide(_loadingView); break; &#125; &#125; private void LoadRes() &#123; InitNext(); &#125; private void InitGlobals() &#123; InitNext(); &#125; private void InitUtils() &#123; InitNext(); &#125; private void InitManager() &#123; ECSManager.Ins().Init(); InitNext(); &#125; private void StartGame() &#123; _logicWorld = new LogicWorld(); _physicWorld = new PhysicWorld(); _renderWorld = new RenderWorld(); InitNext(); &#125;&#125; é¡¹ç›®å·¥ç¨‹ç”±äºŽæœ¬é¡¹ç›®ä»£ç è¾ƒå¤šï¼Œå› æ­¤è¯·ç§»æ­¥ GitHub æŸ¥çœ‹è¯¦ç»†ä»£ç ã€‚ æ³¨æ„äº‹é¡¹æœ¬æ–‡çš„ ECS æž¶æž„å¹¶æœªåšå¤šçº¿ç¨‹æˆ–å¹¶è¡Œå¤„ç†ï¼Œè¿™éƒ¨åˆ†å†…å®¹è¯·è‡ªè¡Œæ”¹é€ ã€‚ æœ¬æ–‡å†…å®¹ä¸ŽTS å®žçŽ° ECS æž¶æž„ä¸€æ–‡åŸºæœ¬ç›¸åŒï¼Œåªæ˜¯åšäº† Unity ç‰ˆæœ¬çš„ç§»æ¤å’Œè°ƒæ•´å¹¶ä¸”ä¿®å¤ä¸€äº› bugï¼Œä¸è¿‡å»ºè®®ä»¥æœ¬æ–‡ä¸ºä¸»ã€‚ æ›´æ–°æ—¥å¿—2024-03-08 æ›´æ–° ECS åŸºæœ¬å†…å®¹ã€‚","categories":[{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/categories/Unity/"},{"name":"å·¥å…·","slug":"Unity/å·¥å…·","permalink":"https://busyogg.github.io/categories/Unity/%E5%B7%A5%E5%85%B7/"}],"tags":[{"name":"C#","slug":"C","permalink":"https://busyogg.github.io/tags/C/"},{"name":"å·¥å…·ç±»","slug":"å·¥å…·ç±»","permalink":"https://busyogg.github.io/tags/%E5%B7%A5%E5%85%B7%E7%B1%BB/"},{"name":"ç³»ç»Ÿæž¶æž„","slug":"ç³»ç»Ÿæž¶æž„","permalink":"https://busyogg.github.io/tags/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/"},{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/tags/Unity/"}]},{"title":"ç¢°æ’žæ£€æµ‹ä¹‹èƒ¶å›Šä½“ä¸Žå…¶ä»–","slug":"ç¢°æ’žæ£€æµ‹ä¹‹èƒ¶å›Šä½“ä¸Žå…¶ä»–","date":"2024-03-05T08:04:10.000Z","updated":"2024-05-30T12:26:04.173Z","comments":true,"path":"article/f9709c7609f9/","link":"","permalink":"https://busyogg.github.io/article/f9709c7609f9/","excerpt":"","text":"ç®€ä»‹æœ¬æ–‡ä¸»è¦é˜è¿°èƒ¶å›Šä½“ä¸Žå…¶ä»–åŒ…å›´ç›’çš„ç¢°æ’žæ£€æµ‹åŽŸç†å’Œå®žçŽ°æ–¹å¼ã€‚ç”±äºŽå…¶åŸºæœ¬åŽŸç†ç›¸åŒï¼Œå› æ­¤æ”¾åœ¨åŒä¸€ç¯‡è®²ã€‚ åŽŸç†å¯¹äºŽèƒ¶å›Šä½“æ¥è¯´ï¼Œç¢°æ’žæ£€æµ‹çš„åŽŸç†éƒ½æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯ç¡®å®šä¸¤ä¸ªæ£€æµ‹ç‚¹ï¼Œç„¶åŽåˆ¤æ–­ç‚¹ä¸Žç‚¹ä¹‹é—´çš„å…³ç³»ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥å‚è€ƒèƒ¶å›Šä½“ä¹‹é—´çš„ç¢°æ’žæ£€æµ‹å¾—å‡ºèƒ¶å›Šä½“ä¸Žå…¶ä»–åŒ…å›´ç›’çš„ç¢°æ’žæ£€æµ‹åŽŸç†ã€‚ åœ†AABBOBBå°„çº¿èƒ¶å›Šä½“ä¸Žåœ†çš„ç¢°æ’žï¼Œå…¶å®žå°±æ˜¯ç®€åŒ–ç‰ˆçš„èƒ¶å›Šä½“ä¸Žèƒ¶å›Šä½“çš„ç¢°æ’žã€‚å› ä¸ºåœ¨èƒ¶å›Šä½“çš„ç¢°æ’žæ£€æµ‹ä¸­ï¼Œæˆ‘ä»¬æœ€ç»ˆå¾—åˆ°çš„å°±æ˜¯åœ†ä¸Žåœ†çš„ç¢°æ’žã€‚ å› æ­¤å¯¹äºŽèƒ¶å›Šä½“ä¸Žåœ†æ¥è¯´ï¼Œåœ†å°±ç›¸å½“äºŽçœåŽ»ä¸€ä¸ªèƒ¶å›Šä½“çš„è®¡ç®—ï¼Œè€Œç›´æŽ¥å¾—åˆ°ç»“æžœã€‚èƒ¶å›Šä½“ä¸Ž AABB çš„ç¢°æ’žï¼Œæˆ‘ä»¬åªè¦å…ˆæ‹¿åˆ° AABB ä¸­å¿ƒç‚¹åœ¨èƒ¶å›Šä½“çº¿æ®µä¸Šçš„æœ€è¿‘ç‚¹ï¼Œç„¶åŽæ ¹æ®è¿™ä¸ªæœ€è¿‘ç‚¹æ±‚ AABB è¡¨é¢çš„æœ€è¿‘ç‚¹ï¼Œç„¶åŽæ¯”è¾ƒä¸¤ç‚¹çš„è·ç¦»æ˜¯å¦å°äºŽèƒ¶å›Šä½“åŠå¾„å³å¯ã€‚ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¾€æœŸç¢°æ’žæ£€æµ‹ä¸­èŽ·å–æœ€è¿‘ç‚¹çš„æ–¹æ³•å³å¯ã€‚ åˆ¤æ–­ç¢°æ’žçš„ä»£ç å¦‚ä¸‹ï¼š 12345678910111213//æ±‚èƒ¶å›Šä½“åŠå¾„å¹³æ–¹float totalRadius = Mathf.Pow(data2.radius, 2);//æ±‚ä¸¤ä¸ªç‚¹ä¹‹é—´çš„è·ç¦»float distance = (closest1 - closest2).sqrMagnitude;//è·ç¦»å°äºŽç­‰äºŽåŠå¾„å¹³æ–¹åˆ™ç¢°æ’žif (distance &lt;= totalRadius)&#123; return true;&#125;else&#123; return false;&#125;èƒ¶å›Šä½“ä¸Ž OBB çš„ç¢°æ’žï¼Œæˆ‘ä»¬åªè¦å…ˆæ‹¿åˆ° OBB ä¸­å¿ƒç‚¹åœ¨èƒ¶å›Šä½“çº¿æ®µçš„æœ€è¿‘ç‚¹ï¼Œç„¶åŽæ ¹æ®è¿™ä¸ªæœ€è¿‘ç‚¹æ±‚ OBB è¡¨é¢ä¸Šçš„æœ€è¿‘ç‚¹ï¼Œç„¶åŽæ¯”è¾ƒä¸¤ç‚¹çš„è·ç¦»æ˜¯å¦å°äºŽèƒ¶å›Šä½“åŠå¾„å³å¯ã€‚ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¾€æœŸç¢°æ’žæ£€æµ‹ä¸­èŽ·å–æœ€è¿‘ç‚¹çš„æ–¹æ³•å³å¯ã€‚ åˆ¤æ–­ç¢°æ’žçš„ä»£ç å¦‚ä¸‹ï¼š 12345678910111213//æ±‚èƒ¶å›Šä½“åŠå¾„å¹³æ–¹float totalRadius = Mathf.Pow(data2.radius, 2);//æ±‚ä¸¤ä¸ªç‚¹ä¹‹é—´çš„è·ç¦»float distance = (closest1 - closest2).sqrMagnitude;//è·ç¦»å°äºŽç­‰äºŽåŠå¾„å¹³æ–¹åˆ™ç¢°æ’žif (distance &lt;= totalRadius)&#123; return true;&#125;else&#123; return false;&#125;èƒ¶å›Šä½“ä¸Žå°„çº¿çš„ç¢°æ’žï¼Œæˆ‘ä»¬ä¸å¦¨æŠŠå°„çº¿çœ‹æˆå¦ä¸€ä¸ªèƒ¶å›Šä½“çš„çº¿æ®µéƒ¨åˆ†ï¼Œæ ¹æ®å°„çº¿çš„èµ·ç‚¹å’Œç»ˆç‚¹æˆ‘ä»¬å¯ä»¥å¾—åˆ°çº¿æ®µçš„ä¸­å¿ƒç‚¹ï¼Œç„¶åŽå°±å’Œèƒ¶å›Šä½“ç¢°æ’žæ£€æµ‹çš„æµç¨‹ä¸€æ ·è¿›è¡Œå³å¯ã€‚ ä¸è¿‡åœ¨æœ€ç»ˆçš„ç¢°æ’žæ£€æµ‹éƒ¨åˆ†ï¼Œé€»è¾‘è¦å’Œ AABB åŠ OBB ä¸€æ ·ï¼Œå¦‚ä¸‹ï¼š 12345678910111213//æ±‚èƒ¶å›Šä½“åŠå¾„å¹³æ–¹float totalRadius = Mathf.Pow(data2.radius, 2);//æ±‚ä¸¤ä¸ªç‚¹ä¹‹é—´çš„è·ç¦»float distance = (closest1 - closest2).sqrMagnitude;//è·ç¦»å°äºŽç­‰äºŽåŠå¾„å¹³æ–¹åˆ™ç¢°æ’žif (distance &lt;= totalRadius)&#123; return true;&#125;else&#123; return false;&#125; ä»£ç å·¥å…·å‡½æ•°æ±‚çº¿æ®µä¸Šæœ€è¿‘ç‚¹12345678private Vector3 GetClosestPointOnLineSegment(Vector3 start, Vector3 end, Vector3 point)&#123; Vector3 line = end - start; //dot line line æ±‚é•¿åº¦å¹³æ–¹ float ratio = Vector3.Dot(point - start, line) / Vector3.Dot(line, line); ratio = Mathf.Min(Mathf.Max(ratio, 0), 1); return start + ratio * line;&#125; æ±‚AABBæœ€è¿‘ç‚¹123456789private Vector3 GetClosestPointAABB(Vector3 pos, CollisionData other)&#123; //Vector3 center = data1.center; Vector3 nearP = Vector3.zero; nearP.x = Mathf.Clamp(pos.x, other.min.x, other.max.x); nearP.y = Mathf.Clamp(pos.y, other.min.y, other.max.y); nearP.z = Mathf.Clamp(pos.z, other.min.z, other.max.z); return nearP;&#125; æ±‚OBBæœ€è¿‘ç‚¹1234567891011121314151617181920212223private Vector3 GetClosestPointOBB(Vector3 pos,CollisionData other)&#123; Vector3 nearP = data2.center; //æ±‚çƒå¿ƒä¸ŽOBBä¸­å¿ƒçš„è·ç¦»å‘é‡ ä»ŽOBBä¸­å¿ƒæŒ‡å‘çƒå¿ƒ Vector3 center1 = pos; Vector3 center2 = data2.center; Vector3 dist = center1 - center2; float[] extents = new float[3] &#123; data2.extents.x, data2.extents.y, data2.extents.z &#125;; Vector3[] axes = data2.axes; for (int i = 0; i &lt; 3; i++) &#123; //è®¡ç®—è·ç¦»å‘é‡åˆ°OBBåæ ‡è½´çš„æŠ•å½±é•¿åº¦ å³è·ç¦»å‘é‡åœ¨OBBåæ ‡ç³»ä¸­çš„å¯¹åº”åæ ‡è½´çš„é•¿åº¦ float distance = Vector3.Dot(dist, axes[i]); distance = Mathf.Clamp(distance, -extents[i], extents[i]); //è¿˜åŽŸåˆ°ä¸–ç•Œåæ ‡ nearP.x += distance * axes[i].x; nearP.y += distance * axes[i].y; nearP.z += distance * axes[i].z; &#125; return nearP;&#125; ç¢°æ’žæ£€æµ‹åœ†AABBOBBå°„çº¿12345678910111213141516171819202122private void CollisionCapsule2Circle(CollisionData data1,CollisionData data2)&#123; //è®¡ç®—å¤´å°¾ç‚¹æœ€å€¼ Vector3 point1 = data1.center + data1.direction * data1.extents.y; Vector3 point2 = data1.center - data1.direction * data1.extents.y; Vector3 closest = GetClosestPointOnLineSegment(point1, point2, data2.center); //æ±‚ä¸¤ä¸ªçƒåŠå¾„å’Œ float totalRadius = Mathf.Pow(data1.radius + data2.radius, 2); //çƒä¸¤ä¸ªçƒå¿ƒä¹‹é—´çš„è·ç¦» float distance = (closest - data2.center).sqrMagnitude; //è·ç¦»å°äºŽç­‰äºŽåŠå¾„å’Œåˆ™ç¢°æ’ž if (distance &lt;= totalRadius) &#123; return true; &#125; else &#123; return false; &#125;&#125;1234567891011121314151617181920212223private void CollisionCapsule2AABB(CollisionData data1,CollisionData data2)&#123; //è®¡ç®—å¤´å°¾ç‚¹æœ€å€¼ Vector3 pointA1 = data1.center + data1.direction * data1.extents.y; Vector3 pointA2 = data1.center - data1.direction * data1.extents.y; Vector3 closest1 = GetClosestPointOnLineSegment(pointA1, pointA2, closest2); Vector3 closest2 = GetClosestPointAABB(closest1, data2); //æ±‚èƒ¶å›Šä½“åŠå¾„å¹³æ–¹ float totalRadius = Mathf.Pow(data1.radius, 2); //æ±‚ä¸¤ä¸ªç‚¹ä¹‹é—´çš„è·ç¦» float distance = (closest1 - closest2).sqrMagnitude; //è·ç¦»å°äºŽç­‰äºŽåŠå¾„å¹³æ–¹åˆ™ç¢°æ’ž if (distance &lt;= totalRadius) &#123; return true; &#125; else &#123; return false; &#125;&#125;1234567891011121314151617181920212223private void CollisionCapsule2OBB(CollisionData data1,CollisionData data2)&#123; //è®¡ç®—å¤´å°¾ç‚¹æœ€å€¼ Vector3 pointA1 = data1.center + data1.direction * data1.extents.y; Vector3 pointA2 = data1.center - data1.direction * data1.extents.y; Vector3 closest1 = GetClosestPointOnLineSegment(pointA1, pointA2, closest2); Vector3 closest2 = GetClosestPointOBB(closest1, data2); //æ±‚èƒ¶å›Šä½“åŠå¾„å¹³æ–¹ float totalRadius = Mathf.Pow(data1.radius, 2); //æ±‚ä¸¤ä¸ªç‚¹ä¹‹é—´çš„è·ç¦» float distance = (closest1 - closest2).sqrMagnitude; //è·ç¦»å°äºŽç­‰äºŽåŠå¾„å¹³æ–¹åˆ™ç¢°æ’ž if (distance &lt;= totalRadius) &#123; return true; &#125; else &#123; return false; &#125;&#125;123456789101112131415161718192021222324252627282930313233343536373839private void CollisionRay2Capsule(CollisionData data1,CollisionData data2)&#123; //è®¡ç®—å¤´å°¾ç‚¹æœ€å€¼ Vector3 pointA1 = data1.center; Vector3 pointA2 = data1.center + data1.direction * data1.radius; Vector3 pointB1 = data2.center + data2.direction * data2.extents.y; Vector3 pointB2 = data2.center - data2.direction * data2.extents.y; Vector3 center = (pointA1 + pointA2) * 0.5f; Vector3 closest2; if ((pointB1 - center).magnitude &lt;= (pointB2 - center).magnitude) &#123; closest2 = pointB1; &#125; else &#123; closest2 = pointB2; &#125; Vector3 closest1 = GetClosestPointOnLineSegment(pointA1, pointA2, closest2); closest2 = GetClosestPointOnLineSegment(pointB1, pointB2, closest1); //æ±‚èƒ¶å›Šä½“åŠå¾„å¹³æ–¹ float totalRadius = Mathf.Pow(data2.radius, 2); //æ±‚ä¸¤ä¸ªç‚¹ä¹‹é—´çš„è·ç¦» float distance = (closest1 - closest2).sqrMagnitude; //è·ç¦»å°äºŽç­‰äºŽåŠå¾„å¹³æ–¹åˆ™ç¢°æ’ž if (distance &lt;= totalRadius) &#123; return true; &#125; else &#123; return false; &#125;&#125; é¡¹ç›®å·¥ç¨‹ æ›´æ–°æ—¥å¿—2024-05-19 ä¿®å¤ AABB ä¸Ž OBB æœ€è¿‘ç‚¹æ£€æµ‹ bugã€‚ 2024-04-18 ä¿®å¤ AABB ä¸Ž OBB æ±‚æœ€è¿‘ç‚¹å‚æ•°å¸¦å…¥é”™è¯¯ã€‚ 2024-03-05 æ›´æ–°èƒ¶å›Šä½“ä¸Žå…¶ä»–ç¢°æ’žæ£€æµ‹åŸºæœ¬å†…å®¹ã€‚","categories":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://busyogg.github.io/categories/%E7%AE%97%E6%B3%95/"},{"name":"ç¢°æ’žæ£€æµ‹","slug":"ç®—æ³•/ç¢°æ’žæ£€æµ‹","permalink":"https://busyogg.github.io/categories/%E7%AE%97%E6%B3%95/%E7%A2%B0%E6%92%9E%E6%A3%80%E6%B5%8B/"}],"tags":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://busyogg.github.io/tags/%E7%AE%97%E6%B3%95/"},{"name":"C#","slug":"C","permalink":"https://busyogg.github.io/tags/C/"},{"name":"ç¢°æ’žæ£€æµ‹","slug":"ç¢°æ’žæ£€æµ‹","permalink":"https://busyogg.github.io/tags/%E7%A2%B0%E6%92%9E%E6%A3%80%E6%B5%8B/"},{"name":"èƒ¶å›Šä½“","slug":"èƒ¶å›Šä½“","permalink":"https://busyogg.github.io/tags/%E8%83%B6%E5%9B%8A%E4%BD%93/"}]},{"title":"ç¢°æ’žæ£€æµ‹ä¹‹èƒ¶å›Šä½“","slug":"ç¢°æ’žæ£€æµ‹ä¹‹èƒ¶å›Šä½“","date":"2024-03-04T17:08:06.000Z","updated":"2024-05-30T12:25:53.983Z","comments":true,"path":"article/721cc45e1056/","link":"","permalink":"https://busyogg.github.io/article/721cc45e1056/","excerpt":"","text":"ç®€ä»‹æœ¬æ–‡ä¸»è¦é˜è¿°èƒ¶å›Šä½“ä¹‹é—´çš„ç¢°æ’žæ£€æµ‹åŽŸç†å’Œå®žçŽ°æ–¹å¼ã€‚ åŽŸç†èƒ¶å›Šä½“çš„è¡¨ç¤ºæˆ‘ä»¬ä½¿ç”¨ 5 ä¸ªå‚æ•°æ¥è¡¨ç¤ºä¸€ä¸ªèƒ¶å›Šä½“ã€‚ centerï¼šèƒ¶å›Šä½“çš„ä¸­å¿ƒä½ç½®ã€‚ height: èƒ¶å›Šä½“ä¸­é—´åœ†æŸ±éƒ¨åˆ†çš„é«˜åº¦ï¼Œæœ¬æ–‡ä½¿ç”¨ data.extents.y æ¥ä»£æ›¿ã€‚ radiusï¼šèƒ¶å›Šä½“çš„ä¸Šä¸‹åŠåœ†éƒ¨åˆ†çš„åŠå¾„ã€‚ rotationï¼šèƒ¶å›Šä½“çš„æ—‹è½¬è§’åº¦ã€‚ directionï¼šèƒ¶å›Šä½“çš„ç«–ç›´æ–¹å‘ã€‚ ç¢°æ’žæ£€æµ‹èƒ¶å›Šä½“çš„ç¢°æ’žæ£€æµ‹ï¼Œä¸»è¦çš„åŽŸç†å’Œåœ†çš„ç¢°æ’žæ£€æµ‹å·®ä¸å¤šã€‚æˆ‘ä»¬å¯ä»¥æŠŠèƒ¶å›Šä½“çœ‹æˆå¤šä¸ªåœ†å¿ƒåœ¨ä¸€ä¸ªçº¿æ®µä¸Šçš„çƒã€‚æˆ‘ä»¬åªè¦æ‰¾åˆ°ä¸¤ä¸ªèƒ¶å›Šä½“ä¹‹é—´æœ€è¿‘çš„ä¸¤ä¸ªçº¿æ®µä¸Šçš„ç‚¹ï¼Œå°±èƒ½ç”¨åœ†çš„ç¢°æ’žæ£€æµ‹åˆ¤æ–­ä¸¤ä¸ªèƒ¶å›Šä½“æ˜¯å¦ç›¸äº¤ã€‚ å¦‚å›¾æ‰€ç¤ºï¼Œåˆ¤æ–­ä¸¤ä¸ªèƒ¶å›Šä½“ç¢°æ’žï¼Œæˆ‘ä»¬ä¸»è¦åˆ¤æ–­ A ç‚¹å’Œ B ç‚¹çš„åœ†æ˜¯å¦ç›¸äº¤ã€‚ çŽ°åœ¨æˆ‘ä»¬çš„ç›®æ ‡å°±å¾ˆæ˜Žç¡®äº†ï¼Œæ‰¾å‡ºä¸¤ä¸ªèƒ¶å›Šä½“æœ€é€‚åˆçš„æ£€æµ‹ç‚¹ã€‚ é¦–å…ˆæˆ‘ä»¬è¦æ‰¾å‡ºä¸¤ä¸ªèƒ¶å›Šä½“çº¿æ®µçš„æœ€å¤§å€¼å’Œæœ€å°å€¼ï¼Œé€šè¿‡å¦‚ä¸‹è®¡ç®—å¯å¾—åˆ°ï¼š 123456//è®¡ç®—å¤´å°¾ç‚¹æœ€å€¼Vector3 pointA1 = data1.center + data1.direction * data1.extents.y;Vector3 pointA2 = data1.center - data1.direction * data1.extents.y;Vector3 pointB1 = data2.center + data2.direction * data2.extents.y;Vector3 pointB2 = data2.center - data2.direction * data2.extents.y; ç„¶åŽæˆ‘ä»¬è®¡ç®—ä¸¤ä¸ªèƒ¶å›Šä½“çº¿æ®µä¹‹é—´çš„æœ€å°è·ç¦»ï¼Œå¯ä»¥å‚è€ƒç¢°æ’žæ£€æµ‹ä¹‹çº¿æ®µæ£€æµ‹çš„å†…å®¹ã€‚ æœ€åŽæˆ‘ä»¬åªéœ€è¦è¿›è¡Œåœ†ä¸Žåœ†çš„ç¢°æ’žæ£€æµ‹å°±å¯ä»¥å¾—åˆ°æ˜¯å¦ç›¸äº¤äº†ã€‚ ä»£ç èƒ¶å›Šä½“ç¢°æ’žæ£€æµ‹1234567891011121314151617181920212223242526private bool CollisionCapsule(CollisionData data1,CollisionData data2)&#123; //è®¡ç®—å¤´å°¾ç‚¹æœ€å€¼ Vector3 pointA1 = data1.center + data1.direction * data1.extents.y; Vector3 pointA2 = data1.center - data1.direction * data1.extents.y; Vector3 pointB1 = data2.center + data2.direction * data2.extents.y; Vector3 pointB2 = data2.center - data2.direction * data2.extents.y; Vector3 closest1; // æ±‚ä¸¤æ¡çº¿æ®µçš„æœ€çŸ­è·ç¦» float distance = GetClosestDistanceBetweenLinesSqr(pointA1, pointA2, pointB1, pointB2); //æ±‚ä¸¤ä¸ªçƒåŠå¾„å’Œ float totalRadius = Mathf.Pow(data1.radius + data2.radius, 2); //è·ç¦»å°äºŽç­‰äºŽåŠå¾„å’Œåˆ™ç¢°æ’ž if (distance &lt;= totalRadius) &#123; return true; &#125; else &#123; return false; &#125;&#125; é¡¹ç›®åœ°å€ æ›´æ–°æ—¥å¿—2024-05-19 ä¿®å¤èƒ¶å›Šä½“æ£€æµ‹ bugã€‚ 2024-03-05 ä¿®æ”¹é”™åˆ«å­—ã€‚ 2024-03-05 æ›´æ–°èƒ¶å›Šä½“æ£€æµ‹åŸºç¡€å†…å®¹ã€‚","categories":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://busyogg.github.io/categories/%E7%AE%97%E6%B3%95/"},{"name":"ç¢°æ’žæ£€æµ‹","slug":"ç®—æ³•/ç¢°æ’žæ£€æµ‹","permalink":"https://busyogg.github.io/categories/%E7%AE%97%E6%B3%95/%E7%A2%B0%E6%92%9E%E6%A3%80%E6%B5%8B/"}],"tags":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://busyogg.github.io/tags/%E7%AE%97%E6%B3%95/"},{"name":"C#","slug":"C","permalink":"https://busyogg.github.io/tags/C/"},{"name":"ç¢°æ’žæ£€æµ‹","slug":"ç¢°æ’žæ£€æµ‹","permalink":"https://busyogg.github.io/tags/%E7%A2%B0%E6%92%9E%E6%A3%80%E6%B5%8B/"},{"name":"èƒ¶å›Šä½“","slug":"èƒ¶å›Šä½“","permalink":"https://busyogg.github.io/tags/%E8%83%B6%E5%9B%8A%E4%BD%93/"}]},{"title":"Unity-åˆ©ç”¨ç‰¹æ€§åå°„æ¥ç»‘å®š UI","slug":"åˆ©ç”¨ç‰¹æ€§åå°„æ¥ç»‘å®šUI","date":"2024-02-22T13:50:13.000Z","updated":"2024-05-30T12:25:22.927Z","comments":true,"path":"article/999bc53b642c/","link":"","permalink":"https://busyogg.github.io/article/999bc53b642c/","excerpt":"","text":"ç®€ä»‹UI ç•Œé¢åœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¾€å¾€éœ€è¦èŽ·å– UI ç»„ä»¶ï¼Œç„¶åŽåœ¨ UI ç»„ä»¶çš„å†…å®¹å‘ç”Ÿå˜åŒ–çš„æ—¶å€™å¯¹ UI ç»„ä»¶è¿›è¡Œèµ‹å€¼ã€‚æˆ‘ä»¬éœ€è¦åŒæ—¶ç®¡ç† UI ç»„ä»¶å’Œæ•°æ®ï¼Œæœ‰æ—¶å€™ä¼šè§‰å¾—å¾ˆç¹çã€‚äºŽæ˜¯æˆ‘æƒ³åˆ°åˆ©ç”¨ç‰¹æ€§ Attribute æ¥åå°„åˆå§‹åŒ– UI ç»„ä»¶ï¼Œä½¿å…¶å’Œæ•°æ®ç»‘å®šåœ¨ä¸€èµ·ï¼Œæ›´æ–°æ•°æ®å°±å¯ä»¥è‡ªåŠ¨æ›´æ–° UIã€‚ åœ¨æ­¤åŸºç¡€ä¸Šï¼Œæˆ‘åˆæ‹“å±•äº† UI åŠ¨ä½œç»‘å®šå’Œ UI ç›‘å¬ç»‘å®šï¼Œè¿™æ ·åªéœ€è¦å¯¹æ–¹æ³•æ ‡è®°ç‰¹æ€§ï¼Œå°±å¯ä»¥è‡ªåŠ¨å®Œæˆå¯¹åº”çš„ç»‘å®šå·¥ä½œã€‚ æœ¬æ¡†æž¶æ”¯æŒè‡ªå®šä¹‰æ‹“å±•åŠŸèƒ½ï¼Œå…·ä½“çš„ä½¿ç”¨è¯´æ˜Žå’Œæ‹“å±•è§„åˆ™è§ï¼š ReflectionBindUI æ–‡æ¡£ åŽŸç†UI æ•°æ®ç±»åž‹ä¸ºäº†å®žçŽ° UI æ•°æ®æ›´æ–°çš„åŒæ—¶æ›´æ–° UI ç•Œé¢ï¼Œå¹¶ä¸”ä¸éœ€è¦æˆ‘ä»¬è‡ªå·±åœ¨æ¯ä¸ª UI ç•Œé¢å±žæ€§ä¸­è®¾ç½® setter å“åº”äº‹ä»¶ï¼Œæˆ‘ä»¬å°±éœ€è¦ä¸€ä¸ªæ–°çš„ç±»åž‹æ¥è¡¨ç¤ºæ•°æ®ã€‚ æ–°çš„æ•°æ®ç±»åž‹å†…å®¹å¾ˆç®€å•ï¼Œå°±æ˜¯ä¿å­˜åŽŸå§‹æ•°æ®ï¼Œä»¥åŠè®¾ç½®ä¸€ä¸ªæ•°æ®æ›´æ”¹æ—¶çš„å“åº”å‡½æ•° _onValueChangeï¼Œä¸€ä¸ª UI æ›´æ”¹æ—¶çš„å“åº”å‡½æ•° _onUIChangeï¼Œåœ¨æ¯æ¬¡æ•°æ®å˜åŒ–æˆ– UI å˜åŒ–çš„æ—¶å€™è°ƒç”¨å³å¯ã€‚ åŽŸç†å°±æ˜¯åœ¨å€¼æ”¹å˜çš„æ—¶å€™åœ¨ set æ–¹æ³•ä¸­è°ƒç”¨ä¿®æ”¹ UI çš„å§”æ‰˜ï¼›åœ¨é€šè¿‡ Get() èŽ·å–å€¼çš„æ—¶å€™è°ƒç”¨åŒæ­¥ UI æ”¹å˜åŽçš„å€¼çš„å§”æ‰˜ã€‚ ä¸è¿‡ List ç±»åž‹æœ‰æ‰€ä¸åŒï¼Œä¸€èˆ¬ List ä¸ä¼šåœ¨ UI ä¸Šç›´æŽ¥ä¿®æ”¹ï¼Œæ‰€ä»¥åªæœ‰ _onValueChange ã€‚ StringUIPropDoubleUIPropUIListPropUI æ•°æ®ç±»åž‹ Stringï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹çš„é€‰æ‹©ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263using System;public class StringUIProp&#123; public string _value; private string val &#123; get &#123; return _value; &#125; set &#123; _value = value; InvokeUI(); &#125; &#125; private Action&lt;string&gt; _onValueChange = null; private Func&lt;string&gt; _onUIChange = null; public StringUIProp() &#123; &#125; public StringUIProp(string value) &#123; _value = value; &#125; public void Set(string value) &#123; this.val = value; &#125; public void Set&lt;T&gt;(T value) &#123; this.val = value.ToString(); &#125; public string Get() &#123; InvokeValue(); return this.val; &#125; public void InvokeValue() &#123; if (_onUIChange != null) &#123; _value = _onUIChange.Invoke(); &#125; &#125; public void InvokeUI() &#123; _onValueChange?.Invoke(val); &#125; public override string ToString() &#123; return val; &#125;&#125;UI æ•°æ®ç±»åž‹ Doubleï¼Œæ‹–æ‹½æ¡ä¹‹ç±»çš„æƒ…å†µä¸‹ä½¿ç”¨ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657using System;public class DoubleUIProp&#123; public double _value; private double val &#123; get &#123; return _value; &#125; set &#123; _value = value; InvokeUI(); &#125; &#125; private Action&lt;double&gt; _onValueChange = null; private Func&lt;double&gt; _onUIChange = null; public DoubleUIProp() &#123; &#125; public DoubleUIProp(double value) &#123; _value = value; &#125; public void Set(double value) &#123; this.val = value; &#125; public double Get() &#123; InvokeValue(); return this.val; &#125; public void InvokeValue() &#123; if (_onUIChange != null) &#123; _value = _onUIChange.Invoke(); &#125; &#125; public void InvokeUI() &#123; _onValueChange?.Invoke(val); &#125; public override string ToString() &#123; return val.ToString(); &#125;&#125;List çš„ UI æ•°æ®ç±»åž‹ï¼Œå“åº”äº‹ä»¶å’Œæ ‡å‡† UI ç±»åž‹ä¸åŒï¼Œå¹¶ä¸”æ•°æ®ç±»åž‹ä¸ºæ³›åž‹List&lt;T&gt;ä»¥é€‚åº”å„ç§æ•°æ®ç±»åž‹ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465using System;using System.Collections;using System.Collections.Generic;using UnityEngine;public class UIListProp&lt;T&gt;&#123; private List&lt;T&gt; _value; private List&lt;T&gt; val &#123; get &#123; return _value; &#125; set &#123; _value = value; Invoke(); &#125; &#125; public int Count &#123; get; set; &#125; private Action&lt;int&gt; _onValueChange = null; public UIListProp() &#123; &#125; public UIListProp(List&lt;T&gt; value) &#123; //this.val = value; _value = value; &#125; public List&lt;T&gt; Get() &#123; return val; &#125; public void Set(List&lt;T&gt; value) &#123; val = value; Count = val.Count; &#125; public void Invoke() &#123; if (val != null) &#123; _onValueChange?.Invoke(val.Count); &#125; &#125; public override string ToString() &#123; string res = &quot;[&quot;; foreach (var item in val) &#123; res += item.ToString() + &quot;,&quot;; &#125; res += &quot;]&quot;; return res; &#125;&#125; ç‰¹æ€§åˆå§‹åŒ–é™¤äº†ç”¨äºŽç»‘å®š UI çš„ç‰¹æ€§å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æ­é…è¾…åŠ©ç‰¹æ€§ï¼Œä¾‹å¦‚ UIColorã€UIOption ç­‰ï¼Œè¾…åŠ©åˆå§‹åŒ–çš„è®¾ç½®ï¼Œå…·ä½“ç”¨æ³•å‚è€ƒ ä½¿ç”¨æ–¹æ³•ã€‚ UICompBindUIDataBindUIActionBindUIListenerBindUIClassBindç»‘å®š UI ç»„ä»¶ï¼Œéœ€è¦ä¼ å…¥ç»„ä»¶ç±»åž‹å’Œè·¯å¾„ã€‚ 12345678910111213141516171819using System;using System.Collections;using System.Collections.Generic;using UnityEngine;/// &lt;summary&gt;/// ç»‘å®šUIç»„ä»¶/// &lt;/summary&gt;[AttributeUsage(AttributeTargets.Property)]public class UICompBind :Attribute&#123; public string _type; public string _path; public UICompBind(string type,string path) &#123; _type = type; _path = path; &#125;&#125;ç»‘å®š UI æ•°æ®ï¼Œéœ€è¦ä¼ å…¥ç»„ä»¶ç±»åž‹å’Œè·¯å¾„ã€‚ 1234567891011121314151617using System;/// &lt;summary&gt;/// ç»‘å®šUIç»„ä»¶å’Œæ•°æ®ï¼Œä½¿å…¶æ ¹æ®æ•°æ®ä¿®æ”¹UI/// &lt;/summary&gt;[AttributeUsage(AttributeTargets.Property)]public class UIDataBind : Attribute&#123; public string _type; public string _path; public UIDataBind(string type, string path) &#123; _type = type; _path = path; &#125;&#125;ç»‘å®š UI åŠ¨ä½œï¼Œéœ€è¦ä¼ å…¥ç»„ä»¶ç±»åž‹å’Œè·¯å¾„ã€‚ 12345678910111213141516171819using System;/// &lt;summary&gt;/// ç»‘å®šUIç»„ä»¶å’ŒåŠ¨ä½œäº‹ä»¶ï¼Œä½¿å…¶æ”¯æŒäº¤äº’/// &lt;/summary&gt;[AttributeUsage(AttributeTargets.Method)]public class UIActionBind : Attribute&#123; public string _type; public string _path; public UIActionBind(string type,string path) &#123; _type = type; _path = path; &#125;&#125;ç»‘å®š UI ç›‘å¬äº‹ä»¶ï¼Œåªéœ€è¦ä¼ å…¥ç›‘å¬äº‹ä»¶çš„åç§°ã€‚ç›‘å¬äº‹ä»¶çš„ id æ˜¯ç•Œé¢ idï¼Œè‡ªåŠ¨ä¼ å…¥ã€‚ 12345678910111213141516171819using System;using System.Collections;using System.Collections.Generic;using UnityEngine;/// &lt;summary&gt;/// ç»‘å®šUIç›‘å¬äº‹ä»¶/// &lt;/summary&gt;[AttributeUsage(AttributeTargets.Method)]public class UIListenerBind : Attribute&#123; public string _name; public UIListenerBind(string name) &#123; _name = name; &#125;&#125;ç»‘å®š UI ç±»ï¼Œéœ€è¦ä¼ å…¥ç±»è¡Œä¸ºå’Œé¢å¤–å‚æ•°ã€‚ 123456789101112using System;[AttributeUsage(AttributeTargets.Class)]public class UIClassBind : Attribute&#123; public UIClass type; public UIClassBind(UIClass type) &#123; this.type = type; &#125;&#125; åå°„ç»‘å®šæˆ‘ä»¬é€šè¿‡åŸºç±»åˆå§‹åŒ–èŽ·å– Typeï¼Œç„¶åŽé€šè¿‡ Type èŽ·å– properties å’Œ methodï¼ˆå¦‚æžœæœ‰éœ€è¦ä¹Ÿå¯ä»¥è‡ªå·±æ·»åŠ  fieldsï¼‰ï¼Œä¹‹åŽé€šè¿‡éåŽ†å±žæ€§å’Œæ–¹æ³•ï¼Œåœ¨å…¶å¾ªçŽ¯ä½“å†…èŽ·å–å¯¹åº”å±žæ€§æˆ–æ–¹æ³•çš„ç‰¹æ€§æ ‡ç­¾ï¼Œåˆ¤æ–­æ ‡ç­¾ç±»åž‹æ˜¯å¦ä¸º UI ç»‘å®šç±»åž‹ï¼Œæ˜¯åˆ™è¿›è¡Œå¯¹åº”çš„æ“ä½œã€‚ ä¸åŒç±»åž‹çš„ç»„ä»¶ç»‘å®šæ–¹æ³•å¯è‡ªè¡Œæ·»åŠ æˆ–ä¿®æ”¹ã€‚ ç»‘å®šç»„ä»¶ç»‘å®šæ•°æ®ç»‘å®šè¡Œä¸ºç»‘å®šç›‘å¬ç»‘å®šç±»12345678910111213private void BindComp(PropertyInfo prop, object attr, GComponent main)&#123; UICompBind uiBind = (UICompBind)attr; switch (uiBind._type) &#123; case &quot;Comp&quot;: GComponent comp = FguiUtils.GetUI&lt;GComponent&gt;(main, uiBind._path); prop.SetValue(this, comp); break; //...... &#125;&#125;123456789101112131415161718192021222324252627282930313233343536373839404142434445private void BindData(PropertyInfo prop, object attr, GComponent main)&#123; UIDataBind uiBind = (UIDataBind)attr; var onValueChange = prop.PropertyType.GetField(&quot;_onValueChange&quot;, _flag); var onUIChange = prop.PropertyType.GetField(&quot;_onUIChange&quot;, _flag); var value = prop.GetValue(this); if (value == null) &#123; if (prop.PropertyType.Equals(typeof(UIProp))) &#123; value = new UIProp(); &#125; else &#123; Type genericType = typeof(UIListProp&lt;&gt;).MakeGenericType(prop.PropertyType.GenericTypeArguments); value = Activator.CreateInstance(genericType); &#125; prop.SetValue(this, value); &#125; switch (uiBind._type) &#123; case &quot;TextField&quot;: GTextField textField = FguiUtils.GetUI&lt;GTextField&gt;(main, uiBind._path); void ActionText(string data) &#123; if (textField != null) &#123; textField.text = data; &#125; &#125; string ActionTextUI() &#123; return textField.text; &#125; onValueChange?.SetValue(value, (Action&lt;string&gt;)ActionText); onUIChange?.SetValue(value, (Func&lt;string&gt;)ActionTextUI); break; //...... &#125;&#125;1234567891011121314151617181920212223private void BindAction(MethodInfo method, object attr, GComponent main)&#123; UIActionBind uiBind = (UIActionBind)attr; GObject obj = FguiUtils.GetUI&lt;GObject&gt;(main, uiBind._path); switch (uiBind._type) &#123; case &quot;Click&quot;: var methondParamsClick = method.GetParameters(); Delegate click = null; if (methondParamsClick.Length == 0) &#123; click = Delegate.CreateDelegate(typeof(EventCallback0), this, method); obj.onClick.Set((EventCallback0)click); &#125; else &#123; click = Delegate.CreateDelegate(typeof(EventCallback1), this, method); obj.onClick.Set((EventCallback1)click); &#125; break; //...... &#125;&#125;123456private void BindListener(MethodInfo method, object attr, string id)&#123; UIListenerBind uiBind = (UIListenerBind)attr; var eventFunc = Delegate.CreateDelegate(typeof(Action&lt;ArrayList&gt;), this, method); EventManager.AddListening(id, uiBind._name, (Action&lt;ArrayList&gt;)eventFunc);&#125;æœ¬æ–¹æ³•ä¸Žå…¶ä»–æ–¹æ³•ä¸åŒï¼Œå…¶ä»–æ–¹æ³•åœ¨ UIBase ä¸­åˆå§‹åŒ–ï¼Œæœ¬æ–¹æ³•åœ¨ BaseView ä¸­åˆå§‹åŒ–ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142/// &lt;summary&gt;/// ç»‘å®š ç±»/// &lt;/summary&gt;/// &lt;param name=&quot;attr&quot;&gt;&lt;/param&gt;private void BindClass(object attr)&#123; UIClassBind uiClassBind = (UIClassBind)attr; switch (uiClassBind.type) &#123; case UIClass.Model: if (_model == null) &#123; _model = new GGraph(); _model.displayObject.gameObject.name = id + &quot;_&quot; + name + &quot;_Model&quot;; UIColor colorAttr = _type.GetCustomAttribute&lt;UIColor&gt;(); Color color = new Color(0, 0, 0, 0); if (colorAttr != null) &#123; color = colorAttr.color; &#125; Vector2 size = GRoot.inst.size; _model.DrawRect(size.x, size.y, 0, new Color(), color); &#125; UIManager.Ins().SetModel(uiNode, _model); _model.onClick.Set(() =&gt; &#123; if (uiClassBind.extra.Length &gt; 0 &amp;&amp; uiClassBind.extra[0] == &quot;Hide&quot;) &#123; Hide(); main.AddChild(_model); &#125; &#125;); break; //å…¶ä»–case &#125;&#125; æŸ¥æ‰¾ UIç»‘å®šç»„ä»¶å¿…ä¸å¯å°‘çš„å°±æ˜¯æŸ¥æ‰¾ UIï¼Œæœ¬é¡¹ç›®ä½¿ç”¨ FGUIï¼Œå› æ­¤æŸ¥æ‰¾ UI ä¹Ÿæ˜¯æ ¹æ® FGUI å†™çš„ã€‚ æ ¹æ®ä¼ å…¥çš„è·¯å¾„ï¼Œæ‹†åˆ†ä¸ºæ¯ä¸€å±‚å…·ä½“çš„ç´¢å¼•ï¼Œç„¶åŽåˆ¤æ–­ç´¢å¼•æ˜¯æ•°å­—è¿˜æ˜¯å­—ç¬¦ä¸²ï¼Œæ˜¯æ•°å­—å°±è°ƒç”¨ GetChildAtï¼Œæ˜¯å­—ç¬¦ä¸²å°±è°ƒç”¨ GetChildã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041/// &lt;summary&gt;/// æ ¹æ®è·¯å¾„èŽ·å–UIç»„ä»¶/// &lt;/summary&gt;/// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;/// &lt;param name=&quot;comp&quot;&gt;&lt;/param&gt;/// &lt;param name=&quot;path&quot;&gt;&lt;/param&gt;/// &lt;returns&gt;&lt;/returns&gt;public static T GetUI&lt;T&gt;(GComponent comp, string path) where T : GObject&#123; string[] paths = path.Split(&#x27;/&#x27;); GObject res = null; GComponent parent = comp; foreach (string s in paths) &#123; if (s == &quot;&quot;) continue; int output; bool isNumeric = int.TryParse(s, out output); if (isNumeric) &#123; res = parent.GetChildAt(output); &#125; else &#123; res = parent.GetChild(s); &#125; if (res == null) &#123; ConsoleUtils.Error(&quot;uiè·¯å¾„é”™è¯¯&quot;, path); return null; &#125; if (res is GComponent) &#123; parent = res.asCom; &#125; else &#123; break; &#125; &#125; return res as T;&#125; ç¼“åŠ¨åŠ¨ç”»æœ¬é¡¹ç›®å®žçŽ°äº†ä¸€ä¸ªç®€å•çš„ç¼“åŠ¨åŠ¨ç”»ç³»ç»Ÿï¼Œç”¨äºŽæŽ§åˆ¶ UI çª—å£çš„è¿›å…¥å’Œé€€å‡ºç¼“åŠ¨åŠ¨ç”»ã€‚ ç¼“åŠ¨åŠ¨ç”»çš„åŽŸç†å¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨æŒç»­æ—¶é—´å†…æ¯å¸§åšæ’å€¼ã€‚ æ’å€¼å‡½æ•°ç¼“åŠ¨å•å…ƒç¼“åŠ¨æ›´æ–°ç¼“åŠ¨ç®¡ç†ç±»ä½¿ç”¨ Laya å¼•æ“Žå†…çš„æ’å€¼å‡½æ•°ä¿®æ”¹è€Œæˆã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250using System;using UnityEngine;public enum TweenEaseType&#123; Linear, SineIn, SineOut, SineInOut, QuadIn, QuadOut, QuadInOut, CubicIn, CubicOut, CubicInOut, QuartIn, QuartOut, QuartInOut, QuintIn, QuintOut, QuintInOut, ExpoIn, ExpoOut, ExpoInOut, CircIn, CircOut, CircInOut, ElasticIn, ElasticOut, ElasticInOut, BackIn, BackOut, BackInOut, BounceIn, BounceOut, BounceInOut, Custom&#125;public class EaseUtil&#123; const float _PiOver2 = Mathf.PI * 0.5f; const float _TwoPi = Mathf.PI * 2; internal static float Evaluate(TweenEaseType TweenEaseType, float time, float duration, float overshootOrAmplitude, float period) &#123; if (duration &lt;= 0) return 1; switch (TweenEaseType) &#123; case TweenEaseType.Linear: return time / duration; case TweenEaseType.SineIn: return -(float)Math.Cos(time / duration * _PiOver2) + 1; case TweenEaseType.SineOut: return (float)Math.Sin(time / duration * _PiOver2); case TweenEaseType.SineInOut: return -0.5f * ((float)Math.Cos(Mathf.PI * time / duration) - 1); case TweenEaseType.QuadIn: return (time /= duration) * time; case TweenEaseType.QuadOut: return -(time /= duration) * (time - 2); case TweenEaseType.QuadInOut: if ((time /= duration * 0.5f) &lt; 1) return 0.5f * time * time; return -0.5f * ((--time) * (time - 2) - 1); case TweenEaseType.CubicIn: return (time /= duration) * time * time; case TweenEaseType.CubicOut: return ((time = time / duration - 1) * time * time + 1); case TweenEaseType.CubicInOut: if ((time /= duration * 0.5f) &lt; 1) return 0.5f * time * time * time; return 0.5f * ((time -= 2) * time * time + 2); case TweenEaseType.QuartIn: return (time /= duration) * time * time * time; case TweenEaseType.QuartOut: return -((time = time / duration - 1) * time * time * time - 1); case TweenEaseType.QuartInOut: if ((time /= duration * 0.5f) &lt; 1) return 0.5f * time * time * time * time; return -0.5f * ((time -= 2) * time * time * time - 2); case TweenEaseType.QuintIn: return (time /= duration) * time * time * time * time; case TweenEaseType.QuintOut: return ((time = time / duration - 1) * time * time * time * time + 1); case TweenEaseType.QuintInOut: if ((time /= duration * 0.5f) &lt; 1) return 0.5f * time * time * time * time * time; return 0.5f * ((time -= 2) * time * time * time * time + 2); case TweenEaseType.ExpoIn: return (time == 0) ? 0 : (float)Math.Pow(2, 10 * (time / duration - 1)); case TweenEaseType.ExpoOut: if (time == duration) return 1; return (-(float)Math.Pow(2, -10 * time / duration) + 1); case TweenEaseType.ExpoInOut: if (time == 0) return 0; if (time == duration) return 1; if ((time /= duration * 0.5f) &lt; 1) return 0.5f * (float)Math.Pow(2, 10 * (time - 1)); return 0.5f * (-(float)Math.Pow(2, -10 * --time) + 2); case TweenEaseType.CircIn: return -((float)Math.Sqrt(1 - (time /= duration) * time) - 1); case TweenEaseType.CircOut: return (float)Math.Sqrt(1 - (time = time / duration - 1) * time); case TweenEaseType.CircInOut: if ((time /= duration * 0.5f) &lt; 1) return -0.5f * ((float)Math.Sqrt(1 - time * time) - 1); return 0.5f * ((float)Math.Sqrt(1 - (time -= 2) * time) + 1); case TweenEaseType.ElasticIn: float s0; if (time == 0) return 0; if ((time /= duration) == 1) return 1; if (period == 0) period = duration * 0.3f; if (overshootOrAmplitude &lt; 1) &#123; overshootOrAmplitude = 1; s0 = period / 4; &#125; else s0 = period / _TwoPi * (float)Math.Asin(1 / overshootOrAmplitude); return -(overshootOrAmplitude * (float)Math.Pow(2, 10 * (time -= 1)) * (float)Math.Sin((time * duration - s0) * _TwoPi / period)); case TweenEaseType.ElasticOut: float s1; if (time == 0) return 0; if ((time /= duration) == 1) return 1; if (period == 0) period = duration * 0.3f; if (overshootOrAmplitude &lt; 1) &#123; overshootOrAmplitude = 1; s1 = period / 4; &#125; else s1 = period / _TwoPi * (float)Math.Asin(1 / overshootOrAmplitude); return (overshootOrAmplitude * (float)Math.Pow(2, -10 * time) * (float)Math.Sin((time * duration - s1) * _TwoPi / period) + 1); case TweenEaseType.ElasticInOut: float s; if (time == 0) return 0; if ((time /= duration * 0.5f) == 2) return 1; if (period == 0) period = duration * (0.3f * 1.5f); if (overshootOrAmplitude &lt; 1) &#123; overshootOrAmplitude = 1; s = period / 4; &#125; else s = period / _TwoPi * (float)Math.Asin(1 / overshootOrAmplitude); if (time &lt; 1) return -0.5f * (overshootOrAmplitude * (float)Math.Pow(2, 10 * (time -= 1)) * (float)Math.Sin((time * duration - s) * _TwoPi / period)); return overshootOrAmplitude * (float)Math.Pow(2, -10 * (time -= 1)) * (float)Math.Sin((time * duration - s) * _TwoPi / period) * 0.5f + 1; case TweenEaseType.BackIn: return (time /= duration) * time * ((overshootOrAmplitude + 1) * time - overshootOrAmplitude); case TweenEaseType.BackOut: return ((time = time / duration - 1) * time * ((overshootOrAmplitude + 1) * time + overshootOrAmplitude) + 1); case TweenEaseType.BackInOut: if ((time /= duration * 0.5f) &lt; 1) return 0.5f * (time * time * (((overshootOrAmplitude *= (1.525f)) + 1) * time - overshootOrAmplitude)); return 0.5f * ((time -= 2) * time * (((overshootOrAmplitude *= (1.525f)) + 1) * time + overshootOrAmplitude) + 2); case TweenEaseType.BounceIn: return Bounce.EaseIn(time, duration); case TweenEaseType.BounceOut: return Bounce.EaseOut(time, duration); case TweenEaseType.BounceInOut: return Bounce.EaseInOut(time, duration); default: return -(time /= duration) * (time - 2); &#125; &#125;&#125;/// &lt;summary&gt;/// This class contains a C# port of the easing equations created by Robert Penner (http://robertpenner.com/easing)./// &lt;/summary&gt;static class Bounce&#123; /// &lt;summary&gt; /// Easing equation function for a bounce (exponentially decaying parabolic bounce) easing in: accelerating from zero velocity. /// &lt;/summary&gt; /// &lt;param name=&quot;time&quot;&gt; /// Current time (in frames or seconds). /// &lt;/param&gt; /// &lt;param name=&quot;duration&quot;&gt; /// Expected easing duration (in frames or seconds). /// &lt;/param&gt; /// &lt;returns&gt; /// The eased value. /// &lt;/returns&gt; public static float EaseIn(float time, float duration) &#123; return 1 - EaseOut(duration - time, duration); &#125; /// &lt;summary&gt; /// Easing equation function for a bounce (exponentially decaying parabolic bounce) easing out: decelerating from zero velocity. /// &lt;/summary&gt; /// &lt;param name=&quot;time&quot;&gt; /// Current time (in frames or seconds). /// &lt;/param&gt; /// &lt;param name=&quot;duration&quot;&gt; /// Expected easing duration (in frames or seconds). /// &lt;/param&gt; /// &lt;returns&gt; /// The eased value. /// &lt;/returns&gt; public static float EaseOut(float time, float duration) &#123; if ((time /= duration) &lt; (1 / 2.75f)) &#123; return (7.5625f * time * time); &#125; if (time &lt; (2 / 2.75f)) &#123; return (7.5625f * (time -= (1.5f / 2.75f)) * time + 0.75f); &#125; if (time &lt; (2.5f / 2.75f)) &#123; return (7.5625f * (time -= (2.25f / 2.75f)) * time + 0.9375f); &#125; return (7.5625f * (time -= (2.625f / 2.75f)) * time + 0.984375f); &#125; /// &lt;summary&gt; /// Easing equation function for a bounce (exponentially decaying parabolic bounce) easing in/out: acceleration until halfway, then deceleration. /// &lt;/summary&gt; /// &lt;param name=&quot;time&quot;&gt; /// Current time (in frames or seconds). /// &lt;/param&gt; /// &lt;param name=&quot;duration&quot;&gt; /// Expected easing duration (in frames or seconds). /// &lt;/param&gt; /// &lt;returns&gt; /// The eased value. /// &lt;/returns&gt; public static float EaseInOut(float time, float duration) &#123; if (time &lt; duration * 0.5f) &#123; return EaseIn(time * 2, duration) * 0.5f; &#125; return EaseOut(time * 2 - duration, duration) * 0.5f + 0.5f; &#125;&#125;åŒ…å«äº†ç¼“åŠ¨éœ€è¦çš„æ‰€æœ‰æ•°æ®å’Œæ–¹æ³•ã€‚ 12345678910111213141516171819202122232425262728293031323334using System;using UnityEngine;public class UITween&#123; public int id; public float duration; private int _time; public bool isStop; public Action&lt;float&gt; updater; public Action callback; public void Update(int delta) &#123; _time += delta; if (_time &lt;= duration) &#123; updater?.Invoke(_time); &#125; else &#123; updater?.Invoke(duration); callback?.Invoke(); isStop = true; updater = null; callback = null; &#125; &#125;&#125;ç¼“åŠ¨åŠ¨ç”»éœ€è¦ä¾æ‰˜ MonoBehaviour æ¥è¿›è¡Œæ›´æ–°ï¼Œå› æ­¤æˆ‘ä»¬è®¾ç½®ä¸€ä¸ªè„šæœ¬ä¸“é—¨ç”¨äºŽæ›´æ–°ç¼“åŠ¨ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950using System.Collections.Generic;using UnityEngine;public class TweenUpdater : MonoBehaviour&#123; private Dictionary&lt;int,UITween&gt; _actions = new Dictionary&lt;int,UITween&gt;(); private List&lt;int&gt; _removeActionIndexes = new List&lt;int&gt;(); void Update() &#123; int delta = (int)(Time.deltaTime * 1000); foreach (var action in _actions) &#123; UITween vt = action.Value; if (vt.isStop) &#123; _removeActionIndexes.Add(vt.id); &#125; else &#123; vt.Update(delta); &#125; &#125; for (int i = _removeActionIndexes.Count - 1; i &gt;= 0; i--) &#123; _actions.Remove(_removeActionIndexes[i]); _removeActionIndexes.RemoveAt(i); &#125; &#125; public void AddTween(UITween tween) &#123; _actions.Add(tween.id,tween); &#125; public void StopTween(int id) &#123; UITween tween; _actions.TryGetValue(id, out tween); if (tween != null) &#123; tween.isStop = true; &#125; &#125;&#125;æœ¬ç±»ä¸ºå•ä¾‹æ¨¡å¼ï¼Œå®žçŽ°äº†ç¼“åŠ¨çš„åˆ›å»ºå’Œåœæ­¢ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154using System;using FairyGUI;using UnityEngine;public class UITweenManager : Singleton&lt;UITweenManager&gt;&#123; private TweenUpdater _updater; private int _id = 0; public void Init() &#123; GameObject obj = new GameObject(); obj.name = &quot;TweenUpdater&quot;; _updater = obj.AddComponent&lt;TweenUpdater&gt;(); &#125; public int AddTween(GObject obj, TweenTarget target, float end, int duration, TweenEaseType ease = TweenEaseType.Linear, Action callback = null) &#123; UITween vt = new UITween(); vt.id = _id++; vt.duration = duration; vt.updater = GenerateUpdater(obj, target, end, duration, ease); vt.callback = callback; _updater.AddTween(vt); return vt.id; &#125; public int AddTween(GObject obj, TweenTarget target, Vector2 end, int duration, TweenEaseType ease = TweenEaseType.Linear, Action callback = null) &#123; UITween vt = new UITween(); vt.id = _id++; vt.duration = duration; vt.updater = GenerateUpdater(obj, target, end, duration, ease); vt.callback = callback; _updater.AddTween(vt); return vt.id; &#125; public void StopTween(int id) &#123; _updater.StopTween(id); &#125; private Action&lt;float&gt; GenerateUpdater(GObject obj, TweenTarget target, float end, float duration, TweenEaseType ease) &#123; float origin = 0; switch (target) &#123; case TweenTarget.X: origin = obj.x; break; case TweenTarget.Y: origin = obj.y; break; case TweenTarget.ScaleX: origin = obj.scaleX; break; case TweenTarget.ScaleY: origin = obj.scaleY; break; case TweenTarget.Rotation: origin = obj.rotation; break; case TweenTarget.Alpha: origin = obj.alpha; break; case TweenTarget.Heihgt: origin = obj.height; break; case TweenTarget.Width: origin = obj.width; break; &#125; void Action(float time) &#123; float ratio = EaseUtil.Evaluate(ease, time, duration, 1.7f, 0); switch (target) &#123; case TweenTarget.X: obj.x = origin + ratio * end; break; case TweenTarget.Y: obj.y = origin + ratio * end; break; case TweenTarget.ScaleX: obj.scaleX = origin + ratio * end; break; case TweenTarget.ScaleY: obj.scaleY = origin + ratio * end; break; case TweenTarget.Rotation: obj.rotation = origin + ratio * end; break; case TweenTarget.Alpha: obj.alpha = origin + ratio * end; break; case TweenTarget.Heihgt: obj.height = origin + ratio * end; break; case TweenTarget.Width: obj.width = origin + ratio * end; break; &#125; &#125; return Action; &#125; private Action&lt;float&gt; GenerateUpdater(GObject obj, TweenTarget target, Vector2 end, float duration, TweenEaseType ease) &#123; Vector2 origin = Vector2.zero; switch (target) &#123; case TweenTarget.Position: origin = obj.xy; break; case TweenTarget.Scale: origin = obj.scale; break; case TweenTarget.Size: origin = obj.size; break; &#125; void Action(float time) &#123; float ratio = EaseUtil.Evaluate(ease, time, duration, 1.7f, 0); switch (target) &#123; case TweenTarget.Position: obj.xy = origin + ratio * end; break; case TweenTarget.Scale: obj.scale = origin + ratio * end; break; case TweenTarget.Size: obj.size = origin + ratio * end; break; &#125; &#125; return Action; &#125;&#125; UI ç®¡ç†å™¨UI èŠ‚ç‚¹UI ç®¡ç†å™¨UI èŠ‚ç‚¹é€šè¿‡æ ‘ç»“æž„è¿›è¡Œå­˜å‚¨ã€‚ é€»è¾‘æƒ…å†µä¸‹ï¼ŒåŒçº§ UI åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸‹ï¼Œå­çº§ UI åœ¨å…¶æ·»åŠ çš„èŠ‚ç‚¹ä¸‹ã€‚ UI å…ƒç´ æƒ…å†µä¸‹ï¼Œçº§æ•°ç›¸åŒçš„ UI åœ¨åŒä¸€ä¸ª Layer å…ƒç´ ï¼ˆGComponentï¼‰ä¸‹ã€‚ è¿™æ ·å°±å¯ä»¥åœ¨åŒä¸€ä¸ªå±‚çº§ä¸­è¿›è¡Œç½®é¡¶æ“ä½œå¹¶ä¸å½±å“å…¶ä»–å±‚çº§çš„ UIã€‚ 123456789101112131415161718192021222324using System.Collections.Generic;public class UINode&#123; /// &lt;summary&gt; /// çˆ¶èŠ‚ç‚¹ /// &lt;/summary&gt; public UINode parent; /// &lt;summary&gt; /// å±‚çº§ç´¢å¼• /// &lt;/summary&gt; public int layer; /// &lt;summary&gt; /// æ‰€å±žUI /// &lt;/summary&gt; public BaseView ui; /// &lt;summary&gt; /// å­èŠ‚ç‚¹ /// &lt;/summary&gt; public Dictionary&lt;string, UINode&gt; children = new Dictionary&lt;string, UINode&gt;();&#125;UI ç®¡ç†å™¨å°è£… UI å¸¸ç”¨æ“ä½œã€‚ å±•ç¤º UIï¼Œå¦‚æžœä¼ å…¥ UINodeï¼Œåˆ™åœ¨è¯¥èŠ‚ç‚¹ä¸‹å±•ç¤ºï¼Œå¦åˆ™åœ¨æ ¹èŠ‚ç‚¹ä¸‹å±•ç¤º UIã€‚å¦‚æžœæœ‰ä¿å­˜è¿‡ UIï¼Œåˆ™ç›´æŽ¥å±•ç¤ºä¿å­˜çš„ UIã€‚ éšè— | é”€æ¯ UIï¼Œæ ¹æ®æ ‘ç»“æž„ï¼ŒéåŽ†å­èŠ‚ç‚¹æ‰§è¡Œç›¸åŒæ“ä½œã€‚ æŸ¥æ‰¾ UIï¼Œå¦‚æžœä¼ å…¥ UINodeï¼Œåˆ™ä»Žè¯¥èŠ‚ç‚¹å¼€å§‹æŸ¥æ‰¾ï¼Œå¦åˆ™ä»Žæ ¹èŠ‚ç‚¹å¼€å§‹æŸ¥æ‰¾ã€‚ ä»¥ä¸‹ä¸º BaseView è‡ªåŠ¨æ‰§è¡Œçš„æ“ä½œï¼Œæ— éœ€ä¸»åŠ¨è°ƒç”¨ï¼š ResetTopï¼ŒåŽŸç†æ˜¯åˆ©ç”¨ FGUI çš„ AddChild é‡æ–°æ’å…¥ UI å…ƒç´ ï¼Œä½¿å…¶ç½®é¡¶æ˜¾ç¤ºã€‚ SetModelï¼Œè®¾ç½®æ¨¡æ€èƒŒæ™¯ï¼ŒåŽŸç†æ˜¯åœ¨å½“å‰éœ€è¦æ¨¡æ€çš„ UI å…ƒç´ çš„ä½ç½®æ’å…¥ä¸€ä¸ª GGraph å¯¹è±¡ï¼Œå½“å‰ UI å…ƒç´ ä¼šåœ¨åŽŸæ¥ç´¢å¼• +1 çš„ä½ç½®ï¼Œè¿™æ ·å°±ä¿è¯èƒŒæ™¯åœ¨ UI å…ƒç´ ä¸‹æ–¹å¹¶ä¸”ä¸å— UI å…ƒç´ çª—å£çš„å½±å“ã€‚ SaveNodeï¼Œåˆ©ç”¨å­—å…¸ä¿å­˜ UI ç•Œé¢ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188using System;using System.Collections.Generic;using FairyGUI;public class UIManager : Singleton&lt;UIManager&gt;&#123; private UINode _root = new UINode(); private int _id = 0; private List&lt;GComponent&gt; _layer = new List&lt;GComponent&gt;(); private Dictionary&lt;string, UINode&gt; _savedView = new Dictionary&lt;string, UINode&gt;(); /// &lt;summary&gt; /// å±•ç¤ºUI /// &lt;/summary&gt; /// &lt;param name=&quot;folder&quot;&gt;&lt;/param&gt; /// &lt;param name=&quot;package&quot;&gt;&lt;/param&gt; /// &lt;param name=&quot;name&quot;&gt;&lt;/param&gt; /// &lt;param name=&quot;parent&quot;&gt;&lt;/param&gt; /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt; /// &lt;returns&gt;&lt;/returns&gt; public UINode ShowUI&lt;T&gt;(string folder, string package, string name, UINode parent = null) where T : BaseView, new() &#123; //æœ‰ä¿å­˜çš„UIç›´æŽ¥å±•ç¤ºå¹¶è¿”å›ž if (_savedView.TryGetValue(name, out var node)) &#123; node.ui.Show(); return node; &#125; //åˆ›å»ºæ²¡ä¿å­˜çš„UI Type type = typeof(T); //åŒ…åŠ è½½é€»è¾‘æš‚æ—¶åŠ è½½Resourcesæ–‡ä»¶å¤¹å†…æ–‡ä»¶ å¦‚æœ‰éœ€è¦å¯è‡ªè¡Œä¿®æ”¹ string packagePath = folder + &quot;/&quot; + package; UIPackage.AddPackage(packagePath); //åˆ›å»ºUI T view = new T(); view.id = &quot;ui_&quot; + _id++; view.name = name; view.main = UIPackage.CreateObject(package, type.Name).asCom; //åˆ›å»ºUIèŠ‚ç‚¹ UINode ui = new UINode(); ui.ui = view; if (parent != null) &#123; int layerIndex = parent.layer + 1; if (_layer.Count - 1 == parent.layer) &#123; GComponent layer = new GComponent(); layer.displayObject.gameObject.name = &quot;Layer_&quot; + layerIndex; GRoot.inst.AddChild(layer); _layer.Add(layer); &#125; _layer[layerIndex].AddChild(view.main); parent.children.Add(view.id, ui); ui.parent = parent; ui.layer = layerIndex; &#125; else &#123; if (_layer.Count == 0) &#123; GComponent layer = new GComponent(); layer.displayObject.gameObject.name = &quot;Layer_0&quot;; GRoot.inst.AddChild(layer); _layer.Add(layer); &#125; _layer[0].AddChild(view.main); _root.children.Add(view.id, ui); ui.parent = _root; ui.layer = 0; &#125; view.uiNode = ui; view.InitConfig(); view.OnAwake(); view.Show(); return ui; &#125; /// &lt;summary&gt; /// éšè—UI /// &lt;/summary&gt; /// &lt;param name=&quot;ui&quot;&gt;&lt;/param&gt; public void HideUI(UINode ui) &#123; foreach (var child in ui.children) &#123; UINode uiChild = child.Value; HideUI(uiChild); &#125; ui.ui.Hide(); &#125; /// &lt;summary&gt; /// æ ¹æ®åå­—èŽ·å–UI /// &lt;/summary&gt; /// &lt;param name=&quot;name&quot;&gt;&lt;/param&gt; /// &lt;param name=&quot;parent&quot;&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public UINode GetUI(string name, UINode parent = null) &#123; if (parent == null) &#123; parent = _root; &#125; if (parent.ui != null &amp;&amp; name == parent.ui.name) &#123; return parent; &#125; UINode node; foreach (var child in parent.children) &#123; node = GetUI(name, child.Value); if (node != null) &#123; return node; &#125; &#125; return null; &#125; /// &lt;summary&gt; /// é”€æ¯UI /// &lt;/summary&gt; /// &lt;param name=&quot;ui&quot;&gt;&lt;/param&gt; public void DisposeUI(UINode ui) &#123; foreach (var child in ui.children) &#123; UINode uiChild = child.Value; DisposeUI(uiChild); &#125; //ç§»é™¤ä¿å­˜çš„èŠ‚ç‚¹ _savedView.Remove(ui.ui.name); ui.children = null; ui.parent = null; ui.ui.Dispose(); &#125; /// &lt;summary&gt; /// é‡æ–°ç½®äºŽä¸Šå±‚ /// &lt;/summary&gt; /// &lt;param name=&quot;ui&quot;&gt;&lt;/param&gt; public void ResetTop(UINode ui) &#123; _layer[ui.layer].AddChild(ui.ui.main); &#125; /// &lt;summary&gt; /// è®¾ç½®æ¨¡æ€èƒŒæ™¯ /// &lt;/summary&gt; /// &lt;param name=&quot;ui&quot;&gt;&lt;/param&gt; /// &lt;param name=&quot;model&quot;&gt;&lt;/param&gt; public void SetModel(UINode ui, GGraph model) &#123; GComponent layer = _layer[ui.layer]; int index = layer.GetChildIndex(ui.ui.main); layer.AddChildAt(model, index); &#125; /// &lt;summary&gt; /// ä¿å­˜èŠ‚ç‚¹ éœ€è¦uiåç§°å”¯ä¸€ /// &lt;/summary&gt; /// &lt;param name=&quot;name&quot;&gt;&lt;/param&gt; /// &lt;param name=&quot;ui&quot;&gt;&lt;/param&gt; public void SaveNode(string name, UINode ui) &#123; _savedView[name] = ui; &#125;&#125; BaseView ç”Ÿå‘½å‘¨æœŸflowchart TB; subgraph A[\"OnAwake ç”Ÿå‘½å‘¨æœŸ\"] OnAwake --> Bind --> BindClass; end subgraph B[\"Show ç”Ÿå‘½å‘¨æœŸ\"] Show --> TweenIn --> OnShow; end subgraph C[\"Hide ç”Ÿå‘½å‘¨æœŸ\"] Hide --> TweenOut --> OnHide; end InitConfig --> A; A --> B; B --> C; C --> Dispose; Show å’Œ Hide æ–¹æ³•æ¯æ¬¡æ˜¾ç¤ºéšè—çš„æ—¶å€™éƒ½ä¼šè°ƒç”¨ã€‚ InitConfig å’Œ OnAwake æ–¹æ³•åªæœ‰åœ¨ç¬¬ä¸€æ¬¡åˆ›å»ºçª—å£çš„æ—¶å€™ä¼šè°ƒç”¨ã€‚ å¯ä»¥é‡å†™çš„ç”Ÿå‘½å‘¨æœŸï¼š InitConfig: åˆå§‹åŒ–é…ç½®ã€‚ OnShow: UI å±•ç¤ºäº‹ä»¶ã€‚ OnHide: UI éšè—äº‹ä»¶ã€‚ TweenIn: å±•ç¤ºç¼“åŠ¨ã€‚ TweenOut: éšè—ç¼“åŠ¨ã€‚ ä½¿ç”¨å±•ç¤ºåŸºæœ¬åŠŸèƒ½ åŒå‘ç»‘å®š æ‹–æ‹½ â†‘ ä»£ç†æ‹–æ‹½ â†‘ â†‘ è‡ªä½“æ‹–æ‹½ â†‘ â†‘ List æ‹–æ‹½ | æ‰‹åŠ¨è®¾ç½®æ‹–æ‹½ â†‘ çª—å£ç¼“åŠ¨ æ‚¬æµ®çª— ä¸‹æ‹‰æ¡† çª—å£æ‹–æ‹½å’Œé¡¶å±‚é‡ç½® UI æ ‘ æ¨¡æ€çª—å£ ä½¿ç”¨æ–¹æ³•è¯·è½¬åˆ°ReflectionBindUI æ–‡æ¡£æŸ¥çœ‹ã€‚ ä»£ç  è¯¦ç»†ä»£ç  StringUIProp StringUIProp12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364using System;public class StringUIProp&#123; public string _value; private string val &#123; get &#123; return _value; &#125; set &#123; _value = value; InvokeUI(); &#125; &#125; private Action&lt;string&gt; _onValueChange = null; private Func&lt;string&gt; _onUIChange = null; public StringUIProp() &#123; &#125; public StringUIProp(string value) &#123; _value = value; &#125; public void Set(string value) &#123; this.val = value; &#125; public void Set&lt;T&gt;(T value) &#123; this.val = value.ToString(); &#125; public string Get() &#123; InvokeValue(); return this.val; &#125; public void InvokeValue() &#123; if (_onUIChange != null) &#123; _value = _onUIChange.Invoke(); &#125; &#125; public void InvokeUI() &#123; _onValueChange?.Invoke(val); &#125; public override string ToString() &#123; return val; &#125;&#125; DoubleUIProp DoubleUIProp123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657using System;public class DoubleUIProp&#123; public double _value; private double val &#123; get &#123; return _value; &#125; set &#123; _value = value; InvokeUI(); &#125; &#125; private Action&lt;double&gt; _onValueChange = null; private Func&lt;double&gt; _onUIChange = null; public DoubleUIProp() &#123; &#125; public DoubleUIProp(double value) &#123; _value = value; &#125; public void Set(double value) &#123; this.val = value; &#125; public double Get() &#123; InvokeValue(); return this.val; &#125; public void InvokeValue() &#123; if (_onUIChange != null) &#123; _value = _onUIChange.Invoke(); &#125; &#125; public void InvokeUI() &#123; _onValueChange?.Invoke(val); &#125; public override string ToString() &#123; return val.ToString(); &#125;&#125; UIListProp UIListProp1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465using System;using System.Collections;using System.Collections.Generic;using UnityEngine;public class UIListProp&lt;T&gt;&#123; private List&lt;T&gt; _value; private List&lt;T&gt; val &#123; get &#123; return _value; &#125; set &#123; _value = value; Invoke(); &#125; &#125; public int Count &#123; get; set; &#125; private Action&lt;int&gt; _onValueChange = null; public UIListProp() &#123; &#125; public UIListProp(List&lt;T&gt; value) &#123; //this.val = value; _value = value; &#125; public List&lt;T&gt; Get() &#123; return val; &#125; public void Set(List&lt;T&gt; value) &#123; val = value; Count = val.Count; &#125; public void Invoke() &#123; if (val != null) &#123; _onValueChange?.Invoke(val.Count); &#125; &#125; public override string ToString() &#123; string res = &quot;[&quot;; foreach (var item in val) &#123; res += item.ToString() + &quot;,&quot;; &#125; res += &quot;]&quot;; return res; &#125;&#125; ç»‘å®šç‰¹æ€§ UICompBind12345678910111213141516171819using System;using System.Collections;using System.Collections.Generic;using UnityEngine;/// &lt;summary&gt;/// ç»‘å®šUIç»„ä»¶/// &lt;/summary&gt;[AttributeUsage(AttributeTargets.Property)]public class UICompBind :Attribute&#123; public string _type; public string _path; public UICompBind(string type,string path) &#123; _type = type; _path = path; &#125;&#125;UIDataBind123456789101112131415161718using System;/// &lt;summary&gt;/// ç»‘å®šUIç»„ä»¶å’Œæ•°æ®ï¼Œä½¿å…¶æ ¹æ®æ•°æ®ä¿®æ”¹UI/// &lt;/summary&gt;[AttributeUsage(AttributeTargets.Property)]public class UIDataBind : Attribute&#123; public string _type; public string _path; public string[] _extra; public UIDataBind(string type, string path, params string[] extra) &#123; _type = type; _path = path; _extra = extra; &#125;&#125;UIActionBind12345678910111213141516171819202122using System;/// &lt;summary&gt;/// ç»‘å®šUIç»„ä»¶å’ŒåŠ¨ä½œäº‹ä»¶ï¼Œä½¿å…¶æ”¯æŒäº¤äº’/// &lt;/summary&gt;[AttributeUsage(AttributeTargets.Method)]public class UIActionBind : Attribute&#123; public string _type; public string _path; public string[] _extra; public UIActionBind(string type,string path,params string[] extra) &#123; _type = type; _path = path; _extra = extra; &#125;&#125;UIListenerBind123456789101112131415161718using System;using System.Collections;using System.Collections.Generic;using UnityEngine;/// &lt;summary&gt;/// ç»‘å®šUIç›‘å¬äº‹ä»¶/// &lt;/summary&gt;[AttributeUsage(AttributeTargets.Method)]public class UIListenerBind : Attribute&#123; public string _name; public UIListenerBind(string name) &#123; _name = name; &#125;&#125; UIBase UIBase123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578579580581582583584585586587588589590591592593594595596597598599600601602603604605606607608609610611612613614615616617618619620621622623624625626627628629630631632633634635636637638639640641642643644645646647648649650651652653654655656657658659660661662663664665666667668669670671672673674675676677678679680681682683684685686687688689690691692693694695696697698699700701702703704705706707708709710711712713714715716717718719720721722723724725726727728729730731732733734735736737738739740741742743744745746747748749750751752753754755756757758759760761762763764765766767768769770771772773774775776777778779780781782783784785786787788789790791792793794795796797798799800801802803804805806807808809810811812813814815816817818819820821822823824825826827828829830831832833834835836837838839840using FairyGUI;using System;using System.Collections;using System.Collections.Generic;using System.Reflection;using UnityEngine;/// &lt;summary&gt;/// UIå†…éƒ¨å…ƒç´ åŸºç±»/// &lt;/summary&gt;public class UIBase&#123; /// &lt;summary&gt; /// ç•Œé¢UIæ ¹å…ƒç´  /// &lt;/summary&gt; public GComponent main; /// &lt;summary&gt; /// ç•Œé¢id /// &lt;/summary&gt; public string id; /// &lt;summary&gt; /// ç•Œé¢å /// &lt;/summary&gt; public string name; /// &lt;summary&gt; /// å½“å‰ç±»çš„ç±»åž‹ /// &lt;/summary&gt; protected Type _type; /// &lt;summary&gt; /// åå°„èŒƒå›´æ ‡å¿— /// &lt;/summary&gt; private readonly BindingFlags _flag = BindingFlags.Public | BindingFlags.NonPublic | BindingFlags.Static | BindingFlags.Instance; //----- å†…å»ºç§æœ‰å˜é‡ ----- /// &lt;summary&gt; /// æ‹–æ‹½å…ƒç´ å­—å…¸ï¼Œç”¨äºŽä¿å­˜å…ƒç´ çš„æ‹–æ‹½çŠ¶æ€ /// &lt;/summary&gt; private readonly Dictionary&lt;string, bool&gt; _dropDic = new Dictionary&lt;string, bool&gt;(); /// &lt;summary&gt; /// ä»£ç†æ‹–æ‹½å…ƒç´  /// &lt;/summary&gt; private GameObject _copy; /// &lt;summary&gt; /// å½“å‰ä»£ç†æ‹–æ‹½è„šæœ¬ /// &lt;/summary&gt; private UIDrag _uiDrag; /// &lt;summary&gt; /// æ‹–æ‹½æ•°æ® /// &lt;/summary&gt; private readonly ArrayList _dropData = new ArrayList(); /// &lt;summary&gt; /// æµ®åŠ¨çª—å£id /// &lt;/summary&gt; private int _floatId = 0; /// &lt;summary&gt; /// æµ®åŠ¨çª—å£å­—å…¸ï¼Œç”¨äºŽä¿å­˜æ‰€æœ‰æµ®åŠ¨çª—å£ /// &lt;/summary&gt; private Dictionary&lt;string, BaseView&gt; _floatViews = new Dictionary&lt;string, BaseView&gt;(); /// &lt;summary&gt; /// æ­£åœ¨æ˜¾ç¤ºçš„æ‚¬æµ®çª— /// &lt;/summary&gt; private BaseView _floatViewOnShow = null; protected void Bind() &#123; _type = GetType(); PropertyInfo[] props = _type.GetProperties(_flag); MethodInfo[] methods = _type.GetMethods(_flag); foreach (var method in methods) &#123; var methodAttrs = method.GetCustomAttributes(true); foreach (var attr in methodAttrs) &#123; if (attr is UIActionBind) &#123; BindAction(method, attr); &#125; else if (attr is UIListenerBind) &#123; BindListener(method, attr); &#125; &#125; &#125; foreach (var prop in props) &#123; var propAttrs = prop.GetCustomAttributes(true); foreach (var attr in propAttrs) &#123; if (attr is UICompBind) &#123; BindComp(prop, attr); &#125; else if (attr is UIDataBind) &#123; BindData(prop, attr); &#125; &#125; &#125; &#125; /// &lt;summary&gt; /// ç»‘å®šç»„ä»¶ /// &lt;/summary&gt; /// &lt;param name=&quot;prop&quot;&gt;&lt;/param&gt; /// &lt;param name=&quot;attr&quot;&gt;&lt;/param&gt; private void BindComp(PropertyInfo prop, object attr) &#123; UICompBind uiBind = (UICompBind)attr; switch (uiBind._type) &#123; case UIType.Comp: GComponent comp = FguiUtils.GetUI&lt;GComponent&gt;(main, uiBind._path); prop.SetValue(this, comp); break; case UIType.TextField: GTextField textField = FguiUtils.GetUI&lt;GTextField&gt;(main, uiBind._path); prop.SetValue(this, textField); break; case UIType.TextInput: GTextInput textInput = FguiUtils.GetUI&lt;GTextInput&gt;(main, uiBind._path); prop.SetValue(this, textInput); break; case UIType.Image: GImage image = FguiUtils.GetUI&lt;GImage&gt;(main, uiBind._path); prop.SetValue(this, image); break; case UIType.Loader: GLoader loader = FguiUtils.GetUI&lt;GLoader&gt;(main, uiBind._path); prop.SetValue(this, loader); break; case UIType.List: GList list = FguiUtils.GetUI&lt;GList&gt;(main, uiBind._path); prop.SetValue(this, list); break; case UIType.Slider: GSlider slider = FguiUtils.GetUI&lt;GSlider&gt;(main, uiBind._path); prop.SetValue(this,slider); break; case UIType.ComboBox: GComboBox comboBox = FguiUtils.GetUI&lt;GComboBox&gt;(main, uiBind._path); prop.SetValue(this,comboBox); break; &#125; &#125; /// &lt;summary&gt; /// ç»‘å®š ç»„ä»¶-æ•°æ® /// &lt;/summary&gt; /// &lt;param name=&quot;prop&quot;&gt;&lt;/param&gt; /// &lt;param name=&quot;attr&quot;&gt;&lt;/param&gt; private void BindData(PropertyInfo prop, object attr) &#123; UIDataBind uiBind = (UIDataBind)attr; //èŽ·å–åŒå‘ç»‘å®šå§”æ‰˜ var onValueChange = prop.PropertyType.GetField(&quot;_onValueChange&quot;, _flag); var onUIChange = prop.PropertyType.GetField(&quot;_onUIChange&quot;, _flag); var value = prop.GetValue(this); if (value == null) &#123; //åˆå§‹åŒ–å½“å‰å±žæ€§çš„å€¼ Type propType = prop.PropertyType; if (propType == typeof(StringUIProp)) &#123; value = new StringUIProp(); &#125; else if (propType == typeof(DoubleUIProp)) &#123; value = new DoubleUIProp(); &#125; else &#123; //åˆ›å»ºList Type genericType = typeof(UIListProp&lt;&gt;).MakeGenericType(prop.PropertyType.GenericTypeArguments); value = Activator.CreateInstance(genericType); &#125; prop.SetValue(this, value); &#125; switch (uiBind._type) &#123; case UIType.TextField: GTextField textField = FguiUtils.GetUI&lt;GTextField&gt;(main, uiBind._path); void ActionText(string data) &#123; textField.text = data; &#125; string ActionTextUI() &#123; return textField.text; &#125; onValueChange?.SetValue(value, (Action&lt;string&gt;)ActionText); onUIChange?.SetValue(value, (Func&lt;string&gt;)ActionTextUI); break; case UIType.TextInput: GTextInput textInput = FguiUtils.GetUI&lt;GTextInput&gt;(main, uiBind._path); void ActionInput(string data) &#123; textInput.text = data; &#125; string ActionInputUI() &#123; return textInput.text; &#125; onValueChange?.SetValue(value, (Action&lt;string&gt;)ActionInput); onUIChange?.SetValue(value, (Func&lt;string&gt;)ActionInputUI); break; case UIType.Image: GImage image = FguiUtils.GetUI&lt;GImage&gt;(main, uiBind._path); void ActionImage(string data) &#123; image.icon = data; &#125; string ActionImageUI() &#123; return image.icon; &#125; onValueChange?.SetValue(value, (Action&lt;string&gt;)ActionImage); onUIChange?.SetValue(value, (Func&lt;string&gt;)ActionImageUI); break; case UIType.Loader: GLoader loader = FguiUtils.GetUI&lt;GLoader&gt;(main, uiBind._path); void ActionLoader(string data) &#123; loader.url = data; // ConsoleUtils.Log(&quot;æ›¿æ¢å›¾ç‰‡&quot;, loader?.url); &#125; string ActionLoaderUI() &#123; return loader.url; &#125; onValueChange?.SetValue(value, (Action&lt;string&gt;)ActionLoader); onUIChange?.SetValue(value, (Func&lt;string&gt;)ActionLoaderUI); break; case UIType.List: GList list = FguiUtils.GetUI&lt;GList&gt;(main, uiBind._path); void ActionList(int data) &#123; list.SetVirtual(); list.numItems = data; if (uiBind._extra.Length &gt; 0) &#123; switch (uiBind._extra[0]) &#123; case &quot;height&quot;: if (list.numChildren &gt; 0) &#123; list.height = data * list.GetChildAt(0).height + list.lineGap * (data - 1) + list.margin.top + list.margin.bottom; &#125; break; case &quot;width&quot;: if (list.numChildren &gt; 0) &#123; list.width = data * list.GetChildAt(0).width + list.columnGap * (data - 1) + list.margin.left + list.margin.right; &#125; break; &#125; &#125; &#125; onValueChange?.SetValue(value, (Action&lt;int&gt;)ActionList); break; case UIType.Slider: GSlider slider = FguiUtils.GetUI&lt;GSlider&gt;(main, uiBind._path); void ActionSlider(double data) &#123; slider.value = data; &#125; double ActionSliderUI() &#123; return slider.value; &#125; onValueChange?.SetValue(value, (Action&lt;double&gt;)ActionSlider); onUIChange?.SetValue(value, (Func&lt;double&gt;)ActionSliderUI); break; case UIType.ComboBox: GComboBox comboBox = FguiUtils.GetUI&lt;GComboBox&gt;(main, uiBind._path); comboBox.items = uiBind._extra; void ActionComboBox(double data) &#123; comboBox.selectedIndex = (int)data; &#125; double ActionComboBoxUI() &#123; return comboBox.selectedIndex; &#125; onValueChange?.SetValue(value, (Action&lt;double&gt;)ActionComboBox); onUIChange?.SetValue(value, (Func&lt;double&gt;)ActionComboBoxUI); break; &#125; &#125; /// &lt;summary&gt; /// ç»‘å®š ç»„ä»¶-è¡Œä¸º /// &lt;/summary&gt; /// &lt;param name=&quot;method&quot;&gt;&lt;/param&gt; /// &lt;param name=&quot;attr&quot;&gt;&lt;/param&gt; private void BindAction(MethodInfo method, object attr) &#123; UIActionBind uiBind = (UIActionBind)attr; GObject obj = FguiUtils.GetUI&lt;GObject&gt;(main, uiBind._path); //èŽ·å–æ–¹æ³•çš„å‚æ•° ParameterInfo[] methodParamsList; bool isAgent; Delegate action; switch (uiBind._type) &#123; case UIAction.Click: methodParamsList = method.GetParameters(); if (methodParamsList.Length == 0) &#123; action = Delegate.CreateDelegate(typeof(EventCallback0), this, method); obj.onClick.Set((EventCallback0)action); &#125; else &#123; action = Delegate.CreateDelegate(typeof(EventCallback1), this, method); obj.onClick.Set((EventCallback1)action); &#125; break; case UIAction.ListRender: action = Delegate.CreateDelegate(typeof(ListItemRenderer), this, method); obj.asList.itemRenderer = (ListItemRenderer)action; break; case UIAction.ListProvider: action = Delegate.CreateDelegate(typeof(ListItemProvider), this, method); obj.asList.itemProvider = (ListItemProvider)action; break; case UIAction.ListClick: methodParamsList = method.GetParameters(); if (methodParamsList.Length == 0) &#123; action = Delegate.CreateDelegate(typeof(EventCallback0), this, method); obj.asList.onClickItem.Set((EventCallback0)action); &#125; else &#123; action = Delegate.CreateDelegate(typeof(EventCallback1), this, method); obj.asList.onClickItem.Set((EventCallback1)action); &#125; break; case UIAction.DragStart: obj.draggable = true; isAgent = uiBind._extra.Length == 0 || uiBind._extra[0] == &quot;Self&quot;; SetDragListener(obj, 0, method, isAgent); break; case UIAction.DragHold: obj.draggable = true; isAgent = uiBind._extra.Length == 0 || uiBind._extra[0] == &quot;Self&quot;; SetDragListener(obj, 1, method, isAgent); break; case UIAction.DragEnd: obj.draggable = true; isAgent = uiBind._extra.Length == 0 || uiBind._extra[0] != &quot;Self&quot;; SetDragListener(obj, 2, method, isAgent); break; case UIAction.Drop: action = (Action&lt;object&gt;)Delegate.CreateDelegate(typeof(Action&lt;object&gt;), this, method); _dropDic[obj.id] = true; EventManager.AddListening(obj.id, &quot;OnDrop_&quot; + obj.id, data =&gt; ((Action&lt;object&gt;)action).Invoke(data)); break; case UIAction.Hover: methodParamsList = method.GetParameters(); if (methodParamsList.Length == 0) &#123; action = Delegate.CreateDelegate(typeof(EventCallback0), this, method); obj.onRollOver.Set((EventCallback0)action); &#125; else &#123; action = Delegate.CreateDelegate(typeof(EventCallback1), this, method); obj.onRollOver.Set((EventCallback1)action); &#125; obj.onRollOver.Add(() =&gt; &#123; if (_floatViewOnShow != null) &#123; if (_floatViewOnShow.main.displayObject.gameObject.GetComponent&lt;UIFollow&gt;() != null) &#123; _floatViewOnShow.main.xy = FguiUtils.GetMousePosition(); &#125; else &#123; _floatViewOnShow.main.xy = obj.xy; &#125; _floatViewOnShow.Show(); &#125; &#125;); //é€€å‡ºéšè— obj.onRollOut.Set(() =&gt; &#123; _floatViewOnShow?.Hide(); _floatViewOnShow = null; &#125;); break; case UIAction.Slider: methodParamsList = method.GetParameters(); if (methodParamsList.Length == 0) &#123; action = Delegate.CreateDelegate(typeof(EventCallback0), this, method); obj.asSlider.onChanged.Set((EventCallback0)action); &#125; else &#123; action = Delegate.CreateDelegate(typeof(EventCallback1), this, method); obj.asSlider.onChanged.Set((EventCallback1)action); &#125; break; case UIAction.ComboBox: methodParamsList = method.GetParameters(); if (methodParamsList.Length == 0) &#123; action = Delegate.CreateDelegate(typeof(EventCallback0), this, method); obj.asComboBox.onChanged.Set((EventCallback0)action); &#125; else &#123; action = Delegate.CreateDelegate(typeof(EventCallback1), this, method); obj.asComboBox.onChanged.Set((EventCallback1)action); &#125; break; &#125; &#125; /// &lt;summary&gt; /// ç»‘å®šç›‘å¬ /// &lt;/summary&gt; /// &lt;param name=&quot;method&quot;&gt;&lt;/param&gt; /// &lt;param name=&quot;attr&quot;&gt;&lt;/param&gt; private void BindListener(MethodInfo method, object attr) &#123; UIListenerBind uiBind = (UIListenerBind)attr; var eventFunc = Delegate.CreateDelegate(typeof(Action&lt;ArrayList&gt;), this, method); EventManager.AddListening(id, uiBind._name, (Action&lt;ArrayList&gt;)eventFunc); &#125; private void ClearDropData() &#123; _dropData.Clear(); &#125; /// &lt;summary&gt; /// æ·»åŠ æ”¾ç½®æ•°æ® /// &lt;/summary&gt; /// &lt;param name=&quot;data&quot;&gt;&lt;/param&gt; protected void AddDropData(object data) &#123; _dropData.Add(data); &#125; /// &lt;summary&gt; /// è®¾ç½®æ‹–æ‹½ï¼Œç”¨äºŽlistå†…å…ƒç´  /// &lt;/summary&gt; /// &lt;param name=&quot;type&quot;&gt;&lt;/param&gt; /// &lt;param name=&quot;action&quot;&gt;&lt;/param&gt; /// &lt;param name=&quot;obj&quot;&gt;&lt;/param&gt; protected void SetDrag(UIAction type, GObject obj, Action dragAction) &#123; obj.draggable = true; Action action = () =&gt; &#123; //åœæ­¢æœ¬æ¬¡æ»šåŠ¨ obj.parent.asList.scrollPane.CancelDragging(); dragAction(); &#125;; switch (type) &#123; case UIAction.DragStart: SetDragListener(obj, 0, action); break; case UIAction.DragHold: SetDragListener(obj, 1, action); break; case UIAction.DragEnd: SetDragListener(obj, 2, action); break; &#125; &#125; protected void SetDrop(GObject obj, Action&lt;object&gt; action) &#123; _dropDic[obj.id] = true; EventManager.AddListening(obj.id, &quot;OnDrop_&quot; + obj.id, data =&gt; action(_dropData)); &#125; /// &lt;summary&gt; /// æ·»åŠ æ”¾ç½®æ•°æ® /// &lt;/summary&gt; /// &lt;param name=&quot;datas&quot;&gt;&lt;/param&gt; protected void AddDropData(params object[] datas) &#123; foreach (var data in datas) &#123; _dropData.Add(data); &#125; &#125; /// &lt;summary&gt; /// å±•ç¤ºæ‚¬æµ®çª— /// &lt;/summary&gt; /// &lt;param name=&quot;name&quot;&gt;æ‚¬æµ®çª—å&lt;/param&gt; /// &lt;param name=&quot;follow&quot;&gt;æ˜¯å¦è·Ÿéš&lt;/param&gt; /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt; protected void ShowFloatView&lt;T&gt;(string name, bool follow = false) where T : BaseView, new() &#123; BaseView view; _floatViews.TryGetValue(name, out view); if (view == null) &#123; view = new T(); string uiName = typeof(T).Name; view.id = &quot;float_view_&quot; + _floatId++; view.name = name; view.main = UIPackage.CreateObject(&quot;Test&quot;, uiName).asCom; view.main.touchable = false; if (follow) &#123; UIFollow uiFollow = view.main.displayObject.gameObject.AddComponent&lt;UIFollow&gt;(); uiFollow.SetObj(view.main, main); &#125; main.AddChild(view.main); view.OnAwake(); _floatViews.Add(name, view); &#125; _floatViewOnShow = view; &#125; /// &lt;summary&gt; /// æ·»åŠ æ‹–æ‹½ç›‘å¬ä»£ç† /// &lt;/summary&gt; /// &lt;param name=&quot;obj&quot;&gt;æ‹–æ‹½UI&lt;/param&gt; /// &lt;param name=&quot;type&quot;&gt;æ‹–æ‹½ç±»åž‹ 0:start,1:hold,2:end&lt;/param&gt; /// &lt;param name=&quot;method&quot;&gt;æ‹–æ‹½å›žè°ƒ&lt;/param&gt; /// &lt;param name=&quot;isAgent&quot;&gt;æ˜¯å¦ä»£ç†æ‹–æ‹½&lt;/param&gt; private void SetDragListener(GObject obj, int type, MethodInfo method, bool isAgent) &#123; ParameterInfo[] methodParamsList = method.GetParameters(); var drag = Delegate.CreateDelegate( methodParamsList.Length == 0 ? typeof(EventCallback0) : typeof(EventCallback1), this, method); if (isAgent) &#123; obj.onDragStart.Add(context =&gt; &#123; context.PreventDefault(); //å¤åˆ¶UI GameObject origin = obj.displayObject.gameObject; _copy = GameObject.Instantiate(origin, main.displayObject.gameObject.transform, true); CompClone(_copy.transform, origin.transform); //åŒæ­¥å±žæ€§ _copy.transform.localPosition = origin.transform.localPosition; _copy.transform.localScale = origin.transform.localScale; _copy.transform.localRotation = origin.transform.localRotation; //æ‹–æ‹½è·Ÿéšé€»è¾‘ _uiDrag = _copy.AddComponent&lt;UIDrag&gt;(); _uiDrag.SetOriginMousePos(); Action action = () =&gt; &#123; //æ¸…é™¤æ”¾ç½®æ•°æ® ClearDropData(); if (methodParamsList.Length == 0) &#123; ((EventCallback0)drag).Invoke(); &#125; else &#123; ((EventCallback1)drag).Invoke(null); &#125; &#125;; switch (type) &#123; case 0: _uiDrag.SetStart(action); break; case 1: _uiDrag.SetUpdate(action); break; case 2: _uiDrag.SetEnd(action); break; &#125; AddDropListener(obj); RemoveDragAgent(); &#125;); &#125; else &#123; if (methodParamsList.Length == 0) &#123; EventCallback0 action = () =&gt; &#123; //æ¸…é™¤æ”¾ç½®æ•°æ® ClearDropData(); ((EventCallback0)drag).Invoke(); &#125;; //ç›‘å¬é¼ æ ‡æ‹–æ‹½ switch (type) &#123; case 0: obj.onDragStart.Set(action); break; case 1: obj.onDragMove.Set(action); break; case 2: obj.onDragEnd.Set(action); break; &#125; &#125; else &#123; EventCallback1 action = context =&gt; &#123; //æ¸…é™¤æ”¾ç½®æ•°æ® ClearDropData(); ((EventCallback1)drag).Invoke(context); &#125;; //ç›‘å¬é¼ æ ‡æ‹–æ‹½ switch (type) &#123; case 0: obj.onDragStart.Set(action); break; case 1: obj.onDragMove.Set(action); break; case 2: obj.onDragEnd.Set(action); break; &#125; &#125; AddDropListener(obj); &#125; &#125; /// &lt;summary&gt; /// è®¾ç½®æ‹–æ‹½ç›‘å¬ /// &lt;/summary&gt; /// &lt;param name=&quot;obj&quot;&gt;æ‹–æ‹½UI&lt;/param&gt; /// &lt;param name=&quot;type&quot;&gt;æ‹–æ‹½ç±»åž‹ 0:start,1:hold,2:end&lt;/param&gt; /// &lt;param name=&quot;dragAction&quot;&gt;æ‹–æ‹½å›žè°ƒ&lt;/param&gt; private void SetDragListener(GObject obj, int type, Action dragAction) &#123; obj.onDragStart.Add(context =&gt; &#123; context.PreventDefault(); //å¤åˆ¶UI GameObject origin = obj.displayObject.gameObject; _copy = GameObject.Instantiate(origin, main.displayObject.gameObject.transform, true); CompClone(_copy.transform, origin.transform); //åŒæ­¥å±žæ€§ _copy.transform.position = origin.transform.position; _copy.transform.localScale = origin.transform.localScale; _copy.transform.rotation = origin.transform.rotation; //æ‹–æ‹½è·Ÿéšé€»è¾‘ _uiDrag = _copy.AddComponent&lt;UIDrag&gt;(); _uiDrag.SetOriginMousePos(); Action action = () =&gt; &#123; //æ¸…é™¤æ”¾ç½®æ•°æ® ClearDropData(); dragAction.Invoke(); &#125;; switch (type) &#123; case 0: _uiDrag.SetStart(action); break; case 1: _uiDrag.SetUpdate(action); break; case 2: _uiDrag.SetEnd(action); break; &#125; AddDropListener(obj); RemoveDragAgent(); &#125;); &#125; /// &lt;summary&gt; /// æ·»åŠ æ”¾ç½®ç›‘å¬ /// &lt;/summary&gt; /// &lt;param name=&quot;obj&quot;&gt;æ”¾ç½®UI&lt;/param&gt; private void AddDropListener(GObject obj) &#123; if (_uiDrag) &#123; _uiDrag.AddEnd(() =&gt; &#123; GObject target = GRoot.inst.touchTarget; while (target != null) &#123; if (_dropDic.ContainsKey(target.id)) &#123; EventManager.TriggerEvent(&quot;OnDrop_&quot; + target.id, _dropData); return; &#125; target = target.parent; &#125; &#125;); &#125; else &#123; obj.onDragEnd.Add(() =&gt; &#123; GObject target = GRoot.inst.touchTarget; while (target != null) &#123; if (_dropDic.ContainsKey(target.id)) &#123; EventManager.TriggerEvent(&quot;OnDrop_&quot; + target.id, _dropData); return; &#125; target = target.parent; &#125; &#125;); &#125; &#125; /// &lt;summary&gt; /// ç§»é™¤æ‹–æ‹½ç›‘å¬ä»£ç† /// &lt;/summary&gt; private void RemoveDragAgent() &#123; if (_uiDrag) &#123; _uiDrag.AddEnd(() =&gt; &#123; _copy = null; _uiDrag = null; &#125;); &#125; &#125; /// &lt;summary&gt; /// ä»£ç†ç»„ä»¶å…‹éš†åŠå¤„ç† /// &lt;/summary&gt; /// &lt;param name=&quot;transCopy&quot;&gt;å…‹éš†ä½“transform&lt;/param&gt; /// &lt;param name=&quot;transOrigin&quot;&gt;åŽŸåž‹transform&lt;/param&gt; private void CompClone(Transform transCopy, Transform transOrigin) &#123; MeshFilter filter = transCopy.GetComponent&lt;MeshFilter&gt;(); MeshRenderer renderer = transCopy.GetComponent&lt;MeshRenderer&gt;(); if (filter) &#123; filter.mesh = transOrigin.GetComponent&lt;MeshFilter&gt;().mesh; &#125; if (renderer) &#123; // renderer.materials = transOrigin.GetComponent&lt;MeshRenderer&gt;().materials; Material[] origin = transOrigin.GetComponent&lt;MeshRenderer&gt;().materials; Material[] copy = new Material[origin.Length]; for (int i = 0; i &lt; origin.Length; i++) &#123; copy[i] = new Material(origin[i]); &#125; renderer.materials = copy; renderer.sortingOrder = 9999; &#125; if (transCopy.childCount &gt; 0) &#123; for (int i = 0; i &lt; transCopy.childCount; i++) &#123; CompClone(transCopy.GetChild(i), transOrigin.GetChild(i)); &#125; &#125; &#125;&#125; BaseView è¯¥ç±»æ²¡æœ‰è‡ªåŠ¨æ‰§è¡Œçš„æ–¹æ³•ï¼Œè¯·è‡ªè¡ŒæŽ¥ç®¡ç”Ÿå‘½å‘¨æœŸBaseView123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288using System;using System.Reflection;using FairyGUI;using UnityEngine;/// &lt;summary&gt;/// UIç•Œé¢åŸºç±»/// &lt;/summary&gt;public class BaseView : UIBase&#123; /// &lt;summary&gt; /// UIèŠ‚ç‚¹ /// &lt;/summary&gt; public UINode uiNode; /// &lt;summary&gt; /// ç¼“åŠ¨æœ€å¤§æŒç»­æ—¶é—´ /// &lt;/summary&gt; private int _duration; /// &lt;summary&gt; /// æ¨¡æ€èƒŒæ™¯ /// &lt;/summary&gt; private GGraph _model; /// &lt;summary&gt; /// æ˜¯å¦ä¿å­˜èŠ‚ç‚¹ é»˜è®¤ä¿å­˜ /// &lt;/summary&gt; private bool _isSaveNode = true; public void OnAwake() &#123; if (_isSaveNode) &#123; //ä¿å­˜èŠ‚ç‚¹ UIManager.Ins().SaveNode(name, uiNode); &#125; //ç»‘å®šUIå…ƒç´  Bind(); //ç»‘å®šç±» var classAttributes = _type.GetCustomAttributes(); foreach (var attr in classAttributes) &#123; if (attr is UIClassBind) &#123; BindClass(attr); &#125; &#125; &#125; /// &lt;summary&gt; /// å±•ç¤ºUI /// &lt;/summary&gt; public void Show() &#123; TweenIn(); DoTween(true); &#125; /// &lt;summary&gt; /// éšè—UI /// &lt;/summary&gt; public void Hide() &#123; TweenOut(); DoTween(false); &#125; /// &lt;summary&gt; /// é”€æ¯UI /// &lt;/summary&gt; public void Dispose() &#123; main.Dispose(); &#125; /// &lt;summary&gt; /// èŽ·å–UIæ˜¾ç¤ºæƒ…å†µ /// &lt;/summary&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool GetVisible() &#123; return main.visible; &#125; /// &lt;summary&gt; /// è®¾ç½®UIæ˜¾ç¤ºæƒ…å†µ /// &lt;/summary&gt; /// &lt;param name=&quot;visible&quot;&gt;&lt;/param&gt; public void SetVisible(bool visible) &#123; main.visible = visible; &#125; /// &lt;summary&gt; /// æ·»åŠ ç¼“åŠ¨ /// &lt;/summary&gt; /// &lt;param name=&quot;target&quot;&gt;ç¼“åŠ¨ç›®æ ‡å±žæ€§&lt;/param&gt; /// &lt;param name=&quot;end&quot;&gt;ç¼“åŠ¨ç›®æ ‡å€¼&lt;/param&gt; /// &lt;param name=&quot;duration&quot;&gt;æŒç»­æ—¶é—´&lt;/param&gt; /// &lt;param name=&quot;ease&quot;&gt;æ’å€¼å‡½æ•°&lt;/param&gt; /// &lt;param name=&quot;callback&quot;&gt;å›žè°ƒ&lt;/param&gt; protected void AddTween(TweenTarget target, float end, int duration, TweenEaseType ease = TweenEaseType.Linear, Action callback = null) &#123; UITweenManager.Ins().AddTween(main, target, end, duration, ease, callback); _duration = duration &lt; _duration ? _duration : duration; &#125; /// &lt;summary&gt; /// æ·»åŠ ç¼“åŠ¨ /// &lt;/summary&gt; /// &lt;param name=&quot;target&quot;&gt;ç¼“åŠ¨ç›®æ ‡å±žæ€§&lt;/param&gt; /// &lt;param name=&quot;end&quot;&gt;ç¼“åŠ¨ç›®æ ‡å€¼&lt;/param&gt; /// &lt;param name=&quot;duration&quot;&gt;æŒç»­æ—¶é—´&lt;/param&gt; /// &lt;param name=&quot;ease&quot;&gt;æ’å€¼å‡½æ•°&lt;/param&gt; /// &lt;param name=&quot;callback&quot;&gt;å›žè°ƒ&lt;/param&gt; protected void AddTween(TweenTarget target, Vector2 end, int duration, TweenEaseType ease = TweenEaseType.Linear, Action callback = null) &#123; UITweenManager.Ins().AddTween(main, target, end, duration, ease, callback); _duration = duration &lt; _duration ? _duration : duration; &#125; /// &lt;summary&gt; /// æ¯æ¬¡å±•ç¤ºçš„æ—¶å€™æ‰§è¡Œ /// &lt;/summary&gt; protected virtual void OnShow() &#123; &#125; /// &lt;summary&gt; /// æ¯æ¬¡éšè—çš„æ—¶å€™æ‰§è¡Œ /// &lt;/summary&gt; protected virtual void OnHide() &#123; &#125; /// &lt;summary&gt; /// è¿›åœºç¼“åŠ¨åˆå§‹åŒ–æ–¹æ³• /// &lt;/summary&gt; protected virtual void TweenIn() &#123; &#125; /// &lt;summary&gt; /// é€€åœºç¼“åŠ¨åˆå§‹åŒ–æ–¹æ³• /// &lt;/summary&gt; protected virtual void TweenOut() &#123; &#125; /// &lt;summary&gt; /// é…ç½®åˆå§‹åŒ– /// &lt;/summary&gt; public virtual void InitConfig() &#123; &#125; /// &lt;summary&gt; /// æ‰§è¡Œç¼“åŠ¨ /// &lt;/summary&gt; /// &lt;param name=&quot;start&quot;&gt;è¿›åœºæˆ–é€€åœº&lt;/param&gt; private void DoTween(bool start) &#123; if (start) &#123; SetVisible(true); AddTween(TweenTarget.None, 0, _duration, TweenEaseType.Linear, OnShow); &#125; else &#123; AddTween(TweenTarget.None, 0, _duration, TweenEaseType.Linear, () =&gt; &#123; main.visible = false; OnHide(); &#125;); &#125; &#125; /// &lt;summary&gt; /// ç»‘å®š ç±» /// &lt;/summary&gt; /// &lt;param name=&quot;attr&quot;&gt;&lt;/param&gt; private void BindClass(object attr) &#123; UIClassBind uiClassBind = (UIClassBind)attr; switch (uiClassBind.type) &#123; case UIClass.Model: if (_model == null) &#123; //åˆ›å»ºæ¨¡æ€èƒŒæ™¯ _model = new GGraph(); _model.displayObject.gameObject.name = id + &quot;_&quot; + name + &quot;_Model&quot;; UIColor colorAttr = _type.GetCustomAttribute&lt;UIColor&gt;(); Color color = new Color(0, 0, 0, 0); if (colorAttr != null) &#123; color = colorAttr.color; &#125; Vector2 size = GRoot.inst.size; _model.DrawRect(size.x, size.y, 0, new Color(), color); &#125; UIManager.Ins().SetModel(uiNode, _model); if (uiClassBind.extra.Length &gt; 0 &amp;&amp; uiClassBind.extra[0] == &quot;Hide&quot;) &#123; _model.onClick.Set(() =&gt; &#123; Hide(); main.AddChild(_model); &#125;); &#125; break; case UIClass.Drag: bool retop = uiClassBind.extra.Length &gt; 0 &amp;&amp; uiClassBind.extra[0] == &quot;Retop&quot;; if (uiClassBind.extra.Length &gt; 1) &#123; GObject obj = FguiUtils.GetUI&lt;GObject&gt;(main, uiClassBind.extra[1]); obj.draggable = true; bool isTouch = false; bool isOut = true; //ç›‘å¬å››ä¸ªäº‹ä»¶ï¼Œä¿è¯æ‹–æ‹½çš„å®žæ—¶æ€§å’Œä¸¥æ ¼æ€§ obj.onTouchBegin.Set(() =&gt; &#123; main.draggable = true; isTouch = true; &#125;); obj.onTouchEnd.Set(() =&gt; &#123; if (isOut) &#123; main.draggable = false; &#125; isTouch = false; &#125;); obj.onRollOver.Set(() =&gt; &#123; main.draggable = true; isOut = false; &#125;); obj.onRollOut.Set(() =&gt; &#123; if (!isTouch) &#123; main.draggable = false; &#125; isOut = true; &#125;); //ç›‘å¬ç½®é¡¶ if (retop) &#123; obj.onTouchBegin.Add(() =&gt; &#123; UIManager.Ins().ResetTop(uiNode); &#125;); &#125; &#125; else &#123; //æ•´ä½“æ‹–æ‹½ï¼Œä¸éœ€è¦åˆ‡æ¢æ‹–æ‹½çŠ¶æ€ï¼Œå› æ­¤ä¸ç›‘å¬äº‹ä»¶ main.draggable = true; //ç›‘å¬ç½®é¡¶ if (retop) &#123; main.onTouchBegin.Set(() =&gt; &#123; UIManager.Ins().ResetTop(uiNode); &#125;); &#125; &#125; break; &#125; &#125;&#125; æ‹–æ‹½è·Ÿéšç±» UIDrag123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172using System;using UnityEngine;public class UIDrag : MonoBehaviour&#123; private Vector3 _originMousePos; private Vector3 _originPos; private Action _onStart; private Action _onUpdate; private Action _onEnd; // Start is called before the first frame update void Start() &#123; _originPos = transform.localPosition; _onStart?.Invoke(); &#125; // Update is called once per frame void Update() &#123; if (Input.GetMouseButton(0)) &#123; transform.localPosition = _originPos + (Input.mousePosition - _originMousePos); _onUpdate?.Invoke(); &#125; else &#123; _onEnd?.Invoke(); Destroy(gameObject); &#125; &#125; public void SetOriginMousePos() &#123; _originMousePos = Input.mousePosition; &#125; public void AddStart(Action start) &#123; _onStart += start; &#125; public void SetStart(Action start) &#123; _onStart = start; &#125; public void AddUpdate(Action update) &#123; _onUpdate += update; &#125; public void SetUpdate(Action update) &#123; _onUpdate = update; &#125; public void AddEnd(Action end) &#123; _onEnd += end; &#125; public void SetEnd(Action end) &#123; _onEnd = end; &#125;&#125; æ‚¬æµ®çª—è·Ÿéšç±» UIFollow12345678910111213141516171819202122232425using System.Collections;using System.Collections.Generic;using FairyGUI;using UnityEngine;public class UIFollow : MonoBehaviour&#123; private GObject _obj; private GObject _parent; void Update() &#123; if (_obj.visible) &#123; _obj.xy = FguiUtils.GetMousePosition(_parent); &#125; &#125; public void SetObj(GObject obj,GObject parent) &#123; _obj = obj; _parent = parent; &#125;&#125; Demo TestView123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137using FairyGUI;using System.Collections;using System.Collections.Generic;using UnityEngine;[UIClassBind(UIClass.Drag,&quot;Retop&quot;,&quot;n10&quot;),UIColor(1,1,1,0.5f)]public class TestView : BaseView&#123; [UIDataBind(UIType.TextField, &quot;1&quot;)] private StringUIProp _testText &#123; get; set; &#125; [UIDataBind(UIType.List, &quot;n1&quot;)] private UIListProp&lt;string&gt; _testList &#123; get; set; &#125; [UIDataBind(UIType.Loader, &quot;4&quot;)] private StringUIProp _loaderUrl &#123; get; set; &#125; [UIDataBind(UIType.Slider, &quot;5&quot;)] private DoubleUIProp _slideValue &#123; get; set; &#125; [UIDataBind(UIType.TextInput, &quot;6&quot;)] private StringUIProp _input &#123; get; set; &#125; [UIDataBind(UIType.ComboBox,&quot;9&quot;,&quot;1&quot;,&quot;b&quot;)] private DoubleUIProp _comboBoxIndex &#123; get; set; &#125; [UICompBind(UIType.Loader, &quot;4&quot;)] private GLoader _loader &#123; get; set; &#125; [UIActionBind(UIAction.ListRender, &quot;2&quot;)] private void ItemRenderer(int index, GObject item) &#123; GComponent comp = item as GComponent; GTextField content = comp.GetChildAt(0).asTextField; content.text = _testList.Get()[index]; SetDrag(UIAction.DragStart, comp, () =&gt; &#123; ConsoleUtils.Log(&quot;å¼€å§‹æ‹–æ‹½&quot;); AddDropData(index); &#125;); SetDrop(comp, (object data) =&gt; &#123; ConsoleUtils.Log(&quot;æ”¾ç½®&quot;, data); &#125;); &#125; [UIActionBind(UIAction.Click, &quot;3&quot;)] private void OnBtnClick() &#123; ConsoleUtils.Log(&quot;ç‚¹å‡»äº†æŒ‰é’®&quot;); _comboBoxIndex.Set(1); EventManager.TriggerEvent(&quot;show_console&quot;, null); &#125; [UIActionBind(UIAction.DragEnd, &quot;3&quot;, &quot;Self&quot;)] private void OnDrag(EventContext context) &#123; //æ·»åŠ æ‹–æ‹½æ•°æ® AddDropData(1, 2, &quot;æµ‹è¯•æ•°æ®&quot;); Debug.Log(&quot;ç»“æŸæ‹–æ‹½&quot;); Debug.Log(GRoot.inst.touchTarget); &#125; [UIActionBind(UIAction.Drop, &quot;4&quot;)] private void OnDrop(object data) &#123; ConsoleUtils.Log(&quot;æ‹–æ‹½æ”¾ç½®&quot;, data); &#125; [UIListenerBind(&quot;show_console&quot;)] private void ShowConsole(ArrayList data) &#123; ConsoleUtils.Log(&quot;è§¦å‘äº†äº‹ä»¶&quot;); _loaderUrl.Set(&quot;ui://Test/Icon&quot;); _testList.Set(new List&lt;string&gt; &#123; &quot;a&quot;, &quot;b&quot;, &quot;c&quot; &#125;); // _slideValue.Set(70); ConsoleUtils.Log(_slideValue.Get(), _input.Get()); &#125; [UIActionBind(UIAction.Hover,&quot;7&quot;)] private void ShowHint() &#123; ShowFloatView&lt;HintView&gt;(&quot;input_hint&quot;,&quot;HintView&quot;,true); // ConsoleUtils.Log(&quot;æ˜¾ç¤ºæ‚¬æµ®çª—&quot;); &#125; [UIActionBind(UIAction.Slider,&quot;5&quot;)] private void OnSliderChanged() &#123; ConsoleUtils.Log(&quot;æ»‘åŠ¨æ¡&quot;,_slideValue.Get()); &#125; [UIActionBind(UIAction.ComboBox,&quot;9&quot;)] private void OnComboBoxChanged() &#123; ConsoleUtils.Log(&quot;ä¸‹æ‹‰æ¡†&quot;,_comboBoxIndex.Get()); &#125; [UIActionBind(UIAction.Click,&quot;n11&quot;)] private void Close() &#123; UIManager.Ins().HideUI(uiNode); // UIManager.Ins().DisposeUI(uiNode); &#125; // protected override void TweenIn() // &#123; // main.x = -500; // AddTween(TweenTarget.X,500,2000,TweenEaseType.CircOut); // // main.y = 500; // AddTween(TweenTarget.Y,-500,2000,TweenEaseType.Linear); // // main.scaleX = 0.5f; // AddTween(TweenTarget.ScaleX,0.5f,2000,TweenEaseType.CircOut); // // AddTween(TweenTarget.Rotation,50,2000,TweenEaseType.CircOut); // &#125; // protected override void OnShow() &#123; ConsoleUtils.Log(&quot;OnShow&quot;,Time.time); &#125; protected override void OnHide() &#123; ConsoleUtils.Log(&quot;OnHide&quot;); &#125; // protected override void TweenOut() // &#123; // AddTween(TweenTarget.X,500,2000,TweenEaseType.CircOut); // &#125;&#125; çª—å£ç¼“åŠ¨ ç¼“åŠ¨æ–¹æ³• Ease123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250using System;using UnityEngine;public enum TweenEaseType&#123; Linear, SineIn, SineOut, SineInOut, QuadIn, QuadOut, QuadInOut, CubicIn, CubicOut, CubicInOut, QuartIn, QuartOut, QuartInOut, QuintIn, QuintOut, QuintInOut, ExpoIn, ExpoOut, ExpoInOut, CircIn, CircOut, CircInOut, ElasticIn, ElasticOut, ElasticInOut, BackIn, BackOut, BackInOut, BounceIn, BounceOut, BounceInOut, Custom&#125;public class EaseUtil&#123; const float _PiOver2 = Mathf.PI * 0.5f; const float _TwoPi = Mathf.PI * 2; internal static float Evaluate(TweenEaseType TweenEaseType, float time, float duration, float overshootOrAmplitude, float period) &#123; if (duration &lt;= 0) return 1; switch (TweenEaseType) &#123; case TweenEaseType.Linear: return time / duration; case TweenEaseType.SineIn: return -(float)Math.Cos(time / duration * _PiOver2) + 1; case TweenEaseType.SineOut: return (float)Math.Sin(time / duration * _PiOver2); case TweenEaseType.SineInOut: return -0.5f * ((float)Math.Cos(Mathf.PI * time / duration) - 1); case TweenEaseType.QuadIn: return (time /= duration) * time; case TweenEaseType.QuadOut: return -(time /= duration) * (time - 2); case TweenEaseType.QuadInOut: if ((time /= duration * 0.5f) &lt; 1) return 0.5f * time * time; return -0.5f * ((--time) * (time - 2) - 1); case TweenEaseType.CubicIn: return (time /= duration) * time * time; case TweenEaseType.CubicOut: return ((time = time / duration - 1) * time * time + 1); case TweenEaseType.CubicInOut: if ((time /= duration * 0.5f) &lt; 1) return 0.5f * time * time * time; return 0.5f * ((time -= 2) * time * time + 2); case TweenEaseType.QuartIn: return (time /= duration) * time * time * time; case TweenEaseType.QuartOut: return -((time = time / duration - 1) * time * time * time - 1); case TweenEaseType.QuartInOut: if ((time /= duration * 0.5f) &lt; 1) return 0.5f * time * time * time * time; return -0.5f * ((time -= 2) * time * time * time - 2); case TweenEaseType.QuintIn: return (time /= duration) * time * time * time * time; case TweenEaseType.QuintOut: return ((time = time / duration - 1) * time * time * time * time + 1); case TweenEaseType.QuintInOut: if ((time /= duration * 0.5f) &lt; 1) return 0.5f * time * time * time * time * time; return 0.5f * ((time -= 2) * time * time * time * time + 2); case TweenEaseType.ExpoIn: return (time == 0) ? 0 : (float)Math.Pow(2, 10 * (time / duration - 1)); case TweenEaseType.ExpoOut: if (time == duration) return 1; return (-(float)Math.Pow(2, -10 * time / duration) + 1); case TweenEaseType.ExpoInOut: if (time == 0) return 0; if (time == duration) return 1; if ((time /= duration * 0.5f) &lt; 1) return 0.5f * (float)Math.Pow(2, 10 * (time - 1)); return 0.5f * (-(float)Math.Pow(2, -10 * --time) + 2); case TweenEaseType.CircIn: return -((float)Math.Sqrt(1 - (time /= duration) * time) - 1); case TweenEaseType.CircOut: return (float)Math.Sqrt(1 - (time = time / duration - 1) * time); case TweenEaseType.CircInOut: if ((time /= duration * 0.5f) &lt; 1) return -0.5f * ((float)Math.Sqrt(1 - time * time) - 1); return 0.5f * ((float)Math.Sqrt(1 - (time -= 2) * time) + 1); case TweenEaseType.ElasticIn: float s0; if (time == 0) return 0; if ((time /= duration) == 1) return 1; if (period == 0) period = duration * 0.3f; if (overshootOrAmplitude &lt; 1) &#123; overshootOrAmplitude = 1; s0 = period / 4; &#125; else s0 = period / _TwoPi * (float)Math.Asin(1 / overshootOrAmplitude); return -(overshootOrAmplitude * (float)Math.Pow(2, 10 * (time -= 1)) * (float)Math.Sin((time * duration - s0) * _TwoPi / period)); case TweenEaseType.ElasticOut: float s1; if (time == 0) return 0; if ((time /= duration) == 1) return 1; if (period == 0) period = duration * 0.3f; if (overshootOrAmplitude &lt; 1) &#123; overshootOrAmplitude = 1; s1 = period / 4; &#125; else s1 = period / _TwoPi * (float)Math.Asin(1 / overshootOrAmplitude); return (overshootOrAmplitude * (float)Math.Pow(2, -10 * time) * (float)Math.Sin((time * duration - s1) * _TwoPi / period) + 1); case TweenEaseType.ElasticInOut: float s; if (time == 0) return 0; if ((time /= duration * 0.5f) == 2) return 1; if (period == 0) period = duration * (0.3f * 1.5f); if (overshootOrAmplitude &lt; 1) &#123; overshootOrAmplitude = 1; s = period / 4; &#125; else s = period / _TwoPi * (float)Math.Asin(1 / overshootOrAmplitude); if (time &lt; 1) return -0.5f * (overshootOrAmplitude * (float)Math.Pow(2, 10 * (time -= 1)) * (float)Math.Sin((time * duration - s) * _TwoPi / period)); return overshootOrAmplitude * (float)Math.Pow(2, -10 * (time -= 1)) * (float)Math.Sin((time * duration - s) * _TwoPi / period) * 0.5f + 1; case TweenEaseType.BackIn: return (time /= duration) * time * ((overshootOrAmplitude + 1) * time - overshootOrAmplitude); case TweenEaseType.BackOut: return ((time = time / duration - 1) * time * ((overshootOrAmplitude + 1) * time + overshootOrAmplitude) + 1); case TweenEaseType.BackInOut: if ((time /= duration * 0.5f) &lt; 1) return 0.5f * (time * time * (((overshootOrAmplitude *= (1.525f)) + 1) * time - overshootOrAmplitude)); return 0.5f * ((time -= 2) * time * (((overshootOrAmplitude *= (1.525f)) + 1) * time + overshootOrAmplitude) + 2); case TweenEaseType.BounceIn: return Bounce.EaseIn(time, duration); case TweenEaseType.BounceOut: return Bounce.EaseOut(time, duration); case TweenEaseType.BounceInOut: return Bounce.EaseInOut(time, duration); default: return -(time /= duration) * (time - 2); &#125; &#125;&#125;/// &lt;summary&gt;/// This class contains a C# port of the easing equations created by Robert Penner (http://robertpenner.com/easing)./// &lt;/summary&gt;static class Bounce&#123; /// &lt;summary&gt; /// Easing equation function for a bounce (exponentially decaying parabolic bounce) easing in: accelerating from zero velocity. /// &lt;/summary&gt; /// &lt;param name=&quot;time&quot;&gt; /// Current time (in frames or seconds). /// &lt;/param&gt; /// &lt;param name=&quot;duration&quot;&gt; /// Expected easing duration (in frames or seconds). /// &lt;/param&gt; /// &lt;returns&gt; /// The eased value. /// &lt;/returns&gt; public static float EaseIn(float time, float duration) &#123; return 1 - EaseOut(duration - time, duration); &#125; /// &lt;summary&gt; /// Easing equation function for a bounce (exponentially decaying parabolic bounce) easing out: decelerating from zero velocity. /// &lt;/summary&gt; /// &lt;param name=&quot;time&quot;&gt; /// Current time (in frames or seconds). /// &lt;/param&gt; /// &lt;param name=&quot;duration&quot;&gt; /// Expected easing duration (in frames or seconds). /// &lt;/param&gt; /// &lt;returns&gt; /// The eased value. /// &lt;/returns&gt; public static float EaseOut(float time, float duration) &#123; if ((time /= duration) &lt; (1 / 2.75f)) &#123; return (7.5625f * time * time); &#125; if (time &lt; (2 / 2.75f)) &#123; return (7.5625f * (time -= (1.5f / 2.75f)) * time + 0.75f); &#125; if (time &lt; (2.5f / 2.75f)) &#123; return (7.5625f * (time -= (2.25f / 2.75f)) * time + 0.9375f); &#125; return (7.5625f * (time -= (2.625f / 2.75f)) * time + 0.984375f); &#125; /// &lt;summary&gt; /// Easing equation function for a bounce (exponentially decaying parabolic bounce) easing in/out: acceleration until halfway, then deceleration. /// &lt;/summary&gt; /// &lt;param name=&quot;time&quot;&gt; /// Current time (in frames or seconds). /// &lt;/param&gt; /// &lt;param name=&quot;duration&quot;&gt; /// Expected easing duration (in frames or seconds). /// &lt;/param&gt; /// &lt;returns&gt; /// The eased value. /// &lt;/returns&gt; public static float EaseInOut(float time, float duration) &#123; if (time &lt; duration * 0.5f) &#123; return EaseIn(time * 2, duration) * 0.5f; &#125; return EaseOut(time * 2 - duration, duration) * 0.5f + 0.5f; &#125;&#125; ç¼“åŠ¨å•å…ƒ UITween12345678910111213141516171819202122232425262728293031323334using System;using UnityEngine;public class UITween&#123; public int id; public float duration; private int _time; public bool isStop; public Action&lt;float&gt; updater; public Action callback; public void Update(int delta) &#123; _time += delta; if (_time &lt;= duration) &#123; updater?.Invoke(_time); &#125; else &#123; updater?.Invoke(duration); callback?.Invoke(); isStop = true; updater = null; callback = null; &#125; &#125;&#125; ç¼“åŠ¨æ›´æ–° TweenUpdater12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849using System.Collections.Generic;using UnityEngine;public class TweenUpdater : MonoBehaviour&#123; private Dictionary&lt;int,UITween&gt; _actions = new Dictionary&lt;int,UITween&gt;(); private List&lt;int&gt; _removeActionIndexes = new List&lt;int&gt;(); void Update() &#123; int delta = (int)(Time.deltaTime * 1000); foreach (var action in _actions) &#123; UITween vt = action.Value; if (vt.isStop) &#123; _removeActionIndexes.Add(vt.id); &#125; else &#123; vt.Update(delta); &#125; &#125; for (int i = _removeActionIndexes.Count - 1; i &gt;= 0; i--) &#123; _actions.Remove(_removeActionIndexes[i]); _removeActionIndexes.RemoveAt(i); &#125; &#125; public void AddTween(UITween tween) &#123; _actions.Add(tween.id,tween); &#125; public void StopTween(int id) &#123; UITween tween; _actions.TryGetValue(id, out tween); if (tween != null) &#123; tween.isStop = true; &#125; &#125;&#125; ç¼“åŠ¨ç®¡ç† UITweenManager123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154using System;using FairyGUI;using UnityEngine;public class UITweenManager : Singleton&lt;UITweenManager&gt;&#123; private TweenUpdater _updater; private int _id = 0; public void Init() &#123; GameObject obj = new GameObject(); obj.name = &quot;TweenUpdater&quot;; _updater = obj.AddComponent&lt;TweenUpdater&gt;(); &#125; public int AddTween(GObject obj, TweenTarget target, float end, int duration, TweenEaseType ease = TweenEaseType.Linear, Action callback = null) &#123; UITween vt = new UITween(); vt.id = _id++; vt.duration = duration; vt.updater = GenerateUpdater(obj, target, end, duration, ease); vt.callback = callback; _updater.AddTween(vt); return vt.id; &#125; public int AddTween(GObject obj, TweenTarget target, Vector2 end, int duration, TweenEaseType ease = TweenEaseType.Linear, Action callback = null) &#123; UITween vt = new UITween(); vt.id = _id++; vt.duration = duration; vt.updater = GenerateUpdater(obj, target, end, duration, ease); vt.callback = callback; _updater.AddTween(vt); return vt.id; &#125; public void StopTween(int id) &#123; _updater.StopTween(id); &#125; private Action&lt;float&gt; GenerateUpdater(GObject obj, TweenTarget target, float end, float duration, TweenEaseType ease) &#123; float origin = 0; switch (target) &#123; case TweenTarget.X: origin = obj.x; break; case TweenTarget.Y: origin = obj.y; break; case TweenTarget.ScaleX: origin = obj.scaleX; break; case TweenTarget.ScaleY: origin = obj.scaleY; break; case TweenTarget.Rotation: origin = obj.rotation; break; case TweenTarget.Alpha: origin = obj.alpha; break; case TweenTarget.Heihgt: origin = obj.height; break; case TweenTarget.Width: origin = obj.width; break; &#125; void Action(float time) &#123; float ratio = EaseUtil.Evaluate(ease, time, duration, 1.7f, 0); switch (target) &#123; case TweenTarget.X: obj.x = origin + ratio * end; break; case TweenTarget.Y: obj.y = origin + ratio * end; break; case TweenTarget.ScaleX: obj.scaleX = origin + ratio * end; break; case TweenTarget.ScaleY: obj.scaleY = origin + ratio * end; break; case TweenTarget.Rotation: obj.rotation = origin + ratio * end; break; case TweenTarget.Alpha: obj.alpha = origin + ratio * end; break; case TweenTarget.Heihgt: obj.height = origin + ratio * end; break; case TweenTarget.Width: obj.width = origin + ratio * end; break; &#125; &#125; return Action; &#125; private Action&lt;float&gt; GenerateUpdater(GObject obj, TweenTarget target, Vector2 end, float duration, TweenEaseType ease) &#123; Vector2 origin = Vector2.zero; switch (target) &#123; case TweenTarget.Position: origin = obj.xy; break; case TweenTarget.Scale: origin = obj.scale; break; case TweenTarget.Size: origin = obj.size; break; &#125; void Action(float time) &#123; float ratio = EaseUtil.Evaluate(ease, time, duration, 1.7f, 0); switch (target) &#123; case TweenTarget.Position: obj.xy = origin + ratio * end; break; case TweenTarget.Scale: obj.scale = origin + ratio * end; break; case TweenTarget.Size: obj.size = origin + ratio * end; break; &#125; &#125; return Action; &#125;&#125; UI ç®¡ç†å™¨ UINode 123456789101112131415161718192021222324using System.Collections.Generic;public class UINode&#123; /// &lt;summary&gt; /// çˆ¶èŠ‚ç‚¹ /// &lt;/summary&gt; public UINode parent; /// &lt;summary&gt; /// å±‚çº§ç´¢å¼• /// &lt;/summary&gt; public int layer; /// &lt;summary&gt; /// æ‰€å±žUI /// &lt;/summary&gt; public BaseView ui; /// &lt;summary&gt; /// å­èŠ‚ç‚¹ /// &lt;/summary&gt; public Dictionary&lt;string, UINode&gt; children = new Dictionary&lt;string, UINode&gt;();&#125; UIManager 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188using System;using System.Collections.Generic;using FairyGUI;public class UIManager : Singleton&lt;UIManager&gt;&#123; private UINode _root = new UINode(); private int _id = 0; private List&lt;GComponent&gt; _layer = new List&lt;GComponent&gt;(); private Dictionary&lt;string, UINode&gt; _savedView = new Dictionary&lt;string, UINode&gt;(); /// &lt;summary&gt; /// å±•ç¤ºUI /// &lt;/summary&gt; /// &lt;param name=&quot;folder&quot;&gt;UIæ‰€åœ¨æ–‡ä»¶å¤¹&lt;/param&gt; /// &lt;param name=&quot;package&quot;&gt;UIåŒ…å&lt;/param&gt; /// &lt;param name=&quot;name&quot;&gt;è‡ªå®šä¹‰åç§°&lt;/param&gt; /// &lt;param name=&quot;parent&quot;&gt;çˆ¶èŠ‚ç‚¹&lt;/param&gt; /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt; /// &lt;returns&gt;&lt;/returns&gt; public UINode ShowUI&lt;T&gt;(string folder, string package, string name, UINode parent = null) where T : BaseView, new() &#123; //æœ‰ä¿å­˜çš„UIç›´æŽ¥å±•ç¤ºå¹¶è¿”å›ž if (_savedView.TryGetValue(name, out var node)) &#123; node.ui.Show(); return node; &#125; //åˆ›å»ºæ²¡ä¿å­˜çš„UI Type type = typeof(T); //åŒ…åŠ è½½é€»è¾‘æš‚æ—¶åŠ è½½Resourcesæ–‡ä»¶å¤¹å†…æ–‡ä»¶ å¦‚æœ‰éœ€è¦å¯è‡ªè¡Œä¿®æ”¹ string packagePath = folder + &quot;/&quot; + package; UIPackage.AddPackage(packagePath); //åˆ›å»ºUI T view = new T(); view.id = &quot;ui_&quot; + _id++; view.name = name; view.main = UIPackage.CreateObject(package, type.Name).asCom; //åˆ›å»ºUIèŠ‚ç‚¹ UINode ui = new UINode(); ui.ui = view; if (parent != null) &#123; int layerIndex = parent.layer + 1; if (_layer.Count - 1 == parent.layer) &#123; GComponent layer = new GComponent(); layer.displayObject.gameObject.name = &quot;Layer_&quot; + layerIndex; GRoot.inst.AddChild(layer); _layer.Add(layer); &#125; _layer[layerIndex].AddChild(view.main); parent.children.Add(view.id, ui); ui.parent = parent; ui.layer = layerIndex; &#125; else &#123; if (_layer.Count == 0) &#123; GComponent layer = new GComponent(); layer.displayObject.gameObject.name = &quot;Layer_0&quot;; GRoot.inst.AddChild(layer); _layer.Add(layer); &#125; _layer[0].AddChild(view.main); _root.children.Add(view.id, ui); ui.parent = _root; ui.layer = 0; &#125; view.uiNode = ui; view.InitConfig(); view.OnAwake(); view.Show(); return ui; &#125; /// &lt;summary&gt; /// éšè—UI /// &lt;/summary&gt; /// &lt;param name=&quot;ui&quot;&gt;UIèŠ‚ç‚¹&lt;/param&gt; public void HideUI(UINode ui) &#123; foreach (var child in ui.children) &#123; UINode uiChild = child.Value; HideUI(uiChild); &#125; ui.ui.Hide(); &#125; /// &lt;summary&gt; /// æ ¹æ®åå­—èŽ·å–UI /// &lt;/summary&gt; /// &lt;param name=&quot;name&quot;&gt;è‡ªå®šä¹‰åç§°&lt;/param&gt; /// &lt;param name=&quot;parent&quot;&gt;çˆ¶èŠ‚ç‚¹&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public UINode GetUI(string name, UINode parent = null) &#123; if (parent == null) &#123; parent = _root; &#125; if (parent.ui != null &amp;&amp; name == parent.ui.name) &#123; return parent; &#125; UINode node; foreach (var child in parent.children) &#123; node = GetUI(name, child.Value); if (node != null) &#123; return node; &#125; &#125; return null; &#125; /// &lt;summary&gt; /// é”€æ¯UI /// &lt;/summary&gt; /// &lt;param name=&quot;ui&quot;&gt;UIèŠ‚ç‚¹&lt;/param&gt; public void DisposeUI(UINode ui) &#123; foreach (var child in ui.children) &#123; UINode uiChild = child.Value; DisposeUI(uiChild); &#125; //ç§»é™¤ä¿å­˜çš„èŠ‚ç‚¹ _savedView.Remove(ui.ui.name); ui.children = null; ui.parent = null; ui.ui.Dispose(); &#125; /// &lt;summary&gt; /// é‡æ–°ç½®äºŽä¸Šå±‚ /// &lt;/summary&gt; /// &lt;param name=&quot;ui&quot;&gt;UIèŠ‚ç‚¹&lt;/param&gt; public void ResetTop(UINode ui) &#123; _layer[ui.layer].AddChild(ui.ui.main); &#125; /// &lt;summary&gt; /// è®¾ç½®æ¨¡æ€èƒŒæ™¯ /// &lt;/summary&gt; /// &lt;param name=&quot;ui&quot;&gt;UIèŠ‚ç‚¹&lt;/param&gt; /// &lt;param name=&quot;model&quot;&gt;æ¨¡æ€èƒŒæ™¯å¯¹è±¡&lt;/param&gt; public void SetModel(UINode ui, GGraph model) &#123; GComponent layer = _layer[ui.layer]; int index = layer.GetChildIndex(ui.ui.main); layer.AddChildAt(model, index); &#125; /// &lt;summary&gt; /// ä¿å­˜èŠ‚ç‚¹ éœ€è¦uiåç§°å”¯ä¸€ /// &lt;/summary&gt; /// &lt;param name=&quot;name&quot;&gt;è‡ªå®šä¹‰åç§°&lt;/param&gt; /// &lt;param name=&quot;ui&quot;&gt;UIèŠ‚ç‚¹&lt;/param&gt; public void SaveNode(string name, UINode ui) &#123; _savedView[name] = ui; &#125;&#125; é¡¹ç›® æ›´æ–°æ—¥å¿—2024-05-30 å› é¡¹ç›®é€»è¾‘æ›´æ–°ï¼Œä¿®æ”¹ç›¸å…³è¯´æ˜Žã€‚ 2024-04-30 æ–°å¢ž UI ç±»ç»‘å®šã€‚æ–°å¢žæ¨¡æ€çª—å£ã€‚æ–°å¢žæ‹–æ‹½çª—å£ã€‚æ–°å¢ž UI ç®¡ç†å™¨ã€‚ 2024-04-27 æ–°å¢žæ»‘åŠ¨æ¡ Actionã€Compã€‚æ–°å¢žä¸‹æ‹‰æ¡† Dataã€Comp å’Œ Actionã€‚ 2024-04-25 æ–°å¢žç®€æ˜“çª—å£ç¼“åŠ¨åŠ¨ç”»ã€‚æ–°å¢žæ‚¬æµ®çª— Actionã€‚ 2024-04-21 æ–°å¢ž double ç±»åž‹æ•°æ®ã€‚æ–°å¢ž UI æ•°æ®åŒå‘ç»‘å®šã€‚æ–°å¢žæ‰‹åŠ¨è®¾ç½®æ‹–æ‹½å’Œæ”¾ç½®æ–¹æ³•ï¼ˆç”¨äºŽ List Itemï¼‰ã€‚ 2024-04-20 æ›´æ–°æ‹–æ‹½åŠŸèƒ½ã€‚è°ƒæ•´éƒ¨åˆ†ä»£ç å±žæ€§åŸŸã€‚ 2024-02-22 æ›´æ–°åŸºç¡€ç‰ˆæœ¬ã€‚","categories":[{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/categories/Unity/"},{"name":"è§£å†³æ–¹æ¡ˆ","slug":"Unity/è§£å†³æ–¹æ¡ˆ","permalink":"https://busyogg.github.io/categories/Unity/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"}],"tags":[{"name":"C#","slug":"C","permalink":"https://busyogg.github.io/tags/C/"},{"name":"Untiy","slug":"Untiy","permalink":"https://busyogg.github.io/tags/Untiy/"},{"name":"UI","slug":"UI","permalink":"https://busyogg.github.io/tags/UI/"},{"name":"åå°„","slug":"åå°„","permalink":"https://busyogg.github.io/tags/%E5%8F%8D%E5%B0%84/"},{"name":"ç‰¹æ€§","slug":"ç‰¹æ€§","permalink":"https://busyogg.github.io/tags/%E7%89%B9%E6%80%A7/"},{"name":"Attribute","slug":"Attribute","permalink":"https://busyogg.github.io/tags/Attribute/"}]},{"title":"å…è´¹å¯¹è±¡å­˜å‚¨ Cloudflare R2","slug":"å…è´¹å¯¹è±¡å­˜å‚¨Cloudflare-R2","date":"2024-01-29T20:50:02.000Z","updated":"2024-05-30T12:25:48.947Z","comments":true,"path":"article/26ad28d4c16a/","link":"","permalink":"https://busyogg.github.io/article/26ad28d4c16a/","excerpt":"","text":"ç¼˜ç”±åœ¨æŸæ—¥ï¼Œæˆ‘çªç„¶å‘çŽ°åšå®¢é‡Œçš„è§†é¢‘åŠ è½½é€Ÿåº¦å¾ˆæ…¢ï¼Œç”±äºŽæˆ‘å¹³æ—¶éƒ½æ˜¯æŒ‚ç€ Clashï¼Œå› æ­¤è¿™ä¹Ÿæ˜¯å¶ç„¶æ‰å‘çŽ°ã€‚åŽŸå› æ˜¯ Cloudflare ä¸ç¼“å­˜è§†é¢‘ã€‚åŽæ¥å°è¯•äº†å„ç§æ–¹æ³•ï¼Œæœ€ç»ˆé€‰æ‹©äº†ä¹Ÿæ˜¯ Cloudflare å®¶çš„ R2 å­˜å‚¨ã€‚ ç®€ä»‹R2 æ˜¯ Cloudflare è‡ªå®¶çš„å¯¹è±¡å­˜å‚¨æœåŠ¡ï¼Œå’Œå…¶ä»–å¯¹è±¡å­˜å‚¨ç›¸æ¯”ï¼ŒR2 ä¸è®¡ç®—æµé‡ï¼Œåªè®¡ç®—è®¿é—®ï¼Œå› æ­¤å¯¹äºŽå¤§æ–‡ä»¶å’Œå°æ–‡ä»¶æ¥è¯´ï¼Œè®¿é—®ä¸€æ¬¡çš„æ¶ˆè€—éƒ½æ˜¯ä¸€æ ·çš„ã€‚ R2 å…è´¹æœ‰æ¯æœˆ 10G å­˜å‚¨ï¼Œ100 ä¸‡æ¬¡ A ç±»æ“ä½œï¼Œ1000 ä¸‡æ¬¡ B ç±»æ“ä½œï¼Œå¯¹äºŽä¸ªäººç”¨æˆ·æ¥è¯´å®Œå…¨è¶³å¤Ÿäº†ã€‚ ç”±äºŽ R2 æ˜¯å›½å¤–çš„ï¼Œå› æ­¤åŸŸåä¸éœ€è¦å¤‡ä»½å¯ä»¥ç›´æŽ¥ä½¿ç”¨ã€‚è€Œä¸”æ–‡ä»¶çš„è®¿é—®é€Ÿåº¦ååˆ†ä¸é”™ã€‚ è®¾ç½®R2 çš„ç”³è¯·æŒ‰ç…§å®˜æ–¹çš„æµç¨‹æ¥å°±å¯ä»¥ï¼Œåœ¨ç”³è¯·å®ŒæˆåŽï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è¿›è¡Œä¸€äº›è®¾ç½®ã€‚ å­˜å‚¨æ¡¶è®¾ç½®å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå­˜å‚¨æ¡¶ä¹‹åŽï¼Œè½¬åˆ°è®¾ç½®ç•Œé¢ã€‚ æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªåŸŸåæ¥è®¿é—®è¿™ä¸ªæ¡¶ã€‚ç‚¹å‡»è¿žæŽ¥åŸŸæ·»åŠ åŸŸåï¼ˆéœ€è¦æŒ‚åˆ° Cloudflareï¼‰ã€‚è¿™æ—¶å€™ Cloudflare åº”è¯¥ä¼šè‡ªåŠ¨è¿›è¡ŒåŸŸåçš„æ ¡éªŒã€‚ ç„¶åŽæˆ‘ä»¬é…ç½®è·¨åŸŸç­–ç•¥ï¼Œæ ¹æ®éœ€æ±‚å³å¯ï¼Œè¿™é‡Œçš„è®¾ç½®è¡¨ç¤ºæ‰€æœ‰æ¥æºå‡å¯è®¿é—®ã€‚ å…¶ä»–è®¾ç½®æ ¹æ®éœ€è¦è‡ªè¡Œè®¾ç½®å³å¯ã€‚ ç¼“å­˜è®¾ç½®æˆ‘ä»¬æ¥åˆ°ç½‘ç«™è®¾ç½®ï¼Œé€‰æ‹©è‡ªå·±çš„åŸŸåã€‚ç„¶åŽæˆ‘ä»¬é€‰æ‹©è§„åˆ™ - é¡µé¢è§„åˆ™ã€‚ çº¢æ¡†éƒ¨åˆ†éœ€è¦è®¾ç½®ï¼Œæ—¶é•¿å¯ä»¥æ ¹æ®è‡ªå·±éœ€è¦æ¥å®šï¼Œå…¶ä»–çš„æŒ‰éœ€è®¾ç½®å³å¯ã€‚ å®‰å…¨è®¾ç½®ç„¶åŽæˆ‘ä»¬è½¬åˆ°å®‰å…¨æ€§-WAFã€‚ æˆ‘ä»¬æ·»åŠ ä¸‰ä¸ªè§„åˆ™ ç¬¬ä¸€ä¸ªè§„åˆ™ç”¨äºŽè®°å½•è®¿é—®ä¿¡æ¯ã€‚ ç¬¬äºŒä¸ªè§„åˆ™ç”¨äºŽé˜²éžæ³•çˆ¬è™«ã€‚ï¼ˆç½‘ç»œæœé›†çš„è§„åˆ™ï¼‰ ç¬¬ä¸‰ä¸ªè§„åˆ™ç”¨äºŽæ”¾è¡Œåˆæ³•çˆ¬è™«ã€‚ï¼ˆç½‘ç»œæœé›†çš„è§„åˆ™ï¼‰ ä»¥ä¸‹æ˜¯ä¸‰æ¡è§„åˆ™çš„ä»£ç ï¼š (http.host contains &quot;your domain&quot; and ip.geoip.country ne &quot;CN&quot;) (cf.threat_score ge 5 and not cf.client.bot) or (not http.request.version in &#123;&quot;HTTP/1.2&quot; &quot;HTTP/2&quot; &quot;HTTP/3&quot; &quot;SPDY/3.1&quot;&#125;) or (not http.user_agent contains &quot;Mozilla/&quot;) (cf.client.bot) or (http.user_agent contains &quot;duckduckgo&quot;) or (http.user_agent contains &quot;facebookexternalhit&quot;) or (http.user_agent contains &quot;Feedfetcher-Google&quot;) or (http.user_agent contains &quot;LinkedInBot&quot;) or (http.user_agent contains &quot;Mediapartners-Google&quot;) or (http.user_agent contains &quot;msnbot&quot;) or (http.user_agent contains &quot;Slackbot&quot;) or (http.user_agent contains &quot;TwitterBot&quot;) or (http.user_agent contains &quot;ia_archive&quot;) or (http.user_agent contains &quot;yahoo&quot;) ç„¶åŽæ˜¯ä¸‰æ¡è§„åˆ™çš„æ“ä½œï¼š è¿˜æœ‰ä¸€æ¡é€Ÿåº¦é™åˆ¶çš„è§„åˆ™ã€‚ è¡¨è¾¾å¼ä¸º(http.request.uri.path contains &quot;/&quot;) æŒ‰ç…§å¦‚å›¾æ‰€ç¤ºè®¾ç½®å³å¯ã€‚ ä½¿ç”¨æ–¹æ³•æˆ‘ä»¬å¯ä»¥é€šè¿‡å­˜å‚¨æ¡¶é¡µé¢çš„ä¸Šä¼ æŒ‰é’®æ¥ä¸Šä¼ æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–æ–¹æ³•æ¥ä¸Šä¼ ï¼ˆä¾‹å¦‚ alistï¼Œè¯·è‡ªè¡Œç ”ç©¶ï¼‰ã€‚ å½“æˆ‘ä»¬è¦è®¿é—®æ–‡ä»¶çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡åˆšæ‰é“¾æŽ¥çš„åŸŸåæ¥è®¿é—®ï¼Œåªè¦è¾“å…¥your domain/filename.suffixå½¢å¼çš„é“¾æŽ¥å³å¯ã€‚ æ›´æ–°æ—¥å¿—2024-01-30 æ›´æ–°åŸºæœ¬å†…å®¹ã€‚","categories":[{"name":"åˆ†äº«","slug":"åˆ†äº«","permalink":"https://busyogg.github.io/categories/%E5%88%86%E4%BA%AB/"}],"tags":[{"name":"Cloudflare","slug":"Cloudflare","permalink":"https://busyogg.github.io/tags/Cloudflare/"},{"name":"å¯¹è±¡å­˜å‚¨","slug":"å¯¹è±¡å­˜å‚¨","permalink":"https://busyogg.github.io/tags/%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8/"},{"name":"OSS","slug":"OSS","permalink":"https://busyogg.github.io/tags/OSS/"}]},{"title":"å®šç‚¹æ•°åŽŸç†","slug":"å®šç‚¹æ•°åŽŸç†","date":"2024-01-27T09:48:46.000Z","updated":"2024-05-30T12:24:28.416Z","comments":true,"path":"article/fbf1414ac525/","link":"","permalink":"https://busyogg.github.io/article/fbf1414ac525/","excerpt":"","text":"ç®€ä»‹åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯åŒæ ·çš„è¾“å…¥å¾—åˆ°åŒæ ·çš„ç»“æžœã€‚å› æ­¤æˆ‘ä»¬è¦ä¹ˆä½¿ç”¨æ•´å½¢ï¼Œè¦ä¹ˆå°±ä½¿ç”¨å®šç‚¹æ•°ã€‚ æœ¬æ–‡ä¸»è¦ä»‹ç»å®šç‚¹æ•°çš„åŽŸç†ã€‚ ä»€ä¹ˆæ˜¯å®šç‚¹æ•°å®šç‚¹æ•°æ˜¯æŒ‡å°æ•°ç‚¹ä½ç½®å›ºå®šçš„æ•°ï¼Œç”¨æ•´æ•°æ¥è¡¨ç¤ºå°æ•°ã€‚æ‰€ä»¥æœ¬è´¨ä¸Šï¼Œå®šç‚¹æ•°çš„è¿ç®—å…¶å®žå°±æ˜¯æ•´æ•°çš„è¿ç®—ã€‚ç”±äºŽæµ®ç‚¹æ•°ä½¿ç”¨çš„æ˜¯ç§‘å­¦è®¡æ•°æ³•æ¥è¡¨ç¤ºï¼Œè¿˜åŽŸæˆæ•°å­—çš„æ—¶å€™ä¼šäº§ç”Ÿè¯¯å·®ï¼Œå› æ­¤ä½¿ç”¨æ•´æ•°è¿ç®—çš„å®šç‚¹æ•°ä¸ä¼šäº§ç”Ÿç²¾åº¦è¯¯å·®ã€‚ å®šç‚¹æ•°åŽŸç†æˆ‘ä»¬çº¦å®šå®šç‚¹æ•°çš„åå­—å«åš FPã€‚ å®šç‚¹æ•°è¡¨ç¤ºæœ¬æ–‡å®šç‚¹æ•°ç”¨ long é•¿æ•´åž‹æ¥è¡¨ç¤ºã€‚é•¿æ•´åž‹ä¸€å…± 64 ä½ï¼Œæœ€é«˜ä½è¡¨ç¤ºç¬¦å·ï¼Œé™¤ç¬¦å·ä½å¤–ï¼Œå‰ 31 ä½è¡¨ç¤ºæ•´æ•°éƒ¨åˆ†ï¼ŒåŽ 32 ä½è¡¨ç¤ºå°æ•°éƒ¨åˆ†ã€‚ å®šç‚¹æ•°è¿ç®—ç±»åž‹è½¬æ¢åŠ æ³•å‡æ³•ä¹˜æ³•é™¤æ³•æ±‚ä½™å…¶ä»–è¿ç®—ç¬¦é¦–å…ˆæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªåŸºæœ¬å•ä½ï¼Œç”¨äºŽè®¡ç®—ã€‚ 12public const int FRACTIONAL_PLACES = 32;public const long ONE = 1L &lt;&lt; FRACTIONAL_PLACES; ONE ä»£è¡¨ FP çš„ä¸€ä¸ªå•ä½å¤§å°ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ç±»åž‹è½¬æ¢çš„æ—¶å€™é€šè¿‡åŽŸæ¥çš„æ•°å€¼å¤§å°ä¹˜ä»¥ ONEï¼Œå°±å¯ä»¥å¾—åˆ°è½¬å˜ä¸º FP ç±»åž‹ä¹‹åŽçš„å€¼ã€‚ åœ¨äºŒè¿›åˆ¶çš„è§†è§’ä¸‹ï¼Œå°±ç›¸å½“äºŽåŽŸæ¥çš„æ•°å·¦ç§»äº† 32 ä½ã€‚ æµ®ç‚¹æ•°è½¬æ¢çš„æ—¶å€™éœ€è¦æ˜¾ç¤ºè½¬æ¢ä¸º longã€‚ ä»Ž FP è½¬æ¢åˆ°å…¶ä»–ç±»åž‹çš„è¯åªè¦è¿›è¡Œç›¸åçš„æ“ä½œï¼Œå³é™¤ä»¥ ONEï¼Œç„¶åŽå¦‚æžœæ˜¯ int ç±»åž‹å°±åœ¨è®¡ç®—å®ŒåŽæ˜¾ç¤ºè½¬æ¢ä¸º intï¼Œå¦‚æžœæ˜¯æµ®ç‚¹ç±»åž‹å°±æå‰æ˜¾ç¤ºè½¬æ¢ä¸ºæµ®ç‚¹ç±»åž‹å³å¯ã€‚ é€šè¿‡é‡è½½ç±»åž‹è½¬æ¢ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä½¿ç”¨çš„æ—¶å€™æ›´æ–¹ä¾¿åœ°è¿›è¡Œç±»åž‹è½¬æ¢ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152public FP(long value)&#123; _value = value;&#125;public static implicit operator FP(long value)&#123; FP res; res._value = value * ONE; return res;&#125;public static implicit operator FP(int value)&#123; FP res; res._value = value * ONE; return res;&#125;public static implicit operator FP(float value)&#123; FP res; res._value = (long)(value * ONE); return res;&#125;public static implicit operator FP(double value)&#123; FP res; res._value = (long)(value * ONE); return res;&#125;public static explicit operator int(FP fp)&#123; return (int)(fp._value / ONE);&#125;public static explicit operator long(FP fp)&#123; return fp._value &gt;&gt; FRACTIONAL_PLACES;&#125;public static explicit operator float(FP fp)&#123; return (float)fp._value / ONE;&#125;public static explicit operator double(FP fp)&#123; return (double)fp._value / ONE;&#125; æˆ‘ä»¬åªè¦é€šè¿‡å¦‚ä¸‹æ–¹æ³•ï¼Œå°±å¯ä»¥å¾—åˆ° FP æ•°ï¼š 12FP num = 1;FP num2 = 1.1f;æˆ‘ä»¬é‡è½½åŠ æ³•è¿ç®—ç¬¦ã€‚ åŠ æ³•åªè¦æŠŠä¸¤ä¸ª FP çš„å€¼ç›¸åŠ ï¼Œå¾—åˆ°ä¸€ä¸ªæ–°çš„å€¼å³å¯ã€‚ å¦‚æžœç›¸åŠ ä¹‹åŽå‡ºçŽ°è¶…å‡º FP èƒ½è¡¨ç¤ºçš„æœ€å¤§ä½æ•°ï¼Œåˆ™è¯¥ç»“æžœæº¢å‡ºï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è¿›è¡Œæº¢å‡ºåˆ¤æ–­ã€‚ æº¢å‡ºåˆ¤æ–­ä¸»è¦æ˜¯å¯¹ç¬¦å·ä½è¿›è¡Œæ£€æµ‹ã€‚ é¦–å…ˆæˆ‘ä»¬é€šè¿‡å¼‚æˆ–åˆ¤æ–­ xl ^ yl ä¸¤ä¸ªå‚æ•°çš„ç¬¦å·ä½æ˜¯å¦ç›¸åŒï¼Œç›¸åŒæƒ…å†µå¾—åˆ°çš„ç»“æžœï¼Œç¬¦å·ä½ä¸º 0ï¼Œå¦åˆ™ä¸º 1ã€‚ ç„¶åŽæˆ‘ä»¬å¯¹è¯¥ç»“æžœå–åï¼Œå³æˆ‘ä»¬æ£€æµ‹ä¸¤ä¸ªå‚æ•°ä¸ºåŒå·çš„æƒ…å†µã€‚å› ä¸ºåªæœ‰åŒå·ç›¸åŠ çš„æƒ…å†µï¼Œæ‰ä¼šäº§ç”Ÿæº¢å‡ºï¼Œå¼‚å·ç›¸åŠ çš„ç»“æžœåªä¼šåœ¨æ­£è´Ÿæžé™å€¼ä¹‹å†…ã€‚ æŽ¥ç€æˆ‘ä»¬åˆ¤æ–­ xl ^ sum å‚æ•° 1 ä¸Žç»“æžœçš„ç¬¦å·æ˜¯å¦ç›¸åŒï¼ˆä¹Ÿå¯ä»¥ç”¨å‚æ•° 2ï¼‰ã€‚ æ ¹æ®å‰é¢çš„ç»“æžœï¼Œæˆ‘ä»¬æŽ¥ä¸‹æ¥åˆ¤æ–­ (~(xl ^ yl) &amp; (xl ^ sum)) ç¬¦å·ä½æ˜¯å¦ç›¸åŒã€‚è¿™é‡Œä¼šå‡ºçŽ°ä¸¤ç§ç»“æžœï¼š ä¸¤ä¸ªå‚æ•°åŒå·ï¼š~(xl ^ yl) ç¬¦å·ä½ä¸º 1ã€‚ç”±äºŽæº¢å‡ºä¼šä½¿ç¬¦å·ç›¸åï¼Œå› æ­¤å¦‚æžœ (xl ^ sum) åŒå·ï¼Œå³ä¸º 0ï¼Œä¸æº¢å‡ºï¼Œåˆ™åœ¨ç¬¦å·ä½ä¸Šï¼Œ1 &amp; 0 = 0ï¼›å¦‚æžœ(xl ^ sum) å¼‚å·ï¼Œå³ä¸º 1ï¼Œæº¢å‡ºï¼Œåˆ™åœ¨ç¬¦å·ä½ä¸Šï¼Œ1 &amp; 1 = 1ã€‚ ä¸¤ä¸ªå‚æ•°å¼‚å·ï¼š~(xl ^ yl) ç¬¦å·ä½ä¸º 0ï¼Œåˆ™ç¬¦å·ä½ç»“æžœå¿…ä¸º 0ã€‚ 5.æœ€åŽæˆ‘ä»¬è·Ÿ Min_Value æ±‚ä¸Žï¼ŒMin_Value æ˜¯ float çš„æœ€å°æ•°ï¼Œå³æœ€é«˜ä½ç¬¦å·ä½ä¸º 1ï¼Œå…¶ä½™éƒ½æ˜¯ 0ã€‚è¿™æ ·å°±èƒ½å•ç‹¬æ¯”è¾ƒç¬¦å·ä½çš„ç»“æžœæ˜¯å¦ä¸º 0ï¼Œä¸æ˜¯åˆ™æº¢å‡ºã€‚ 1234567891011121314public static FP operator +(FP x,FP y)&#123; var xl = x._value; var yl = y._value; var sum = xl + yl; //é€šè¿‡ç¬¦å·ä½åˆ¤æ–­æº¢å‡º if (((~(xl ^ yl) &amp; (xl ^ sum)) &amp; Min_Value) != 0) &#123; sum = xl &gt; 0 ? Max_Value : Min_Value; &#125; FP result; result._value = sum; return result;&#125;æˆ‘ä»¬é‡è½½å‡æ³•è¿ç®—ç¬¦ã€‚ åŠ æ³•åªè¦æŠŠä¸¤ä¸ª FP çš„å€¼ç›¸å‡ï¼Œå¾—åˆ°ä¸€ä¸ªæ–°çš„å€¼å³å¯ã€‚ å¦‚æžœç›¸åŠ ä¹‹åŽå‡ºçŽ°è¶…å‡º FP èƒ½è¡¨ç¤ºçš„æœ€å¤§ä½æ•°ï¼Œåˆ™è¯¥ç»“æžœæº¢å‡ºï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è¿›è¡Œæº¢å‡ºåˆ¤æ–­ã€‚ æº¢å‡ºåˆ¤æ–­ä¸»è¦æ˜¯å¯¹ç¬¦å·ä½è¿›è¡Œæ£€æµ‹ã€‚ é¦–å…ˆæˆ‘ä»¬é€šè¿‡å¼‚æˆ–åˆ¤æ–­ xl ^ yl ä¸¤ä¸ªå‚æ•°çš„ç¬¦å·ä½æ˜¯å¦ç›¸åŒï¼Œç›¸åŒæƒ…å†µå¾—åˆ°çš„ç»“æžœï¼Œç¬¦å·ä½ä¸º 0ï¼Œå¦åˆ™ä¸º 1ã€‚ æ­¤å¤„æˆ‘ä»¬ä¸å¯¹è¯¥ç»“æžœå–åï¼Œå’ŒåŠ æ³•ç›¸åã€‚å› ä¸ºåªæœ‰å¼‚å·ç›¸å‡çš„æƒ…å†µï¼Œæ‰ä¼šäº§ç”Ÿæº¢å‡ºï¼ŒåŒå·ç›¸å‡çš„ç»“æžœåªä¼šåœ¨æ­£è´Ÿæžé™å€¼ä¹‹å†…ã€‚ æŽ¥ç€æˆ‘ä»¬åˆ¤æ–­ xl ^ sum å‚æ•° 1 ä¸Žç»“æžœçš„ç¬¦å·æ˜¯å¦ç›¸åŒï¼ˆä¹Ÿå¯ä»¥ç”¨å‚æ•° 2ï¼‰ã€‚ æ ¹æ®å‰é¢çš„ç»“æžœï¼Œæˆ‘ä»¬æŽ¥ä¸‹æ¥åˆ¤æ–­ ((xl ^ yl) &amp; (xl ^ sum)) ç¬¦å·ä½æ˜¯å¦ç›¸åŒã€‚è¿™é‡Œä¼šå‡ºçŽ°ä¸¤ç§ç»“æžœï¼š ä¸¤ä¸ªå‚æ•°å¼‚å·ï¼š(xl ^ yl) ç¬¦å·ä½ä¸º 1ã€‚ç”±äºŽæº¢å‡ºä¼šä½¿ç¬¦å·ç›¸åï¼Œå› æ­¤å¦‚æžœ (xl ^ sum) åŒå·ï¼Œå³ä¸º 0ï¼Œä¸æº¢å‡ºï¼Œåˆ™åœ¨ç¬¦å·ä½ä¸Šï¼Œ1 &amp; 0 = 0ï¼›å¦‚æžœ(xl ^ sum) å¼‚å·ï¼Œå³ä¸º 1ï¼Œæº¢å‡ºï¼Œåˆ™åœ¨ç¬¦å·ä½ä¸Šï¼Œ1 &amp; 1 = 1ã€‚ ä¸¤ä¸ªå‚æ•°åŒå·ï¼š(xl ^ yl) ç¬¦å·ä½ä¸º 0ï¼Œåˆ™ç¬¦å·ä½ç»“æžœå¿…ä¸º 0ã€‚ 5.æœ€åŽæˆ‘ä»¬è·Ÿ Min_Value æ±‚ä¸Žï¼ŒMin_Value æ˜¯ float çš„æœ€å°æ•°ï¼Œå³æœ€é«˜ä½ç¬¦å·ä½ä¸º 1ï¼Œå…¶ä½™éƒ½æ˜¯ 0ã€‚è¿™æ ·å°±èƒ½å•ç‹¬æ¯”è¾ƒç¬¦å·ä½çš„ç»“æžœæ˜¯å¦ä¸º 0ï¼Œä¸æ˜¯åˆ™æº¢å‡ºã€‚ 1234567891011121314public static FP operator -(FP x, FP y)&#123; var xl = x._value; var yl = y._value; var diff = xl - yl; //é€šè¿‡ç¬¦å·ä½åˆ¤æ–­æº¢å‡º if ((((xl ^ yl) &amp; (xl ^ diff)) &amp; Min_Value) != 0) &#123; diff = xl &gt; 0 ? Max_Value : Min_Value; &#125; FP result; result._value = diff; return result;&#125;æˆ‘ä»¬é‡è½½ä¹˜æ³•è¿ç®—ç¬¦ã€‚ ä¹˜æ³•è¿ç®—æˆ‘ä»¬åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œå››ä¸ªæ­¥éª¤è¿›è¡Œã€‚ä¸¤ä¸ªéƒ¨åˆ†æ˜¯æ•´æ•°éƒ¨åˆ†å’Œå°æ•°éƒ¨åˆ†ï¼Œå››ä¸ªæ­¥éª¤ï¼Œæ˜¯ä¸¤ä¸ªå‚æ•°çš„æ•´æ•°å’Œå°æ•°åˆ†åˆ«ç›¸ä¹˜ã€‚æœ€åŽæˆ‘ä»¬æŠŠå¾—åˆ°çš„ç»“æžœç›¸åŠ ï¼Œå°±æ˜¯ä¹˜æ³•çš„ç»“æžœäº†ã€‚ æˆ‘ä»¬å¯ä»¥ç±»æ¯”ä¸ºç«–å¼è®¡ç®—çš„è¿‡ç¨‹ï¼Œè¿™æ ·æˆ–è®¸ä¼šæ›´å¥½ç†è§£ã€‚ æ¯”å¦‚ $1.1 \\times 1.1$ ,æˆ‘ä»¬æ ¹æ®è§„åˆ™å¾—åˆ°ä»¥ä¸‹å››ä¸ªå¼å­ï¼š $0.1 \\times 0.1 &#x3D; 0.01$ $1 \\times 0.1 &#x3D; 0.1$ $1 \\times 0.1 &#x3D; 0.1$ $1 \\times 1 &#x3D; 1$ æœ€åŽæŠŠç»“æžœåŠ èµ·æ¥å°±æ˜¯ $0.01+0.1+0.1+1&#x3D;1.21$ æˆ‘ä»¬å¯¹å°æ•°éƒ¨åˆ†ä¸Ž0x00000000FFFFFFFFæ±‚ä¸Žï¼Œå¾—åˆ°å°æ•°éƒ¨åˆ†è¡¨ç¤ºä¸ºæ•´æ•°çš„å€¼ï¼›å¯¹æ•´æ•°éƒ¨åˆ†å³ç§» 32 ä½ï¼Œå¾—åˆ°æ­£ç¡®çš„æ•´æ•°å€¼ï¼ˆè€Œä¸æ˜¯å®šç‚¹æ•°è¡¨ç¤ºçš„æ•´æ•°å€¼ï¼‰ã€‚ å°æ•°éƒ¨åˆ†ç›¸ä¹˜çš„æƒ…å†µä¸‹ï¼Œå¾—åˆ°çš„ç»“æžœä¼šå˜æˆ 64 ä½ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å³ç§» 32 ä½ä½¿å…¶å½’ä½ã€‚ æ•´æ•°éƒ¨åˆ†ç›¸ä¹˜çš„æƒ…å†µä¸‹ï¼Œå¾—åˆ°çš„ç»“æžœå·¦ç§» 32 ä½ï¼Œä½¿å…¶å›žåˆ°å®šç‚¹æ•°è¡¨ç¤ºçš„æ•´æ•°ä½ç½®ã€‚ å°æ•°ä¸Žæ•´æ•°ç›¸ä¹˜çš„æƒ…å†µä¸‹ï¼Œä¸ä¼šä½¿å°æ•°ä½æ•°äº§ç”Ÿå˜åŒ–ï¼Œè¿›ä½çš„å€¼ä¹Ÿä¼šè‡ªåŠ¨è¿›å…¥æ•´æ•°ä½ç½®ï¼Œå› æ­¤ä¸éœ€è¦è¿›è¡Œæ“ä½œã€‚ æŽ¥ç€æˆ‘ä»¬é€ä¸ªç›¸åŠ ï¼Œæ¯æ¬¡ç›¸åŠ éƒ½åˆ¤æ–­æ˜¯å¦æœ‰æº¢å‡ºã€‚ è¿™é‡Œåˆ¤æ–­æº¢å‡ºçš„æ–¹å¼å’ŒåŠ æ³•ä¸åŒï¼Œè¿™é‡Œåªéœ€è¦åˆ¤æ–­åŒå·çš„æƒ…å†µï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»æŠŠä¸¤ä¸ªå‚æ•°è½¬ä¸ºåŒå·ï¼Œæ‰€ä»¥åªè¦åˆ¤æ–­ä¸¤ä¸ªå‚æ•°å’Œå¾—åˆ°çš„ç»“æžœæ˜¯å¦åŒå·å³å¯ã€‚ æœ€åŽæˆ‘ä»¬é€šè¿‡ä¹‹å‰åˆ¤æ–­çš„ä¸¤ä¸ªå‚æ•°æ˜¯å¦åŒå·ï¼Œå†³å®šä¹˜æ³•ç»“æžœçš„æ­£è´Ÿã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566public static FP operator *(FP x, FP y)&#123; var xl = x._value; var yl = y._value; bool opSignsEqual = ((xl ^ yl) &amp; Min_Value) == 0; if (xl &lt; 0) &#123; xl = -xl; &#125; if(yl &lt; 0) &#123; yl = -yl; &#125; var xlo = (xl &amp; 0x00000000FFFFFFFF); var xhi = xl &gt;&gt; FRACTIONAL_PLACES; var ylo = (yl &amp; 0x00000000FFFFFFFF); var yhi = yl &gt;&gt; FRACTIONAL_PLACES; //åˆ†è§£è®¡ç®—è¿‡ç¨‹ var lolo = xlo * ylo; var lohi = xlo * yhi; var hilo = xhi * ylo; var hihi = xhi * yhi; //ä¿®æ­£ä½æ•° var loResult = lolo &gt;&gt; FRACTIONAL_PLACES; var midResult1 = hilo; var midResult2 = lohi; var hiResult = hihi &lt;&lt; FRACTIONAL_PLACES; bool overflow = false; var sum = AddOverflowHelper(loResult, midResult1, ref overflow); sum = AddOverflowHelper(sum, midResult2, ref overflow); sum = AddOverflowHelper(sum, hiResult, ref overflow); if(overflow) &#123; sum = Max_Value; &#125; if (!opSignsEqual) &#123; sum = -sum; &#125; FP result; result._value = sum; return result;&#125;/// &lt;summary&gt;/// åªåœ¨åŒå·æƒ…å†µä¸‹æœ‰ç”¨ï¼Œè®¡ç®—æ˜¯å¦æº¢å‡º/// &lt;/summary&gt;/// &lt;param name=&quot;x&quot;&gt;&lt;/param&gt;/// &lt;param name=&quot;y&quot;&gt;&lt;/param&gt;/// &lt;param name=&quot;overflow&quot;&gt;&lt;/param&gt;/// &lt;returns&gt;&lt;/returns&gt;static long AddOverflowHelper(long x, long y, ref bool overflow)&#123; var sum = x + y; // x + y overflows if sign(x) ^ sign(y) != sign(sum) overflow |= ((x ^ y ^ sum) &amp; Min_Value) != 0; return sum;&#125;æˆ‘ä»¬é‡è½½é™¤æ³•è¿ç®—ç¬¦ã€‚ é™¤æ³•çš„è¿ç®—æ˜¯æ¨¡æ‹Ÿæˆ‘ä»¬æ•°å­¦ä¸Šé™¤æ³•çš„è¿‡ç¨‹ã€‚ å¦‚æžœé™¤æ•°æ˜¯ 0ï¼Œç›´æŽ¥è¿”å›žæœ€å¤§å€¼ã€‚ æˆ‘ä»¬å®šä¹‰ä½™æ•° remainderï¼Œé™¤æ•° dividerï¼Œå•† quotientï¼Œè®¡ç®—ä½æ•° bitPosã€‚ ä½™æ•°åˆå§‹åŒ–ä¸ºå‚æ•° 1ï¼Œé™¤æ•°åˆå§‹åŒ–ä¸ºå‚æ•° 2ï¼Œå•†åˆå§‹åŒ–ä¸º 0ï¼Œè®¡ç®—ä½æ•°åˆå§‹åŒ–ä¸º 33 ä½ã€‚ ç„¶åŽæˆ‘ä»¬å¼€å§‹è®¡ç®—ï¼š å…ˆåˆ¤æ–­å°æ•°éƒ¨åˆ†æœ‰æ²¡æœ‰å¤šä½™çš„ 0ï¼Œæ­¤å¤„é€‰æ‹©æ¯æ¬¡å³ç§» 4 ä½ï¼ˆ2 çš„ 4 æ¬¡å¹‚ï¼‰ï¼Œå³ä¸€ä¸ªåå…­è¿›åˆ¶ 0ã€‚è¿™æ ·å¯ä»¥å¿«é€Ÿç§»åŠ¨åˆ°æœ€å°è®¡ç®—ä½æ•°ã€‚ ç„¶åŽæˆ‘ä»¬å¼€å§‹å¾ªçŽ¯ï¼Œå¦‚æžœæœ‰ä½™æ•°å¹¶ä¸”è®¡ç®—ä½æ•°å¤§äºŽç­‰äºŽ 0 çš„æƒ…å†µï¼Œæˆ‘ä»¬å°±è¿›è¡Œä¸€æ¬¡é™¤æ³•ã€‚ æˆ‘ä»¬å…ˆèŽ·å¾—ä½™æ•°å‰å¯¼é›¶ä¸ªæ•°ï¼Œç„¶åŽå’Œéœ€è¦è®¡ç®—çš„ä½æ•°è¿›è¡Œæ¯”è¾ƒï¼Œé˜²æ­¢æº¢å‡ºã€‚ ç„¶åŽæˆ‘ä»¬å·¦ç§»ä½™æ•°ï¼Œè¿™ä¸€æ­¥æ˜¯ä¸ºäº†é˜²æ­¢åœ¨å¾ªçŽ¯çš„è¿‡ç¨‹ä¸­ä½™æ•°ä¸å¤Ÿä½æ•°å‚ä¸Žè¿ç®—ã€‚åŒæ—¶æˆ‘ä»¬å‰©ä½™çš„è®¡ç®—ä½æ•°è¦å‡åŽ»å·¦ç§»çš„ä½æ•°ã€‚ æŽ¥ç€æˆ‘ä»¬æ±‚å•†å’Œä½™æ•°ï¼Œæ–°çš„ä½™æ•°èµ‹å€¼ç»™åŽŸæ¥çš„ä½™æ•°ï¼Œå•†æ ¹æ®å·¦ç§»ä½æ•°åŒæ ·ç§»åŠ¨å¹¶ä¸”åŠ åˆ°æ€»å•†ä¸Šã€‚ åˆ¤æ–­ç»“æžœæœ‰æ²¡æœ‰æº¢å‡ºã€‚ ä½™æ•°è¿›ä½ï¼Œç»§ç»­å¾ªçŽ¯ã€‚ å•† +1 å¹¶å³ç§»ä¸€ä½ï¼Œè¿›è¡Œèˆå…¥ã€‚ æœ€åŽåˆ¤æ–­æ˜¯å¦å¼‚å·ï¼Œæ˜¯çš„è¯ç¬¦å·ä½å°±å–åã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182public static FP operator /(FP x, FP y)&#123; var xl = x._value; var yl = y._value; if (yl == 0) &#123; return Max_Value; //throw new DivideByZeroException(); &#125; var remainder = (ulong)(xl &gt;= 0 ? xl : -xl); var divider = (ulong)(yl &gt;= 0 ? yl : -yl); var quotient = 0UL; var bitPos = Num_Bit / 2 + 1; //åŠ é€Ÿé™¤æ³•ï¼Œå‡å°‘å°æ•°éƒ¨åˆ†å¤šä½™çš„0æ•°é‡ // If the divider is divisible by 2^n, take advantage of it. while ((divider &amp; 0xF) == 0 &amp;&amp; bitPos &gt;= 4) &#123; divider &gt;&gt;= 4; bitPos -= 4; &#125; //é™¤æ³•è®¡ç®— while (remainder != 0 &amp;&amp; bitPos &gt;= 0) &#123; //è®¡ç®—è¢«é™¤æ•°å‰å¯¼é›¶æ•°é‡ int shift = CountLeadingZeroes(remainder); if (shift &gt; bitPos) &#123; shift = bitPos; &#125; //ç§»åŠ¨è¢«é™¤æ•°åˆ°å…è®¸çš„æœ€é«˜ä½ remainder &lt;&lt;= shift; bitPos -= shift; //æ±‚å•†å’Œä½™æ•° var div = remainder / divider; remainder = remainder % divider; //æŠŠå•†åŠ åˆ°æ€»å•†ä¸­ quotient += div &lt;&lt; bitPos; // Detect overflow //0xFFFFFFFFFFFFFFFF &gt;&gt; bitPoså¾—åˆ°64-bitPosä¸ª1 //å–åå¾—åˆ°11100....ï¼ˆ64-bitPosä¸ª0ï¼‰ //å¦‚æžœç»“æžœä¸ä¸º0ï¼Œè¯´æ˜Žè¶…å‡ºæœ€å¤§ä½æ•°ï¼Œæº¢å‡º if ((div &amp; ~(0xFFFFFFFFFFFFFFFF &gt;&gt; bitPos)) != 0) &#123; return ((xl ^ yl) &amp; Min_Value) == 0 ? MaxValue : MinValue; &#125; //å‰è¿›ä¸€ä½ remainder &lt;&lt;= 1; --bitPos; &#125; // rounding ++quotient; var result = (long)(quotient &gt;&gt; 1); if (((xl ^ yl) &amp; Min_Value) != 0) &#123; result = -result; &#125; FP r; r._value = result; return r; //return new FP(result);&#125;/// &lt;summary&gt;/// æ±‚å‰å¯¼0ä¸ªæ•°/// &lt;/summary&gt;/// &lt;param name=&quot;x&quot;&gt;&lt;/param&gt;/// &lt;returns&gt;&lt;/returns&gt;public static int CountLeadingZeroes(ulong x)&#123; int result = 0; //å¦‚æžœæœ€é«˜å››ä½ï¼ˆäºŒè¿›åˆ¶ï¼‰éƒ½ä¸º0ï¼Œåˆ™å·¦ç§»å››ä½ï¼ŒåŠ é€Ÿè®¡ç®— while ((x &amp; 0xF000000000000000) == 0) &#123; result += 4; x &lt;&lt;= 4; &#125; //å¦‚æžœæœ€é«˜ä¸€ä½ï¼ˆäºŒè¿›åˆ¶ï¼‰ä¸º0ï¼Œåˆ™å·¦ç§»ä¸€ä½ while ((x &amp; 0x8000000000000000) == 0) &#123; result += 1; x &lt;&lt;= 1; &#125; return result;&#125;æˆ‘ä»¬é‡è½½æ±‚ä½™è¿ç®—ç¬¦ã€‚ æ±‚ä½™åªå¢žåŠ ä¸€ç§æƒ…å†µåˆ¤å®šï¼Œé˜²æ­¢æº¢å‡ºï¼Œå…¶ä»–å’ŒåŽŸæœ¬çš„æ±‚ä½™ä¸€æ ·ã€‚ 12345678910public static FP operator %(FP x, FP y)&#123; FP result; // åˆ¤æ–­æ˜¯å¦ä¸ºç‰¹æ®Šæƒ…å†µï¼šè¢«é™¤æ•°æ˜¯æœ€å°è´Ÿæ•°ä¸”é™¤æ•°æ˜¯-1 // è¿™ç§æƒ…å†µä¸‹æ•´æ•°æº¢å‡ºä¼šå¯¼è‡´ç»“æžœä¸º0 result._value = x._value == Min_Value &amp; y._value == -1 ? 0 : x._value % y._value; return result;&#125;1234567891011121314151617181920212223242526272829303132333435public static FP operator -(FP x)&#123; //è´Ÿæ•°æ¯”æ­£æ•°å¤šè¡¨ç¤ºä¸€ä½ï¼Œå› æ­¤æ­£æ•°å¯ä»¥ç›´æŽ¥è½¬ä¸ºè´Ÿæ•°ï¼Œè€Œæœ€å°è´Ÿæ•°ä¸èƒ½ç›´æŽ¥è½¬ä¸ºæ­£æ•°ï¼Œè€Œæ˜¯è½¬ä¸ºæœ€å¤§æ­£å€¼ return x._value == Min_Value ? MaxValue : new FP(-x._value);&#125;public static bool operator ==(FP x, FP y)&#123; return x._value == y._value;&#125;public static bool operator !=(FP x, FP y)&#123; return x._value != y._value;&#125;public static bool operator &gt;(FP x, FP y)&#123; return x._value &gt; y._value;&#125;public static bool operator &lt;(FP x, FP y)&#123; return x._value &lt; y._value;&#125;public static bool operator &gt;=(FP x, FP y)&#123; return x._value &gt;= y._value;&#125;public static bool operator &lt;=(FP x, FP y)&#123; return x._value &lt;= y._value;&#125; æ›´æ–°æ—¥å¿—2024-01-28 è¡¥ä¸Šå¼•ç”¨å†…å®¹ 2024-01-28 æ›´æ–°åŸºç¡€å†…å®¹ã€‚","categories":[{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/categories/Unity/"},{"name":"è§£å†³æ–¹æ¡ˆ","slug":"Unity/è§£å†³æ–¹æ¡ˆ","permalink":"https://busyogg.github.io/categories/Unity/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"}],"tags":[{"name":"C#","slug":"C","permalink":"https://busyogg.github.io/tags/C/"},{"name":"å®šç‚¹æ•°","slug":"å®šç‚¹æ•°","permalink":"https://busyogg.github.io/tags/%E5%AE%9A%E7%82%B9%E6%95%B0/"},{"name":"ç¡®å®šæ€§","slug":"ç¡®å®šæ€§","permalink":"https://busyogg.github.io/tags/%E7%A1%AE%E5%AE%9A%E6%80%A7/"}]},{"title":"é€»è¾‘ä¸Žæ¸²æŸ“åˆ†ç¦»","slug":"é€»è¾‘ä¸Žæ¸²æŸ“åˆ†ç¦»","date":"2024-01-22T18:00:49.000Z","updated":"2024-05-30T12:25:41.849Z","comments":true,"path":"article/ce948424ad1b/","link":"","permalink":"https://busyogg.github.io/article/ce948424ad1b/","excerpt":"","text":"ç®€ä»‹é€»è¾‘ä¸Žæ¸²æŸ“åˆ†ç¦»ï¼Œå³é€»è¾‘è¿ç®—ä¸ºä¸€ä¸ªéƒ¨åˆ†ï¼Œæ¸²æŸ“è¡¨çŽ°ä¸ºä¸€ä¸ªéƒ¨åˆ†ã€‚æ¸²æŸ“è¡¨çŽ°ä¾èµ–äºŽé€»è¾‘è¿ç®—çš„ç»“æžœï¼Œä½†é€»è¾‘è¿ç®—ä¸ä¼šå—åˆ°æ¸²æŸ“è¡¨çŽ°çš„å½±å“ã€‚ å› æ­¤ï¼Œé€»è¾‘ä¸Žæ¸²æŸ“å¯ä»¥èŽ·å¾—ä¸åŒçš„æ›´æ–°é¢‘çŽ‡ï¼Œé€šå¸¸æ˜¯é€»è¾‘è®¡ç®—çš„é¢‘çŽ‡è¦ä½ŽäºŽæ¸²æŸ“ï¼Œè¿™æ ·å¯ä»¥å‡å°‘å¤æ‚é€»è¾‘çš„æ€§èƒ½å¼€é”€ã€‚ æ¸²æŸ“è¡¨çŽ°åœ¨æ¯ä¸¤ä¸ªé€»è¾‘å¸§ä¹‹é—´è¿›è¡Œæ’å€¼ï¼Œè¿™æ ·å°±èƒ½ä½¿ç”»é¢å¹³æ»‘ï¼Œä¸ä¼šå› ä¸ºä½Žé¢‘é€»è¾‘æ›´æ–°è€Œäº§ç”Ÿé¡¿æ„Ÿã€‚ å®žçŽ°å¦‚æžœé¡¹ç›®ç»“æž„æ˜¯é¢å‘å¯¹è±¡çš„è¯ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨äº‹ä»¶æ¥é€šçŸ¥æ¸²æŸ“å¯¹è±¡æ›´æ–°æ•°æ®å¹¶æ’å€¼ï¼Œæˆ–è€…æ¸²æŸ“å¯¹è±¡æŒæœ‰é€»è¾‘å¯¹è±¡ï¼Œåœ¨æ›´æ–°çš„æ—¶å€™èŽ·å–å¯¹åº”æ•°æ®ã€‚ æœ¬ä¾‹ä½¿ç”¨çš„æ˜¯ ECS çš„ç»“æž„ï¼Œå› æ­¤åªéœ€è¦åœ¨æ¸²æŸ“ç³»ç»Ÿå†™å¥½æ’å€¼é€»è¾‘ï¼Œç³»ç»Ÿè‡ªç„¶ä¼šéåŽ†æ›´æ–°ã€‚ å¦‚æžœç›®æ ‡ä½ç½®æˆ–æ—‹è½¬æœ‰æ›´æ–°ï¼Œç›´æŽ¥é‡ç½®ä¸Šä¸€ä½ç½®å’Œæ—‹è½¬ä¸ºå½“å‰æ¸²æŸ“å¯¹è±¡çš„åæ ‡å’Œæ—‹è½¬ï¼Œå¹¶é‡ç½®æ’å€¼è¿›åº¦ä¸º 0ã€‚ æ›´æ–°æ’å€¼è¿›åº¦ã€‚ æ ¹æ®ä¸Šä¸€ä½ç½®æˆ–ä¸Šä¸€æ—‹è½¬å’Œç›®æ ‡ä½ç½®æˆ–ç›®æ ‡æ—‹è½¬ï¼Œè¿›è¡Œ lerp æ’å€¼ï¼Œç„¶åŽèµ‹å€¼ç»™æ¸²æŸ“å¯¹è±¡ã€‚ å¦‚æžœæ’å€¼è¿›åº¦å®Œæˆï¼Œåˆ™é‡ç½®ä¸Šä¸€ä½ç½®å’Œæ—‹è½¬ä¸ºå½“å‰æ¸²æŸ“å¯¹è±¡çš„åæ ‡å’Œæ—‹è½¬ï¼Œå¹¶é‡ç½®æ’å€¼è¿›åº¦ä¸º 0ã€‚ å¦‚æžœæœ‰ç¼©æ”¾éœ€æ±‚çš„ä¹Ÿå¯ä»¥åŒç†æ“ä½œã€‚ ä¸Šå›¾ç™½è‰²çº¿æ¡†ä¸ºé€»è¾‘åŒ…å›´ç›’ä½ç½®ï¼Œå¯ä»¥çœ‹å‡ºé€»è¾‘æ›´æ–°é¢‘çŽ‡ä½Žçš„æƒ…å†µä¸‹æœ‰é¡¿æ„Ÿï¼Œæ¸²æŸ“å¯¹è±¡çš„æ–¹å—è¿½é€é€»è¾‘ä½ç½®æ’å€¼é è¿‘ã€‚ æ›´æ–°æ—¥å¿—2024-01-23 æ›´æ–°åŸºç¡€å†…å®¹ã€‚","categories":[{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/categories/Unity/"},{"name":"è§£å†³æ–¹æ¡ˆ","slug":"Unity/è§£å†³æ–¹æ¡ˆ","permalink":"https://busyogg.github.io/categories/Unity/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"}],"tags":[{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/tags/Unity/"},{"name":"è§£å†³æ–¹æ¡ˆ","slug":"è§£å†³æ–¹æ¡ˆ","permalink":"https://busyogg.github.io/tags/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"},{"name":"æ¸²æŸ“","slug":"æ¸²æŸ“","permalink":"https://busyogg.github.io/tags/%E6%B8%B2%E6%9F%93/"}]},{"title":"ç‰©ç†å¼•æ“Ž Demo æ€è·¯","slug":"ç‰©ç†å¼•æ“ŽDemoæ€è·¯","date":"2024-01-21T20:08:06.000Z","updated":"2024-05-30T12:27:11.723Z","comments":true,"path":"article/b83ee5a642c0/","link":"","permalink":"https://busyogg.github.io/article/b83ee5a642c0/","excerpt":"","text":"ç§»åŠ¨ç§»åŠ¨çš„æ—¶å€™åªéœ€è¦ä»¥å¯¹è±¡åæ ‡ä¸ºåŸºç¡€ï¼ŒåŠ ä¸Šç§»åŠ¨çš„æ–¹å‘å’Œé€Ÿåº¦ï¼Œå³å¯å¾—åˆ°ä¸‹ä¸€ä¸ªåæ ‡ã€‚ ç¢°æ’žåœ¨ä¸€å¸§ç§»åŠ¨å®ŒæˆåŽï¼Œæ£€æµ‹æœ€æ–°ä½ç½®æ˜¯å¦æœ‰å’Œå…¶ä»–ç‰©ä½“ç¢°æ’žï¼Œå¦‚æžœæœ‰çš„è¯ï¼š è®¡ç®—ç¢°æ’žæ³•çº¿ï¼Œç¢°æ’žæ³•çº¿æ˜¯å…¶ä»–ç‰©ä½“è¢«ç¢°æ’žçš„é¢çš„æ³•çº¿ã€‚ è®¡ç®—ç¢°æ’žæ·±åº¦ã€‚ å½“å‰ä½ç½® +&#x3D; ç¢°æ’žæ³•çº¿ * ç¢°æ’žæ·±åº¦ã€‚ è¿™æ ·å°±å¯ä»¥å¾—åˆ°ç¢°æ’žåŽåº”è¯¥åœ¨çš„ä½ç½®ã€‚æˆ‘ç§°ä¹‹ä¸ºæŽ’æ–¥ã€‚ å¤šä¸ªç¢°æ’žä½“çš„æƒ…å†µè®¾ç½®ä¸€ä¸ªå‘é‡ offset ç”¨æ¥è®°å½•æŽ’æ–¥çš„å€¼ï¼Œæ¯ä¸ªç¢°æ’žç‰©ä½“çš„æŽ’æ–¥å€¼éƒ½è¦åŠ åˆ° offset ä¸­ã€‚æœ€åŽæˆ‘ä»¬ä¼šå¾—åˆ°ä¸€ä¸ªæ€»çš„æŽ’æ–¥å€¼ï¼ŒåŠ åˆ°å½“å‰ä½ç½®ä¸­å³å¯ã€‚ å½“ä¸¤ä¸ªç¢°æ’žç‰©ä½“æŽ’æˆä¸€æŽ’æ—¶ï¼Œä¼šå‡ºçŽ°æ— æ³•è¶Šè¿‡äº¤ç•Œå¤„çš„æƒ…å†µã€‚ å› æ­¤æˆ‘é€‰æ‹©æ¯æ¬¡æŽ’æ–¥éƒ½æ›´æ–°ä¸€ä¸‹è‡ªä½“ç¢°æ’žç›’ã€‚è¿™æ ·å°±èƒ½ä¿è¯ç¢°æ’žæ³•çº¿çš„æ–¹å‘ç›¸åŒã€‚ä¸è¿‡æ¯æ¬¡åˆ·æ–°åŒ…å›´ç›’çš„æ—¶å€™éƒ½ä¼šé‡æ–°è®¡ç®—åŒ…å›´ç›’ä¿¡æ¯ï¼Œå¢žåŠ äº†è®¡ç®—é‡ã€‚ ä¸è¿‡è¿™æ ·ä¼šå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¦‚æžœç¢°æ’žçš„é¡ºåºä¸åŒçš„è¯ï¼Œå¾—åˆ°çš„ç»“æžœä¹Ÿä¸åŒï¼Œå› æ­¤æˆ‘é€‰æ‹©ä¿å­˜æŽ¥è§¦åˆ°çš„ç¢°æ’žå¯¹è±¡ï¼Œæ¯æ¬¡ç¢°æ’žæ£€æµ‹çš„æ—¶å€™æ£€æµ‹ä¸Šæ¬¡çš„ç¢°æ’žç‰©ä½“æ˜¯å¦å­˜åœ¨äºŽåˆ—è¡¨ä¸­ï¼Œå­˜åœ¨åˆ™ä¸åŠ¨ï¼Œä¸å­˜åœ¨åˆ™æ–°å¢žåˆ°åˆ—è¡¨åŽé¢ï¼Œæ²¡ç¢°æ’žçš„ç‰©ä½“ç§»é™¤åˆ—è¡¨ã€‚è¿™æ ·å°±èƒ½ä¿è¯æ¯æ¬¡ç¢°æ’žçš„é¡ºåºæ˜¯æŒ‰ç…§æŽ¥è§¦åˆ°çš„ç‰©ä½“é¡ºåºï¼Œè€Œä¸æ˜¯éåŽ†çš„é¡ºåºã€‚ ä¸‹è½æˆ‘é€‰æ‹©çš„æ˜¯æ ¹æ®ä¸‹è½çš„å…¬å¼ $v_g&#x3D;-gt$ å¾—åˆ°ä¸‹è½é€Ÿåº¦ï¼Œä¹˜ä»¥æ¯å¸§æ—¶é—´ $v_{g_{dt}}&#x3D;v_g*dt$ å¾—åˆ°æ¯å¸§çš„ä¸‹è½é€Ÿåº¦ï¼Œå†åŠ åˆ°å½“å‰åæ ‡çš„ y å€¼ä¸Šå³å¯ã€‚ è·³è·ƒè·³è·ƒæ˜¯åœ¨ä¸‹è½çš„åŸºç¡€ä¸Šï¼Œå¢žåŠ ä¸€ä¸ªåˆå§‹é€Ÿåº¦ï¼Œé€šè¿‡å…¬å¼ $v&#x3D;v_0-v_g$ å¾—åˆ°ä¸‹è½é€Ÿåº¦ï¼Œç„¶åŽè·Ÿä¸Šé¢ä¸‹è½ä¸€æ ·å¤„ç†å¾—åˆ°æ–°çš„ y å€¼ã€‚ çˆ¬å¡åœ¨çˆ¬å¡çš„æ—¶å€™ï¼Œæˆ‘æ ¹æ®å¡é¢çš„æ³•çº¿æ–¹å‘å’Œè‡ªä½“çš„ä¸Šæ–¹å‘ï¼Œå¾—åˆ°ä¸€ä¸ªæ—‹è½¬çš„å››å…ƒæ•°ï¼Œç„¶åŽç”¨è¯¥å››å…ƒæ•°ä¹˜ä»¥å‰è¿›æ–¹å‘ï¼Œä½¿å‰è¿›æ–¹å‘æ—‹è½¬åˆ°å¡é¢ï¼Œè¿™æ ·åœ¨å¡é¢çš„ç§»åŠ¨å°±ç›¸å½“äºŽæŠŠåŽŸæ¥çš„åæ ‡ç³»è½¬ç§»åˆ°å¡é¢çš„åæ ‡ç³»ä¸­ï¼Œå†åœ¨å¡é¢åæ ‡ç³»å®žçŽ°ä½ç§»ã€‚ ç”¨ä¸€ä¸ªå¹³é¢å›¾æ¥è¡¨ç¤ºçš„è¯å°±åƒä¸‹å›¾æ‰€ç¤ºï¼š æŽ¨å¹¿åˆ°ä¸‰ç»´ç©ºé—´ä¹Ÿæ˜¯ä¸€æ ·ã€‚ åˆ¤æ–­æ˜¯å¦åœ¨å¹³å°ä¸Šè·³è·ƒå’Œå¡é¢éƒ½éœ€è¦åˆ¤æ–­æ˜¯å¦åœ¨å¹³å°ä¸Šï¼Œåœ¨å¹³å°ä¸Šçš„è¯å°±åœæ­¢ä¸‹è½å¹¶é‡ç½®çŠ¶æ€ã€‚ åˆ¤æ–­æ˜¯å¦åœ¨é¡¶éƒ¨ï¼Œå°±åˆ¤æ–­è‡ªä½“æœ€ä½Žç‚¹æ˜¯å¦å¤§äºŽç­‰äºŽç¢°æ’žç‰©ä½“æœ€é«˜ç‚¹ï¼›åˆ¤æ–­æ˜¯ä¼šå¦åœ¨å¡é¢ï¼Œå°±åˆ¤æ–­ç§»åŠ¨æ–¹å‘å’Œè‡ªä½“ä¸‹æ–¹å‘çš„æŠ•å½±çš„ç»å¯¹å€¼æ˜¯å¦å¤§äºŽ 0 å¹¶å°äºŽè‡ªå®šä¹‰çš„å¡åº¦ï¼ˆ0-1 ä¹‹é—´ï¼‰ã€‚ è·¨å°é˜¶è·¨å°é˜¶å°±æ˜¯åœ¨åšæŽ’æ–¥çš„æ—¶å€™ï¼Œåˆ¤æ–­è‡ªä½“æœ€ä½Žç‚¹æ˜¯å¦å°äºŽç¢°æ’žç‰©ä½“æœ€é«˜ç‚¹ï¼Œå¹¶ä¸”è‡ªä½“æœ€ä½Žç‚¹åŠ ä¸Šè‡ªå®šä¹‰è·¨è¶Šé«˜åº¦æ˜¯å¦å¤§äºŽç¢°æ’žç‰©ä½“æœ€é«˜ç‚¹ï¼Œéƒ½æ»¡è¶³çš„æƒ…å†µä¸‹ä»¤æŽ’æ–¥å€¼çš„ y å€¼ç­‰äºŽç¢°æ’žç‰©ä½“æœ€é«˜ç‚¹å‡åŽ»è‡ªä½“æœ€ä½Žç‚¹ï¼Œå³ï¼š 1234if (self.minY &lt; other.maxY &amp;&amp; self.minY + self.stepHeight &gt;= other.maxY)&#123; offset.y = other.maxY - self.minY;&#125; å¦åˆ™å°±æŒ‰ç…§æ­£å¸¸çš„æŽ’æ–¥è®¡ç®—ã€‚ æ”€çˆ¬æ”€çˆ¬åˆ¤å®šå‘ç”Ÿç¢°æ’žå¹¶ä¸”ç§»åŠ¨æ–¹å‘å’Œç¢°æ’žæ³•çº¿çš„æŠ•å½±å°äºŽä¸€å®šå€¼ï¼ˆè‡ªå®šä¹‰ï¼‰è¶…è¿‡ä¸€å®šæ—¶é—´çš„æ—¶å€™åˆ¤å®šä¸ºå¼€å§‹æ”€çˆ¬ã€‚ å¤´é¡¶æœ‰éšœç¢ç‰©çš„æ—¶å€™å–æ¶ˆæ”€çˆ¬ã€‚ï¼ˆæ”€çˆ¬é¢æ³•çº¿ y å€¼å°äºŽä¸€å®šå€¼ä¸ºå¤´é¡¶æœ‰éšœç¢ç‰©ï¼‰ æ”€çˆ¬è®¡ç®—æ”€çˆ¬å’Œçˆ¬å¡ä¸€æ ·éœ€è¦æŠŠåæ ‡ç³»è½¬ç§»åˆ°æ”€çˆ¬å¹³é¢ä¸Šã€‚ ä»¤åŽŸå§‹è¾“å…¥æ–¹å‘ï¼ˆå³è¾“å…¥å€¼ ADWSï¼‰é¢å‘æ”€çˆ¬å¹³é¢æ³•çº¿çš„åæ–¹å‘ï¼Œå¾—åˆ°é¢å‘è¾“å…¥æ–¹å‘ã€‚ è®¡ç®—è‡ªä½“ä¸Šæ–¹å‘å’Œæ”€çˆ¬å¹³é¢æ³•çº¿çš„æ—‹è½¬å››å…ƒæ•°ã€‚ æ—‹è½¬å››å…ƒæ•°ä¹˜ä»¥é¢å‘è¾“å…¥æ–¹å‘å¾—åˆ°æœ€ç»ˆæ”€çˆ¬æ–¹å‘ã€‚ï¼ˆå’Œçˆ¬å¡ä¸€æ ·çš„æ“ä½œï¼‰ æ”€çˆ¬ä¸Žçˆ¬å¡ä¸åŒçš„æ˜¯ï¼Œçˆ¬å¡ç”¨çš„æ˜¯è‡ªä½“çš„ç§»åŠ¨æ–¹å‘åšåŽŸå§‹è¾“å…¥ï¼Œæ”€çˆ¬ç”¨çš„æ˜¯é”®ç›˜è¾“å…¥çš„ç§»åŠ¨æ–¹å‘åšåŽŸå§‹è¾“å…¥ã€‚ æ”€çˆ¬çš„æ—¶å€™éœ€è¦å•ç‹¬è®¡ç®—æŽ’æ–¥ï¼Œä½¿å…¶åˆšå¥½å¤„äºŽç¢°æ’žç‰©ä½“è¡¨é¢ã€‚å¹¶ä¸”ï¼Œç¢°æ’žç‰©ä½“çš„æœ€è¿‘ä¸­å¿ƒåæ ‡åœ¨ä¸ç¢°æ’žçš„æ—¶å€™ä¸æ¸…é™¤ï¼Œè¿™æ ·å°±å¯ä»¥æ‹å¼¯ã€‚ è‡ªåŠ¨æ”€çˆ¬åˆ°é¡¶åˆ¤æ–­è‡ªä½“æœ€é«˜ç‚¹æ˜¯å¦å¤§äºŽç¢°æ’žç‰©ä½“æœ€é«˜ç‚¹ä¸€å®šå€¼ï¼Œæ˜¯åˆ™å¼€å§‹è‡ªåŠ¨æ”€çˆ¬å¹¶ç¦ç”¨æ”€çˆ¬ç§»åŠ¨ã€‚ æ”€çˆ¬è·³è·ƒé»˜è®¤æƒ…å†µä¸‹å‘ä¸Šè·³è·ƒï¼Œæœ‰æŒ‰æ–¹å‘çš„æƒ…å†µä¸‹æŒ‰ç…§æ‰€æŒ‰æ–¹å‘è·³è·ƒã€‚ å’Œæ”€çˆ¬åˆ°é¡¶ä¸€æ ·ï¼Œæ”€çˆ¬è·³è·ƒä¹Ÿç¦ç”¨æ”€çˆ¬ï¼Œç„¶åŽè‡ªåŠ¨è¿›è¡Œæ•°å¸§çš„ä½ç§»ã€‚å®ŒæˆåŽé‡å¯æ”€çˆ¬ã€‚ æŽ¨ç‰©ä½“è®¾ç½®ç‰©ä½“çš„æŽ¨åŠ›å’Œè¢«æŽ¨æ—¶éœ€è¦çš„åŠ›ï¼Œç„¶åŽæ ¹æ®æ¯”ä¾‹ï¼Œåœ¨ç¢°æ’žæ£€æµ‹æŽ’æ–¥çš„æ—¶å€™è¿›è¡Œæ¯”è¾ƒã€‚ è®¾æŽ¨åŠ›æ¯”ä¾‹ä¸º powerRatio è®¡ç®— $powerRatio&#x3D;å¦ä¸€ç‰©ä½“è¢«æŽ¨åŠ›&#x2F;æœ¬ç‰©ä½“æŽ¨åŠ›$ ï¼Œç„¶åŽå°†å¾—åˆ°çš„æ•°å­—ä¹˜åˆ°æŽ’æ–¥åŠ›ä¸Šï¼Œå³ $offset*&#x3D;powerRatio$ ï¼Œå³å¯å¾—åˆ°æ–°çš„æŽ’æ–¥åŠ›å¤§å°ã€‚ åœ¨è®¡ç®—æŽ’æ–¥åŠ›å¤§å°ä¹‹å‰ï¼Œéœ€è¦å…ˆè®¡ç®—å¦ä¸€ç‰©ä½“éœ€è¦ç§»åŠ¨çš„è·ç¦»ã€‚ è®¾å¦ä¸€ç‰©ä½“çš„æŽ’æ–¥åŠ›ä¸º reverseOffset æ ¹æ®ä»¥ä¸‹å…¬å¼ï¼š $reverseOffset&#x3D;offset*(1-powerRatio)$ æŠŠæ‰€æœ‰ reverseOffset éƒ½åŠ åˆ°å¦ä¸€ç‰©ä½“çš„ offsetï¼Œæˆ‘ä»¬å°±èƒ½å¾—åˆ°å¦ä¸€ç‰©ä½“ç§»åŠ¨çš„è·ç¦»ã€‚ æ›´æ–°æ—¥å¿—2024-03-01 1.æ›´æ–°æŽ¨ç‰©ä½“æ€è·¯ 2024-01-22 æ›´æ–°åŸºç¡€å†…å®¹ç§»åŠ¨ç¢°æ’žä¸‹è½è·³è·ƒçˆ¬å¡åˆ¤å®šå¹³å°è·¨å°é˜¶æ”€çˆ¬","categories":[{"name":"è®¾è®¡æ€è·¯","slug":"è®¾è®¡æ€è·¯","permalink":"https://busyogg.github.io/categories/%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/"}],"tags":[{"name":"ç‰©ç†","slug":"ç‰©ç†","permalink":"https://busyogg.github.io/tags/%E7%89%A9%E7%90%86/"}]},{"title":"ç”¨è‡ªå·±ä¹°çš„æœåŠ¡å™¨è¿›è¡Œå†…ç½‘ç©¿é€","slug":"ç”¨è‡ªå·±ä¹°çš„æœåŠ¡å™¨è¿›è¡Œå†…ç½‘ç©¿é€","date":"2024-01-20T17:07:09.000Z","updated":"2024-05-30T12:27:21.412Z","comments":true,"path":"article/90abd34fc86f/","link":"","permalink":"https://busyogg.github.io/article/90abd34fc86f/","excerpt":"","text":"ç®€ä»‹å¤§éƒ¨åˆ†æ—¶å€™æˆ‘ä»¬è‡ªå·±ç½‘ç»œçš„ IP æ˜¯å†…ç½‘ IPï¼Œåˆæƒ³è¦åˆ«äººèƒ½å¤Ÿé€šè¿‡å¤–ç½‘æ¥è®¿é—®æˆ‘ä»¬ç”µè„‘é‡Œçš„é¡¹ç›®ï¼Œè¿™æ—¶å€™å°±éœ€è¦å†…ç½‘ç©¿é€ã€‚ é™¤äº†èŠ±ç”Ÿå£³ç­‰ç¬¬ä¸‰æ–¹ä»¥å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç”¨è‡ªå·±ä¹°çš„æœåŠ¡å™¨çš„å…¬ç½‘ IP æ¥è¿›è¡Œå†…ç½‘ç©¿é€ã€‚ å½“ç„¶ï¼Œå¦‚æžœä½ æ¡ä»¶å…è®¸çš„è¯ï¼Œç›´æŽ¥ç”¨é«˜é…çš„æœåŠ¡å™¨å°±å¥½ã€‚æ­¤å¤„çš„é€‚ç”¨åœºæ™¯ä¸ºæœåŠ¡å™¨é…ç½®ä¸è¶³ï¼Œè‡ªå·±ç”µè„‘é…ç½®è¶³å¤Ÿçš„æƒ…å†µä¸‹ï¼Œé€šè¿‡æœåŠ¡å™¨è½¬å‘è®¿é—®åˆ°æˆ‘ä»¬è‡ªå·±çš„ç”µè„‘ã€‚ æ–¹æ³•æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¼€æºé¡¹ç›® FRP æ¥å®žçŽ°ã€‚ é¦–å…ˆæˆ‘ä»¬ä¸‹è½½ release ä¸­å¯¹åº”å¹³å°çš„æ–‡ä»¶ã€‚ å…¶æ¬¡æˆ‘ä»¬åœ¨æœåŠ¡ç«¯éƒ¨ç½² frps ç›¸å…³çš„æ‰€æœ‰æ–‡ä»¶åˆ°ä»»æ„ç›®å½•ã€‚ç„¶åŽä¿®æ”¹é…ç½®æ–‡ä»¶ï¼ˆä¹Ÿå¯ä»¥é»˜è®¤ä¸ä¿®æ”¹ï¼Œé»˜è®¤ç«¯å£ä¸º 7000ï¼‰ã€‚ç„¶åŽé€šè¿‡ ./frps -c ./frps.toml å‘½ä»¤æ¥å¯åŠ¨æœåŠ¡ã€‚ æŽ¥ä¸‹æ¥æˆ‘ä»¬åœ¨å®¢æˆ·ç«¯éƒ¨ç½² frpc ç›¸å…³çš„æ‰€æœ‰æ–‡ä»¶åˆ°ä»»æ„ç›®å½•ã€‚ç„¶åŽæŒ‰ç…§ä¸‹é¢çš„è¦æ±‚ä¿®æ”¹é…ç½®æ–‡ä»¶ã€‚æœ€åŽé€šè¿‡ ./frpc -c ./frpc.toml å‘½ä»¤æ¥å¯åŠ¨æœåŠ¡ã€‚ 1234567891011serverAddr = &quot;x.x.x.x&quot; //æœåŠ¡å™¨ipserverPort = 7000 //æœåŠ¡ç«¯ç«¯å£ï¼Œå’Œfrpsé…ç½®çš„ä¸€è‡´# å¦‚æžœé»˜è®¤çš„ STUN æœåŠ¡å™¨ä¸å¯ç”¨ï¼Œå¯ä»¥é…ç½®ä¸€ä¸ªæ–°çš„ STUN æœåŠ¡å™¨# natHoleStunServer = &quot;xxx&quot;[[proxies]]name = &quot;test-tcp&quot; //éšä¾¿å†™type = &quot;tcp&quot; //åè®®localIP = &quot;127.0.0.1&quot; //æœ¬åœ°æœåŠ¡iplocalPort = 22 //æœ¬åœ°æœåŠ¡ç«¯å£remotePort = 6000 //è®¿é—®æ—¶ä½¿ç”¨çš„ç«¯å£ æ›´å¤šé…ç½®è¯·å‰å¾€ å®˜æ–¹æ–‡æ¡£ æŸ¥çœ‹ã€‚ åªè¦æœåŠ¡ç«¯å‡ºçŽ° frps started successfullyï¼Œæœ¬åœ°å‡ºçŽ° start proxy success å­—æ ·å°±ç©¿é€æˆåŠŸäº†ã€‚ æŽ¥ä¸‹æ¥åªè¦ä½¿ç”¨ x.x.x.x:6000 å°±èƒ½è®¿é—®åˆ°å†…ç½‘çš„æœåŠ¡äº†ã€‚ æ›´æ–°æ—¥å¿—2024-01-21 1.æ›´æ–°åŸºæœ¬å†…å®¹ã€‚","categories":[{"name":"åˆ†äº«","slug":"åˆ†äº«","permalink":"https://busyogg.github.io/categories/%E5%88%86%E4%BA%AB/"}],"tags":[{"name":"å†…ç½‘ç©¿é€","slug":"å†…ç½‘ç©¿é€","permalink":"https://busyogg.github.io/tags/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/"},{"name":"æœåŠ¡å™¨","slug":"æœåŠ¡å™¨","permalink":"https://busyogg.github.io/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8/"},{"name":"FRP","slug":"FRP","permalink":"https://busyogg.github.io/tags/FRP/"}]},{"title":"ChatGPTè®¿é—®æ–¹æ³•","slug":"ChatGPTè®¿é—®æ–¹æ³•","date":"2023-12-15T15:49:03.000Z","updated":"2024-05-18T15:38:09.617Z","comments":true,"path":"article/0adcafccba95/","link":"","permalink":"https://busyogg.github.io/article/0adcafccba95/","excerpt":"","text":"è®¾ç½®ä»£ç†åœ°å€ä¸ºæ”¯æŒ ChatGPT çš„å›½å®¶æˆ–åœ°åŒºï¼Œå¦‚ç¾Žå›½ï¼ˆé¦™æ¸¯ä¸æ”¯æŒï¼‰ã€‚ æ¸…é™¤æµè§ˆå™¨ cookieã€‚ åœ°å€æ è¾“å…¥javascript:window.localStorage.removeItem(Object.keys(window.localStorage).find(i=&gt;i.startsWith(&#39;@@auth0spajs&#39;)))ï¼Œå…¶ä¸­javascript:éœ€è¦æ‰‹åŠ¨è¾“å…¥ã€‚ ä»¥ä¸Šæ–¹æ³•æ ¹æ®æƒ…å†µè‡ªç”±é€‰æ‹©æ­é…ä½¿ç”¨ï¼ˆä»£ç†å¿…é¡»è¦åšï¼‰ã€‚æ¸…é™¤ cookie éœ€è¦é‡å¯æµè§ˆå™¨ã€‚æ¸…é™¤ç¼“å­˜ä¸éœ€è¦ã€‚","categories":[{"name":"åˆ†äº«","slug":"åˆ†äº«","permalink":"https://busyogg.github.io/categories/%E5%88%86%E4%BA%AB/"}],"tags":[{"name":"ChatGPT","slug":"ChatGPT","permalink":"https://busyogg.github.io/tags/ChatGPT/"}]},{"title":"Unity-é…ç½®ç±»ç”Ÿæˆå™¨","slug":"Unity-é…ç½®ç±»ç”Ÿæˆå™¨","date":"2023-12-10T13:32:35.000Z","updated":"2024-05-30T12:28:38.441Z","comments":true,"path":"article/7fe0212fb1a1/","link":"","permalink":"https://busyogg.github.io/article/7fe0212fb1a1/","excerpt":"","text":"ç®€ä»‹è‡ªåŠ¨ç›‘å¬ Json é…ç½®æ–‡ä»¶å¤¹ï¼Œç›®å‰å®žçŽ°ä¸€ä»¶ç”Ÿæˆé…ç½®ç±»ï¼Œæœ‰ç©ºçš„è¯å†å¢žåŠ é…ç½®æŸ¥çœ‹å’Œä¿®æ”¹çš„åŠŸèƒ½ã€‚ ä½¿ç”¨è¯´æ˜Žå·¥å…·è¯´æ˜Ž æŒ‰ç…§å›¾ç‰‡çº¢æ¡†æ‰€ç¤ºçš„æ­¥éª¤å³å¯ä¸€ä»¶ç”Ÿæˆé…ç½®ç±»æ–‡ä»¶ã€‚æœ¬å·¥å…·ç›‘å¬é…ç½®æ–‡ä»¶å¤¹ï¼Œåªè¦æœ‰å˜åŒ–è‡ªåŠ¨å°±ä¼šæ”¹å˜é¢æ¿æ˜¾ç¤ºçš„å†…å®¹ã€‚ å·¥å…·ä»£ç æ”¾åœ¨ Unity é¡¹ç›®çš„ Editor æ–‡ä»¶å¤¹ä¸‹ã€‚ é…ç½®ç±»è¯´æ˜Žé…ç½®ç±»ä¼šä¿å­˜åˆ°é…ç½®ç±»è¾“å‡ºæ–‡ä»¶å¤¹çš„ Bean ç›®å½•ä¸‹ã€‚ åœ¨è¾“å‡ºæ–‡ä»¶å¤¹æ ¹ç›®å½•ä¸­å­˜åœ¨ä¸€ä¸ª ConfigsPathConfig æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«æ‰€æœ‰é…ç½®çš„åå­—å’Œé…ç½®æ–‡ä»¶å¤¹çš„åå­—ã€‚ ä¾‹ï¼š é…ç½®æ–‡ä»¶è¯´æ˜Žé…ç½®è¡¨å±žæ€§ååŽé¢æ·»åŠ  | å¯ä»¥åˆ†å‰²å±žæ€§åå’Œç±»åž‹ã€‚ å¦‚æžœæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæœ¬é…ç½®ç±»çš„ç±»åž‹ï¼Œåˆ™æˆ‘ä»¬åœ¨å¯¹åº”çš„é…ç½®é¡¹å°±ç½®ç©ºã€‚ ä¾‹ï¼š å¦‚æžœæˆ‘ä»¬éœ€è¦ä¸€ä¸ªç‰¹å®šçš„æžšä¸¾ç±»åž‹æˆ–è€…ç±»çš„ç±»åž‹ï¼Œåˆ™å¯ä»¥ç”¨ | æ¥è¡¨ç¤ºæˆ‘ä»¬è¦ç”Ÿæˆçš„ç±»åž‹ï¼Œå³ PropName|EnumTypeï¼Œè¿™æ ·å°±èƒ½ç”Ÿæˆ EnumType propã€‚ ä¾‹ï¼š å¦‚æžœè¯¥ç±»åž‹æ˜¯ int ç±»åž‹çš„åˆ—è¡¨ï¼Œä½†æ˜¯ç¬¬ä¸€é¡¹ä¸­æ²¡æœ‰å†…å®¹ï¼Œæˆ‘ä»¬åªè¦æŠŠå±žæ€§åå†™æˆ PropName|int å³å¯ç”Ÿæˆ List&lt;int&gt;ã€‚ ä¾‹ï¼š å¦‚æžœè¯¥ç±»åž‹æ˜¯æœ¬æ•°æ®ç±»ï¼Œåˆ™æˆ‘ä»¬ä¸ç”¨å†™ç±»åž‹ï¼Œä½†æ˜¯è¦åœ¨é…ç½®é¡¹çš„ä½ç½®å†™ä¸€ä¸ªç©ºåˆ—è¡¨ [] ï¼Œè¿™æ ·ç”Ÿæˆçš„æ—¶å€™å°±ä¼šç”Ÿæˆ List&lt;ClassName&gt;ã€‚ ä¾‹ï¼š å¦‚æžœè¦ç”Ÿæˆä¸€ä¸ªå­—å…¸ï¼Œåˆ™æˆ‘ä»¬å¯ä»¥å†åŠ ä¸€ä¸ª | æ¥è¡¨ç¤ºé”®å€¼å¯¹ç±»åž‹ï¼Œå³å†™æˆ PropName|type|typeï¼Œå¹¶ä¸”åœ¨é…ç½®é¡¹å†™ä¸€ä¸ªç©ºå¯¹è±¡ &#123;&#125;ï¼Œè¿™æ ·å°±èƒ½ç”Ÿæˆ Dictionary&lt;type,type&gt;ã€‚ç›®å‰æ”¯æŒçš„ key ç±»åž‹ä¸º string å’Œ intã€‚ ä¾‹ï¼š å¦‚æžœè¦ç”Ÿæˆä¸€ä¸ªå¯¹è±¡æ•°ç»„ï¼Œåªéœ€è¦åœ¨æ•°ç»„ä¸­å†™å…¥å¯¹è±¡é”®å€¼å¯¹ï¼Œå³å¯ç”Ÿæˆå¯¹è±¡è¾…åŠ©ç±»ã€‚æœ¬ç±»åž‹ä¸æ”¯æŒè‡ªå®šä¹‰æ•°ç»„å’Œå­—å…¸ç±»åž‹ï¼Œåªèƒ½æŒ‰ç…§è¾“å…¥çš„å†…å®¹åˆ›å»ºåŸºæœ¬æ•°æ®ç±»åž‹çš„æ•°ç»„å’Œå­—å…¸ã€‚ ä¾‹ï¼š é…ç½®ç®¡ç†å™¨è¯´æ˜Žä½¿ç”¨ ConfigManager.Ins().GetConfig&lt;T&gt;(string folder, string name) æ¥èŽ·å–å¯¹åº”çš„é…ç½®ã€‚ ä½¿ç”¨ ConfigManager.Ins().Clear() æ¥æ¸…é™¤ç¼“å­˜ã€‚ é…ç½®è·¯å¾„ä¿®æ”¹ä¿®æ”¹æ–‡ä»¶ ConfigEditor ä¸­çš„ _jsonUrl å±žæ€§å³å¯ä¿®æ”¹è¯»å– json æ–‡ä»¶çš„æ–‡ä»¶å¤¹è·¯å¾„ã€‚ ä¿®æ”¹æ–‡ä»¶ ConfigEditor ä¸­çš„ _outputUrl å±žæ€§å³å¯ä¿®æ”¹å†™å…¥é…ç½®ç±»çš„è·¯å¾„ã€‚ æ³¨æ„ é…ç½®æ–‡ä»¶å¤¹ä¸‹ä¸èƒ½åˆ›å»ºå’Œé…ç½®æ–‡ä»¶å¤¹åŒåçš„æ–‡ä»¶å¤¹ã€‚ é…ç½®æ–‡ä»¶å¤¹åªèƒ½å­˜åœ¨æœ€å¤šäºŒçº§æ–‡ä»¶å¤¹ï¼Œå³æœ€å¤§è·¯å¾„ä¸º /Configs/Folder/Config.jsonã€‚ ä»£ç ConfigEditor123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478using System.Collections;using System.Collections.Generic;using UnityEngine;using UnityEditor;using System.IO;using LitJson;public class ConfigEditor : EditorWindow&#123; /// &lt;summary&gt; /// é…ç½®æ–‡ä»¶è·¯å¾„ /// &lt;/summary&gt; private string _jsonUrl; /// &lt;summary&gt; /// é…ç½®ç±»è¾“å‡ºè·¯å¾„ /// &lt;/summary&gt; private string _outputUrl; private Dictionary&lt;string, List&lt;FileInfo&gt;&gt; _allConfigs = new Dictionary&lt;string, List&lt;FileInfo&gt;&gt;(); private int _configsNum = 0; private bool _foldConfigs = true; private Vector2 _scrollRoot; ConfigEditor() &#123; titleContent = new GUIContent(&quot;é…ç½®ç¼–è¾‘å™¨&quot;); &#125; [MenuItem(&quot;PreUtils/EditorEditor&quot;)] static public void ShowEditor() &#123; // Debug.Log(&quot;å¯åŠ¨é…ç½®ç¼–è¾‘å™¨&quot;); EditorWindow.GetWindow(typeof(ConfigEditor)); &#125; private void OnEnable() &#123; _jsonUrl = Application.dataPath + &quot;/Configs/&quot;; _outputUrl = Application.dataPath + &quot;/Script/Loader/Config/&quot;; //èŽ·å–æ‰€æœ‰é…ç½® GetAllConfigs(); //ç›‘å¬é…ç½®æ–‡ä»¶å¤¹å˜åŒ– Debug.Log(&quot;å¯åŠ¨æ–‡ä»¶å¤¹ç›‘å¬&quot;); FileSystemWatcher watcher = new FileSystemWatcher(); watcher.IncludeSubdirectories = true; watcher.Path = _jsonUrl; watcher.NotifyFilter = NotifyFilters.LastWrite; watcher.Filter = &quot;*.json&quot;; FileSystemEventHandler changeHandle = new FileSystemEventHandler(OnJsonFileChanged); watcher.Changed += changeHandle; //watcher.Deleted += changeHandle; watcher.Created += changeHandle; watcher.EnableRaisingEvents = true; watcher.InternalBufferSize = 10240; &#125; public void OnGUI() &#123; GUILayout.Space(10); //èŽ·å–æ‰€æœ‰é…ç½® _foldConfigs = EditorGUILayout.BeginFoldoutHeaderGroup(_foldConfigs, &quot;æ‰€æœ‰é…ç½®&quot;); if (_foldConfigs) &#123; GUILayout.Label(&quot;æ€»é…ç½®æ•°é‡ï¼š&quot; + _configsNum); GUILayout.BeginHorizontal(); GUILayout.Space(10); _scrollRoot = EditorGUILayout.BeginScrollView(_scrollRoot, GUILayout.Height(400), GUILayout.Width(position.width - 20)); GUIStyle configButtonStyle = new GUIStyle(GUI.skin.button); configButtonStyle.fixedHeight = 22; configButtonStyle.fontSize = 16; configButtonStyle.alignment = TextAnchor.MiddleLeft; GUIStyle configLabelStyle = new GUIStyle(GUI.skin.label); configLabelStyle.fontSize = 18; configLabelStyle.alignment = TextAnchor.MiddleLeft; configLabelStyle.fixedHeight = 20; foreach (var fileInfo in _allConfigs) &#123; EditorGUILayout.LabelField(fileInfo.Key + &quot;ã€&quot; + fileInfo.Value.Count + &quot;ä¸ªé…ç½®æ–‡ä»¶ã€‘:&quot;, configLabelStyle); GUILayout.Space(5); for (int i = 0, len = fileInfo.Value.Count; i &lt; len; i++) &#123; FileInfo file = fileInfo.Value[i]; //EditorGUILayout.LabelField(&quot;æµ‹è¯•&quot;); GUIContent name = new GUIContent((i + 1) + &quot;.&quot; + file.Name.Replace(&quot;.json&quot;, &quot;&quot;)); if (GUILayout.Button(name, configButtonStyle)) &#123; //EditorWindow.GetWindow(typeof(ConfigDetailEditor)); &#125; GUILayout.Space(2); &#125; GUILayout.Space(10); &#125; EditorGUILayout.EndScrollView(); GUILayout.EndHorizontal(); &#125; EditorGUILayout.EndFoldoutHeaderGroup(); GUILayout.Space(10); if (GUILayout.Button(&quot;ä¸€é”®ç”Ÿæˆæ‰€æœ‰é…ç½®æ–‡ä»¶æ•°æ®ç±»&quot;)) &#123; GenerateDataClass(); GenerateConfigPath(); &#125; &#125; /// &lt;summary&gt; /// åˆ›å»ºæ•°æ®ç±» /// &lt;/summary&gt; private void GenerateDataClass() &#123; //ç”ŸæˆåŸºç±» string ns = &quot;Bean&quot;; string baseClass = &quot;namespace &quot; + ns + &quot;\\r\\n&#123;\\r\\n&quot; + &quot;\\tpublic class ConfigBaseData\\r\\n&quot; + &quot;\\t&#123;\\r\\n&quot; + &quot;\\t\\tpublic int id;\\r\\n&quot; + &quot;\\t&#125;\\r\\n&#125;&quot;; string output = _outputUrl + &quot;ConfigBaseData.cs&quot;; GeneratorUtils.WriteFile(output, baseClass); //åˆ›å»ºæ‰€æœ‰æ•°æ®ç±» foreach (var fileInfo in _allConfigs) &#123; //ç”Ÿæˆæ•°æ®ç±» for (int i = 0, len = fileInfo.Value.Count; i &lt; len; i++) &#123; FileInfo file = fileInfo.Value[i]; string content = GeneratorUtils.ReadFile(file.FullName); JsonData jsonData = JsonMapper.ToObject(content); GenerateClass(GeneratorUtils.UpperCaseFirstChar(file.Name.Split(&#x27;.&#x27;)[0]) + &quot;Data&quot;, jsonData, fileInfo.Key); &#125; &#125; &#125; /// &lt;summary&gt; /// åˆ›å»ºç±» /// &lt;/summary&gt; /// &lt;param name=&quot;clsName&quot;&gt;&lt;/param&gt; /// &lt;param name=&quot;json&quot;&gt;&lt;/param&gt; /// &lt;param name=&quot;folder&quot;&gt;&lt;/param&gt; private void GenerateClass(string clsName, JsonData json, string folder) &#123; List&lt;string&gt; listClass = new List&lt;string&gt;(); List&lt;string&gt; listProps = new List&lt;string&gt;(); string ns = &quot;Bean&quot;; //åˆ›å»ºå‘½åç©ºé—´ listClass.Add(&quot;using System;\\r\\n&quot; + &quot;using System.Collections.Generic;\\r\\n&quot; + &quot;namespace &quot; + ns + &quot;&#123;\\r\\n&quot;); //åˆ›å»ºç±»å¤´ listClass.Add(&quot;\\tpublic class &quot; + clsName + &quot;: ConfigBaseData, ICloneable&#123;\\r\\n&quot;); //åˆ›å»ºæž„é€ å‡½æ•° string strConstructor = &quot;\\t\\tpublic &quot; + clsName + &quot;()&#123;\\r\\n&quot;; //éåŽ†å±žæ€§ IDictionary props = json[0]; foreach (var key in props.Keys) &#123; Dictionary&lt;string, bool&gt; dicClass = new Dictionary&lt;string, bool&gt;(); string propName = key.ToString(); if (propName == &quot;id&quot;) continue; JsonData child = json[0][propName]; object type = child == null ? JsonType.None : child.GetJsonType(); if (type.Equals(JsonType.None)) &#123; listClass.Add(&quot;\\t\\tpublic &quot; + clsName + &quot; &quot; + propName + &quot;;\\r\\n&quot;); &#125; else if (type.Equals(JsonType.Array)) &#123; //å±žæ€§ä¸ºæ•°ç»„ if (child.Count == 0) &#123; //æœ€ç»ˆç±»åž‹éžå¯¹è±¡ï¼Œè¯¥å±žæ€§ä¸ºçº¯æ•°ç»„ string strList = &quot;&quot;; string strListEnd = &quot;&quot;; strList += &quot;List&lt;&quot;; strListEnd += &quot;&gt;&quot;; string[] propSplit = propName.Split(&#x27;|&#x27;); string strType; if (propSplit.Length &gt; 1) &#123; //strList += propSplit[1] + strListEnd; strType = propSplit[1]; &#125; else &#123; strType = clsName; &#125; strList += strType + strListEnd; Debug.Log(&quot;listæ•°ç»„ ==== &quot; + strList); //cls += &quot;\\t\\tpublic &quot; + strList + &quot; &quot; + propName + &quot;;\\r\\n&quot;; listClass.Add(&quot;\\t\\tpublic &quot; + strList + &quot; &quot; + propSplit[0] + &quot;;\\r\\n&quot;); string strConstructorChild = &quot;\\t\\t\\t&quot; + propSplit[0] + &quot; = new List&lt;&quot; + strType + &quot;&gt;();\\r\\n&quot;; strConstructor += strConstructorChild; &#125; else &#123; //èŽ·å–æœ€ç»ˆç±»åž‹ JsonData tempData = child[0]; JsonType tempType = tempData.GetJsonType(); int loop = 1; while (tempData.GetJsonType().Equals(JsonType.Array)) &#123; tempData = tempData[0]; tempType = tempData.GetJsonType(); loop++; &#125; if (tempType.Equals(JsonType.Object)) &#123; //æœ€ç»ˆç±»åž‹ä¸ºå¯¹è±¡ //åˆ›å»ºé™„å±žç±» string strListClassName = GeneratorUtils.UpperCaseFirstChar(propName) + &quot;Data&quot;; if (!dicClass.ContainsKey(strListClassName)) &#123; GeneratorUtils.GenerateSubClass(child, strListClassName, listClass, dicClass); dicClass.Add(strListClassName, true); &#125; //åˆ›å»ºé™„å±žç±»åˆ—è¡¨ string strList = &quot;&quot;; string strListEnd = &quot;&quot;; for (int i = 0; i &lt; loop; i++) &#123; strList += &quot;List&lt;&quot;; strListEnd += &quot;&gt;&quot;; if (i == loop - 1) &#123; strList += strListClassName + strListEnd; &#125; &#125; //strListClass += &quot;\\t\\tpublic &quot; + strList + &quot; &quot; + propName + &quot;;\\r\\n&quot;; listClass.Add(&quot;\\t\\tpublic &quot; + strList + &quot; &quot; + propName + &quot;;\\r\\n&quot;); string strConstructorChild = &quot;\\t\\t\\t&quot; + propName + &quot; = new List&lt;&quot; + strListClassName + &quot;&gt;();\\r\\n&quot;; strConstructor += strConstructorChild; &#125; else &#123; //æœ€ç»ˆç±»åž‹éžå¯¹è±¡ï¼Œè¯¥å±žæ€§ä¸ºçº¯æ•°ç»„ string strList = &quot;&quot;; string strListEnd = &quot;&quot;; for (int i = 0; i &lt; loop; i++) &#123; strList += &quot;List&lt;&quot;; strListEnd += &quot;&gt;&quot;; if (i == loop - 1) &#123; strList += GeneratorUtils.GetType(tempType) + strListEnd; &#125; &#125; Debug.Log(&quot;listæ•°ç»„ ==== &quot; + strList); //cls += &quot;\\t\\tpublic &quot; + strList + &quot; &quot; + propName + &quot;;\\r\\n&quot;; listClass.Add(&quot;\\t\\tpublic &quot; + strList + &quot; &quot; + propName + &quot;;\\r\\n&quot;); string strConstructorChild = &quot;\\t\\t\\t&quot; + propName + &quot; = new List&lt;&quot; + GeneratorUtils.GetType(tempType) + &quot;&gt;();\\r\\n&quot;; strConstructor += strConstructorChild; &#125; &#125; &#125; else if (type.Equals(JsonType.Object)) &#123; //å±žæ€§ä¸ºå¯¹è±¡ string[] propSplits = propName.Split(&quot;|&quot;); if (propSplits.Length &gt; 1) &#123; listClass.Add(&quot;\\t\\tpublic Dictionary&lt;&quot; + propSplits[1] + &quot;,&quot; + propSplits[2] + &quot;&gt; &quot; + propSplits[0] + &quot;;\\r\\n&quot;); string strConstructorChild = &quot;\\t\\t\\t&quot; + propSplits[0] + &quot; = new Dictionary&lt;&quot; + propSplits[1] + &quot;,&quot; + propSplits[2] + &quot;&gt;();\\r\\n&quot;; strConstructor += strConstructorChild; &#125; else &#123; //åˆ›å»ºé™„å±žç±» string strListClassName = GeneratorUtils.UpperCaseFirstChar(propName) + &quot;Data&quot;; if (!dicClass.ContainsKey(strListClassName)) &#123; GeneratorUtils.GenerateSubClass(child, strListClassName, listClass, dicClass); dicClass.Add(strListClassName, true); &#125; listClass.Add(&quot;\\t\\tpublic &quot; + strListClassName + &quot; &quot; + propName + &quot;;\\r\\n&quot;); &#125; &#125; else &#123; //å±žæ€§ä¸ºåŸºæœ¬ç±»åž‹ //Debug.Log(&quot;å±žæ€§å&quot; + propName + &quot;,&quot; + type + &quot;,&quot; + json[0][propName]); //cls += &quot;\\t\\tpublic &quot; + GetType(type) + &quot; &quot; + propName + &quot;;\\r\\n&quot;; if (type == null) &#123; listClass.Add(&quot;\\t\\tpublic &quot; + clsName + &quot; &quot; + propName + &quot;;\\r\\n&quot;); &#125; else &#123; string[] propSplit = propName.Split(&#x27;|&#x27;); if (propSplit.Length &gt; 1) &#123; listClass.Add(&quot;\\t\\tpublic &quot; + propSplit[1] + &quot; &quot; + propSplit[0] + &quot;;\\r\\n&quot;); &#125; else &#123; listClass.Add(&quot;\\t\\tpublic &quot; + GeneratorUtils.GetType((JsonType)type) + &quot; &quot; + propName + &quot;;\\r\\n&quot;); &#125; &#125; &#125; listProps.Add(propName); &#125; strConstructor += &quot;\\t\\t&#125;\\r\\n&quot;; listClass.Add(strConstructor); string strGenerator = &quot;&quot;; strGenerator += &quot;\\t\\tpublic &quot; + clsName + &quot;(&quot; + clsName + &quot; obj)&#123;\\r\\n&quot;; for (int i = 0, len = listProps.Count; i &lt; len; i++) &#123; string[] propSplit = listProps[i].Split(&#x27;|&#x27;); if (propSplit.Length &gt; 1) &#123; strGenerator += &quot;\\t\\t\\t&quot; + propSplit[0] + &quot; = obj.&quot; + propSplit[0] + &quot;;\\r\\n&quot;; &#125; else &#123; strGenerator += &quot;\\t\\t\\t&quot; + listProps[i] + &quot; = obj.&quot; + listProps[i] + &quot;;\\r\\n&quot;; &#125; &#125; strGenerator += &quot;\\t\\t&#125;\\r\\n&quot;; listClass.Add(strGenerator); //åˆ›å»ºå…‹éš†å‡½æ•° listClass.Add(&quot;\\t\\tpublic object Clone()\\r\\n&quot; + &quot;\\t\\t&#123;\\r\\n&quot; + &quot;\\t\\t\\treturn new &quot; + clsName + &quot;(this);\\r\\n&quot; + &quot;\\t\\t&#125;\\r\\n&quot;); //è¡¥å……æ–‡ä»¶ç»“æž„ listClass.Add(&quot;\\t&#125;&quot; + &quot;\\r\\n&#125;&quot;); //æ‹¼è£…æ•°æ®ç±»å†…å®¹ string cls = &quot;&quot;; for (int i = 0, len = listClass.Count; i &lt; len; i++) &#123; cls += listClass[i]; &#125; //ä¿å­˜æ•°æ®ç±» Debug.Log(&quot;ç”Ÿæˆç±»&quot; + cls); string strFolder; if (folder == &quot;Configs&quot;) &#123; strFolder = &quot;&quot;; &#125; else &#123; strFolder = folder + &quot;/&quot;; &#125; string output = _outputUrl + &quot;Bean/&quot; + strFolder + clsName + &quot;.cs&quot;; GeneratorUtils.WriteFile(output, cls); &#125; private void GenerateConfigPath() &#123; //string ns = &quot;Bean&quot;; string cls = &quot;namespace Bean&#123;\\r\\n&quot; + &quot;\\tpublic class ConfigsFolderConfig\\r\\n&quot; + &quot;\\t&#123;\\r\\n&quot;; string folders = &quot;\\t\\tpublic const string Null = null;\\r\\n&quot;; string names = &quot;&quot;; //é…ç½®åå­—å…¸ï¼Œé˜²æ­¢é‡åé…ç½®é‡å¤æ·»åŠ  Dictionary&lt;string, bool&gt; dicNames = new Dictionary&lt;string, bool&gt;(); //åˆ›å»ºæ‰€æœ‰æ•°æ®ç±» foreach (var fileInfo in _allConfigs) &#123; if (fileInfo.Key != &quot;Configs&quot;) &#123; folders += &quot;\\t\\tpublic const string &quot; + fileInfo.Key + &quot; = \\&quot;&quot; + fileInfo.Key + &quot;\\&quot;;\\r\\n&quot;; &#125; //ç”Ÿæˆæ•°æ®ç±» for (int i = 0, len = fileInfo.Value.Count; i &lt; len; i++) &#123; FileInfo file = fileInfo.Value[i]; string fileName = file.Name.Replace(&quot;.json&quot;, &quot;&quot;); if (!dicNames.ContainsKey(fileName)) &#123; names += &quot;\\t\\tpublic const string &quot; + GeneratorUtils.UpperCaseFirstChar(fileName) + &quot; = \\&quot;&quot; + fileName + &quot;\\&quot;;\\r\\n&quot;; dicNames.Add(fileName, true); &#125; &#125; &#125; cls += folders; cls += &quot;\\t&#125;\\r\\n\\r\\n&quot; + &quot;\\tpublic class ConfigsNameConfig\\r\\n&quot; + &quot;\\t&#123;\\r\\n&quot;; cls += names; cls += &quot;\\t&#125;\\r\\n&quot; + &quot;&#125;&quot;; Debug.Log(&quot;ç”Ÿæˆé…ç½®è¡¨è·¯å¾„é…ç½®\\n&quot; + cls); GeneratorUtils.WriteFile(_outputUrl + &quot;ConfigsPathConfig.cs&quot;, cls); &#125; //-----è‡ªåŠ¨å‡½æ•°----- /// &lt;summary&gt; /// é…ç½®æ–‡ä»¶å‘ç”Ÿå˜åŒ–åŽçš„å“åº”äº‹ä»¶ /// &lt;/summary&gt; /// &lt;param name=&quot;obj&quot;&gt;&lt;/param&gt; /// &lt;param name=&quot;args&quot;&gt;&lt;/param&gt; private void OnJsonFileChanged(object obj, FileSystemEventArgs args) &#123; Debug.Log(&quot;é…ç½®æ–‡ä»¶å‘ç”Ÿå˜åŒ–ï¼Œé‡è½½é…ç½®æ–‡ä»¶&quot;); _allConfigs.Clear(); GetAllConfigs(); &#125; /// &lt;summary&gt; /// èŽ·å–æ‰€æœ‰é…ç½® /// &lt;/summary&gt; private void GetAllConfigs() &#123; Debug.Log(&quot;èŽ·å–æ‰€æœ‰é…ç½®1:&quot; + _jsonUrl); DirectoryInfo directoryInfo = new DirectoryInfo(_jsonUrl); FileInfo[] files = directoryInfo.GetFiles(&quot;*&quot;, SearchOption.AllDirectories); _configsNum = 0; for (int i = 0, len = files.Length; i &lt; len; i++) &#123; FileInfo file = files[i]; if (file.Name.EndsWith(&quot;.meta&quot;)) continue; string[] folders = file.DirectoryName.Split(&#x27;\\\\&#x27;); string parent = folders[folders.Length - 1]; //_allConfigs.Add(file); if (!_allConfigs.ContainsKey(parent)) &#123; _allConfigs.Add(parent, new List&lt;FileInfo&gt;()); &#125; _allConfigs[parent].Add(file); //ConsoleUtils.Log(&quot;æ·»åŠ è·¯å¾„&quot; , (file.DirectoryName + &quot;/&quot;), _jsonUrl); _configsNum++; &#125; &#125;&#125; GeneratorUtils123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181using System.Collections;using System.Collections.Generic;using UnityEngine;using LitJson;using System.IO;using System.Text;public class GeneratorUtils&#123; /// &lt;summary&gt; /// ç”Ÿæˆè¾…åŠ©ç±» /// &lt;/summary&gt; /// &lt;param name=&quot;json&quot;&gt;&lt;/param&gt; /// &lt;param name=&quot;className&quot;&gt;&lt;/param&gt; /// &lt;param name=&quot;list&quot;&gt;&lt;/param&gt; /// &lt;param name=&quot;dic&quot;&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public static string GenerateSubClass(JsonData json, string className, List&lt;string&gt; list, Dictionary&lt;string, bool&gt; dic) &#123; string strListClass = &quot;\\t\\tpublic class &quot; + className + &quot; &#123;\\r\\n&quot;; Debug.Log(&quot;jsonæ•°æ® ===== &quot; + json.ToJson()); IDictionary classProps = json.GetJsonType().Equals(JsonType.Array) ? json[0] : json; foreach (var classKey in classProps.Keys) &#123; string propName = classKey.ToString(); //JsonData child = json[0][propName]; //strListClass += &quot;\\t\\tpublic &quot; + GetType(type) + &quot; &quot; + propName + &quot;;\\r\\n&quot;; JsonData child = (JsonData)classProps[classKey]; JsonType type = child.GetJsonType(); if (type.Equals(JsonType.Array)) &#123; string[] propSplit = propName.Split(&#x27;|&#x27;); //èŽ·å–æœ€ç»ˆç±»åž‹ JsonData tempData = child[0]; JsonType tempType = tempData.GetJsonType(); int loop = 1; while (tempData.GetJsonType().Equals(JsonType.Array)) &#123; tempData = tempData[0]; tempType = tempData.GetJsonType(); loop++; &#125; if (tempType.Equals(JsonType.Object)) &#123; string strListClassName = GeneratorUtils.UpperCaseFirstChar(propName) + &quot;Data&quot;; if (!dic.ContainsKey(strListClassName)) &#123; GenerateSubClass(child, strListClassName, list, dic); dic.Add(strListClassName, true); &#125; //åˆ›å»ºé™„å±žç±»åˆ—è¡¨ string strList = &quot;&quot;; string strListEnd = &quot;&quot;; for (int i = 0; i &lt; loop; i++) &#123; strList += &quot;List&lt;&quot;; strListEnd += &quot;&gt;&quot;; if (i == loop - 1) &#123; strList += strListClassName + strListEnd; &#125; &#125; strListClass += &quot;\\t\\t\\tpublic &quot; + strList + &quot; &quot; + propName + &quot;;\\r\\n&quot;; &#125; else &#123; //éžå¯¹è±¡ï¼Œè¯¥å±žæ€§ä¸ºçº¯æ•°ç»„ string strList = &quot;&quot;; string strListEnd = &quot;&quot;; for (int i = 0; i &lt; loop; i++) &#123; strList += &quot;List&lt;&quot;; strListEnd += &quot;&gt;&quot;; if (i == loop - 1) &#123; strList += GetType(tempType) + strListEnd; &#125; &#125; strListClass += &quot;\\t\\t\\tpublic &quot; + strList + &quot; &quot; + propName + &quot;;\\r\\n&quot;; &#125; &#125; else if (type.Equals(JsonType.Object)) &#123; string strListClassName = GeneratorUtils.UpperCaseFirstChar(propName) + &quot;Data&quot;; if (!dic.ContainsKey(strListClassName)) &#123; GenerateSubClass(child, strListClassName, list, dic); &#125; strListClass += &quot;\\t\\t\\tpublic &quot; + strListClassName + &quot; &quot; + propName + &quot;;\\r\\n&quot;; &#125; else &#123; string[] propSplit = propName.Split(&#x27;|&#x27;); Debug.Log(&quot;åˆ†ç¦»:&quot; + propSplit.Length); if (propSplit.Length &gt; 1) &#123; strListClass += &quot;\\t\\t\\tpublic &quot; + propSplit[1] + &quot; &quot; + propSplit[0] + &quot;;\\r\\n&quot;; &#125; else &#123; strListClass += &quot;\\t\\t\\tpublic &quot; + GetType(type) + &quot; &quot; + propName + &quot;;\\r\\n&quot;; &#125; &#125; &#125; strListClass += &quot;\\t\\t&#125;\\r\\n&quot;; list.Insert(2, strListClass); return strListClass; &#125; public static string GetType(JsonType name) &#123; switch (name) &#123; case JsonType.Int: return &quot;int&quot;; case JsonType.Boolean: return &quot;bool&quot;; case JsonType.String: return &quot;string&quot;; case JsonType.Double: return &quot;double&quot;; case JsonType.Long: return &quot;long&quot;; &#125; return &quot;&quot;; &#125; /// &lt;summary&gt; /// é¦–å­—æ¯å¤§å†™ /// &lt;/summary&gt; /// &lt;param name=&quot;s&quot;&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public static string UpperCaseFirstChar(string s) &#123; if (string.IsNullOrEmpty(s)) &#123; return string.Empty; &#125; char[] a = s.ToCharArray(); a[0] = char.ToUpper(a[0]); return new string(a); &#125; /// &lt;summary&gt; /// åˆ›å»ºæ–‡ä»¶ /// &lt;/summary&gt; /// &lt;param name=&quot;path&quot;&gt;&lt;/param&gt; /// &lt;param name=&quot;name&quot;&gt;&lt;/param&gt; /// &lt;param name=&quot;info&quot;&gt;&lt;/param&gt; public static void WriteFile(string path, string content) &#123; //if (File.Exists(path)) &#123; //&#125; string folderPath = Path.GetDirectoryName(path); if (!Directory.Exists(folderPath)) &#123; Directory.CreateDirectory(folderPath); &#125; File.WriteAllText(path, content, Encoding.Default); &#125; /// &lt;summary&gt; /// è¯»å–æ–‡ä»¶ /// &lt;/summary&gt; /// &lt;param name=&quot;path&quot;&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public static string ReadFile(string path) &#123; path = path.Replace(&quot;/&quot;, &quot;\\\\&quot;); return File.ReadAllText(path); &#125;&#125; FileUtils123456789101112131415161718192021222324252627282930313233343536using System.IO;using System.Text;public class FileUtils&#123; // Start is called before the first frame update /// &lt;summary&gt; /// åˆ›å»ºæ–‡ä»¶ /// &lt;/summary&gt; /// &lt;param name=&quot;path&quot;&gt;&lt;/param&gt; /// &lt;param name=&quot;name&quot;&gt;&lt;/param&gt; /// &lt;param name=&quot;info&quot;&gt;&lt;/param&gt; public static void WriteFile(string path, string content) &#123; //if (File.Exists(path)) &#123; //&#125; string folderPath = Path.GetDirectoryName(path); if (!Directory.Exists(folderPath)) &#123; Directory.CreateDirectory(folderPath); &#125; File.WriteAllText(path, content, Encoding.Default); &#125; /// &lt;summary&gt; /// è¯»å–æ–‡ä»¶ /// &lt;/summary&gt; /// &lt;param name=&quot;path&quot;&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public static string ReadFile(string path) &#123; path = path.Replace(&quot;/&quot;, &quot;\\\\&quot;); return File.ReadAllText(path); &#125;&#125; ConfigManager1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677using System.Collections.Generic;using System.IO;using UnityEngine;using System.Linq;using LitJson;using Bean;using System.Text.RegularExpressions;public class ConfigManager:Singleton&lt;ConfigManager&gt;&#123; private Dictionary&lt;string, object&gt; _configs = new Dictionary&lt;string, object&gt;(); private Dictionary&lt;string, Dictionary&lt;string, FileInfo&gt;&gt; _fileInfo; /// &lt;summary&gt; /// è¯»å–é…ç½® /// &lt;/summary&gt; /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt; /// &lt;param name=&quot;folder&quot;&gt;é…ç½®åˆ†ç±»&lt;/param&gt; /// &lt;param name=&quot;name&quot;&gt;é…ç½®å&lt;/param&gt; /// &lt;returns&gt;é…ç½®å­—å…¸&lt;/returns&gt; public Dictionary&lt;int, T&gt; GetConfig&lt;T&gt;(string folder, string name) where T : ConfigBaseData &#123; object obj = null; string path = folder + &quot;_&quot; + name; _configs.TryGetValue(path, out obj); if (obj != null) &#123; Debug.Log(&quot;è¯»å–é…ç½®ç¼“å­˜ã€&quot; + name + &quot;ã€‘&quot;); return (Dictionary&lt;int, T&gt;)obj; &#125; else &#123; string config = FileUtils.ReadFile(Application.dataPath + &quot;/Configs/&quot; + (folder != null ? folder + &quot;/&quot; : &quot;&quot;) + name + &quot;.json&quot;); config = Regex.Replace(config, &quot;(\\\\|).*(?=\\&quot;)&quot;, &quot;&quot;); Debug.Log(&quot;é…ç½®è¯»å–è·¯å¾„ - &quot; + Application.dataPath + &quot;/Configs/&quot; + (folder != null ? folder + &quot;/&quot; : &quot;&quot;) + name + &quot;.json&quot;); Debug.Log(&quot;è¯»å–å†…å®¹ = &quot; + config); if (!string.IsNullOrEmpty(config)) &#123; T[] json = JsonMapper.ToObject&lt;T[]&gt;(config); obj = json.ToDictionary(key =&gt; key.id, value =&gt; value); _configs.Add(path, obj); return (Dictionary&lt;int, T&gt;)obj; &#125; else &#123; Debug.LogWarning(&quot;ä¸å­˜åœ¨é…ç½®ã€&quot; + name + &quot;ã€‘&quot;); return null; &#125; &#125; &#125; /// &lt;summary&gt; /// æ¸…é™¤ç›®æ ‡ç¼“å­˜ /// &lt;/summary&gt; /// &lt;param name=&quot;folder&quot;&gt;&lt;/param&gt; /// &lt;param name=&quot;name&quot;&gt;&lt;/param&gt; public void Clear(string folder, string name) &#123; string path = folder + &quot;_&quot; + name; if (_configs.ContainsKey(path)) &#123; _configs.Remove(path); &#125; &#125; /// &lt;summary&gt; /// æ¸…é™¤æ‰€æœ‰ç¼“å­˜ /// &lt;/summary&gt; public void ClearAll() &#123; _configs.Clear(); &#125;&#125; æ›´æ–°æ—¥å¿—2023-12-13 æ›´æ–°é…ç½®è¯»å–ç®¡ç†å™¨ã€‚ä¿®æ”¹ LitJson åºåˆ—åŒ–ä½¿å…¶æ”¯æŒ int ç±»åž‹ä½œä¸ºå­—å…¸çš„ keyã€‚ 2023-12-09 æ›´æ–°åŸºç¡€ç‰ˆæœ¬ã€‚","categories":[{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/categories/Unity/"},{"name":"å·¥å…·","slug":"Unity/å·¥å…·","permalink":"https://busyogg.github.io/categories/Unity/%E5%B7%A5%E5%85%B7/"}],"tags":[{"name":"C#","slug":"C","permalink":"https://busyogg.github.io/tags/C/"},{"name":"å·¥å…·ç±»","slug":"å·¥å…·ç±»","permalink":"https://busyogg.github.io/tags/%E5%B7%A5%E5%85%B7%E7%B1%BB/"},{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/tags/Unity/"}]},{"title":"Unity-æ—¶é—´è½®å®šæ—¶å™¨","slug":"Unity-æ—¶é—´è½®å®šæ—¶å™¨","date":"2023-12-08T19:20:26.000Z","updated":"2024-05-30T12:28:48.555Z","comments":true,"path":"article/57f2cacfb66b/","link":"","permalink":"https://busyogg.github.io/article/57f2cacfb66b/","excerpt":"","text":"ç®€ä»‹æˆ‘ä»¬åœ¨å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰æ—¶å€™éœ€è¦ä¸€ä¸ªè¡Œä¸ºå»¶è¿Ÿä¸€å®šæ—¶é—´ï¼Œæˆ–è€…æ˜¯é‡å¤æ‰§è¡Œï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°å®šæ—¶å™¨ã€‚Unity æ²¡æœ‰ä¸“é—¨çš„å®šæ—¶å™¨ç³»ç»Ÿï¼Œä¸è¿‡æœ‰åç¨‹çš„æ–¹å¼æ¥å®žçŽ°è¿™ä¸€è¡Œä¸ºã€‚ä¸è¿‡åç¨‹çš„ä½¿ç”¨éš¾å…æœ‰äº›ä¸æ–¹ä¾¿ï¼Œä¹Ÿæœ‰ä¸€äº›æ€§èƒ½ä¸Šçš„æ¶ˆè€—ï¼Œå› æ­¤å†³å®šè‡ªå·±é€ è½®å­ã€‚æœ¬ç³»ç»Ÿä½¿ç”¨æ—¶é—´è½®çš„æ€æƒ³æž„å»ºå®šæ—¶å™¨ç³»ç»Ÿï¼Œæœ‰åˆ«äºŽä¼ ç»Ÿçš„å…¨éåŽ†æ–¹å¼ã€‚ åŽŸç†æ—¶é—´è½®ç½‘å›¾ï¼š å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªæ—¶é—´è½®ç›˜ï¼Œè¿™ä¸ªè½®ç›˜æœ‰å¥½å‡ ä¸ªæ§½ä½ï¼Œæ¯ä¸ªæ§½ä½é‡Œé¢æœ‰ä¸€ä¸ªé“¾è¡¨ç”¨äºŽä¿å­˜ç¬¦åˆå½“å‰æ¡ä»¶çš„å®šæ—¶ä»»åŠ¡ã€‚ æ¯ä¸ªå®šæ—¶ä»»åŠ¡æ”¾å…¥å¯¹åº”æ§½ä½çš„è§„åˆ™ä¸º å½“å‰æ—¶é—´ + å»¶è¿Ÿæ—¶é—´ + æ¯æ¬¡å¾ªçŽ¯æ—¶é—´ï¼Œè¿™æ ·æ¯ä¸ªæ§½ä½å°±å¯¹åº”ç€è§¦å‘ä»»åŠ¡çš„æ—¶é—´ã€‚ æˆ‘ä»¬æŒ‰ç…§å½“å‰æ—¶é—´æ¥è®¿é—®å¯¹åº”çš„æ§½ä½ï¼Œå³åˆ°äº†éœ€è¦è§¦å‘ä»»åŠ¡çš„æ—¶é—´ï¼Œä»»åŠ¡è§¦å‘ã€‚ å¦‚æžœæˆ‘ä»¬æŒ‰ç…§ä¸€ä¸ªæœ€å°æ—¶é—´é—´éš”ï¼Œæ¯ä¸ªæ—¶é—´éƒ½å¼€è®¾ä¸€ä¸ªæ§½ä½çš„è¯ï¼Œéœ€è¦çš„å­˜å‚¨ç©ºé—´å°±å¤ªå¤§äº†ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦å¤šå±‚æ—¶é—´è½®ï¼Œå°±å¥½åƒæ°´è¡¨æœ‰å¥½å‡ ä¸ªè½¬ç›˜è¡¨ç¤ºä¸åŒçš„åˆ»åº¦ã€‚æˆ‘ä»¬æŠŠæ—¶é—´åˆ†ä¸ºå¹´ï¼ˆéœ€è¦çš„è¯ï¼‰ã€æœˆã€æ—¥ã€æ—¶ã€åˆ†ã€æ¯«ç§’ï¼Œæœ¬ä¾‹ä¸­æ²¡æœ‰å¹´è½®ï¼Œæ€»å…±æ˜¯å…­ä¸ªæ—¶é—´è½®ã€‚æ¯«ç§’è½®çš„æ•°é‡å¤ªå¤§ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æŒ‰ç…§è®¾å®šçš„æœ€å°æ—¶é—´é—´éš”å‡å°‘åˆ’åˆ†ï¼ˆæœ¬ä¾‹æŒ‰ç…§ 50ms ä¸ºæœ€å°ç²’åº¦åˆ’åˆ† 20 ä¸ªæ§½ä½ï¼‰ã€‚æœ¬ä¾‹ä¸­æ—¶é—´è½®ç”¨å­—å…¸ä¿å­˜ï¼Œä»»åŠ¡åˆ—è¡¨ç”¨é“¾è¡¨ä¿å­˜ã€‚ å½“æˆ‘ä»¬çš„ä»»åŠ¡ä¸ºå®šæ—¶åˆ° 5 ç§’åŽï¼Œæˆ‘ä»¬å°±æŠŠå½“å‰ä»»åŠ¡æ”¾å…¥æœˆè½®å½“æœˆçš„æ§½ä½ï¼Œç„¶åŽæˆ‘ä»¬åœ¨è½®è¯¢çš„æ—¶å€™æŒ‰ç…§å…­ä¸ªç¬¦åˆå½“å‰æ—¶é—´çš„æ—¶é—´è½®æ§½ä½ä¾æ¬¡éåŽ†é“¾è¡¨ã€‚ç”±äºŽæˆ‘ä»¬æ¯æ¬¡æ·»åŠ ä»»åŠ¡éƒ½æ˜¯æ·»åŠ åˆ°æœ€é¡¶å±‚çš„æœˆè½®ï¼Œå› æ­¤æˆ‘ä»¬æŠŠå½“å‰æ—¶é—´çš„æœˆè½®æ§½ä½ä¸­çš„æ‰€æœ‰ä»»åŠ¡éƒ½å–å‡ºå¹¶æ·»åŠ åˆ°æ—¥è½®ã€‚æ—¥è½®ä¹Ÿæ˜¯åŒæ ·çš„æ“ä½œï¼Œä¾æ¬¡æ‰§è¡Œä¹‹åŽä»»åŠ¡å°±åˆ°è¾¾æ¯«ç§’è½®ä¸­ã€‚ ä»»åŠ¡æœ€ç»ˆåˆ°è¾¾æ¯«ç§’è½®åŽï¼Œæˆ‘ä»¬å°±éåŽ†å½“å‰æ¯«ç§’è½®æ§½ä½çš„é“¾è¡¨ï¼Œæ¯”è¾ƒå½“å‰æ—¶é—´å’Œä»»åŠ¡ç›®æ ‡æ—¶é—´ï¼Œå¤§äºŽç­‰äºŽçš„æƒ…å†µä¸‹æ‰§è¡Œä»»åŠ¡å¹¶ç§»é™¤å‡ºé“¾è¡¨ã€‚ç§»é™¤ä¹‹åŽï¼Œæˆ‘ä»¬è¿˜è¦åˆ¤æ–­å½“å‰ä»»åŠ¡æ˜¯å¦éœ€è¦å¾ªçŽ¯ï¼Œéœ€è¦å¾ªçŽ¯çš„è¯æˆ‘ä»¬æŠŠå½“å‰ä»»åŠ¡åˆé‡æ–°æ·»åŠ åˆ°æœˆè½®ä¸­ï¼Œæ‰§è¡Œä¸‹ä¸€ä¸ªå¾ªçŽ¯ã€‚ é“¾å¼è°ƒç”¨ä¸ºäº†è®©å®šæ—¶å™¨æ›´åŠ å®žç”¨ï¼Œæˆ‘ä»¬å¼•å…¥äº†é“¾å¼è°ƒç”¨ã€‚æˆ‘ä»¬åœ¨åˆ›å»ºå®šæ—¶å™¨çš„æ—¶å€™ä¼šè¿”å›žä¸€ä¸ªé“¾å¼è°ƒç”¨çš„å¯¹è±¡ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨åˆ›å»ºä¸€æ¬¡å®šæ—¶å™¨ä¹‹åŽå†ç‚¹å‡ºä¸€ä¸ªæ–°çš„å®šæ—¶å™¨ã€‚è¿™ä¸ªæ–°çš„å®šæ—¶å™¨çš„å»¶è¿Ÿæ—¶é—´ä¸ºå‰é¢æ‰€æœ‰å®šæ—¶å™¨çš„æ€»ç»è¿‡æ—¶é—´å†åŠ ä¸Šè‡ªå·±çš„å»¶è¿Ÿæ—¶é—´ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…å®šæ—¶å™¨çš„åµŒå¥—ã€‚ ä½¿ç”¨æ–¹å¼ä½¿ç”¨ä¹‹å‰å…ˆè°ƒç”¨ TimerUtils.Init() æ¥åˆå§‹åŒ–ï¼Œç»“æŸä¹‹åŽè°ƒç”¨ TimerUtils.Stop() æ¥ç»“æŸã€‚ è°ƒç”¨å®šæ—¶å™¨çš„æ–¹å¼åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯åŒæ­¥ä»»åŠ¡ï¼Œä¸€ç§æ˜¯å¼‚æ­¥ä»»åŠ¡ã€‚ç”±äºŽ Unity å¯¹è±¡åªæœ‰åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰èƒ½è®¿é—®ï¼Œå› æ­¤å¦‚æžœè¦å»¶è¿Ÿæ“ä½œ Unity å¯¹è±¡çš„è¯å°±éœ€è¦ç”¨åŒæ­¥ä»»åŠ¡ï¼Œå…¶ä»–æƒ…å†µå¯ä»¥é€‰æ‹©å¼‚æ­¥è°ƒç”¨ï¼Œæ ¹æ®éœ€æ±‚å³å¯ã€‚ å»¶è¿Ÿæ‰§è¡Œï¼šTimerChain Once(int delay, Action action)ä¸‹é¢çš„ä¾‹å­æ˜¯å»¶è¿Ÿä¸€ç§’åŽæ‰“å°æ¶ˆæ¯åˆ°æŽ§åˆ¶å°ã€‚ 1234TimerUtils.Once(1000, () =&gt;&#123; ConsoleUtils.Log(&quot;æ‰§è¡Œ&quot;, DateTime.Now, chain.GetId());&#125;); å¾ªçŽ¯æ‰§è¡Œï¼šTimerChain Loop(int interval, Action action, int delay = 0, int loopTimes = -1)ä¸‹é¢çš„ä¾‹å­æ˜¯å¾ªçŽ¯ä¸‰æ¬¡ï¼Œæ¯æ¬¡ 1 ç§’é—´éš”ï¼Œå»¶è¿Ÿæ—¶é—´ä¸º 0ï¼Œä¸ä¼ å…¥å¾ªçŽ¯æ¬¡æ•°å°±æ˜¯æ— é™å¾ªçŽ¯ã€‚ 1234TimerUtils.Loop(1000, () =&gt;&#123; ConsoleUtils.Log(&quot;å¾ªçŽ¯&quot;, DateTime.Now);&#125;, 0, 3); æ¸…é™¤å®šæ—¶å™¨ 12345678TimerChain chain = TimerUtils.Loop(1000, () =&gt;&#123; ConsoleUtils.Log(&quot;å¾ªçŽ¯&quot;, DateTime.Now);&#125;, 0, 3);//æ¸…é™¤å®šæ—¶å™¨chain.Clear();//æˆ–è€…ç”¨ä¸‹é¢çš„æ–¹å¼ï¼Œä¸¤ç§éƒ½ä¸€æ ·TimerUtils.Clear(chain); é“¾å¼è°ƒç”¨ 1234567TimerUtils.Loop(1000, () =&gt;&#123; ConsoleUtils.Log(&quot;å¾ªçŽ¯&quot;, DateTime.Now);&#125;, 0, 3).Once(5000, () =&gt;&#123; ConsoleUtils.Log(&quot;ç­‰å¾…&quot;, DateTime.Now);&#125;); å¼‚æ­¥çš„è°ƒç”¨å’ŒåŒæ­¥çš„ä¸€æ ·ï¼Œåªæ˜¯å‡½æ•°åä¸åŒï¼ˆå¸¦ Asyncï¼‰ã€‚ ä»£ç TimerTask123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172using System;using System.Threading.Tasks;public class TimerTask&#123; public int id; public int delay; public int interval; public int loopTimes; public Action action; public DateTime dateTime; public TimerType type; public bool isRemove; public TimerTask(int id, int interval, Action action, int loopTimes, int delay, TimerType type) &#123; this.id = id; this.interval = interval; this.action = action; this.loopTimes = loopTimes; this.delay = delay; this.type = type; isRemove = false; dateTime = DateTime.Now.AddMilliseconds(interval + delay); &#125; public void Run() &#123; if (type == TimerType.Sync) &#123; TimerUtils.AddAction(id, action); &#125; else &#123; RunAsync(); &#125; &#125; public async Task RunAsync() &#123; await Task.Run(() =&gt; &#123; action.Invoke(); &#125;); &#125; public bool CheckLoop() &#123; if (isRemove) &#123; return false; &#125; if (loopTimes &lt; 0) &#123; dateTime = DateTime.Now.AddMilliseconds(interval); return true; &#125; else &#123; loopTimes--; dateTime = DateTime.Now.AddMilliseconds(interval); return loopTimes &gt; 0; &#125; &#125;&#125; TimerChain12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758using System;public class TimerChain&#123; private TimeWheel _timeWheel; //private int _id = -1; private TimerTask _task; private int _delay = 0; public TimerChain(TimeWheel wheel) &#123; _timeWheel = wheel; &#125; public TimerChain Once(int delay, Action action) &#123; _task = _timeWheel.SetTimeout(_task != null ? _task.id : -1, delay + _delay, action); _delay = delay; return this; &#125; public TimerChain Loop(int interval, Action action, int delay = 0, int loopTimes = -1) &#123; _task = _timeWheel.SetInterval(_task != null ? _task != null ? _task.id : -1 : -1, interval, action, delay + _delay, loopTimes); ; _delay = interval * loopTimes + delay; return this; &#125; public TimerChain OnceAsync(int delay, Action action) &#123; _task = _timeWheel.SetTimeoutAsync(_task != null ? _task.id : -1, delay + _delay, action); _delay = delay; return this; &#125; public TimerChain LoopAsync(int interval, Action action, int delay = 0, int loopTimes = -1) &#123; _task = _timeWheel.SetIntervalAsync(_task != null ? _task.id : -1, interval, action, delay + _delay, loopTimes); _delay = interval * loopTimes + delay; return this; &#125; public TimerChain Clear() &#123; _task.isRemove = true; _timeWheel.ClearInterval(_task != null ? _task.id : -1, true); //ConsoleUtils.Log(&quot;æ¸…é™¤ä»»åŠ¡Chain&quot;, _task.id); return this; &#125; public int GetId() &#123; return _task != null ? _task.id : -1; &#125;&#125; TimerUtils12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697using System;using System.Threading;using UnityEngine;public class TimerUtils&#123; private static TimeWheel _timeWheel; private static Thread _thread; private static bool _isRunning = false; private static TimerScript _timerScript; public static void Init() &#123; _timeWheel = new TimeWheel(); _isRunning = true; _thread = new Thread(Update); _thread.Start(); GameObject obj = new GameObject(); obj.name = &quot;TimerUtils&quot;; _timerScript = obj.AddComponent&lt;TimerScript&gt;(); &#125; public static void Stop() &#123; _isRunning = false; //_thread.Abort(); &#125; private static void Update() &#123; while (_isRunning) &#123; _timeWheel.Update(); &#125; &#125; /// &lt;summary&gt; /// åŒæ­¥å®šæ—¶å™¨ /// &lt;/summary&gt; /// &lt;param name=&quot;delay&quot;&gt;å»¶æ—¶ å•ä½æ¯«ç§’&lt;/param&gt; /// &lt;param name=&quot;action&quot;&gt;è¡Œä¸º&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public static TimerChain Once(int delay, Action action) &#123; return new TimerChain(_timeWheel).Once(delay, action); &#125; /// &lt;summary&gt; /// åŒæ­¥å¾ªçŽ¯ ç¬¬ä¸€æ¬¡è§¦å‘æ—¶é—´ä¸º interval + delay /// &lt;/summary&gt; /// &lt;param name=&quot;interval&quot;&gt;å¾ªçŽ¯é—´éš”æ—¶é—´&lt;/param&gt; /// &lt;param name=&quot;action&quot;&gt;è¡Œä¸º&lt;/param&gt; /// &lt;param name=&quot;delay&quot;&gt;å»¶æ—¶&lt;/param&gt; /// &lt;param name=&quot;loopTimes&quot;&gt;å¾ªçŽ¯æ¬¡æ•° é»˜è®¤ä¸º-1 æ— é™å¾ªçŽ¯&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public static TimerChain Loop(int interval, Action action, int delay = 0, int loopTimes = -1) &#123; return new TimerChain(_timeWheel).Loop(interval, action, delay, loopTimes); &#125; /// &lt;summary&gt; /// å¼‚æ­¥å®šæ—¶å™¨ /// &lt;/summary&gt; /// &lt;param name=&quot;delay&quot;&gt;å»¶æ—¶ å•ä½æ¯«ç§’&lt;/param&gt; /// &lt;param name=&quot;action&quot;&gt;è¡Œä¸º&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public static TimerChain OnceAsync(int delay, Action action) &#123; return new TimerChain(_timeWheel).OnceAsync(delay, action); &#125; /// &lt;summary&gt; /// å¼‚æ­¥å¾ªçŽ¯ ç¬¬ä¸€æ¬¡è§¦å‘æ—¶é—´ä¸º interval + delay /// &lt;/summary&gt; /// &lt;param name=&quot;interval&quot;&gt;å¾ªçŽ¯é—´éš”æ—¶é—´&lt;/param&gt; /// &lt;param name=&quot;action&quot;&gt;è¡Œä¸º&lt;/param&gt; /// &lt;param name=&quot;delay&quot;&gt;å»¶æ—¶&lt;/param&gt; /// &lt;param name=&quot;loopTimes&quot;&gt;å¾ªçŽ¯æ¬¡æ•° é»˜è®¤ä¸º-1 æ— é™å¾ªçŽ¯&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public static TimerChain LoopAsync(int interval, Action action, int delay = 0, int loopTimes = -1) &#123; return new TimerChain(_timeWheel).LoopAsync(interval, action, delay, loopTimes); &#125; public static TimerChain Clear(TimerChain chain) &#123; chain.Clear(); return chain; &#125; public static void AddAction(int id, Action action) &#123; _timerScript.AddAction(id, action); &#125;&#125; TimeWheel123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269using System;using System.Collections.Generic;using System.Linq;public class TimeWheel&#123; private Dictionary&lt;int, LinkedList&lt;TimerTask&gt;&gt; _month = new Dictionary&lt;int, LinkedList&lt;TimerTask&gt;&gt;(); private Dictionary&lt;int, LinkedList&lt;TimerTask&gt;&gt; _day = new Dictionary&lt;int, LinkedList&lt;TimerTask&gt;&gt;(); private Dictionary&lt;int, LinkedList&lt;TimerTask&gt;&gt; _hour = new Dictionary&lt;int, LinkedList&lt;TimerTask&gt;&gt;(); private Dictionary&lt;int, LinkedList&lt;TimerTask&gt;&gt; _minute = new Dictionary&lt;int, LinkedList&lt;TimerTask&gt;&gt;(); private Dictionary&lt;int, LinkedList&lt;TimerTask&gt;&gt; _second = new Dictionary&lt;int, LinkedList&lt;TimerTask&gt;&gt;(); private Dictionary&lt;int, LinkedList&lt;TimerTask&gt;&gt; _millisecond = new Dictionary&lt;int, LinkedList&lt;TimerTask&gt;&gt;(); //private long _curTime = 0; private int _id = 0; private object _lock = new object(); public TimeWheel() &#123; ConsoleUtils.Log(DateTime.Now); for (int i = 0; i &lt; 13; i++) &#123; _month.Add(i, new LinkedList&lt;TimerTask&gt;()); &#125; for (int i = 0; i &lt; 31; i++) &#123; _day.Add(i, new LinkedList&lt;TimerTask&gt;()); &#125; for (int i = 0; i &lt; 24; i++) &#123; _hour.Add(i, new LinkedList&lt;TimerTask&gt;()); &#125; for (int i = 0; i &lt; 60; i++) &#123; _minute.Add(i, new LinkedList&lt;TimerTask&gt;()); &#125; for (int i = 0; i &lt; 60; i++) &#123; _second.Add(i, new LinkedList&lt;TimerTask&gt;()); &#125; //æ¯«ç§’çº§ç²’åº¦ä¸º50ms for (int i = 0; i &lt; 20; i++) &#123; _millisecond.Add(i, new LinkedList&lt;TimerTask&gt;()); &#125; &#125; public void Update() &#123; lock (_lock) &#123; DateTime now = DateTime.Now; LinkedList&lt;TimerTask&gt; month = _month[now.Month]; LinkedList&lt;TimerTask&gt; day = _day[now.Day]; LinkedList&lt;TimerTask&gt; hour = _hour[now.Hour]; LinkedList&lt;TimerTask&gt; minute = _minute[now.Minute]; LinkedList&lt;TimerTask&gt; second = _second[now.Second]; int milliSecondDelta = now.Millisecond / 50; LinkedList&lt;TimerTask&gt; millisecond = _millisecond[milliSecondDelta]; while (month.Count &gt; 0) &#123; LinkedListNode&lt;TimerTask&gt; node = month.First; month.RemoveFirst(); //æ·»åŠ åˆ°æ—¥è½® _day[node.Value.dateTime.Day].AddLast(node); &#125; while (day.Count &gt; 0) &#123; LinkedListNode&lt;TimerTask&gt; node = day.First; day.RemoveFirst(); //æ·»åŠ åˆ°å°æ—¶è½® _hour[node.Value.dateTime.Hour].AddLast(node); &#125; while (hour.Count &gt; 0) &#123; LinkedListNode&lt;TimerTask&gt; node = hour.First; hour.RemoveFirst(); //æ·»åŠ åˆ°åˆ†è½® _minute[node.Value.dateTime.Minute].AddLast(node); &#125; while (minute.Count &gt; 0) &#123; LinkedListNode&lt;TimerTask&gt; node = minute.First; minute.RemoveFirst(); //æ·»åŠ åˆ°ç§’è½® _second[node.Value.dateTime.Second].AddLast(node); &#125; while (second.Count &gt; 0) &#123; LinkedListNode&lt;TimerTask&gt; node = second.First; second.RemoveFirst(); //æ·»åŠ åˆ°æ¯«ç§’è½® _millisecond[node.Value.dateTime.Millisecond / 50].AddLast(node); &#125; while (millisecond.Count &gt; 0) &#123; //LinkedListNode&lt;TimerTask&gt; node = second.First; //second.RemoveFirst(); ////æ·»åŠ åˆ°æ¯«ç§’è½® //_millisecond[node.Value.dateTime.Millisecond / 50].AddLast(node); foreach (var task in millisecond.ToList()) &#123; if (task != null &amp;&amp; DateTime.Now &gt;= task.dateTime) &#123; millisecond.Remove(task); //ConsoleUtils.Log(&quot;æ‰§è¡Œä»»åŠ¡&quot;, task.id); //task.RunAsync(); task.Run(); if (task.CheckLoop()) &#123; AddTask(task); &#125; &#125; &#125; &#125; &#125; &#125; public TimerTask SetInterval(int id, int interval, Action action, int delay, int loopTimes, bool isRemove = false) &#123; if (id == -1) &#123; id = GetId(); &#125; TimerTask task = new TimerTask(id, interval, action, loopTimes, delay, TimerType.Sync); AddTask(task); return task; &#125; public TimerTask SetTimeout(int id, int delay, Action action) &#123; if (id == -1) &#123; id = GetId(); &#125; TimerTask task = new TimerTask(id, 0, action, 1, delay, TimerType.Sync); AddTask(task); return task; &#125; public TimerTask SetIntervalAsync(int id, int interval, Action action, int delay, int loopTimes) &#123; if (id == -1) &#123; id = GetId(); &#125; TimerTask task = new TimerTask(id, interval, action, loopTimes, delay, TimerType.Async); AddTask(task); return task; &#125; public TimerTask SetTimeoutAsync(int id, int delay, Action action) &#123; if (id == -1) &#123; id = GetId(); &#125; TimerTask task = new TimerTask(id, 0, action, 1, delay, TimerType.Async); AddTask(task); return task; &#125; public void ClearInterval(int id, bool isAll = false) &#123; if (isAll) &#123; RemoveTask(_month, id, isAll); RemoveTask(_day, id, isAll); RemoveTask(_hour, id, isAll); RemoveTask(_minute, id, isAll); RemoveTask(_second, id, isAll); RemoveTask(_millisecond, id, isAll); &#125; else &#123; if (RemoveTask(_month, id)) &#123; return; &#125; if (RemoveTask(_day, id)) &#123; return; &#125; if (RemoveTask(_hour, id)) &#123; return; &#125; if (RemoveTask(_minute, id)) &#123; return; &#125; if (RemoveTask(_second, id)) &#123; return; &#125; if (RemoveTask(_millisecond, id)) &#123; return; &#125; &#125; &#125; private void AddTask(TimerTask task) &#123; _month[task.dateTime.Month].AddLast(task); &#125; private bool RemoveTask(Dictionary&lt;int, LinkedList&lt;TimerTask&gt;&gt; wheel, int id, bool isAll = false) &#123; if (isAll) &#123; bool res = false; foreach (var item in wheel) &#123; LinkedList&lt;TimerTask&gt; tasks = item.Value; foreach (var task in tasks.ToList()) &#123; if (task.id == id) &#123; //ConsoleUtils.Log(&quot;æ¸…é™¤ä»»åŠ¡&quot;, task.id, task.isRemove); tasks.Remove(task); res = true; &#125; &#125; &#125; return res; &#125; else &#123; foreach (var item in wheel) &#123; LinkedList&lt;TimerTask&gt; tasks = item.Value; foreach (var task in tasks) &#123; if (task.id == id) &#123; tasks.Remove(task); return true; &#125; &#125; &#125; return false; &#125; &#125; private int GetId() &#123; return _id++; &#125;&#125; TimerScript12345678910111213141516171819202122232425262728293031323334using System;using System.Collections.Generic;using UnityEngine;public class TimerScript : MonoBehaviour&#123; private Queue&lt;(int, Action)&gt; _actions = new Queue&lt;(int, Action)&gt;(); private Dictionary&lt;int, bool&gt; _register = new Dictionary&lt;int, bool&gt;(); void Update() &#123; while (_actions.Count &gt; 0) &#123; (int, Action) item = _actions.Dequeue(); Run(item.Item2); _register.Remove(item.Item1); &#125; &#125; public void AddAction(int id, Action action) &#123; if (!_register.ContainsKey(id)) &#123; _actions.Enqueue((id, action)); _register.Add(id, true); &#125; &#125; private void Run(Action action) &#123; action.Invoke(); &#125;&#125; æ›´æ–°æ—¥å¿—2023-12-20 ä¿®å¤ bug 2023-12-20 æ›´æ–°åŸºç¡€ç‰ˆæœ¬ã€‚","categories":[{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/categories/Unity/"},{"name":"å·¥å…·","slug":"Unity/å·¥å…·","permalink":"https://busyogg.github.io/categories/Unity/%E5%B7%A5%E5%85%B7/"}],"tags":[{"name":"C#","slug":"C","permalink":"https://busyogg.github.io/tags/C/"},{"name":"å·¥å…·ç±»","slug":"å·¥å…·ç±»","permalink":"https://busyogg.github.io/tags/%E5%B7%A5%E5%85%B7%E7%B1%BB/"},{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/tags/Unity/"}]},{"title":"Unityç¼–è¾‘å™¨æ‹“å±•-è‡ªå®šä¹‰Monoè„šæœ¬Inspector","slug":"Unityç¼–è¾‘å™¨æ‹“å±•-è‡ªå®šä¹‰Monoè„šæœ¬Inspector","date":"2023-11-28T19:03:01.000Z","updated":"2024-05-18T15:36:49.319Z","comments":true,"path":"article/5b49262a8f1d/","link":"","permalink":"https://busyogg.github.io/article/5b49262a8f1d/","excerpt":"","text":"ç®€ä»‹æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦åœ¨æŸä¸ªåŠŸèƒ½å¼€å¯çš„æƒ…å†µä¸‹ç¼–è¾‘ä¸€äº›å‚æ•°ï¼Œè¿™æ—¶å€™å°±å¯ä»¥è‡ªå®šä¹‰ Inspector é¢æ¿çš„æ˜¾ç¤ºé€»è¾‘æ¥å®žçŽ°è¿™ä¸€éœ€æ±‚ã€‚ åŽŸç†Unity æä¾›è‡ªå®šä¹‰ç¼–è¾‘å™¨çš„åŠŸèƒ½ï¼Œé€šè¿‡ä½¿ç”¨å±žæ€§æ ‡ç­¾[CustomEditor(typeof(CustomClass))]å®šä¹‰ä¸€ä¸ªç¼–è¾‘å™¨ç±»æ¥è‡ªå®šä¹‰æˆ‘ä»¬éœ€è¦çš„ Inspector æ˜¾ç¤ºã€‚å¦‚æžœéœ€è¦å¤šé€‰ç¼–è¾‘çš„è¯ï¼Œåªè¦å†åŠ ä¸€ä¸ªå±žæ€§æ ‡ç­¾[CanEditMultipleObjects]å³å¯ã€‚ å®žçŽ°æˆ‘ä»¬éœ€è¦ä¸€ä¸ªåŽŸå§‹çš„ MonoBehaviour ç±»ï¼Œä»¥åŠä¸€ä¸ªæ´¾ç”Ÿ Editor çš„ç±»ï¼Œå³æˆ‘ä»¬è‡ªå®šä¹‰ä¿®æ”¹æŸä¸€ MonoBehaviour ç±»æ˜¾ç¤ºé¢æ¿çš„ç±»ã€‚ å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª MonoBehaviour ç±»å¦‚ä¸‹ï¼š MonoBehaviourç±»123456using UnityEngine;public class Test : MonoBehaviour&#123; public bool _isShow = false; public int _initNum = 0;&#125; æˆ‘ä»¬è¦å®žçŽ°å¦‚ä¸‹éœ€æ±‚ï¼šå½“_isShow ä¸º true çš„æ—¶å€™åœ¨é¢æ¿ä¸Šæ˜¾ç¤º_initNumã€‚ æˆ‘ä»¬éœ€è¦è¿™æ ·ä¸€ä¸ª Editor ç±»ï¼š 12345678910111213141516171819using UnityEditor;[CustomEditor(typeof(Test))][CanEditMultipleObjects]public class TestEditor : Editor&#123; public override void OnInspectorGUI() &#123; Test test = (Test)target; test._isShow = EditorGUILayout.Toggle(&quot;æ˜¯å¦æ˜¾ç¤º&quot;, test._isShow); if(test._isShow) &#123; EditorGUI.indentLevel++; test._initNum = EditorGUILayout.IntField(&quot;InitNum&quot;, test._initNum); EditorGUI.indentLevel--; &#125; &#125;&#125; Editor ç±»çš„ç¼–å†™æ–¹å¼å’Œæ™®é€šçš„ Editor æ‹“å±•ä¸€æ ·ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æ²¡æœ‰å†™çš„å±žæ€§ä¹Ÿä¸ä¼šå‡ºçŽ°åœ¨ Inspector ä¸­ï¼Œè¿™ä¸ªç±»ç›¸å½“äºŽå®Œå…¨æŽ¥ç®¡åŽŸæ¥çš„é¢æ¿æ˜¾ç¤ºé€»è¾‘ã€‚ ä¸ºäº†æ›´å¥½åˆ†è¾¨é¢æ¿å±žæ€§å±‚çº§ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨EditorGUI.indentLevelæ¥ç¼©è¿›ã€‚æˆ–è€…ä½¿ç”¨EditorGUILayout.Space()ï¼Œæ ¹æ®å…·ä½“æƒ…å†µå³å¯ã€‚ å½“ç„¶ï¼Œæ˜¾ç¤ºå±žæ€§çš„æ–¹æ³•ä¹Ÿå¯ä»¥å’Œå®˜æ–¹æ–‡æ¡£ä¸€æ ·ã€‚å…·ä½“ç›´æŽ¥çœ‹å®˜æ–¹æ–‡æ¡£å³å¯ã€‚","categories":[{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/categories/Unity/"},{"name":"ç¼–è¾‘å™¨","slug":"Unity/ç¼–è¾‘å™¨","permalink":"https://busyogg.github.io/categories/Unity/%E7%BC%96%E8%BE%91%E5%99%A8/"}],"tags":[{"name":"C#","slug":"C","permalink":"https://busyogg.github.io/tags/C/"},{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/tags/Unity/"},{"name":"ç¼–è¾‘å™¨","slug":"ç¼–è¾‘å™¨","permalink":"https://busyogg.github.io/tags/%E7%BC%96%E8%BE%91%E5%99%A8/"}]},{"title":"çº¢ç‚¹ç³»ç»Ÿ","slug":"çº¢ç‚¹ç³»ç»Ÿ","date":"2023-11-09T07:43:02.000Z","updated":"2024-05-18T15:40:07.308Z","comments":true,"path":"article/5daef1721d9d/","link":"","permalink":"https://busyogg.github.io/article/5daef1721d9d/","excerpt":"","text":"ç®€ä»‹æ¸¸æˆä¸­ç»å¸¸ä¼šéœ€è¦çº¢ç‚¹æ¥æé†’çŽ©å®¶æœ‰æ–°å†…å®¹ï¼Œæ¯ä¸ªéƒ¨åˆ†å•ç‹¬æŽ§åˆ¶çº¢ç‚¹æ˜¾ç„¶ä¸æ˜¯ä¸ªå¥½åŠžæ³•ï¼Œå› æ­¤éœ€è¦çº¢ç‚¹ç³»ç»Ÿæ¥ç»Ÿä¸€ç®¡ç†çº¢ç‚¹ã€‚ åŽŸç†æ‰€æœ‰çº¢ç‚¹æ ¹æ®å±‚çº§å…³ç³»ç»„ç»‡æˆçº¢ç‚¹æ ‘ï¼Œæ¯æ¬¡æœ‰æ•°æ®å˜åŒ–å°±ä»Žçº¢ç‚¹æ ‘çš„å¶å­ç»“ç‚¹å¼€å§‹å‘ä¸Šæ›´æ–°ã€‚ çº¢ç‚¹æ ‘å±žæ€§çº¢ç‚¹æ•°æœ‰_children æ¥ä¿å­˜æ‰€æœ‰ä¸‹å±žèŠ‚ç‚¹ï¼Œæœ‰_parent æ¥å›žæº¯ä¸Šæ¸¸èŠ‚ç‚¹ï¼Œå¹¶ä¸”æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰_path æ¥è®°å½•çº¢ç‚¹åœ¨çº¢ç‚¹æ ‘ä¸­çš„è·¯å¾„ã€‚ _dotNum è¡¨ç¤ºå½“å‰çº¢ç‚¹èŠ‚ç‚¹çš„æ•°æ®ï¼Œ_isShow ç”¨æ¥æŽ§åˆ¶å½“å‰çº¢ç‚¹èŠ‚ç‚¹æ˜¯å¦éœ€è¦æ˜¾ç¤ºçº¢ç‚¹ã€‚ çº¢ç‚¹_type åˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ç±»æ˜¯ Eternalï¼Œåªæœ‰çº¢ç‚¹æ•°é‡å½’é›¶çš„æ—¶å€™æ‰ä¸æ˜¾ç¤ºï¼›ä¸€ç±»æ˜¯ Onceï¼Œä¸€æ—¦çº¢ç‚¹æ•°é‡å˜å°‘å°±ä¸å†æ˜¾ç¤ºã€‚ å½“çº¢ç‚¹æ•°é‡å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ä¼šè°ƒç”¨_onRedDotChangedCallback æ–¹æ³•æ‰§è¡Œå¯¹åº”çš„æ“ä½œã€‚ 1234567891011121314151617181920212223export enum RedDotType &#123; Eternal, Once,&#125;export default class RedDot &#123; /** çˆ¶èŠ‚ç‚¹ */ private _parent: RedDot | null; /** å­èŠ‚ç‚¹ */ private _children; /** çº¢ç‚¹èŠ‚ç‚¹è·¯å¾„ */ public _path: string; /** çº¢ç‚¹æ•°é‡ */ private _dotNum; /** æ˜¯å¦å±•ç¤ºçº¢ç‚¹ */ private _isShow; /** çº¢ç‚¹ç±»åž‹ */ private _type: RedDotType; private _onRedDotChangedCallback: Function | null; //----- function start -----&#125; æ–¹æ³•æ·»åŠ çº¢ç‚¹å­èŠ‚ç‚¹å…ˆèŽ·å–éœ€è¦æ·»åŠ çš„çº¢ç‚¹èŠ‚ç‚¹çš„è·¯å¾„ï¼Œåˆ¤æ–­æ˜¯å¦å·²æ·»åŠ ã€‚æœªæ·»åŠ çš„æƒ…å†µä¸‹æˆ‘ä»¬è®¾ç½®å½“å‰çº¢ç‚¹èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ä¸ºéœ€è¦æ·»åŠ çš„èŠ‚ç‚¹ï¼Œè®¾ç½®éœ€è¦æ·»åŠ èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä¸ºå½“å‰èŠ‚ç‚¹ï¼Œå¹¶ä¸”èµ°ä¸€éçº¢ç‚¹å˜åŒ–çš„é€»è¾‘ï¼Œé˜²æ­¢å‡ºçŽ° bugã€‚ 12345678910111213141516171819/** * æ·»åŠ çº¢ç‚¹å­èŠ‚ç‚¹ * @param child */public addChild(child: RedDot) &#123; let path = child._path; if (!this._children[path]) &#123; this._children[path] = child; child._parent = this; //å­èŠ‚ç‚¹æœ‰å±•ç¤ºçº¢ç‚¹ åˆ™è¯¥èŠ‚ç‚¹å¿…å±•ç¤ºçº¢ç‚¹ if (child._isShow) &#123; this._isShow = true; &#125; //æ”¹å˜çº¢ç‚¹æ•°é‡ this.changeDotNum(child.getDotNum()); &#125; else &#123; console.warn(&quot;çº¢ç‚¹èŠ‚ç‚¹é‡å¤æ·»åŠ ï¼š&quot;, path); &#125;&#125; æ”¹å˜çº¢ç‚¹æ•°é‡é¦–å…ˆæˆ‘ä»¬ä¿å­˜å½“å‰èŠ‚ç‚¹çš„çº¢ç‚¹æ•°é‡ï¼Œç„¶åŽæ ¹æ®ä¼ å…¥çš„å˜åŒ–æ•°é‡å¯¹å½“å‰èŠ‚ç‚¹çº¢ç‚¹æ•°é‡è¿›è¡Œæ”¹å˜ã€‚ æ”¹å˜ä¹‹åŽä¼šå‘ç”Ÿä¸¤ç§æƒ…å†µï¼š çº¢ç‚¹æ•°é‡å°äºŽç­‰äºŽ 0ï¼Œè¿™æ—¶å€™æˆ‘ä»¬ç½®çº¢ç‚¹ä¸ºä¸æ˜¾ç¤ºã€‚ çº¢ç‚¹æ•°é‡å¤§äºŽ 0ï¼Œå¦‚æžœä¼ å…¥çš„å˜åŒ–é‡å¤§äºŽ 0ï¼Œåˆ™çº¢ç‚¹æ˜¾ç¤ºï¼›å¦åˆ™æ ¹æ®çº¢ç‚¹ç±»åž‹åˆ¤æ–­ï¼Œå¦‚æžœæ˜¯ Onceï¼Œåˆ™çº¢ç‚¹æ•°é‡å½’é›¶ï¼Œå¹¶ä¸”ç½®ä¸ºä¸æ˜¾ç¤ºã€‚ å¤„ç†å®Œå½“å‰èŠ‚ç‚¹çš„çº¢ç‚¹æ•°é‡åŽï¼Œæˆ‘ä»¬å›žæº¯çˆ¶èŠ‚ç‚¹ï¼Œå¯¹çˆ¶èŠ‚ç‚¹è¿›è¡ŒåŒæ ·çš„æ“ä½œã€‚ä¸è¿‡ä¼ å…¥çš„å˜åŒ–é‡éœ€è¦æ ¹æ®å½“å‰èŠ‚ç‚¹æ˜¯å¦æ˜¾ç¤ºçº¢ç‚¹æ¥åˆ¤æ–­ï¼Œå¦‚æžœæ˜¯ä¸æ˜¾ç¤ºçº¢ç‚¹ï¼Œåˆ™æˆ‘ä»¬ä¼ å…¥è´Ÿçš„ä¹‹å‰ä¿å­˜çš„èŠ‚ç‚¹çº¢ç‚¹æ•°é‡ï¼›æ˜¾ç¤ºçº¢ç‚¹ï¼Œåˆ™ä¼ å…¥è¯¥æ–¹æ³•ä¼ å…¥çš„å‚æ•°ã€‚ 1234567891011121314151617181920212223242526/** * æ”¹å˜çº¢ç‚¹æ•°é‡ * @param num */public changeDotNum(num: number) &#123; let defDotNum = this._dotNum; this._dotNum += num; //åˆ¤æ–­æ˜¯å¦å±•ç¤ºçº¢ç‚¹ if (this._dotNum &lt;= 0) &#123; this._dotNum = 0; this._isShow = false; &#125; else &#123; if(num &gt; 0)&#123; this._isShow = true; &#125;else&#123; if(this._type == RedDotType.Once)&#123; this._dotNum = 0; this._isShow = false; &#125; &#125; &#125; //è§¦å‘çº¢ç‚¹å˜åŒ–å›žè°ƒ this._onRedDotChangedCallback &amp;&amp; this._onRedDotChangedCallback(this._isShow); //çˆ¶èŠ‚ç‚¹æ”¹å˜çº¢ç‚¹æ•°é‡ this._parent &amp;&amp; this._parent.changeDotNum(this._isShow ? num : -defDotNum);&#125; å…¶ä»–åŸºç¡€åŠŸèƒ½ï¼Œæ ¹æ®å‡½æ•°å†…å®¹å³å¯å¾—çŸ¥ä½œç”¨ã€‚ 1234567891011121314151617181920212223242526272829303132333435/** * èŽ·å¾—æ‰€æœ‰å­èŠ‚ç‚¹ * @returns */public getChildren()&#123; return this._children;&#125;/** * æ˜¯å¦å±•ç¤ºçº¢ç‚¹ * @returns */public checkShow() &#123; this._onRedDotChangedCallback &amp;&amp; this._onRedDotChangedCallback(this._isShow);&#125;/** * èŽ·å¾—çº¢ç‚¹æ•°é‡ * @returns */public getDotNum() &#123; return this._dotNum;&#125;/** * è®¾ç½®çº¢ç‚¹å˜åŒ–å›žè°ƒ * @param callback */public onRedDotChanged(callback) &#123; this._onRedDotChangedCallback = callback;&#125;/** * ç§»é™¤çº¢ç‚¹å˜åŒ–å›žè°ƒ */public removeRedDotChange()&#123; this._onRedDotChangedCallback = null;&#125; çº¢ç‚¹ç®¡ç†ç±»ç®¡ç†ç±»ç»´æŠ¤ä¸€ä¸ªçº¢ç‚¹å­—å…¸_redDotDicï¼Œç”¨äºŽå¿«é€ŸæŸ¥æ‰¾å¯¹åº”è·¯å¾„çš„çº¢ç‚¹ã€‚ åˆå§‹åŒ–åˆå§‹åŒ–ä¸€ä¸ª root çº¢ç‚¹ï¼Œè¯¥çº¢ç‚¹æ˜¯æ‰€æœ‰çº¢ç‚¹çš„æ ¹èŠ‚ç‚¹ã€‚ 12345678/** * åˆå§‹åŒ–çº¢ç‚¹æ ‘ */public init() &#123; let root = new RedDot(null, RedDotType.Eternal); root._path = &quot;root&quot;; this._redDotDic[&quot;root&quot;] = root;&#125; æ³¨å†Œçº¢ç‚¹ç”¨äºŽæ³¨å†Œçº¢ç‚¹çš„æ–¹æ³•ã€‚å…ˆåˆ¤æ–­çº¢ç‚¹æ˜¯å¦å·²æ³¨å†Œï¼Œæœªæ³¨å†Œçš„æƒ…å†µä¸‹æ‰§è¡Œæ³¨å†Œæ–¹æ³•ï¼š è£å‰ªçº¢ç‚¹è·¯å¾„ï¼Œæ ¹æ®â€&#x2F;â€œåˆ†å¼€ã€‚ æ ¹æ®çº¢ç‚¹è·¯å¾„é•¿åº¦å¾ªçŽ¯åˆ¤æ–­æ˜¯å¦æ³¨å†Œè¿‡çº¢ç‚¹ï¼Œæœªæ³¨å†Œåˆ™æ–°å»ºçº¢ç‚¹å¹¶ä¿å­˜åˆ°çº¢ç‚¹å­—å…¸ï¼Œçº¢ç‚¹è·¯å¾„æ¯æ¬¡ä¹Ÿä¼šæ ¹æ®çº¢ç‚¹å±‚çº§æ‹¼æŽ¥ã€‚å¦‚æžœæ–°å»ºçš„çº¢ç‚¹æ˜¯æœ€ç»ˆè·¯å¾„ï¼Œåˆ™è¿”å›žè¯¥çº¢ç‚¹ã€‚ 123456789101112131415161718192021222324252627282930313233/** * æ³¨å†Œçº¢ç‚¹ * @param redDot */public register(path: string, type: RedDotType = RedDotType.Eternal): RedDot &#123; let leaf = this.getRedDot(path); if (!leaf) &#123; let redDotPath = path.split(&quot;/&quot;); let index = 0; let curDic = this._redDotDic[&quot;root&quot;] as RedDot; let subPath = &quot;&quot;; while (index &lt; redDotPath.length) &#123; let child = curDic.getChildren()[redDotPath[index]]; subPath += (index == 0 ? &quot;&quot; : &quot;/&quot;) + redDotPath[index]; if (!child) &#123; let newRedDot = new RedDot(null, type); newRedDot._path = subPath; curDic.addChild(newRedDot); if (index == redDotPath.length - 1) &#123; leaf = newRedDot; &#125; child = newRedDot; this._redDotDic[subPath] = child; &#125; curDic = child; index++; &#125; &#125; return leaf;&#125; å…¶ä»–åŸºç¡€åŠŸèƒ½ï¼Œæ ¹æ®å‡½æ•°å†…å®¹å³å¯å¾—çŸ¥ä½œç”¨ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849/** * æ”¹å˜çº¢ç‚¹æ•°æ® * @param path * @param num */public changeDotNum(path, num) &#123; let redDot = this.getRedDot(path); if (redDot) &#123; redDot.changeDotNum(num); &#125; else &#123; console.warn(&quot;ä¸å­˜åœ¨è¯¥çº¢ç‚¹&quot;, path); &#125;&#125;/** * è®¾ç½®çº¢ç‚¹å›žè°ƒ * @param path * @param callback */public setRedDotCallback(path,callback)&#123; let redDot = this.getRedDot(path); if(redDot)&#123; redDot.onRedDotChanged(callback); &#125;&#125;/** * ç§»é™¤çº¢ç‚¹å›žè°ƒ * @param path */public removeRedDotCallback(path)&#123; let redDot = this.getRedDot(path); if(redDot)&#123; redDot.removeRedDotChange(); &#125;&#125;/** * èŽ·å¾—çº¢ç‚¹ * @param path * @returns */private getRedDot(path: string): RedDot &#123; return this._redDotDic[path];&#125;public getRoot() &#123; return this._redDotDic[&quot;root&quot;];&#125; ä»£ç RedDot123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113import &#123; RedDotType &#125; from &quot;./RedDotManager&quot;;export default class RedDot &#123; /** çˆ¶èŠ‚ç‚¹ */ private _parent: RedDot | null; /** å­èŠ‚ç‚¹ */ private _children; /** çº¢ç‚¹èŠ‚ç‚¹è·¯å¾„ */ public _path: string; /** çº¢ç‚¹æ•°é‡ */ private _dotNum; /** æ˜¯å¦å±•ç¤ºçº¢ç‚¹ */ private _isShow; /** çº¢ç‚¹ç±»åž‹ */ private _type: RedDotType; private _onRedDotChangedCallback: Function | null; public constructor(parent = null, type = RedDotType.Eternal) &#123; this._parent = parent; this._children = &#123;&#125;; this._dotNum = 0; this._isShow = false; this._type = type; &#125; /** * æ·»åŠ çº¢ç‚¹å­èŠ‚ç‚¹ * @param child */ public addChild(child: RedDot) &#123; let path = child._path; if (!this._children[path]) &#123; this._children[path] = child; child._parent = this; //å­èŠ‚ç‚¹æœ‰å±•ç¤ºçº¢ç‚¹ åˆ™è¯¥èŠ‚ç‚¹å¿…å±•ç¤ºçº¢ç‚¹ if (child._isShow) &#123; this._isShow = true; &#125; //æ”¹å˜çº¢ç‚¹æ•°é‡ this.changeDotNum(child.getDotNum()); &#125; else &#123; console.warn(&quot;çº¢ç‚¹èŠ‚ç‚¹é‡å¤æ·»åŠ ï¼š&quot;, path); &#125; &#125; /** * èŽ·å¾—æ‰€æœ‰å­èŠ‚ç‚¹ * @returns */ public getChildren() &#123; return this._children; &#125; /** * æ˜¯å¦å±•ç¤ºçº¢ç‚¹ * @returns */ public checkShow() &#123; this._onRedDotChangedCallback &amp;&amp; this._onRedDotChangedCallback(this._isShow); &#125; /** * æ”¹å˜çº¢ç‚¹æ•°é‡ * @param num */ public changeDotNum(num: number) &#123; let defDotNum = this._dotNum; this._dotNum += num; //åˆ¤æ–­æ˜¯å¦å±•ç¤ºçº¢ç‚¹ if (this._dotNum &lt;= 0) &#123; this._dotNum = 0; this._isShow = false; &#125; else &#123; if (num &gt; 0) &#123; this._isShow = true; &#125; else &#123; if (this._type == RedDotType.Once) &#123; this._dotNum = 0; this._isShow = false; &#125; &#125; &#125; //è§¦å‘çº¢ç‚¹å˜åŒ–å›žè°ƒ this._onRedDotChangedCallback &amp;&amp; this._onRedDotChangedCallback(this._isShow); //çˆ¶èŠ‚ç‚¹æ”¹å˜çº¢ç‚¹æ•°é‡ this._parent &amp;&amp; this._parent.changeDotNum(this._isShow ? num : -defDotNum); &#125; /** * èŽ·å¾—çº¢ç‚¹æ•°é‡ * @returns */ public getDotNum() &#123; return this._dotNum; &#125; /** * è®¾ç½®çº¢ç‚¹å˜åŒ–å›žè°ƒ * @param callback */ public onRedDotChanged(callback) &#123; this._onRedDotChangedCallback = callback; &#125; /** * ç§»é™¤çº¢ç‚¹å˜åŒ–å›žè°ƒ */ public removeRedDotChange() &#123; this._onRedDotChangedCallback = null; &#125;&#125; RedDotManager123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111import RedDot from &quot;./RedDot&quot;;export enum RedDotType &#123; Eternal, Once,&#125;export default class RedDotManager &#123; private static _instance: RedDotManager | null = null; /** çº¢ç‚¹å­—å…¸ */ private _redDotDic = &#123;&#125;; public static getInst(): RedDotManager &#123; if (!this._instance) &#123; this._instance = new RedDotManager(); &#125; return this._instance; &#125; /** * åˆå§‹åŒ–çº¢ç‚¹æ ‘ */ public init() &#123; let root = new RedDot(null, RedDotType.Eternal); root._path = &quot;root&quot;; this._redDotDic[&quot;root&quot;] = root; &#125; /** * æ³¨å†Œçº¢ç‚¹ * @param redDot */ public register(path: string, type: RedDotType = RedDotType.Eternal): RedDot &#123; let leaf = this.getRedDot(path); if (!leaf) &#123; let redDotPath = path.split(&quot;/&quot;); let index = 0; let curDic = this._redDotDic[&quot;root&quot;] as RedDot; let subPath = &quot;&quot;; while (index &lt; redDotPath.length) &#123; let child = curDic.getChildren()[redDotPath[index]]; subPath += (index == 0 ? &quot;&quot; : &quot;/&quot;) + redDotPath[index]; if (!child) &#123; let newRedDot = new RedDot(null, type); newRedDot._path = subPath; curDic.addChild(newRedDot); if (index == redDotPath.length - 1) &#123; leaf = newRedDot; &#125; child = newRedDot; this._redDotDic[subPath] = child; &#125; curDic = child; index++; &#125; &#125; return leaf; &#125; /** * æ”¹å˜çº¢ç‚¹æ•°æ® * @param path * @param num */ public changeDotNum(path, num) &#123; let redDot = this.getRedDot(path); if (redDot) &#123; redDot.changeDotNum(num); &#125; else &#123; console.warn(&quot;ä¸å­˜åœ¨è¯¥çº¢ç‚¹&quot;, path); &#125; &#125; /** * è®¾ç½®çº¢ç‚¹å›žè°ƒ * @param path * @param callback */ public setRedDotCallback(path, callback) &#123; let redDot = this.getRedDot(path); if (redDot) &#123; redDot.onRedDotChanged(callback); &#125; &#125; /** * ç§»é™¤çº¢ç‚¹å›žè°ƒ * @param path */ public removeRedDotCallback(path) &#123; let redDot = this.getRedDot(path); if (redDot) &#123; redDot.removeRedDotChange(); &#125; &#125; /** * èŽ·å¾—çº¢ç‚¹ * @param path * @returns */ private getRedDot(path: string): RedDot &#123; return this._redDotDic[path]; &#125; public getRoot() &#123; return this._redDotDic[&quot;root&quot;]; &#125;&#125;","categories":[{"name":"Laya","slug":"Laya","permalink":"https://busyogg.github.io/categories/Laya/"},{"name":"å·¥å…·","slug":"Laya/å·¥å…·","permalink":"https://busyogg.github.io/categories/Laya/%E5%B7%A5%E5%85%B7/"}],"tags":[{"name":"Laya","slug":"Laya","permalink":"https://busyogg.github.io/tags/Laya/"},{"name":"å·¥å…·ç±»","slug":"å·¥å…·ç±»","permalink":"https://busyogg.github.io/tags/%E5%B7%A5%E5%85%B7%E7%B1%BB/"},{"name":"ç³»ç»Ÿæž¶æž„","slug":"ç³»ç»Ÿæž¶æž„","permalink":"https://busyogg.github.io/tags/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/"},{"name":"Typescript","slug":"Typescript","permalink":"https://busyogg.github.io/tags/Typescript/"}]},{"title":"ä»»åŠ¡ç³»ç»Ÿ","slug":"ä»»åŠ¡ç³»ç»Ÿ","date":"2023-11-07T12:41:52.000Z","updated":"2024-05-30T12:26:57.400Z","comments":true,"path":"article/bcdc7baf0eb9/","link":"","permalink":"https://busyogg.github.io/article/bcdc7baf0eb9/","excerpt":"","text":"ç®€ä»‹åŸºäºŽä»»åŠ¡æ ‘çš„ä»»åŠ¡ç³»ç»Ÿï¼Œæ”¯æŒæ™®é€šä»»åŠ¡ã€åˆ†æ”¯ä»»åŠ¡ï¼Œä¸€ä¸ªç³»åˆ—ä»»åŠ¡ä»¥æ ‘çš„å½¢å¼ä¿å­˜ã€‚ä»»åŠ¡æ”¯æŒå¤šéœ€æ±‚ã€å¤šå¥–åŠ±ã€‚ä»»åŠ¡è¿›åº¦æ”¯æŒä»»åŠ¡å¼€å¯åŽç»Ÿè®¡å’Œé¢„ç»Ÿè®¡ã€‚ åŽç»­ä¼šæ›´æ–°å…¶ä»–åŠŸèƒ½ã€‚ æ¼”ç¤º åŽŸç†ä»»åŠ¡ç®¡ç†ç±»è®¾ç½®ä¸‰ä¸ªå­—å…¸_lockedMissionã€_unlockedMissionã€_doneMissionæ¥ä¿å­˜æœªè§£é”ä»»åŠ¡ï¼Œå·²è§£é”ä»»åŠ¡å’Œå·²å®Œæˆä»»åŠ¡ã€‚ ä»»åŠ¡æ•°æ®ç»“æž„ ä»»åŠ¡æ ‘è‡ªèº«ä¸Žä¹‹é—´çš„ç»“æž„å¦‚å›¾æ‰€ç¤ºã€‚ ä¸åŒä»»åŠ¡ä»¥æ ‘çš„å½¢å¼é“¾æŽ¥ï¼Œå•ä¸ªä»»åŠ¡ä»¥é“¾è¡¨çš„å½¢å¼é“¾æŽ¥ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091using System.Collections.Generic;using UnityEngine;public class MissionTree&#123; /// &lt;summary&gt; /// ä»»åŠ¡æ­¥éª¤id /// &lt;/summary&gt; public int id &#123; get; set; &#125; /// &lt;summary&gt; /// ä»»åŠ¡id /// &lt;/summary&gt; public int m_id &#123; get; set; &#125; /// &lt;summary&gt; /// ä»»åŠ¡æ ‡é¢˜ /// &lt;/summary&gt; public string title &#123; get; set; &#125; /// &lt;summary&gt; /// ä»»åŠ¡æè¿° /// &lt;/summary&gt; public string describe &#123; get; set; &#125; /// &lt;summary&gt; /// ä»»åŠ¡ç±»åž‹ /// &lt;/summary&gt; public MissionType type &#123; get; set; &#125; /// &lt;summary&gt; /// ä»»åŠ¡ç±»åˆ« /// &lt;/summary&gt; public MissionFilter filter &#123; get; set; &#125; /// &lt;summary&gt; /// ä»»åŠ¡ç›®æ ‡ /// &lt;/summary&gt; public List&lt;int&gt; target &#123; get; set; &#125; /// &lt;summary&gt; /// ä»»åŠ¡ç›®æ ‡æè¿° /// &lt;/summary&gt; public List&lt;string&gt; target_describe &#123; get; set; &#125; /// &lt;summary&gt; /// ä»»åŠ¡ç›®æ ‡æ•°é‡ /// &lt;/summary&gt; public Dictionary&lt;int, float&gt; target_num &#123; get; set; &#125; /// &lt;summary&gt; /// ä»»åŠ¡å®Œæˆæ•°é‡ /// &lt;/summary&gt; public Dictionary&lt;int, float&gt; complete_num &#123; get; set; &#125; /// &lt;summary&gt; /// ä»»åŠ¡å¥–åŠ± /// &lt;/summary&gt; public List&lt;string&gt; award &#123; get; set; &#125; /// &lt;summary&gt; /// ä»»åŠ¡å¥–åŠ±æ•°é‡ /// &lt;/summary&gt; public List&lt;float&gt; award_num &#123; get; set; &#125; /// &lt;summary&gt; /// æ˜¯å¦é¢„ç»Ÿè®¡ /// &lt;/summary&gt; public bool is_pre_count &#123; get; set; &#125; /// &lt;summary&gt; /// ä¸‹ä¸€ä»»åŠ¡ /// &lt;/summary&gt; public MissionTree next &#123; get; set; &#125; /// &lt;summary&gt; /// ä»»åŠ¡è§£é”åˆ—è¡¨ /// &lt;/summary&gt; public List&lt;int&gt; unlock_mission &#123; get; set; &#125; /// &lt;summary&gt; /// ä»»åŠ¡åˆ†æ”¯ /// &lt;/summary&gt; public List&lt;int&gt; branch &#123; get; set; &#125; /// &lt;summary&gt; /// åˆ†æ”¯æ‰€å±žä»»åŠ¡ /// &lt;/summary&gt; public int branch_belong &#123; get; set; &#125; /// &lt;summary&gt; /// æ˜¯å¦ç›´æŽ¥è§£é” /// &lt;/summary&gt; public bool is_pre_unlock &#123; get; set; &#125; public MissionTree() &#123; target = new List&lt;int&gt;(); target_num = new Dictionary&lt;int, float&gt;(); complete_num = new Dictionary&lt;int, float&gt;(); award = new List&lt;string&gt;(); award_num = new List&lt;float&gt;(); unlock_mission = new List&lt;int&gt;(); target_describe = new List&lt;string&gt;(); branch = new List&lt;int&gt;(); &#125;&#125; åˆ¤æ–­ä»»åŠ¡å®Œæˆåˆ¤æ–­ä»»åŠ¡å®Œæˆéœ€è¦åˆ¤æ–­æ‰€æœ‰çš„ä»»åŠ¡ç›®æ ‡å®Œæˆæ•°é‡æ˜¯å¦éƒ½å¤§äºŽç­‰äºŽä»»åŠ¡ç›®æ ‡éœ€æ±‚æ•°é‡ã€‚è¿™é‡Œæˆ‘ä»¬éåŽ†ä»»åŠ¡ç›®æ ‡ï¼Œåªè¦æœ‰ä¸€ä¸ªç›®æ ‡æ•°é‡ä¸è¾¾æ ‡å°±å¯ä»¥åˆ¤æ–­ä»»åŠ¡æœªå®Œæˆã€‚ 123456789101112131415161718192021222324252627/// &lt;summary&gt;/// æ£€æµ‹ä»»åŠ¡æ˜¯å¦å®Œæˆ/// &lt;/summary&gt;/// &lt;param name=&quot;missionId&quot;&gt;&lt;/param&gt;/// &lt;returns&gt;&lt;/returns&gt;public bool CheckComplete(MissionTree mission)&#123; for (int i = 0, len = mission.target.Count; i &lt; len; i++) &#123; int target = mission.target[i]; if (mission.is_pre_count) &#123; if (mission.target_num[target] &gt; _preCount[target]) &#123; return false; &#125; &#125; else &#123; if (mission.complete_num.Count == 0 || mission.target_num[target] &gt; mission.complete_num[target]) &#123; return false; &#125; &#125; &#125; return true;&#125; å¢žåŠ ä»»åŠ¡ç›®æ ‡æ•°é‡ä»»åŠ¡ç›®æ ‡æ•°é‡çš„å¢žåŠ è°ƒç”¨SetCompleteNumæ–¹æ³•ï¼Œé»˜è®¤æ˜¯ç´¯åŠ æ¨¡å¼ã€‚é¢„ç»Ÿè®¡æ•°é‡çš„å¢žåŠ åˆ™æ˜¯é€šè¿‡RefreshPreCountNumæ–¹æ³•ä¿å­˜æ•°æ®åˆ°_preCountå­—å…¸ä¸­ï¼Œä»¥ä¾›é¢„ç»Ÿè®¡ç±»åž‹ä»»åŠ¡ä½¿ç”¨ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849/// &lt;summary&gt;/// åˆ·æ–°é¢„è®¡æ•°ç±»åž‹ä»»åŠ¡çš„å®Œæˆæ•°é‡/// &lt;/summary&gt;/// &lt;param name=&quot;targetId&quot;&gt;&lt;/param&gt;/// &lt;param name=&quot;num&quot;&gt;&lt;/param&gt;public void RefreshPreCountNum(int targetId, float num, bool isAdd = false)&#123; if (!_preCount.ContainsKey(targetId)) &#123; _preCount.Add(targetId, 0); &#125; if (isAdd) &#123; _preCount[targetId] += num; &#125; else &#123; _preCount[targetId] = num; &#125;&#125;/// &lt;summary&gt;/// è®¾ç½®ä»»åŠ¡å®Œæˆæ•°é‡/// &lt;/summary&gt;/// &lt;param name=&quot;missionId&quot;&gt;&lt;/param&gt;/// &lt;param name=&quot;completeNum&quot;&gt;&lt;/param&gt;/// &lt;param name=&quot;isAdd&quot;&gt;&lt;/param&gt;public void SetCompleteNum(int missionId, int targetId, float completeNum, bool isAdd = true)&#123; MissionTree mission; _unlockedMission.TryGetValue(missionId, out mission); if (mission != null) &#123; if (!mission.complete_num.ContainsKey(targetId)) &#123; mission.complete_num.Add(targetId, 0); &#125; if (isAdd) &#123; mission.complete_num[targetId] += completeNum; &#125; else &#123; mission.complete_num[targetId] = completeNum; &#125; //ä¿å­˜æ•°æ® SaveMissionData(missionId, mission.id, mission.complete_num, false); &#125;&#125; ä¸‹ä¸€ä»»åŠ¡ä»»åŠ¡å®Œæˆçš„æ—¶å€™é™¤äº†æŽ¨è¿›æœ¬ä»»åŠ¡é“¾çš„ä»»åŠ¡ä»¥å¤–ï¼Œè¿˜è¦æ£€æµ‹æ˜¯å¦æœ‰å¯ä»¥è§£é”çš„ä»»åŠ¡ï¼Œå¯ä»¥è§£é”åˆ™æŠŠå…¶ä»Ž_lockedMissionè½¬ç§»åˆ°_unlockedMissionï¼Œä»»åŠ¡é“¾å®Œæˆåˆ™è½¬ç§»åˆ°_doneMissionã€‚åœ¨å®Œæˆä»»åŠ¡çš„æ—¶å€™ï¼Œè°ƒç”¨å¥–åŠ±æ–¹æ³•æ¥å‘æ”¾å¥–åŠ±ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253public void Next(MissionTree mission)&#123; //MissionTree mission = _unlockedMission[missionId]; int missionId = mission.m_id; MissionTree next = mission.next; if (next != null) &#123; if (mission.unlock_mission.Count &gt; 0) &#123; for (int i = 0, len = mission.unlock_mission.Count; i &lt; len; i++) &#123; int id = mission.unlock_mission[i]; MissionTree unlockMission = _lockedMission[id]; _unlockedMission.Add(unlockMission.m_id, unlockMission); _lockedMission.Remove(id); //ä¿å­˜æ•°æ® SaveMissionData(id, unlockMission.id, unlockMission.complete_num, false); &#125; &#125; //ä¸‹ä¸€ä»»åŠ¡ _unlockedMission[missionId] = next; //ä¿å­˜æ•°æ® SaveMissionData(missionId, next.id, next.complete_num, false); &#125; else &#123; _unlockedMission.Remove(missionId); _doneMission.Add(missionId, mission); //ä¿å­˜æ•°æ® SaveMissionData(missionId, mission.id, mission.complete_num, true); &#125; //èŽ·å¾—å¥–åŠ± GetAward(mission); if (mission.filter == MissionFilter.Branch) &#123; bool missionDone = true; foreach (var id in mission.branch) &#123; MissionTree branch = GetUnlockedMissionById(id); if (mission != null) &#123; missionDone = false; break; &#125; &#125; if (!missionDone) &#123; Next(GetUnlockedMissionById(mission.branch_belong)); &#125; &#125;&#125; UIå› ä¸ºä»»åŠ¡é¢æ¿ UI æ˜¯ç®€å•æ‹¼å‡‘ï¼Œå› æ­¤åœ¨æ­¤ä¸åšä»‹ç»ã€‚æœ‰å…³ä»»åŠ¡é¢æ¿æ»šåŠ¨åˆ—è¡¨çš„è¯´æ˜Žè§æ»šåŠ¨åˆ—è¡¨ ä»£ç MissionTree123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990using System.Collections.Generic;using UnityEngine;public class MissionTree&#123; /// &lt;summary&gt; /// ä»»åŠ¡æ­¥éª¤id /// &lt;/summary&gt; public int id &#123; get; set; &#125; /// &lt;summary&gt; /// ä»»åŠ¡id /// &lt;/summary&gt; public int m_id &#123; get; set; &#125; /// &lt;summary&gt; /// ä»»åŠ¡æ ‡é¢˜ /// &lt;/summary&gt; public string title &#123; get; set; &#125; /// &lt;summary&gt; /// ä»»åŠ¡æè¿° /// &lt;/summary&gt; public string describe &#123; get; set; &#125; /// &lt;summary&gt; /// ä»»åŠ¡ç±»åž‹ /// &lt;/summary&gt; public MissionType type &#123; get; set; &#125; /// &lt;summary&gt; /// ä»»åŠ¡ç±»åˆ« /// &lt;/summary&gt; public MissionFilter filter &#123; get; set; &#125; /// &lt;summary&gt; /// ä»»åŠ¡ç›®æ ‡ /// &lt;/summary&gt; public List&lt;int&gt; target &#123; get; set; &#125; /// &lt;summary&gt; /// ä»»åŠ¡ç›®æ ‡æè¿° /// &lt;/summary&gt; public List&lt;string&gt; target_describe &#123; get; set; &#125; /// &lt;summary&gt; /// ä»»åŠ¡ç›®æ ‡æ•°é‡ /// &lt;/summary&gt; public Dictionary&lt;int, float&gt; target_num &#123; get; set; &#125; /// &lt;summary&gt; /// ä»»åŠ¡å®Œæˆæ•°é‡ /// &lt;/summary&gt; public Dictionary&lt;int, float&gt; complete_num &#123; get; set; &#125; /// &lt;summary&gt; /// ä»»åŠ¡å¥–åŠ± /// &lt;/summary&gt; public List&lt;string&gt; award &#123; get; set; &#125; /// &lt;summary&gt; /// ä»»åŠ¡å¥–åŠ±æ•°é‡ /// &lt;/summary&gt; public List&lt;float&gt; award_num &#123; get; set; &#125; /// &lt;summary&gt; /// æ˜¯å¦é¢„ç»Ÿè®¡ /// &lt;/summary&gt; public bool is_pre_count &#123; get; set; &#125; /// &lt;summary&gt; /// ä¸‹ä¸€ä»»åŠ¡ /// &lt;/summary&gt; public MissionTree next &#123; get; set; &#125; /// &lt;summary&gt; /// ä»»åŠ¡è§£é”åˆ—è¡¨ /// &lt;/summary&gt; public List&lt;int&gt; unlock_mission &#123; get; set; &#125; /// &lt;summary&gt; /// ä»»åŠ¡åˆ†æ”¯ /// &lt;/summary&gt; public List&lt;int&gt; branch &#123; get; set; &#125; /// &lt;summary&gt; /// åˆ†æ”¯æ‰€å±žä»»åŠ¡ /// &lt;/summary&gt; public int branch_belong &#123; get; set; &#125; /// &lt;summary&gt; /// æ˜¯å¦ç›´æŽ¥è§£é” /// &lt;/summary&gt; public bool is_pre_unlock &#123; get; set; &#125; public MissionTree() &#123; target = new List&lt;int&gt;(); target_num = new Dictionary&lt;int, float&gt;(); complete_num = new Dictionary&lt;int, float&gt;(); award = new List&lt;string&gt;(); award_num = new List&lt;float&gt;(); unlock_mission = new List&lt;int&gt;(); target_describe = new List&lt;string&gt;(); branch = new List&lt;int&gt;(); &#125;&#125; MissionManager123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423using System.Collections;using System.Collections.Generic;using System.IO;using System.Linq;using System.Runtime.InteropServices.WindowsRuntime;using UnityEngine;public enum MissionType&#123; Find, Collection, Kill&#125;public enum MissionFilter&#123; Main, Sub, Branch//è¿™ä¸ªç±»åž‹ä¸€å®šæ”¾æœ€åŽ å› ä¸ºè¯¥ç±»åž‹ä¸å‚ä¸Žè®¡ç®—ï¼Œæžšä¸¾æ•°ä¸èƒ½å½±å“è®¡ç®—&#125;/// &lt;summary&gt;/// ä»»åŠ¡ç®¡ç†å™¨/// &lt;para&gt;è¯·åœ¨é¢„ç»Ÿè®¡ç‰©å“æ•°é‡ï¼ˆå³èƒŒåŒ…ã€æ€äººæ•°ç­‰ï¼‰åŠ è½½ä¹‹å‰åŠ è½½æœ¬ç±»ï¼Œå¹¶ä¸”åœ¨é¢„ç»Ÿè®¡ç‰©å“æ•°é‡åŠ è½½æ—¶æ‰§è¡ŒRefreshPreCountNumæ–¹æ³•&lt;/para&gt;/// &lt;/summary&gt;public class MissionManager&#123; private static MissionManager instance; private Dictionary&lt;int, MissionTree&gt; _lockedMission = new Dictionary&lt;int, MissionTree&gt;(); private Dictionary&lt;int, MissionTree&gt; _unlockedMission = new Dictionary&lt;int, MissionTree&gt;(); private Dictionary&lt;int, MissionTree&gt; _doneMission = new Dictionary&lt;int, MissionTree&gt;(); private Dictionary&lt;int, MissionSaveData&gt; _missionSaveData = new Dictionary&lt;int, MissionSaveData&gt;(); private Dictionary&lt;int, float&gt; _preCount = new Dictionary&lt;int, float&gt;(); private MissionTree _curMission; public static MissionManager Instance() &#123; if (instance == null) &#123; instance = new MissionManager(); &#125; return instance; &#125; private MissionManager() &#123; &#125; /// &lt;summary&gt; /// åŠ è½½å­˜æ¡£ /// &lt;/summary&gt; /// &lt;param name=&quot;save&quot;&gt;&lt;/param&gt; public void LoadSaveData(MissionSaveDataSO save) &#123; for (int i = 0, len = save._missionSaveDatas.Count; i &lt; len; i++) &#123; MissionSaveData missionSaveData = save._missionSaveDatas[i]; _missionSaveData.Add(missionSaveData.m_id, missionSaveData); &#125; &#125; public void Init() &#123; //ç¡¬ç¼–ç æ•°æ® List&lt;MissionTree&gt; missions = new List&lt;MissionTree&gt;(); MissionTree m1 = new MissionTree(); m1.id = 0; m1.m_id = 0; m1.title = &quot;ä»»åŠ¡1-1&quot;; m1.describe = &quot;ä»»åŠ¡1-1çš„ä»»åŠ¡æè¿°\\næµ‹è¯•æ¢è¡Œ&quot;; m1.type = MissionType.Collection; m1.filter = MissionFilter.Main; m1.is_pre_count = true; m1.target.Add(0); m1.target_describe.Add(&quot;æ”¶é›†id=0çš„ç‰©å“&quot;); m1.target_num.Add(0, 2); m1.award.Add(&quot;å¥–åŠ±1&quot;); m1.award_num.Add(1); m1.is_pre_unlock = true; MissionTree m2 = new MissionTree(); m2.id = 1; m2.m_id = 0; m2.title = &quot;ä»»åŠ¡1-2&quot;; m2.describe = &quot;ä»»åŠ¡1-2çš„ä»»åŠ¡æè¿°&quot;; m2.type = MissionType.Collection; m2.filter = MissionFilter.Main; m2.is_pre_count = false; m2.target.Add(0); m2.target_describe.Add(&quot;æ”¶é›†id=0çš„ç‰©å“&quot;); m2.target_num.Add(0, 2); //m2.award.Add(&quot;å¥–åŠ±1&quot;); //m2.award_num.Add(1); m1.next = m2; MissionTree m3 = new MissionTree(); m3.id = 0; m3.m_id = 1; m3.title = &quot;ä»»åŠ¡2-1&quot;; m3.describe = &quot;ä»»åŠ¡2-1çš„ä»»åŠ¡æè¿°&quot;; m3.type = MissionType.Collection; m3.filter = MissionFilter.Sub; m3.is_pre_count = false; m3.target.Add(0); m3.target_describe.Add(&quot;æ”¶é›†id=0çš„ç‰©å“&quot;); m3.target_num.Add(0, 2); m3.award.Add(&quot;å¥–åŠ±1&quot;); m3.award_num.Add(1); //m3.is_pre_unlock = true; MissionTree m4 = new MissionTree(); m4.id = 0; m4.m_id = 2; m4.title = &quot;ä»»åŠ¡3-1&quot;; m4.describe = &quot;ä»»åŠ¡3-1çš„ä»»åŠ¡æè¿°&quot;; m4.type = MissionType.Collection; m4.filter = MissionFilter.Branch; m4.is_pre_count = false; m4.target.Add(0); m4.target_describe.Add(&quot;æ”¶é›†id=0çš„ç‰©å“&quot;); m4.target_num.Add(0, 2); m4.award.Add(&quot;å¥–åŠ±1&quot;); m4.award_num.Add(1); m4.is_pre_unlock = true; m4.branch_belong = 0; MissionTree m5 = new MissionTree(); m5.id = 0; m5.m_id = 3; m5.title = &quot;ä»»åŠ¡4-1&quot;; m5.describe = &quot;ä»»åŠ¡4-1çš„ä»»åŠ¡æè¿°&quot;; m5.type = MissionType.Collection; m5.filter = MissionFilter.Branch; m5.is_pre_count = false; m5.target.Add(0); m5.target_describe.Add(&quot;æ”¶é›†id=0çš„ç‰©å“&quot;); m5.target_num.Add(0, 2); m5.award.Add(&quot;å¥–åŠ±1&quot;); m5.award_num.Add(1); m5.is_pre_unlock = true; m5.branch_belong = 0; m1.unlock_mission.Add(1); m2.branch.Add(2); m2.branch.Add(3); missions.Add(m1); missions.Add(m3); missions.Add(m4); missions.Add(m5); //åˆå§‹åŒ– for (int i = 0, len = missions.Count; i &lt; len; i++) &#123; MissionTree mission = missions[i]; MissionSaveData missionSaveData; _missionSaveData.TryGetValue(mission.m_id, out missionSaveData); if (missionSaveData != null) &#123; if (missionSaveData.isDone) &#123; _doneMission.Add(mission.m_id, mission); &#125; else &#123; while (mission.id != missionSaveData.id) &#123; mission = mission.next; &#125; _unlockedMission.Add(mission.m_id, mission); mission.complete_num = missionSaveData.complete_num; &#125; &#125; else &#123; if (mission.is_pre_unlock) &#123; _unlockedMission.Add(mission.m_id, mission); &#125; else &#123; _lockedMission.Add(mission.m_id, mission); &#125; &#125; &#125; &#125; public MissionTree GetCurMission() &#123; return _curMission; &#125; public Dictionary&lt;int, MissionTree&gt; GetUnlockedMission() &#123; return _unlockedMission; &#125; public Dictionary&lt;int, MissionTree&gt; GetDoneMission() &#123; return _doneMission; &#125; public MissionTree GetUnlockedMissionById(int id) &#123; MissionTree missionTree; _unlockedMission.TryGetValue(id, out missionTree); return missionTree; &#125; /// &lt;summary&gt; /// èŽ·å¾—ä»»åŠ¡ç­›é€‰ç±»åž‹æ–‡å­—æè¿° /// &lt;/summary&gt; /// &lt;param name=&quot;type&quot;&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public string GetMissionFilterString(MissionFilter type) &#123; switch (type) &#123; case MissionFilter.Main: default: return &quot;ä¸»çº¿&quot;; case MissionFilter.Sub: return &quot;æ”¯çº¿&quot;; &#125; &#125; /// &lt;summary&gt; /// èŽ·å¾—ä»»åŠ¡ç­›é€‰ç±»åž‹ /// &lt;/summary&gt; /// &lt;param name=&quot;filter&quot;&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public MissionFilter GetMissionFileter(string filter) &#123; switch (filter) &#123; case &quot;ä¸»çº¿&quot;: default: return MissionFilter.Main; case &quot;æ”¯çº¿&quot;: return MissionFilter.Sub; &#125; &#125; /// &lt;summary&gt; /// åˆ·æ–°é¢„ç»Ÿè®¡ç±»åž‹ä»»åŠ¡çš„å®Œæˆæ•°é‡ /// &lt;/summary&gt; /// &lt;param name=&quot;targetId&quot;&gt;&lt;/param&gt; /// &lt;param name=&quot;num&quot;&gt;&lt;/param&gt; public void RefreshPreCountNum(int targetId, float num, bool isAdd = false) &#123; if (!_preCount.ContainsKey(targetId)) &#123; _preCount.Add(targetId, 0); &#125; if (isAdd) &#123; _preCount[targetId] += num; &#125; else &#123; _preCount[targetId] = num; &#125; &#125; /// &lt;summary&gt; /// èŽ·å¾—é¢„ç»Ÿè®¡æ•°é‡ /// &lt;/summary&gt; /// &lt;param name=&quot;targetId&quot;&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public float GetPreCountNum(int targetId) &#123; return _preCount[targetId]; &#125; /// &lt;summary&gt; /// è®¾ç½®ä»»åŠ¡å®Œæˆæ•°é‡ /// &lt;/summary&gt; /// &lt;param name=&quot;missionId&quot;&gt;&lt;/param&gt; /// &lt;param name=&quot;completeNum&quot;&gt;&lt;/param&gt; /// &lt;param name=&quot;isAdd&quot;&gt;&lt;/param&gt; public void SetCompleteNum(int missionId, int targetId, float completeNum, bool isAdd = true) &#123; MissionTree mission; _unlockedMission.TryGetValue(missionId, out mission); if (mission != null) &#123; if (!mission.complete_num.ContainsKey(targetId)) &#123; mission.complete_num.Add(targetId, 0); &#125; if (isAdd) &#123; mission.complete_num[targetId] += completeNum; &#125; else &#123; mission.complete_num[targetId] = completeNum; &#125; //ä¿å­˜æ•°æ® SaveMissionData(missionId, mission.id, mission.complete_num, false); &#125; &#125; /// &lt;summary&gt; /// æ£€æµ‹ä»»åŠ¡æ˜¯å¦å®Œæˆ /// &lt;/summary&gt; /// &lt;param name=&quot;missionId&quot;&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; public bool CheckComplete(MissionTree mission) &#123; for (int i = 0, len = mission.target.Count; i &lt; len; i++) &#123; int target = mission.target[i]; if (mission.is_pre_count) &#123; if (mission.target_num[target] &gt; _preCount[target]) &#123; return false; &#125; &#125; else &#123; if (mission.complete_num.Count == 0 || mission.target_num[target] &gt; mission.complete_num[target]) &#123; return false; &#125; &#125; &#125; return true; &#125; public void Next(MissionTree mission) &#123; //MissionTree mission = _unlockedMission[missionId]; int missionId = mission.m_id; MissionTree next = mission.next; if (next != null) &#123; if (mission.unlock_mission.Count &gt; 0) &#123; for (int i = 0, len = mission.unlock_mission.Count; i &lt; len; i++) &#123; int id = mission.unlock_mission[i]; MissionTree unlockMission = _lockedMission[id]; _unlockedMission.Add(unlockMission.m_id, unlockMission); _lockedMission.Remove(id); //ä¿å­˜æ•°æ® SaveMissionData(id, unlockMission.id, unlockMission.complete_num, false); &#125; &#125; //ä¸‹ä¸€ä»»åŠ¡ _unlockedMission[missionId] = next; //ä¿å­˜æ•°æ® SaveMissionData(missionId, next.id, next.complete_num, false); &#125; else &#123; _unlockedMission.Remove(missionId); _doneMission.Add(missionId, mission); //ä¿å­˜æ•°æ® SaveMissionData(missionId, mission.id, mission.complete_num, true); &#125; //èŽ·å¾—å¥–åŠ± GetAward(mission); if (mission.filter == MissionFilter.Branch) &#123; MissionTree branchMissionRoot = GetUnlockedMissionById(mission.branch_belong); bool missionDone = true; foreach (var id in branchMissionRoot.branch) &#123; MissionTree branch = GetUnlockedMissionById(id); if (branch != null) &#123; missionDone = false; break; &#125; &#125; if (missionDone) &#123; Next(branchMissionRoot); &#125; &#125; &#125; private void GetAward(MissionTree mission) &#123; string award = &quot;&quot;; for (int i = 0, len = mission.award.Count; i &lt; len; i++) &#123; award += mission.award[i] + &quot; æ•°é‡:&quot; + mission.award_num[i]; &#125; Debug.Log(&quot;èŽ·å¾—ä»»åŠ¡å¥–åŠ± ===&gt; &quot; + award); &#125; private void SaveMissionData(int missionId, int stepId, Dictionary&lt;int, float&gt; completeNum, bool isDone) &#123; //ä¿å­˜æ•°æ® MissionSaveData missionSaveData; _missionSaveData.TryGetValue(missionId, out missionSaveData); if (missionSaveData == null) &#123; missionSaveData = new MissionSaveData(); missionSaveData.m_id = missionId; _missionSaveData.Add(missionId, missionSaveData); &#125; missionSaveData.id = stepId; missionSaveData.complete_num = completeNum; missionSaveData.isDone = isDone; &#125;&#125; æ›´æ–°æ—¥å¿—2023-12-12 ä¿®å¤åˆ†æ”¯ä»»åŠ¡åˆ¤å®š bugã€‚ 2023-11-7 1.æ›´æ–°åŸºç¡€ç‰ˆæœ¬","categories":[{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/categories/Unity/"},{"name":"å·¥å…·","slug":"Unity/å·¥å…·","permalink":"https://busyogg.github.io/categories/Unity/%E5%B7%A5%E5%85%B7/"}],"tags":[{"name":"C#","slug":"C","permalink":"https://busyogg.github.io/tags/C/"},{"name":"å·¥å…·ç±»","slug":"å·¥å…·ç±»","permalink":"https://busyogg.github.io/tags/%E5%B7%A5%E5%85%B7%E7%B1%BB/"},{"name":"ç³»ç»Ÿæž¶æž„","slug":"ç³»ç»Ÿæž¶æž„","permalink":"https://busyogg.github.io/tags/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/"},{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/tags/Unity/"}]},{"title":"UGUIå¾ªçŽ¯åˆ—è¡¨","slug":"UGUIå¾ªçŽ¯åˆ—è¡¨","date":"2023-11-07T07:56:56.000Z","updated":"2024-05-18T15:37:23.587Z","comments":true,"path":"article/9d7f93194d78/","link":"","permalink":"https://busyogg.github.io/article/9d7f93194d78/","excerpt":"","text":"ç®€ä»‹UGUI å®žçŽ°æ»šåŠ¨åˆ—è¡¨ï¼Œæ”¯æŒéžå›ºå®šå¤§å°çš„ Item ä»¥åŠå¤šç§ä¸åŒçš„æ•°æ®ï¼Œå¯è‡ªå®šä¹‰å•å…ƒæ ¼åç§»é‡ã€å•å…ƒæ ¼é—´éš”ã€å•å…ƒæ ¼é‡å¤æ•°é‡é™åˆ¶ï¼Œå¯ä»¥æ ¹æ®å•å…ƒæ ¼é‡å¤æ•°é‡è‡ªåŠ¨è°ƒæ•´æ»šåŠ¨æ–¹å‘ã€‚ æ¼”ç¤ºå•ç±»åž‹å•å…ƒæ ¼ å¤æ•°ç±»åž‹å•å…ƒæ ¼ ä½¿ç”¨æ–¹æ³•UI åœ¨ Canvas ä¸ŠæŒ‚è½½ Scroll View é¢„åˆ¶ä½“ï¼Œé€‰ä¸­ Content å¯¹è±¡ï¼ŒæŒ‚è½½ç®¡ç†è„šæœ¬ã€‚é¢„åˆ¶ä½“ä¸­é»˜è®¤æŒ‚è½½äº†ä¸€ä¸ª TestScrollView è„šæœ¬ã€‚ PrefabItem åˆ—è¡¨ç”¨äºŽæŒ‚è½½ä¸åŒçš„ Item é¢„åˆ¶ä½“ï¼Œéœ€è¦å¤šå°‘ç§å°±æŒ‚è½½å¤šå°‘ä¸ªã€‚ Stack ç”¨äºŽèŽ·å–å¯¹è±¡æ± èŠ‚ç‚¹ï¼Œå³ä¸Šå›¾çš„ Stack èŠ‚ç‚¹ã€‚ Scroll ç”¨äºŽèŽ·å– Scroll View èŠ‚ç‚¹ã€‚ FitSize å¼€å¯åŽåˆ—è¡¨å°†æ¸²æŸ“æ‰€æœ‰å•å…ƒæ ¼ï¼Œå¹¶ä¸”é¢æ¿å¤§å°è‡ªåŠ¨è°ƒæ•´ä¸ºé€‚åˆçš„å¤§å°ï¼Œå¹¶ç¦æ­¢æ»šåŠ¨ã€‚ SpaceXï¼Œå•å…ƒæ ¼ X æ–¹å‘é—´éš”ã€‚ SpaceYï¼Œå•å…ƒæ ¼ Y æ–¹å‘é—´éš”ã€‚ OffsetXï¼Œåˆ—è¡¨ X æ–¹å‘åç§»ã€‚ OffsetYï¼Œåˆ—è¡¨ Y æ–¹å‘åç§»ã€‚ RepeatXï¼Œåˆ—è¡¨ X æ–¹å‘å•å…ƒæ ¼æœ€å¤§æ•°é‡ã€‚0 ä¸ºæ— é™åˆ¶ã€‚ RepeatYï¼Œåˆ—è¡¨ Y æ–¹å‘å•å…ƒæ ¼æœ€å¤§æ•°é‡ã€‚0 ä¸ºæ— é™åˆ¶ã€‚å½“ RepeatX è®¾ç½®åŽï¼Œè¯¥é¡¹å¤±æ•ˆï¼ˆå¯èƒ½ä¼šå‡º bugï¼Œä¸å»ºè®®åŒæ—¶è®¾ç½®ï¼‰ã€‚ ä»£ç Content å¯¹è±¡æŒ‚è½½çš„è„šæœ¬éœ€è¦ç»§æ‰¿ ScrollViewScriptã€‚å¦‚ TestScrollViewï¼š TestScrollView123456789101112131415161718192021222324252627282930313233343536373839404142434445using System.Collections.Generic;using TMPro;public class TestScrollView : ScrollViewScript&lt;int&gt;&#123; private List&lt;int&gt; _subData = new List&lt;int&gt;(); void Awake() &#123; for (int i = 0; i &lt; 10; i++) &#123; _subData.Add(i); &#125; actions.Add(UpdateItem); actions.Add(UpdateItem); &#125; protected override void InitItemType() &#123; List&lt;int[]&gt; type = new List&lt;int[]&gt;(); int i = 0; int j = 0; while (i &lt; data.Count || j &lt; _subData.Count) &#123; if (i &lt; data.Count) &#123; type.Add(new int[] &#123; 0, i++ &#125;); &#125; if (j &lt; _subData.Count) &#123; type.Add(new int[] &#123; 1, j++ &#125;); &#125; &#125; itemType = type; &#125; private void UpdateItem(ItemTransformData cell, int index) &#123; cell.item.transform.GetChild(0).GetComponent&lt;TextMeshProUGUI&gt;().text = &quot;å•å…ƒæ ¼ &quot; + data[index]; &#125;&#125; æ³›åž‹ä»£è¡¨äº†åˆ—è¡¨é»˜è®¤æ•°æ® data çš„æ•°æ®ç±»åž‹ã€‚å¯¹ data èµ‹å€¼å³å¯åˆ·æ–°åˆ—è¡¨ã€‚ åˆ—è¡¨å•å…ƒæ ¼æ¸²æŸ“å‡½æ•°éœ€è¦åœ¨ Start å‡½æ•°ä¹‹å‰å®šä¹‰å¹¶å­˜å…¥æ¸²æŸ“å‡½æ•°æ•°ç»„actionsä¸­ã€‚æœ¬ä¾‹ä¸­åœ¨ Awake è¿›è¡Œåˆå§‹åŒ–ã€‚æœ‰å¤šå°‘ Item ç±»åž‹å°±è¦åˆå§‹åŒ–å¤šå°‘æ¸²æŸ“å‡½æ•°ï¼Œå¹¶ä¸”é¡ºåºè¦ä¸€ä¸€å¯¹åº”ã€‚ä¸è¿‡å¦‚æžœ Item æ•°é‡å¤§äºŽæ¸²æŸ“å‡½æ•°æ•°é‡ï¼Œç¨‹åºä¹Ÿä¸ä¼šå‡ºé—®é¢˜ï¼Œå¦‚æžœæ˜¯ä¸­é—´ Item ç±»åž‹çš„æ¸²æŸ“å‡½æ•°ä¸å­˜åœ¨ï¼Œé‚£å°±ä¼šå‡ºçŽ°æ¸²æŸ“å‡½æ•°å’Œ Item ä¸åŒ¹é…ã€‚å› æ­¤æœ€å¥½æ˜¯ä¸€ä¸€å¯¹åº”ã€‚ å¦‚æžœéœ€è¦é¢å¤–çš„æ•°æ®ï¼Œé‚£å°±éœ€è¦é‡å†™InitItemTypeæ–¹æ³•ã€‚ 1234567891011121314/// &lt;summary&gt;/// åˆå§‹åŒ–å•å…ƒæ ¼ç±»åž‹/// &lt;/summary&gt;/// &lt;param name=&quot;itemType&quot;&gt;int[2] 0ä¸ºbuttonç±»åž‹ 1ä¸ºå¯¹åº”ç±»åž‹çš„æ•°æ®ç´¢å¼•&lt;/param&gt;protected virtual void InitItemType()&#123; List&lt;int[]&gt; type = new List&lt;int[]&gt;(); for (int i = 0, len = _data.Count; i &lt; len; i++) &#123; type.Add(new int[] &#123; 0, i &#125;); &#125; itemType = type;&#125; è¯¥æ–¹æ³•è´Ÿè´£ç®¡ç†è™šæ‹Ÿåˆ—è¡¨ä¸­ Item å¯¹åº”ç´¢å¼•çš„ Item ç±»åž‹å’Œå…¶åœ¨å¯¹åº”æ•°æ®åˆ—è¡¨ä¸­çš„ç´¢å¼•ã€‚ ä¾‹å¦‚ï¼š 1234567891011121314151617181920protected override void InitItemType() &#123; List&lt;int[]&gt; type = new List&lt;int[]&gt;(); int i = 0; int j = 0; while (i &lt; data.Count || j &lt; _subData.Count) &#123; if (i &lt; data.Count) &#123; type.Add(new int[] &#123; 0, i++ &#125;); &#125; if (j &lt; _subData.Count) &#123; type.Add(new int[] &#123; 1, j++ &#125;); &#125; &#125; itemType = type; &#125; _subDataä¸ºä»»åŠ¡æ»šåŠ¨åˆ—è¡¨ç±»è‡ªå®šä¹‰çš„å±žæ€§ï¼Œæœ¬ä¾‹æ ¹æ®ä¸€ä¸ª Item0 å’Œä¸€ä¸ª Item1 äº¤æ›¿å¡«å……åˆ°itemTypeä¸­ï¼Œå³ç®¡ç†è™šæ‹Ÿåˆ—è¡¨ä¸­ Item å¯¹åº”ç´¢å¼•çš„ Item ç±»åž‹å’Œå…¶åœ¨å¯¹åº”æ•°æ®åˆ—è¡¨ä¸­çš„ç´¢å¼•çš„åˆ—è¡¨ä¸­ã€‚ æ³¨æ„ï¼Œå¦‚æžœåˆ—è¡¨ä¸æ˜¯å•åˆ—æˆ–å•è¡Œï¼Œå»ºè®®ä¸è¦ä½¿ç”¨å¤šç§å¤§å°ä¸åŒçš„ Item æ··æ­ï¼Œæœ¬é¡¹ç›®å°šæœªå¯¹è¯¥æƒ…å†µè¿›è¡Œé€‚é…ï¼Œå¾ˆæœ‰å¯èƒ½ä¼šå‡ºçŽ° Item è¦†ç›–çš„æƒ…å†µã€‚ åŽŸç†æ¦‚è¿°Item å›ºå®šå¤§å°çš„å¾ªçŽ¯åˆ—è¡¨ä¼šåœ¨æ»šåŠ¨é¢æ¿è§†é‡Žå¤–é¢å¤–ç”Ÿæˆä¸€ä¸ª Itemï¼Œåœ¨ä¸Šä¸‹æ»šåŠ¨çš„æ—¶å€™é€šè¿‡æ”¹å˜é¢å¤– Item çš„åæ ‡å¹¶ä¸”é‡æ–°æ¸²æŸ“è¯¥ Item æ¥å®žçŽ°åˆ—è¡¨çš„æ»šåŠ¨æ•ˆæžœã€‚ æœ¬é¡¹ç›®å› ä¸ºéœ€è¦æ”¯æŒéžå›ºå®šå¤§å°çš„ Itemï¼Œå› æ­¤ä½¿ç”¨å¯¹è±¡æ± çš„æ–¹å¼æ¥æ¨¡æ‹Ÿã€‚é€šè¿‡åˆ¤æ–­ä¸Šä¸‹æ»šåŠ¨æ—¶çš„å¤´å°¾èŠ‚ç‚¹ç›¸è¾ƒäºŽæ»šåŠ¨é¢æ¿çš„ä½ç½®æ¥åˆ¤æ–­æ˜¯è¦å›žæ”¶ Item è¿˜æ˜¯åˆ›å»º Itemã€‚ å•å…ƒæ ¼æ ¹æ®ç±»åž‹è°ƒç”¨å¯¹åº”çš„æ¸²æŸ“å‡½æ•°ï¼Œåœ¨ data æ•°æ®å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ä¼šåˆ·æ–°åˆ—è¡¨ï¼›åœ¨å•å…ƒæ ¼å¤§å°å‘ç”Ÿå˜åŒ–æ—¶ä¼šåˆ·æ–°å•å…ƒæ ¼åæ ‡ã€‚ å•å…ƒæ ¼æ•°æ®ç±»æ‰€æœ‰å•å…ƒæ ¼éƒ½éµå¾ªè¯¥ç±»çš„è®¾ç½®ã€‚æ»šåŠ¨åˆ—è¡¨å•å…ƒæ ¼ä¹‹é—´æŒ‰ç…§é€»è¾‘é¡ºåºä½¿ç”¨ next å’Œ parent å½¢æˆåŒå‘é“¾è¡¨ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123using UnityEngine;using UnityEngine.UI;public class ItemTransformData&#123; /// &lt;summary&gt; /// åæ ‡ /// &lt;/summary&gt; public Vector2 pos &#123; get &#123; return _pos; &#125; set &#123; _pos = value; item.transform.localPosition = pos; &#125; &#125; /// &lt;summary&gt; /// é«˜åº¦ /// &lt;/summary&gt; public float height &#123; get &#123; if (_item_rect) &#123; return _item_rect.rect.height; &#125; else &#123; return 0f; &#125; &#125; &#125; /// &lt;summary&gt; /// å®½åº¦ /// &lt;/summary&gt; public float width &#123; get &#123; if (_item_rect) &#123; return _item_rect.rect.width; &#125; else &#123; return 0f; &#125; &#125; &#125; /// &lt;summary&gt; /// å®½é«˜ /// &lt;/summary&gt; public Vector2 size &#123; set &#123; _item_rect.sizeDelta = value; &#125; &#125; /// &lt;summary&gt; /// è™šæ‹Ÿåˆ—è¡¨ç´¢å¼• /// &lt;/summary&gt; public int cell_index &#123; get; set; &#125; /// &lt;summary&gt; /// æ•°æ®åˆ—è¡¨ç´¢å¼• /// &lt;/summary&gt; public int item_index &#123; get; set; &#125; /// &lt;summary&gt; /// å•å…ƒæ ¼å¯¹è±¡ /// &lt;/summary&gt; public Button item &#123; get &#123; return _item; &#125; set &#123; _item = value; _item_rect = _item.GetComponent&lt;RectTransform&gt;(); &#125; &#125; /// &lt;summary&gt; /// å•å…ƒæ ¼ç±»åž‹ /// &lt;/summary&gt; public int item_type &#123; get; set; &#125; /// &lt;summary&gt; /// ä¸‹ä¸€å•å…ƒæ ¼ /// &lt;/summary&gt; public ItemTransformData next &#123; get; set; &#125; /// &lt;summary&gt; /// ä¸Šä¸€å•å…ƒæ ¼ /// &lt;/summary&gt; public ItemTransformData parent &#123; get; set; &#125; private Button _item; private RectTransform _item_rect; private Vector2 _pos; public void CloneTo(ItemTransformData itd) &#123; itd.pos = pos; itd.cell_index = cell_index; itd.item_index = item_index; itd.item = item; itd.item_type = item_type; &#125; public ItemTransformData Clone() &#123; ItemTransformData itd = new ItemTransformData(); CloneTo(itd); return itd; &#125;&#125; åˆå§‹åŒ– ç”Ÿæˆå•å…ƒæ ¼å¯¹è±¡æ±  é¦–å…ˆåˆå§‹åŒ–åˆ—è¡¨çš„è§†å£å¤§å°ã€‚ ç„¶åŽéåŽ† Item é¢„åˆ¶ä½“ç±»åž‹ï¼Œæ ¹æ®è§†å£å¤§å°å¾ªçŽ¯åˆ›å»º Item å¯¹è±¡å¹¶å­˜å…¥å¯¹è±¡æ± ï¼ˆä¹Ÿå¯ä»¥åœ¨è¿è¡Œæ—¶åˆ›å»ºï¼Œæ ¹æ®éœ€æ±‚å³å¯ï¼‰ã€‚ æ ¹æ®é¢æ¿é…ç½®è®¾ç½®å¯¹åº”çš„æŽ§åˆ¶æ¡ä»¶ã€‚ ç›‘å¬æ»šåŠ¨ã€‚ æ ¹æ®æ•°æ®ç”Ÿæˆå•å…ƒæ ¼ å›žæ”¶æ‰€æœ‰æ˜¾ç¤ºçš„å•å…ƒæ ¼ã€‚ åˆå§‹åŒ–è™šæ‹Ÿåˆ—è¡¨ while å¾ªçŽ¯ç”Ÿæˆå•å…ƒæ ¼ï¼Œéž FitSize æƒ…å†µä¸‹å½“å•å…ƒæ ¼è¶…å‡ºè§†ç•ŒåŽä¸ç”Ÿæˆï¼ŒåªèŽ·å–å¹¶è®¡ç®—ä½ç½®å’Œå¤§å°ä¿¡æ¯ã€‚ åˆ—è¡¨æ»šåŠ¨åˆ·æ–°å‰ææ¡ä»¶ï¼šY è½´å‘ä¸‹ä¸ºè´Ÿå€¼ï¼Œå‘ä¸‹æ»šåŠ¨ä¸ºæ»šåŠ¨é¢æ¿ Y å€¼å¢žåŠ ï¼ŒX æ–¹å‘ç›¸å æ»šåŠ¨åˆ—è¡¨åˆ·æ–°æŒ‰ç…§æ»šåŠ¨æ–¹å‘åˆ†ä¸ºä¸¤ç±»ï¼š å‘ä¸‹\\å³æ»šåŠ¨ å¯¹äºŽå¤´å•å…ƒæ ¼ï¼Œå½“å…¶ Y æ–¹å‘æœ€ä½Žç‚¹åŠ ä¸Šæ»šåŠ¨è·ç¦»å¤§äºŽ 0 æ—¶ï¼Œæˆ–è€…å…¶ X æ–¹å‘æœ€å³ç‚¹åŠ ä¸Šæ»šåŠ¨è·ç¦»å°äºŽ 0 æ—¶ï¼Œå›žæ”¶å¤´å•å…ƒæ ¼ï¼Œç„¶åŽç½®å¤´å•å…ƒæ ¼ä¸ºä¸‹ä¸€å•å…ƒæ ¼ï¼ˆnextï¼‰ã€‚ Yï¼š_head.pos.y - _head.height + rect &gt; 0 Xï¼š_head.pos.x + _head.width + rect &lt; 0 å¯¹äºŽå°¾å•å…ƒæ ¼ï¼Œå½“å…¶ Y æ–¹å‘æœ€é«˜ç‚¹åŠ ä¸Šæ»šåŠ¨è·ç¦»å¤§äºŽè´Ÿçš„æ»šåŠ¨é¢æ¿é«˜åº¦æ—¶ï¼Œæˆ–è€…å…¶ X æ–¹å‘æœ€å·¦ç‚¹åŠ ä¸Šæ»šåŠ¨è·ç¦»å°äºŽæ»šåŠ¨é¢æ¿å®½åº¦æ—¶ï¼Œç”Ÿæˆæ–°å•å…ƒæ ¼ï¼Œå¹¶ç½®å°¾å•å…ƒæ ¼ä¸ºè¯¥å•å…ƒæ ¼ã€‚ Yï¼š_tail.pos.y + rect &gt; -_viewHeight Xï¼š_tail.pos.x + rect &lt; _viewWidth å‘ä¸Š\\å·¦æ»šåŠ¨ å¯¹äºŽå¤´å•å…ƒæ ¼ï¼Œå½“å…¶ Y æ–¹å‘æœ€ä½Žç‚¹åŠ ä¸Šæ»šåŠ¨è·ç¦»å°äºŽ 0 æ—¶ï¼Œæˆ–è€…å…¶ X æ–¹å‘æœ€å³ç‚¹åŠ ä¸Šæ»šåŠ¨è·ç¦»å¤§äºŽ 0 æ—¶ï¼Œç”Ÿæˆæ–°å•å…ƒæ ¼ï¼Œå¹¶ç½®å¤´å•å…ƒæ ¼ä¸ºè¯¥å•å…ƒæ ¼ã€‚ Yï¼š_head.pos.y - _head.height + rect &lt; 0 Xï¼š_head.pos.x + _head.width + rect &gt; 0 å¯¹äºŽå°¾å•å…ƒæ ¼ï¼Œå½“å…¶ Y æ–¹å‘æœ€é«˜ç‚¹åŠ ä¸Šæ»šåŠ¨è·ç¦»å°äºŽè´Ÿçš„æ»šåŠ¨é¢æ¿é«˜åº¦æ—¶ï¼Œæˆ–è€…å…¶ X æ–¹å‘æœ€å·¦ç‚¹åŠ ä¸Šæ»šåŠ¨è·ç¦»å¤§äºŽæ»šåŠ¨é¢æ¿å®½åº¦æ—¶ï¼Œå›žæ”¶å°¾å•å…ƒæ ¼ï¼Œç„¶åŽç½®å°¾å•å…ƒæ ¼ä¸ºä¸Šä¸€å•å…ƒæ ¼ï¼ˆparentï¼‰ã€‚ Yï¼š_tail.pos.y + rect &lt; -_viewHeight Xï¼š_tail.pos.x + rect &gt; _viewWidth æ”¹å˜å•å…ƒæ ¼å¤§å°è°ƒç”¨SetCellSizeæ–¹æ³•è®¾ç½®å•å…ƒæ ¼å¤§å°ï¼Œå¹¶ä¸”é»˜è®¤åˆ·æ–°å•å…ƒæ ¼ä½ç½®ã€‚ ä»£ç ItemTransformData123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123using UnityEngine;using UnityEngine.UI;public class ItemTransformData&#123; /// &lt;summary&gt; /// åæ ‡ /// &lt;/summary&gt; public Vector2 pos &#123; get &#123; return _pos; &#125; set &#123; _pos = value; item.transform.localPosition = pos; &#125; &#125; /// &lt;summary&gt; /// é«˜åº¦ /// &lt;/summary&gt; public float height &#123; get &#123; if (_item_rect) &#123; return _item_rect.rect.height; &#125; else &#123; return 0f; &#125; &#125; &#125; /// &lt;summary&gt; /// å®½åº¦ /// &lt;/summary&gt; public float width &#123; get &#123; if (_item_rect) &#123; return _item_rect.rect.width; &#125; else &#123; return 0f; &#125; &#125; &#125; /// &lt;summary&gt; /// å®½é«˜ /// &lt;/summary&gt; public Vector2 size &#123; set &#123; _item_rect.sizeDelta = value; &#125; &#125; /// &lt;summary&gt; /// è™šæ‹Ÿåˆ—è¡¨ç´¢å¼• /// &lt;/summary&gt; public int cell_index &#123; get; set; &#125; /// &lt;summary&gt; /// æ•°æ®åˆ—è¡¨ç´¢å¼• /// &lt;/summary&gt; public int item_index &#123; get; set; &#125; /// &lt;summary&gt; /// å•å…ƒæ ¼å¯¹è±¡ /// &lt;/summary&gt; public Button item &#123; get &#123; return _item; &#125; set &#123; _item = value; _item_rect = _item.GetComponent&lt;RectTransform&gt;(); &#125; &#125; /// &lt;summary&gt; /// å•å…ƒæ ¼ç±»åž‹ /// &lt;/summary&gt; public int item_type &#123; get; set; &#125; /// &lt;summary&gt; /// ä¸‹ä¸€å•å…ƒæ ¼ /// &lt;/summary&gt; public ItemTransformData next &#123; get; set; &#125; /// &lt;summary&gt; /// ä¸Šä¸€å•å…ƒæ ¼ /// &lt;/summary&gt; public ItemTransformData parent &#123; get; set; &#125; private Button _item; private RectTransform _item_rect; private Vector2 _pos; public void CloneTo(ItemTransformData itd) &#123; itd.pos = pos; itd.cell_index = cell_index; itd.item_index = item_index; itd.item = item; itd.item_type = item_type; &#125; public ItemTransformData Clone() &#123; ItemTransformData itd = new ItemTransformData(); CloneTo(itd); return itd; &#125;&#125; ScrollViewScript123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578579580581582583584585586587588589590591592593594595596597598599600601602603604605606607608609610611612613614615616617618619620621622623624625626627628629630631632633634635636637638639640641642using System;using System.Collections.Generic;using UnityEngine;using UnityEngine.UI;public class ScrollViewScript&lt;T&gt; : MonoBehaviour&#123; /// &lt;summary&gt; /// å•å…ƒæ ¼é¢„åˆ¶ä½“ /// &lt;/summary&gt; public List&lt;Button&gt; PrefabItem; /// &lt;summary&gt; /// å•å…ƒæ ¼å›žæ”¶èŠ‚ç‚¹ /// &lt;/summary&gt; public GameObject Stack; /// &lt;summary&gt; /// æ»šåŠ¨èŠ‚ç‚¹ /// &lt;/summary&gt; public ScrollRect Scroll; /// &lt;summary&gt; /// è‡ªé€‚åº”å¤§å° /// &lt;/summary&gt; public bool FitSize; /// &lt;summary&gt; /// Xæ–¹å‘å•å…ƒæ ¼é—´éš” /// &lt;/summary&gt; public float SpaceX; /// &lt;summary&gt; /// Yæ–¹å‘å•å…ƒæ ¼é—´éš” /// &lt;/summary&gt; public float SpaceY; /// &lt;summary&gt; /// Xæ–¹å‘åç§» /// &lt;/summary&gt; public float OffsetX; /// &lt;summary&gt; /// Yæ–¹å‘åç§» /// &lt;/summary&gt; public float OffsetY; /// &lt;summary&gt; /// Xæ–¹å‘é‡å¤å•å…ƒæ ¼ä¸ªæ•° /// &lt;/summary&gt; public int RepeatX; /// &lt;summary&gt; /// Yæ–¹å‘é‡å¤å•å…ƒæ ¼ä¸ªæ•° /// &lt;/summary&gt; public int RepeatY; /// &lt;summary&gt; /// é»˜è®¤åˆ—è¡¨æ•°æ® /// &lt;/summary&gt; public List&lt;T&gt; data &#123; get &#123; return _data; &#125; set &#123; RefreshList(value); &#125; &#125; /// &lt;summary&gt; /// åˆ—è¡¨å•å…ƒæ ¼ç±»åž‹ /// &lt;/summary&gt; protected List&lt;int[]&gt; itemType &#123; get &#123; return _itemType; &#125; set &#123; _itemType = value; &#125; &#125; protected List&lt;Action&lt;ItemTransformData, int&gt;&gt; actions &#123; get &#123; return _actions; &#125; &#125; private bool _inited = false; private List&lt;int[]&gt; _itemType = new List&lt;int[]&gt;(); /// &lt;summary&gt; /// é»˜è®¤åˆ—è¡¨æ•°æ® /// &lt;/summary&gt; private List&lt;T&gt; _data; /// &lt;summary&gt; /// å•å…ƒæ ¼è™šæ‹Ÿæ•°é‡æœ€å¤§å€¼ /// &lt;/summary&gt; private int _length; /// &lt;summary&gt; /// æ˜¾ç¤ºçš„å•å…ƒæ ¼åˆ—è¡¨ /// &lt;/summary&gt; private List&lt;ItemTransformData&gt; _items = new List&lt;ItemTransformData&gt;(); /// &lt;summary&gt; /// å›žæ”¶çš„å•å…ƒæ ¼åˆ—è¡¨ /// &lt;/summary&gt; private List&lt;Stack&lt;ItemTransformData&gt;&gt; _itemStack = new List&lt;Stack&lt;ItemTransformData&gt;&gt;(); /// &lt;summary&gt; /// contenté¢æ¿transform /// &lt;/summary&gt; private RectTransform _rectTransform; /// &lt;summary&gt; /// contentè§†å›¾é«˜åº¦ /// &lt;/summary&gt; private float _viewHeight; /// &lt;summary&gt; /// contentè§†å›¾å®½åº¦ /// &lt;/summary&gt; private float _viewWidth; //private int _repeatX; private ItemTransformData _head; private ItemTransformData _tail; private Vector2 _lastScrollPos = new Vector2(); private List&lt;Vector2&gt; _itemPos = new List&lt;Vector2&gt;(); private Dictionary&lt;int, Dictionary&lt;int, Vector2&gt;&gt; _itemSize = new Dictionary&lt;int, Dictionary&lt;int, Vector2&gt;&gt;(); private int _scrollDirection = 0; private List&lt;Action&lt;ItemTransformData, int&gt;&gt; _actions = new List&lt;Action&lt;ItemTransformData, int&gt;&gt;(); public void Start() &#123; _rectTransform = GetComponent&lt;RectTransform&gt;(); _viewWidth = transform.parent.GetComponent&lt;RectTransform&gt;().rect.width; _viewHeight = transform.parent.GetComponent&lt;RectTransform&gt;().rect.height; for (int i = 0, len = PrefabItem.Count; i &lt; len; i++) &#123; //åˆ›å»ºå›žæ”¶æ ˆèŠ‚ç‚¹å¯¹åº”ç±»åž‹çš„å›žæ”¶èŠ‚ç‚¹ GameObject obj = new GameObject(); obj.name = &quot;ItemType_&quot; + i; obj.transform.SetParent(Stack.transform); Button item = Instantiate(PrefabItem[i]); item.transform.SetParent(obj.transform); RectTransform itemRect = item.GetComponent&lt;RectTransform&gt;(); ItemTransformData itd = new ItemTransformData(); itd.item = item; itd.pos = new Vector2(); itd.item_type = i; if (_itemStack.Count &lt;= i) &#123; _itemStack.Add(new Stack&lt;ItemTransformData&gt;()); &#125; _itemStack[i].Push(itd); for (int j = 0, len2 = (int)Mathf.Ceil(_viewHeight / itd.height) * (int)Mathf.Ceil(_viewWidth / itd.width); j &lt; len2; j++) &#123; Button item2 = Instantiate(PrefabItem[i]); item2.transform.SetParent(obj.transform); RectTransform itemRect2 = item.GetComponent&lt;RectTransform&gt;(); ItemTransformData itd2 = new ItemTransformData(); itd2.item = item2; itd2.pos = new Vector2(); itd2.item_type = i; _itemStack[i].Push(itd2); &#125; &#125; if (FitSize) &#123; Scroll.vertical = false; Scroll.horizontal = false; &#125; else &#123; if (RepeatY != 0) &#123; Scroll.vertical = false; &#125; else &#123; Scroll.horizontal = false; &#125; &#125; Scroll.onValueChanged.AddListener(OnScroll); _inited = true; if (data != null &amp;&amp; data.Count &gt; 0) &#123; data = data; &#125; &#125; private void OnScroll(Vector2 v) &#123; ////Debug.Log(v); if (_head == null || _tail == null) return; float rect; float diff; if (RepeatY != 0) &#123; rect = _rectTransform.localPosition.x; diff = _lastScrollPos.x - rect; &#125; else &#123; rect = _rectTransform.localPosition.y; diff = rect - _lastScrollPos.y; &#125; if (diff &gt; 0) &#123; _scrollDirection = 1; &#125; else if (diff &lt; 0) &#123; _scrollDirection = -1; &#125; else &#123; _scrollDirection = 0; &#125; if (_scrollDirection == 1) &#123; bool checkRecycleHead; if (RepeatY != 0) &#123; checkRecycleHead = _head.pos.x + _head.width + rect &lt; 0; &#125; else &#123; checkRecycleHead = _head.pos.y - _head.height + rect &gt; 0; &#125; if (checkRecycleHead) &#123; if (_head.next != null) &#123; //Debug.Log(&quot;å›žæ”¶å¤´&quot; + _head.cell_index + &quot; == &quot; + _head.next.cell_index); RecycleCell(_head.item_type, _head); _head = _head.next; &#125; &#125; bool checkRecycleTail; if (RepeatY != 0) &#123; checkRecycleTail = _tail.pos.x + rect &lt; _viewWidth; &#125; else &#123; checkRecycleTail = _tail.pos.y + rect &gt; -_viewHeight; &#125; //Debug.Log(_tail.pos.y + rectY + &quot; : &quot; + _viewHeight); if (checkRecycleTail) &#123; int index = _tail.cell_index + 1; if (index &lt; _itemType.Count) &#123; int[] itemType = _itemType[index]; ItemTransformData item = CreateItem(itemType[0]); Vector2 pos = _itemPos[index]; item.cell_index = index; item.item_index = itemType[1]; item.parent = _tail; _tail.next = item; item.pos = pos; item.item.transform.localPosition = pos; item.item.name = index + &quot;&quot;; _tail = item; //Debug.Log(&quot;åˆ›å»ºå°¾&quot; + _tail.cell_index + &quot; &quot; + pos + &quot; &quot; + index); if (itemType[0] &lt; _actions.Count) &#123; _actions[itemType[0]](item, item.item_index); &#125; &#125; &#125; &#125; else if (_scrollDirection == -1) &#123; bool checkRecycleHead; if (RepeatY != 0) &#123; checkRecycleHead = _head.pos.x + _head.width + rect &gt; 0; &#125; else &#123; checkRecycleHead = _head.pos.y - _head.height + rect &lt; 0; &#125; //Debug.Log(_head.pos.y - _head.height + rectY); if (checkRecycleHead) &#123; int index = _head.cell_index - 1; if (index &gt;= 0) &#123; int[] itemType = _itemType[index]; ItemTransformData item = CreateItem(itemType[0]); Vector2 pos = _itemPos[index]; item.cell_index = index; item.item_index = itemType[1]; item.next = _head; _head.parent = item; item.pos = pos; item.item.transform.localPosition = pos; item.item.name = index + &quot;&quot;; _head = item; //Debug.Log(&quot;åˆ›å»ºå¤´&quot; + _head.cell_index + &quot; &quot; + pos + &quot; &quot; + index); if (itemType[0] &lt; _actions.Count) &#123; _actions[itemType[0]](item, item.item_index); &#125; &#125; &#125; bool checkRecycleTail; if (RepeatY != 0) &#123; checkRecycleTail = _tail.pos.x + rect &gt; _viewWidth; &#125; else &#123; checkRecycleTail = _tail.pos.y + rect &lt; -_viewHeight; &#125; //Debug.Log(_tail.pos.y + rectY + &quot; : &quot; + -_viewHeight); if (checkRecycleTail) &#123; if (_tail.parent != null) &#123; //Debug.Log(&quot;å›žæ”¶å°¾&quot; + _tail.cell_index); RecycleCell(_tail.item_type, _tail); _tail = _tail.parent; &#125; &#125; &#125; _lastScrollPos.x = _rectTransform.localPosition.x; _lastScrollPos.y = _rectTransform.localPosition.y; &#125; /// &lt;summary&gt; /// åˆ›å»ºItemTransformData /// &lt;/summary&gt; /// &lt;param name=&quot;itemType&quot;&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; private ItemTransformData CreateItem(int itemType, bool init = true) &#123; ItemTransformData item; //Debug.Log(itemType + &quot; &quot; + _itemStack.Count); if (_itemStack[itemType].Count &gt; 0) &#123; item = _itemStack[itemType].Pop(); &#125; else &#123; Button button = Instantiate(PrefabItem[itemType]); item = new ItemTransformData(); item.item = button; &#125; if (init) &#123; item.item.transform.SetParent(transform); _items.Add(item); &#125; else &#123; _itemStack[itemType].Push(item); &#125; return item; &#125; /// &lt;summary&gt; /// å›žæ”¶æ‰€æœ‰å•å…ƒæ ¼ /// &lt;/summary&gt; private void RecycleAllCells() &#123; for (int i = 0, len = _items.Count; i &lt; len; i++) &#123; ItemTransformData item = _items[i]; item.item.transform.SetParent(Stack.transform.GetChild(item.item_type)); _itemStack[item.item_type].Push(item); &#125; _items.Clear(); _itemPos.Clear(); &#125; /// &lt;summary&gt; /// å›žæ”¶ä¸€ä¸ªå•å…ƒæ ¼ /// &lt;/summary&gt; /// &lt;param name=&quot;itemType&quot;&gt;&lt;/param&gt; /// &lt;param name=&quot;itd&quot;&gt;&lt;/param&gt; private void RecycleCell(int itemType, ItemTransformData itd) &#123; itd.item.transform.SetParent(Stack.transform.GetChild(itemType)); //itd.next = null; //itd.parent = null; _items.Remove(itd); _itemStack[itemType].Push(itd); &#125; private Vector2 CalculatePosition(ItemTransformData last, ItemTransformData current) &#123; float bonusX = 0; float bonusY = 0; if (RepeatX != 0) &#123; if (current.cell_index == 0) &#123; bonusX = OffsetX; bonusY = OffsetY; &#125; else if (current.cell_index % RepeatX == 0) &#123; //æ¢è¡Œ bonusX = -last.pos.x + OffsetX; bonusY = last.height + SpaceY; &#125; else &#123; bonusX = last.width + SpaceX; &#125; &#125; else if (RepeatY != 0) &#123; if (current.cell_index == 0) &#123; bonusY = OffsetY; bonusX = OffsetX; &#125; else if (current.cell_index % RepeatY == 0) &#123; //æ¢è¡Œ bonusX = last.width + SpaceX; bonusY = last.pos.y + OffsetY; &#125; else &#123; bonusY = last.height + SpaceY; &#125; Debug.Log(bonusY); &#125; else &#123; if (current.cell_index == 0) &#123; bonusX = OffsetX; bonusY = OffsetY; &#125; else if (last.pos.x + last.width + SpaceX + current.width &gt; _viewWidth) &#123; //æ¢è¡Œ bonusX = -last.pos.x + OffsetX; bonusY = last.height + SpaceY; &#125; else &#123; bonusX = last.width + SpaceX; &#125; &#125; //_tempVec2.x = last.pos.x + bonusX; //_tempVec2.y = last.pos.y - bonusY; Vector2 pos = new Vector2(last.pos.x + bonusX, last.pos.y - bonusY); return pos; &#125; protected void RefreshList(List&lt;T&gt; data) &#123; //Debug.Log(&quot;è®¾ç½®æ•°æ®&quot;); _data = data; if (_inited) &#123; RecycleAllCells(); InitItemType(); ResetCells(); &#125; &#125; private void ResetCells() &#123; if (FitSize) &#123; _viewWidth = transform.parent.GetComponent&lt;RectTransform&gt;().rect.width; _viewHeight = transform.parent.GetComponent&lt;RectTransform&gt;().rect.height; &#125; ItemTransformData last = new ItemTransformData(); int i = 0; float maxY = 0; float maxX = 0; float maxHeight = 0; float maxWidth = 0; while (i &lt; itemType.Count) &#123; int type = itemType[i][0]; bool isInit = true; if (!FitSize) &#123; if (RepeatY != 0) &#123; isInit = maxX &lt; _viewHeight; &#125; else &#123; isInit = maxY &gt; -_viewHeight; &#125; &#125; ItemTransformData itd = CreateItem(type, isInit); itd.cell_index = i; itd.item_index = itemType[i][1]; itd.item.name = i + &quot;&quot;; if (isInit) &#123; if (type &lt; _actions.Count) &#123; _actions[type](itd, itd.item_index); &#125; &#125; Vector2 pos = CalculatePosition(last, itd); _itemPos.Add(pos); //ç¬¬ä¸€æ¬¡è®¾ç½®æ•°æ®çš„æ—¶å€™åˆå§‹åŒ–å•å…ƒæ ¼å¤§å° ä¹‹åŽè®¾ç½®å•å…ƒæ ¼å¤§å° Dictionary&lt;int, Vector2&gt; sizeDic; _itemSize.TryGetValue(type, out sizeDic); if (sizeDic == null) &#123; sizeDic = new Dictionary&lt;int, Vector2&gt;(); _itemSize.Add(type, sizeDic); &#125; if (!sizeDic.ContainsKey(itd.item_index)) &#123; sizeDic.Add(itd.item_index, new Vector2(itd.width, itd.height)); &#125; else &#123; itd.size = sizeDic[itd.item_index]; &#125; itd.pos = pos; last.next = itd; if (i != 0) &#123; itd.parent = last; &#125; last = itd; maxY = pos.y; maxX = pos.x; float maxH = pos.y - itd.height; float maxW = pos.x + itd.width; if (maxH &lt; maxHeight) &#123; maxHeight = maxH; &#125; if (maxW &gt; maxWidth) &#123; maxWidth = maxW; &#125; i++; //Debug.Log(&quot;è®¾ç½®item &quot; + (i - 1) + &quot; &quot; + maxHeight + &quot; &quot; + pos.y + &quot; &quot; + itd.height); &#125; if (_items.Count &gt; 0) &#123; _head = _items[0]; _tail = _items[_items.Count - 1]; &#125; else &#123; _head = null; _tail = null; &#125; //æ›´æ–°UIå¤§å° _rectTransform.sizeDelta = new Vector2(maxWidth, -maxHeight); if (FitSize) &#123; float contentHeight = _rectTransform.rect.height; _viewHeight = contentHeight; float contentWidth = _rectTransform.rect.width; _viewWidth = contentWidth; //if (contentHeight &lt; _viewHeight) //&#123; // _viewHeight = contentHeight; //&#125; RectTransform scrollRect = Scroll.GetComponent&lt;RectTransform&gt;(); scrollRect.sizeDelta = new Vector2(maxWidth, -maxHeight); &#125; &#125; private void Resize() &#123; RecycleAllCells(); ResetCells(); &#125; /// &lt;summary&gt; /// åˆå§‹åŒ–å•å…ƒæ ¼ç±»åž‹ /// &lt;/summary&gt; /// &lt;param name=&quot;itemType&quot;&gt;int[2] 0ä¸ºbuttonç±»åž‹ 1ä¸ºå¯¹åº”ç±»åž‹çš„æ•°æ®ç´¢å¼•&lt;/param&gt; protected virtual void InitItemType() &#123; List&lt;int[]&gt; type = new List&lt;int[]&gt;(); for (int i = 0, len = _data.Count; i &lt; len; i++) &#123; type.Add(new int[] &#123; 0, i &#125;); &#125; itemType = type; &#125; /// &lt;summary&gt; /// è®¾ç½®å•å…ƒæ ¼å¤§å° /// &lt;/summary&gt; /// &lt;param name=&quot;itd&quot;&gt;&lt;/param&gt; /// &lt;param name=&quot;size&quot;&gt;&lt;/param&gt; protected void SetCellSize(ItemTransformData itd, Vector2 size, bool resize = true) &#123; _itemSize[itd.item_type][itd.item_index] = size; if (resize) &#123; Resize(); &#125; &#125;&#125;","categories":[{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/categories/Unity/"},{"name":"å·¥å…·","slug":"Unity/å·¥å…·","permalink":"https://busyogg.github.io/categories/Unity/%E5%B7%A5%E5%85%B7/"}],"tags":[{"name":"C#","slug":"C","permalink":"https://busyogg.github.io/tags/C/"},{"name":"å·¥å…·ç±»","slug":"å·¥å…·ç±»","permalink":"https://busyogg.github.io/tags/%E5%B7%A5%E5%85%B7%E7%B1%BB/"},{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/tags/Unity/"},{"name":"UI","slug":"UI","permalink":"https://busyogg.github.io/tags/UI/"}]},{"title":"å¯¹è¯ç³»ç»Ÿ","slug":"å¯¹è¯ç³»ç»Ÿ","date":"2023-11-02T11:27:14.000Z","updated":"2024-05-18T15:40:15.086Z","comments":true,"path":"article/71fc63e69064/","link":"","permalink":"https://busyogg.github.io/article/71fc63e69064/","excerpt":"","text":"ç®€ä»‹é€šè¿‡å¯¹è¯æ ‘æž„é€ å¯¹è¯ç³»ç»Ÿï¼Œæ”¯æŒé€‰é¡¹åˆ†æ”¯ã€è‡ªåŠ¨å¯¹è¯å’Œå¯¹è¯åŽ†å²ã€‚ æ¼”ç¤º åŽŸç†é€šè¿‡æ ‘ç»“æž„ä¿å­˜å¯¹è¯èŠ‚ç‚¹ï¼Œæ²¡æœ‰é€‰é¡¹çš„æ—¶å€™è¿›å…¥ç´¢å¼•ä¸º 0 çš„ä¸‹ä¸€èŠ‚ç‚¹ï¼Œæœ‰é€‰é¡¹çš„æ—¶å€™æ ¹æ®é€‰é¡¹çš„ç´¢å¼•è¿›å…¥å¯¹åº”çš„ä¸‹ä¸€èŠ‚ç‚¹ã€‚ DialogueTree1234567891011121314151617181920212223242526272829303132333435363738394041424344using System.Collections.Generic;public class DialogueTree&#123; /// &lt;summary&gt; /// idï¼Œç”¨æ¥åˆ¤æ–­å¯¹è¯é¡ºåº /// &lt;/summary&gt; public int id &#123; get; set; &#125; /// &lt;summary&gt; /// å¯¹è¯idï¼Œç”¨æ¥åˆ¤æ–­æ‰€å±žå¯¹è¯æ ‘ /// &lt;/summary&gt; public int d_id &#123; get; set; &#125; /// &lt;summary&gt; /// å¯¹è¯äºº /// &lt;/summary&gt; public string target &#123; get; set; &#125; /// &lt;summary&gt; /// å†…å®¹ /// &lt;/summary&gt; public string content &#123; get; set; &#125; /// &lt;summary&gt; /// é€‰é¡¹ /// &lt;/summary&gt; public List&lt;string&gt; selection &#123; get; set; &#125; /// &lt;summary&gt; /// ä¸‹ä¸€å¯¹è¯ /// &lt;/summary&gt; public List&lt;DialogueTree&gt; next &#123; get; set; &#125; /// &lt;summary&gt; /// ç‰¹æ•ˆ æš‚æ— ç”¨å¤„ /// &lt;/summary&gt; public string effect &#123; get; set; &#125; /// &lt;summary&gt; /// è‡ªåŠ¨æ’­æ”¾é€Ÿåº¦ /// &lt;/summary&gt; public float autoSpeed &#123; get; set; &#125; public DialogueTree() &#123; next = new List&lt;DialogueTree&gt;(); selection = new List&lt;string&gt;(); &#125;&#125; è‡ªåŠ¨å¯¹è¯åˆ©ç”¨åç¨‹è¿›è¡Œï¼Œåœ¨é‡åˆ°é€‰é¡¹çš„æ—¶å€™åœæ­¢ï¼Œåœ¨é€‰é¡¹é€‰æ‹©åŽé‡æ–°å¼€å¯è‡ªåŠ¨å¯¹è¯åç¨‹ï¼›åœ¨æ‰‹åŠ¨ç‚¹å‡»ä¸‹ä¸€ä¸ªå¯¹è¯çš„æƒ…å†µä¸‹åœæ­¢åç¨‹å¹¶é‡æ–°å¼€å¯ä¸€ä¸ªè‡ªåŠ¨å¯¹è¯çš„åç¨‹ã€‚ å¯¹è¯åŽ†å²åˆ™æ˜¯æŠŠæ¯ä¸€æ¡å¯¹è¯å’Œé€‰æ‹©çš„é€‰é¡¹è®°å½•åˆ°ä¸€ä¸ªå¯¹è¯åˆ—è¡¨ä¸­ï¼Œå±•ç¤ºçš„æ—¶å€™åªè¦éåŽ†å³å¯ã€‚ UI é€»è¾‘UI å±•ç¤ºUI å±•ç¤ºå°è£…ä¸ºShowDialogueï¼Œæ¯æ¬¡è°ƒç”¨æ›´æ–°å¯¹è¯äººï¼Œå¯¹è¯å†…å®¹ï¼Œå¦‚æžœæœ‰é€‰é¡¹åˆ™æ ¹æ®é€‰é¡¹æ•°é‡æ˜¾ç¤ºé€‰é¡¹æŒ‰é’®ã€‚åŒæ—¶ï¼Œåœ¨è¯¥æ–¹æ³•å†…è°ƒç”¨DialogueManager.Instance().RecordDialogue(_content.text);è®°å½•å¯¹è¯å†…å®¹ç”¨äºŽå›žæ”¾ã€‚ 123456789101112131415161718192021/// &lt;summary&gt;/// UIå±•ç¤º/// &lt;/summary&gt;private void ShowDialogue()&#123; _content.text = DialogueManager.Instance().GetContent(); DialogueManager.Instance().RecordDialogue(_content.text); _target.text = DialogueManager.Instance().GetTarget(); List&lt;string&gt; selections = DialogueManager.Instance().GetSelection(); if (selections.Count &gt; 0) &#123; for (int i = 0, len = selections.Count; i &lt; len; i++) &#123; string selection = selections[i]; Button button = _buttons[i]; button.gameObject.transform.GetChild(0).GetComponent&lt;TextMeshProUGUI&gt;().text = selection; button.gameObject.SetActive(true); &#125; &#125;&#125; å¼€å§‹å¯¹è¯è°ƒç”¨DialogueManager.Instance().StartDialogue();æ–¹æ³•å¼€å§‹å¯¹è¯ï¼Œè¯¥æ–¹æ³•æŽ¥å—ä¸€ä¸ªå¯¹è¯ id å‚æ•°ã€‚ å¼€å§‹å¯¹è¯ä¹‹åŽï¼Œç«‹åˆ»è°ƒç”¨ShowDialogueå±•ç¤ºå¯¹è¯å†…å®¹ï¼Œå¹¶ä¸”åˆ¤æ–­æ˜¯å¦è‡ªåŠ¨å¯¹è¯ï¼Œæ˜¯çš„æƒ…å†µè°ƒç”¨è‡ªåŠ¨å¯¹è¯åç¨‹ 12345678910111213141516/// &lt;summary&gt;/// å¼€å§‹å¯¹è¯ç‚¹å‡»äº‹ä»¶/// &lt;/summary&gt;private void OnStartClick()&#123; _start.gameObject.SetActive(false); _dialoguePanel.SetActive(true); DialogueManager.Instance().StartDialogue(0); ShowDialogue(); if (_isAuto) &#123; _dialogCo = StartCoroutine(AutoDialogue()); &#125;&#125; è‡ªåŠ¨å¯¹è¯åˆ©ç”¨åç¨‹æ ¹æ®æ¯ä¸€æ®µå¯¹è¯çš„é€Ÿåº¦æ¥å†³å®šè‡ªåŠ¨è¿›å…¥ä¸‹ä¸€å¯¹è¯çš„æ—¶é—´ã€‚ ç‚¹å‡»æŒ‰é’®å¼€å¯è‡ªåŠ¨å¯¹è¯ï¼Œå†æ¬¡ç‚¹å‡»å…³é—­ã€‚ è‡ªåŠ¨å¯¹è¯åç¨‹ç­‰å¾…æ—¶é—´åˆ°äº†ä¹‹åŽï¼Œå…ˆåˆ¤æ–­æ˜¯å¦æœ‰ä¸‹ä¸€å¯¹è¯ã€‚ æ˜¯çš„æƒ…å†µåˆ¤æ–­ä¸‹ä¸€å¯¹è¯æ˜¯å¦æœ‰é€‰é¡¹ï¼Œæ²¡æœ‰é€‰é¡¹çš„æƒ…å†µä¸‹è¿›å…¥ä¸‹ä¸€å¯¹è¯ï¼Œæœ‰çš„è¯å°±åœæ­¢åç¨‹ã€‚ å¦çš„æƒ…å†µï¼Œç»“æŸå¯¹è¯ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142/// &lt;summary&gt;/// è‡ªåŠ¨å¯¹è¯ç‚¹å‡»äº‹ä»¶/// &lt;/summary&gt;private void OnAutoClick()&#123; _isAuto = !_isAuto; if (_isAuto) &#123; _dialogCo = StartCoroutine(AutoDialogue()); _auto.gameObject.transform.GetChild(0).GetComponent&lt;TextMeshProUGUI&gt;().text = &quot;Auto On&quot;; &#125; else &#123; StopCoroutine(_dialogCo); _auto.gameObject.transform.GetChild(0).GetComponent&lt;TextMeshProUGUI&gt;().text = &quot;Auto&quot;; &#125;&#125;/// &lt;summary&gt;/// è‡ªåŠ¨å¯¹è¯åç¨‹/// &lt;/summary&gt;/// &lt;returns&gt;&lt;/returns&gt;IEnumerator AutoDialogue()&#123; float speed = DialogueManager.Instance().GetAutoSpeed(); yield return new WaitForSeconds(speed); bool next = DialogueManager.Instance().Next(); if (next) &#123; bool nextSelection = DialogueManager.Instance().GetSelection().Count == 0; if (nextSelection) &#123; StartCoroutine(AutoDialogue()); &#125; ShowDialogue(); &#125; else &#123; _start.gameObject.SetActive(true); _dialoguePanel.SetActive(false); &#125;&#125; ä¸‹ä¸€å¯¹è¯é¦–å…ˆåˆ¤æ–­é€‰é¡¹æŒ‰é’®æ˜¯å¦æ˜¾ç¤ºï¼Œæ˜¾ç¤ºçš„æƒ…å†µä¸‹ç¦æ­¢è¿›å…¥ä¸‹ä¸€å¯¹è¯ã€‚å¦åˆ™è°ƒç”¨DialogueManager.Instance().Next()è¿›å…¥ä¸‹ä¸€å¯¹è¯ï¼Œå¹¶ä¸”è°ƒç”¨ShowDialogue()æ›´æ–° UIã€‚å¦‚æžœæ²¡æœ‰ä¸‹ä¸€å¯¹è¯å°±ç»“æŸå¯¹è¯ã€‚ åœ¨å¼€å¯è‡ªåŠ¨å¯¹è¯çš„æƒ…å†µä¸‹ï¼Œå…ˆåœæ­¢ä¸Šä¸€ä¸ªè‡ªåŠ¨å¯¹è¯çš„åç¨‹é˜²æ­¢å†²çªï¼Œç„¶åŽå¦èµ·ä¸€ä¸ªè‡ªåŠ¨å¯¹è¯åç¨‹ã€‚ 12345678910111213141516171819202122232425/// &lt;summary&gt;/// ä¸‹ä¸€å¯¹è¯ç‚¹å‡»äº‹ä»¶/// &lt;/summary&gt;private void OnNextClick()&#123; if (!_buttons[0].gameObject.activeInHierarchy) &#123; bool next = DialogueManager.Instance().Next(); if (next) &#123; ShowDialogue(); &#125; else &#123; _start.gameObject.SetActive(true); _dialoguePanel.SetActive(false); &#125; if (_isAuto) &#123; StopCoroutine(_dialogCo); _dialogCo = StartCoroutine(AutoDialogue()); &#125; &#125;&#125; é€‰é¡¹ç‚¹å‡»é€‰é¡¹çš„æ—¶å€™è°ƒç”¨DialogueManager.Instance().SetSelect(index)è®¾ç½®å½“å‰é€‰é¡¹ï¼Œè°ƒç”¨DialogueManager.Instance().RecordDialogue(DialogueManager.Instance().GetSelection()[index])ä¿å­˜å·²é€‰é€‰é¡¹çš„å†…å®¹åˆ°å¯¹è¯åŽ†å²ä¸­ã€‚ç„¶åŽå°±æ˜¯å’Œç‚¹å‡»ä¸‹ä¸€å¯¹è¯çš„é€»è¾‘ä¸€æ ·ã€‚å¦å¤–åœ¨å®Œæˆé€‰æ‹©åŽéšè—æ‰€æœ‰é€‰é¡¹ã€‚ 1234567891011121314151617181920/// &lt;summary&gt;/// é€‰é¡¹ç‚¹å‡»äº‹ä»¶/// &lt;/summary&gt;/// &lt;param name=&quot;index&quot;&gt;&lt;/param&gt;private void OnSelectClick(int index)&#123; DialogueManager.Instance().SetSelect(index); DialogueManager.Instance().RecordDialogue(DialogueManager.Instance().GetSelection()[index]); DialogueManager.Instance().Next(); for (int i = 0; i &lt; _buttons.Count; i++) &#123; Button button = _buttons[i]; button.gameObject.SetActive(false); &#125; ShowDialogue(); if (_isAuto) &#123; _dialogCo = StartCoroutine(AutoDialogue()); &#125;&#125; å¯¹è¯åŽ†å²å¯¹è¯åŽ†å²åªè¦è°ƒç”¨DialogueManager.Instance().GetRecordedDialogue()èŽ·å¾—åŽ†å²å¯¹è¯åˆ—è¡¨ï¼Œç„¶åŽæ ¹æ®éœ€è¦è¾“å‡ºå³å¯ã€‚ 1234567891011/// &lt;summary&gt;/// å¯¹è¯å›žæ”¾ç‚¹å‡»äº‹ä»¶/// &lt;/summary&gt;private void OnRecordClick() &#123; List&lt;string&gt; record = DialogueManager.Instance().GetRecordedDialogue(); for(int i = 0,len = record.Count; i &lt; len; i++) &#123; string rec = record[i]; Debug.Log(rec); &#125;&#125; å¯¹è¯ç®¡ç†å™¨å¯¹è¯ç®¡ç†å™¨è´Ÿè´£ç®€å•çš„æ•°æ®å­˜å‚¨å’ŒèŽ·å–åŠŸèƒ½ã€‚æœ€å¤æ‚çš„éƒ¨åˆ†å°±åœ¨äºŽé€‰æ‹©ä¸‹ä¸€å¯¹è¯ã€‚ ä¸‹ä¸€å¯¹è¯å…ˆåˆ¤æ–­æ˜¯å¦æœ‰é€‰é¡¹ æœ‰é€‰é¡¹çš„æƒ…å†µï¼Œä¸‹ä¸€å¯¹è¯ç›´æŽ¥æ ¹æ®å½“å‰é€‰æ‹©çš„ç´¢å¼•åŽ»_curDialogue.nextä¸­å–å¯¹åº”ç´¢å¼•çš„èŠ‚ç‚¹ã€‚ æ²¡æœ‰é€‰é¡¹çš„æƒ…å†µï¼Œå¦‚æžœ_curDialogue.nextçš„è®¡æ•°å¤§äºŽ 0ï¼Œå³æœ‰ä¸‹ä¸€å¯¹è¯ï¼Œåˆ™ç½®å½“å‰å¯¹è¯èŠ‚ç‚¹_curDialogueä¸º_curDialogue.next[0]ï¼ˆä¿å­˜çš„ä¸‹ä¸€å¯¹è¯åªæœ‰ä¸€ä¸ªï¼Œç´¢å¼•ä¸º 0ï¼‰ã€‚å¦åˆ™ç½®ä¸‹ä¸€å¯¹è¯ä¸ºnullã€‚ ä¸‹ä¸€å¯¹è¯é€‰æ‹©å®ŒæˆåŽï¼Œè¿”å›žæˆåŠŸæˆ–å¤±è´¥çš„ç»“æžœï¼Œç”¨äºŽ UI å±•ç¤ºã€‚ 12345678910111213141516171819202122232425/// &lt;summary&gt;/// ä¸‹ä¸€å¯¹è¯/// &lt;/summary&gt;public bool Next()&#123; if (_curDialogue.selection.Count == 0) &#123; if (_curDialogue.next.Count &gt; 0) &#123; _curDialogue = _curDialogue.next[0]; return true; &#125; else &#123; _curDialogue = null; return false; &#125; &#125; else &#123; _curDialogue = _curDialogue.next[_select]; return true; &#125;&#125; ä»£ç å¯¹è¯æ ‘1234567891011121314151617181920212223242526272829303132333435363738394041424344using System.Collections.Generic;public class DialogueTree&#123; /// &lt;summary&gt; /// idï¼Œç”¨æ¥åˆ¤æ–­å¯¹è¯é¡ºåº /// &lt;/summary&gt; public int id &#123; get; set; &#125; /// &lt;summary&gt; /// å¯¹è¯idï¼Œç”¨æ¥åˆ¤æ–­æ‰€å±žå¯¹è¯æ ‘ /// &lt;/summary&gt; public int d_id &#123; get; set; &#125; /// &lt;summary&gt; /// å¯¹è¯äºº /// &lt;/summary&gt; public string target &#123; get; set; &#125; /// &lt;summary&gt; /// å†…å®¹ /// &lt;/summary&gt; public string content &#123; get; set; &#125; /// &lt;summary&gt; /// é€‰é¡¹ /// &lt;/summary&gt; public List&lt;string&gt; selection &#123; get; set; &#125; /// &lt;summary&gt; /// ä¸‹ä¸€å¯¹è¯ /// &lt;/summary&gt; public List&lt;DialogueTree&gt; next &#123; get; set; &#125; /// &lt;summary&gt; /// ç‰¹æ•ˆ æš‚æ— ç”¨å¤„ /// &lt;/summary&gt; public string effect &#123; get; set; &#125; /// &lt;summary&gt; /// è‡ªåŠ¨æ’­æ”¾é€Ÿåº¦ /// &lt;/summary&gt; public float autoSpeed &#123; get; set; &#125; public DialogueTree() &#123; next = new List&lt;DialogueTree&gt;(); selection = new List&lt;string&gt;(); &#125;&#125; UIè„šæœ¬123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190using System.Collections;using System.Collections.Generic;using TMPro;using UnityEngine;using UnityEngine.UI;public class RootScript : MonoBehaviour&#123; //UIæŽ§ä»¶ -----start public TextMeshProUGUI _content; public List&lt;Button&gt; _buttons; public Button _auto; public Button _start; public Button _panel; public Button _record; public TextMeshProUGUI _target; public GameObject _dialoguePanel; //UIæŽ§ä»¶ -----end /// &lt;summary&gt; /// æ˜¯å¦è‡ªåŠ¨å¯¹è¯ /// &lt;/summary&gt; private bool _isAuto = false; /// &lt;summary&gt; /// è‡ªåŠ¨å¯¹è¯åç¨‹ /// &lt;/summary&gt; private Coroutine _dialogCo; void Start() &#123; DialogueManager.Instance().Init(); _auto.onClick.AddListener(OnAutoClick); _start.onClick.AddListener(OnStartClick); _panel.onClick.AddListener(OnNextClick); _record.onClick.AddListener(OnRecordClick); for (int i = 0, len = _buttons.Count; i &lt; len; i++) &#123; Button button = _buttons[i]; int index = i; button.onClick.AddListener(() =&gt; &#123; OnSelectClick(index); &#125;); &#125; &#125; /// &lt;summary&gt; /// UIå±•ç¤º /// &lt;/summary&gt; private void ShowDialogue() &#123; _content.text = DialogueManager.Instance().GetContent(); DialogueManager.Instance().RecordDialogue(_content.text); _target.text = DialogueManager.Instance().GetTarget(); List&lt;string&gt; selections = DialogueManager.Instance().GetSelection(); if (selections.Count &gt; 0) &#123; for (int i = 0, len = selections.Count; i &lt; len; i++) &#123; string selection = selections[i]; Button button = _buttons[i]; button.gameObject.transform.GetChild(0).GetComponent&lt;TextMeshProUGUI&gt;().text = selection; button.gameObject.SetActive(true); &#125; &#125; &#125; /// &lt;summary&gt; /// å¼€å§‹å¯¹è¯ç‚¹å‡»äº‹ä»¶ /// &lt;/summary&gt; private void OnStartClick() &#123; _start.gameObject.SetActive(false); _dialoguePanel.SetActive(true); DialogueManager.Instance().StartDialogue(0); ShowDialogue(); if (_isAuto) &#123; _dialogCo = StartCoroutine(AutoDialogue()); &#125; &#125; /// &lt;summary&gt; /// è‡ªåŠ¨å¯¹è¯ç‚¹å‡»äº‹ä»¶ /// &lt;/summary&gt; private void OnAutoClick() &#123; _isAuto = !_isAuto; if (_isAuto) &#123; _dialogCo = StartCoroutine(AutoDialogue()); _auto.gameObject.transform.GetChild(0).GetComponent&lt;TextMeshProUGUI&gt;().text = &quot;Auto On&quot;; &#125; else &#123; StopCoroutine(_dialogCo); _auto.gameObject.transform.GetChild(0).GetComponent&lt;TextMeshProUGUI&gt;().text = &quot;Auto&quot;; &#125; &#125; /// &lt;summary&gt; /// ä¸‹ä¸€å¯¹è¯ç‚¹å‡»äº‹ä»¶ /// &lt;/summary&gt; private void OnNextClick() &#123; if (!_buttons[0].gameObject.activeInHierarchy) &#123; bool next = DialogueManager.Instance().Next(); if (next) &#123; ShowDialogue(); &#125; else &#123; _start.gameObject.SetActive(true); _dialoguePanel.SetActive(false); &#125; if (_isAuto) &#123; StopCoroutine(_dialogCo); _dialogCo = StartCoroutine(AutoDialogue()); &#125; &#125; &#125; /// &lt;summary&gt; /// é€‰é¡¹ç‚¹å‡»äº‹ä»¶ /// &lt;/summary&gt; /// &lt;param name=&quot;index&quot;&gt;&lt;/param&gt; private void OnSelectClick(int index) &#123; DialogueManager.Instance().SetSelect(index); DialogueManager.Instance().RecordDialogue(DialogueManager.Instance().GetSelection()[index]); DialogueManager.Instance().Next(); for (int i = 0; i &lt; _buttons.Count; i++) &#123; Button button = _buttons[i]; button.gameObject.SetActive(false); &#125; ShowDialogue(); if (_isAuto) &#123; _dialogCo = StartCoroutine(AutoDialogue()); &#125; &#125; /// &lt;summary&gt; /// å¯¹è¯å›žæ”¾ç‚¹å‡»äº‹ä»¶ /// &lt;/summary&gt; private void OnRecordClick() &#123; List&lt;string&gt; record = DialogueManager.Instance().GetRecordedDialogue(); for(int i = 0,len = record.Count; i &lt; len; i++) &#123; string rec = record[i]; Debug.Log(rec); &#125; &#125; /// &lt;summary&gt; /// è‡ªåŠ¨å¯¹è¯åç¨‹ /// &lt;/summary&gt; /// &lt;returns&gt;&lt;/returns&gt; IEnumerator AutoDialogue() &#123; float speed = DialogueManager.Instance().GetAutoSpeed(); yield return new WaitForSeconds(speed); bool next = DialogueManager.Instance().Next(); if (next) &#123; bool nextSelection = DialogueManager.Instance().GetSelection().Count == 0; if (nextSelection) &#123; StartCoroutine(AutoDialogue()); &#125; ShowDialogue(); &#125; else &#123; _start.gameObject.SetActive(true); _dialoguePanel.SetActive(false); &#125; &#125;&#125; å¯¹è¯ç®¡ç†å™¨123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168using System.Collections.Generic;public class DialogueManager&#123; private static DialogueManager _instance = null; private List&lt;DialogueTree&gt; _dialogues = new List&lt;DialogueTree&gt;(); private DialogueTree _curDialogue = null; private int _select; private List&lt;string&gt; _record = new List&lt;string&gt;(); public static DialogueManager Instance() &#123; if (_instance == null) &#123; _instance = new DialogueManager(); &#125; return _instance; &#125; private DialogueManager() &#123; &#125; public void Init() &#123; DialogueTree d1 = new DialogueTree(); d1.id = 0; d1.d_id = 0; d1.content = &quot;ç¬¬ä¸€æ¡å¯¹è¯&quot;; d1.target = &quot;NPC&quot;; d1.autoSpeed = 2; DialogueTree d2 = new DialogueTree(); d2.id = 1; d2.d_id = 0; d2.content = &quot;ç¬¬äºŒæ¡å¯¹è¯&quot;; d2.target = &quot;NPC&quot;; d2.autoSpeed = 2; d2.selection.Add(&quot;é€‰é¡¹1&quot;); d2.selection.Add(&quot;é€‰é¡¹2&quot;); DialogueTree d3 = new DialogueTree(); d3.id = 2; d3.d_id = 0; d3.content = &quot;ç¬¬ä¸‰æ¡å¯¹è¯&quot;; d3.target = &quot;NPC&quot;; d3.autoSpeed = 2; DialogueTree d4 = new DialogueTree(); d4.id = 3; d4.d_id = 0; d4.content = &quot;ç¬¬å››æ¡å¯¹è¯&quot;; d4.target = &quot;Player&quot;; d4.autoSpeed = 2; d1.next.Add(d2); d2.next.Add(d3); d2.next.Add(d4); _dialogues.Add(d1); &#125; /// &lt;summary&gt; /// å¼€å§‹å¯¹è¯ /// &lt;/summary&gt; /// &lt;param name=&quot;id&quot;&gt;&lt;/param&gt; public void StartDialogue(int id) &#123; _curDialogue = _dialogues[id]; &#125; /// &lt;summary&gt; /// èŽ·å–å¯¹è¯å†…å®¹ /// &lt;/summary&gt; /// &lt;returns&gt;&lt;/returns&gt; public string GetContent() &#123; return _curDialogue?.content; &#125; /// &lt;summary&gt; /// èŽ·å–å¯¹è¯äºº /// &lt;/summary&gt; /// &lt;returns&gt;&lt;/returns&gt; public string GetTarget() &#123; return _curDialogue?.target; &#125; /// &lt;summary&gt; /// èŽ·å¾—é€‰é¡¹ /// &lt;/summary&gt; /// &lt;returns&gt;&lt;/returns&gt; public List&lt;string&gt; GetSelection() &#123; return _curDialogue?.selection; &#125; /// &lt;summary&gt; /// èŽ·å¾—è‡ªåŠ¨å¯¹è¯é€Ÿåº¦ /// &lt;/summary&gt; /// &lt;returns&gt;&lt;/returns&gt; public float GetAutoSpeed() &#123; return _curDialogue.autoSpeed; &#125; /// &lt;summary&gt; /// è®¾ç½®é€‰é¡¹ /// &lt;/summary&gt; /// &lt;param name=&quot;select&quot;&gt;&lt;/param&gt; public void SetSelect(int select) &#123; _select = select; &#125; /// &lt;summary&gt; /// ä¸‹ä¸€å¯¹è¯ /// &lt;/summary&gt; public bool Next() &#123; if (_curDialogue.selection.Count == 0) &#123; if (_curDialogue.next.Count &gt; 0) &#123; _curDialogue = _curDialogue.next[0]; return true; &#125; else &#123; _curDialogue = null; return false; &#125; &#125; else &#123; _curDialogue = _curDialogue.next[_select]; return true; &#125; &#125; /// &lt;summary&gt; /// è®°å½•å¯¹è¯ /// &lt;/summary&gt; /// &lt;param name=&quot;content&quot;&gt;&lt;/param&gt; public void RecordDialogue(string content) &#123; _record.Add(content); &#125; /// &lt;summary&gt; /// èŽ·å¾—å¯¹è¯è®°å½• /// &lt;/summary&gt; /// &lt;returns&gt;&lt;/returns&gt; public List&lt;string&gt; GetRecordedDialogue() &#123; return _record; &#125; /// &lt;summary&gt; /// æ¸…é™¤å¯¹è¯è®°å½• /// &lt;/summary&gt; public void ClearRecordedDialogue() &#123; _record.Clear(); &#125;&#125;","categories":[{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/categories/Unity/"},{"name":"å·¥å…·","slug":"Unity/å·¥å…·","permalink":"https://busyogg.github.io/categories/Unity/%E5%B7%A5%E5%85%B7/"}],"tags":[{"name":"C#","slug":"C","permalink":"https://busyogg.github.io/tags/C/"},{"name":"å·¥å…·ç±»","slug":"å·¥å…·ç±»","permalink":"https://busyogg.github.io/tags/%E5%B7%A5%E5%85%B7%E7%B1%BB/"},{"name":"ç³»ç»Ÿæž¶æž„","slug":"ç³»ç»Ÿæž¶æž„","permalink":"https://busyogg.github.io/tags/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/"},{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/tags/Unity/"}]},{"title":"è¿žæ‹›ç³»ç»Ÿ","slug":"è¿žæ‹›ç³»ç»Ÿ","date":"2023-10-31T17:11:49.000Z","updated":"2024-05-18T15:39:50.874Z","comments":true,"path":"article/69e4e16ef4ee/","link":"","permalink":"https://busyogg.github.io/article/69e4e16ef4ee/","excerpt":"","text":"ç®€ä»‹ä½¿ç”¨æœ‰é™çŠ¶æ€æœºæž„é€ çš„è¿žæ‹›ç³»ç»Ÿï¼Œæ”¯æŒæŠ€èƒ½è¿žæ‹›ã€åˆ†æ”¯æŠ€èƒ½ã€æ‰“æ–­ã€å˜æ‹›ã€é•¿æŒ‰æŠ€èƒ½ã€è“„åŠ›æŠ€èƒ½ã€‚ æ¼”ç¤º åŽŸç†åœ¨ Update ä¸­æŒç»­åˆ¤æ–­çŠ¶æ€åˆ‡æ¢ï¼Œå¹¶æ ¹æ®å½“å‰çŠ¶æ€æ‰§è¡Œå¯¹åº”çš„æ“ä½œã€‚ çŠ¶æ€æœºåˆ†ä¸ºäº”ä¸ªçŠ¶æ€ï¼ŒIdleã€Runningã€Holdingã€Charging ä»¥åŠ Waitingã€‚å…¶ä¸­ Running ä¸ºéžé•¿æŒ‰æŠ€èƒ½é‡Šæ”¾çŠ¶æ€ï¼›Holding ä¸ºé•¿æŒ‰æŠ€èƒ½ï¼›Charging ä¸ºè“„åŠ›æŠ€èƒ½ã€‚ æŠ€èƒ½æ ‘æœ¬ç³»ç»Ÿç»´æŠ¤ä¸€ä¸ªæŠ€èƒ½åˆ—è¡¨ï¼ŒæŠ€èƒ½åˆ—è¡¨ä¸­ä¿å­˜è‡ªå®šä¹‰çš„æŠ€èƒ½æ ‘ã€‚ SkillTree123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869using System.Collections.Generic;using UnityEngine;public class SkillTree&#123; /// &lt;summary&gt; /// æŠ€èƒ½åç§° /// &lt;/summary&gt; public string name &#123; get; set; &#125; /// &lt;summary&gt; /// æŠ€èƒ½id ä¸€ç³»åˆ—æŠ€èƒ½ä½¿ç”¨åŒä¸€id /// &lt;/summary&gt; public int id &#123; get; set; &#125; /// &lt;summary&gt; /// é”®ä½éœ€æ±‚ /// &lt;/summary&gt; public KeyCode key &#123; get; set; &#125; /// &lt;summary&gt; /// ä¸‹ä¸€è¿žæ‹›åˆ—è¡¨ /// &lt;/summary&gt; public List&lt;SkillTree&gt; next &#123; get; set; &#125; /// &lt;summary&gt; /// æŠ€èƒ½æŒç»­æ—¶é—´ /// &lt;/summary&gt; public float skillTime &#123; get; set; &#125; /// &lt;summary&gt; /// æ˜¯å¦æ­£åœ¨é‡Šæ”¾æŠ€èƒ½ /// &lt;/summary&gt; public bool isRunSkill &#123; get; set; &#125; /// &lt;summary&gt; /// è¿žæ‹›è¶…æ—¶æ—¶é—´ /// &lt;/summary&gt; public float outOfTime &#123; get; set; &#125; /// &lt;summary&gt; /// æ˜¯å¦å¯ä»¥å¼ºåˆ¶æ‰“æ–­æŠ€èƒ½ /// &lt;/summary&gt; public bool isCanForceStop &#123; get; set; &#125; /// &lt;summary&gt; /// å¼ºåˆ¶æ‰“æ–­æ¬¡æ•° /// &lt;/summary&gt; public int forceTimes &#123; get; set; &#125; /// &lt;summary&gt; /// é»˜è®¤å¼ºåˆ¶æ‰“æ–­æ¬¡æ•° /// &lt;/summary&gt; public int defaultForceTimes &#123; get; set; &#125; /// &lt;summary&gt; /// å¼ºåˆ¶æ‰“æ–­é‡ç½®æ—¶é—´ /// &lt;/summary&gt; public float forceResetTime &#123; get; set; &#125; /// &lt;summary&gt; /// æŠ€èƒ½ç±»åž‹ /// &lt;/summary&gt; public SkillType skillType &#123; get; set; &#125; /// &lt;summary&gt; /// é•¿æŒ‰/è“„åŠ›æ—¶é—´ /// &lt;/summary&gt; public float holdingTime &#123; get; set; &#125; /// &lt;summary&gt; /// è¿›åº¦æ¡é¢œè‰² /// &lt;/summary&gt; public Color progressColor &#123; get; set; &#125; public SkillTree() &#123; skillType = SkillType.Click; progressColor = Color.white; next = new List&lt;SkillTree&gt;(); &#125;&#125; æœ¬ç³»ç»Ÿè¿˜ç»´æŠ¤å½“å‰ä½¿ç”¨çš„æŠ€èƒ½ã€è¾“å…¥é—´éš”æ—¶é—´ã€æŠ€èƒ½æŒç»­æ—¶é—´ã€è“„åŠ›&#x2F;é•¿æŒ‰æ—¶é—´ã€‚è¿™äº›æ•°æ®æ˜¯è¿žæ‹›åˆ¤å®šçš„ç›¸å…³æ•°æ®ã€‚ è¿žæ‹›åˆ¤å®šæ–¹æ³•æˆ‘ä»¬åœ¨æŠ€èƒ½æ ‘ä¸­ä¿å­˜äº†éœ€è¦æŒ‰ä¸‹çš„æŒ‰é”®ï¼Œåªè¦åˆ¤æ–­è¾“å…¥äº‹ä»¶æ˜¯å¦å’Œæ‰€éœ€è¦çš„é”®ä½ç›¸åŒå³å¯ã€‚ è¿žæ‹›åˆ¤å®šåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯ä»Žæ ¹æŠ€èƒ½ï¼ˆå³èµ·æ‰‹å¼ï¼‰çš„æƒ…å†µï¼Œä¸€ä¸ªæ˜¯åˆ¤å®šè¿žæ‹›çš„æƒ…å†µã€‚ æ ¹æŠ€èƒ½çš„æƒ…å†µä¸‹æœ‰ä¸¤ç§åˆ¤æ–­ï¼Œä¸€ä¸ªæ˜¯æŠ€èƒ½æ‰“æ–­çš„åˆ¤æ–­ï¼Œä¸€ä¸ªæ˜¯å¼€å§‹æ”¾æŠ€èƒ½çš„åˆ¤æ–­ã€‚æˆ‘ä»¬åªè¦æ£€æµ‹æœ€è¿‘æœ‰æ— æ”¾è¿‡æŠ€èƒ½å°±èƒ½åˆ†è¾¨æ˜¯ä»€ä¹ˆæƒ…å†µçš„åˆ¤æ–­ã€‚ è¿žæ‹›çš„æƒ…å†µä¸‹ä¹Ÿæœ‰ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯è¿žæ‹›æˆåŠŸï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä¿å­˜å½“å‰çš„æŠ€èƒ½ä¸ºè¿žæ‹›çš„æŠ€èƒ½ï¼›å¦ä¸€ç§æ˜¯è¿žæ‹›å¤±è´¥ï¼Œå³ä¸‹ä¸€ä¸ªé”®ä½ä¸æ˜¯è¿žæ‹›çš„é”®ä½ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¿”å›žä¸€ä¸ªé”™è¯¯è¿žæ‹›çš„çŠ¶æ€ã€‚ åˆ¤å®šè¿žæ‹›é”®ä½çš„æ—¶å€™æˆ‘ä»¬éåŽ†é”®ä½åˆ—è¡¨ï¼Œå³å¯åšå‡ºåˆ†æ”¯æ”»å‡»ã€‚ æŠ€èƒ½æ‰“æ–­é™åˆ¶æ¬¡æ•°ï¼Œæ¯æ¬¡æ‰“æ–­éƒ½ä¼šå‡å°‘æ¬¡æ•°ï¼Œå¹¶ä¸”å¼€å¯ä¸€ä¸ªåç¨‹ç­‰å¾…æ¢å¤æŠ€èƒ½æ‰“æ–­æ¬¡æ•°ã€‚æœ¬ç³»ç»Ÿçš„é€»è¾‘ä¸ºç¬¬ä¸€æ¬¡æ‰“æ–­å¼€å§‹è®¡æ—¶ï¼Œæ—¶é—´åˆ°äº†å°±æ¢å¤æ¬¡æ•°ï¼Œä¸è®ºé‡ç½®å‰ä½¿ç”¨å¤šå°‘æ¬¡ï¼Œä¹Ÿä¸ä¼šå‘åŽæŽ¨å»¶å€’è®¡æ—¶ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980/// &lt;summary&gt;/// æ£€æµ‹è¿žæ‹›æ˜¯å¦æˆåŠŸ/// &lt;/summary&gt;/// &lt;param name=&quot;isRoot&quot;&gt;&lt;/param&gt;/// &lt;returns&gt;&lt;/returns&gt;private ComboState CheckSkillKey(bool isRoot)&#123; if (Input.anyKeyDown) &#123; if (isRoot) &#123; if (_curSkill != null) &#123; //å­˜åœ¨æœ€è¿‘æŠ€èƒ½ï¼Œå¹¶ä¸”ä»ŽæŠ€èƒ½èµ·æ‰‹å¼å¼€å§‹æ£€æµ‹ è¯¥æƒ…å†µä¸ºæ‰“æ–­æ£€æµ‹ for (int i = 0, len = _skills.Count; i &lt; len; i++) &#123; SkillTree skill = _skills[i]; if (skill.isCanForceStop &amp;&amp; skill.forceTimes &gt; 0 &amp;&amp; Input.GetKeyDown(skill.key)) &#123; Debug.Log(&quot;æ‰“æ–­å¹¶å¼ºåˆ¶å¼€å§‹è¿žæ‹›&quot; + skill.key); StopCoroutine(_skillCo); if (skill.name != _curSkill.name) &#123; _curSkill.isRunSkill = false; //_curSkill.forceTimes = _curSkill.defaultForceTimes; &#125; _curSkill = skill; --_curSkill.forceTimes; bool reset; _forceReset.TryGetValue(_curSkill.id, out reset); if (!reset) &#123; StartCoroutine(WaitForForceTimesReset(_curSkill)); &#125; return ComboState.Success; &#125; &#125; &#125; else &#123; //æŸ¥æ‰¾è¿žæ‹›èµ·æ‰‹å¼ for (int i = 0, len = _skills.Count; i &lt; len; i++) &#123; SkillTree skill = _skills[i]; if (Input.GetKeyDown(skill.key)) &#123; Debug.Log(&quot;å¼€å§‹è¿žæ‹›&quot; + skill.key); _curSkill = skill; return ComboState.Success; &#125; &#125; &#125; &#125; else &#123; //æ£€æµ‹è¿žæ‹›åˆ†æ”¯ for (int i = 0, len = _curSkill.next.Count; i &lt; len; i++) &#123; SkillTree skill = _curSkill.next[i]; if (Input.GetKeyDown(skill.key)) &#123; //è¿žæ‹›æˆåŠŸ _curSkill = _curSkill.next[i]; return ComboState.Success; &#125; &#125; //è¿žé”™æ‹› é‡ç½® Debug.Log(&quot;è¿žæ‹›é‡ç½®&quot;); return ComboState.Wrong; &#125; &#125; return ComboState.Fail;&#125; çŠ¶æ€åˆ‡æ¢Idleå¾…æœºçŠ¶æ€ï¼Œè¿™ä¸ªçŠ¶æ€ä¸ºåˆå§‹çŠ¶æ€ï¼Œè´Ÿè´£æŽ¥æ”¶æŠ€èƒ½çš„èµ·æ‰‹å¼æŒ‰é”®ã€‚å¦‚æžœçŽ©å®¶æŒ‰ä¸‹çš„æŒ‰é”®æ˜¯æŸä¸€æŠ€èƒ½çš„èµ·æ‰‹å¼ï¼Œé‚£ä¹ˆå½“å‰çŠ¶æ€å°±ç½®ä¸º Runningã€Holding å’Œ Charging ä¸­çš„ä¸€ç§ï¼ˆæ ¹æ®æŠ€èƒ½æ ‘è®¾ç½®ï¼‰ã€‚ RunningæŠ€èƒ½æ‰§è¡ŒçŠ¶æ€ï¼Œè¿™ä¸ªçŠ¶æ€è´Ÿè´£æ‰§è¡ŒæŠ€èƒ½ç­‰å¾…åç¨‹å’ŒæŠ€èƒ½æ‰“æ–­åˆ¤å®šã€‚ è¯¥çŠ¶æ€ä¼šå¼€å¯ä¸€æ¬¡æŠ€èƒ½ç­‰å¾…åç¨‹ï¼Œé‡ç½®æŠ€èƒ½æ—¶é—´ã€‚è¯¥çŠ¶æ€ä¸‹ä¼šæŒç»­å¢žåŠ æŠ€èƒ½ç­‰å¾…æ—¶é—´ã€‚æŠ€èƒ½ç­‰å¾…åç¨‹æ‰§è¡Œå®Œæ¯•ä¼šè‡ªåŠ¨åˆ‡æ¢ä¸º Waiting çŠ¶æ€å¹¶ä¸”é‡ç½®æŠ€èƒ½çš„æ‰§è¡ŒçŠ¶æ€ã€‚ å¦‚æžœæŠ€èƒ½æ‰“æ–­æˆåŠŸï¼Œåˆ™æˆ‘ä»¬å°±é‡ç½®è¾“å…¥é—´éš”æ—¶é—´ã€‚ç”±äºŽè¿™ä¸ªæ—¶å€™æŠ€èƒ½å˜ä¸ºäº†æ–°çš„ï¼Œå› æ­¤ä¼šé‡æ–°æ‰§è¡Œä¸€æ¬¡ä¸Šè¿°è¡Œä¸ºã€‚ Holdingé•¿æŒ‰æŠ€èƒ½çŠ¶æ€ï¼ŒæŒ‰ä½æŒ‰é”®æŠ€èƒ½å°±ä¸€ç›´é‡Šæ”¾ï¼ŒæŒ‰é”®æ”¾ä¸‹å°±ç»“æŸå¹¶è½¬ä¸º Waiting çŠ¶æ€ã€‚ è¯¥çŠ¶æ€æŒç»­å¢žåŠ é•¿æŒ‰æ—¶é—´ï¼Œä¸€æ—¦é”®ä½ä¸å†æŒç»­è¾“å…¥æˆ–è€…è¶…è¿‡æœ€å¤§æŒç»­æ—¶é—´ï¼Œå°±ä¼šç½®çŠ¶æ€ä¸º Waitingã€‚è€ƒè™‘åˆ°æŒ‰é”®ä¸€æ¾å¼€å°±ä¼šç»“æŸé•¿æŒ‰çŠ¶æ€ï¼Œå› æ­¤è¿™ä¸ªçŠ¶æ€æ²¡æœ‰åˆ¤æ–­æŠ€èƒ½æ‰“æ–­ã€‚ Chargingè“„åŠ›çŠ¶æ€ï¼ŒæŒ‰ä½æŒ‰é”®æŠ€èƒ½å¼€å§‹è“„åŠ›ï¼ŒæŒ‰é”®æ”¾ä¸‹å°±ç»“æŸå¹¶è½¬ä¸º Idle çŠ¶æ€ã€‚ è¯¥çŠ¶æ€æŒç»­å¢žåŠ è“„åŠ›æ—¶é—´ï¼Œä¸€æ—¦é”®ä½åœæ­¢è¾“å…¥ï¼Œåˆ™æ‰“æ–­è“„åŠ›ã€‚ç”±äºŽè“„åŠ›æœªå®Œæˆï¼Œè¿žæ‹›ä¸­æ–­ï¼Œå› æ­¤è¿›å…¥ Idle çŠ¶æ€ã€‚è€ƒè™‘åˆ°æŒ‰é”®ä¸€æ¾å¼€å°±ä¼šç»“æŸè“„åŠ›çŠ¶æ€ï¼Œæ‰€ä»¥è¿™ä¸ªçŠ¶æ€æ²¡æœ‰åˆ¤æ–­æŠ€èƒ½æ‰“æ–­ã€‚ å½“è“„åŠ›æ—¶é—´è¶…è¿‡æŠ€èƒ½æ‰€éœ€æ—¶é—´ï¼Œåˆ™è½¬æ¢ä¸º Running çŠ¶æ€ï¼Œæ‰§è¡Œ Running çŠ¶æ€çš„æŠ€èƒ½é‡Šæ”¾ï¼Œè¿™æ—¶å€™å’Œæ™®é€šç‚¹æŒ‰æŠ€èƒ½é‡Šæ”¾çš„æ•ˆæžœä¸€æ ·ã€‚ æ€»çš„æ¥è¯´ï¼Œè“„åŠ›æŠ€èƒ½å°±æ˜¯åœ¨æŠ€èƒ½é‡Šæ”¾çŠ¶æ€ä¹‹å‰ï¼Œå¢žåŠ äº†ä¸€ä¸ªè“„åŠ›è¿‡ç¨‹ï¼Œå…¶ä»–å’Œç‚¹æŒ‰æŠ€èƒ½ä¸€è‡´ã€‚ Waitingç­‰å¾…çŠ¶æ€ï¼Œè´Ÿè´£æŠ€èƒ½è¿žæ‹›ä¹‹é—´çš„ç­‰å¾…è¾“å…¥ã€‚è¯¥çŠ¶æ€ä¸‹æ¯å¸§éƒ½ä¼šå¢žåŠ è¾“å…¥é—´éš”æ—¶é—´ï¼Œå¦‚æžœè¾“å…¥é—´éš”æ—¶é—´å°äºŽæŠ€èƒ½æœ€å¤§çš„è¿žæ‹›ç­‰å¾…æ—¶é—´ï¼Œå¹¶ä¸”çŽ©å®¶æœ‰è¾“å…¥æ“ä½œçš„æƒ…å†µä¸‹ï¼Œå°±å¼€å§‹åˆ¤å®šè¿žæ‹›ã€‚ è¿žæ‹›æ­£ç¡®çš„æƒ…å†µä¸‹ï¼Œé‡ç½®è¾“å…¥é—´éš”æ—¶é—´ï¼Œæ”¹å˜è¿žæ‹›çŠ¶æ€ä¸º Runningï¼›è¿žæ‹›é”™è¯¯çš„æƒ…å†µä¸‹ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰å¯¹åº”æŒ‰é”®çš„èµ·æ‰‹å¼ï¼Œæœ‰å°±ç«‹åˆ»è½¬ä¸ºæ–°çš„è¿žæ‹›å¹¶æ”¹å˜çŠ¶æ€ä¸º Runningï¼Œå¦åˆ™å°±ç½®ä¸º Idleã€‚ è¶…æ—¶çš„æƒ…å†µä¸‹ï¼Œé‡ç½®è¾“å…¥é—´éš”æ—¶é—´ï¼Œå¹¶ç½® Idleã€‚ çŠ¶æ€æ‰§è¡Œæ ¹æ®å„ä¸ªçŠ¶æ€æ‰§è¡Œå¯¹åº”çš„åŠŸèƒ½å³å¯ã€‚è¯¥éƒ¨åˆ†åªè´Ÿè´£å®žçŽ°ï¼Œä¸å‚ä¸ŽæŽ§åˆ¶ã€‚ ä»£ç æŠ€èƒ½æ ‘12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970using System.Collections.Generic;using UnityEngine;public class SkillTree&#123; /// &lt;summary&gt; /// æŠ€èƒ½åç§° /// &lt;/summary&gt; public string name &#123; get; set; &#125; /// &lt;summary&gt; /// æŠ€èƒ½id ä¸€ç³»åˆ—æŠ€èƒ½ä½¿ç”¨åŒä¸€id /// &lt;/summary&gt; public int id &#123; get; set; &#125; /// &lt;summary&gt; /// é”®ä½éœ€æ±‚ /// &lt;/summary&gt; public KeyCode key &#123; get; set; &#125; /// &lt;summary&gt; /// ä¸‹ä¸€è¿žæ‹›åˆ—è¡¨ /// &lt;/summary&gt; public List&lt;SkillTree&gt; next &#123; get; set; &#125; /// &lt;summary&gt; /// æŠ€èƒ½æŒç»­æ—¶é—´ /// &lt;/summary&gt; public float skillTime &#123; get; set; &#125; /// &lt;summary&gt; /// æ˜¯å¦æ­£åœ¨é‡Šæ”¾æŠ€èƒ½ /// &lt;/summary&gt; public bool isRunSkill &#123; get; set; &#125; /// &lt;summary&gt; /// è¿žæ‹›è¶…æ—¶æ—¶é—´ /// &lt;/summary&gt; public float outOfTime &#123; get; set; &#125; /// &lt;summary&gt; /// æ˜¯å¦å¯ä»¥å¼ºåˆ¶æ‰“æ–­æŠ€èƒ½ /// &lt;/summary&gt; public bool isCanForceStop &#123; get; set; &#125; /// &lt;summary&gt; /// å¼ºåˆ¶æ‰“æ–­æ¬¡æ•° /// &lt;/summary&gt; public int forceTimes &#123; get; set; &#125; /// &lt;summary&gt; /// é»˜è®¤å¼ºåˆ¶æ‰“æ–­æ¬¡æ•° /// &lt;/summary&gt; public int defaultForceTimes &#123; get; set; &#125; /// &lt;summary&gt; /// å¼ºåˆ¶æ‰“æ–­é‡ç½®æ—¶é—´ /// &lt;/summary&gt; public float forceResetTime &#123; get; set; &#125; /// &lt;summary&gt; /// æŠ€èƒ½ç±»åž‹ /// &lt;/summary&gt; public SkillType skillType &#123; get; set; &#125; /// &lt;summary&gt; /// é•¿æŒ‰/è“„åŠ›æ—¶é—´ /// &lt;/summary&gt; public float holdingTime &#123; get; set; &#125; /// &lt;summary&gt; /// è¿›åº¦æ¡é¢œè‰² /// &lt;/summary&gt; public Color progressColor &#123; get; set; &#125; public SkillTree() &#123; skillType = SkillType.Click; progressColor = Color.white; next = new List&lt;SkillTree&gt;(); &#125;&#125; è¿žæ‹›æŽ§åˆ¶123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469using System;using System.Collections;using System.Collections.Generic;using UnityEditor.Experimental.GraphView;using UnityEngine;using UnityEngine.UI;public class ComboScript : MonoBehaviour&#123; /// &lt;summary&gt; /// è¿žæ‹›çŠ¶æ€ /// &lt;/summary&gt; private State _state; /// &lt;summary&gt; /// æŠ€èƒ½åˆ—è¡¨ /// &lt;/summary&gt; private List&lt;SkillTree&gt; _skills = new List&lt;SkillTree&gt;(); /// &lt;summary&gt; /// å½“å‰æŠ€èƒ½ /// &lt;/summary&gt; private SkillTree _curSkill; /// &lt;summary&gt; /// è¾“å…¥é—´éš” /// &lt;/summary&gt; private float _inputDelta = 0; /// &lt;summary&gt; /// è¾“å…¥é—´éš”è¿›åº¦æ¡æŽ§ä»¶ /// &lt;/summary&gt; private RectTransform _skillProgress = null; /// &lt;summary&gt; /// è¾“å…¥é—´éš”è¿›åº¦æ¡å›¾åƒ /// &lt;/summary&gt; private Image _skillImage; /// &lt;summary&gt; /// æŠ€èƒ½è¿›åº¦æ¡æŽ§ä»¶ /// &lt;/summary&gt; private RectTransform _runProgress = null; /// &lt;summary&gt; /// æŠ€èƒ½è¿›åº¦æ¡å›¾åƒ /// &lt;/summary&gt; private Image _runImage; /// &lt;summary&gt; /// æŠ€èƒ½æ‰§è¡Œæ—¶é—´ /// &lt;/summary&gt; private float _skillTime = 0; /// &lt;summary&gt; /// é•¿æŒ‰æ—¶é—´ /// &lt;/summary&gt; private float _holdingTime = 0; private Dictionary&lt;int, bool&gt; _forceReset = new Dictionary&lt;int, bool&gt;(); private Coroutine _skillCo; private Action _onIdle; private Action _onRunning; private Action _onHolding; private Action _onCharging; private Action _onWaiting; void Start() &#123; //èŽ·å–UI _skillProgress = GameObject.FindGameObjectWithTag(&quot;Player&quot;).GetComponent&lt;RectTransform&gt;(); _skillProgress.sizeDelta = new Vector2(0, 30); _skillImage = GameObject.FindGameObjectWithTag(&quot;Player&quot;).GetComponent&lt;Image&gt;(); _runProgress = GameObject.FindGameObjectWithTag(&quot;Finish&quot;).GetComponent&lt;RectTransform&gt;(); _runProgress.sizeDelta = new Vector2(0, 30); _runImage = GameObject.FindGameObjectWithTag(&quot;Finish&quot;).GetComponent&lt;Image&gt;(); DoChangeState(State.Idle); &#125; // Update is called once per frame void Update() &#123; ChangeState(); &#125; private void OnGUI() &#123; if (_curSkill != null) &#123; if (_inputDelta == 0) &#123; if (_skillProgress.sizeDelta.x != 0) &#123; _skillProgress.sizeDelta = new Vector2(0, 30); &#125; &#125; else &#123; float ratio = (_curSkill.outOfTime - _inputDelta) / _curSkill.outOfTime; if (ratio &lt; 0) &#123; ratio = 0; &#125; _skillProgress.sizeDelta = new Vector2(ratio * 100, 30); _skillImage.color = _curSkill.progressColor; &#125; if (_skillTime == 0) &#123; if (_runProgress.sizeDelta.x != 0) &#123; _runProgress.sizeDelta = new Vector2(0, 30); &#125; &#125; else &#123; float total = _curSkill.skillTime; if (_curSkill.skillType == SkillType.Charge &amp;&amp; _state == State.Charging) &#123; total = _curSkill.holdingTime; &#125; if (total - _skillTime &gt;= 0) &#123; float skillRatio = (total - _skillTime) / total; _runProgress.sizeDelta = new Vector2(skillRatio * 100, 30); _runImage.color = _curSkill.progressColor; &#125; else &#123; _runProgress.sizeDelta = new Vector2(0, 30); &#125; &#125; &#125; else &#123; if (_skillProgress.sizeDelta.x != 0) &#123; _skillProgress.sizeDelta = new Vector2(0, 30); &#125; if (_runProgress.sizeDelta.x != 0) &#123; _runProgress.sizeDelta = new Vector2(0, 30); &#125; &#125; &#125; /// &lt;summary&gt; /// æ”¹å˜çŠ¶æ€ /// &lt;/summary&gt; private void ChangeState() &#123; switch (_state) &#123; case State.Idle: _curSkill = null; //èµ·å§‹æŠ€èƒ½æ£€æµ‹ if (CheckSkillKey(true) == ComboState.Success) &#123; DoChangeState(CheckSkillType(_curSkill.skillType)); &#125; break; case State.Running: //ç­‰å¾…æŠ€èƒ½æ‰§è¡Œ if (!_curSkill.isRunSkill) &#123; Debug.Log(&quot;æ‰§è¡ŒæŠ€èƒ½ === &quot; + _curSkill.name + &quot;:&quot; + _curSkill.skillTime); _curSkill.isRunSkill = true; _skillCo = StartCoroutine(WaitForSkill()); &#125; _skillTime += Time.deltaTime; //æ£€æµ‹å¼ºåˆ¶æ‰“æ–­ if (CheckSkillKey(true) == ComboState.Success) &#123; //_inputDelta = 0; DoChangeState(State.Running); &#125; break; case State.Holding: _holdingTime += Time.deltaTime; _skillTime += Time.deltaTime; if (_holdingTime &gt; _curSkill.holdingTime || !Input.anyKey) &#123; Debug.Log(&quot;è¶…æ—¶æˆ–æ²¡æœ‰é•¿æŒ‰&quot;); DoChangeState(State.Waiting); &#125; else &#123; Debug.Log(&quot;æ‰§è¡Œé•¿æŒ‰æŠ€èƒ½ === &quot; + _curSkill.name); &#125; break; case State.Charging: _holdingTime += Time.deltaTime; _skillTime += Time.deltaTime; if (Input.anyKey) &#123; if (_holdingTime &gt; _curSkill.holdingTime) &#123; Debug.Log(&quot;è“„åŠ›å®Œæˆ&quot;); DoChangeState(State.Running); &#125; else &#123; Debug.Log(&quot;è“„åŠ› === &quot; + _curSkill.name); &#125; &#125; else &#123; Debug.Log(&quot;åœæ­¢è“„åŠ›&quot;); DoChangeState(State.Idle); &#125; break; case State.Waiting: //ç­‰å¾…ä¸­å¢žåŠ é—´éš”æ—¶é—´ _inputDelta += Time.deltaTime; //è¿žå‡»æ—¶é—´å°äºŽæŠ€èƒ½æœ€å¤§é—´éš”æ—¶é—´ if (_inputDelta &lt;= _curSkill.outOfTime) &#123; //è¿žå‡»æ—¶é—´å†…æ£€æµ‹ ComboState res = CheckSkillKey(false); if (res == ComboState.Success) &#123; //è¿žæ‹›æˆåŠŸ DoChangeState(CheckSkillType(_curSkill.skillType)); Debug.Log(&quot;è¿žæ‹›æˆåŠŸ&quot;); &#125; else if (res == ComboState.Wrong) &#123; //è¿žæ‹›é”™è¯¯ æ­¤å¤„é€‰æ‹©ç«‹å³æ‰§è¡Œå½“å‰è¿žæ‹›æŒ‡ä»¤ ä¹Ÿå¯ä»¥ä¸æ‰§è¡Œï¼Œæ”¾ä¸‹ä¸€å¸§å†åˆ¤æ–­ if (CheckSkillKey(true) == ComboState.Success) &#123; //å¦‚æžœæœ‰æ‹›ï¼Œç›´æŽ¥è½¬ä¸ºåˆ«çš„è¿žæ‹› DoChangeState(CheckSkillType(_curSkill.skillType)); Debug.Log(&quot;è½¬æ¢è¿žæ‹›&quot;); &#125; else &#123; //æ²¡æœ‰åˆ«çš„è¿žæ‹› çŠ¶æ€é‡ç½® DoChangeState(State.Idle); Debug.Log(&quot;æ²¡æœ‰æ–°è¿žæ‹›&quot;); &#125; &#125; &#125; else &#123; //è¶…æ—¶é‡ç½® DoChangeState(State.Idle); &#125; break; &#125; &#125; private State CheckSkillType(SkillType type) &#123; switch (type) &#123; case SkillType.Click: return State.Running; case SkillType.Hold: return State.Holding; case SkillType.Charge: return State.Charging; &#125; return State.Running; &#125; /// &lt;summary&gt; /// æ‰§è¡ŒçŠ¶æ€ /// &lt;/summary&gt; private void DoStatus() &#123; switch (_state) &#123; case State.Idle: //RunIdle if (_onIdle != null) &#123; _onIdle(); &#125; break; case State.Running: //RunSkill if (_onRunning != null) &#123; _onRunning(); &#125; break; case State.Holding: //HoldingSkill if (_onHolding != null) &#123; _onHolding(); &#125; break; case State.Charging: //HoldingSkill if (_onCharging != null) &#123; _onCharging(); &#125; break; case State.Waiting: //RunWaiting if (_onWaiting != null) &#123; _onWaiting(); &#125; break; &#125; &#125; private void DoChangeState(State state) &#123; _state = state; _inputDelta = 0; _skillTime = 0; _holdingTime = 0; DoStatus(); Debug.Log(&quot;é‡ç½®è®¡æ•°å™¨&quot;); &#125; /// &lt;summary&gt; /// æ£€æµ‹è¿žæ‹›æ˜¯å¦æˆåŠŸ /// &lt;/summary&gt; /// &lt;param name=&quot;isRoot&quot;&gt;&lt;/param&gt; /// &lt;returns&gt;&lt;/returns&gt; private ComboState CheckSkillKey(bool isRoot) &#123; if (Input.anyKeyDown) &#123; if (isRoot) &#123; if (_curSkill != null) &#123; //å­˜åœ¨æœ€è¿‘æŠ€èƒ½ï¼Œå¹¶ä¸”ä»ŽæŠ€èƒ½èµ·æ‰‹å¼å¼€å§‹æ£€æµ‹ è¯¥æƒ…å†µä¸ºæ‰“æ–­æ£€æµ‹ for (int i = 0, len = _skills.Count; i &lt; len; i++) &#123; SkillTree skill = _skills[i]; if (skill.isCanForceStop &amp;&amp; skill.forceTimes &gt; 0 &amp;&amp; Input.GetKeyDown(skill.key)) &#123; Debug.Log(&quot;æ‰“æ–­å¹¶å¼ºåˆ¶å¼€å§‹è¿žæ‹›&quot; + skill.key); StopCoroutine(_skillCo); if (skill.name != _curSkill.name) &#123; _curSkill.isRunSkill = false; //_curSkill.forceTimes = _curSkill.defaultForceTimes; &#125; _curSkill = skill; --_curSkill.forceTimes; bool reset; _forceReset.TryGetValue(_curSkill.id, out reset); if (!reset) &#123; StartCoroutine(WaitForForceTimesReset(_curSkill)); &#125; return ComboState.Success; &#125; &#125; &#125; else &#123; //æŸ¥æ‰¾è¿žæ‹›èµ·æ‰‹å¼ for (int i = 0, len = _skills.Count; i &lt; len; i++) &#123; SkillTree skill = _skills[i]; if (Input.GetKeyDown(skill.key)) &#123; Debug.Log(&quot;å¼€å§‹è¿žæ‹›&quot; + skill.key); _curSkill = skill; return ComboState.Success; &#125; &#125; &#125; &#125; else &#123; //æ£€æµ‹è¿žæ‹›åˆ†æ”¯ for (int i = 0, len = _curSkill.next.Count; i &lt; len; i++) &#123; SkillTree skill = _curSkill.next[i]; if (Input.GetKeyDown(skill.key)) &#123; //è¿žæ‹›æˆåŠŸ _curSkill = _curSkill.next[i]; return ComboState.Success; &#125; &#125; //è¿žé”™æ‹› é‡ç½® Debug.Log(&quot;è¿žæ‹›é‡ç½®&quot;); return ComboState.Wrong; &#125; &#125; return ComboState.Fail; &#125; /// &lt;summary&gt; /// æ¨¡æ‹ŸæŠ€èƒ½æ‰§è¡Œæ—¶é—´ /// &lt;/summary&gt; /// &lt;returns&gt;&lt;/returns&gt; private IEnumerator WaitForSkill() &#123; yield return new WaitForSeconds(_curSkill.skillTime); if (_curSkill != null) &#123; DoChangeState(State.Waiting); _curSkill.isRunSkill = false; &#125; &#125; private IEnumerator WaitForForceTimesReset(SkillTree obj) &#123; Debug.Log(&quot;å¼€å§‹é‡ç½®å¼ºåˆ¶æ‰“æ–­æ¬¡æ•° ï¼š&quot; + obj.forceResetTime); yield return new WaitForSeconds(obj.forceResetTime); obj.forceTimes = obj.defaultForceTimes; _forceReset[obj.id] = false; Debug.Log(&quot;é‡ç½®å¼ºåˆ¶æ‰“æ–­æ¬¡æ•°&quot;); &#125; /// &lt;summary&gt; /// æ·»åŠ æŠ€èƒ½ /// &lt;/summary&gt; /// &lt;param name=&quot;skill&quot;&gt;&lt;/param&gt; public void AddSkill(SkillTree skill) &#123; _skills.Add(skill); &#125; /// &lt;summary&gt; /// èŽ·å–å½“å‰æŠ€èƒ½ /// &lt;/summary&gt; /// &lt;returns&gt;&lt;/returns&gt; public SkillTree GetCurSkill() &#123; return _curSkill; &#125; public void OnIdle(Action callback) &#123; _onIdle = callback; &#125; public void OnRunning(Action callback) &#123; _onRunning = callback; &#125; public void OnHolding(Action callback) &#123; _onHolding = callback; &#125; public void OnCharging(Action callback) &#123; _onCharging = callback; &#125; public void OnWaiting(Action callback) &#123; _onWaiting = callback; &#125;&#125; è¿žæ‹›ç®¡ç†ç±»123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181using System;using System.Collections;using System.Collections.Generic;using UnityEngine;/// &lt;summary&gt;/// è¿žæ‹›çŠ¶æ€æžšä¸¾ ç©ºé—²|æ‰§è¡Œä¸­|ç­‰å¾…/// &lt;/summary&gt;public enum State&#123; Idle, Running, Holding, Charging, Waiting&#125;/// &lt;summary&gt;/// è¿žæ‹›æ£€æµ‹çŠ¶æ€æžšä¸¾ æˆåŠŸ|å¤±è´¥|é”™è¯¯/// &lt;/summary&gt;public enum ComboState&#123; Success, Fail, Wrong&#125;public enum SkillType &#123; Click, Hold, Charge&#125;public class ComboManager&#123; private static ComboManager _instance = null; private ComboScript _comboScript; public static ComboManager Instance() &#123; if(_instance == null) &#123; _instance = new ComboManager(); &#125; return _instance; &#125; private ComboManager() &#123; &#125; public void Init() &#123; GameObject root = new GameObject(); root.name = &quot;ComboSystem&quot;; _comboScript = root.AddComponent&lt;ComboScript&gt;(); //åˆå§‹åŒ–æŠ€èƒ½ æ­¤å¤„æš‚æ—¶ç”¨ä»£ç å†™æ­» //å®žä¾‹åŒ–æŠ€èƒ½é“¾ //æŠ€èƒ½A SkillTree skillA1 = new SkillTree(); skillA1.key = KeyCode.A; skillA1.name = &quot;è¿žæ‹›A1&quot;; skillA1.id = 1; skillA1.outOfTime = 0.5f; skillA1.skillTime = 0.5f; skillA1.progressColor = Color.red; SkillTree skillA2 = new SkillTree(); skillA2.key = KeyCode.A; skillA2.name = &quot;è¿žæ‹›A2&quot;; skillA2.id = 1; skillA2.outOfTime = 0.5f; skillA2.skillTime = 2f; skillA2.progressColor = new Color(0.8f, 0, 0, 1); skillA2.skillType = SkillType.Hold; skillA2.holdingTime = 2; SkillTree skillA3 = new SkillTree(); skillA3.key = KeyCode.A; skillA3.name = &quot;è¿žæ‹›A3-1&quot;; skillA3.id = 1; skillA3.outOfTime = 0.5f; skillA3.skillTime = 0.5f; skillA3.progressColor = new Color(0.6f, 0, 0, 1); SkillTree skillA4 = new SkillTree(); skillA4.key = KeyCode.S; skillA4.name = &quot;è¿žæ‹›A3-2&quot;; skillA4.id = 1; skillA4.outOfTime = 0.5f; skillA4.skillTime = 0.5f; skillA4.progressColor = new Color(0.4f, 0, 0, 1); skillA4.skillType = SkillType.Charge; skillA4.holdingTime = 2; skillA1.next.Add(skillA2); skillA2.next.Add(skillA3); skillA2.next.Add(skillA4); _comboScript.AddSkill(skillA1); //æŠ€èƒ½B SkillTree skillB1 = new SkillTree(); skillB1.key = KeyCode.B; skillB1.name = &quot;è¿žæ‹›B1&quot;; skillB1.id = 2; skillB1.outOfTime = 0.5f; skillB1.skillTime = 0.5f; skillB1.isCanForceStop = true; skillB1.forceTimes = 1; skillB1.defaultForceTimes = 1; skillB1.forceResetTime = 5; skillB1.progressColor = Color.green; SkillTree skillB2 = new SkillTree(); skillB2.key = KeyCode.B; skillB2.name = &quot;è¿žæ‹›B2&quot;; skillB2.id = 2; skillB2.outOfTime = 0.5f; skillB2.skillTime = 10f; skillB2.progressColor = new Color(0, 0.8f, 0, 1); skillB1.next.Add(skillB2); _comboScript.AddSkill(skillB1); Debug.Log(&quot;åˆå§‹åŒ–å®Œæˆ&quot;); &#125; /// &lt;summary&gt; /// èŽ·å¾—å½“å‰æŠ€èƒ½ /// &lt;/summary&gt; /// &lt;returns&gt;&lt;/returns&gt; public SkillTree GetCurSkill() &#123; return _comboScript.GetCurSkill(); &#125; /// &lt;summary&gt; /// Idleå‡½æ•° /// &lt;/summary&gt; /// &lt;param name=&quot;callback&quot;&gt;&lt;/param&gt; public void OnIdle(Action callback) &#123; _comboScript.OnIdle(callback); &#125; /// &lt;summary&gt; /// Runningå‡½æ•° /// &lt;/summary&gt; /// &lt;param name=&quot;callback&quot;&gt;&lt;/param&gt; public void OnRunning(Action callback) &#123; _comboScript.OnRunning(callback); &#125; /// &lt;summary&gt; /// Holdingå‡½æ•° /// &lt;/summary&gt; /// &lt;param name=&quot;callback&quot;&gt;&lt;/param&gt; public void OnHolding(Action callback) &#123; _comboScript.OnHolding(callback); &#125; /// &lt;summary&gt; /// Chargingå‡½æ•° /// &lt;/summary&gt; /// &lt;param name=&quot;callback&quot;&gt;&lt;/param&gt; public void OnCharging(Action callback) &#123; _comboScript.OnCharging(callback); &#125; /// &lt;summary&gt; /// Waitingå‡½æ•° /// &lt;/summary&gt; /// &lt;param name=&quot;callback&quot;&gt;&lt;/param&gt; public void OnWaiting(Action callback) &#123; _comboScript.OnWaiting(callback); &#125;&#125;","categories":[{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/categories/Unity/"},{"name":"å·¥å…·","slug":"Unity/å·¥å…·","permalink":"https://busyogg.github.io/categories/Unity/%E5%B7%A5%E5%85%B7/"}],"tags":[{"name":"C#","slug":"C","permalink":"https://busyogg.github.io/tags/C/"},{"name":"å·¥å…·ç±»","slug":"å·¥å…·ç±»","permalink":"https://busyogg.github.io/tags/%E5%B7%A5%E5%85%B7%E7%B1%BB/"},{"name":"ç³»ç»Ÿæž¶æž„","slug":"ç³»ç»Ÿæž¶æž„","permalink":"https://busyogg.github.io/tags/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/"},{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/tags/Unity/"}]},{"title":"IKç®—æ³•ä¹‹Fabrik","slug":"IKç®—æ³•ä¹‹Fabrik","date":"2023-10-30T14:29:55.000Z","updated":"2024-05-18T15:37:57.409Z","comments":true,"path":"article/5795c3870390/","link":"","permalink":"https://busyogg.github.io/article/5795c3870390/","excerpt":"","text":"ç®€ä»‹IKï¼ˆåå‘è¿åŠ¨ï¼ŒInverse Kinematicsï¼‰æ˜¯è®¡ç®—è¿åŠ¨å…³èŠ‚æœ«ç«¯(å¦‚æœºæ¢°è‡‚è‡‚çˆªæˆ–äººç‰©éª¨æž¶æ‰‹è‡‚æœ«ç«¯çš„æ‰‹æŽŒ)ç›¸å¯¹äºŽå…³èŠ‚çš„èµ·å§‹ä½ç½®å’Œæ–¹å‘åˆ°è¾¾æ‰€éœ€ä½ç½®çš„å…³èŠ‚å‚æ•°çš„æ•°å­¦è¿‡ç¨‹ã€‚ â€“ç™¾åº¦ç™¾ç§‘ Fabrik ç®—æ³•é€šè¿‡è®¡ç®—éª¨éª¼èŠ‚ç‚¹çš„ç©ºé—´åæ ‡å…³ç³»æ¥å®žçŽ° IK çš„æ•ˆæžœã€‚ åŽŸç†æ¦‚æ‹¬Fabrik ç®—æ³•ä¸€æ¬¡è¿­ä»£æ‰§è¡Œä¸¤ä¸ªæ–¹å‘çš„éåŽ†ï¼Œé¦–å…ˆä»ŽåŽå¾€å‰è®¡ç®—åˆ°è¾¾ç›®æ ‡ç‚¹æƒ…å†µä¸‹æ‰€æœ‰éª¨éª¼çš„ç©ºé—´ä½ç½®å˜åŒ–ï¼ˆä¸åŒ…æ‹¬æ ¹èŠ‚ç‚¹ï¼‰ï¼Œç„¶åŽä»Žå‰å¾€åŽè®¡ç®—ä»Žæ ¹èŠ‚ç‚¹å‡ºå‘åˆ°è¾¾ç›®æ ‡èŠ‚ç‚¹çš„éª¨éª¼èŠ‚ç‚¹ä½ç½®ã€‚ ä»ŽåŽå¾€å‰ é¦–å…ˆæˆ‘ä»¬æŠŠæœ€åŽä¸€ä¸ªéª¨éª¼èŠ‚ç‚¹ç½®äºŽç›®æ ‡ä½ç½®ï¼Œç„¶åŽä»ŽåŽå‘å‰éåŽ†éª¨éª¼èŠ‚ç‚¹ï¼Œå‰ä¸€ä¸ªèŠ‚ç‚¹çš„ä½ç½®ç”±åŽä¸€ä¸ªèŠ‚ç‚¹æŒ‡å‘å‰ä¸€ä¸ªèŠ‚ç‚¹çš„æ–¹å‘å‘é‡çš„å•ä½å‘é‡ä¹˜ä»¥éª¨éª¼é•¿åº¦åŠ ä¸ŠåŽä¸€ä¸ªèŠ‚ç‚¹å½“å‰çš„ä½ç½®å¾—åˆ°ï¼Œå³ $\\vec{dir}*length+P_{back}$ $\\vec{dir}&#x3D;normalized(P_{forward}-P_{back})$ ç»è¿‡ä¸€è½®éåŽ†ä¹‹åŽæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°é™¤äº†æ ¹èŠ‚ç‚¹å¤–çš„æ‰€æœ‰èŠ‚ç‚¹åˆ°è¾¾ç›®æ ‡ç‚¹çš„ä½ç½®ã€‚ ä»Žå‰å¾€åŽ ç„¶åŽæˆ‘ä»¬ä»Žæ ¹èŠ‚ç‚¹å¼€å§‹ä»Žå‰å‘åŽéåŽ†éª¨éª¼èŠ‚ç‚¹ï¼ŒåŽä¸€ä¸ªèŠ‚ç‚¹çš„ä½ç½®ç”±å‰ä¸€ä¸ªèŠ‚ç‚¹æŒ‡å‘åŽä¸€ä¸ªèŠ‚ç‚¹çš„æ–¹å‘å‘é‡çš„å•ä½å‘é‡ä¹˜ä»¥éª¨éª¼é•¿åº¦åŠ ä¸Šå‰ä¸€ä¸ªèŠ‚ç‚¹å½“å‰çš„ä½ç½®å¾—åˆ°ï¼Œå³ $\\vec{dir}*length+P_{forward}$ $\\vec{dir}&#x3D;normalized(P_{back}-P_{forward})$ å’Œä»ŽåŽå¾€å‰çš„ç®—æ³•ç›¸åã€‚ ç»è¿‡ä¸€è½®è¿­ä»£åŽï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°ä¸€ä¸ªç›¸å¯¹æ­£ç¡®çš„ä½ç½®äº†ã€‚ çº¦æŸå› ä¸º Fabrik æ˜¯åŸºäºŽéª¨éª¼èŠ‚ç‚¹ä½ç½®çš„ï¼Œå› æ­¤ä¼šå‡ºçŽ°å…³èŠ‚å¾€å¥‡æ€ªæ–¹å‘å¼¯æ›²çš„é—®é¢˜ã€‚æ‰€ä»¥ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜å°±è¦å¯¹å…³èŠ‚è¿›è¡Œçº¦æŸã€‚ æˆ‘ä½¿ç”¨å‘é‡å‰ä¹˜æ¥åˆ¤æ–­å½“å‰å…³èŠ‚å‰åŽä¸¤ä¸ªéª¨éª¼çš„æ–¹å‘æ˜¯å¦ç¬¦åˆçº¦å®šçš„å·¦å³å…³ç³»ï¼Œä¸ç¬¦åˆçš„è¯å°±æ—‹è½¬æ–¹å‘å‘é‡åˆ°æˆ‘ä»¬éœ€è¦çš„æ–¹å‘ã€‚ å› ä¸ºæˆ‘åˆæ¬¡æŽ¥è§¦ IK ç®—æ³•ï¼Œå› æ­¤çº¦æŸç›¸å…³çš„å†…å®¹è¿˜æ²¡æœ‰å¥½çš„æ–¹æ¡ˆï¼Œè¿™éƒ¨åˆ†å†…å®¹å°±è¯·è‡ªè¡Œè°ƒæ•´ã€‚ ä»£ç IKData12345678910using System.Collections;using System.Collections.Generic;using UnityEngine;public class IKData&#123; public Vector3 Pos &#123; get; set; &#125; public float Length &#123; get; set; &#125; public Transform Node &#123; get; set; &#125;&#125; IKRootScript123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152using System;using System.Collections.Generic;using UnityEngine;public class IKRootScript : MonoBehaviour&#123; public List&lt;IKData&gt; _ikList = new List&lt;IKData&gt;(); public Transform _leaf; public Vector3 _lastPos; public List&lt;GameObject&gt; _boneLine = new List&lt;GameObject&gt;(); void Start() &#123; InitBone(transform); InitLength(); _leaf = GameObject.Find(&quot;CtrlPoint&quot;).transform; _lastPos = _leaf.position; Debug.Log(&quot;éª¨éª¼æ•°é‡&quot; + _ikList.Count); CreateBoneLine(); &#125; void LateUpdate() &#123; //æŽ§åˆ¶ç‚¹å‘ç”Ÿå˜åŒ–çš„æ—¶å€™è®¡ç®—IK if (_lastPos != _leaf.position) &#123; //IKè¿­ä»£ for (int i = 0; i &lt; 3; i++) &#123; IKBack(_leaf.position); IKForward(); &#125; _lastPos = _leaf.position; UpdateBone(); &#125; &#125; /// &lt;summary&gt; /// åˆå§‹åŒ–éª¨éª¼èŠ‚ç‚¹ /// &lt;/summary&gt; /// &lt;param name=&quot;trans&quot;&gt;&lt;/param&gt; private void InitBone(Transform trans) &#123; IKData bone = new IKData(); bone.Pos = trans.position; bone.Node = trans; _ikList.Add(bone); if (trans.childCount &gt; 0) &#123; Transform child = trans.GetChild(0); InitBone(child); &#125; &#125; /// &lt;summary&gt; /// åˆå§‹åŒ–éª¨éª¼é•¿åº¦ /// &lt;/summary&gt; private void InitLength() &#123; for (int i = 0, len = _ikList.Count - 1; i &lt; len; i++) &#123; IKData first = _ikList[i]; IKData second = _ikList[i + 1]; first.Length = Math.Abs((second.Pos - first.Pos).magnitude); &#125; &#125; /// &lt;summary&gt; /// åˆ›å»ºéª¨æž¶ /// &lt;/summary&gt; private void CreateBoneLine() &#123; for (int i = 0, len = _ikList.Count - 1; i &lt; len; i++) &#123; IKData parent = _ikList[i]; IKData child = _ikList[i + 1]; Vector3 center = (parent.Pos + child.Pos) * 0.5f; GameObject cube = GameObject.CreatePrimitive(PrimitiveType.Cube); cube.transform.position = center; cube.transform.localScale = new Vector3(0.2f, 0.2f, parent.Length); cube.transform.LookAt(child.Pos); _boneLine.Add(cube); &#125; &#125; /// &lt;summary&gt; /// æ›´æ–°éª¨éª¼ä½ç½® /// &lt;/summary&gt; private void UpdateBone() &#123; for (int i = 0, len = _ikList.Count; i &lt; len; i++) &#123; //æ›´æ–°å…³èŠ‚ä½ç½® IKData parent = _ikList[i]; parent.Node.position = parent.Pos; //æ›´æ–°éª¨æž¶ä½ç½® if (i &lt; len - 1) &#123; IKData child = _ikList[i + 1]; GameObject cube = _boneLine[i]; Vector3 center = (parent.Pos + child.Pos) * 0.5f; cube.transform.position = center; cube.transform.LookAt(child.Pos); &#125; &#125; &#125; /// &lt;summary&gt; /// åå‘è¿­ä»£ /// &lt;/summary&gt; /// &lt;param name=&quot;target&quot;&gt;&lt;/param&gt; private void IKBack(Vector3 target) &#123; //æœ«èŠ‚ç‚¹ä½ç½®ç½®ä¸ºtarget _ikList[_ikList.Count - 1].Pos = target; //éåŽ†è¿­ä»£ for (int i = _ikList.Count - 1; i &gt; 1; i--) &#123; IKData parent = _ikList[i - 1]; IKData child = _ikList[i]; Vector3 nextBone = (parent.Pos - child.Pos).normalized; Vector3 lastBone = (parent.Pos - _ikList[i - 2].Pos).normalized; Vector3 side = Vector3.Cross(nextBone, lastBone); Debug.Log(i + &quot;:&quot; + side); Vector3 normal = (parent.Pos - child.Pos).normalized; if (side.x &lt;= 0 || side.y &lt;= 0 || side.z &lt;= 0) &#123; //æŒ‰ç…§æƒé‡å’Œæ—‹è½¬æ–¹å‘è°ƒæ•´æ–¹å‘å‘é‡ normal = Quaternion.Euler(new Vector3(2f, 0, 0)) * normal; &#125; parent.Pos = child.Pos + normal * parent.Length; Debug.Log(i + &quot;:&quot; + normal); &#125; &#125; /// &lt;summary&gt; /// æ­£å‘è¿­ä»£ /// &lt;/summary&gt; private void IKForward() &#123; //éåŽ†è¿­ä»£ for (int i = 0, len = _ikList.Count - 1; i &lt; len; i++) &#123; IKData parent = _ikList[i]; IKData child = _ikList[i + 1]; Vector3 normal = (child.Pos - parent.Pos).normalized; child.Pos = parent.Pos + normal * parent.Length; &#125; &#125;&#125;","categories":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://busyogg.github.io/categories/%E7%AE%97%E6%B3%95/"},{"name":"é€†å‘è¿åŠ¨å­¦","slug":"ç®—æ³•/é€†å‘è¿åŠ¨å­¦","permalink":"https://busyogg.github.io/categories/%E7%AE%97%E6%B3%95/%E9%80%86%E5%90%91%E8%BF%90%E5%8A%A8%E5%AD%A6/"}],"tags":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://busyogg.github.io/tags/%E7%AE%97%E6%B3%95/"},{"name":"IK","slug":"IK","permalink":"https://busyogg.github.io/tags/IK/"},{"name":"Fabrik","slug":"Fabrik","permalink":"https://busyogg.github.io/tags/Fabrik/"},{"name":"C#","slug":"C","permalink":"https://busyogg.github.io/tags/C/"}]},{"title":"ç¢°æ’žæ£€æµ‹ä¹‹å°„çº¿ä¸Ž AABB å’Œ OBB","slug":"ç¢°æ’žæ£€æµ‹ä¹‹å°„çº¿ä¸ŽAABBå’ŒOBB","date":"2023-10-15T12:29:10.000Z","updated":"2024-05-30T12:26:19.524Z","comments":true,"path":"article/e2b04b62f691/","link":"","permalink":"https://busyogg.github.io/article/e2b04b62f691/","excerpt":"","text":"ç®€ä»‹å°„çº¿æ£€æµ‹å¯ä»¥ç”¨äºŽæ‹¾å–ç‰©ä½“ã€åˆ¤æ–­å‰æ–¹æ˜¯å¦æœ‰éšœç¢ç‰©ã€åˆ¤æ–­æ˜¯å¦ç¢°æ’žç­‰åœºæ™¯ï¼Œæœ¬æ–‡ä»‹ç»å°„çº¿ä¸Ž AABB ä»¥åŠå°„çº¿ä¸Ž OBB çš„æ£€æµ‹åŽŸç†ã€‚å°„çº¿ä¸Ž AABB æ£€æµ‹çš„åŽŸç†æ˜¯ç”±å°„çº¿ä¸Ž OBB æ£€æµ‹ç®€åŒ–è€Œæ¥ï¼Œå› æ­¤æ”¾åœ¨ä¸€èµ·ä»‹ç»ã€‚ åŽŸç†å½“æˆ‘ä»¬åˆ¤æ–­ä¸€æ¡å°„çº¿æ˜¯å¦ä¸Žä¸€ä¸ªçŸ©å½¢ç›¸äº¤çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥åˆ¤æ–­å°„çº¿å’ŒçŸ©å½¢å››æ¡è¾¹çš„å»¶é•¿çº¿çš„äº¤ç‚¹ä¹‹é—´çš„å…³ç³»ã€‚ï¼ˆslab ç¢°æ’žæ£€æµ‹ï¼‰ å¦‚å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬æœ‰ä¸€æ¡ç»¿è‰²å°„çº¿ä¸Žé»‘è‰²çŸ©å½¢ç›¸äº¤ï¼Œå¾—åˆ°å››ä¸ªç‚¹ P1ã€P2ã€P3ã€P4ã€‚å…¶ä¸­åœ¨ y è½´æ–¹å‘çš„äº¤ç‚¹ä¸º P1ã€P2ï¼Œåœ¨ x è½´æ–¹å‘çš„äº¤ç‚¹ä¸º P3ã€P4ï¼›æˆ‘ä»¬æœ‰ä¸€æ¡ç´«è‰²å°„çº¿ä¸Žé»‘è‰²çŸ©å½¢ç›¸äº¤ï¼Œå¾—åˆ°å››ä¸ªç‚¹ P1â€™ã€P2â€™ã€P3â€™ã€P4â€™ã€‚å…¶ä¸­åœ¨ x è½´æ–¹å‘çš„äº¤ç‚¹ä¸º P1â€™ã€P2â€™ï¼Œåœ¨ y è½´æ–¹å‘çš„äº¤ç‚¹ä¸º P3â€™ã€P4â€™ã€‚ è§‚å¯Ÿå›¾åƒæˆ‘ä»¬å¯ä»¥å‘çŽ°ï¼Œå½“å°„çº¿ä¸Žåœ†ç›¸äº¤çš„æ—¶å€™ï¼ŒP1P2 ä¸Ž P3P4 åœ¨å°„çº¿ä¸Šå­˜åœ¨ç›¸äº¤çš„éƒ¨åˆ†ï¼Œå½“å°„çº¿ä¸Žåœ†ä¸ç›¸äº¤çš„æ—¶å€™ï¼ŒP1â€™P2â€™ä¸Ž P3â€™P4â€™åœ¨å°„çº¿ä¸Šä¸å­˜åœ¨ç›¸äº¤çš„éƒ¨åˆ†ã€‚ å› æ­¤æˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸ªç»“è®ºï¼šå½“çŸ©å½¢ä¸¤ä¸ªæ–¹å‘è½´ä¸Šçš„å››æ¡è¾¹çš„å»¶é•¿çº¿ä¸Žå°„çº¿ç›¸äº¤çš„æ—¶å€™ï¼Œæ‰€æœ‰è½´å‘ä¸Šçš„æœ€å°äº¤ç‚¹æ¯”æœ€å¤§äº¤ç‚¹è¦å°ï¼Œå¹¶ä¸”æ‰€æœ‰æœ€å°äº¤ç‚¹çš„æœ€å¤§å€¼æ¯”æ‰€æœ‰æœ€å¤§äº¤ç‚¹çš„æœ€å°å€¼éƒ½è¦å°ï¼Œè¿™æ—¶å€™å°„çº¿ä¸ŽçŸ©å½¢ç›¸äº¤ã€‚ å³ï¼šæ¯ä¸ªè½´ä¸¤æ¡è¾¹çš„ä¸¤ä¸ªäº¤ç‚¹ä¸­çš„è¿‘ç‚¹ P1ã€P3 ä¸­çš„æœ€å¤§å€¼ï¼Œè¦æ¯”è¿œç‚¹ P2ã€P4 ä¸­çš„æœ€å°å€¼è¿˜å°ï¼Œè¿™æ ·å°„çº¿å°±ä¸ŽçŸ©å½¢ç›¸äº¤ã€‚ æ‰€ä»¥å¯¹äºŽå°„çº¿ä¸ŽçŸ©å½¢ï¼Œæˆ‘ä»¬æœ‰$max(P1,P3)&lt;min(P2,P4)$ï¼ŒåŒ–ä¸ºé€šå¼çš„è¯å°±æ˜¯$max(Pmin_x,Pmin_y)&lt;min(Pmax_x,Pmax_y)$ æ‹“å±•åˆ°ä¸‰ç»´ç©ºé—´ä¹Ÿæ˜¯ä¸€æ ·ï¼ŒäºŒç»´ç©ºé—´æ˜¯æ¯”è¾ƒä¸¤ä¸ªè½´ï¼Œä¸‰ç»´ç©ºé—´å°±æ˜¯æ¯”è¾ƒä¸‰ä¸ªè½´ï¼Œä¹Ÿè¦æ»¡è¶³$max(Pmin_x,Pmin_y,Pmin_z)&lt;min(Pmax_x,Pmax_y,Pmax_z)$çš„å…³ç³»ã€‚ åœ¨ OBB ä¸­æˆ‘ä»¬è®¾å°„çº¿ R çš„èµ·ç‚¹ä¸º C1ï¼Œé•¿åº¦ä¸º tï¼Œæ–¹å‘ä¸º Dirï¼›å¹³é¢ S çš„æ³•çº¿ä¸º nï¼Œå¹³é¢ä¸­ä¸€ç‚¹ä¸º Dï¼Œå¹³é¢åˆ° R èµ·ç‚¹çš„è·ç¦»ä¸º dï¼Œå¹³é¢ä¸Žå°„çº¿çš„äº¤ç‚¹ä¸º Pï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ° å°„çº¿çš„æ–¹ç¨‹ä¸ºï¼š $P&#x3D;C1+t*Dir$ å¹³é¢çš„æ–¹ç¨‹ä¸ºï¼š $Dot(P,n)&#x3D;d$ å½“å°„çº¿ä¸Žå¹³é¢ç›¸äº¤çš„æ—¶å€™ï¼Œä¸¤ä¸ªæ–¹ç¨‹çš„å€¼ç›¸ç­‰ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦‚ä¸‹å…³ç³»ï¼š $Dot(C1+t*Dir,n)&#x3D;d$ ç”±äºŽç‚¹ä¹˜ç¬¦åˆåˆ†é…å¾‹ï¼Œæ‰€ä»¥æ–¹ç¨‹åŒ–ä¸ºï¼š $Dot(C1,n)+Dot(t*Dir,n)&#x3D;d$ æˆ‘ä»¬æƒ³è¦æ±‚å‡ºå°„çº¿çš„é•¿åº¦ tï¼Œå› æ­¤æ–¹ç¨‹æ”¹é€ ä¸€ä¸‹å˜æˆï¼š $Dot(t*Dir,n)&#x3D;d-Dot(C1,n)$ ç”±äºŽç‚¹ä¹˜ç¬¦åˆç»“åˆå¾‹ï¼Œæ‰€ä»¥æ–¹ç¨‹åŒ–ä¸ºï¼š $t*Dot(Dir,n)&#x3D;d-Dot(C1,n)$ åŒ–ç®€å¾—åˆ°ï¼š $t&#x3D;(d-Dot(C1,n))&#x2F;Dot(Dir,n)$ å› ä¸ºæˆ‘ä»¬ä¸çŸ¥é“ dï¼Œæ‰€ä»¥æ ¹æ®å¹³é¢æ–¹ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ï¼š $t&#x3D;(Dot(P,n)-Dot(C1,n))&#x2F;Dot(Dir,n)$ ç”±åˆ†é…å¾‹ï¼Œæˆ‘ä»¬æœ€ç»ˆå¾—åˆ°ï¼š $t&#x3D;(Dot(P-C1,n))&#x2F;Dot(Dir,n)$ åœ¨ OBB åŒ…å›´ç›’ä¸­ï¼Œæœ€å¤§ç‚¹å’Œæœ€å°ç‚¹åˆ†åˆ«æ¨ªè·¨ä¸‰ä¸ªæœ€å¤§é¢å’Œæœ€å°é¢ï¼Œå› æ­¤æ»¡è¶³æ–¹ç¨‹ï¼š $Dot(P_{min},n)&#x3D;d$ $Dot(P_{max},n)&#x3D;d$ æ‰€ä»¥ï¼Œä¸‰ä¸ªæœ€å°é¢çš„æœ€å°è·ç¦»ä¸ºï¼š $t&#x3D;(Dot(P_{min}-C1,n))&#x2F;Dot(Dir,n)$ ä¸‰ä¸ªæœ€å¤§é¢çš„æœ€å¤§è·ç¦»ä¸ºï¼š $t&#x3D;(Dot(P_{max}-C1,n))&#x2F;Dot(Dir,n)$ æœ€åŽï¼Œæˆ‘ä»¬åªéœ€è¦åˆ¤æ–­$max(t_{min_x},t_{min_y},t_{min_z})&lt;min(t_{max_x},t_{max_y},t_{max_z})$å°±èƒ½çŸ¥é“æ˜¯å¦ç›¸äº¤ã€‚ äº¤ç‚¹åªè¦å¸¦å…¥å°„çº¿æ–¹ç¨‹å³å¯å¾—åˆ°ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬éƒ½æ˜¯ä»¥å°„çº¿å’ŒåŒ…å›´ç›’æ–¹å‘è½´åŒå‘ä¸ºæ­£æ–¹å‘ï¼Œå› æ­¤å½“æ–¹å‘ç›¸åçš„æ—¶å€™ï¼ˆ$Dot(Dir,n)&lt;0$ï¼‰ï¼Œæˆ‘ä»¬è¦äº¤æ¢$t_{min}$å’Œ$t_{max}$çš„å€¼ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091//åŒ…å›´ç›’æ•°æ®ç»“æž„public class CollisionData : MonoBehaviour&#123; public Vector3 center = Vector3.zero; public float radius = 1.0f; public Vector3 direction = Vector3.zero; public Vector3[] vertexts = new Vector3[8]; public Vector3[] axes = new Vector3[3];&#125;---------------------------------------------/// &lt;summary&gt;/// å°„çº¿å’ŒOBBæ£€æµ‹/// &lt;param name=&quot;data1&quot;&gt;&lt;/param&gt;/// &lt;param name=&quot;data2&quot;&gt;&lt;/param&gt;/// &lt;/summary&gt;private bool CollisionRay2OBB(CollisionData data1,CollisionData data2)&#123; //åˆ¤æ–­ä¸åœ¨OBBå†… Vector3 centerDis = data1.center - data2.center; float ray2ObbX = Vector3.Dot(centerDis, data2.axes[0]); float ray2ObbY = Vector3.Dot(centerDis, data2.axes[1]); float ray2ObbZ = Vector3.Dot(centerDis, data2.axes[2]); bool checkNotInside = ray2ObbX &lt; -data2.extents[0] || ray2ObbX &gt; data2.extents[0] || ray2ObbY &lt; -data2.extents[1] || ray2ObbY &gt; data2.extents[1] || ray2ObbZ &lt; -data2.extents[2] || ray2ObbZ &gt; data2.extents[2]; //åˆ¤æ–­åå‘æƒ…å†µ bool checkFoward = Vector3.Dot(data2.center - data1.center, data1.direction) &lt; 0; if (checkNotInside &amp;&amp; checkFoward) &#123; return false; &#125; //åˆ¤æ–­æ˜¯å¦ç›¸äº¤ Vector3 min = Vector3.zero; Vector3 minP = data2.vertexts[4] - data1.center; min.x = Vector3.Dot(minP, data2.axes[0]); min.y = Vector3.Dot(minP, data2.axes[1]); min.z = Vector3.Dot(minP, data2.axes[2]); Vector3 max = Vector3.zero; Vector3 maxP = data2.vertexts[2] - data1.center; max.x = Vector3.Dot(maxP, data2.axes[0]); max.y = Vector3.Dot(maxP, data2.axes[1]); max.z = Vector3.Dot(maxP, data2.axes[2]); Vector3 projection = Vector3.zero; projection.x = 1 / Vector3.Dot(data1.direction, data2.axes[0]); projection.y = 1 / Vector3.Dot(data1.direction, data2.axes[1]); projection.z = 1 / Vector3.Dot(data1.direction, data2.axes[2]); Vector3 pMin = Vector3.Scale(min, projection); Vector3 pMax = Vector3.Scale(max, projection); if (projection.x &lt; 0) Swap(ref pMin.x, ref pMax.x); if (projection.y &lt; 0) Swap(ref pMin.y, ref pMax.y); if (projection.z &lt; 0) Swap(ref pMin.z, ref pMax.z); float n = Mathf.Max(pMin.x, pMin.y, pMin.z); float f = Mathf.Min(pMax.x, pMax.y, pMax.z); Debug.Log(n + &quot; &quot; + f); Debug.Log(pMin + &quot; &quot; + pMax); Debug.Log(projection); bool res = false; if (!checkNotInside) &#123; res = true; Vector3 point = data1.center + data1.direction * f; ConsoleUtils.Log(&quot;ç¢°æ’žç‚¹&quot;, point); &#125; else &#123; if (n &lt; f &amp;&amp; data1.radius &gt;= n) &#123; res = true; &#125; else &#123; return false; &#125; Vector3 point = data1.center + data1.direction * n; ConsoleUtils.Log(&quot;ç¢°æ’žç‚¹&quot;, point); &#125; return res;&#125; åœ¨ AABB ä¸­ç”±äºŽ AABB åŒ…å›´ç›’çš„æ–¹å‘è½´ä¸Žåæ ‡è½´ä¸€è‡´ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç®€åŒ–æ–¹ç¨‹ã€‚ åœ¨ X è½´ä¸Šï¼Œæˆ‘ä»¬æœ‰$t_{yz}&#x3D;(Dot(P-C1,n_{yz}))&#x2F;Dot(Dir,n_{yz})$ åˆå› ä¸º$n_{yz}&#x3D;(1,0,0)$ï¼Œåªæœ‰ x ä¸Šæœ‰å€¼ æ‰€ä»¥$t_{yz}&#x3D;(P.x-C1.x)&#x2F;Dir.x$ åŒç†å¯å¾—å…¶ä»–é¢ä¹Ÿæ˜¯è¿™æ ·ï¼Œå› æ­¤æœ€åŽæˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦‚ä¸‹æ–¹ç¨‹ï¼š $t&#x3D;(P-C1)&#x2F;Dir$ å…¶ä»–éƒ¨åˆ†å°±å’Œå°„çº¿ä¸Ž OBB çš„ç®—æ³•ä¸€è‡´ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273//åŒ…å›´ç›’æ•°æ®ç»“æž„public class CollisionData : MonoBehaviour&#123; public Vector3 center = Vector3.zero; public float radius = 1.0f; public Vector3 direction = Vector3.zero; public Vector3 max = Vector3.zero; public Vector3 min = Vector3.zero;&#125;---------------------------------------------/// &lt;summary&gt;/// å°„çº¿å’ŒAABBæ£€æµ‹/// &lt;param name=&quot;data1&quot;&gt;&lt;/param&gt;/// &lt;param name=&quot;data2&quot;&gt;&lt;/param&gt;/// &lt;/summary&gt;private void CollisionRay2AABB(CollisionData data1,CollisionData data2)&#123; //åˆ¤æ–­æ˜¯å¦ä¸åœ¨AABBå†… bool checkNotInside = data1.center.x &gt; data2.max.x || data1.center.x &lt; data2.min.x || data1.center.y &gt; data2.max.y || data1.center.y &lt; data2.min.y || data1.center.z &gt; data2.max.z || data1.center.z &lt; data2.min.z; //åˆ¤æ–­åå‘æƒ…å†µ bool checkForawd = Vector3.Dot(data2.center - data1.center, data1.direction) &lt; 0; if (checkNotInside &amp;&amp; checkForawd) &#123; line1.Collided(false); line2.Collided(false); return; &#125; //åˆ¤æ–­æ˜¯å¦ç›¸äº¤ Vector3 min = data2.min - data1.center; Vector3 max = data2.max - data1.center; Vector3 projection = new Vector3(1 / data1.direction.x, 1 / data1.direction.y, 1 / data1.direction.z); Vector3 pMin = Vector3.Scale(min, projection); Vector3 pMax = Vector3.Scale(max, projection); if (data1.direction.x &lt; 0) Swap(ref pMin.x, ref pMax.x); if (data1.direction.y &lt; 0) Swap(ref pMin.y, ref pMax.y); if (data1.direction.z &lt; 0) Swap(ref pMin.z, ref pMax.z); float n = Mathf.Max(pMin.x, pMin.y, pMin.z); float f = Mathf.Min(pMax.x, pMax.y, pMax.z); if (!checkNotInside) &#123; line1.Collided(true); line2.Collided(true); Vector3 point = data1.center + data1.direction * f; ConsoleUtils.Log(&quot;ç¢°æ’žç‚¹&quot;, point); &#125; else &#123; if (n &lt; f &amp;&amp; data1.radius &gt;= n) &#123; line1.Collided(true); line2.Collided(true); &#125; else &#123; line1.Collided(false); line2.Collided(false); return; &#125; Vector3 point = data1.center + data1.direction * n; ConsoleUtils.Log(&quot;ç¢°æ’žç‚¹&quot;, point); &#125;&#125; å…¶ä»–æƒ…å†µå’Œå°„çº¿ä¸Žåœ†ç›¸äº¤æ£€æµ‹ä¸€æ ·ï¼Œå½“å°„çº¿åœ¨åŒ…å›´ç›’å†…çš„æ—¶å€™ä¸€å®šç›¸äº¤ï¼›å½“å°„çº¿ä¸ŽåŒ…å›´ç›’ç›¸åçš„æ—¶å€™ä¸€å®šä¸ç›¸äº¤ã€‚ å¯¹äºŽ AABB æ¥è¯´ï¼Œåªè¦åˆ¤æ–­å°„çº¿èµ·ç‚¹å’Œ AABB åŒ…å›´ç›’çš„æœ€å¤§æœ€å°ç‚¹çš„å…³ç³»å°±å¯ä»¥åˆ¤æ–­æ˜¯å¦åœ¨åŒ…å›´ç›’å†…ï¼Œå¯¹äºŽ OBB æ¥è¯´è¦æŠŠå°„çº¿èµ·ç‚¹æ˜ å°„åˆ° OBB åæ ‡ç³»ä¸­ï¼Œç„¶åŽæŒ‰ç…§ AABB çš„æ–¹å¼æ¥åˆ¤æ–­ã€‚ ç¢°æ’žæ£€æµ‹ç¤ºä¾‹å·¥ç¨‹ æ›´æ–°æ—¥å¿—2024-03-21 ä¿®å¤æè¿°é”™è¯¯ã€‚ 2023-10-15 æ›´æ–°åŸºæœ¬å†…å®¹ã€‚","categories":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://busyogg.github.io/categories/%E7%AE%97%E6%B3%95/"},{"name":"ç¢°æ’žæ£€æµ‹","slug":"ç®—æ³•/ç¢°æ’žæ£€æµ‹","permalink":"https://busyogg.github.io/categories/%E7%AE%97%E6%B3%95/%E7%A2%B0%E6%92%9E%E6%A3%80%E6%B5%8B/"}],"tags":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://busyogg.github.io/tags/%E7%AE%97%E6%B3%95/"},{"name":"C#","slug":"C","permalink":"https://busyogg.github.io/tags/C/"},{"name":"ç¢°æ’žæ£€æµ‹","slug":"ç¢°æ’žæ£€æµ‹","permalink":"https://busyogg.github.io/tags/%E7%A2%B0%E6%92%9E%E6%A3%80%E6%B5%8B/"},{"name":"OBB","slug":"OBB","permalink":"https://busyogg.github.io/tags/OBB/"},{"name":"AABB","slug":"AABB","permalink":"https://busyogg.github.io/tags/AABB/"},{"name":"å°„çº¿","slug":"å°„çº¿","permalink":"https://busyogg.github.io/tags/%E5%B0%84%E7%BA%BF/"}]},{"title":"ç¢°æ’žæ£€æµ‹ä¹‹å°„çº¿ä¸Žåœ†","slug":"ç¢°æ’žæ£€æµ‹ä¹‹å°„çº¿ä¸Žåœ†","date":"2023-10-08T11:20:39.000Z","updated":"2024-05-18T15:39:38.391Z","comments":true,"path":"article/d898103b68b3/","link":"","permalink":"https://busyogg.github.io/article/d898103b68b3/","excerpt":"","text":"ç®€ä»‹å°„çº¿æ£€æµ‹å¯ä»¥ç”¨äºŽæ‹¾å–ç‰©ä½“ã€åˆ¤æ–­å‰æ–¹æ˜¯å¦æœ‰éšœç¢ç‰©ã€åˆ¤æ–­æ˜¯å¦ç¢°æ’žç­‰åœºæ™¯ï¼Œæœ¬æ–‡ä»‹ç»å°„çº¿ä¸Žåœ†çš„æ£€æµ‹åŽŸç†ã€‚ åŽŸç†å°„çº¿ä¸Žåœ†çš„æ£€æµ‹ï¼Œæœ‰ä»¥ä¸‹å‡ ç‚¹åˆ¤æ–­ï¼š å°„çº¿æ–¹å‘æ˜¯å¦ä¸Žå°„çº¿èµ·ç‚¹ä¸Žåœ†çš„æ–¹å‘ç›¸åï¼Œæ˜¯åˆ™ä¸ç›¸äº¤ï¼› å°„çº¿æ˜¯å¦è¿‡çŸ­ï¼Œæ˜¯åˆ™ä¸ç›¸äº¤ï¼› å¦‚å›¾æ‰€ç¤ºï¼Œå°„çº¿ R åœ¨å°„çº¿åŽŸç‚¹ä¸Žåœ†å¿ƒæ–¹å‘çš„æŠ•å½±åŠ ä¸Šåœ† C çš„åŠå¾„é•¿åº¦ä¹‹å’Œå°äºŽå°„çº¿åŽŸç‚¹ä¸Žåœ†å¿ƒçš„è·ç¦» RCï¼Œå°„çº¿è¿‡çŸ­ã€‚ï¼ˆé»‘çº¿è¡¨ç¤ºè·ç¦»å’Œï¼Œè“çº¿è¡¨ç¤º RCï¼‰ å°„çº¿æ˜¯å¦åœ¨å›­å†…ï¼Œæ˜¯åˆ™å¿…å®šç›¸äº¤ï¼› å½“å°„çº¿ä¸Žåœ†ç›¸äº¤çš„æ—¶å€™ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š æˆ‘ä»¬æŠ•å½±å°„çº¿åŽŸç‚¹ä¸Žåœ†å¿ƒçš„è·ç¦» d åˆ°å°„çº¿ R ä¸Šï¼Œè®°ä¸º pï¼Œå¹¶é€šè¿‡åœ†å¿ƒä½œä¸€æ¡åž‚ç›´äºŽå°„çº¿ R çš„åž‚çº¿ gï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦‚ä¸‹å…³ç³»ï¼š f1 : $p^2+g^2&#x3D;d^2$ æˆ‘ä»¬æŠŠäº¤ç‚¹åˆ°å°„çº¿åŽŸç‚¹çš„è·ç¦»è®°ä¸º tï¼Œåˆ°åž‚çº¿ g çš„è·ç¦»è®°ä¸º sï¼Œçº¿æ®µ s æ»¡è¶³ä»¥ä¸‹å…³ç³»ï¼šf2 : $s^2+g^2&#x3D;r^2$ æˆ‘ä»¬åˆå¹¶ä¸¤ä¸ªä¸‰è§’å½¢æ–¹ç¨‹f1ã€f2ï¼Œå¾—åˆ°æ–¹ç¨‹ $p^2+g^2-s^2+g^2&#x3D;d^2-r^2$ï¼ŒåŒ–ç®€å¾—åˆ°ï¼šf3 : $s^2&#x3D;p^2-d^2+r^2$ ç”±æ­¤å¯çŸ¥ï¼Œå¦‚æžœå°„çº¿ä¸Žåœ†ç›¸äº¤ï¼Œåˆ™ä»¥ä¸Šç­‰å¼æ’æˆç«‹ï¼Œå³å¦‚æžœä»¥ä¸Šç­‰å¼ä¸æˆç«‹çš„æƒ…å†µä¸‹ï¼Œå°„çº¿ä¸Žåœ†ä¸ç›¸äº¤ã€‚å› æ­¤æˆ‘ä»¬åˆ¤æ–­æ–¹ç¨‹f3çš„æƒ…å†µæ˜¯å¦æˆç«‹ï¼Œå¼€æ ¹å·å¾—åˆ°ï¼š f4 : $s&#x3D;\\pm\\sqrt[]{p^2-d^2+r^2}$ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªè¦åˆ¤æ–­$p^2-d^2+r^2&gt;&#x3D;0$å°±çŸ¥é“å°„çº¿ä¸Žåœ†æ˜¯å¦ç›¸äº¤ï¼Œpã€dã€r å‡ä¸ºå·²çŸ¥æ•°ã€‚ å½“æˆ‘ä»¬è¦æ±‚äº¤ç‚¹çš„æ—¶å€™ï¼Œæˆ‘ä»¬åªè¦å¸¦å…¥ä¸Šæ–‡å·²æ±‚çš„ p å’Œ sï¼Œå¾—åˆ°è¿‘ç‚¹è·ç¦»ä¸ºï¼š$t&#x3D;p-s$ï¼›è¿œç‚¹è·ç¦»ä¸ºï¼š$t&#x3D;p+s$ï¼Œç„¶åŽä»¥å°„çº¿åŽŸç‚¹å‡ºå‘ï¼ŒåŠ ä¸Šæ–¹å‘å‘é‡çš„å•ä½å‘é‡ä¹˜ä»¥è·ç¦»ï¼Œå³å¯æ±‚å‡ºäº¤ç‚¹ã€‚ å¯¹äºŽä¸‰ç»´ç©ºé—´æ¥è¯´ï¼Œæˆ‘ä»¬æ±‚çš„ä¹Ÿæ˜¯å°„çº¿ä¸Žçƒçš„ä¸€ä¸ªé¢ï¼Œå³åœ†çš„å…³ç³»ã€‚å› æ­¤ç®—æ³•å’ŒäºŒç»´ç©ºé—´ä¸€æ ·ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243//åŒ…å›´ç›’æ•°æ®ç»“æž„public class CollisionData : MonoBehaviour&#123; public Vector3 center = Vector3.zero; public float radius = 1.0f; public Vector3 direction = Vector3.zero;&#125;---------------------------------------------/// &lt;summary&gt;/// å°„çº¿å’Œçƒæ£€æµ‹/// &lt;param name=&quot;data1&quot;&gt;&lt;/param&gt;/// &lt;param name=&quot;data2&quot;&gt;&lt;/param&gt;/// &lt;/summary&gt;private bool CollisionRay2Circle(CollisionData data1,CollisionData data2)&#123; Vector3 centerDis = data2.center - data1.center; Vector3 direction = data1.direction; float projection = Vector3.Dot(centerDis, direction); float r2 = Mathf.Pow(data2.radius, 2); float f = Mathf.Pow(projection, 2) + r2 - centerDis.sqrMagnitude; //æ–¹å‘ç›¸å bool checkDirection = projection &lt; 0; //å°„çº¿è¿‡çŸ­ bool checkDistance = centerDis.sqrMagnitude &gt; Mathf.Pow(data1.radius + data2.radius, 2); //å°„çº¿èµ·ç‚¹åœ¨çƒå†…éƒ¨ bool checkNotInside = centerDis.sqrMagnitude &gt; r2; //ä¸ç›¸äº¤ bool checkNotCollide = f &lt; 0; if (checkNotInside &amp;&amp; (checkDirection || checkDistance || checkNotCollide)) &#123; return false; &#125; float dis = projection - Mathf.Sqrt(f) * (checkNotInside ? 1 : -1); Vector3 point = data1.center + data1.direction * dis; ConsoleUtils.Log(&quot;ç¢°æ’žç‚¹&quot;, point); return true;&#125; ç¢°æ’žæ£€æµ‹ç¤ºä¾‹å·¥ç¨‹","categories":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://busyogg.github.io/categories/%E7%AE%97%E6%B3%95/"},{"name":"ç¢°æ’žæ£€æµ‹","slug":"ç®—æ³•/ç¢°æ’žæ£€æµ‹","permalink":"https://busyogg.github.io/categories/%E7%AE%97%E6%B3%95/%E7%A2%B0%E6%92%9E%E6%A3%80%E6%B5%8B/"}],"tags":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://busyogg.github.io/tags/%E7%AE%97%E6%B3%95/"},{"name":"C#","slug":"C","permalink":"https://busyogg.github.io/tags/C/"},{"name":"ç¢°æ’žæ£€æµ‹","slug":"ç¢°æ’žæ£€æµ‹","permalink":"https://busyogg.github.io/tags/%E7%A2%B0%E6%92%9E%E6%A3%80%E6%B5%8B/"},{"name":"åœ†","slug":"åœ†","permalink":"https://busyogg.github.io/tags/%E5%9C%86/"},{"name":"å°„çº¿","slug":"å°„çº¿","permalink":"https://busyogg.github.io/tags/%E5%B0%84%E7%BA%BF/"}]},{"title":"ç¢°æ’žæ£€æµ‹ä¹‹åœ†ä¸ŽOBB","slug":"ç¢°æ’žæ£€æµ‹ä¹‹åœ†ä¸ŽOBB","date":"2023-09-28T08:43:29.000Z","updated":"2024-05-18T15:38:30.812Z","comments":true,"path":"article/2d2709a1efcf/","link":"","permalink":"https://busyogg.github.io/article/2d2709a1efcf/","excerpt":"","text":"ç®€ä»‹åœ†ä¸Ž OBB è¿›è¡Œç¢°æ’žæ£€æµ‹ï¼Œå’Œåœ†ä¸Ž AABB è¿›è¡Œç¢°æ’žæ£€æµ‹ç±»ä¼¼ï¼Œå®žè´¨å¯ä»¥åŒ–ä¸ºä¸€ä¸ªç‚¹ä¸Ž OBB è¿›è¡Œæ£€æµ‹ï¼Œç„¶åŽæ ¹æ®æ£€æµ‹ç»“æžœä¸Žåœ†çš„åŠå¾„è¿›è¡Œæ¯”è¾ƒã€‚ åŽŸç†å’Œåœ†ä¸Ž AABB ç¢°æ’žæ£€æµ‹ç±»ä¼¼ï¼Œåœ†ä¸Ž OBB ç¢°æ’žæ£€æµ‹ä¹Ÿæ˜¯åŒ–ä¸ºç‚¹ä¸Ž OBB æ£€æµ‹ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦æŠŠç‚¹çš„åæ ‡åŒ–ä¸º OBB åæ ‡ç³»çš„åæ ‡ã€‚è¿™é‡Œæˆ‘ä»¬åˆ©ç”¨æŠ•å½±ï¼ŒæŠŠç‚¹çš„åæ ‡æŠ•å½±åˆ° OBB åæ ‡ç³»ä¸­ï¼Œç„¶åŽå†ä½¿ç”¨ç‚¹ä¸Ž AABB æ£€æµ‹çš„æ€è·¯è¿›è¡Œæ£€æµ‹ï¼Œæœ€åŽæŠŠå¾—åˆ°çš„äº¤ç‚¹è½¬æ¢å›žåŽŸæ¥çš„åæ ‡ç³»ä¸­ã€‚ å¦‚å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬è¿žæŽ¥ä¸¤ä¸ªç‰©ä½“çš„ä¸­å¿ƒç‚¹ C1 å’Œ C2ï¼Œå¾—åˆ°ä¸€ä¸ªè·ç¦»å‘é‡ DIRï¼ˆçŸ©å½¢ä¸­å¿ƒåˆ°åœ†å¿ƒï¼‰ã€‚ç„¶åŽæˆ‘ä»¬æŠŠ dir æŠ•å½±åˆ°çŸ©å½¢çš„åæ ‡è½´ä¸Šï¼Œå¾—åˆ° X æ–¹å‘çš„æŠ•å½± Xâ€™å’Œ Y æ–¹å‘çš„æŠ•å½± Yâ€™ï¼Œç”±æ­¤å¯ä»¥å¾—å‡º C1 ç‚¹åœ¨çŸ©å½¢åæ ‡ç³»ä¸­çš„ä½ç½®ã€‚ ç„¶åŽæˆ‘ä»¬åˆ©ç”¨åœ†ä¸Ž AABB æ£€æµ‹çš„æ–¹æ³•å¾—åˆ° OBB ä¸Šè·ç¦» C1 ç‚¹çš„æœ€è¿‘ç‚¹ï¼Œå¹¶ä¸”è¿˜åŽŸè¿™ä¸ªåæ ‡åˆ°åŽŸå§‹åæ ‡è½´ä¸­ã€‚å…·ä½“æ–¹æ³•æ˜¯ä»¤æœ€è¿‘ç‚¹ Pnear åˆå§‹å€¼ä¸º C2 åæ ‡ï¼Œç„¶åŽåœ¨æ±‚äº¤ç‚¹åœ¨æ¯ä¸ªè½´åæ ‡çš„æ—¶å€™è®© P çš„æ¯ä¸ªè½´çš„å€¼åŠ ä¸Šåæ ‡å€¼distance * åæ ‡è½´å‘é‡çš„åˆ†é‡ï¼Œå³ Pnear.x += distance * axis[i].x ,ä»¥æ­¤ç±»æŽ¨ã€‚ å¾—åˆ°æœ€è¿‘ç‚¹ä¹‹åŽï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨å’Œåœ†ä¸Ž AABB æ£€æµ‹ä¸€æ ·çš„æ–¹æ³•æ¥åˆ¤æ–­æ˜¯å¦ç›¸äº¤äº†ã€‚ ä¸‰ç»´ç©ºé—´å’ŒäºŒç»´ç©ºé—´çš„æ±‚æ³•ä¸€æ ·ï¼Œåªä¸è¿‡å¤šä¸€ä¸ªè½´ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364//åŒ…å›´ç›’æ•°æ®ç»“æž„using System.Collections;using System.Collections.Generic;using UnityEngine;public class CollisionData : MonoBehaviour&#123; public Vector3 center = Vector3.zero; public Vector3 extents = Vector3.zero; public Vector3[] axes = new Vector3[3]; public float radius = 1.0f;&#125;---------------------------------------------/// &lt;summary&gt;/// çƒä¸ŽOBBæ£€æµ‹/// &lt;param name=&quot;data1&quot;&gt;&lt;/param&gt;/// &lt;param name=&quot;data2&quot;&gt;&lt;/param&gt;/// &lt;/summary&gt;private bool CollisionCircle2OBB(CollisionData data1,CollisionData data2)&#123; //æ±‚æœ€è¿‘ç‚¹ Vector3 nearP = GetClosestPointOBB(data1,data2); //ä¸ŽAABBæ£€æµ‹åŽŸç†ç›¸åŒ float distance = (nearP - data1.center).sqrMagnitude; float radius = Mathf.Pow(data1.radius, 2); if (distance &lt;= radius) &#123; return true; &#125; else &#123; return false; &#125;&#125;/// &lt;summary&gt;/// èŽ·å–ä¸€ç‚¹åˆ°OBBçš„æœ€è¿‘ç‚¹/// &lt;param name=&quot;data1&quot;&gt;&lt;/param&gt;/// &lt;param name=&quot;data2&quot;&gt;&lt;/param&gt;/// &lt;/summary&gt;/// &lt;returns&gt;&lt;/returns&gt;private Vector3 GetClosestPointOBB(CollisionData data1,CollisionData data2)&#123; Vector3 nearP = data2.center; //æ±‚çƒå¿ƒä¸ŽOBBä¸­å¿ƒçš„è·ç¦»å‘é‡ ä»ŽOBBä¸­å¿ƒæŒ‡å‘çƒå¿ƒ Vector3 center1 = data1.center; Vector3 center2 = data2.center; Vector3 dist = center1 - center2; float[] extents = new float[3] &#123; data2.extents.x, data2.extents.y, data2.extents.z &#125;; Vector3[] axes = data2.axes; for (int i = 0; i &lt; 3; i++) &#123; //è®¡ç®—è·ç¦»å‘é‡åˆ°OBBåæ ‡è½´çš„æŠ•å½±é•¿åº¦ å³è·ç¦»å‘é‡åœ¨OBBåæ ‡ç³»ä¸­çš„å¯¹åº”åæ ‡è½´çš„é•¿åº¦ float distance = Vector3.Dot(dist, axes[i]); distance = Mathf.Clamp(distance, -extents[i], extents[i]); //è¿˜åŽŸåˆ°ä¸–ç•Œåæ ‡ nearP.x += distance * axes[i].x; nearP.y += distance * axes[i].y; nearP.z += distance * axes[i].z; &#125; return nearP;&#125; å…¶ä»–å’Œåœ†ä¸Žåœ†çš„æ£€æµ‹ä¸€æ ·ï¼Œåœ†ä¸Ž OBB æ£€æµ‹æ±‚ä¸¤ç‚¹è·ç¦»çš„æ—¶å€™ä¹Ÿä½¿ç”¨å¹³æ–¹æ¥è®¡ç®—ï¼Œå‡å°‘å¼€æ–¹çš„æ€§èƒ½æ¶ˆè€—ã€‚ ç¢°æ’žæ£€æµ‹ç¤ºä¾‹å·¥ç¨‹","categories":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://busyogg.github.io/categories/%E7%AE%97%E6%B3%95/"},{"name":"ç¢°æ’žæ£€æµ‹","slug":"ç®—æ³•/ç¢°æ’žæ£€æµ‹","permalink":"https://busyogg.github.io/categories/%E7%AE%97%E6%B3%95/%E7%A2%B0%E6%92%9E%E6%A3%80%E6%B5%8B/"}],"tags":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://busyogg.github.io/tags/%E7%AE%97%E6%B3%95/"},{"name":"C#","slug":"C","permalink":"https://busyogg.github.io/tags/C/"},{"name":"ç¢°æ’žæ£€æµ‹","slug":"ç¢°æ’žæ£€æµ‹","permalink":"https://busyogg.github.io/tags/%E7%A2%B0%E6%92%9E%E6%A3%80%E6%B5%8B/"},{"name":"OBB","slug":"OBB","permalink":"https://busyogg.github.io/tags/OBB/"},{"name":"åœ†","slug":"åœ†","permalink":"https://busyogg.github.io/tags/%E5%9C%86/"}]},{"title":"ç¢°æ’žæ£€æµ‹ä¹‹åœ†ä¸ŽAABB","slug":"ç¢°æ’žæ£€æµ‹ä¹‹åœ†ä¸ŽAABB","date":"2023-09-26T16:11:11.000Z","updated":"2024-05-18T15:38:31.960Z","comments":true,"path":"article/09bda077a263/","link":"","permalink":"https://busyogg.github.io/article/09bda077a263/","excerpt":"","text":"ç®€ä»‹åœ†ä¸Ž AABB è¿›è¡Œç¢°æ’žæ£€æµ‹ï¼Œå®žè´¨å¯ä»¥åŒ–ä¸ºä¸€ä¸ªç‚¹ä¸Ž AABB è¿›è¡Œæ£€æµ‹ï¼Œç„¶åŽæ ¹æ®æ£€æµ‹ç»“æžœä¸Žåœ†çš„åŠå¾„è¿›è¡Œæ¯”è¾ƒã€‚ åŽŸç†äºŒç»´ é¦–å…ˆæˆ‘ä»¬æŠŠåœ†ä¸Ž AABB çš„é—®é¢˜åŒ–ä¸ºç‚¹ä¸Ž AABB çš„é—®é¢˜ã€‚ ä»Žä¸€ä¸ªç‚¹åˆ°ä¸€æ¡ç›´çº¿çš„æœ€çŸ­è·ç¦»ï¼Œå°±æ˜¯ä»Žè¿™ä¸ªç‚¹åšä¸€æ¡åž‚çº¿ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¾—åˆ°äº†ä¸€ä¸ªç‚¹ Pã€‚ å¦‚å›¾æ‰€ç¤ºï¼Œåœ¨ Y è½´ä¸Šï¼Œè¿™ä¸ªç‚¹çš„ Y åæ ‡åœ¨çŸ©å½¢ Y åæ ‡çš„æœ€å¤§å€¼å’Œæœ€å°å€¼ä¹‹é—´ã€‚è¿™æ—¶æˆ‘ä»¬è§‚å¯Ÿå›¾åƒå¯çŸ¥ï¼ŒP ç‚¹çš„ Y åæ ‡å°±æ˜¯åœ†å¿ƒçš„ Y åæ ‡ã€‚ åœ¨ X è½´ä¸Šï¼Œè¿™ä¸ªç‚¹çš„ X åæ ‡åœ¨çŸ©å½¢ X åæ ‡çš„æœ€å¤§å€¼å’Œæœ€å°å€¼ä¹‹å¤–ã€‚ç”±äºŽ P ç‚¹æ˜¯çŸ©å½¢ä¸Šä¸€ç‚¹ï¼Œå› æ­¤ P çš„ X åæ ‡ä¸€å®šé™åˆ¶åœ¨çŸ©å½¢çš„ X åæ ‡ä¹‹å†…ã€‚æ‰€ä»¥ï¼Œæ­¤æ—¶ P ç‚¹çš„ X åæ ‡ä¸ºçŸ©å½¢çš„ X åæ ‡æœ€å°å€¼ã€‚ é€šè¿‡è¿™ä¸¤æ¡æˆ‘ä»¬ä¸éš¾çœ‹å‡ºï¼Œä¸€ä¸ªç‚¹åœ¨ AABB çš„æœ€è¿‘ç‚¹åæ ‡ä¸€å®šåœ¨ AABB æœ€å¤§æœ€å°åæ ‡ä¹‹å†…ï¼Œå¦‚æžœè¶…å‡ºçš„è¯å°±è®¾ç½®ä¸º AABB çš„æœ€å¤§æˆ–æœ€å°åæ ‡ã€‚ å½“æˆ‘ä»¬å¾—åˆ° P ç‚¹åæ ‡ä¹‹åŽï¼Œå°±å¯ä»¥é€šè¿‡åœ†å¿ƒå’Œ P ç‚¹æ±‚å‡ºè¿™ä¸¤ä¸ªç‚¹ä¹‹é—´çš„è·ç¦»ã€‚ç„¶åŽæˆ‘ä»¬åªéœ€è¦æ¯”è¾ƒè¿™ä¸ªè·ç¦»å’Œåœ†åŠå¾„çš„å…³ç³»å°±å¯ä»¥çŸ¥é“è¿™ä¸¤ä¸ªç‰©ä½“æ˜¯å¦ç›¸äº¤ã€‚ ä¸‰ç»´åœ¨ä¸‰ç»´ç©ºé—´ä¸­ï¼Œä¸¤ä¸ªå¯¹è±¡ç¢°æ’žæ£€æµ‹çš„åŽŸç†å’ŒäºŒç»´ç©ºé—´ä¸€æ ·ï¼Œåªä¸è¿‡å¤šåŠ äº†ä¸€ä¸ª Z è½´ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849//åŒ…å›´ç›’æ•°æ®ç»“æž„using System.Collections;using System.Collections.Generic;using UnityEngine;public class CollisionData : MonoBehaviour&#123; public Vector3 max = Vector3.zero; public Vector3 min = Vector3.zero; public Vector3 center = Vector3.zero; public float radius = 1.0f;&#125;---------------------------------------------/// &lt;summary&gt;/// çƒä¸ŽAABBæ£€æµ‹/// &lt;param name=&quot;data1&quot;&gt;&lt;/param&gt;/// &lt;param name=&quot;data2&quot;&gt;&lt;/param&gt;/// &lt;/summary&gt;private bool CollisionCircle2AABB(CollisionData data1,CollisionData data2)&#123; //æ±‚å‡ºæœ€è¿‘ç‚¹ Vector3 center = data1.center; Vector3 nearP = GetClosestPointAABB(data1,data2); //æ±‚å‡ºæœ€è¿‘ç‚¹ä¸Žçƒå¿ƒçš„è·ç¦» float distance = (nearP - center).sqrMagnitude; float radius = Mathf.Pow(data1.radius, 2); //è·ç¦»å°äºŽåŠå¾„åˆ™ç¢°æ’ž if (distance &lt;= radius) &#123; return true; &#125; return false;&#125;/// &lt;summary&gt;/// èŽ·å¾—ä¸€ç‚¹åˆ°AABBæœ€è¿‘ç‚¹/// &lt;param name=&quot;data1&quot;&gt;&lt;/param&gt;/// &lt;param name=&quot;data2&quot;&gt;&lt;/param&gt;/// &lt;/summary&gt;/// &lt;returns&gt;&lt;/returns&gt;private Vector3 GetClosestPointAABB(CollisionData data1,CollisionData data2)&#123; Vector3 center = data1.center; Vector3 nearP = Vector3.zero; nearP.x = Mathf.Clamp(center.x, data2.min.x, data2.max.x); nearP.y = Mathf.Clamp(center.y, data2.min.y, data2.max.y); nearP.z = Mathf.Clamp(center.z, data2.min.z, data2.max.z); return nearP;&#125; å…¶ä»–å’Œåœ†ä¸Žåœ†çš„æ£€æµ‹ä¸€æ ·ï¼Œåœ†ä¸Ž AABB æ£€æµ‹æ±‚ä¸¤ç‚¹è·ç¦»çš„æ—¶å€™ä¹Ÿä½¿ç”¨å¹³æ–¹æ¥è®¡ç®—ï¼Œå‡å°‘å¼€æ–¹çš„æ€§èƒ½æ¶ˆè€—ã€‚ ç¢°æ’žæ£€æµ‹ç¤ºä¾‹å·¥ç¨‹","categories":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://busyogg.github.io/categories/%E7%AE%97%E6%B3%95/"},{"name":"ç¢°æ’žæ£€æµ‹","slug":"ç®—æ³•/ç¢°æ’žæ£€æµ‹","permalink":"https://busyogg.github.io/categories/%E7%AE%97%E6%B3%95/%E7%A2%B0%E6%92%9E%E6%A3%80%E6%B5%8B/"}],"tags":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://busyogg.github.io/tags/%E7%AE%97%E6%B3%95/"},{"name":"C#","slug":"C","permalink":"https://busyogg.github.io/tags/C/"},{"name":"ç¢°æ’žæ£€æµ‹","slug":"ç¢°æ’žæ£€æµ‹","permalink":"https://busyogg.github.io/tags/%E7%A2%B0%E6%92%9E%E6%A3%80%E6%B5%8B/"},{"name":"AABB","slug":"AABB","permalink":"https://busyogg.github.io/tags/AABB/"},{"name":"åœ†","slug":"åœ†","permalink":"https://busyogg.github.io/tags/%E5%9C%86/"}]},{"title":"ç¢°æ’žæ£€æµ‹ä¹‹åœ†ä¸Žåœ†","slug":"ç¢°æ’žæ£€æµ‹ä¹‹åœ†ä¸Žåœ†","date":"2023-09-26T15:46:22.000Z","updated":"2024-05-18T15:38:33.204Z","comments":true,"path":"article/2bef1c973f07/","link":"","permalink":"https://busyogg.github.io/article/2bef1c973f07/","excerpt":"","text":"ç®€ä»‹ç”¨åœ†æˆ–çƒæ¥åŒ…è£¹ç‰©ä½“ï¼Œæ£€æµ‹ä¸¤ä¸ªç‰©ä½“æ˜¯å¦æœ‰ç¢°æ’žã€‚ åŽŸç† åˆ¤æ–­ä¸¤ä¸ªåœ†æ˜¯å¦ç›¸äº¤ï¼Œåªéœ€è¦åˆ¤æ–­ä¸¤ä¸ªåœ†å¿ƒçš„è·ç¦»å°äºŽç­‰äºŽï¼ˆä¹Ÿå¯ä»¥åªæ˜¯å°äºŽï¼Œçœ‹éœ€æ±‚ï¼‰ä¸¤ä¸ªåœ†çš„åŠå¾„ä¹‹å’Œï¼Œè‹¥å°äºŽï¼Œåˆ™ç›¸äº¤ã€‚ äºŒç»´ç©ºé—´å’Œä¸‰ç»´ç©ºé—´çš„åŽŸç†ç›¸åŒï¼Œä¹Ÿæ˜¯åˆ¤æ–­ä¸¤ä¸ªçƒå¿ƒçš„è·ç¦»å°äºŽç­‰äºŽä¸¤ä¸ªçƒçš„åŠå¾„ä¹‹å’Œã€‚ ç‰©ä½“çš„åŒ…å›´çƒå¯èƒ½ä¼šå­˜åœ¨è¾ƒå¤§çš„ç©ºéš™ï¼Œå› æ­¤åŒ…å›´çƒæ£€æµ‹çš„ç²¾åº¦è¾ƒä½Žã€‚ æˆ‘ä»¬åœ¨æ±‚è·ç¦»çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨å¹³æ–¹æ¥è®¡ç®—ï¼Œå› ä¸ºå¹³æ–¹çš„å¼€é”€æ¯”å¼€æ–¹å°ï¼Œè¿™æ ·å¯ä»¥ä¼˜åŒ–æ€§èƒ½ã€‚ 1234567891011121314151617181920212223242526272829//åŒ…å›´ç›’æ•°æ®ç»“æž„using System.Collections;using System.Collections.Generic;using UnityEngine;public class CollisionData : MonoBehaviour&#123; public Vector3 center = Vector3.zero; public float radius = 1.0f;&#125;---------------------------------------------/// &lt;summary&gt;/// çƒä¸Žçƒæ£€æµ‹/// &lt;param name=&quot;data1&quot;&gt;&lt;/param&gt;/// &lt;param name=&quot;data2&quot;&gt;&lt;/param&gt;/// &lt;/summary&gt;private bool CollisionCircle(CollisionData data1,CollisionData data2)&#123; //æ±‚ä¸¤ä¸ªçƒåŠå¾„å’Œçš„å¹³æ–¹ float totalRadius = Mathf.Pow(data1.radius + data2.radius, 2); //çƒä¸¤ä¸ªçƒå¿ƒä¹‹é—´çš„è·ç¦»å¹³æ–¹ float distance = (data1.center - data2.center).sqrMagnitude; //è·ç¦»å°äºŽç­‰äºŽåŠå¾„å’Œåˆ™ç¢°æ’ž if (distance &lt;= totalRadius) &#123; return true; &#125; return false;&#125; ç¢°æ’žæ£€æµ‹ç¤ºä¾‹å·¥ç¨‹","categories":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://busyogg.github.io/categories/%E7%AE%97%E6%B3%95/"},{"name":"ç¢°æ’žæ£€æµ‹","slug":"ç®—æ³•/ç¢°æ’žæ£€æµ‹","permalink":"https://busyogg.github.io/categories/%E7%AE%97%E6%B3%95/%E7%A2%B0%E6%92%9E%E6%A3%80%E6%B5%8B/"}],"tags":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://busyogg.github.io/tags/%E7%AE%97%E6%B3%95/"},{"name":"C#","slug":"C","permalink":"https://busyogg.github.io/tags/C/"},{"name":"ç¢°æ’žæ£€æµ‹","slug":"ç¢°æ’žæ£€æµ‹","permalink":"https://busyogg.github.io/tags/%E7%A2%B0%E6%92%9E%E6%A3%80%E6%B5%8B/"},{"name":"åœ†","slug":"åœ†","permalink":"https://busyogg.github.io/tags/%E5%9C%86/"}]},{"title":"ç¢°æ’žæ£€æµ‹ä¹‹OBB","slug":"ç¢°æ’žæ£€æµ‹ä¹‹OBB","date":"2023-09-25T15:27:33.000Z","updated":"2024-05-18T15:38:27.157Z","comments":true,"path":"article/3c9cb66ca768/","link":"","permalink":"https://busyogg.github.io/article/3c9cb66ca768/","excerpt":"","text":"ç®€ä»‹OBB æ£€æµ‹ï¼Œå³æœ‰å‘åŒ…å›´ç›’ï¼ˆOriented Bounding Boxï¼‰æ£€æµ‹ï¼Œæ˜¯ä¸€ç§æ£€æµ‹ä¸¤ä¸ªç‰©ä½“æœ‰æ²¡æœ‰ç›¸äº¤çš„ç®—æ³•ã€‚ç‰©ä½“æ ¹æ®åŒ…å›´ç›’ä¸­å¿ƒã€åŒ…å›´ç›’å¤§å°ä»¥åŠåŒ…å›´ç›’æ—‹è½¬è½´æž„é€ æœ‰å‘åŒ…å›´ç›’ï¼Œè¯¥åŒ…å›´ç›’æ¯” AABB åŒ…å›´ç›’æ›´è´´åˆæ—‹è½¬ç‰©ä½“ã€‚OBB æ£€æµ‹åˆ©ç”¨ SATï¼ˆSeparating AxisTheoremï¼‰åˆ†ç¦»è½´ç®—æ³•è¿›è¡Œç›¸äº¤æ£€æµ‹ï¼Œæ¯” AABB æ£€æµ‹å…·æœ‰æ›´å¥½çš„æ£€æµ‹ç²¾åº¦ã€‚ åŽŸç† å¯¹äºŽä¸¤ä¸ªå‡¸å¤šè¾¹å½¢æ¥è¯´ï¼Œè‹¥å­˜åœ¨ä¸€æ¡ç›´çº¿æŠŠä¸¤ä¸ªå‡¸å¤šè¾¹å½¢åˆ†å¼€ï¼Œé‚£ä¹ˆåž‚ç›´äºŽè¿™æ¡ç›´çº¿çš„è½´åˆ™ç§°ä¸ºåˆ†ç¦»è½´ã€‚è‹¥ä¸¤ä¸ªç‰©ä½“åœ¨åˆ†ç¦»è½´ä¸Šçš„æŠ•å½±ä¸ç›¸äº¤ï¼Œåˆ™ä¸¤ä¸ªç‰©ä½“ä¸ç›¸äº¤ï¼Œå¹¶ä¸”ä¸€æ—¦åœ¨æŸä¸ªè½´ä¸Šå­˜åœ¨ä¸ç›¸äº¤çš„æƒ…å†µï¼Œåˆ™ä¸¤ä¸ªç‰©ä½“ä¸€å®šä¸ç›¸äº¤ï¼Œé€€å‡ºæ£€æµ‹ã€‚ åœ¨å®žé™…è¿ç”¨ä¸­ï¼Œæˆ‘ä»¬å¸¸ä»¥å‡¸å¤šè¾¹å½¢çš„è¾¹çš„åž‚çº¿ä½œä¸ºåˆ†ç¦»è½´ï¼Œä¾æ¬¡æ£€æµ‹ç‰©ä½“åœ¨åˆ†ç¦»è½´ä¸Šçš„æŠ•å½±ã€‚ äºŒç»´ åœ¨ 2D å›¾å½¢ä¸­ï¼Œåˆ†ç¦»è½´çš„æ•°é‡ä¸ºä¸¤ä¸ªå‡¸å¤šè¾¹å½¢ç‰©ä½“çš„è¾¹æ•°ä¹‹å’Œï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œ4 æ¡é»‘è‰²çš„è½´ä¸ºåˆ†ç¦»è½´ã€‚åœ¨åˆ†ç¦»è½´ 1 ä¸Šï¼Œæˆ‘ä»¬è§‚å¯Ÿåˆ°ç‰©ä½“ A çš„æŠ•å½±å’Œç‰©ä½“ B çš„æŠ•å½±ç›¸äº¤äº†ï¼Œå› æ­¤åœ¨åˆ†ç¦»è½´ 1 ä¸Šï¼Œä¸¤ä¸ªç‰©ä½“ç›¸äº¤ï¼›åœ¨åˆ†ç¦»è½´ 2 ä¸Šï¼Œæˆ‘ä»¬è§‚å¯Ÿåˆ°ä¸¤ä¸ªç‰©ä½“çš„æŠ•å½±æ²¡æœ‰ç›¸äº¤ï¼Œå› æ­¤ä¸¤ä¸ªç‰©ä½“åœ¨åˆ†ç¦»è½´ 2 ä¸Šæ²¡æœ‰ç›¸äº¤ã€‚ ç”±æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡º Aã€B ä¸¤ä¸ªç‰©ä½“æ²¡æœ‰ç›¸äº¤ã€‚é€šè¿‡è§‚å¯Ÿå›¾åƒæˆ‘ä»¬ä¹ŸçŸ¥é“è¿™ä¸ªç»“æžœæ²¡é”™ã€‚ ä¸‰ç»´åœ¨ 3D ä¸­ï¼Œæˆ‘ä»¬ä»¥ä¸€ä¸ªæœ‰å‘çš„é•¿æ–¹ä½“æ¥åŒ…å›´ç‰©ä½“ï¼Œå³ OBBã€‚ ç”±äºŽé•¿æ–¹ä½“çš„åæ ‡è½´ä¸¤ä¸¤åž‚ç›´ï¼Œå› æ­¤åæ ‡è½´å³æ˜¯åˆ†ç¦»è½´ã€‚ç”±äºŽä¸¤ä¸ªé•¿æ–¹ä½“ä¹‹é—´è¿˜å­˜åœ¨ç‰¹æ®Šçš„æ‘†æ”¾ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸¤ä¸ªåŒ…å›´ç›’çš„åæ ‡è½´åˆ†ç¦»è½´æŠ•å½±å‡ç›¸äº¤ï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªç‰©ä½“å¹¶æ²¡æœ‰ç›¸äº¤ï¼Œä¸¤ä¸ªç‰©ä½“ä¹‹é—´è¿˜æ˜¯å­˜åœ¨ä¸€ä¸ªé¢èƒ½å¤ŸæŠŠä¸¤ä¸ªç‰©ä½“åˆ†å¼€ï¼Œè¿™ä¸ªé¢å°±æ˜¯å‘é‡ A å’Œå‘é‡ B æž„æˆçš„å¹³é¢ã€‚ åˆ©ç”¨å‘é‡å‰ä¹˜çš„æ€§è´¨ï¼Œæˆ‘ä»¬å¯ä»¥æ±‚å‡ºä¸€ä¸ªåž‚ç›´äºŽè¿™ä¸ªé¢çš„å‘é‡ï¼Œæˆ‘ä»¬ä»¥è¿™ä¸ªå‘é‡ä¸ºæ–°çš„åˆ†ç¦»è½´ã€‚ä¸¤ä¸ªç‰©ä½“æ¯ä¸¤æ¡è¾¹æž„æˆçš„é¢éƒ½éœ€è¦æ±‚åž‚ç›´å‘é‡ï¼Œå› æ­¤ä¸¤ä¸ª OBB åŒ…å›´ç›’ä¹‹é—´æœ‰ 3 * 3 = 9 æ¡æ–°çš„åˆ†ç¦»è½´ã€‚åŠ ä¸ŠåŽŸæ¥ä¸¤ä¸ªå‘é‡çš„ 3 + 3 = 6 æ¡åˆ†ç¦»è½´ï¼Œåœ¨ 3D ä¸­ä¸€å…±è¦æ£€æµ‹15æ¡åˆ†ç¦»è½´ã€‚ å¯¹äºŽå…¶ä¸­ä¸€æ¡åˆ†ç¦»è½´ï¼Œæˆ‘ä»¬éåŽ†é¡¶ç‚¹ä½œä¸ºå‘é‡ï¼ŒæŠ•å½±åˆ°åˆ†ç¦»è½´ä¸Šï¼Œç­›é€‰å‡ºæœ€å¤§å’Œæœ€å°å€¼ã€‚å¯¹ä¸¤ä¸ªç‰©ä½“è¿›è¡ŒåŒæ ·çš„æ“ä½œåŽï¼Œæˆ‘ä»¬æ¯”è¾ƒä¸¤ä¸ªç‰©ä½“çš„æŠ•å½±æœ€å€¼æœ‰æ— ç›¸äº¤ã€‚æ¯æ¡åˆ†ç¦»è½´ä»¥æ­¤æ–¹æ³•æ“ä½œå³å¯ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485//åŒ…å›´ç›’æ•°æ®ç»“æž„using System.Collections;using System.Collections.Generic;using UnityEngine;public class CollisionData : MonoBehaviour&#123; public Vector3[] vertexts = new Vector3[8]; public Vector3[] axes = new Vector3[3]; public Vector3 center = Vector3.zero;&#125;---------------------------------------------/// &lt;summary&gt;/// SATåˆ†ç¦»è½´ç¢°æ’žæ£€æµ‹ä¹‹OBBæ£€æµ‹/// &lt;param name=&quot;data1&quot;&gt;&lt;/param&gt;/// &lt;param name=&quot;data2&quot;&gt;&lt;/param&gt;/// &lt;/summary&gt;private bool CollisionOBB(CollisionData data1,CollisionData data2)&#123; //æ±‚ä¸Žä¸¤ä¸ªOBBåŒ…å›´ç›’ä¹‹é—´ä¸¤ä¸¤åæ ‡è½´åž‚ç›´çš„æ³•çº¿è½´ å…±9ä¸ª int len1 = data1.axes.Length; int len2 = data2.axes.Length; Vector3[] axes = new Vector3[len1 + len2 + len1 * len2]; int k = 0; int initJ = len2; for (int i = 0; i &lt; len1; i++) &#123; axes[k++] = data1.axes[i]; for (int j = 0; j &lt; len2; j++) &#123; if (initJ &gt; 0) &#123; initJ--; axes[k++] = data2.axes[j]; &#125; axes[k++] = Vector3.Cross(data1.axes[i], data2.axes[j]); &#125; &#125; for (int i = 0, len = axes.Length; i &lt; len; i++) &#123; if (NotInteractiveOBB(data1.vertexts, data2.vertexts, axes[i])) &#123; //æœ‰ä¸€ä¸ªä¸ç›¸äº¤å°±é€€å‡º return false; &#125; &#125; return true;&#125;/// &lt;summary&gt;/// è®¡ç®—æŠ•å½±æ˜¯å¦ä¸ç›¸äº¤/// &lt;/summary&gt;/// &lt;param name=&quot;vertexs1&quot;&gt;&lt;/param&gt;/// &lt;param name=&quot;vertexs2&quot;&gt;&lt;/param&gt;/// &lt;param name=&quot;axis&quot;&gt;&lt;/param&gt;/// &lt;returns&gt;&lt;/returns&gt;private bool NotInteractiveOBB(Vector3[] vertexs1, Vector3[] vertexs2, Vector3 axis)&#123; //è®¡ç®—OBBåŒ…å›´ç›’åœ¨åˆ†ç¦»è½´ä¸Šçš„æŠ•å½±æžé™å€¼ float[] limit1 = GetProjectionLimit(vertexs1, axis); float[] limit2 = GetProjectionLimit(vertexs2, axis); //ä¸¤ä¸ªåŒ…å›´ç›’æžé™å€¼ä¸ç›¸äº¤ï¼Œåˆ™ä¸ç¢°æ’ž return limit1[0] &gt; limit2[1] || limit2[0] &gt; limit1[1];&#125;/// &lt;summary&gt;/// è®¡ç®—é¡¶ç‚¹æŠ•å½±æžé™å€¼/// &lt;/summary&gt;/// &lt;param name=&quot;vertexts&quot;&gt;&lt;/param&gt;/// &lt;param name=&quot;axis&quot;&gt;&lt;/param&gt;/// &lt;returns&gt;&lt;/returns&gt;private float[] GetProjectionLimit(Vector3[] vertexts, Vector3 axis)&#123; float[] result = new float[2] &#123; float.MaxValue, float.MinValue &#125;; for (int i = 0, len = vertexts.Length; i &lt; len; i++) &#123; Vector3 vertext = vertexts[i]; float dot = Vector3.Dot(vertext, axis); result[0] = Mathf.Min(dot, result[0]); result[1] = Mathf.Max(dot, result[1]); &#125; return result;&#125; å…¶ä»–OBB æ£€æµ‹åªèƒ½æ˜¯å‡¸å¤šè¾¹å½¢ï¼Œä¸é€‚ç”¨äºŽå‡¹å¤šè¾¹å½¢çš„æƒ…å†µã€‚å‡¹å¤šè¾¹å½¢å¯ä»¥åˆ†å‰²ä¸ºå‡¸å¤šè¾¹å½¢è¿›è¡Œæ£€æµ‹ã€‚ ç¢°æ’žæ£€æµ‹ç¤ºä¾‹å·¥ç¨‹","categories":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://busyogg.github.io/categories/%E7%AE%97%E6%B3%95/"},{"name":"ç¢°æ’žæ£€æµ‹","slug":"ç®—æ³•/ç¢°æ’žæ£€æµ‹","permalink":"https://busyogg.github.io/categories/%E7%AE%97%E6%B3%95/%E7%A2%B0%E6%92%9E%E6%A3%80%E6%B5%8B/"}],"tags":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://busyogg.github.io/tags/%E7%AE%97%E6%B3%95/"},{"name":"C#","slug":"C","permalink":"https://busyogg.github.io/tags/C/"},{"name":"ç¢°æ’žæ£€æµ‹","slug":"ç¢°æ’žæ£€æµ‹","permalink":"https://busyogg.github.io/tags/%E7%A2%B0%E6%92%9E%E6%A3%80%E6%B5%8B/"},{"name":"OBB","slug":"OBB","permalink":"https://busyogg.github.io/tags/OBB/"},{"name":"SATåˆ†ç¦»è½´","slug":"SATåˆ†ç¦»è½´","permalink":"https://busyogg.github.io/tags/SAT%E5%88%86%E7%A6%BB%E8%BD%B4/"}]},{"title":"ç¢°æ’žæ£€æµ‹ä¹‹AABB","slug":"ç¢°æ’žæ£€æµ‹ä¹‹AABB","date":"2023-09-25T14:35:26.000Z","updated":"2024-05-18T15:38:29.519Z","comments":true,"path":"article/1f60a8286c97/","link":"","permalink":"https://busyogg.github.io/article/1f60a8286c97/","excerpt":"","text":"ç®€ä»‹AABB æ£€æµ‹ï¼Œå³è½´å¯¹é½åŒ…å›´ç›’ï¼ˆAxis-Aligned Bounding Boxesï¼‰æ£€æµ‹ï¼Œæ˜¯ä¸€ç§æ£€æµ‹ä¸¤ä¸ªç‰©ä½“æœ‰æ²¡æœ‰ç›¸äº¤çš„ç®—æ³•ã€‚ç‰©ä½“æ ¹æ®åæ ‡è½´å½¢æˆåŒ…å›´ç›’ï¼Œé€šè¿‡æ£€æµ‹é¡¶ç‚¹å…³ç³»æ¥åˆ¤æ–­æ˜¯å¦ç›¸äº¤ã€‚ åŽŸç†ä¸€ç»´ å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåœ¨ä¸€ç»´åæ ‡è½´ä¸­ï¼Œå­˜åœ¨ä¸€ä¸ªç‰©ä½“ ABï¼Œä¸€ä¸ªç‰©ä½“ CD ä»¥åŠä¸€ä¸ªç‰©ä½“ EFã€‚ å½“æˆ‘ä»¬è¦æ£€æµ‹ç‰©ä½“ AB å’Œ CD æ˜¯å¦ç›¸äº¤çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸éš¾çœ‹å‡ºï¼Œåªè¦ç‰©ä½“ CD çš„æœ€å¤§åæ ‡å’Œæœ€å°åæ ‡éƒ½ä¸åœ¨ç‰©ä½“ AB çš„åæ ‡ä¹‹é—´ï¼Œé‚£æˆ‘ä»¬å°±è®¤ä¸ºè¿™ä¸¤ä¸ªç‰©ä½“æ²¡æœ‰ç›¸äº¤ã€‚ å½“æˆ‘ä»¬æ£€æµ‹ç‰©ä½“ AB å’Œç‰©ä½“ EF æ˜¯å¦ç›¸äº¤çš„æ—¶å€™ï¼Œæˆ‘ä»¬è§‚å¯Ÿåˆ°ç‰©ä½“ AB å’Œç‰©ä½“ EF çš„åæ ‡ç›¸äº¤äº†ï¼Œå› æ­¤è¿™ä¸¤ä¸ªç‰©ä½“ç›¸äº¤ã€‚ ç”±æ­¤æˆ‘ä»¬å¯ä»¥å¾—å‡ºï¼Œå½“ä¸€ä¸ªç‰©ä½“çš„æœ€å¤§åæ ‡å’Œæœ€å°åæ ‡éƒ½ä¸åœ¨å¦ä¸€ä¸ªç‰©ä½“çš„æœ€å¤§åæ ‡å’Œæœ€å°åæ ‡ä¹‹é—´ï¼Œåˆ™ä¸¤ä¸ªç‰©ä½“æ²¡æœ‰ç›¸äº¤ã€‚ äºŒç»´è¿™ä¸ªåŽŸç†æ‹“å±•åˆ°äºŒç»´åæ ‡ä¸­ï¼Œå³ 2D å¹³é¢ä¸­ä¹Ÿæˆç«‹ã€‚ åŒæ ·çš„ï¼Œæˆ‘ä»¬åœ¨å¹³é¢ä¸­ä¹Ÿå­˜åœ¨ Aã€Bã€Cã€D å››ä¸ªç‰©ä½“ã€‚ å¯¹äºŽç‰©ä½“ A å’Œç‰©ä½“ Dï¼Œåœ¨ X è½´ä¸­ï¼Œæˆ‘ä»¬éœ€è¦åˆ¤æ–­ D çš„ X æœ€å¤§å€¼å’Œ D çš„ X æœ€å°å€¼éƒ½ä¸åœ¨ A çš„ X æœ€å¤§å€¼å’Œ X æœ€å°å€¼ä¸­ï¼Œæˆ‘ä»¬å°±èƒ½åˆ¤æ–­è¿žä¸ªç‰©ä½“ä¸ç›¸äº¤ã€‚ å¯¹äºŽç‰©ä½“ A å’Œç‰©ä½“ Cï¼Œåœ¨ X è½´ä¸­ï¼Œæˆ‘ä»¬éœ€è¦åˆ¤æ–­ C çš„ Y æœ€å¤§å€¼å’Œ C çš„ Y æœ€å°å€¼éƒ½ä¸åœ¨ A çš„ Y æœ€å¤§å€¼å’Œ Y æœ€å°å€¼ä¸­ï¼Œæˆ‘ä»¬å°±èƒ½åˆ¤æ–­è¿žä¸ªç‰©ä½“ä¸ç›¸äº¤ã€‚ å› æ­¤ï¼Œå¯¹äºŽå¹³é¢æ¥è¯´ï¼Œæˆ‘ä»¬åªæ˜¯æ‹“å±•äº†ä¸€ä¸ªè½´çš„æ£€æµ‹ï¼Œå¹¶ä¸”è¿™ä¸¤ä¸ªè½´çš„æ£€æµ‹åªè¦æœ‰ä¸€ä¸ªæˆç«‹ï¼Œå°±è¡¨ç¤ºä¸¤ä¸ªç‰©ä½“ä¸ç›¸äº¤ã€‚ æˆ‘ä»¬åœ¨åšå¹³é¢ AABB æ£€æµ‹çš„æ—¶å€™ä¼šå‡ºçŽ°ä¸‰ç§æƒ…å†µï¼Œå³ Bã€Cã€D ä¸‰ä¸ªç‰©ä½“å’Œ A ç‰©ä½“ä¹‹é—´çš„å…³ç³»ã€‚è¿™ä¸‰ç§æƒ…å†µåªè¦å‡ºçŽ°ä¸€ç§æˆç«‹å³å¯ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬åˆ¤æ–­ç‰©ä½“å…³ç³»çš„æ—¶å€™å°±åˆ¤æ–­ä¸æˆç«‹çš„æƒ…å†µï¼Œç”¨æˆ–æ¥è¿žæŽ¥ï¼Œå¯ä»¥å‡å°‘è®¡ç®—é‡ã€‚å¹¶ä¸”å½“æˆ‘ä»¬åˆ¤æ–­çš„æ—¶å€™å¯ä»¥ç›´æŽ¥ç”¨ä¸€ä¸ªç‰©ä½“çš„æœ€å¤§å€¼åŽ»æ¯”å¦ä¸€ä¸ªç‰©ä½“çš„æœ€å°å€¼ï¼Œç”¨æœ€å°å€¼åŽ»æ¯”æœ€å¤§å€¼ï¼Œè¿›ä¸€æ­¥å‡å°‘è®¡ç®—ã€‚ ä¸‰ç»´åœ¨ä¸‰ç»´ç©ºé—´ä¸­è¿›è¡Œ AABB æ£€æµ‹ä¸Žåœ¨äºŒç»´ç©ºé—´ä¸­æ£€æµ‹å¹¶æ— ä¸åŒï¼Œåªæ˜¯è¦æ£€æµ‹çš„è½´å†å¢žåŠ ä¸€ä¸ª Z è½´ã€‚ä¸‰ä¸ªè½´ä¹‹é—´çš„å…³ç³»ä¹Ÿæ˜¯æˆ–çš„å…³ç³»ã€‚ 1234567891011121314151617181920212223242526272829//åŒ…å›´ç›’æ•°æ®ç»“æž„using System.Collections;using System.Collections.Generic;using UnityEngine;public class CollisionData : MonoBehaviour&#123; public Vector3 max = Vector3.zero; public Vector3 min = Vector3.zero;&#125;---------------------------------------------/// &lt;summary&gt;/// AABBæ£€æµ‹/// &lt;param name=&quot;data1&quot;&gt;&lt;/param&gt;/// &lt;param name=&quot;data2&quot;&gt;&lt;/param&gt;/// &lt;/summary&gt;//AABBæ£€æµ‹private bool CollisionAABB(CollisionData data1,CollisionData data2)&#123; //åŒ…å›´ç›’1çš„æœ€å°å€¼æ¯”åŒ…å›´ç›’2çš„æœ€å¤§å€¼è¿˜å¤§ æˆ– åŒ…å›´ç›’1çš„æœ€å¤§å€¼æ¯”åŒ…å›´ç›’2çš„æœ€å°å€¼è¿˜å° åˆ™ä¸ç¢°æ’ž if (data1.max.x &lt; data2.min.x || data1.max.y &lt; data2.min.y || data1.max.z &lt; data2.min.z || data1.min.x &gt; data2.max.x || data1.min.y &gt; data2.max.y || data1.min.z &gt; data2.max.z) &#123; return false; &#125; else &#123; return true; &#125;&#125; å…¶ä»–AABB æ£€æµ‹åœ¨ç‰©ä½“æœ‰æ—‹è½¬çš„æƒ…å†µä¸‹ä¼šé€ æˆåŒ…å›´ç›’è¿‡å¤§ï¼Œå› æ­¤æ£€æµ‹çš„ç²¾åº¦ä¸æ˜¯å¾ˆé«˜ã€‚å…·ä½“æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ ç¢°æ’žæ£€æµ‹ç¤ºä¾‹å·¥ç¨‹","categories":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://busyogg.github.io/categories/%E7%AE%97%E6%B3%95/"},{"name":"ç¢°æ’žæ£€æµ‹","slug":"ç®—æ³•/ç¢°æ’žæ£€æµ‹","permalink":"https://busyogg.github.io/categories/%E7%AE%97%E6%B3%95/%E7%A2%B0%E6%92%9E%E6%A3%80%E6%B5%8B/"}],"tags":[{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://busyogg.github.io/tags/%E7%AE%97%E6%B3%95/"},{"name":"C#","slug":"C","permalink":"https://busyogg.github.io/tags/C/"},{"name":"ç¢°æ’žæ£€æµ‹","slug":"ç¢°æ’žæ£€æµ‹","permalink":"https://busyogg.github.io/tags/%E7%A2%B0%E6%92%9E%E6%A3%80%E6%B5%8B/"},{"name":"AABB","slug":"AABB","permalink":"https://busyogg.github.io/tags/AABB/"}]},{"title":"TSå®žçŽ°ECSæž¶æž„","slug":"TSå®žçŽ°ECSæž¶æž„","date":"2023-09-14T17:40:51.000Z","updated":"2024-05-18T15:37:27.180Z","comments":true,"path":"article/be8112f144cf/","link":"","permalink":"https://busyogg.github.io/article/be8112f144cf/","excerpt":"","text":"ç®€ä»‹ECS æž¶æž„æ˜¯ å®žä½“ï¼ˆEntityï¼‰-ç»„ä»¶ï¼ˆComponentï¼‰-ç³»ç»Ÿï¼ˆSystemï¼‰ ç»„æˆçš„æž¶æž„ï¼Œä¸»è¦ç›®çš„æ˜¯å¯¹æ•°æ®å’Œé€»è¾‘è¿›è¡Œè§£è€¦ä»¥ä¾¿æ›´å¥½çš„ç»´æŠ¤ç³»ç»Ÿã€‚å…¶è¿è¡Œçš„åŽŸç†ä¹Ÿèƒ½æé«˜ CPU çš„ç¼“å­˜å‘½ä¸­ï¼Œå³å¯ä»¥æé«˜æ¸¸æˆè¿è¡Œçš„æ€§èƒ½ã€‚ åŽŸç†æ¦‚è¿°ECS æž¶æž„ç®€å•æ¥è¯´å°±æ˜¯ç”¨å®žä½“æ¥ç»„åˆç»„ä»¶ï¼Œç”¨ç»„ä»¶æ¥ä¿å­˜æ•°æ®ï¼Œç”¨ç³»ç»Ÿæ¥è¿›è¡Œè¿ç®—ã€‚å•ä¸€çš„å®žä½“æ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼Œåªæœ‰åœ¨ç»„åˆç»„ä»¶ä¹‹åŽè¿™ä¸ªå®žä½“æ‰æœ‰æ„ä¹‰ã€‚ç»„ä»¶åªèƒ½ç”¨äºŽä¿å­˜æ•°æ®ï¼Œä¸èƒ½è‡ªå·±è¿›è¡Œä»»ä½•çš„è¿ç®—ã€‚ç³»ç»Ÿåªè´Ÿè´£è¿ç®—ï¼Œä¸ä¼šæŒä¹…åŒ–ä¿å­˜ä»»ä½•æ•°æ®ã€‚è¿™æ ·å°±æŠŠæ•°æ®å’Œé€»è¾‘åˆ†ç¦»å¼€æ¥ï¼Œé€šè¿‡ç»„åˆçš„æ–¹å¼å®žçŽ°ç‰¹å®šçš„åŠŸèƒ½ï¼Œå®žçŽ°æ•°æ®å’Œé€»è¾‘çš„è§£è€¦ï¼Œä»¥åŠé€»è¾‘ä¸Žé€»è¾‘ä¹‹é—´çš„è§£è€¦ã€‚ å¤§è‡´ç¤ºæ„å›¾å¦‚ä¸‹ ç»„ä»¶ç»„ä»¶æ˜¯ ECS æž¶æž„çš„åŸºç¡€ï¼Œå®žä½“éœ€è¦ç»„ä»¶ï¼Œç³»ç»Ÿä¹Ÿæ ¹æ®ç»„ä»¶å¤„ç†é€»è¾‘ã€‚ç»„ä»¶çš„è®¾è®¡å¾ˆç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦ä»¥ä¸‹åŸºç¡€å±žæ€§å’Œæ–¹æ³•ï¼š ç»„ä»¶ idï¼Œæ¯ä¸ªç»„ä»¶éƒ½æ‹¥æœ‰ä¸€ä¸ªå±žäºŽè‡ªå·±çš„ idï¼Œè¿™ä¸ª id æ˜¯å…¨å±€å”¯ä¸€çš„ã€‚ ç»„ä»¶åï¼Œæ¯ä¸ªç»„ä»¶éƒ½æ‹¥æœ‰ä¸€ä¸ªå±žäºŽè‡ªå·±çš„åå­—ï¼Œè¿™ä¸ªåå­—æ˜¯å…¨å±€å”¯ä¸€çš„ã€‚ å®žä½“ï¼Œä¿å­˜ç»„ä»¶æ‰€å±žçš„å…·ä½“å®žä½“ã€‚ æ˜¯å¦å¯ä»¥è¢«å›žæ”¶ï¼Œæœ‰äº›ç»„ä»¶åœ¨å®žä½“ç§»é™¤åŽéœ€è¦å›žæ”¶ï¼Œæœ‰äº›åˆ™ä¸ä»Žå®žä½“å›žæ”¶ã€‚ é‡ç½®æ–¹æ³•ï¼Œç”¨äºŽå›žæ”¶ç»„ä»¶ä¹‹åŽè¿›è¡Œç»„ä»¶çš„é‡ç½®ã€‚ å› æ­¤æˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªç»„ä»¶æŽ¥å£ï¼ŒæŽ¥å£ä¸å…³å¿ƒç»„ä»¶çš„å…·ä½“ä¿¡æ¯ï¼Œåªå…³å¿ƒç»„ä»¶æ˜¯å¦å¯ä»¥å›žæ”¶ã€ç»„ä»¶çš„æ‰€å±žä»¥åŠé‡ç½®æ–¹æ³•ã€‚ IComp1234567import Entity from &quot;../Entity&quot;;export default interface IComp &#123; canRecycle: boolean; entity: Entity; reset(): void;&#125; ç„¶åŽæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæŠ½è±¡ç»„ä»¶åŸºç±»ã€‚ Comp12345678910import Entity from &quot;./Entity&quot;;import IComp from &quot;./Interface/IComp&quot;;export abstract class Comp implements IComp &#123; static tid = -1; static compName: string; public canRecycle: boolean = true; public entity: Entity | null; abstract reset(): void;&#125; ç„¶åŽæˆ‘ä»¬å°±å¯ä»¥å®šä¹‰å®žé™…çš„ Comp ç±»æ¥ä¿å­˜æˆ‘ä»¬éœ€è¦çš„æ•°æ®ã€‚ ç»„ä»¶è¿˜æœ‰ä¸€ç§å½¢å¼æ˜¯æ ‡ç­¾ï¼Œæ ‡ç­¾ä¸ç»§æ‰¿æŠ½è±¡ç»„ä»¶åŸºç±»ï¼Œä½†æ˜¯åœ¨æ³¨å†Œçš„æ—¶å€™ä¹Ÿæ˜¯å’Œç»„ä»¶å…±äº«ä¸€å¥— id è‡ªå¢žè§„åˆ™ã€‚æ³¨æ„ï¼Œæ ‡ç­¾ç±»ä¸­çš„å±žæ€§è¦ä»»æ„èµ‹ä¸€ä¸ªå€¼ï¼Œè¿™æ ·æ‰èƒ½åœ¨æ³¨å†Œçš„æ—¶å€™èŽ·å–åˆ°è¿™ä¸ªå±žæ€§ã€‚ å®žä½“å®žä½“æ˜¯ç»„ä»¶çš„åˆé›†ï¼Œè™½ç„¶å®žä½“çš„æ¦‚å¿µå¾ˆç®€å•ï¼Œä½†æ˜¯å®žä½“çš„å®žçŽ°å´æ¯”è¾ƒå¤æ‚ã€‚å®žä½“éœ€è¦å®žçŽ°ç»„ä»¶çš„æ·»åŠ å’Œç§»é™¤ï¼Œä¹Ÿè¦åœ¨æ·»åŠ ç§»é™¤ç»„ä»¶çš„æ—¶å€™é€šçŸ¥å¯¹åº”ç³»ç»Ÿè¿›è¡Œå¤„ç†ï¼ŒåŒæ—¶å®žä½“ä¹Ÿè¦æä¾›ç»„ä»¶çš„æŸ¥è¯¢åŠŸèƒ½ã€‚å½“ç„¶ï¼Œå®žä½“è‡ªèº«ä¹Ÿè¦æä¾›ç§»é™¤çš„æ–¹æ³•ã€‚ æŽ©ç å·¥å…·ç”±äºŽå®žä½“éœ€è¦æŸ¥è¯¢ç»„ä»¶ï¼Œç³»ç»Ÿä¹Ÿéœ€è¦æŸ¥è¯¢ç»„ä»¶ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å…ˆè®¾è®¡å¯¹åº”çš„åŠŸèƒ½ã€‚æ­¤å¤„æˆ‘ä»¬é€‰æ‹©ç”¨äºŒè¿›åˆ¶æ•°æ¥åˆ¶ä½œæŽ©ç ç³»ç»Ÿä¿å­˜ç»„ä»¶ä¿¡æ¯ã€‚ è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªäºŒè¿›åˆ¶æ•°ç»„æ¥ä¿å­˜ï¼Œç”¨æ•°ç»„çš„ç›®çš„æ˜¯å¦‚æžœç»„ä»¶æ•°è¶…è¿‡äºŒè¿›åˆ¶æ•°å¤§å°ï¼Œå°±åœ¨æ•°ç»„å¢žåŠ ä¸€ä¸ªäºŒè¿›åˆ¶æ•°æ¥ä¿å­˜ã€‚åœ¨ 32 ä½äºŒè¿›åˆ¶æ•°ä¸­ï¼Œç”±äºŽä¸Žï¼ˆ&amp;ï¼‰æ“ä½œç¬¦æœ€å¤§åªèƒ½æ“ä½œ 30 ä½æ•°ï¼ˆä¸€ä½ç¬¦å·ä½ï¼Œä¸€ä½è¿›ä½ï¼‰ï¼Œå› æ­¤ä¸€ä¸ªæ•°åªä¿å­˜ 30 ä¸ªç»„ä»¶ã€‚ ç”±äºŽç»„ä»¶çš„æ•°é‡åœ¨æ¸¸æˆçš„æœ€å¼€å§‹å°±åˆå§‹åŒ–å®Œæˆï¼Œå› æ­¤ Mask å®žä¾‹çš„ç»„ä»¶æ€»æ•°æ˜¯å›ºå®šçš„ã€‚ å½“æˆ‘ä»¬è¿›è¡ŒæŽ©ç è¿ç®—æ—¶ï¼Œä¼ å…¥çš„ç»„ä»¶ id è½¬ä¸ºäºŒè¿›åˆ¶æ•°å’Œå½“å‰çš„æŽ©ç è¿›è¡Œæ¯”è¾ƒï¼Œä¾‹å¦‚æˆ‘ä»¬è®¾ç½®ç»„ä»¶æ—¶ï¼Œå‡è®¾å½“å‰æŽ©ç ä¸º 0000 0000 0000 0000 ï¼Œä¼ å…¥çš„ç»„ä»¶ id ä¸º 3ï¼Œåˆ™æˆ‘ä»¬æŠŠç»„ä»¶ id åŒ–ä¸º 1 &lt;&lt; (3 % 31)ï¼Œå³ 1 å·¦ç§» 3 ä½ï¼Œå¾—åˆ° 1000 ï¼Œ0000 0000 0000 0000 &amp; 1000 = 0000 0000 0000 1000ï¼Œæœ€ç»ˆçš„ç»„ä»¶å°±ä¿å­˜ä¸‹æ¥äº†ã€‚ ä¹Ÿå°±æ˜¯è¯´ 32 ä½æŽ©ç å°±æ˜¯æ’æ§½ï¼Œç»„ä»¶çš„ id å°±æ˜¯å¾€å“ªä¸ªæ’æ§½æ’å…¥ç»„ä»¶ï¼Œè¿™æ ·å°±èƒ½è¡¨ç¤ºä¿å­˜çš„ç»„ä»¶äº†ã€‚ Mask123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566import ECSManager from &quot;./ECSManager&quot;;export default class Mask &#123; /** 32ä½äºŒè¿›åˆ¶æ•°ç»„ ç”±äºŽ&amp;æ“ä½œç¬¦æœ€å¤§åªèƒ½30ä½æ“ä½œ æ•…æ¯ä¸ªä¸‰åäºŒä½äºŒè¿›åˆ¶ä¿å­˜30ä¸ªç»„ä»¶ */ private mask: Uint32Array; private size: number = 0; constructor() &#123; //è®¡ç®—32ä½æŽ©ç æ•°é‡ (æ€»ç»„ä»¶æ•°/31) let length = Math.ceil(ECSManager.getInst().getCompTid() / 31); this.mask = new Uint32Array(length); this.size = length; &#125; /** * è®¾ç½®æŽ©ç  æˆ– * @param num */ set(num: number) &#123; /// &gt;&gt;&gt; æ— ç¬¦å·ä½ç§» é«˜ä½è¡¥0 this.mask[(num / 31) &gt;&gt;&gt; 0] |= 1 &lt;&lt; num % 31; &#125; /** * ç§»é™¤æŽ©ç  ä¸Ž å–å * @param num */ delete(num: number) &#123; this.mask[(num / 31) &gt;&gt;&gt; 0] &amp;= ~(1 &lt;&lt; num % 31); &#125; /** * æŸ¥æ‰¾ ä¸Ž * @param num * @returns */ has(num: number) &#123; // !!å–å¸ƒå°”å€¼ 0æˆ–1 return !!(this.mask[(num / 31) &gt;&gt;&gt; 0] &amp; (1 &lt;&lt; num % 31)); &#125; or(other: Mask) &#123; for (let i = 0; i &lt; this.size; i++) &#123; // &amp;æ“ä½œç¬¦æœ€å¤§ä¹Ÿåªèƒ½å¯¹2^30è¿›è¡Œæ“ä½œï¼Œå¦‚æžœå¯¹2^31&amp;2^31ä¼šå¾—åˆ°è´Ÿæ•°ã€‚å½“ç„¶å¯ä»¥(2^31&amp;2^31) &gt;&gt;&gt; 0ï¼Œè¿™æ ·å¤šäº†ä¸€æ­¥å³ç§»æ“ä½œã€‚ if (this.mask[i] &amp; other.mask[i]) &#123; return true; &#125; &#125; return false; &#125; and(other: Mask) &#123; for (let i = 0; i &lt; this.size; i++) &#123; if ((this.mask[i] &amp; other.mask[i]) != this.mask[i]) &#123; return false; &#125; &#125; return true; &#125; clear() &#123; for (let i = 0; i &lt; this.size; i++) &#123; this.mask[i] = 0; &#125; &#125;&#125; ç­›é€‰å·¥å…·å› ä¸ºç³»ç»Ÿä»¥å®žä½“è¿›è¡ŒéåŽ†çš„ï¼Œæ‰€ä»¥æœ‰äº†æŽ©ç ä¹‹åŽï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯¹å®žä½“è¿›è¡Œç­›é€‰äº†ï¼Œé€šè¿‡æ¯”è¾ƒå®žä½“çš„ç»„ä»¶æŽ©ç å’Œç­›é€‰å·¥å…·çš„ç»„ä»¶æŽ©ç ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç­›é€‰å‡ºç³»ç»Ÿéœ€è¦çš„å®žä½“ã€‚ é¦–å…ˆæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªåŒ¹é…è§„åˆ™æŠ½è±¡åŸºç±»ï¼ŒåŸºç±»çš„æž„é€ å‡½æ•°æ ¹æ®ä¼ å…¥çš„ç»„ä»¶è®¾ç½®æŽ©ç ï¼Œå¹¶ä¸”æŒ‰é¡ºåºä¿å­˜ç»„ä»¶ idã€‚ ç„¶åŽæˆ‘ä»¬å®šä¹‰å„ä¸ªåŒ¹é…è§„åˆ™çš„ç±»ï¼Œåˆ¤æ–­æ˜¯å¦åŒ¹é…åªéœ€è¦è°ƒç”¨æŽ©ç å®šä¹‰çš„è§„åˆ™å³å¯ã€‚ æ‰€æœ‰è§„åˆ™ç±»1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586import &#123; CompTypeUnion &#125; from &quot;./ECSManager&quot;;import Entity from &quot;./Entity&quot;;import &#123; CompType &#125; from &quot;./Interface/CompType&quot;;import IComp from &quot;./Interface/IComp&quot;;import Mask from &quot;./Mask&quot;;export abstract class BaseOf &#123; protected mask = new Mask(); public indices: number[] = []; constructor(...args: CompTypeUnion&lt;IComp&gt;[]) &#123; let componentTypeId = -1; let len = args.length; for (let i = 0; i &lt; len; i++) &#123; if (typeof args[i] === &quot;number&quot;) &#123; componentTypeId = args[i] as number; &#125; else &#123; componentTypeId = (args[i] as CompType&lt;IComp&gt;).tid; &#125; if (componentTypeId == -1) &#123; console.error(&quot;å­˜åœ¨æ²¡æœ‰æ³¨å†Œçš„ç»„ä»¶ï¼&quot;); &#125; this.mask.set(componentTypeId); if (this.indices.indexOf(componentTypeId) &lt; 0) &#123; // åŽ»é‡ this.indices.push(componentTypeId); &#125; &#125; if (len &gt; 1) &#123; // å¯¹ç»„ä»¶ç±»åž‹idè¿›è¡ŒæŽ’åºï¼Œè¿™æ ·å…³æ³¨ç›¸åŒç»„ä»¶çš„ç³»ç»Ÿå°±èƒ½å…±ç”¨åŒä¸€ä¸ªgroup this.indices.sort((a, b) =&gt; &#123; return a - b; &#125;); &#125; &#125; public toString(): string &#123; return this.indices.join(&quot;-&quot;); // ç”Ÿæˆgroupçš„key &#125; public abstract getKey(): string; public abstract isMatch(entity: Entity): boolean;&#125;/** * ç”¨äºŽæè¿°åŒ…å«ä»»æ„ä¸€ä¸ªè¿™äº›ç»„ä»¶çš„å®žä½“ */export class AnyOf extends BaseOf &#123; public isMatch(entity: Entity): boolean &#123; // @ts-ignore return this.mask.or(entity.mask); &#125; getKey(): string &#123; return &quot;anyOf:&quot; + this.toString(); &#125;&#125;/** * ç”¨äºŽæè¿°åŒ…å«äº†â€œè¿™äº›â€ç»„ä»¶çš„å®žä½“ï¼Œè¿™ä¸ªå®žä½“é™¤äº†åŒ…å«è¿™äº›ç»„ä»¶è¿˜å¯ä»¥åŒ…å«å…¶ä»–ç»„ä»¶ */export class AllOf extends BaseOf &#123; public isMatch(entity: Entity): boolean &#123; // @ts-ignore return this.mask.and(entity.mask); &#125; getKey(): string &#123; return &quot;allOf:&quot; + this.toString(); &#125;&#125;/** * ä¸åŒ…å«æŒ‡å®šçš„ä»»æ„ä¸€ä¸ªç»„ä»¶ */export class ExcludeOf extends BaseOf &#123; public getKey(): string &#123; return &quot;excludeOf:&quot; + this.toString(); &#125; public isMatch(entity: Entity): boolean &#123; // @ts-ignore return !this.mask.or(entity.mask); &#125;&#125; ç„¶åŽæˆ‘ä»¬å®šä¹‰åŒ¹é…å™¨ï¼ŒåŒ¹é…å™¨å¯ä»¥åŒ…å«å¤æ•°è§„åˆ™ï¼Œå³åŒ¹é…å™¨æ˜¯è§„åˆ™çš„é›†åˆï¼Œæ˜¯æ‰€æœ‰åŒ¹é…çš„å®žé™…æ‰§è¡Œç±»ã€‚åŒ¹é…å™¨ä¹Ÿéœ€è¦ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ idï¼Œç»™åŽé¢çš„ Group ä½¿ç”¨ã€‚ IMatcher12345678import Entity from &quot;../Entity&quot;;export interface IMatcher &#123; mid: number; indices: number[]; key: string; isMatch(entity: Entity): boolean;&#125; Matcher123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110import ECSManager, &#123; CompTypeUnion &#125; from &quot;./ECSManager&quot;;import Entity from &quot;./Entity&quot;;import &#123; AllOf, AnyOf, BaseOf, ExcludeOf &#125; from &quot;./FilterRule&quot;;import IComp from &quot;./Interface/IComp&quot;;import &#123; IMatcher &#125; from &quot;./Interface/IMatcher&quot;;/** * ç­›é€‰è§„åˆ™é—´æ˜¯â€œä¸Žâ€çš„å…³ç³» * æ¯”å¦‚ï¼šecs.Macher.allOf(...).excludeOf(...)è¡¨è¾¾çš„æ˜¯allOf &amp;&amp; excludeOfï¼Œå³å®žä½“æœ‰â€œè¿™äº›ç»„ä»¶â€ å¹¶ä¸” â€œæ²¡æœ‰è¿™äº›ç»„ä»¶â€ */export class Matcher implements IMatcher &#123; protected rules: BaseOf[] = []; protected _indices: number[] | null = null; public mid: number = -1; private _key: string | null = null; public get key(): string &#123; if (!this._key) &#123; let s = &quot;&quot;; for (let i = 0; i &lt; this.rules.length; i++) &#123; s += this.rules[i].getKey(); if (i &lt; this.rules.length - 1) &#123; s += &quot; &amp;&amp; &quot;; &#125; &#125; this._key = s; &#125; return this._key; &#125; constructor() &#123; this.mid = ECSManager.getInst().getMatherId(); &#125; /** * åŒ¹é…å™¨å…³æ³¨çš„ç»„ä»¶ç´¢å¼•ã€‚åœ¨åˆ›å»ºGroupæ—¶ï¼ŒContextæ ¹æ®ç»„ä»¶idåŽ»ç»™Groupå…³è”ç»„ä»¶çš„æ·»åŠ å’Œç§»é™¤äº‹ä»¶ã€‚ */ public get indices() &#123; if (this._indices === null) &#123; this._indices = []; //åˆå¹¶æ•°ç»„ this.rules.forEach((rule) =&gt; &#123; Array.prototype.push.apply(this._indices, rule.indices); &#125;); &#125; return this._indices; &#125; /** * ç»„ä»¶é—´æ˜¯æˆ–çš„å…³ç³»ï¼Œè¡¨ç¤ºå…³æ³¨æ‹¥æœ‰ä»»æ„ä¸€ä¸ªè¿™äº›ç»„ä»¶çš„å®žä½“ã€‚ * @param args ç»„ä»¶ç´¢å¼• */ public anyOf(...args: CompTypeUnion&lt;IComp&gt;[]): Matcher &#123; this.rules.push(new AnyOf(...args)); return this; &#125; /** * ç»„ä»¶é—´æ˜¯ä¸Žçš„å…³ç³»ï¼Œè¡¨ç¤ºå…³æ³¨æ‹¥æœ‰æ‰€æœ‰è¿™äº›ç»„ä»¶çš„å®žä½“ã€‚ * @param args ç»„ä»¶ç´¢å¼• */ public allOf(...args: CompTypeUnion&lt;IComp&gt;[]): Matcher &#123; this.rules.push(new AllOf(...args)); return this; &#125; /** * è¡¨ç¤ºå…³æ³¨åªæ‹¥æœ‰è¿™äº›ç»„ä»¶çš„å®žä½“ * * æ³¨æ„ï¼š * ä¸æ˜¯ç‰¹æ®Šæƒ…å†µä¸å»ºè®®ä½¿ç”¨onlyOfã€‚å› ä¸ºonlyOfä¼šç›‘å¬æ‰€æœ‰ç»„ä»¶çš„æ·»åŠ å’Œåˆ é™¤äº‹ä»¶ã€‚ * @param args ç»„ä»¶ç´¢å¼• */ public onlyOf(...args: CompTypeUnion&lt;IComp&gt;[]): Matcher &#123; this.rules.push(new AllOf(...args)); let otherTids: CompTypeUnion&lt;IComp&gt;[] = []; for (let comp of ECSManager.getInst().getComps()) &#123; if (args.indexOf(comp) &lt; 0) &#123; otherTids.push(comp); &#125; &#125; this.rules.push(new ExcludeOf(...otherTids)); return this; &#125; /** * ä¸åŒ…å«æŒ‡å®šçš„ä»»æ„ä¸€ä¸ªç»„ä»¶ * @param args */ public excludeOf(...args: CompTypeUnion&lt;IComp&gt;[]) &#123; this.rules.push(new ExcludeOf(...args)); return this; &#125; public isMatch(entity: Entity): boolean &#123; for (let rule of this.rules) &#123; if (!rule.isMatch(entity)) &#123; return false; &#125; &#125; return true; &#125; public clone(): Matcher &#123; let newMatcher = new Matcher(); newMatcher.mid = ECSManager.getInst().getMatherId(); this.rules.forEach((rule) =&gt; newMatcher.rules.push(rule)); return newMatcher; &#125;&#125; å¤§è‡´çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤º å®žä½“ç±»çŽ°åœ¨æˆ‘ä»¬å¯ä»¥å®žçŽ°å®žä½“ç±»äº†ã€‚ å¤§æ¦‚çš„æ€è·¯å¦‚å›¾æ‰€ç¤º é¦–å…ˆæ˜¯ç»„ä»¶çš„å¢žåŠ ã€‚ æˆ‘ä»¬è®¾ç½®ä¸€ä¸ª Mapï¼ˆä¸‹æ–‡éƒ½å«å­—å…¸ï¼‰_compInEntity æ¥ä¿å­˜å½“å‰å®žä½“çš„ç»„ä»¶ï¼Œè®¾ç½®ä¸€ä¸ªå­—å…¸ _compRemoved ç”¨æ¥ä¿å­˜å·²ç»ç§»é™¤ä½†æ²¡æœ‰å›žæ”¶çš„ç»„ä»¶ã€‚ æ·»åŠ ç»„ä»¶çš„æ—¶å€™å…ˆåˆ¤æ–­æ˜¯ç»„ä»¶è¿˜æ˜¯æ ‡ç­¾ã€‚ æ ‡ç­¾çš„æƒ…å†µï¼Œåˆ¤æ–­æ ‡ç­¾æ˜¯å¦å·²ç»æ³¨å†Œï¼Œå·²æ³¨å†Œçš„æƒ…å†µä¸‹æŠŠæ ‡ç­¾æ·»åŠ åˆ°å®žä½“æŽ©ç ï¼Œå¹¶ä¸”æ·»åŠ åˆ°å·²ä¿å­˜çš„ç»„ä»¶å­—å…¸ä¸­å³å¯ã€‚ ç»„ä»¶çš„æƒ…å†µï¼Œåˆ¤æ–­ç»„ä»¶æ˜¯å¦å·²æ³¨å†Œï¼Œå·²æ³¨å†Œå¹¶ä¸”å·²å­˜åœ¨çš„æƒ…å†µä¸‹åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°æ·»åŠ ï¼Œéœ€è¦çš„è¯å°±ç§»é™¤å½“å‰çš„ç»„ä»¶ï¼Œç„¶åŽæŠŠç»„ä»¶æ·»åŠ åˆ°å®žä½“æŽ©ç ï¼Œå¹¶ä¸”æ·»åŠ åˆ°å·²ä¿å­˜çš„ç»„ä»¶å­—å…¸ä¸­ã€‚ æ·»åŠ å®Œæˆä¹‹åŽï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¹¿æ’­å¢žåˆ äº‹ä»¶ç»™ç³»ç»Ÿã€‚ ç„¶åŽæ˜¯ç»„ä»¶çš„ç§»é™¤ã€‚ ç»„ä»¶çš„ç§»é™¤å’Œæ·»åŠ ç±»ä¼¼ï¼Œä¹Ÿéœ€è¦åˆ†ä¸ºæ ‡ç­¾å’Œç»„ä»¶ä¸¤ä¸ªéƒ¨åˆ†ã€‚ æ ‡ç­¾çš„æƒ…å†µï¼Œåˆ¤æ–­æ ‡ç­¾æ˜¯å¦å­˜åœ¨ï¼Œæ˜¯çš„è¯æ ‡è®°å­˜åœ¨ï¼Œåˆ°æœ€åŽç»Ÿä¸€å¤„ç†ã€‚ ç»„ä»¶çš„æƒ…å†µï¼Œåˆ¤æ–­ç»„ä»¶æ˜¯å¦å­˜åœ¨ï¼Œæ˜¯çš„è¯æ ‡è®°å­˜åœ¨ï¼Œå–å‡ºå½“å‰ç»„ä»¶çš„å®žä¾‹ï¼Œè®¾ç½®å®žä¾‹çš„å®žä½“ä¸º nullï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦å›žæ”¶ï¼Œéœ€è¦å›žæ”¶çš„è¯æ‰§è¡Œç»„ä»¶åˆå§‹åŒ–æ“ä½œå¹¶å›žæ”¶ï¼Œä¸éœ€è¦çš„è¯å°±æŠŠç»„ä»¶æ”¾åˆ°ç§»é™¤åˆ—è¡¨ä¸­ã€‚ æœ€åŽæˆ‘ä»¬æ‰§è¡ŒæŽ©ç çš„ç§»é™¤å’Œç»„ä»¶å­˜åœ¨åˆ—è¡¨çš„ç§»é™¤ï¼Œå¹¶ä¸”å¹¿æ’­é€šçŸ¥ç³»ç»Ÿæ‰§è¡Œå¯¹åº”æ“ä½œã€‚ åœ¨ç»„ä»¶çš„æ·»åŠ å’Œç§»é™¤ä¸­ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥è®¾ç½®å®žä½“ç±»çš„å¯¹åº”åç§°å±žæ€§ä¸ºç»„ä»¶å®žä¾‹ï¼Œä»¥ä¾¿æ›´æ–¹ä¾¿åœ°è®¿é—®ç»„ä»¶ã€‚ æŽ¥ç€æ˜¯ç»„ä»¶çš„æŸ¥æ‰¾ã€‚ ç»„ä»¶çš„æŸ¥æ‰¾å¾ˆç®€å•ï¼Œå¯ä»¥ç”¨æŽ©ç ä¹Ÿå¯ä»¥ç”¨å­—å…¸ï¼Œæ ¹æ®è‡ªå·±çš„éœ€è¦å³å¯ã€‚ç»„ä»¶çš„èŽ·å–åŒç†ï¼Œå¯ä»¥ç”¨å­—å…¸ä¹Ÿå¯ä»¥ç”¨å±žæ€§ï¼Œè‡ªå·±å†³å®šå³å¯ã€‚ æœ€åŽæ˜¯å®žä½“çš„ç§»é™¤ã€‚ å®žä½“ç§»é™¤çš„æ—¶å€™è¦ç§»é™¤æ‰€æœ‰ç»„ä»¶ï¼ŒåŒ…æ‹¬å­˜åœ¨çš„å’Œç§»é™¤çš„åˆ—è¡¨ã€‚ç„¶åŽå®žä½“å¯ä»¥æ”¾å…¥å¯¹è±¡æ± ã€‚ Entity123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192import ECSManager, &#123; CompTypeUnion &#125; from &quot;./ECSManager&quot;;import &#123; CompType &#125; from &quot;./Interface/CompType&quot;;import IComp from &quot;./Interface/IComp&quot;;import Mask from &quot;./Mask&quot;;export default class Entity &#123; public eid: number = -1; private mask = new Mask(); /** * å½“å‰å®žä½“ä¸Šçš„ç»„ä»¶ */ private _compInEntity: Map&lt;number, CompTypeUnion&lt;IComp&gt;&gt; = new Map(); /** * ä¿å­˜åœ¨å®žä½“ä¸Šçš„å·²ç§»é™¤çš„ç»„ä»¶ */ private _compRemoved: Map&lt;number, CompTypeUnion&lt;IComp&gt;&gt; = new Map(); constructor() &#123;&#125; /** * æ·»åŠ ç»„ä»¶ * @param comp * @param isReAdded * @returns */ public add&lt;T extends IComp&gt;( comp: CompTypeUnion&lt;T&gt;, isReAdded = false ): T | null &#123; let compId; if (typeof comp == &quot;number&quot;) &#123; compId = comp; if (ECSManager.getInst().hasTag(comp)) &#123; this.mask.set(comp); this._compInEntity.set(comp, comp); let tagName = ECSManager.getInst().getTag(comp)!; // @ts-ignore this[tagName] = comp; ECSManager.getInst().broadcastCompAddOrRemove(this, comp); &#125; else &#123; console.error(&quot;ä¸å­˜åœ¨çš„tagï¼&quot;); &#125; return null; &#125; else &#123; compId = comp.tid; if (compId == -1) &#123; console.error(&quot;ç»„ä»¶æœªæ³¨å†Œ&quot;); return null; &#125; if (this._compInEntity.has(compId)) &#123; if (isReAdded) &#123; this.remove(comp); &#125; else &#123; console.log(&quot;ç»„ä»¶&quot; + comp.compName + &quot;å·²å­˜åœ¨&quot;); return this[comp.compName]; &#125; &#125; this.mask.set(compId); let compInstance: T; if (this._compRemoved.has(compId)) &#123; compInstance = this._compRemoved.get(compId) as unknown as T; this._compRemoved.delete(compId); &#125; else &#123; compInstance = ECSManager.getInst().createComp(comp); &#125; this[comp.compName] = compInstance; this._compInEntity.set(compId, comp); compInstance.entity = this; //TODO å¹¿æ’­æ·»åŠ ç»„ä»¶æ¶ˆæ¯ ECSManager.getInst().broadcastCompAddOrRemove(this, compId); return compInstance as T; &#125; &#125; /** * æ·»åŠ ç»„ä»¶ * @param comps * @returns */ public addComps(reAdded = false, ...comps) &#123; for (let comp of comps) &#123; this.add(comp, reAdded); &#125; return this; &#125; /** * èŽ·å¾—ç»„ä»¶ * @param comp * @returns */ public get&lt;T&gt;(comp: CompTypeUnion&lt;T&gt;) &#123; let compName; if (typeof comp == &quot;number&quot;) &#123; compName = ECSManager.getInst().getTag(comp); &#125; else &#123; compName = comp.compName; &#125; return this[compName] as T; &#125; /** * åˆ¤æ–­ç»„ä»¶æ˜¯å¦å­˜åœ¨ * @param comp * @returns */ public has&lt;T&gt;(comp: CompTypeUnion&lt;T&gt;) &#123; if (typeof comp == &quot;number&quot;) &#123; return this.mask.has(comp); &#125; else &#123; return this._compInEntity.has(comp.tid); &#125; &#125; private _remove(comp: CompTypeUnion&lt;IComp&gt;) &#123; //TODO gitä¸Šä¸ºfalse æ­¤å¤„æµ‹è¯•true this.remove(comp, true); &#125; /** * ç§»é™¤ç»„ä»¶ * @param comp ç»„ä»¶ * @param isRecycle æ˜¯å¦å›žæ”¶ */ public remove(comp: CompTypeUnion&lt;IComp&gt;, isRecycle: boolean = true) &#123; let compName: string; let id = -1; let hasComp = false; if (typeof comp == &quot;number&quot;) &#123; id = comp; if (this.mask.has(id)) &#123; hasComp = true; compName = ECSManager.getInst().getTag(id); &#125; else &#123; console.warn(&quot;è¯•å›¾ç§»é™¤ä¸å­˜åœ¨çš„tag&quot;); return; &#125; &#125; else &#123; id = comp.tid; compName = comp.compName; if (this.mask.has(id)) &#123; hasComp = true; let compInstance = this[compName] as CompType&lt;IComp&gt;; compInstance.entity = null; if (isRecycle) &#123; compInstance.reset(); if (compInstance.canRecycle) &#123; ECSManager.getInst().recycle(id, compInstance); &#125; &#125; else &#123; this._compRemoved.set(id, compInstance); &#125; &#125; else &#123; console.warn(&quot;è¯•å›¾ç§»é™¤ä¸å­˜åœ¨çš„ç»„ä»¶&quot;, compName); &#125; &#125; if (hasComp) &#123; this[compName] = null; this.mask.delete(id); this._compInEntity.delete(id); ECSManager.getInst().broadcastCompAddOrRemove(this, id); // console.log(&quot;å¹¿æ’­ç§»é™¤ç»„ä»¶&quot;, compName); &#125; &#125; /** * ç§»é™¤ç»„ä»¶ * @param isRecycle * @param args */ public removeComps(isRecycle = true, ...args: CompTypeUnion&lt;IComp&gt;[]) &#123; for (let c of args) &#123; this.remove(c, isRecycle); &#125; &#125; /** * ç§»é™¤å®žä½“ */ public removeSelf() &#123; this._compInEntity.forEach(this._remove, this); this._compRemoved.forEach(this._remove, this); ECSManager.getInst().removeEntity(this.eid, this); &#125;&#125; ç³»ç»Ÿç³»ç»Ÿæ ¹æ®æ‰€éœ€è¦çš„ç»„ä»¶æ¥ç­›é€‰å®žä½“ï¼Œæœ‰æ—¶å€™ä¸åŒç³»ç»Ÿéœ€è¦çš„ç»„ä»¶ç›¸åŒï¼Œå› æ­¤æˆ‘ä»¬ä½¿ç”¨ç»„ Group æ¥ç®¡ç†ç³»ç»Ÿã€‚ ç³»ç»Ÿçš„ç»“æž„å¦‚ä¸‹å›¾æ‰€ç¤º ç¾¤ç»„ç¾¤ç»„åŒ…å«ä¸€ä¸ªåŒ¹é…å™¨ï¼Œå¦‚å‰æ–‡æ‰€è¯´ï¼ŒåŒ¹é…å™¨çš„ id ä¹Ÿæ˜¯ç¾¤ç»„çš„ idã€‚ç¾¤ç»„åªå…³å¿ƒç»„ä»¶åŒ¹é…çš„å®žä½“ï¼Œæ“ä½œçš„å¯¹è±¡ä¹Ÿéƒ½æ˜¯å®žä½“ã€‚ æˆ‘ä»¬ä¿å­˜ä¸€ä¸ªåŒ¹é…å®žä½“å­—å…¸ï¼Œä»¥å®žä½“ id ä¸º keyï¼Œä»¥åŠä¸€ä¸ªç¼“å­˜å®žä½“æ•°ç»„ã€‚ç¼“å­˜å®žä½“æ•°ç»„æ˜¯ç³»ç»Ÿè¿è¡Œæ—¶éåŽ†çš„ï¼Œæ¯æ¬¡ç»„ä»¶å¹¿æ’­åŽåˆ é™¤ï¼Œä¸‹æ¬¡é‡æ–°ç¼“å­˜ã€‚ å¦å¤–ï¼Œæˆ‘ä»¬ä¿å­˜ä¸€ä¸ªè¿›å…¥å®žä½“åˆ—è¡¨å’Œä¸€ä¸ªç§»é™¤å®žä½“åˆ—è¡¨ï¼Œè¿™ä¸¤ä¸ªåˆ—è¡¨ä¿å­˜çš„æ˜¯ç³»ç»Ÿä¸­å¯¹åº”åˆ—è¡¨çš„å¼•ç”¨ï¼Œåœ¨ç¾¤ç»„é‡Œä¸“é—¨è´Ÿè´£ç›‘æŽ§ç»„ä»¶å˜åŒ–æ—¶å®žä½“çš„è¿›å…¥å’Œç§»é™¤æƒ…å†µã€‚ Group12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697import Entity from &quot;./Entity&quot;;import &#123; IMatcher &#125; from &quot;./Interface/IMatcher&quot;;export default class Group&lt;E extends Entity = Entity&gt; &#123; /** * å®žä½“ç­›é€‰è§„åˆ™ */ private matcher: IMatcher; private _matchEntities: Map&lt;number, E&gt; = new Map(); private _entitiesCache: E[] | null = null; /** * ç¬¦åˆè§„åˆ™çš„å®žä½“ */ public get matchEntities() &#123; if (this._entitiesCache === null) &#123; this._entitiesCache = Array.from(this._matchEntities.values()); &#125; return this._entitiesCache; &#125; /** * å½“å‰groupä¸­å®žä½“çš„æ•°é‡ã€‚ * * ä¸è¦æ‰‹åŠ¨ä¿®æ”¹è¿™ä¸ªå±žæ€§å€¼ã€‚ */ public count = 0; // å…¶å®žå¯ä»¥é€šè¿‡this._matchEntities.sizeèŽ·å¾—å®žä½“æ•°é‡ï¼Œä½†æ˜¯éœ€è¦å°è£…getæ–¹æ³•ã€‚ä¸ºäº†å‡å°‘ä¸€æ¬¡æ–¹æ³•çš„è°ƒç”¨æ‰€ä»¥æ‰ç›´æŽ¥åˆ›å»ºä¸€ä¸ªcountå±žæ€§ /** * èŽ·å–matchEntitiesä¸­ç¬¬ä¸€ä¸ªå®žä½“ */ get entity(): E &#123; return this.matchEntities[0]; &#125; private _enteredEntities: Map&lt;number, E&gt; | null = null; private _removedEntities: Map&lt;number, E&gt; | null = null; constructor(matcher: IMatcher) &#123; this.matcher = matcher; &#125; /** * ç»„ä»¶å˜åŒ–ç›‘å¬ * @param entity å®žä½“ */ public onComponentAddOrRemove(entity: E) &#123; if (this.matcher.isMatch(entity)) &#123; // Groupåªå…³å¿ƒæŒ‡å®šç»„ä»¶åœ¨å®žä½“èº«ä¸Šçš„æ·»åŠ å’Œåˆ é™¤åŠ¨ä½œã€‚ this._matchEntities.set(entity.eid, entity); this._entitiesCache = null; this.count++; if (this._enteredEntities) &#123; this._enteredEntities.set(entity.eid, entity); &#125; if (this._removedEntities) &#123; this._removedEntities.delete(entity.eid); &#125; &#125; else if (this._matchEntities.has(entity.eid)) &#123; // å¦‚æžœGroupä¸­æœ‰è¿™ä¸ªå®žä½“ï¼Œä½†æ˜¯è¿™ä¸ªå®žä½“å·²ç»ä¸æ»¡è¶³åŒ¹é…è§„åˆ™ï¼Œåˆ™ä»ŽGroupä¸­ç§»é™¤è¯¥å®žä½“ this._matchEntities.delete(entity.eid); this._entitiesCache = null; this.count--; if (this._enteredEntities) &#123; this._enteredEntities.delete(entity.eid); &#125; if (this._removedEntities) &#123; this._removedEntities.set(entity.eid, entity); &#125; &#125; &#125; /** * ç›‘æŽ§è¿›å…¥/ç§»é™¤æ•°ç»„ * @param enteredEntities * @param removedEntities */ public watchEntityEnterAndRemove( enteredEntities: Map&lt;number, E&gt;, removedEntities: Map&lt;number, E&gt; ) &#123; this._enteredEntities = enteredEntities; this._removedEntities = removedEntities; &#125; clear() &#123; this._matchEntities.clear(); this._entitiesCache = null; this.count = 0; this._enteredEntities?.clear(); this._removedEntities?.clear(); &#125;&#125; ç³»ç»Ÿå®žçŽ°ç³»ç»Ÿå®žçŽ°åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªéƒ¨åˆ†æ˜¯ç³»ç»Ÿçš„å…·ä½“å®žçŽ°ï¼Œè¿˜æœ‰ä¸€ä¸ªéƒ¨åˆ†æ˜¯æ ¹ç³»ç»Ÿã€‚ ç³»ç»Ÿçš„å…·ä½“å®žçŽ°æ ¸å¿ƒç›®æ ‡æ˜¯å®žçŽ°å®žä½“è¿›å…¥æ—¶çš„é€»è¾‘å¤„ç†ï¼Œæ¯å¸§é€»è¾‘å¤„ç†å’Œå®žä½“ç§»é™¤æ—¶çš„é€»è¾‘å¤„ç†ã€‚å› æ­¤æˆ‘ä»¬å®šä¹‰å¦‚ä¸‹æŽ¥å£ ISystem12345678910111213141516171819202122232425import Entity from &quot;../Entity&quot;;/** * å¦‚æžœéœ€è¦ç›‘å¬å®žä½“é¦–æ¬¡è¿›å…¥Systemçš„æƒ…å†µï¼Œå®žçŽ°è¿™ä¸ªæŽ¥å£ã€‚ * * entityEnterä¼šåœ¨updateæ–¹æ³•ä¹‹å‰æ‰§è¡Œï¼Œå®žä½“è¿›å…¥åŽï¼Œä¸ä¼šå†æ¬¡è¿›å…¥entityEnteræ–¹æ³•ä¸­ã€‚ * å½“å®žä½“ä»Žå½“å‰Systemç§»é™¤ï¼Œä¸‹æ¬¡å†æ¬¡ç¬¦åˆæ¡ä»¶è¿›å…¥Systemä¹Ÿä¼šæ‰§è¡Œä¸Šè¿°æµç¨‹ã€‚ */export interface IEntityEnterSystem&lt;E extends Entity = Entity&gt; &#123; entityEnter(entities: E[]): void;&#125;/** * å¦‚æžœéœ€è¦ç›‘å¬å®žä½“ä»Žå½“å‰Systemç§»é™¤ï¼Œéœ€è¦å®žçŽ°è¿™ä¸ªæŽ¥å£ã€‚ */export interface IEntityRemoveSystem&lt;E extends Entity = Entity&gt; &#123; entityRemove(entities: E[]): void;&#125;/** * ç¬¬ä¸€æ¬¡æ‰§è¡Œupdate */export interface ISystemFirstUpdate&lt;E extends Entity = Entity&gt; &#123; firstUpdate(entities: E[]): void;&#125; æˆ‘ä»¬åœ¨ç³»ç»Ÿå®žçŽ°ç±»çš„æž„é€ å‡½æ•°ä¸­åˆ¤æ–­æ˜¯å¦æœ‰æˆ‘ä»¬éœ€è¦å®žçŽ°çš„æ–¹æ³•ï¼Œåˆ†ä¸ºä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š æœ‰é¦–æ¬¡è¿›å…¥&#x2F;ç§»é™¤çš„é€»è¾‘å‡½æ•°execute1ã€‚è¿™æ—¶å€™æˆ‘ä»¬è¦åˆå§‹åŒ–å®žä½“è¿›å…¥&#x2F;ç§»é™¤çš„æ•°ç»„ï¼Œå¹¶ä¸”åœ¨ç»„é‡Œç›‘å¬è¿™ä¸¤ä¸ªæ•°ç»„çš„å®žä½“å˜åŒ–ã€‚ä¹‹åŽè®¾ç½®æ‰§è¡Œå‡½æ•°ä¸ºexecute1ã€‚ æ²¡æœ‰ä¸Šè¿°é€»è¾‘ï¼Œç›´æŽ¥è®¾ç½®æ‰§è¡Œå‡½æ•°ä¸ºæ¯å¸§æ›´æ–°çš„é€»è¾‘å‡½æ•°execute0ã€‚ å¦‚æžœæœ‰ç¬¬ä¸€æ¬¡æ‰§è¡Œ update çš„å‡½æ•°updateOnceçš„è¯ï¼Œå°±ä¿å­˜å½“å‰è®¾ç½®çš„æ‰§è¡Œå‡½æ•°ï¼Œå¹¶ä¸”è®¾æ‰§è¡Œå‡½æ•°ä¸ºupdateOnceã€‚ åœ¨execute1ã€execute0ã€updateOnceæ‰§è¡Œä¹‹åŽï¼Œæˆ‘ä»¬éƒ½è¦ç½®å®žä½“è¿›å…¥&#x2F;ç§»é™¤çš„æ•°ç»„ä¸ºç©ºï¼Œé˜²æ­¢ä¸‹æ¬¡æ‰§è¡Œæ—¶é‡å¤å¯¹å·²æ‰§è¡Œå®žä½“å†æ¬¡æ‰§è¡Œå¯¹åº”é€»è¾‘ã€‚ å¦‚æžœè¿˜æœ‰å…¶ä»–éœ€æ±‚ï¼Œä¹Ÿå¯ä»¥è‡ªè¡Œå®šä¹‰å¯¹åº”çš„æŽ¥å£å’Œå…·ä½“çš„å¤„ç†é€»è¾‘ã€‚ ComblockSystem123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133import ECSManager from &quot;./ECSManager&quot;;import Entity from &quot;./Entity&quot;;import Group from &quot;./Group&quot;;import &#123; IMatcher &#125; from &quot;./Interface/IMatcher&quot;;import &#123; IEntityEnterSystem, ISystemFirstUpdate, IEntityRemoveSystem,&#125; from &quot;./Interface/ISystem&quot;;export abstract class ComblockSystem&lt;E extends Entity = Entity&gt; &#123; protected _group: Group&lt;E&gt;; protected _dt: number = 0; private _enteredEntities: Map&lt;number, E&gt; | null = null; private _removedEntities: Map&lt;number, E&gt; | null = null; private _hasEntityEnter: boolean = false; private _hasEntityRemove: boolean = false; private _tmpExecute: ((dt: number) =&gt; void) | null = null; private execute!: (dt: number) =&gt; void; constructor() &#123; let hasOwnProperty = Object.hasOwnProperty; let prototype = Object.getPrototypeOf(this); let hasEntityEnter = hasOwnProperty.call(prototype, &quot;entityEnter&quot;); let hasEntityRemove = hasOwnProperty.call(prototype, &quot;entityRemove&quot;); let hasFirstUpdate = hasOwnProperty.call(prototype, &quot;firstUpdate&quot;); this._hasEntityEnter = hasEntityEnter; this._hasEntityRemove = hasEntityRemove; if (hasEntityEnter || hasEntityRemove) &#123; this._enteredEntities = new Map&lt;number, E&gt;(); this._removedEntities = new Map&lt;number, E&gt;(); this.execute = this.execute1; this._group = ECSManager.getInst().createGroup(this.filter()); this._group.watchEntityEnterAndRemove( this._enteredEntities, this._removedEntities ); &#125; else &#123; this.execute = this.execute0; this._group = ECSManager.getInst().createGroup(this.filter()); &#125; if (hasFirstUpdate) &#123; this._tmpExecute = this.execute; this.execute = this.updateOnce; &#125; &#125; init(): void &#123;&#125; onDestroy(): void &#123;&#125; hasEntity(): boolean &#123; return this._group.count &gt; 0; &#125; private updateOnce(dt: number) &#123; if (this._group.count === 0) &#123; return; &#125; this._dt = dt; // å¤„ç†åˆšè¿›æ¥çš„å®žä½“ if (this._enteredEntities &amp;&amp; this._enteredEntities.size &gt; 0) &#123; (this as unknown as IEntityEnterSystem).entityEnter( Array.from(this._enteredEntities.values()) as E[] ); this._enteredEntities.clear(); &#125; (this as unknown as ISystemFirstUpdate).firstUpdate( this._group.matchEntities ); this.execute = this._tmpExecute!; this.execute(dt); this._tmpExecute = null; &#125; /** * åªæ‰§è¡Œupdate * @param dt * @returns */ private execute0(dt: number): void &#123; if (this._group.count === 0) &#123; return; &#125; this._dt = dt; this.update(this._group.matchEntities); &#125; /** * å…ˆæ‰§è¡ŒentityRemoveï¼Œå†æ‰§è¡ŒentityEnterï¼Œæœ€åŽæ‰§è¡Œupdateã€‚ * @param dt * @returns */ private execute1(dt: number): void &#123; if (this._removedEntities &amp;&amp; this._removedEntities.size &gt; 0) &#123; if (this._hasEntityRemove) &#123; (this as unknown as IEntityRemoveSystem).entityRemove( Array.from(this._removedEntities.values()) as E[] ); &#125; this._removedEntities.clear(); &#125; if (this._group.count === 0) &#123; return; &#125; this._dt = dt; // å¤„ç†åˆšè¿›æ¥çš„å®žä½“ if (this._enteredEntities &amp;&amp; this._enteredEntities.size &gt; 0) &#123; if (this._hasEntityEnter) &#123; (this as unknown as IEntityEnterSystem).entityEnter( Array.from(this._enteredEntities.values()) as E[] ); &#125; this._enteredEntities.clear(); &#125; this.update(this._group.matchEntities as E[]); &#125; /** * å®žä½“è¿‡æ»¤è§„åˆ™ * * æ ¹æ®æä¾›çš„ç»„ä»¶è¿‡æ»¤å®žä½“ã€‚ */ abstract filter(): IMatcher; abstract update(entities: E[]): void;&#125; å½“ç„¶ï¼ŒåŒç±»åž‹çš„ç³»ç»Ÿæˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨ç³»ç»Ÿç»„åˆå™¨æ¥ç»„åˆä½¿ç”¨ã€‚ System123456789101112131415161718192021222324import &#123; ComblockSystem &#125; from &quot;./ComBlockSystem&quot;;/** * ç³»ç»Ÿç»„åˆå™¨ï¼Œç”¨äºŽå°†å¤šä¸ªç›¸åŒåŠŸèƒ½æ¨¡å—çš„ç³»ç»Ÿé€»è¾‘ä¸Šæ”¾åœ¨ä¸€èµ·ã€‚Systemä¹Ÿå¯ä»¥åµŒå¥—Systemã€‚ */export class System &#123; private _comblockSystems: ComblockSystem[] = []; get comblockSystems() &#123; return this._comblockSystems; &#125; add(system: System | ComblockSystem) &#123; if (system instanceof System) &#123; Array.prototype.push.apply( this._comblockSystems, system._comblockSystems ); system._comblockSystems.length = 0; &#125; else &#123; this._comblockSystems.push(system as ComblockSystem); &#125; return this; &#125;&#125; æ‰€æœ‰çš„ç³»ç»Ÿå®žçŽ°ï¼Œæœ€åŽæˆ‘ä»¬éƒ½è¦ç”¨æ ¹ç³»ç»Ÿæ¥ä½¿ç”¨ã€‚ æ ¹ç³»ç»Ÿç”Ÿå‘½å‘¨æœŸæä¾›ä¸€ä¸ª init æ–¹æ³•ï¼Œæ¥éåŽ†æ‰€æœ‰ç³»ç»Ÿå¹¶ä¸”è°ƒç”¨å¯¹åº”ç³»ç»Ÿçš„åˆå§‹åŒ–ï¼›æä¾›ä¸€ä¸ª execute æ–¹æ³•æ¥éåŽ†æ‰€æœ‰ç³»ç»Ÿï¼Œæ‰§è¡Œæ¯å¸§æ›´æ–°çš„å†…å®¹ï¼›æä¾›ä¸€ä¸ª clear æ–¹æ³•æ¥éåŽ†æ‰€æœ‰ç³»ç»Ÿï¼Œè°ƒç”¨ç³»ç»Ÿé”€æ¯æ—¶çš„ onDestroy æ–¹æ³•ã€‚ ç„¶åŽå°±æ˜¯ add æ–¹æ³•ï¼Œä¼ å…¥ç³»ç»Ÿç»„åˆå™¨æ—¶æˆ‘ä»¬ä¼šå¹³é“ºå…¶çš„æ‰€æœ‰ç³»ç»Ÿå¹¶åŠ å…¥æ•°ç»„ï¼›ä¼ å…¥ç³»ç»Ÿæ—¶ç›´æŽ¥åŠ å…¥æ•°ç»„ã€‚ æ‰€æœ‰çš„æ–¹æ³•åœ¨æˆ‘ä»¬è‡ªå®šä¹‰æ ¹ç³»ç»Ÿçš„æ—¶å€™éƒ½ä¸éœ€è¦ä¿®æ”¹ï¼Œåªéœ€è¦åœ¨æž„é€ å‡½æ•°ä¸­ add æ–°çš„ç³»ç»Ÿå³å¯ã€‚ RootSystem1234567891011121314151617181920212223242526272829303132333435363738394041import &#123; ComblockSystem &#125; from &quot;./ComBlockSystem&quot;;import &#123; System &#125; from &quot;./System&quot;;/** * Systemçš„rootï¼Œå¯¹æ¸¸æˆä¸­çš„SysteméåŽ†ä»Žè¿™é‡Œå¼€å§‹ã€‚ * * ä¸€ä¸ªSystemç»„åˆä¸­åªèƒ½æœ‰ä¸€ä¸ªRootSystemï¼Œå¯ä»¥æœ‰å¤šä¸ªå¹¶è¡Œçš„RootSystemã€‚ */export class RootSystem &#123; private executeSystemFlows: ComblockSystem[] = []; private systemCnt: number = 0; add(system: System | ComblockSystem) &#123; if (system instanceof System) &#123; // å°†åµŒå¥—çš„Systeméƒ½â€œæ‘Šå¹³â€ï¼Œæ”¾åœ¨æ ¹Systemä¸­è¿›è¡ŒéåŽ†ï¼Œå‡å°‘executeçš„é¢‘ç¹è¿›å…¥é€€å‡ºã€‚ Array.prototype.push.apply( this.executeSystemFlows, system.comblockSystems ); &#125; else &#123; this.executeSystemFlows.push(system as ComblockSystem); &#125; this.systemCnt = this.executeSystemFlows.length; return this; &#125; init() &#123; this.executeSystemFlows.forEach((sys) =&gt; sys.init()); &#125; execute(dt: number) &#123; for (let i = 0; i &lt; this.systemCnt; i++) &#123; // @ts-ignore this.executeSystemFlows[i].execute(dt); &#125; &#125; clear() &#123; this.executeSystemFlows.forEach((sys) =&gt; sys.onDestroy()); &#125;&#125; ç®¡ç†å™¨ECS çš„åŸºæœ¬æ¡†æž¶æ­å»ºå¥½åŽï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªç®¡ç†å™¨æ¥ç®¡ç† ECS æ¡†æž¶çš„ä¸€äº›æ“ä½œã€‚ä¸‹é¢æ˜¯æœ¬é¡¹ç›®çš„åˆ†ç±»ï¼Œä¹Ÿå¯ä»¥æ ¹æ®éœ€æ±‚è‡ªå·±è®¾è®¡ã€‚ ECS ç®¡ç†å™¨çš„æ ¸å¿ƒåŠŸèƒ½ç®€å•æ¦‚æ‹¬å¦‚ä¸‹å›¾æ‰€ç¤º ç»„ä»¶æ³¨å†Œæˆ‘ä»¬åœ¨ä½¿ç”¨ç»„ä»¶ä¹‹å‰ï¼Œéƒ½è¦å¯¹ç»„ä»¶è¿›è¡Œæ³¨å†Œã€‚ç”±ä¸Šæ–‡æˆ‘ä»¬çŸ¥é“ç»„ä»¶æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯ç»„ä»¶ï¼Œä¸€ç§æ˜¯æ ‡ç­¾ï¼Œå› æ­¤æ³¨å†Œä¹Ÿæ˜¯åˆ†ä¸¤ç§æƒ…å†µè¿›è¡Œã€‚ é¦–å…ˆæˆ‘ä»¬å®šä¹‰ç»„ä»¶ id_compTidæ¥è®°å½•ç»„ä»¶ idï¼Œå®šä¹‰æ³¨å†Œæ± _registerPoolæ¥åˆ¤æ–­æ˜¯å¦å­˜åœ¨åŒåç»„ä»¶æˆ–æ ‡ç­¾ï¼Œå®šä¹‰ç»„ä»¶æ± _compsä¿å­˜ç»„ä»¶ç±»ï¼Œå®šä¹‰ç»„ä»¶ç¼“å­˜æ± _compPoolsæ¥ä¿å­˜ç»„ä»¶å¯¹è±¡ï¼Œå®šä¹‰ tag æ± _tagsæ¥ä¿å­˜æ ‡ç­¾åï¼Œå®šä¹‰ç»„ä»¶å˜åŒ–æ± _compAddOrRemoveæ¥ä¿å­˜å˜åŒ–çš„ç»„ä»¶ã€‚ ç»„ä»¶çš„æ³¨å†Œç”¨è£…é¥°å™¨è¿›è¡Œï¼Œæˆ‘ä»¬å®šä¹‰ä¸¤ä¸ªç±»è£…é¥°å™¨å‡½æ•°ã€‚ æ³¨å†Œç»„ä»¶ï¼šä¼ å…¥ä¸€ä¸ªç»„ä»¶åï¼Œè¿˜æœ‰ä¸€ä¸ªå¯é€‰å˜é‡ canNew è¡¨ç¤ºæ˜¯å¦å¯ä»¥å®žä¾‹åŒ–ï¼Œä¸€èˆ¬æˆ‘ä»¬é»˜è®¤ trueï¼Œç„¶åŽæˆ‘ä»¬åˆ¤æ–­æ³¨å†Œçš„ç»„ä»¶æ˜¯å¦é‡å¤ï¼Œæ²¡é‡å¤çš„è¯ç»™å½“å‰ç»„ä»¶å‘½åï¼Œç»„ä»¶ id èµ‹å€¼åŽè‡ªå¢žï¼Œå¯ä»¥å®žä¾‹åŒ–ç»„ä»¶çš„è¯å°±æŠŠç»„ä»¶å­˜å…¥ç»„ä»¶æ± ï¼Œå¹¶å¼€è¾Ÿä¸€ä¸ªå½“å‰ç»„ä»¶çš„ç¼“å­˜æ± æ•°ç»„ä»¥åŠç»„ä»¶å˜åŒ–æ± æ•°ç»„ã€‚æœ€åŽåœ¨æ³¨å†Œæ± é‡Œæ ‡è®°ä¸ºå·²æ³¨å†Œã€‚ æ³¨å†Œç»„ä»¶12345678910111213141516171819202122232425262728293031/** * æ³¨å†Œç»„ä»¶ * @param compName * @param canNew * @returns */public register&lt;T&gt;(compName: string, canNew: boolean = true) &#123; return function (comp: CompType&lt;T&gt;) &#123; if (comp.tid == -1) &#123; let manager = ECSManager.getInst(); if (manager._registerPool[compName]) &#123; console.warn(&quot;ç»„ä»¶ä¸Žæ ‡ç­¾é‡å:&quot;, compName); &#125; else &#123; comp.tid = manager._compTid++; comp.compName = compName; if (canNew) &#123; manager._comps.push(comp); manager._compPools.set(comp.tid, []); &#125; else &#123; manager._comps.push(null); &#125; manager._compAddOrRemove.set(comp.tid, []); console.log(&quot;ç»„ä»¶&quot; + compName + &quot;æ³¨å†ŒæˆåŠŸ:&quot;, comp.tid) manager._registerPool[compName] = true; &#125; &#125; else &#123; console.log(&quot;ç»„ä»¶å·²æ³¨å†Œ&quot;); &#125; &#125;&#125; æ³¨å†Œæ ‡ç­¾ï¼šæ³¨å†Œæ ‡ç­¾æˆ‘ä»¬ä¸ä¼ å…¥ä»»ä½•å‚æ•°ï¼Œæˆ‘ä»¬åªéœ€è¦éåŽ†æ ‡ç­¾ç±»çš„æ‰€æœ‰å±žæ€§ï¼Œåˆ¤æ–­æ˜¯å¦å·²æ³¨å†Œï¼Œæœªæ³¨å†Œçš„æƒ…å†µæˆ‘ä»¬ç»™æ ‡ç­¾ id èµ‹å€¼å¹¶è‡ªå¢žï¼Œç„¶åŽå’Œç»„ä»¶ä¸€æ ·æ”¾å…¥ç»„ä»¶æ± å¹¶å¼€è¾Ÿç»„ä»¶ç¼“å­˜æ± ã€‚æ ‡ç­¾è¦é¢å¤–æ”¾åˆ°æ ‡ç­¾æ± ä»¥æ–¹ä¾¿æ ‡ç­¾çš„æ“ä½œã€‚æœ€åŽä¹Ÿè¦åœ¨æ³¨å†Œæ± é‡Œæ ‡æ³¨ä¸ºå·²æ³¨å†Œã€‚ æ³¨å†Œtag123456789101112131415161718192021222324/** * æ³¨å†Œtag * @returns */public registerTag() &#123; return function (_class: any) &#123; let manager = ECSManager.getInst(); let tid = manager._compTid; for (let k in _class) &#123; if (manager._registerPool[k]) &#123; console.warn(&quot;æ ‡ç­¾ä¸Žç»„ä»¶é‡å:&quot;, k); &#125; else &#123; tid = manager._compTid++; _class[k] = tid; manager._comps.push(tid); manager._compPools.set(tid, []); manager._compAddOrRemove.set(tid, []); manager._tags.set(tid, k); console.log(&quot;æ ‡ç­¾&quot; + k + &quot;æ³¨å†ŒæˆåŠŸ:&quot;, tid) manager._registerPool[k] = true; &#125; &#125; &#125;&#125; ç»„ä»¶åŠŸèƒ½ç»„ä»¶çš„åŠŸèƒ½å¾ˆç®€å•ï¼Œåªæ˜¯è¿ç”¨äº†å¯¹è±¡æ± çš„æ¦‚å¿µã€‚ ç»„ä»¶åŠŸèƒ½12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455//-----tag-----/** * æ˜¯å¦æœ‰tag * @param id * @returns */public hasTag(id: number) &#123; return this._tags.has(id);&#125;/** * èŽ·å¾—tag * @param id * @returns */public getTag(id: number): string &#123; return this._tags.get(id) as string;&#125;//-----tag-----//-----ç»„ä»¶-----/** * å›žæ”¶ç»„ä»¶ * @param id ç»„ä»¶id * @param comp ç»„ä»¶å®žä¾‹ */public recycle(id: number, comp: IComp) &#123; this._compPools.get(id)?.push(comp);&#125;/** * åˆ›å»ºç»„ä»¶ * @param comp * @returns */public createComp&lt;T&gt;(comp: CompType&lt;T&gt;) &#123; if (!this._comps[comp.tid]) &#123; console.error(&quot;æœªæ‰¾åˆ°ç»„ä»¶&quot; + comp.compName) &#125; let compInstance = this._compPools.get(comp.tid)?.pop() || new this._comps[comp.tid]; return compInstance;&#125;/** * èŽ·å¾—æ‰€æœ‰ç»„ä»¶ * @returns */public getComps() &#123; return this._comps;&#125;//-----ç»„ä»¶----- å®žä½“åŠŸèƒ½å®žä½“çš„åŠŸèƒ½ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå®žä½“æ± _eid2Entityç”¨äºŽä¿å­˜å½“å‰æ‰€æœ‰çš„å®žä½“å®žä¾‹ï¼Œå®šä¹‰ä¸€ä¸ªå®žä½“ç¼“å­˜æ± _eneityPoolç”¨æ¥å½“å®žä½“çš„å¯¹è±¡æ± ã€‚ å®žä½“åŠŸèƒ½1234567891011121314151617181920212223242526272829303132333435363738394041424344/** * åˆ›å»ºå®žä½“ * @returns */public createEntity&lt;E extends Entity = Entity&gt;(): E &#123; let entity = this._eneityPool.pop(); if (!entity) &#123; entity = new Entity(); entity.eid = this._entityId++; &#125; this._eid2Entity.set(entity.eid, entity); return entity as E;&#125;/** * ç§»é™¤å®žä½“ * @param id å®žä½“id * @param entity å®žä½“ */public removeEntity(id: number, entity: Entity) &#123; if (this._eid2Entity.has(id)) &#123; this._eneityPool.push(entity); this._eid2Entity.delete(id); &#125; else &#123; console.warn(&quot;è¯•å›¾é”€æ¯ä¸å­˜åœ¨çš„å®žä½“&quot;); &#125;&#125;/** * æ ¹æ®eidèŽ·å–å®žä½“ * @param eid * @returns */public getEntityByEid(eid: number) &#123; return this._eid2Entity.get(eid);&#125;/** * èŽ·å¾—å½“å‰æ´»åŠ¨å®žä½“æ•°é‡ * @returns */public activeEntityCount() &#123; return this._eid2Entity.size;&#125; ç³»ç»ŸåŠŸèƒ½ç³»ç»ŸåŠŸèƒ½åŒ…æ‹¬ç¾¤ç»„åŠŸèƒ½ï¼Œè¿‡æ»¤åŠŸèƒ½å’Œç»„ä»¶å˜åŒ–çš„é€šçŸ¥åŠæ¸…é™¤åŠŸèƒ½ã€‚ ç»„ä»¶å˜åŒ–çš„ç›‘å¬æ˜¯åœ¨åˆ›å»ºç¾¤ç»„çš„æ—¶å€™å°±ç»‘å®šå¥½çš„ã€‚é€šè¿‡èŽ·å–å¯¹åº”ç»„ä»¶ id çš„ç»„ä»¶å˜åŒ–æ•°ç»„ï¼Œå­˜å…¥ç¾¤ç»„çš„ç›‘å¬å‡½æ•°ï¼Œå°±å¯ä»¥åœ¨æ¯æ¬¡ç»„ä»¶å˜åŒ–çš„æ—¶å€™é€šçŸ¥æ‰€æœ‰ç›‘å¬è¯¥ç»„ä»¶çš„ç¾¤ç»„æ‰§è¡Œå¯¹åº”çš„å‡½æ•°ã€‚ å…¶ä»–åŠŸèƒ½å°±æ˜¯å¯¹ä¸Šæ–‡çŽ°æœ‰åŠŸèƒ½çš„å†åŒ…è£…ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109//-----ç¾¤ç»„-----/** * åˆ›å»ºç¾¤ç»„ * @param matcher */public createGroup&lt;E extends Entity = Entity&gt;(matcher: IMatcher): Group&lt;E&gt; &#123; let group = this._groups.get(matcher.mid); if (!group) &#123; group = new Group(matcher); this._groups.set(matcher.mid, group); let careCompIds = matcher.indices; for (let i = 0, len = careCompIds.length; i &lt; len; i++) &#123; let child = this._compAddOrRemove.get(careCompIds[i]); if (!child) &#123; child = []; this._compAddOrRemove.set(careCompIds[i], child); &#125; child.push(group.onComponentAddOrRemove.bind(group)); &#125; &#125; return group as unknown as Group&lt;E&gt;;&#125;public query(matcher: IMatcher) &#123; let group = this._groups.get(matcher.mid); if (!group) &#123; group = this.createGroup(matcher); this._eid2Entity.forEach(group.onComponentAddOrRemove, group); &#125; return group.matchEntities;&#125;//-----ç¾¤ç»„-----/*** å®žä½“èº«ä¸Šç»„ä»¶æœ‰å¢žåˆ æ“ä½œï¼Œå¹¿æ’­é€šçŸ¥å¯¹åº”çš„è§‚å¯Ÿè€…ã€‚* @param entity å®žä½“å¯¹è±¡* @param componentTypeId ç»„ä»¶ç±»åž‹id*/public broadcastCompAddOrRemove(entity: Entity, componentTypeId: number) &#123; let events = this._compAddOrRemove.get(componentTypeId); if (events) &#123; for (let i = events.length - 1; i &gt;= 0; i--) &#123; events![i](entity); &#125; &#125;&#125;/*** æ¸…é™¤*/public clear() &#123; this._eid2Entity.forEach((entity) =&gt; &#123; entity.removeSelf(); &#125;); this._groups.forEach((group) =&gt; &#123; group.clear(); &#125;); this._compAddOrRemove.forEach(callbackLst =&gt; &#123; callbackLst.length = 0; &#125;); this._eid2Entity.clear(); this._groups.clear();&#125;//-----è¿‡æ»¤-----public getMatherId() &#123; return this._matcherId++;&#125;/** * åˆ¤æ–­æ˜¯å¦æ‹¥æœ‰æ‰€æœ‰å¯¹åº”ç»„ä»¶ * @param args * @returns */public allOf(...args: CompTypeUnion&lt;IComp&gt;[]) &#123; return new Matcher().allOf(...args);&#125;/** * åˆ¤æ–­æ˜¯å¦æ‹¥æœ‰ä»»æ„å¯¹åº”ç»„ä»¶ * @param args * @returns */public anyOf(...args: CompTypeUnion&lt;IComp&gt;[]) &#123; return new Matcher().anyOf(...args);&#125;/** * åˆ¤æ–­æ˜¯å¦åªåŒ…å«æ‰€æœ‰å¯¹åº”ç»„ä»¶ * @param args * @returns */public onlyOf(...args: CompTypeUnion&lt;IComp&gt;[]) &#123; return new Matcher().onlyOf(...args);&#125;/** * åˆ¤æ–­æ˜¯å¦ä¸åŒ…å«ä»»æ„å¯¹åº”ç»„ä»¶ * @param args * @returns */public excludeOf(...args: CompTypeUnion&lt;IComp&gt;[]) &#123; return new Matcher().excludeOf();&#125;//-----è¿‡æ»¤----- æ€»çš„ ECS ç®¡ç†ç±»ä»£ç å¦‚ä¸‹ ECSManager123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337import &#123; Comp &#125; from &quot;./Comp&quot;;import Entity from &quot;./Entity&quot;;import Group from &quot;./Group&quot;;import &#123; CompType &#125; from &quot;./Interface/CompType&quot;;import IComp from &quot;./Interface/IComp&quot;;import &#123; IMatcher &#125; from &quot;./Interface/IMatcher&quot;;import &#123; Matcher &#125; from &quot;./Mathcer&quot;;export type CompAddOrRemove = (entity: Entity) =&gt; void;export type CompTypeUnion&lt;T&gt; = CompType&lt;T&gt; | number;export default class ECSManager &#123; private static _instance: ECSManager | null = null; private _compTid = 0; private _entityId = 1; private _matcherId = 1; /** * æ³¨å†Œæ± ï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨åŒåç»„ä»¶æˆ–æ ‡ç­¾ */ private _registerPool = &#123;&#125;; /** * ç»„ä»¶æ³¨å†Œæ±  */ private _comps: any[] = []; /** * ç»„ä»¶ç¼“å­˜æ±  */ private _compPools: Map&lt;number, Comp[]&gt; = new Map(); /** * tagæ±  */ private _tags: Map&lt;number, string&gt; = new Map(); private _compAddOrRemove: Map&lt;number, CompAddOrRemove[]&gt; = new Map(); /** * å®žä½“æ±  */ private _eid2Entity: Map&lt;number, Entity&gt; = new Map(); /** * å®žä½“ç¼“å­˜æ±  */ private _eneityPool: Entity[] = []; private _groups: Map&lt;number, Group&gt; = new Map(); public static getInst(): ECSManager &#123; if (!this._instance) &#123; this._instance = new ECSManager(); &#125; return this._instance; &#125; public getCompTid() &#123; return this._compTid; &#125; //-----æ³¨å†Œ----- /** * æ³¨å†Œç»„ä»¶ * @param compName * @param canNew * @returns */ public register&lt;T&gt;(compName: string, canNew: boolean = true) &#123; return function (comp: CompType&lt;T&gt;) &#123; if (comp.tid == -1) &#123; let manager = ECSManager.getInst(); if (manager._registerPool[compName]) &#123; console.warn(&quot;ç»„ä»¶ä¸Žæ ‡ç­¾é‡å:&quot;, compName); &#125; else &#123; comp.tid = manager._compTid++; comp.compName = compName; if (canNew) &#123; manager._comps.push(comp); manager._compPools.set(comp.tid, []); &#125; else &#123; manager._comps.push(null); &#125; manager._compAddOrRemove.set(comp.tid, []); console.log(&quot;ç»„ä»¶&quot; + compName + &quot;æ³¨å†ŒæˆåŠŸ:&quot;, comp.tid); manager._registerPool[compName] = true; &#125; &#125; else &#123; console.log(&quot;ç»„ä»¶å·²æ³¨å†Œ&quot;); &#125; &#125;; &#125; /** * æ³¨å†Œtag * @returns */ public registerTag() &#123; return function (_class: any) &#123; let manager = ECSManager.getInst(); let tid = manager._compTid; for (let k in _class) &#123; if (manager._registerPool[k]) &#123; console.warn(&quot;æ ‡ç­¾ä¸Žç»„ä»¶é‡å:&quot;, k); &#125; else &#123; tid = manager._compTid++; _class[k] = tid; manager._comps.push(tid); manager._compPools.set(tid, []); manager._compAddOrRemove.set(tid, []); manager._tags.set(tid, k); console.log(&quot;æ ‡ç­¾&quot; + k + &quot;æ³¨å†ŒæˆåŠŸ:&quot;, tid); manager._registerPool[k] = true; &#125; &#125; &#125;; &#125; //-----æ³¨å†Œ----- //-----tag----- /** * æ˜¯å¦æœ‰tag * @param id * @returns */ public hasTag(id: number) &#123; return this._tags.has(id); &#125; /** * èŽ·å¾—tag * @param id * @returns */ public getTag(id: number): string &#123; return this._tags.get(id) as string; &#125; //-----tag----- //-----ç»„ä»¶----- /** * å›žæ”¶ç»„ä»¶ * @param id ç»„ä»¶id * @param comp ç»„ä»¶å®žä¾‹ */ public recycle(id: number, comp: IComp) &#123; this._compPools.get(id)?.push(comp); &#125; /** * åˆ›å»ºç»„ä»¶ * @param comp * @returns */ public createComp&lt;T&gt;(comp: CompType&lt;T&gt;) &#123; if (!this._comps[comp.tid]) &#123; console.error(&quot;æœªæ‰¾åˆ°ç»„ä»¶&quot; + comp.compName); &#125; let compInstance = this._compPools.get(comp.tid)?.pop() || new this._comps[comp.tid](); return compInstance; &#125; /** * èŽ·å¾—æ‰€æœ‰ç»„ä»¶ * @returns */ public getComps() &#123; return this._comps; &#125; /** * å®žä½“èº«ä¸Šç»„ä»¶æœ‰å¢žåˆ æ“ä½œï¼Œå¹¿æ’­é€šçŸ¥å¯¹åº”çš„è§‚å¯Ÿè€…ã€‚ * @param entity å®žä½“å¯¹è±¡ * @param componentTypeId ç»„ä»¶ç±»åž‹id */ public broadcastCompAddOrRemove(entity: Entity, componentTypeId: number) &#123; let events = this._compAddOrRemove.get(componentTypeId); if (events) &#123; for (let i = events.length - 1; i &gt;= 0; i--) &#123; events![i](entity); &#125; &#125; &#125; //-----ç»„ä»¶----- //-----å®žä½“----- /** * åˆ›å»ºå®žä½“ * @returns */ public createEntity&lt;E extends Entity = Entity&gt;(): E &#123; let entity = this._eneityPool.pop(); if (!entity) &#123; entity = new Entity(); entity.eid = this._entityId++; &#125; this._eid2Entity.set(entity.eid, entity); return entity as E; &#125; /** * ç§»é™¤å®žä½“ * @param id å®žä½“id * @param entity å®žä½“ */ public removeEntity(id: number, entity: Entity) &#123; if (this._eid2Entity.has(id)) &#123; this._eneityPool.push(entity); this._eid2Entity.delete(id); &#125; else &#123; console.warn(&quot;è¯•å›¾é”€æ¯ä¸å­˜åœ¨çš„å®žä½“&quot;); &#125; &#125; /** * æ ¹æ®eidèŽ·å–å®žä½“ * @param eid * @returns */ public getEntityByEid(eid: number) &#123; return this._eid2Entity.get(eid); &#125; /** * èŽ·å¾—å½“å‰æ´»åŠ¨å®žä½“æ•°é‡ * @returns */ public activeEntityCount() &#123; return this._eid2Entity.size; &#125; /** * æ¸…é™¤ */ public clear() &#123; this._eid2Entity.forEach((entity) =&gt; &#123; entity.removeSelf(); &#125;); this._groups.forEach((group) =&gt; &#123; group.clear(); &#125;); this._compAddOrRemove.forEach((callbackLst) =&gt; &#123; callbackLst.length = 0; &#125;); this._eid2Entity.clear(); this._groups.clear(); &#125; //-----å®žä½“----- //-----ç¾¤ç»„----- /** * åˆ›å»ºç¾¤ç»„ * @param matcher */ public createGroup&lt;E extends Entity = Entity&gt;(matcher: IMatcher): Group&lt;E&gt; &#123; let group = this._groups.get(matcher.mid); if (!group) &#123; group = new Group(matcher); this._groups.set(matcher.mid, group); let careCompIds = matcher.indices; for (let i = 0, len = careCompIds.length; i &lt; len; i++) &#123; let child = this._compAddOrRemove.get(careCompIds[i]); if (!child) &#123; child = []; this._compAddOrRemove.set(careCompIds[i], child); &#125; child.push(group.onComponentAddOrRemove.bind(group)); &#125; &#125; return group as unknown as Group&lt;E&gt;; &#125; public query(matcher: IMatcher) &#123; let group = this._groups.get(matcher.mid); if (!group) &#123; group = this.createGroup(matcher); this._eid2Entity.forEach(group.onComponentAddOrRemove, group); &#125; return group.matchEntities; &#125; //-----ç¾¤ç»„----- //-----è¿‡æ»¤----- public getMatherId() &#123; return this._matcherId++; &#125; /** * åˆ¤æ–­æ˜¯å¦æ‹¥æœ‰æ‰€æœ‰å¯¹åº”ç»„ä»¶ * @param args * @returns */ public allOf(...args: CompTypeUnion&lt;IComp&gt;[]) &#123; return new Matcher().allOf(...args); &#125; /** * åˆ¤æ–­æ˜¯å¦æ‹¥æœ‰ä»»æ„å¯¹åº”ç»„ä»¶ * @param args * @returns */ public anyOf(...args: CompTypeUnion&lt;IComp&gt;[]) &#123; return new Matcher().anyOf(...args); &#125; /** * åˆ¤æ–­æ˜¯å¦åªåŒ…å«æ‰€æœ‰å¯¹åº”ç»„ä»¶ * @param args * @returns */ public onlyOf(...args: CompTypeUnion&lt;IComp&gt;[]) &#123; return new Matcher().onlyOf(...args); &#125; /** * åˆ¤æ–­æ˜¯å¦ä¸åŒ…å«ä»»æ„å¯¹åº”ç»„ä»¶ * @param args * @returns */ public excludeOf(...args: CompTypeUnion&lt;IComp&gt;[]) &#123; return new Matcher().excludeOf(); &#125; //-----è¿‡æ»¤-----&#125; ä½¿ç”¨æ–¹æ³•Tagç¤ºä¾‹1234567import ECSManager from &quot;../../../ECS/ECSManager&quot;;@ECSManager.getInst().registerTag()export default class StatusTags &#123; public static StatusA = 0; public static StatusB = 1;&#125; Compç¤ºä¾‹123456789101112import &#123; Comp &#125; from &quot;../../../ECS/Comp&quot;;import ECSManager from &quot;../../../ECS/ECSManager&quot;;@ECSManager.getInst().register(&quot;Transform&quot;)export default class TransformComp extends Comp &#123; /** åæ ‡ */ public position: Laya.Vector3 = new Laya.Vector3(); reset(): void &#123; this.position.set(0, 0, 0); &#125;&#125; Entityç¤ºä¾‹123456import Entity from &quot;../../../ECS/Entity&quot;;import TransformComp from &quot;../Comp/TransformComp&quot;;export default class RoleEntity extends Entity &#123; public Transform: TransformComp;&#125; ComblockSystemç¤ºä¾‹123456789101112131415161718192021222324252627import &#123; ComblockSystem &#125; from &quot;../../../ECS/ComBlockSystem&quot;;import ECSManager from &quot;../../../ECS/ECSManager&quot;;import &#123; IMatcher &#125; from &quot;../../../ECS/Interface/IMatcher&quot;;import &#123; IEntityEnterSystem &#125; from &quot;../../../ECS/Interface/ISystem&quot;;import ServantComp from &quot;../Comp/ServantComp&quot;;import WorkerComp from &quot;../Comp/WorkerComp&quot;;import RoleEntity from &quot;../Entity/RoleEntity&quot;;/** * å·¥ä½œç³»ç»Ÿ */export default class WorkSystem extends ComblockSystem&lt;RoleEntity&gt; implements IEntityEnterSystem&lt;RoleEntity&gt;&#123; entityEnter(entities: RoleEntity[]): void &#123; for (let e of entities) &#123; &#125; &#125; filter(): IMatcher &#123; return ECSManager.getInst().anyOf(WorkerComp, ServantComp); &#125; update(entities: RoleEntity[]): void &#123; for (let e of entities) &#123; &#125; &#125;&#125; RootSystemç¤ºä¾‹1234567891011121314151617181920import Globals from &quot;../../../Config/Globals&quot;;import &#123; RootSystem &#125; from &quot;../../../ECS/RootSystem&quot;;import CarShopSystem from &quot;../System/CarShopSystem&quot;;import CarSystem from &quot;../System/CarSystem&quot;;import CustomSystem from &quot;../System/CustomSystem&quot;;import DollSystem from &quot;../System/DollSystem&quot;;import MoveSystem from &quot;../System/MoveSystem&quot;;import NpcSystem from &quot;../System/NpcSystem&quot;;import PathFindingSystem from &quot;../System/PathFindingSystem&quot;;import WorkSystem from &quot;../System/WorkSystem&quot;;/** * æ…¢é€Ÿæ ¹ç³»ç»Ÿ */export default class RootSlowSystem extends RootSystem &#123; constructor() &#123; super(); this.add(new WorkSystem()); &#125;&#125; æ ¹ç³»ç»Ÿè°ƒç”¨ç¤ºä¾‹123456789101112onAwake()&#123; this._rootSlowSystem = new RootSlowSystem(); this._rootSlowSystem.init();&#125;onUpdate()&#123; this._rootSlowSystem.execute(Laya.timer.delta);&#125;onDisable() &#123; this._rootSlowSystem.clear();&#125; ä»£ç ç”±äºŽæœ¬é¡¹ç›®ä»£ç è¾ƒå¤šï¼Œå› æ­¤è¯·ç§»æ­¥ GitHub æŸ¥çœ‹è¯¦ç»†ä»£ç ã€‚","categories":[{"name":"Laya","slug":"Laya","permalink":"https://busyogg.github.io/categories/Laya/"},{"name":"å·¥å…·","slug":"Laya/å·¥å…·","permalink":"https://busyogg.github.io/categories/Laya/%E5%B7%A5%E5%85%B7/"}],"tags":[{"name":"Laya","slug":"Laya","permalink":"https://busyogg.github.io/tags/Laya/"},{"name":"Typescript","slug":"Typescript","permalink":"https://busyogg.github.io/tags/Typescript/"},{"name":"å·¥å…·","slug":"å·¥å…·","permalink":"https://busyogg.github.io/tags/%E5%B7%A5%E5%85%B7/"},{"name":"ECS","slug":"ECS","permalink":"https://busyogg.github.io/tags/ECS/"}]},{"title":"Layaå®žçŽ°FixedUpdate","slug":"Layaå®žçŽ°FixedUpdate","date":"2023-09-13T10:14:10.000Z","updated":"2024-05-18T15:37:43.771Z","comments":true,"path":"article/f6c36db9b473/","link":"","permalink":"https://busyogg.github.io/article/f6c36db9b473/","excerpt":"","text":"ç®€ä»‹æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦å›ºå®šæ¯ç§’å›ºå®šæ¬¡æ•°æ›´æ–°çš„åŠŸèƒ½çš„æ—¶å€™ï¼Œä¾‹å¦‚ Unity çš„ FixedUpdateï¼ŒLaya æœ¬èº«ä¸æä¾›è¿™æ ·çš„æ–¹æ³•ï¼Œæˆ–è®¸æœ‰äººç”¨å®šæ—¶å™¨å®žçŽ°ï¼Œä½†æ˜¯å®šæ—¶å™¨ä¸æ˜“ç®¡ç†ã€‚æœ¬é¡¹ç›®æä¾›ä¸€ç§åŸºäºŽå¸§æ›´æ–°çš„å®šæ—¶æ›´æ–°æ–¹æ³•ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ åŸºæœ¬åŽŸç†æ¯å¸§æ›´æ–°çš„æ—¶å€™è®¡ç®—æ€»æ›´æ–°æ—¶é—´ï¼Œæ ¹æ®æ€»æ›´æ–°æ—¶é—´é™¤ä»¥é—´éš”æ—¶é—´èŽ·å¾—å½“å‰å¸§éœ€è¦æ›´æ–°çš„æ¬¡æ•°ï¼Œæ ¹æ®æ›´æ–°æ¬¡æ•°å¾ªçŽ¯æ›´æ–°ã€‚ä»¥æ­¤æˆ‘ä»¬å¯ä»¥å®žçŽ°å’Œå¸§çŽ‡ä¸åŒçš„æ›´æ–°é¢‘çŽ‡ã€‚ æœ¬ä¾‹è®¾ç½®é—´éš”æ—¶é—´ä¸º 50msï¼Œå³æ¯ç§’è¿è¡Œ 20 æ¬¡ã€‚å¦‚æžœå½“å‰æ€»å¸§é—´éš”æ—¶é—´å°äºŽ 50ms çš„æƒ…å†µä¸‹ï¼Œ_fiexdTimesè¿è¡Œæ¬¡æ•°ä¸º 0ï¼ŒäºŽæ˜¯å½“å‰å¸§ä¸è¿è¡ŒonFixedUpdateï¼Œåä¹‹è¿è¡Œ n æ¬¡ã€‚ 60fps çš„æƒ…å†µä¸‹ï¼Œæ¯ä¸‰å¸§é—´éš”æ—¶é—´è¾¾åˆ° 50msï¼Œè¿è¡Œä¸€æ¬¡onFixedUpdateã€‚ 30fps çš„æƒ…å†µä¸‹ï¼Œå¤´ 2 æ¬¡æ¯ 2 å¸§é—´éš”æ—¶é—´è¶…è¿‡ 50msï¼Œè¿è¡Œ 1 æ¬¡ï¼Œç¬¬ 3 æ¬¡å¼€å§‹ç”±äºŽä¹‹å‰ä¿å­˜çš„æ—¶é—´ä¸º _savedTime = 32 * 2 - 50 + 32 * 2 -50 = 28 ,åŠ ä¸Šå½“å‰å¸§çš„ 32ms äºŽæ˜¯å¤§äºŽ 50msï¼Œè¿è¡Œä¸€æ¬¡ã€‚å³å‰ 7 å¸§ä¸º 2 å¸§ 2 æ¬¡åŽ 1 å¸§ 1 æ¬¡ã€‚ 10fps çš„æƒ…å†µä¸‹ï¼Œæ¯å¸§é—´éš” 100msï¼Œå› æ­¤æ¯å¸§è¿è¡Œä¸¤æ¬¡onFixedUpdateã€‚ é€šè¿‡åŠ¨æ€å¹³è¡¡æ¯å¸§éœ€è¦æ‰§è¡Œçš„æ¬¡æ•°ï¼Œå°±èƒ½æŽ§åˆ¶æ¯ç§’æ‰§è¡Œçš„æ€»æ¬¡æ•°ä¸å˜ã€‚ è¿è¡Œçš„è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå‡ºçŽ°å•å¸§è¿è¡Œæ—¶é—´Math.floor(this._fiexdTimes) * this._intervalså®žé™…å°äºŽé—´éš”æ—¶é—´this._deltaTimeçš„æƒ…å†µï¼Œå› æ­¤å¢žè®¾ä¸€ä¸ª_savedTimeæ¥ä¿å­˜æœªå‚ä¸Žè¿ç®—çš„æ—¶é—´ï¼ŒåŒæ—¶ä¸ºäº†é˜²æ­¢ä¿å­˜çš„æ—¶é—´å’Œå¸§é—´éš”æ—¶é—´è¿‡é•¿ï¼ˆå°æ¸¸æˆæŒ‚åˆ°åŽå°ï¼Œæ¸¸æˆæš‚åœå¯¼è‡´ deltaTime è¿‡å¤§ï¼‰å¯¼è‡´é‡å¤è¿è¡Œæ¬¡æ•°è¿‡å¤šï¼Œå› æ­¤åœ¨æ¯å¸§å‚ä¸Žè¿ç®—ä¹‹å‰éƒ½ä¼šå¯¹å…¶è¿›è¡Œä¸Šé™åˆ¤æ–­ã€‚è¿™éƒ¨åˆ†å¯ä»¥æ ¹æ®éœ€è¦è‡ªè¡Œåˆ æ”¹ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243/** ç´¯è®¡æ—¶é—´ */private _deltaTime = 0;/** ä¸Šä¸€fixed update å‰©ä½™æ—¶é—´ */private _savedTime = 0;/** fixed update æ‰§è¡Œæ¬¡æ•° */private _fiexdTimes = 0;/** é€»è¾‘å¸§é—´éš”æ—¶é—´ å•ä½æ¯«ç§’ 50å³æ¯ç§’æ›´æ–°20æ¬¡*/private _intervals = 50; /** * å›ºå®šæ›´æ–° */private fixedUpdate() &#123; let mark = false; let curDelta = Laya.timer.delta; curDelta = curDelta &lt; this._intervals ? curDelta : this._intervals; //é˜²æ­¢å‡ºçŽ°é•¿æ—¶é—´æ”¾ç½®å¯¼è‡´çš„ä¿å­˜æ—¶é—´è¿‡é•¿ if (this._savedTime &gt; this._intervals) &#123; this._savedTime = this._intervals; &#125; //ç´¯è®¡é—´éš”æ—¶é—´ this._deltaTime += curDelta + this._savedTime; //æ›´æ–°æ¬¡æ•° this._fiexdTimes = this._deltaTime / this._intervals; for (let i = 1; i &lt; this._fiexdTimes; i++) &#123; this.onFixedUpdate(); mark = true; &#125; if (mark) &#123; this._savedTime = this._deltaTime - Math.floor(this._fiexdTimes) * this._intervals; this._deltaTime = 0; &#125; else &#123; this._savedTime = 0; &#125;&#125;/** * å›ºå®šæ›´æ–°è¿è¡Œå†…å®¹ */onFixedUpdate() &#123;&#125;","categories":[{"name":"Laya","slug":"Laya","permalink":"https://busyogg.github.io/categories/Laya/"},{"name":"å·¥å…·","slug":"Laya/å·¥å…·","permalink":"https://busyogg.github.io/categories/Laya/%E5%B7%A5%E5%85%B7/"}],"tags":[{"name":"Laya","slug":"Laya","permalink":"https://busyogg.github.io/tags/Laya/"},{"name":"Typescript","slug":"Typescript","permalink":"https://busyogg.github.io/tags/Typescript/"},{"name":"å·¥å…·","slug":"å·¥å…·","permalink":"https://busyogg.github.io/tags/%E5%B7%A5%E5%85%B7/"}]},{"title":"å››å‰æ ‘ç©ºé—´ç®¡ç†","slug":"å››å‰æ ‘ç©ºé—´ç®¡ç†","date":"2023-09-11T18:56:40.000Z","updated":"2024-05-18T15:38:17.225Z","comments":true,"path":"article/3357cf00d6c0/","link":"","permalink":"https://busyogg.github.io/article/3357cf00d6c0/","excerpt":"","text":"ç®€ä»‹åœ¨æ¸¸æˆå¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è¦å¯¹ç©ºé—´è¿›è¡Œç®¡ç†ï¼Œä¸€ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„æ–¹æ³•å°±æ˜¯ç”¨å››å‰æ ‘è¿›è¡Œç®¡ç†ï¼Œé‡‡ç”¨çš„æ˜¯åˆ†æ²»çš„æ€è·¯ï¼ŒæŠŠä¸€ä¸ªå¤§çš„ç©ºé—´åˆ†ä¸ºè‹¥å¹²å°ç©ºé—´è¿›è¡Œç®¡ç†ã€‚ åŽŸç†å››å‰æ ‘çš„æ€è·¯å¾ˆç®€å•ï¼Œå’ŒäºŒåˆ†æŸ¥æ‰¾ç±»ä¼¼ é¦–å…ˆæˆ‘ä»¬è¦å®šä¹‰ä¸€ä¸ªèŒƒå›´ï¼Œä½œä¸ºç©ºé—´ç®¡ç†çš„åŸºç¡€ã€‚ ç„¶åŽæŠŠè¿™ä¸ªèŒƒå›´åˆ’åˆ†ä¸ºå››å—ã€‚ æ‰€æœ‰æ“ä½œéƒ½æŒ‰ç…§è¿™ä¸ªç©ºé—´æ¥è¿›è¡Œï¼Œå½“å‰æ ¼å­ä¸æ»¡è¶³æ¡ä»¶çš„æƒ…å†µå°±å‘ä¸‹æ‹“å±•ã€‚ çŽ°åœ¨ï¼Œæˆ‘ä»¬è¦æ‰¾åˆ°ç©ºé—´ä¸­çš„ä¸€ä¸ªç‰©ä½“ï¼Œæˆ‘ä»¬å°±ä¸éœ€è¦ä»Žå¤§çš„é»‘è‰²çš„è¿™ä¸ªèŒƒå›´å…¨éƒ¨éåŽ†ç‰©ä½“ï¼Œè€Œæ˜¯åœ¨çº¢è‰²åˆ†å‰²çº¿åˆ’åˆ†å‡ºæ¥çš„å°ç©ºé—´é‡Œé¢éåŽ†è¯¥ç©ºé—´ä¸­å­˜å‚¨çš„ç‰©ä½“ã€‚ å¦‚å›¾æ‰€ç¤ºï¼Œä¸‹é¢å°±æ˜¯ä¸€ä¸ªæœ€åŸºç¡€çš„å››å‰æ ‘åˆ†å‰²ã€‚æˆ‘ä»¬æŠŠä¸€ä¸ªå¤§çš„ç©ºé—´åˆ†ä¸ºäº†å››ä¸ªå°çš„ç©ºé—´ã€‚ å››å‰æ ‘å®šä¹‰çŽ°åœ¨ï¼Œæˆ‘ä»¬é‡åˆ°äº†ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œè¦é€šè¿‡ä»€ä¹ˆè§„åˆ™æ¥å†³å®šæ˜¯å¦éœ€è¦åˆ’åˆ†ç©ºé—´å‘¢ï¼Ÿ è¿™é‡Œå°±è¦å¼•å…¥èŠ‚ç‚¹æ·±åº¦å’ŒèŠ‚ç‚¹å®¹é‡çš„æ¦‚å¿µã€‚ èŠ‚ç‚¹æ·±åº¦å†³å®šå››å‰æ ‘èƒ½å¤Ÿæ‹“å±•åˆ°å¤šæ·± èŠ‚ç‚¹å®¹é‡å†³å®šéžæœ€æ·±èŠ‚ç‚¹èƒ½å­˜å‚¨å¯¹è±¡çš„æœ€å¤§æ•°é‡ã€‚ å½“éžæœ€æ·±èŠ‚ç‚¹çš„èŠ‚ç‚¹å®¹é‡æœªæ»¡çš„æ—¶å€™ï¼ŒèŠ‚ç‚¹ä¸è¿›è¡Œåˆ†å‰²ï¼Œæ‰€æœ‰çš„å¯¹è±¡éƒ½å­˜å‚¨åœ¨å½“å‰çš„èŠ‚ç‚¹ï¼›å½“å®¹é‡æ»¡äº†ä¹‹åŽï¼ŒèŠ‚ç‚¹åˆ†å‰²ä¸ºæ›´å°çš„å››å—ï¼Œå¹¶ä¸”èŠ‚ç‚¹ä¸­å­˜å‚¨çš„å¯¹è±¡é€šè¿‡æŸ¥è¯¢æ¯”è¾ƒåŒ…å›´ç›’å¤§å°ï¼Œæ»¡è¶³æ¡ä»¶çš„å­˜å…¥æ–°çš„èŠ‚ç‚¹ä¸­ï¼Œä¸æ»¡è¶³æ¡ä»¶çš„åˆ™ç»§ç»­å­˜æ”¾åœ¨è¯¥èŠ‚ç‚¹ã€‚ çŽ°åœ¨ï¼Œæˆ‘ä»¬å¾€è¿™ä¸ªç©ºé—´é‡Œæ”¾å…¥ä¸€äº›å¯¹è±¡ã€‚æˆ‘ä»¬å‡è®¾æ·±åº¦ä¸º 2ï¼Œå®¹é‡ä¹Ÿä¸º 2ã€‚é‚£ä¹ˆå°±æœ‰å¦‚ä¸‹å›¾æ‰€ç¤ºçš„æƒ…å†µã€‚ image.png æ©™è‰²ä»£è¡¨æ’å…¥çš„å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥è§‚å¯Ÿåˆ°ï¼Œåœ¨çº¢è‰²åˆ†å‰²çº¿åˆ’åˆ†çš„å³ä¸Šè§’æ ¼å­ä¸­ï¼Œæˆ‘ä»¬æ’å…¥äº† 4 ä¸ªå¯¹è±¡ã€‚æ­¤æ—¶è¯¥èŠ‚ç‚¹æ·±åº¦ä¸º 1ï¼Œå¯¹è±¡ä¸º 4 è¶…è¿‡äº†èŠ‚ç‚¹çš„æœ€å¤§å®¹é‡ï¼Œå› æ­¤æˆ‘ä»¬ç»§ç»­åˆ†å‰²ï¼Œåˆ†å‰²å‡ºç²‰è‰²çº¿å››ä¸ªæ ¼å­ã€‚å³ä¸Šç²‰è‰²æ ¼å­å¯¹è±¡æ•°é‡ä¸º 3ï¼Œæ­¤æ—¶è™½ç„¶è¶…å‡ºäº†æœ€å¤§å®¹é‡ï¼Œä½†ç”±äºŽæ ¼å­çš„æ·±åº¦ä¸º 2ï¼Œå·²ç»è¾¾åˆ°æœ€å¤§æ·±åº¦ï¼Œå› æ­¤æ— æ³•ç»§ç»­åˆ†å‰²ï¼Œæ‰€æœ‰çš„å¯¹è±¡éƒ½å­˜å‚¨åœ¨è¯¥èŠ‚ç‚¹ã€‚ å››å‰æ ‘çš„æ•°æ®ç»“æž„å¯ä»¥æ ¹æ®ä»¥ä¸Šæ¦‚å¿µå¾—å‡º QTree12345678/** æœ€å¤§æ·±åº¦ */public _maxDepth = 0;/** æœ€å¤§æ•°é‡ */public _maxObjCount = 0;/** åŒ…å›´ç›’ */public _bound = &#123;&#125;;/** æ ¹èŠ‚ç‚¹ */public _root: Qnode; æ­¤å¤„æœ‰ä¸€ä¸ª QNode ä¸ºå››å‰æ ‘èŠ‚ç‚¹ï¼Œå››å‰æ ‘èŠ‚ç‚¹çš„æ•°æ®ç»“æž„å¦‚ä¸‹ QNode12345678910111213141516/** åŒ…å›´ç›’ */public _bound: &#123; x, z, w, h, maxX, minX, maxZ, minZ &#125;;/** å®½æ¾åŒ…å›´ç›’ */public _looseBound: any = &#123;&#125;;/** çˆ¶èŠ‚ç‚¹ */public _parent: Qnode;/** æ‰€å±žå››å‰æ ‘ */public _belongTree: Qtree;/** å¯¹è±¡åˆ—è¡¨ */public _objList = [];/** å­èŠ‚ç‚¹å­—å…¸ */public _childDic = &#123;&#125;;/** æ·±åº¦ */public _depth: number;/** å¯¹è±¡æ•°é‡ */public _objCount = 0; å››å‰æ ‘èŠ‚ç‚¹æ•°æ®ç»“æž„ä¸­çš„å®½æ¾åŒ…å›´ç›’ä¸ºæ¾æ•£å››å‰æ ‘æ‰€ä½¿ç”¨ï¼ŒæŽ¥ä¸‹æ¥ä¼šä»‹ç»ã€‚å¯¹è±¡å­˜å‚¨åœ¨æ•°ç»„ä¸­ï¼Œå­èŠ‚ç‚¹å¯ä»¥å­˜ä¸ºæ•°ç»„ï¼Œä¹Ÿå¯ä»¥å­˜ä¸ºå­—å…¸ï¼Œæœ€ç»ˆçš„ç»“æžœéƒ½æ˜¯ä¸€æ ·å­˜æ”¾ä¸‹ä¸€æ·±åº¦çš„å››ä¸ªèŠ‚ç‚¹ï¼Œå¯ä»¥æŒ‰ç…§è‡ªå·±çš„å–œå¥½è°ƒæ•´ã€‚ å››å‰æ ‘æ“ä½œå¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬è¦è§£å†³ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚ä½•è¿›è¡Œå¯¹è±¡æ’å…¥çš„æ¡ä»¶åˆ¤æ–­ï¼Ÿ åœ¨è®¨è®ºæ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬è¦å…ˆæ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æžœå››å‰æ ‘åˆ‡çº¿è¾¹ç¼˜å­˜åœ¨ç‰©ä½“çš„æƒ…å†µè¯¥å¦‚ä½•è§£å†³ï¼Ÿè¿™é‡Œæœ‰ä¸¤ç§æ–¹æ³•ï¼Œä¸€ç§æ˜¯å­˜åœ¨çˆ¶èŠ‚ç‚¹ï¼Œä¸€ç§æ˜¯æ¯ä¸€ä¸ªåŽ‹åˆ°çš„èŠ‚ç‚¹éƒ½å­˜æ”¾ä¸€ä¸ªè¯¥å¯¹è±¡ã€‚ å‡è®¾è¿™ä¸ªè“è‰²çš„å¯¹è±¡æ’å…¥çš„æ—¶å€™åŽ‹åˆ°äº†ç²‰è‰²è¾¹çº¿ï¼Œç”¨ç¬¬ä¸€ç§æ–¹æ³•çš„æ—¶å€™ï¼Œæˆ‘ä»¬æŸ¥æ‰¾å³ä¸Šè§’ç²‰è‰²æ ¼å­å†…çš„å¯¹è±¡çš„æ—¶å€™ï¼ŒæŸ¥æ‰¾çš„ç»“æžœå¿…å®šä¼šåŒ…å«è“è‰²å¯¹è±¡ï¼Œå› ä¸ºè“è‰²å¯¹è±¡æœ¬èº«æ˜¯å±žäºŽçº¢è‰²æ ¼å­çš„ã€‚ç”¨ç¬¬äºŒç§æ–¹æ³•çš„æ—¶å€™ï¼Œå·¦ä¸‹è§’å’Œå³ä¸‹è§’çš„ç²‰è‰²æ ¼å­éƒ½æœ‰ä¿å­˜è“è‰²å¯¹è±¡çš„ä¿¡æ¯ï¼Œå ç”¨äº†ä¸¤ä»½æ•°æ®ï¼Œå¦‚æžœæ˜¯åœ¨ç²‰è‰²åå­—æ­£ä¸­é—´çš„æ—¶å€™ï¼Œå­˜å‚¨çš„æ•°æ®è¦å˜æˆå››ä»½ã€‚ è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬è¦å¼•å…¥ä¸€ä¸ªæ¾æ•£å››å‰æ ‘çš„æ¦‚å¿µã€‚æˆ‘ä»¬åœ¨ä¸Šé¢çš„å››å‰æ ‘å®šä¹‰ä¸­ä¹Ÿæåˆ°è¿‡æ¾æ•£å››å‰æ ‘ï¼Œæ¾æ•£å››å‰æ ‘æ˜¯æŒ‡æ¯ä¸€ä¸ªåˆ†å‰²çš„æ ¼å­çš„åŒ…å›´ç›’å¹¶ä¸ä¸€å®šè¦ä¸¥æ ¼åˆ†å‰²å››åˆ†ä¹‹ä¸€çˆ¶èŠ‚ç‚¹ç©ºé—´ã€‚ å¦‚å›¾æ‰€ç¤ºï¼Œå³ä¸‹è§’è¿™ä¸ªç»¿è‰²çš„ç©ºé—´ï¼Œå°±æ˜¯å³ä¸‹è§’æ ¼å­çš„æ¾æ•£åŒ…å›´ç›’ã€‚æ¯ä¸€ä¸ªæ ¼å­éƒ½æœ‰è‡ªå·±çš„æ¾æ•£åŒ…å›´ç›’ã€‚å½“æ¾æ•£åŒ…å›´ç›’çš„å¤§å°æ˜¯æ ¼å­å¤§å°çš„ 2 å€çš„æ—¶å€™ä¼šäº§ç”Ÿä¸€ä¸ªç‰¹æ€§ï¼Œé‚£å°±æ˜¯æ’å…¥å¯¹è±¡çš„ä¸­å¿ƒç‚¹åªè¦åœ¨æ ¼å­ä¸­ï¼Œé‚£ä»–å¿…å®šåœ¨è¿™ä¸ªæ ¼å­çš„æ¾æ•£åŒ…å›´ç›’ä¹‹å†… ã€‚å› æ­¤ä¸€èˆ¬å¸¸ç”¨ 2 å€å¤§å°çš„æ¾æ•£åŒ…å›´ç›’ã€‚ è¿™ä¸ªæ—¶å€™ï¼Œå¯¹è±¡åŽ‹çº¿çš„é—®é¢˜å°±å¾—åˆ°äº†è§£å†³ï¼Œåªè¦åˆ¤æ–­å¯¹è±¡çš„ä¸­å¿ƒå±žäºŽå“ªä¸ªæ ¼å­å³å¯ã€‚ å¦‚å›¾æ‰€ç¤ºï¼Œå‡å¦‚æ©™è‰²éƒ¨åˆ†æ˜¯æ’å…¥å¯¹è±¡çš„å¤§å°ï¼Œå½“ä»–çš„å¤§å°ä¸ºæœ€å¤§ï¼Œå³çº¢è‰²æ ¼å­å¤§å°æ—¶ï¼Œä»–çš„ä¸­å¿ƒç‚¹åœ¨çº¢è‰²æ ¼å­çš„å·¦ä¸‹è§’æ—¶ï¼Œä¾ç„¶ä¸ä¼šè¶…å‡ºç»¿è‰²æ¾æ•£åŒ…å›´ç›’å¤§å°ã€‚ å‰æœŸå·¥ä½œé¦–å…ˆï¼Œæˆ‘ä»¬è¦æž„é€ ä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯åˆ¤æ–­å¯¹è±¡ä¸­å¿ƒæ˜¯å¦åœ¨æ ¼å­å†…ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯åˆ¤æ–­ä¸¤ä¸ªåŒ…å›´ç›’æ˜¯å¦ç›¸äº¤ã€‚ åˆ¤æ–­å¯¹è±¡ä¸­å¿ƒæ˜¯å¦åœ¨æ ¼å­å†…å¾ˆç®€å•ï¼Œåªè¦åˆ¤æ–­ä¸­å¿ƒç‚¹çš„ x å’Œ z æ˜¯å¦å¤§äºŽåŒ…å›´ç›’æœ€å°å€¼å¹¶ä¸”å°äºŽåŒ…å›´ç›’æœ€å¤§å€¼å³å¯ã€‚ ä¸­å¿ƒç‚¹æ£€æµ‹123456789101112/** * æ£€æµ‹æ˜¯å¦åœ¨åŒ…å›´ç›’å†… * @param rect * @returns */ private checkInAreaStrict(rect: RectBean, child: RectBean) &#123; if (rect.minX &gt; child.minX &amp;&amp; rect.maxX &lt; child.maxX &amp;&amp; rect.minZ &gt; child.minZ &amp;&amp; rect.maxZ &lt; child.maxZ) &#123; return true; &#125; return false; &#125; æ£€æµ‹åŒ…å›´ç›’æ˜¯å¦ç›¸äº¤çš„æ—¶å€™åªè¦åˆ¤æ–­åŒ…å›´ç›’ A çš„æœ€å¤§å€¼æ˜¯å¦å°äºŽåŒ…å›´ç›’ B çš„æœ€å°å€¼æˆ–è€…åŒ…å›´ç›’ A çš„æœ€å°å€¼æ˜¯å¦å¤§äºŽåŒ…å›´ç›’ B çš„æœ€å¤§å€¼ï¼Œè¿™ç§æƒ…å†µä¸‹ä¸¤åŒ…å›´ç›’å¿…å®šä¸ç›¸äº¤ã€‚è¿™ç§æ–¹æ³•å³ AABBï¼ˆAxially Aligned Bounding Boxï¼ŒæŒ‰åæ ‡è½´æŽ’åˆ—çš„åŒ…å›´ç›’ï¼‰æ£€æµ‹ã€‚ AABBç›¸äº¤æ£€æµ‹123456789101112131415/** * æ£€æµ‹æ˜¯å¦ç›¸äº¤ * @param rect * @param child * @returns */ private checkIntractive(rect: RectBean, child: RectBean) &#123; if (rect.maxX &lt; child.minX || rect.minX &gt; child.maxX || rect.maxZ &lt; child.minZ || rect.minZ &gt; child.maxZ) &#123; return false; &#125; return true; &#125; å››å‰æ ‘æ’å…¥é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆåˆ¤æ–­æ˜¯å¦éœ€è¦æ‹“å±•å­èŠ‚ç‚¹ï¼Œå°±æŒ‰ç…§ä¸Šé¢è¯´çš„ï¼Œåœ¨ä¸å­˜åœ¨å­èŠ‚ç‚¹å¹¶ä¸”æ˜¯æ ¹èŠ‚ç‚¹ï¼Œæˆ–è€…å½“å‰èŠ‚ç‚¹å¯¹è±¡æ•°é‡è¶…å‡ºé™åˆ¶æ•°é‡å¹¶ä¸”å½“å‰èŠ‚ç‚¹æ·±åº¦ä¸æ˜¯æœ€å¤§æ·±åº¦çš„æ—¶å€™æ‹“å±•ã€‚ ç„¶åŽæˆ‘ä»¬æ ¹æ®è§„åˆ™æŠŠå¯¹è±¡æ’å…¥åˆ°å››å‰æ ‘ä¸­å³å¯ã€‚å…ˆåˆ¤æ–­å¯¹è±¡æ˜¯å¦å¯ä»¥æ’å…¥å½“å‰æ ¼ï¼Œç„¶åŽåˆ¤æ–­å½“å‰æ ¼æœ‰æ— å­èŠ‚ç‚¹ï¼Œæœ‰å­èŠ‚ç‚¹å°½é‡æŠŠå¯¹è±¡æ’å…¥å­èŠ‚ç‚¹ï¼ŒåŒæ—¶æ ‡è®°å½“å‰æ ¼ï¼ˆå¦‚æžœæœ‰å­èŠ‚ç‚¹çš„è¯ä¹ŸåŒ…æ‹¬å­èŠ‚ç‚¹ï¼‰å­˜å‚¨çš„å¯¹è±¡æ•°é‡ã€‚ æ’å…¥123456789101112131415161718192021222324252627282930313233343536373839/** * æ’å…¥å¯¹è±¡ * @param obj * @returns */public insert(obj: QtreeObj) &#123; //åˆ¤æ–­æ˜¯å¦åˆ›å»ºå­èŠ‚ç‚¹ if (!this._childDic[&quot;tl&quot;] &amp;&amp; (this._depth == 0 || this._objCount &gt;= this._belongTree._maxObjCount &amp;&amp; this._depth &lt; this._belongTree._maxDepth)) &#123; this.createChild(); //å¡«å……å¯¹è±¡åˆ°æ–°åˆ›å»ºçš„å­èŠ‚ç‚¹ä¸­ for (let i = this._objList.length - 1; i &gt;= 0; i--) &#123; //éåŽ†å­èŠ‚ç‚¹ for (let prop in this._childDic) &#123; //å¯¹è±¡æ»¡è¶³å­èŠ‚ç‚¹æ¡ä»¶çš„ï¼Œæ’å…¥åˆ°å­èŠ‚ç‚¹ä¸­ if (this.checkInAreaStrict(this._objList[i].rect, this._childDic[prop]._bound)) &#123; this._childDic[prop].insert(this._objList[i]); this._objList.splice(i, 1); break; &#125; &#125; &#125; &#125; if (this._childDic[&quot;tl&quot;]) &#123; //å°½å¯èƒ½åœ°åˆ†åˆ°å­èŠ‚ç‚¹ for (let key in this._childDic) &#123; if (this.checkInAreaStrict(obj.rect, this._childDic[key]._bound)) &#123; this._objCount++; return this._childDic[key].insert(obj); &#125; &#125; &#125; this._objList.push(obj); ++this._objCount; return this;&#125; å››å‰æ ‘ç§»é™¤å››å‰æ ‘çš„ç§»é™¤å’Œæ’å…¥ç±»ä¼¼ï¼Œæ¯ä¸ªæŸ¥æ‰¾åˆ°çš„èŠ‚ç‚¹éƒ½å’Œéœ€è¦ç§»é™¤çš„å¯¹è±¡è¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æžœè¯¥èŠ‚ç‚¹æ²¡æœ‰éœ€è¦ç§»é™¤çš„å¯¹è±¡ï¼Œå°±è¿›å…¥åˆ°å­èŠ‚ç‚¹åŽ»ç»§ç»­æŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°æˆ–è€…æœ€å¤§æ·±åº¦ã€‚ç§»é™¤ä¹‹åŽè¦å¯¹æ’å…¥è¯¥å¯¹è±¡çš„æ¯ä¸€å±‚çš„å¯¹è±¡æ•°é‡è¿›è¡Œå‡ 1ã€‚å¦‚æžœå››ä¸ªå­èŠ‚ç‚¹çš„å¯¹è±¡æ•°é‡éƒ½ä¸º 0 çš„æƒ…å†µä¸‹ï¼Œçˆ¶èŠ‚ç‚¹å¯ä»¥è¿›è¡Œåç¼©ï¼Œå³ç§»é™¤å››ä¸ªå­èŠ‚ç‚¹ã€‚ ç§»é™¤12345678910111213141516171819202122232425262728293031/** * ç§»é™¤å¯¹è±¡ * @param obj * @returns */public remove(obj: QtreeObj) &#123; //çˆ¶èŠ‚ç‚¹åç¼© if (this._parent._objCount &lt;= 0) &#123; this._parent._childDic = &#123;&#125;; &#125; //éåŽ†ç§»é™¤ for (let i = this._objList.length - 1; i &gt;= 0; i--) &#123; //æ¯”è¾ƒå¯¹è±¡idæ˜¯å¦ç›¸ç­‰ï¼Œè¯¥æ¡ä»¶å¯æ ¹æ®éœ€è¦è‡ªè¡Œä¿®æ”¹ if (this._objList[i].objId == obj.objId) &#123; this._objList.splice(i, 1); this._objCount--; return; &#125; &#125; //å¦‚æžœå½“å‰èŠ‚ç‚¹æ²¡æœ‰åŒ¹é…å¯¹è±¡ï¼Œåˆ™éåŽ†å­èŠ‚ç‚¹å¯»æ‰¾éœ€è¦ç§»é™¤çš„å¯¹è±¡ if (this._childDic[&quot;tl&quot;]) &#123; for (let key in this._childDic) &#123; if (this.checkInAreaStrict(obj.rect, this._childDic[key]._bound)) &#123; this._childDic[key].remove(obj); this._objCount--; return; &#125; &#125; &#125;&#125; å››å‰æ ‘æŸ¥æ‰¾æŽ¥ä¸‹æ¥æ˜¯å››å‰æ ‘çš„æŸ¥æ‰¾ï¼Œå››å‰æ ‘çš„æŸ¥æ‰¾å¯ä»¥åªæŸ¥æ‰¾å½“å‰æºå¯¹è±¡æ‰€åœ¨çš„åŒºå—ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥è¿›ä¸€æ­¥ç­›é€‰å’Œæºå¯¹è±¡ç›¸äº¤çš„å¯¹è±¡ï¼Œå³æ£€æµ‹ä¸ŽæŸ¥æ‰¾èŒƒå›´åŒ…å›´ç›’ç›¸äº¤çš„å¯¹è±¡ã€‚æœ¬æ¡ˆä¾‹é‡‡å–è¿›ä¸€æ­¥ç­›é€‰çš„æ¨¡å¼ã€‚ åœ¨å››å‰æ ‘éåŽ†çš„è¿‡ç¨‹ä¸­ï¼Œå…ˆå¯¹æ¯ä¸ªèŠ‚ç‚¹çš„å¯¹è±¡è¿›è¡Œç›¸äº¤æ£€æµ‹ï¼Œç›¸äº¤çš„ç‰©ä½“åŠ å…¥æŸ¥æ‰¾ç»“æžœæ•°ç»„ã€‚ç„¶åŽå¯¹äºŽæ¯ä¸ªå­èŠ‚ç‚¹ï¼Œæˆ‘ä»¬éƒ½è¦æ¯”è¾ƒæºå¯¹è±¡çš„èŒƒå›´å’Œå­èŠ‚ç‚¹çš„æ¾æ•£åŒ…å›´ç›’æ˜¯å¦ç›¸äº¤ã€‚ç”±äºŽæ¯ä¸ªå­èŠ‚ç‚¹éƒ½æœ‰å¯èƒ½å’Œæºå¯¹è±¡äº¤æ±‡ï¼Œ å› æ­¤å››ä¸ªå­èŠ‚ç‚¹éƒ½è¦è¿›è¡Œåˆ¤æ–­ã€‚ æŸ¥æ‰¾1234567891011121314151617181920/** * æŸ¥æ‰¾èŒƒå›´å†…æ‰€æœ‰èŠ‚ç‚¹ * @param rect */public findObjFromRect(rect: RectBean): QtreeObj[] &#123; let objs = []; //æŸ¥æ‰¾åŒ¹é…å¯¹è±¡ for (let key in this._objList) &#123; if (this.checkIntractive(rect, this._objList[key].rect)) &#123; objs.push(this._objList[key]); &#125; &#125; //éåŽ†å­èŠ‚ç‚¹ for (let key in this._childDic) &#123; if (this._childDic[key].checkIntractive(rect, this._childDic[key]._looseBound)) &#123; objs = objs.concat(this._childDic[key].findObjFromRect(rect)); &#125; &#125; return objs;&#125; å››å‰æ ‘åŠ¨æ€æ›´æ–°å››å‰æ ‘èŠ‚ç‚¹çš„æ›´æ–°ä¹Ÿå¾ˆç®€å•ã€‚å…·ä½“çš„é€»è¾‘å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š æ›´æ–°12345678910111213/** * åˆ·æ–°å¯¹è±¡åœ¨å››å‰æ ‘ä¸­çš„ä½ç½® * @param obj * @returns */public refresh(obj: QtreeObj) &#123; if (this.checkInAreaStrict(obj.rect, this._bound)) &#123; return this; &#125; else &#123; this.remove(obj); return this._belongTree.insert(obj); &#125;&#125; ä»£ç åŒ…å›´ç›’æ•°æ®ç»“æž„1234567891011121314151617181920export default class RectBean &#123; constructor(x?, z?, w?, h?, maxX?, minX?, maxZ?, minZ?) &#123; this.x = x; this.z = z; this.w = w; this.h = h; this.maxX = maxX; this.minX = minX; this.maxZ = maxZ; this.minZ = minZ; &#125; public x; public z; public w; //å®½ -- xæ–¹å‘ public h; //é«˜ -- zæ–¹å‘ public maxX; public minX; public maxZ; public minZ;&#125; å››å‰æ ‘å¯¹è±¡æ•°æ®ç»“æž„123456789101112131415161718import &#123; BoxCollider &#125; from &quot;../../../../../libs/Collider&quot;;export default class QtreeObj &#123; constructor(id?, objId?, rect?, node?) &#123; this.id = id; this.objId = objId; this.rect = rect; this.node = node; &#125; /** id ä¸€èˆ¬åªéœ€è¦è¿™ä¸ªå°±å¤Ÿäº† å¿…è¦å±žæ€§ */ public id: number; /** å¯¹è±¡id æ­¤å¤„ä¸ºé¡¹ç›®éœ€è¦è€Œå¢žåŠ çš„id */ public objId: number; /** èŒƒå›´ å¿…è¦å±žæ€§ */ public rect; /** èŠ‚ç‚¹ å¿…è¦å±žæ€§ */ public node: Laya.Sprite3D;&#125; å››å‰æ ‘è„šæœ¬12345678910111213141516171819202122232425262728293031import QtreeObj from &quot;./Bean/QtreeObj&quot;;import Qnode from &quot;./Qnode&quot;;export default class Qtree &#123; public _maxDepth = 0; public _maxObjCount = 0; public _bound = &#123;&#125;; /** å­èŠ‚ç‚¹ */ public _root: Qnode; constructor(bound, maxDepth, maxObjCount) &#123; this._bound = bound; this._maxDepth = maxDepth; this._maxObjCount = maxObjCount; this._root = new Qnode(bound, 0, this, this); &#125; public insert(obj: QtreeObj): void &#123; return this._root.insert(obj); &#125; public remove(obj: QtreeObj) &#123; this._root.remove(obj); &#125; public findObjFromRect(rect): QtreeObj[] &#123; return this._root.findObjFromRect(rect); &#125;&#125; å››å‰æ ‘èŠ‚ç‚¹è„šæœ¬123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348import ModelFactory from &quot;../../Common/ModelFactory&quot;;import QtreeObj from &quot;./Bean/QtreeObj&quot;;import RectBean from &quot;./Bean/RectBean&quot;;import Qtree from &quot;./Qtree&quot;;export default class Qnode &#123; /** åŒ…å›´ç›’ */ public _bound: &#123; x; z; w; h; maxX; minX; maxZ; minZ &#125;; /** å®½æ¾åŒ…å›´ç›’ */ public _looseBound: any = &#123;&#125;; /** çˆ¶èŠ‚ç‚¹ */ public _parent: Qnode; /** æ‰€å±žå››å‰æ ‘ */ public _belongTree: Qtree; /** å¯¹è±¡åˆ—è¡¨ */ public _objList = []; /** å­èŠ‚ç‚¹å­—å…¸ */ public _childDic = &#123;&#125;; /** æ·±åº¦ */ public _depth: number; /** å¯¹è±¡æ•°é‡ */ public _objCount = 0; private _debugColor: Laya.Color = new Laya.Color(1, 0, 0, 1); private _debugColor2: Laya.Color = new Laya.Color(0, 1, 1, 1); private _debugView: Laya.PixelLineSprite3D; constructor(bound, depth, parent, belongTree) &#123; this._bound = bound; this._depth = depth; this._parent = parent; this._belongTree = belongTree; this._looseBound = &#123; x: bound.x, z: bound.z, w: bound.w * 2, h: bound.h * 2, maxX: bound.x + bound.w, minX: bound.x - bound.w, maxZ: bound.z + bound.h, minZ: bound.z - bound.h, &#125;; //ç»˜åˆ¶å››å‰æ ‘èŒƒå›´ // this.showDebugMode(); &#125; /** * ç»˜åˆ¶å››å‰æ ‘èŒƒå›´ Layaç‰ˆæœ¬ * @param loose æ˜¯å¦ç»˜åˆ¶æ¾æ•£èŒƒå›´ */ private showDebugMode(loose?) &#123; Laya.timer.once(1000, this, () =&gt; &#123; //åœºæ™¯ä¸­æ’å…¥çº¿æ®µ this._debugView = new Laya.PixelLineSprite3D(99999); ModelFactory.getScene().addChild(this._debugView); for (let t = this._debugView.lineCount - 1; t &gt;= 0; t--) this._debugView.removeLine(t); //ç´§å‡‘å››å‰æ ‘ this._debugView.addLine( new Laya.Vector3(this._bound.maxX, 0.1, this._bound.maxZ), new Laya.Vector3(this._bound.maxX, 0.1, this._bound.minZ), this._debugColor, this._debugColor ); this._debugView.addLine( new Laya.Vector3(this._bound.minX, 0.1, this._bound.maxZ), new Laya.Vector3(this._bound.minX, 0.1, this._bound.minZ), this._debugColor, this._debugColor ); this._debugView.addLine( new Laya.Vector3(this._bound.maxX, 0.1, this._bound.maxZ), new Laya.Vector3(this._bound.minX, 0.1, this._bound.maxZ), this._debugColor, this._debugColor ); this._debugView.addLine( new Laya.Vector3(this._bound.maxX, 0.1, this._bound.minZ), new Laya.Vector3(this._bound.minX, 0.1, this._bound.minZ), this._debugColor, this._debugColor ); if (loose) &#123; //æ¾æ•£å››å‰æ ‘ this._debugView.addLine( new Laya.Vector3(this._looseBound.maxX, 0.1, this._looseBound.maxZ), new Laya.Vector3(this._looseBound.maxX, 0.1, this._looseBound.minZ), this._debugColor2, this._debugColor2 ); this._debugView.addLine( new Laya.Vector3(this._looseBound.minX, 0.1, this._looseBound.maxZ), new Laya.Vector3(this._looseBound.minX, 0.1, this._looseBound.minZ), this._debugColor2, this._debugColor2 ); this._debugView.addLine( new Laya.Vector3(this._looseBound.maxX, 0.1, this._looseBound.maxZ), new Laya.Vector3(this._looseBound.minX, 0.1, this._looseBound.maxZ), this._debugColor2, this._debugColor2 ); this._debugView.addLine( new Laya.Vector3(this._looseBound.maxX, 0.1, this._looseBound.minZ), new Laya.Vector3(this._looseBound.minX, 0.1, this._looseBound.minZ), this._debugColor2, this._debugColor2 ); &#125; &#125;); &#125; /** * æ’å…¥å¯¹è±¡ * @param obj * @returns */ public insert(obj: QtreeObj) &#123; //åˆ¤æ–­æ˜¯å¦åˆ›å»ºå­èŠ‚ç‚¹ if ( !this._childDic[&quot;tl&quot;] &amp;&amp; (this._depth == 0 || (this._objCount &gt;= this._belongTree._maxObjCount &amp;&amp; this._depth &lt; this._belongTree._maxDepth)) ) &#123; this.createChild(); //å¡«å……å¯¹è±¡åˆ°æ–°åˆ›å»ºçš„å­èŠ‚ç‚¹ä¸­ for (let i = this._objList.length - 1; i &gt;= 0; i--) &#123; //éåŽ†å­èŠ‚ç‚¹ for (let prop in this._childDic) &#123; //å¯¹è±¡æ»¡è¶³å­èŠ‚ç‚¹æ¡ä»¶çš„ï¼Œæ’å…¥åˆ°å­èŠ‚ç‚¹ä¸­ if ( this.checkInAreaStrict( this._objList[i].rect, this._childDic[prop]._bound ) ) &#123; this._childDic[prop].insert(this._objList[i]); this._objList.splice(i, 1); break; &#125; &#125; &#125; &#125; if (this._childDic[&quot;tl&quot;]) &#123; //å°½å¯èƒ½åœ°åˆ†åˆ°å­èŠ‚ç‚¹ for (let key in this._childDic) &#123; if (this.checkInAreaStrict(obj.rect, this._childDic[key]._bound)) &#123; this._objCount++; return this._childDic[key].insert(obj); &#125; &#125; &#125; this._objList.push(obj); ++this._objCount; return this; &#125; /** * ç§»é™¤å¯¹è±¡ * @param obj * @returns */ public remove(obj: QtreeObj) &#123; //çˆ¶èŠ‚ç‚¹åç¼© if (this._parent._objCount &lt;= 0) &#123; this._parent._childDic = &#123;&#125;; &#125; //éåŽ†ç§»é™¤ for (let i = this._objList.length - 1; i &gt;= 0; i--) &#123; //æ¯”è¾ƒå¯¹è±¡idæ˜¯å¦ç›¸ç­‰ï¼Œè¯¥æ¡ä»¶å¯æ ¹æ®éœ€è¦è‡ªè¡Œä¿®æ”¹ if (this._objList[i].objId == obj.objId) &#123; this._objList.splice(i, 1); this._objCount--; return; &#125; &#125; //å¦‚æžœå½“å‰èŠ‚ç‚¹æ²¡æœ‰åŒ¹é…å¯¹è±¡ï¼Œåˆ™éåŽ†å­èŠ‚ç‚¹å¯»æ‰¾éœ€è¦ç§»é™¤çš„å¯¹è±¡ if (this._childDic[&quot;tl&quot;]) &#123; for (let key in this._childDic) &#123; if (this.checkInAreaStrict(obj.rect, this._childDic[key]._bound)) &#123; this._childDic[key].remove(obj); this._objCount--; return; &#125; &#125; &#125; &#125; /** * æŸ¥æ‰¾èŒƒå›´å†…æ‰€æœ‰èŠ‚ç‚¹ * @param rect */ public findObjFromRect(rect: RectBean): QtreeObj[] &#123; let objs = []; //æŸ¥æ‰¾åŒ¹é…å¯¹è±¡ for (let key in this._objList) &#123; if (this.checkIntractive(rect, this._objList[key].rect)) &#123; objs.push(this._objList[key]); &#125; &#125; //éåŽ†å­èŠ‚ç‚¹ for (let key in this._childDic) &#123; if ( this._childDic[key].checkIntractive( rect, this._childDic[key]._looseBound ) ) &#123; objs = objs.concat(this._childDic[key].findObjFromRect(rect)); &#125; &#125; return objs; &#125; /** * åˆ·æ–°å¯¹è±¡åœ¨å››å‰æ ‘ä¸­çš„ä½ç½® * @param obj * @returns */ public refresh(obj: QtreeObj) &#123; if (this.checkInAreaStrict(obj.rect, this._bound)) &#123; return this; &#125; else &#123; this.remove(obj); return this._belongTree.insert(obj); &#125; &#125; /** * åˆ›å»ºå­èŠ‚ç‚¹ */ private createChild() &#123; let bound1 = &#123; x: this._bound.x + this._bound.w * 0.25, z: this._bound.z + this._bound.h * 0.25, w: this._bound.w * 0.5, h: this._bound.h * 0.5, maxX: this._bound.x + this._bound.w * 0.25 + this._bound.w * 0.25, minX: this._bound.x + this._bound.w * 0.25 - this._bound.w * 0.25, maxZ: this._bound.z + this._bound.h * 0.25 + this._bound.h * 0.25, minZ: this._bound.z + this._bound.h * 0.25 - this._bound.h * 0.25, &#125;; this._childDic[&quot;tl&quot;] = new Qnode( bound1, this._depth + 1, this._parent, this._belongTree ); let bound2 = &#123; x: this._bound.x - this._bound.w * 0.25, z: this._bound.z + this._bound.h * 0.25, w: this._bound.w * 0.5, h: this._bound.h * 0.5, maxX: this._bound.x - this._bound.w * 0.25 + this._bound.w * 0.25, minX: this._bound.x - this._bound.w * 0.25 - this._bound.w * 0.25, maxZ: this._bound.z + this._bound.h * 0.25 + this._bound.h * 0.25, minZ: this._bound.z + this._bound.h * 0.25 - this._bound.h * 0.25, &#125;; this._childDic[&quot;tr&quot;] = new Qnode( bound2, this._depth + 1, this._parent, this._belongTree ); let bound3 = &#123; x: this._bound.x + this._bound.w * 0.25, z: this._bound.z - this._bound.h * 0.25, w: this._bound.w * 0.5, h: this._bound.h * 0.5, maxX: this._bound.x + this._bound.w * 0.25 + this._bound.w * 0.25, minX: this._bound.x + this._bound.w * 0.25 - this._bound.w * 0.25, maxZ: this._bound.z - this._bound.h * 0.25 + this._bound.h * 0.25, minZ: this._bound.z - this._bound.h * 0.25 - this._bound.h * 0.25, &#125;; this._childDic[&quot;bl&quot;] = new Qnode( bound3, this._depth + 1, this._parent, this._belongTree ); let bound4 = &#123; x: this._bound.x - this._bound.w * 0.25, z: this._bound.z - this._bound.h * 0.25, w: this._bound.w * 0.5, h: this._bound.h * 0.5, maxX: this._bound.x - this._bound.w * 0.25 + this._bound.w * 0.25, minX: this._bound.x - this._bound.w * 0.25 - this._bound.w * 0.25, maxZ: this._bound.z - this._bound.h * 0.25 + this._bound.h * 0.25, minZ: this._bound.z - this._bound.h * 0.25 - this._bound.h * 0.25, &#125;; this._childDic[&quot;br&quot;] = new Qnode( bound4, this._depth + 1, this._parent, this._belongTree ); &#125; /** * æ£€æµ‹æ˜¯å¦åœ¨åŒ…å›´ç›’å†… * @param rect * @returns */ private checkInAreaStrict(rect: RectBean, child: RectBean) &#123; if ( rect.minX &gt; child.minX &amp;&amp; rect.maxX &lt; child.maxX &amp;&amp; rect.minZ &gt; child.minZ &amp;&amp; rect.maxZ &lt; child.maxZ ) &#123; return true; &#125; return false; &#125; /** * æ£€æµ‹æ˜¯å¦ç›¸äº¤ * @param rect * @param child * @returns */ private checkIntractive(rect: RectBean, child: RectBean) &#123; if ( rect.maxX &lt; child.minX || rect.minX &gt; child.maxX || rect.maxZ &lt; child.minZ || rect.minZ &gt; child.maxZ ) &#123; return false; &#125; return true; &#125;&#125;","categories":[{"name":"Laya","slug":"Laya","permalink":"https://busyogg.github.io/categories/Laya/"},{"name":"å·¥å…·","slug":"Laya/å·¥å…·","permalink":"https://busyogg.github.io/categories/Laya/%E5%B7%A5%E5%85%B7/"}],"tags":[{"name":"Laya","slug":"Laya","permalink":"https://busyogg.github.io/tags/Laya/"},{"name":"Typescript","slug":"Typescript","permalink":"https://busyogg.github.io/tags/Typescript/"},{"name":"å·¥å…·","slug":"å·¥å…·","permalink":"https://busyogg.github.io/tags/%E5%B7%A5%E5%85%B7/"},{"name":"å››å‰æ ‘","slug":"å››å‰æ ‘","permalink":"https://busyogg.github.io/tags/%E5%9B%9B%E5%8F%89%E6%A0%91/"},{"name":"ç©ºé—´ç®¡ç†","slug":"ç©ºé—´ç®¡ç†","permalink":"https://busyogg.github.io/tags/%E7%A9%BA%E9%97%B4%E7%AE%A1%E7%90%86/"}]},{"title":"åŸºäºŽIPçš„SSLè¯ä¹¦ç­¾å‘","slug":"åŸºäºŽIPçš„SSLè¯ä¹¦ç­¾å‘","date":"2023-09-09T20:37:36.000Z","updated":"2024-05-18T15:40:08.395Z","comments":true,"path":"article/e01680050386/","link":"","permalink":"https://busyogg.github.io/article/e01680050386/","excerpt":"","text":"é‡è¦ä¿¡æ¯çŽ°åœ¨æœ¬æ–¹æ³•åŸºæœ¬å¤±æ•ˆäº†ï¼Œå› ä¸ºå…è´¹è¯ä¹¦æœ‰æ•°é‡ä¸Šé™å¹¶ä¸”å·²è¿‡æœŸè¯ä¹¦æ— æ³•åˆ é™¤ã€‚ ç®€ä»‹ç½‘ä¸Šå¤§éƒ¨åˆ† SSL è¯ä¹¦éƒ½éœ€è¦åŸŸåæ¥ç­¾å‘ï¼Œè¿™é‡Œæ‰¾åˆ°ä¸€ä¸ªå¯ä»¥ç”¨ IP æ¥ç­¾å‘çš„ SSL è¯ä¹¦ç”³è¯·ã€‚ ç½‘å€ZeroSSLhttps://app.zerossl.com/ ä½¿ç”¨è¯´æ˜Ž ç”±äºŽæ²¡æœ‰ä½¿ç”¨è¿‡é‚®ä»¶éªŒè¯ï¼Œå› æ­¤ä¸æä¾›å…·ä½“æ–¹æ³•ã€‚ å¦‚æžœé€‰æ‹© CNAME éªŒè¯ï¼Œåˆ™åˆ° DNS ç®¡ç†å¡«å…¥ CNAME ç»™çš„å‚æ•°ï¼Œæ­¤å¤„ä»¥ Cloudflare ä¸¾ä¾‹ å¦‚æžœé€‰ HTTP éªŒè¯ nginx ä»£ç†å¯ä»¥è‡ªè¡Œæœç´¢ linux nginx è®¿é—®æœ¬åœ°æ–‡ä»¶ è¯ä¹¦ç­¾å‘åŽæˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦å®‰è£…è¯ä¹¦ ç„¶åŽé€‰æ‹©å¯¹åº”çš„ç±»åž‹æ ¹æ®æç¤ºè¿›è¡Œå®‰è£…","categories":[{"name":"åˆ†äº«","slug":"åˆ†äº«","permalink":"https://busyogg.github.io/categories/%E5%88%86%E4%BA%AB/"}],"tags":[{"name":"SSLè¯ä¹¦","slug":"SSLè¯ä¹¦","permalink":"https://busyogg.github.io/tags/SSL%E8%AF%81%E4%B9%A6/"}]},{"title":"CloudflareåŠ é€Ÿgithubè®¿é—®","slug":"CloudflareåŠ é€Ÿgithubè®¿é—®","date":"2023-09-09T19:27:19.000Z","updated":"2024-05-18T15:38:05.247Z","comments":true,"path":"article/ae66b10eef2c/","link":"","permalink":"https://busyogg.github.io/article/ae66b10eef2c/","excerpt":"","text":"ç®€ä»‹åˆ©ç”¨ Cloudflare ä»£ç†è®¿é—® GitHub åœ°å€ï¼ŒåŒç†å¯åº”ç”¨äºŽå…¶ä»–ç½‘å€ã€‚ å‡†å¤‡ Cloudflare è´¦å· åŸŸåï¼ˆè‡ªè¡Œæ³¨å†Œï¼‰ å®žçŽ°æ–¹æ³• ç™»å½• Cloudflareï¼ŒæŠŠä½ çš„åŸŸåæ·»åŠ åˆ° Cloudflareã€‚ å¤„ç†åŸŸåçš„ DNS æ–°å¢ž Woker worker ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194&quot;use strict&quot;;/** * static files (404.html, sw.js, conf.js) */const ASSET_URL = &quot;https://åŸŸå/&quot;;// å‰ç¼€ï¼Œå¦‚æžœè‡ªå®šä¹‰è·¯ç”±ä¸ºexample.com/gh/*ï¼Œå°†PREFIXæ”¹ä¸º &#x27;/gh/&#x27;ï¼Œæ³¨æ„ï¼Œå°‘ä¸€ä¸ªæ éƒ½ä¼šé”™ï¼const PREFIX = &quot;/&quot;;// åˆ†æ”¯æ–‡ä»¶ä½¿ç”¨jsDelivré•œåƒçš„å¼€å…³ï¼Œ0ä¸ºå…³é—­ï¼Œé»˜è®¤å…³é—­const Config = &#123; jsdelivr: 0,&#125;;const whiteList = []; // ç™½åå•ï¼Œè·¯å¾„é‡Œé¢æœ‰åŒ…å«å­—ç¬¦çš„æ‰ä¼šé€šè¿‡ï¼Œe.g. [&#x27;/username/&#x27;]/** @type &#123;RequestInit&#125; */const PREFLIGHT_INIT = &#123; status: 204, headers: new Headers(&#123; &quot;access-control-allow-origin&quot;: &quot;*&quot;, &quot;access-control-allow-methods&quot;: &quot;GET,POST,PUT,PATCH,TRACE,DELETE,HEAD,OPTIONS&quot;, &quot;access-control-max-age&quot;: &quot;1728000&quot;, &#125;),&#125;;const exp1 = /^(?:https?:\\/\\/)?github\\.com\\/.+?\\/.+?\\/(?:releases|archive)\\/.*$/i;const exp2 = /^(?:https?:\\/\\/)?github\\.com\\/.+?\\/.+?\\/(?:blob|raw)\\/.*$/i;const exp3 = /^(?:https?:\\/\\/)?github\\.com\\/.+?\\/.+?\\/(?:info|git-).*$/i;const exp4 = /^(?:https?:\\/\\/)?raw\\.(?:githubusercontent|github)\\.com\\/.+?\\/.+?\\/.+?\\/.+$/i;const exp5 = /^(?:https?:\\/\\/)?gist\\.(?:githubusercontent|github)\\.com\\/.+?\\/.+?\\/.+$/i;const exp6 = /^(?:https?:\\/\\/)?github\\.com\\/.+?\\/.+?\\/tags.*$/i;/** * @param &#123;any&#125; body * @param &#123;number&#125; status * @param &#123;Object&lt;string, string&gt;&#125; headers */function makeRes(body, status = 200, headers = &#123;&#125;) &#123; headers[&quot;access-control-allow-origin&quot;] = &quot;*&quot;; return new Response(body, &#123; status, headers &#125;);&#125;/** * @param &#123;string&#125; urlStr */function newUrl(urlStr) &#123; try &#123; return new URL(urlStr); &#125; catch (err) &#123; return null; &#125;&#125;addEventListener(&quot;fetch&quot;, (e) =&gt; &#123; const ret = fetchHandler(e).catch((err) =&gt; makeRes(&quot;cfworker error:\\n&quot; + err.stack, 502) ); e.respondWith(ret);&#125;);function checkUrl(u) &#123; for (let i of [exp1, exp2, exp3, exp4, exp5, exp6]) &#123; if (u.search(i) === 0) &#123; return true; &#125; &#125; return false;&#125;/** * @param &#123;FetchEvent&#125; e */async function fetchHandler(e) &#123; const req = e.request; const urlStr = req.url; const urlObj = new URL(urlStr); let path = urlObj.searchParams.get(&quot;q&quot;); if (path) &#123; return Response.redirect(&quot;https://&quot; + urlObj.host + PREFIX + path, 301); &#125; // cfworker ä¼šæŠŠè·¯å¾„ä¸­çš„ `//` åˆå¹¶æˆ `/` path = urlObj.href .substr(urlObj.origin.length + PREFIX.length) .replace(/^https?:\\/+/, &quot;https://&quot;); if ( path.search(exp1) === 0 || path.search(exp5) === 0 || path.search(exp6) === 0 || path.search(exp3) === 0 || path.search(exp4) === 0 ) &#123; return httpHandler(req, path); &#125; else if (path.search(exp2) === 0) &#123; if (Config.jsdelivr) &#123; const newUrl = path .replace(&quot;/blob/&quot;, &quot;@&quot;) .replace(/^(?:https?:\\/\\/)?github\\.com/, &quot;https://cdn.jsdelivr.net/gh&quot;); return Response.redirect(newUrl, 302); &#125; else &#123; path = path.replace(&quot;/blob/&quot;, &quot;/raw/&quot;); return httpHandler(req, path); &#125; &#125; else if (path.search(exp4) === 0) &#123; const newUrl = path .replace(/(?&lt;=com\\/.+?\\/.+?)\\/(.+?\\/)/, &quot;@$1&quot;) .replace( /^(?:https?:\\/\\/)?raw\\.(?:githubusercontent|github)\\.com/, &quot;https://cdn.jsdelivr.net/gh&quot; ); return Response.redirect(newUrl, 302); &#125; else &#123; return fetch(ASSET_URL + path); &#125;&#125;/** * @param &#123;Request&#125; req * @param &#123;string&#125; pathname */function httpHandler(req, pathname) &#123; const reqHdrRaw = req.headers; // preflight if ( req.method === &quot;OPTIONS&quot; &amp;&amp; reqHdrRaw.has(&quot;access-control-request-headers&quot;) ) &#123; return new Response(null, PREFLIGHT_INIT); &#125; const reqHdrNew = new Headers(reqHdrRaw); let urlStr = pathname; let flag = !Boolean(whiteList.length); for (let i of whiteList) &#123; if (urlStr.includes(i)) &#123; flag = true; break; &#125; &#125; if (!flag) &#123; return new Response(&quot;blocked&quot;, &#123; status: 403 &#125;); &#125; if (urlStr.startsWith(&quot;github&quot;)) &#123; urlStr = &quot;https://&quot; + urlStr; &#125; const urlObj = newUrl(urlStr); /** @type &#123;RequestInit&#125; */ const reqInit = &#123; method: req.method, headers: reqHdrNew, redirect: &quot;manual&quot;, body: req.body, &#125;; return proxy(urlObj, reqInit);&#125;/** * * @param &#123;URL&#125; urlObj * @param &#123;RequestInit&#125; reqInit */async function proxy(urlObj, reqInit) &#123; const res = await fetch(urlObj.href, reqInit); const resHdrOld = res.headers; const resHdrNew = new Headers(resHdrOld); const status = res.status; if (resHdrNew.has(&quot;location&quot;)) &#123; let _location = resHdrNew.get(&quot;location&quot;); if (checkUrl(_location)) resHdrNew.set(&quot;location&quot;, PREFIX + _location); else &#123; reqInit.redirect = &quot;follow&quot;; return proxy(newUrl(_location), reqInit); &#125; &#125; resHdrNew.set(&quot;access-control-expose-headers&quot;, &quot;*&quot;); // resHdrNew.set(&#x27;access-control-allow-origin&#x27;, &#x27;*&#x27;) resHdrNew.delete(&quot;content-security-policy&quot;); resHdrNew.delete(&quot;content-security-policy-report-only&quot;); resHdrNew.delete(&quot;clear-site-data&quot;); return new Response(res.body, &#123; status, headers: resHdrNew, &#125;);&#125; è®¾ç½®è·¯ç”± ä¾‹å¦‚æˆ‘çš„è·¯ç”±ä¸º æ‰€æœ‰æ­¥éª¤å®ŒæˆåŽåŸºæœ¬ä¸Šå°±å¯ä»¥æ ¹æ®ä½ çš„åŸŸåè®¿é—® GitHub æ‰˜ç®¡çš„åšå®¢äº†ï¼Œå¦‚æžœæ²¡æœ‰æ•ˆæžœçš„è¯å¯èƒ½è¦ç­‰ Cloudflare åŸŸåæ¿€æ´»æˆ–è€…ç­‰ä¸€ä¼šå„¿ worker ç”Ÿæ•ˆ GitHub å›¾åºŠGitHub å›¾åºŠä¹Ÿå¯ä»¥ç”¨è¿™ä¸ª worker ä»£ç æ¥ä»£ç†ï¼Œæ–°å¢žä¸€ä¸ª workerï¼Œæ³¨æ„ github å›¾ç‰‡çš„ä»£ç†åœ°å€è¦å†™https://raw.githubusercontent.com/GitHubç”¨æˆ·å/å›¾åºŠä»“åº“å/åˆ†æ”¯å/ï¼Œæ ¹æ®ä¸ªäººæƒ…å†µè¿›è¡Œä¿®æ”¹ã€‚å¯ä»¥åœ¨åŸŸåä¸‹æ·»åŠ ä¸€ä¸ªè·¯ç”±ï¼Œæˆ‘æ˜¯ç”¨çš„æ˜¯img.busyo.buzz/*è¿›è¡Œè·¯ç”±ï¼Œç„¶åŽæ·»åŠ  img çš„ DNSï¼Œè®¿é—®å›¾ç‰‡åªè¦ä½¿ç”¨https://img.busyo.buzz/ä»“åº“ä¸­çš„å›¾ç‰‡è·¯å¾„å³å¯ã€‚ ä¾‹ï¼š 12345678910//ä»£ç†åœ°å€https://raw.githubusercontent.com/UserName/PictureReposity/main///ä»“åº“ç»“æž„PictureReposity|- picture|-- test.png//è®¿é—®åœ°å€https://domain.com/picture/test.png","categories":[{"name":"æ•™ç¨‹","slug":"æ•™ç¨‹","permalink":"https://busyogg.github.io/categories/%E6%95%99%E7%A8%8B/"}],"tags":[{"name":"æ•™ç¨‹","slug":"æ•™ç¨‹","permalink":"https://busyogg.github.io/tags/%E6%95%99%E7%A8%8B/"},{"name":"GitHub","slug":"GitHub","permalink":"https://busyogg.github.io/tags/GitHub/"},{"name":"ç½‘ç»œåŠ é€Ÿ","slug":"ç½‘ç»œåŠ é€Ÿ","permalink":"https://busyogg.github.io/tags/%E7%BD%91%E7%BB%9C%E5%8A%A0%E9%80%9F/"}]},{"title":"Hexoåšå®¢æ­å»º ç¾ŽåŒ–ç¯‡","slug":"Hexoåšå®¢æ­å»º-ç¾ŽåŒ–ç¯‡","date":"2023-09-01T00:07:42.000Z","updated":"2024-05-18T15:37:59.870Z","comments":true,"path":"article/38effc2a84e9/","link":"","permalink":"https://busyogg.github.io/article/38effc2a84e9/","excerpt":"","text":"ç®€ä»‹æœ¬ç½‘ç«™ä½¿ç”¨çš„æ˜¯ Volantis ä¸»é¢˜ï¼Œå¹¶å¯¹å…¶è¿›è¡Œäº†è‡ªå®šä¹‰æ”¹é€ ã€‚ å®‰è£…åœ¨ _config.yml æ–‡ä»¶ä¸­ä¿®æ”¹ä»¥ä¸‹é¡¹ç›® config.yml1theme: volantis ç„¶åŽé€šè¿‡ npm å®‰è£…ä¸»é¢˜æ–‡ä»¶ ä¸»é¢˜å®‰è£…1npm i hexo-theme-volantis å®‰è£…å®Œä¸»é¢˜åŽï¼Œåœ¨åšå®¢çš„æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ªæ–°çš„é…ç½®æ–‡ä»¶ _config.volantis.ymlï¼Œå¹¶ä¸”ä»Žä¸»é¢˜æ–‡ä»¶å¤¹ä¸­å¤åˆ¶é…ç½®æ–‡ä»¶çš„å†…å®¹è¿›æ¥ï¼Œä»¥ä¾¿ä¿®æ”¹é…ç½®ã€‚ å› ä¸ºæˆ‘ä»¬æ˜¯é€šè¿‡ npm æ–¹å¼å®‰è£…ï¼Œå› æ­¤ä¸»é¢˜é…ç½®æ–‡ä»¶åœ¨\\node_modules\\hexo-theme-volantis\\_config.yml è¯¥ä¸»é¢˜è‡ªå¸¦çš„æœç´¢åŠŸèƒ½éœ€è¦å®‰è£…é¢å¤–æ¨¡å— æœç´¢å®‰è£…1npm i -S hexo-generator-json-content ç„¶åŽä¿®æ”¹é…ç½®æ–‡ä»¶ _config.volantis.yml123search: enable: true service: hexo é…ç½®ä¸»é¢˜ä¸»é¢˜é…ç½®å¯ä»¥é˜…è¯»ä¸»é¢˜æ–‡æ¡£è¿›è¡Œå¯¹åº”çš„é…ç½®ã€‚ ä¸»é¢˜é…ç½®https://volantis.js.org/v6/theme-settings/ ä»¥ä¸‹ä¸ºæœ¬åšå®¢ä¸»è¦è°ƒèŠ‚çš„é…ç½® å¯¼èˆª_config.volantis.yml12345678910111213141516171819202122232425navbar: width: auto visiable: always # always, auto effect: [shadow, blur] # [shadow, floatable, blur] logo: # choose [img] or [icon + title] img: /images/img_logo.png #logoå›¾ç‰‡è·¯å¾„ icon: title: menu: - name: ä¸»é¡µ icon: fa-solid fa-rss url: / - name: åˆ†ç±» icon: fa-solid fa-folder-open url: categories/ - name: æ ‡ç­¾ icon: fa-solid fa-tags url: tags/ - name: å½’æ¡£ icon: fa-solid fa-archive url: archives/ - name: æš—é»‘æ¨¡å¼ # å¯è‡ªå®šä¹‰ icon: fa-solid fa-moon # å¯è‡ªå®šä¹‰ toggle: darkmode search: Search... # Search bar placeholder å¯¼èˆªæ–°å¢žäº†åˆ†ç±»å’Œæ ‡ç­¾ä¸¤ä¸ªæ ç›®ï¼Œä»¥åŠé»‘æš—æ¨¡å¼çš„åˆ‡æ¢æŒ‰é’® åˆ†ç±»å’Œæ ‡ç­¾ä½¿ç”¨ä»£ç åˆ›å»º 12hexo new page categorieshexo new page tags åˆ›å»ºå®ŒæˆåŽï¼Œæˆ‘ä»¬åˆ° source æ–‡ä»¶å¤¹ä¸‹å¯¹åº”çš„æ–‡ä»¶å¤¹ä¿®æ”¹ index.md æ–‡ä»¶ categories123456---layout: categoryindex: truetitle: æ‰€æœ‰åˆ†ç±»sidebar: [blogger, music, category, tagcloud, webinfo]--- tags123456---layout: tagindex: truetitle: æ‰€æœ‰æ ‡ç­¾sidebar: [blogger, music, category, tagcloud, webinfo]--- è¿™é‡Œçš„ sidebar æ˜¯ç»„ä»¶åˆ—è¡¨ï¼Œå¯ä»¥æ ¹æ®éœ€è¦å‚è€ƒä¸»é¢˜æ–‡æ¡£è‡ªå·±ä¿®æ”¹ é¦–é¡µ Cover_config.volantis.yml1234567891011121314cover: height_scheme: half # full, half layout_scheme: featured # blank (ç•™ç™½), search (æœç´¢), dock (åž), featured (ç²¾é€‰), focus (ç„¦ç‚¹) display: home: true archive: false others: false # can be written in front-matter &#x27;cover: true&#x27; background: https://gcore.jsdelivr.net/gh/MHG-LAB/cron@gh-pages/bing/bing.jpg #èƒŒæ™¯å›¾ # background: https://bing.ioliu.cn/v1/rand?w=1920&amp;h=1200 logo: # https://cdn.jsdelivr.net/gh/volantis-x/cdn-org/blog/Logo-Cover@3x.png title: &quot;Busyo&#x27;s Blog&quot; #ä¸­é—´æ˜¾ç¤ºçš„æ–‡å­— subtitle: &quot;&quot; search: A Wonderful Theme for Hexo # search bar placeholder # features: æ­¤å¤„æœ¬åšå®¢é€‰æ‹©å ä¸€åŠé¡µé¢çš„ coverï¼Œä¸ºäº†ä¿ç•™åšå®¢åçš„æ˜¾ç¤ºï¼Œé€‰æ‹©äº†éž blank çš„å¸ƒå±€ï¼ŒåŒæ—¶ä¸ºäº†ç§»é™¤å¤šä½™çš„æŒ‰é’®ï¼Œæ³¨é‡Šäº† features çš„æ‰€æœ‰å†…å®¹ã€‚display å¯ä»¥é€‰æ‹©åœ¨ä»€ä¹ˆç•Œé¢å±•ç¤ºã€‚ å­—ä½“_config.volantis.yml12345678910111213141516171819fontfamily: logofont: fontfamily: &#x27; &quot;haipai&quot;, &quot;Microsoft YaHei&quot;, Helvetica, Arial&#x27; name: &quot;haipai&quot; url: /fonts/haipai.ttf # https://cdn.jsdelivr.net/gh/volantis-x/cdn-fonts/VarelaRound/VarelaRound-Regular.ttf weight: normal style: normal bodyfont: fontfamily: &#x27;&quot;haipai&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, Helvetica, Arial&#x27; name: &quot;haipai&quot; url: /fonts/haipai.ttf # https://cdn.jsdelivr.net/gh/volantis-x/cdn-fonts/UbuntuMono/UbuntuMono-Regular.ttf weight: normal style: normal codefont: fontfamily: &quot;FiraCode-SemiBold, haipai, Monaco&quot; name: &quot;FiraCode-SemiBold&quot; url: /fonts/FiraCode-SemiBold.ttf # https://cdn.jsdelivr.net/gh/volantis-x/cdn-fonts/Monaco/Monaco.ttf weight: normal style: normal æ­¤é…ç½®å¯ä»¥ä¿®æ”¹ä¸‰ä¸ªåœ°æ–¹çš„å­—ä½“ logo å­—ä½“ã€æ­£æ–‡å­—ä½“å’Œä»£ç å­—ä½“ï¼Œæœ¬åšå®¢ä½¿ç”¨çš„å­—ä½“ä¿å­˜äºŽ/source/fonts/æ–‡ä»¶å¤¹ä¸‹ï¼Œå› æ­¤ä¼ å…¥çš„è·¯å¾„åŽ»é™¤ source ä¹‹åŽå°±æ˜¯/fonts/å­—ä½“ ä¾§è¾¹æ ç»„ä»¶_config.volantis.yml12345678sidebar: position: right # left right # ä¸»é¡µã€åˆ†ç±»ã€å½’æ¡£ç­‰ç‹¬ç«‹é¡µé¢ for_page: [blogger, music, category, tagcloud, webinfo] # layout: docs/post è¿™ç±»æ–‡ç« é¡µé¢ for_post: [toc] # ä¾§è¾¹æ ç»„ä»¶åº“ widget_library: ä¾§è¾¹æ çš„ç»„ä»¶åˆ—è¡¨å†…çš„å†…å®¹éƒ½æ˜¯ä»Žä¸‹é¢ç»„ä»¶åº“ä¸­é€‰æ‹©ï¼Œå¹¶ä¸”ç»„ä»¶å¯æ ¹æ®è‡ªå·±éœ€æ±‚è°ƒæ•´é…ç½®ï¼Œè¯¦æƒ…å¯å‚è€ƒå®˜æ–¹æ–‡æ¡£å’Œé…ç½®æ³¨é‡Šã€‚ æ–‡ç« ä½œè€…_config.volantis.yml1234567meta_library: # é»˜è®¤æ–‡ç« ä½œè€…ï¼ˆå¯åœ¨ _data/author.yaml ä¸­å¢žåŠ å…¶ä»–ä½œè€…ï¼Œå¹¶åœ¨ front-matter ä¸­è®¾ç½®ï¼‰ # https://volantis.js.org/advanced-settings/#å¤šäººååŒ author: avatar: /images/img_icon.png # ä½œè€…å¤´åƒå›¾ç‰‡è·¯å¾„ name: åå­— url: / #ä½œè€…ç½‘å€ é»˜è®¤å³åšå®¢ç½‘å€ æ’ä»¶å¹»ç¯ç‰‡èƒŒæ™¯_config.volantis.yml12345678910111213141516171819202122232425262728parallax: enable: true position: fixed # cover: å›ºå®šä½ç½®. fixed: æ»šåŠ¨è·Ÿéš. shuffle: true # ä¹±åº duration: 10000 # æ˜¾ç¤ºæŒç»­æ—¶é—´ å•ä½æ¯«ç§’ fade: 500 # æ¸å˜æ—¶é—´ å•ä½æ¯«ç§’ images: # å›¾ç‰‡åˆ—è¡¨ - volantis-static/media/wallpaper/minimalist/2020/001.webp - volantis-static/media/wallpaper/minimalist/2020/002.webp - volantis-static/media/wallpaper/minimalist/2020/003.webp - volantis-static/media/wallpaper/minimalist/2020/004.webp - volantis-static/media/wallpaper/minimalist/2020/005.webp - volantis-static/media/wallpaper/minimalist/2020/006.webp - volantis-static/media/wallpaper/minimalist/2020/012.webp - volantis-static/media/wallpaper/minimalist/2020/016.webp - volantis-static/media/wallpaper/minimalist/2020/019.webp - volantis-static/media/wallpaper/minimalist/2020/025.webp - volantis-static/media/wallpaper/minimalist/2020/033.webp - volantis-static/media/wallpaper/minimalist/2020/034.webp - volantis-static/media/wallpaper/minimalist/2020/035.webp - volantis-static/media/wallpaper/minimalist/2020/038.webp - volantis-static/media/wallpaper/minimalist/2020/039.webp - volantis-static/media/wallpaper/minimalist/2020/042.webp - volantis-static/media/wallpaper/minimalist/2020/046.webp - volantis-static/media/wallpaper/minimalist/2020/051.webp - volantis-static/media/wallpaper/minimalist/2020/052.webp - volantis-static/media/wallpaper/minimalist/2020/054.webp - volantis-static/media/wallpaper/minimalist/2020/056.webp éŸ³ä¹æ’­æ”¾å™¨_config.volantis.yml1234567891011121314151617181920aplayer: enable: true js: aplayer: volantis-static/libs/aplayer/dist/APlayer.min.js # https://unpkg.com/aplayer@1.10/dist/APlayer.min.js meting: volantis-static/libs/meting/dist/Meting.min.js # https://unpkg.com/meting@2.0/dist/Meting.min.js css: volantis-static/libs/aplayer/dist/APlayer.min.css # https://unpkg.com/aplayer@1.10/dist/APlayer.min.css # Required server: netease # netease, tencent, kugou, xiami, baidu type: playlist # song, playlist, album, search, artist id: 897784673 # song id / playlist id / album id / search keyword # Optional fixed: false # enable fixed mode theme: &quot;#1BCDFC&quot; # main color autoplay: false # audio autoplay order: list # player play order, values: &#x27;list&#x27;, &#x27;random&#x27; loop: all # player loop play, values: &#x27;all&#x27;, &#x27;one&#x27;, &#x27;yaml&#x27; volume: 0.7 # default volume, notice that player will remember user setting, default volume will not work after user set volume themselves list_max_height: 320px # list max height list_folded: true autoHide: true # hide automaticaly è®¾ç½® enable å¯ç”¨ï¼Œserver é€‰æ‹©éŸ³ä¹è½¯ä»¶ï¼Œtype é€‰æ‹©ç±»åž‹ï¼Œå¯¹åº”éŸ³ä¹è½¯ä»¶ä¸­çš„ç±»åž‹ï¼Œid é€‰æ‹©å…·ä½“çš„æ›²ç›®ï¼Œæœ¬åšå®¢ä½¿ç”¨ç½‘æ˜“äº‘çš„æ­Œå•ï¼Œid å³ä»£è¡¨å¯¹åº”çš„æ­Œå•ã€‚ å¦‚ä½•èŽ·å¾—ç±»åž‹å’Œidï¼Ÿ æ‰“å¼€ç½‘é¡µç‰ˆç½‘æ˜“äº‘ï¼Œæœç´¢æƒ³è¦çš„å†…å®¹ï¼ŒæŸ¥çœ‹ç½‘å€æ  ç»Ÿè®¡_config.volantis.yml123456analytics: busuanzi: volantis-static/libs/busuanzi/js/busuanzi.pure.mini.js #https://cdn.jsdelivr.net/gh/volantis-x/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js leancloud: # è¯·ä½¿ç”¨è‡ªå·±çš„ id &amp; key ä»¥é˜²æ­¢æ•°æ®ä¸¢å¤± app_id: # u9j57bwJod4EDmXWdxrwuqQT-MdYXbMMI app_key: # jfHtEKVE24j0IVCGHbvuFClp custom_api_server: # å›½é™…ç‰ˆä¸€èˆ¬ä¸éœ€è¦å†™ï¼Œé™¤éžè‡ªå®šä¹‰äº† API Server æœ¬åšå®¢ä½¿ç”¨ä¸è’œå­ç»Ÿè®¡ï¼Œè‹¥éœ€è¦æ›´é«˜çº§çš„ç»Ÿè®¡ï¼Œå¯å‚è€ƒä¸»é¢˜æ–‡æ¡£æŽ¥å…¥å…¶ä»–ç»Ÿè®¡ã€‚ å­—æ•°ç»Ÿè®¡_config.volantis.yml123# npm i hexo-wordcountwordcount: enable: true å­—æ•°ç»Ÿè®¡åŠŸèƒ½éœ€è¦å®‰è£…å¯¹åº”çš„æ¨¡å— 1npm i hexo-wordcount ç•Œé¢åŠŸèƒ½ç•Œé¢æ”¯æŒå¤šç§åŠŸèƒ½ï¼Œæ¯”å¦‚è¯„è®ºã€æ ‡ç­¾ã€æ‘˜è¦ã€å¼•ç”¨ç­‰ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ ç•Œé¢é…ç½® ä¸»é¢˜è¦†ç›–é¦–å…ˆæˆ‘ä»¬åœ¨ä¸»é¢˜æ–‡ä»¶å¤¹\\node_modules\\hexo-theme-volantis\\source\\cssä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œåå­—éšæ„ï¼Œæˆ‘æ–°å»ºäº†ä¸€ä¸ª_busyoæ–‡ä»¶å¤¹ã€‚ ç„¶åŽåœ¨æ–°å»ºçš„æ–‡ä»¶å¤¹ä¸‹æ–°å»ºä¸€ä¸ªcover.stylæ–‡ä»¶ç”¨æ¥ä¿å­˜è¦†ç›–çš„æ ·å¼ï¼Œä¸€ä¸ªextra.stylæ–‡ä»¶ç”¨æ¥ä¿å­˜æ–°å¢žçš„æ ·å¼ï¼Œæœ€åŽæˆ‘ä»¬åœ¨_busyoæ–‡ä»¶å¤¹ç»Ÿè®¡ç›®å½•ä¸‹çš„style.stylæ–‡ä»¶æœ€æœ«å°¾æ–°å¢žä¸€è¡Œ@import &#39;_busyo/*&#39;å³å¯ã€‚ ä¹‹åŽæˆ‘ä»¬æ‰€æœ‰çš„æ ·å¼æ”¹åŠ¨éƒ½å¯ä»¥å†™åœ¨è¿™ä¸¤ä¸ªæ–‡ä»¶å¤¹å†…ã€‚ è¦†ç›–æ ·å¼å¯¹äºŽè¦†ç›–æ ·å¼ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨æµè§ˆå™¨çš„å¼€å‘è€…å·¥å…·å®šä½æˆ‘ä»¬æƒ³è¦ä¿®æ”¹çš„å…ƒç´  æ­¤å¤„æˆ‘ä»¬çœ‹åˆ° class æœ‰ä¸¤ä¸ªæ ·å¼ï¼Œä¸€ä¸ªå« highlightï¼Œä¸€ä¸ªå« yamlï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ cover.styl æ–‡ä»¶å¤¹å†…æ–°å¢žåŒåå†…å®¹æ¥ä¿®æ”¹ä»–ä»¬ã€‚æ ¼å¼å¦‚ä¸‹ï¼š cover.styl1234.highlight border: 3px solid rgba(0,0,0,0.5) border-radius: 20px overflow:hidden å±žæ€§ä¿®æ”¹å³æ˜¯ css çš„ä¿®æ”¹ï¼Œå¯ä»¥æ ¹æ® css çš„ç›¸å…³å†…å®¹è‡ªå·±è°ƒæ•´ã€‚ æ–°å¢žæ ·å¼å¯¹äºŽæ–°å¢žæ ·å¼ï¼Œå¯ä»¥åœ¨extra.stylæ–‡ä»¶æ–°å¢žä¸é‡åçš„æ ·å¼ï¼Œç„¶åŽåœ¨å¯¹åº”çš„å¸ƒå±€æ–‡ä»¶ä¸­å¯¹åº”çš„éƒ¨åˆ†çš„ class å†…å®¹ä¸­åŠ ä¸Šä½ å¢žåŠ çš„æ ·å¼ã€‚ å¸ƒå±€æ–‡ä»¶çš„è·¯å¾„åœ¨ä¸»é¢˜æ–‡ä»¶å¤¹\\node_modules\\hexo-theme-volantis\\layout\\ä¸‹ï¼Œejs ç»“å°¾çš„æ–‡ä»¶ã€‚ å…³äºŽ ejs å†™æ³•è¯·è‡ªè¡ŒæŸ¥æ‰¾ç›¸å…³å†…å®¹ã€‚ å†…å®¹æ³¨å…¥æœ¬ä¸»é¢˜æ”¯æŒåœ¨ä¸ä¿®æ”¹ä¸»é¢˜æ–‡ä»¶çš„æƒ…å†µä¸‹å‘ head å’Œ body ä¸­æ·»åŠ å†…å®¹ã€‚ _config.yml123456import: head_begin: head_end: body_begin: body_end: # - &lt;script&gt;&lt;/script&gt; æ³¨å…¥å†…å®¹å¯ä»¥æ˜¯ä»»æ„æ ‡ç­¾ï¼Œä¹Ÿå¯ä»¥æ˜¯ JavaScript ä»£ç ï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºŽç½‘é¡µåŠ è½½ç­–ç•¥çš„åŽŸå› ï¼ŒJavaScript ä»£ç åªæœ‰åœ¨ç¬¬ä¸€æ¬¡æ‰“å¼€ç½‘ç«™çš„æ—¶å€™ä¼šæ‰§è¡Œï¼Œä¹‹åŽå°±ä¼šå†æ¬¡æ‰§è¡Œï¼Œé™¤éžåˆ·æ–°ç½‘é¡µã€‚ ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæœ¬åšå®¢é€‰æ‹©åœ¨å¸ƒå±€æ–‡ä»¶ä¸­ç¡¬ç¼–å…¥ script æ ‡ç­¾ã€‚ æœ¬åšå®¢çš„ä»£ç å—æ ·å¼å°±æ˜¯ç”±ä»£ç ç”Ÿæˆæ›¿æ¢ã€‚é€šè¿‡ script æ ‡ç­¾å¼•å…¥åŽå¤„ç†æ–‡ä»¶ï¼Œè¿™æ ·æ¯æ¬¡æ‰“å¼€ç•Œé¢éƒ½ä¼šæ‰§è¡Œä»£ç ã€‚ article.ejs1234&lt;!--çœç•¥ä¸Šé¢ä»£ç --&gt;&lt;/article&gt;&lt;script src = &quot;/script/AfterProcess.js&quot;&gt;&lt;/script&gt;&lt;!--çœç•¥ä¸‹é¢ä»£ç --&gt; JavaScript ä»£ç ç•Œé¢ç¾ŽåŒ–ï¼ˆä»£ç å—ã€æ ‡é¢˜ï¼‰1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677window.AfterProcess = &#123; ResetCodeStyle: () =&gt; &#123; var eles = document.getElementsByClassName(&quot;highlight&quot;); var colors = [&quot;#ed6a5e&quot;, &quot;#f5bd4f&quot;, &quot;#61c454&quot;]; for (let i = 0, len = eles.length; i &lt; len; i++) &#123; let child = eles[i].firstChild; //åˆ›å»ºæŒ‰é’® let customDiv = document.createElement(&quot;div&quot;); customDiv.style.display = &quot;flex&quot;; customDiv.style.height = &quot;40px&quot;; customDiv.style.width = &quot;100%&quot;; for (let j = 0; j &lt; 3; j++) &#123; let btn = document.createElement(&quot;div&quot;); btn.style.backgroundColor = colors[j]; btn.style.height = &quot;20px&quot;; btn.style.width = &quot;20px&quot;; btn.style.border = &quot;1px solid &quot; + colors[j]; btn.style.borderRadius = &quot;10px&quot;; btn.style.margin = &quot;10px 5px 10px 5px&quot;; customDiv.appendChild(btn); &#125; console.log(&quot;æ˜¯å¦åŒ¹é…&quot;, child.nodeName); if (child.nodeName != &quot;FIGCAPTION&quot;) &#123; //æ²¡æœ‰æ ‡é¢˜ eles[i].insertBefore(customDiv, child); &#125; else &#123; eles[i].replaceChild(customDiv, child); //æœ‰æ ‡é¢˜ let p = document.createElement(&quot;p&quot;); p.style.width = customDiv.offsetWidth - 40 * 3 + &quot;px&quot;; p.style.height = &quot;40px&quot;; p.style.textAlign = &quot;center&quot;; p.style.margin = &quot;0px&quot;; p.style.lineHeight = &quot;40px&quot;; p.innerText = child.firstChild.innerText; p.style.fontSize = &quot;20px&quot;; customDiv.appendChild(p); &#125; &#125; &#125;, ResetTitle: () =&gt; &#123; var eles = document.querySelectorAll(&quot;h1,h2,h3,h4,h5,h6&quot;); var picker = window.getComputedStyle; for (let i = 1, len = eles.length; i &lt; len; i++) &#123; let child = eles[i].firstChild; let eleStyle = picker(eles[i]); //åˆ›å»ºæ ‡è¯† let customDiv = document.createElement(&quot;div&quot;); customDiv.style.display = &quot;flex&quot;; customDiv.style.width = &quot;15px&quot;; customDiv.style.backgroundColor = &quot;#61c454&quot;; customDiv.style.height = eleStyle.fontSize; customDiv.style.marginRight = &quot;10px&quot;; customDiv.style.marginTop = (parseFloat(eleStyle.lineHeight) - parseFloat(eleStyle.fontSize)) * 0.5 + &quot;px&quot;; customDiv.style.borderRadius = &quot;5px&quot;; // console.log(&quot;å­—ä½“å¤§å°&quot;,eleStyle.fontSize,parseFloat(eleStyle.lineHeight),parseFloat(eleStyle.fontSize)) // customDiv.style.verticalAlign eles[i].style.display = &quot;flex&quot;; eles[i].style.verticalAlign = &quot;center&quot;; eles[i].insertBefore(customDiv, child); &#125; &#125;, Init: () =&gt; &#123; console.log(&quot;åˆå§‹åŒ–ç•Œé¢&quot;); AfterProcess.ResetCodeStyle(); AfterProcess.ResetTitle(); &#125;,&#125;;AfterProcess.Init();","categories":[{"name":"æ•™ç¨‹","slug":"æ•™ç¨‹","permalink":"https://busyogg.github.io/categories/%E6%95%99%E7%A8%8B/"},{"name":"Hexo","slug":"æ•™ç¨‹/Hexo","permalink":"https://busyogg.github.io/categories/%E6%95%99%E7%A8%8B/Hexo/"}],"tags":[{"name":"æ•™ç¨‹","slug":"æ•™ç¨‹","permalink":"https://busyogg.github.io/tags/%E6%95%99%E7%A8%8B/"},{"name":"Hexo","slug":"Hexo","permalink":"https://busyogg.github.io/tags/Hexo/"}]},{"title":"Hexoåšå®¢æ­å»º åŸºç¡€ç¯‡","slug":"Hexoåšå®¢æ­å»º-åŸºç¡€ç¯‡","date":"2023-08-31T20:09:13.000Z","updated":"2024-05-18T15:38:01.307Z","comments":true,"path":"article/e834ef617110/","link":"","permalink":"https://busyogg.github.io/article/e834ef617110/","excerpt":"","text":"åŸºç¡€ä»‹ç»Hexo æ˜¯ä¸€ä¸ªå¿«é€Ÿã€ç®€æ´ä¸”é«˜æ•ˆçš„åšå®¢æ¡†æž¶ï¼Œå…·æœ‰è¶…å¿«é€Ÿåº¦ã€æ”¯æŒ Markdownã€ä¸€é”®éƒ¨ç½²ã€æ’ä»¶å’Œå¯æ‰©å±•æ€§ï¼ˆå¼•è‡ªå®˜ç½‘ç®€ä»‹ï¼‰ã€‚ è¯¥æ¡†æž¶å¯ä»¥éƒ¨ç½²åˆ°ä¸ªäººæœåŠ¡å™¨æˆ–è€… GitHub ä¸Šï¼Œæœ¬æ–‡ä¸»è¦æ˜¯ä»‹ç»å¦‚ä½•éƒ¨ç½²åˆ° GitHubï¼Œä»¥åŠé…ç½®çš„è°ƒæ•´ã€‚ ä¾èµ–Hexo åšå®¢éœ€è¦å®‰è£…ç›¸å…³ä¾èµ–ç¨‹åº Node.js Git å®‰è£…æ–¹æ³•è¯·è‡ªè¡ŒæŸ¥æ‰¾ã€‚ Hexo å®‰è£…Hexo åšå®¢åˆ©ç”¨ Node.js çš„ npm å®‰è£…ï¼Œæˆ‘ä»¬æ‰“å¼€ cmd æˆ–è€… powershellï¼Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤å®‰è£… Hexo ç›¸å…³çš„å·¥å…· 1npm install -g hexo-cli ç„¶åŽæˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»ºæˆ‘ä»¬çš„åšå®¢æ–‡ä»¶å¤¹ï¼Œå…¶ä¸­ folder ä»£è¡¨è¦åˆ›å»ºæ–‡ä»¶å¤¹çš„è·¯å¾„ï¼Œä¸æŒ‡å®šçš„è¯é»˜è®¤åœ¨å½“å‰æ–‡ä»¶å¤¹åˆ›å»ºï¼Œç„¶åŽæˆ‘ä»¬è¿›å…¥æ–‡ä»¶å¤¹å¼€å§‹åˆ›å»ºæˆ‘ä»¬çš„åšå®¢ 123hexo init &lt;folder&gt;cd &lt;folder&gt;npm install å¦‚æžœå‡ºçŽ°æ— æ³•åŠ è½½æ–‡ä»¶ C:\\Users\\*\\AppData\\Roaming\\npm\\nodemon.ps1ä¹‹ç±»çš„æŠ¥é”™ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•è§£å†³ï¼ˆå‚è€ƒé“¾æŽ¥ï¼‰ï¼š 12Start-Process powershell -Verb runAsset-ExecutionPolicy RemoteSigned æˆ–è€…è¿›å…¥é¡¹ç›®æ–‡ä»¶å¤¹ï¼Œè¿è¡Œï¼š 1npx nodemon run dev çŽ°åœ¨æˆ‘ä»¬çš„åšå®¢æ–‡ä»¶å¤¹çš„é›å½¢å°±åˆ›å»ºå¥½äº†ã€‚æŽ¥ä¸‹æ¥å°±æ˜¯æŠŠæˆ‘ä»¬çš„åšå®¢éƒ¨ç½²åˆ° GitHub ä¸Šäº†ã€‚ éƒ¨ç½² GitHub é¦–å…ˆæˆ‘ä»¬è¦æœ‰ä¸€ä¸ª GitHub çš„è´¦å·ã€‚ ç„¶åŽæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª git ä»“åº“ï¼Œç”¨æˆ·åå³ä½ çš„ git è´¦æˆ·å æ‰“å¼€åšå®¢æ–‡ä»¶å¤¹ä¸‹çš„_comfig.ymlï¼Œæ‰¾åˆ°å¯¹åº”é¡¹ç›®å¡«å…¥ä»¥ä¸‹å†…å®¹ï¼ˆæ²¡æ‰¾åˆ°å°±è‡ªå·±å†™å…¥ï¼‰ 1234deploy:type: gitrepo: è¿™é‡Œå¡«å…¥ä½ ä¹‹å‰åœ¨GitHubä¸Šåˆ›å»ºä»“åº“çš„å®Œæ•´è·¯å¾„ï¼Œè®°å¾—åŠ ä¸Š .gitbranch: main å®‰è£… Hexo çš„ git å·¥å…· 1npm install --save hexo-deployer-git æ‰“å¼€ git ç»ˆç«¯ è¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼Œç¬¬ä¸€æ¡ä¸ºæ¸…ç©ºå‘å¸ƒæ–‡ä»¶å¤¹ï¼Œç¬¬äºŒæ¡ä¸ºç”Ÿæˆå‘å¸ƒæ–‡ä»¶å¤¹ï¼Œç¬¬ä¸‰æ¡ä¸ºä¸Šä¼ ã€‚ 123hexo cleanhexo ghexo d æ­¤æ—¶ä¼šé‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œerr: Error: Spawn failedï¼Œæˆ‘ä»¬éœ€è¦åŽ»ç”Ÿæˆæ–° SSH å¯†é’¥ï¼ŒGitHub å®˜æ–¹æ–‡æ¡£ç”Ÿæˆ sshï¼Œç„¶åŽæˆ‘ä»¬åœ¨ git ç»ˆç«¯èŽ·å–æˆ‘ä»¬åˆ›å»ºçš„ SSH ç§˜é’¥ 12cd ~/.sshcat id_rsa.pub ç„¶åŽå¡«å…¥è¿™ä¸ªç•Œé¢ New SSH key æŽ¥ä¸‹æ¥æˆ‘ä»¬æŽ¨é€åšå®¢åˆ° GitHub ä¸Šåº”è¯¥å°±æ²¡æœ‰é—®é¢˜äº†ï¼ŒæŽ¨é€åŽè¿‡ä¸€ä¼šå„¿æˆ‘ä»¬å°±èƒ½é€šè¿‡ ç”¨æˆ·å.github.io çš„é“¾æŽ¥è®¿é—®åšå®¢äº† åŸºæœ¬å‘½ä»¤å®˜ç½‘æ–‡æ¡£ - æŒ‡ä»¤https://hexo.io/zh-cn/docs/commands åˆ›å»ºæ–‡ç« å¯ä»¥ç”¨å¦‚ä¸‹å‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ª md åŽç¼€çš„ markdown é¡µé¢ï¼Œè¿™ä¸ªå‘½ä»¤è¿˜æœ‰å…¶ä»–æŒ‰å‚æ•°ï¼Œå…·ä½“å¯ä»¥æŸ¥é˜…å®˜ç½‘æ–‡æ¡£ã€‚ 1hexo new &quot;æ–‡ç« å&quot; å…¶ä»–é¡¹ç›®ç›¸å…³çš„å‘½ä»¤å¦‚ä¸‹ è¿è¡Œæœ¬åœ°æœåŠ¡å™¨1hexo server ç”Ÿæˆå‘å¸ƒæ–‡ä»¶å¤¹1hexo generate éƒ¨åˆ†æ–‡ä»¶ä½¿ç”¨è¦å…ˆç”Ÿæˆæ‰èƒ½é“¾æŽ¥æˆåŠŸ æ¸…é™¤å‘å¸ƒæ–‡ä»¶å¤¹1hexo clean å‘å¸ƒåˆ°git1hexo d æœ¬å‘½ä»¤éœ€è¦åœ¨gitç»ˆç«¯æ‰§è¡Œ é…ç½®ä¿®æ”¹é™¤äº†ä¸Šæ–‡æåˆ°çš„ deploy è®¾ç½®å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥æ›´æ”¹åšå®¢çš„ä¸€äº›ä¿¡æ¯ 123456789# Sitetitle: åšå®¢åsubtitle: å‰¯æ ‡é¢˜description: ç®€ä»‹keywords:author: ä½œè€…ålanguage: zh-CNtimezone: &#x27;&#x27;favicon: /images/img_icon.png #ç½‘ç«™å›¾æ ‡ è¿™é‡Œçš„å›¾æ ‡æˆ‘ç”¨äº†æœ¬åœ°æ–‡ä»¶ï¼Œåœ¨ source æ–‡ä»¶å¤¹ä¸‹åˆ›å»ºçš„ images æ–‡ä»¶å¤¹å†…çš„ img_icon.pngï¼Œåœ¨ç”ŸæˆåŽè·¯å¾„ä¼šå˜æˆ/public/images/img_icon.pngï¼Œè¿™é‡Œçš„ public å°±æ˜¯ç”Ÿæˆçš„æ–‡ä»¶å¤¹ï¼Œimages å‰é¢åŠ æ–œæ ä»£è¡¨ä»Žæ ¹ç›®å½•å¼€å§‹ï¼Œå¦åˆ™ä¼šä»¥æ‰“å¼€çš„è·¯å¾„åŽé¢åŠ å›¾æ ‡è·¯å¾„ã€‚å…¶ä»–èµ„æºçš„è°ƒç”¨ä¹Ÿæ˜¯ç±»ä¼¼çš„æƒ…å†µã€‚è¿™é‡Œä¹Ÿå¯ä»¥ç”¨ç½‘ç»œè·¯å¾„ã€‚ å…¶æ¬¡å°±æ˜¯æ–‡ç« è®¿é—®è·¯å¾„çš„ä¿®æ”¹ï¼Œé»˜è®¤æ˜¯ä»¥æ—¶é—´+æ–‡ç« åä½œä¸ºè®¿é—®è·¯å¾„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹é…ç½®ä¿®æ”¹ 123456url: https://busyogg.github.io/ #ç½‘å€permalink: article/:category/:title/ #è®¿é—®è·¯å¾„permalink_defaults:pretty_urls: trailing_index: true # Set to false to remove trailing &#x27;index.html&#x27; from permalinks trailing_html: true # Set to false to remove trailing &#x27;.html&#x27; from permalinks è·¯å¾„çš„è§„åˆ™ä¸º | å˜é‡ | æè¿° || â€”â€”â€”â€“ | â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” | â€”â€” || :year | æ–‡ç« çš„å‘è¡¨å¹´ä»½ï¼ˆ4 ä½æ•°ï¼‰ || :month | æ–‡ç« çš„å‘è¡¨æœˆä»½ï¼ˆ2 ä½æ•°ï¼‰ || :i_month | æ–‡ç« çš„å‘è¡¨æœˆä»½ï¼ˆä¸å«å‰å¯¼é›¶ï¼‰ || :day | æ–‡ç« çš„å‘è¡¨æ—¥æœŸ (2 ä½æ•°) || :i_day | æ–‡ç« çš„å‘è¡¨æ—¥æœŸï¼ˆä¸å«å‰å¯¼é›¶ï¼‰ || :hour | æ–‡ç« å‘è¡¨æ—¶çš„å°æ—¶ (2 ä½æ•°) || :minute | æ–‡ç« å‘è¡¨æ—¶çš„åˆ†é’Ÿ (2 ä½æ•°) || :second | æ–‡ç« å‘è¡¨æ—¶çš„ç§’é’Ÿ (2 ä½æ•°) || :title | æ–‡ä»¶åç§° (ç›¸å¯¹äºŽ â€œsource&#x2F;_posts&#x2F;â€œ æ–‡ä»¶å¤¹) || :name | æ–‡ä»¶åç§° || :post_title | æ–‡ç« æ ‡é¢˜ || :id | æ–‡ç«  ID (æ¸…é™¤ç¼“å­˜æ—¶ä¸å…·æœ‰æŒä¹…æ€§) || :category | åˆ†ç±»ã€‚å¦‚æžœæ–‡ç« æ²¡æœ‰åˆ†ç±»ï¼Œåˆ™æ˜¯ default_category é…ç½® | ä¿¡æ¯ã€‚ || :hash | æ–‡ä»¶åï¼ˆä¸Ž :title ç›¸åŒï¼‰å’Œæ—¥æœŸçš„ SHA1 å“ˆå¸Œå€¼ï¼ˆ12 ä½ 16 è¿›åˆ¶æ•°ï¼‰ | è·¯å¾„å¼€å¤´ä¸å¸¦æ–œæ ï¼Œæˆ‘è·¯å¾„çš„ article ä¸ºæ–‡ç« å­˜æ”¾çš„æ ¹æ–‡ä»¶å¤¹ï¼Œå¯åŠ å¯ä¸åŠ ï¼Œå¯è‡ªå®šä¹‰åç§°ï¼Œæ ¹æ®ä¸ªäººéœ€æ±‚å†³å®šã€‚ å…¶ä»–æ³¨æ„äº‹é¡¹ æ‰€æœ‰å¯¹ config æ–‡ä»¶çš„ä¿®æ”¹éƒ½éœ€è¦é‡æ–°æ‰§è¡Œ hexo serverå‘½ä»¤ source æ–‡ä»¶å¤¹ç”¨äºŽä¿å­˜é¡¹ç›®æ–‡ä»¶ï¼Œå¯¹æ–‡ç« çš„ä¿®æ”¹å¯ä»¥å®žæ—¶æ›´æ–°ï¼Œä½†è¦å¢žåŠ  source æ–‡ä»¶å¤¹ä¸‹é¢çš„æ–‡ä»¶çš„è¯å°±éœ€è¦é‡æ–°æ‰§è¡Œhexo generateæ¥ç”Ÿæˆæ–‡ä»¶ æ–‡ç« åˆ›å»ºçš„æ ·æ¿æ–‡ä»¶ä¸ºpost.mdï¼Œåœ¨ scaffolds æ–‡ä»¶å¤¹ä¸‹ï¼Œåœ¨åˆ›å»ºæ–‡ç« çš„æ—¶å€™ä¼šå¸®ä½ æå‰è¾“å…¥ä¸€äº›å†…å®¹ã€‚å…¶ä»–æ ·æ¿æ–‡ä»¶åŒç†ã€‚","categories":[{"name":"æ•™ç¨‹","slug":"æ•™ç¨‹","permalink":"https://busyogg.github.io/categories/%E6%95%99%E7%A8%8B/"},{"name":"Hexo","slug":"æ•™ç¨‹/Hexo","permalink":"https://busyogg.github.io/categories/%E6%95%99%E7%A8%8B/Hexo/"}],"tags":[{"name":"æ•™ç¨‹","slug":"æ•™ç¨‹","permalink":"https://busyogg.github.io/tags/%E6%95%99%E7%A8%8B/"},{"name":"GitHub","slug":"GitHub","permalink":"https://busyogg.github.io/tags/GitHub/"},{"name":"Hexo","slug":"Hexo","permalink":"https://busyogg.github.io/tags/Hexo/"}]},{"title":"Unity ConsoleæŽ§åˆ¶å°æ‰“å°æ‹“å±•å·¥å…·","slug":"Unity-ConsoleæŽ§åˆ¶å°æ‰“å°æ‹“å±•å·¥å…·","date":"2023-08-28T11:23:58.000Z","updated":"2024-05-18T15:37:10.187Z","comments":true,"path":"article/ad277da9d73c/","link":"","permalink":"https://busyogg.github.io/article/ad277da9d73c/","excerpt":"","text":"ç®€ä»‹æœ¬é¡¹ç›®æ—¨åœ¨å±•å¼€ console æŽ§åˆ¶å°æ‰“å°çš„å†…å®¹æ˜¾ç¤ºï¼Œå‡å°‘æ‰“å°å¯¹è±¡å†…å®¹æœªçŸ¥çš„æƒ…å†µï¼ŒåŒæ—¶ç®€åŒ–å¤šå‚æ•°æ‰“å°çš„è°ƒç”¨ã€‚ æœ¬é¡¹ç›®éƒ¨åˆ†åŠŸèƒ½ä½¿ç”¨ LitJson å®žçŽ°ï¼Œæ•°ç»„ã€å­—å…¸ã€json æ•°æ®å‡ä¼šå¦èµ·ä¸€è¡Œæ˜¾ç¤ºï¼Œå…¶ä»–æ•°æ®ä¹‹é—´ä¼šç©ºä¸€æ ¼æ˜¾ç¤º åŸºæœ¬åŽŸç† åˆ©ç”¨ params å…³é”®å­—ï¼Œå…è®¸ç”¨æˆ·è½»æ¾æ‰“å°ä¸å®šæ•°é‡çš„å‚æ•°ã€‚ å¯¹éƒ¨åˆ†å˜é‡ç±»åž‹è¿›è¡Œæ‰‹åŠ¨åºåˆ—åŒ–ä»¥åœ¨ console æŽ§åˆ¶å°æ˜¾ç¤ºå…·ä½“å†…å®¹ æ•´åˆæ‰€æœ‰å‚æ•°æœ€ç»ˆçš„ç»“æžœï¼Œæ‹¼ä¸ºä¸€ä¸ª string å¹¶è°ƒç”¨å¯¹åº” Debug æ–¹æ³•æ‰“å° ä½¿ç”¨æ–¹æ³•1234567891011121314151617181920212223//jsonæ•°æ®string str = &quot;&#123; &#x27;a&#x27;:1 &#125;&quot;;JsonData jd = JsonMapper.ToObject(str);//å­—å…¸å†…å®¹Dictionary&lt;string, int[]&gt; testDic = new Dictionary&lt;string, int[]&gt;();testDic.Add(&quot;testA&quot;, new int[] &#123; 1, 2, 3 &#125;);testDic.Add(&quot;testB&quot;, new int[] &#123; 1 &#125;);//å¯¹è±¡GameObject obj = new GameObject();obj.name = &quot;test_obj&quot;;//å‘é‡Vector3 vec = new Vector3();//å¯¹è±¡object testObj = new object[] &#123; &quot;str1&quot;, 2 &#125;;//æ•°ç»„int[] ints = new int[] &#123; 1, 2, 3 &#125;;//è¾“å‡ºæµ‹è¯•ConsoleUtils.Log(&quot;è¾“å‡ºé€šçŸ¥å†…å®¹1 ----- &quot;, ints, testObj, jd, testDic, obj, vec);ConsoleUtils.Warn(&quot;è¾“å‡ºé€šçŸ¥å†…å®¹1 ----- &quot;, ints, testObj, jd, testDic, obj, vec);ConsoleUtils.Error(&quot;è¾“å‡ºé€šçŸ¥å†…å®¹1 ----- &quot;, ints, testObj, jd, testDic, obj, vec); è¿è¡Œæ•ˆæžœ ä»£ç test123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234using LitJson;using System;using UnityEngine;namespace Game&#123; public class ConsoleUtils &#123; private static string PrintDic(dynamic dic) &#123; string res = &quot;&#123; &quot;; foreach (dynamic data in dic) &#123; string key = data.Key.ToString(); string valueName = data.Value.GetType().Name; if (valueName.IndexOf(&quot;Dictionary&quot;) != -1) &#123; res += key + &quot;:&quot; + PrintDic(data.Value) + &quot;,&quot;; &#125; else if (valueName.IndexOf(&quot;List&quot;) != -1) &#123; res += key + &quot;:&quot; + PrintList(data.Value) + &quot;,&quot;; &#125; else &#123; res += key + &quot;:&quot; + data.Value.ToString() + &quot;,&quot;; &#125; &#125; res = res.Substring(0, res.Length - 1) + &quot; &#125;&quot;; return res; &#125; private static string PrintList(dynamic list) &#123; string res = &quot;[ &quot;; for(int i = 0,len = list.Count; i &lt; len; i++) &#123; string valueName = list[i].GetType().Name; if (valueName.IndexOf(&quot;Dictionary&quot;) != -1) &#123; res += PrintDic(list[i]) + &quot;,&quot;; &#125; else if (valueName.IndexOf(&quot;List&quot;) != -1) &#123; res += PrintList(list[i]) + &quot;,&quot;; &#125; else &#123; res += list[i].ToString() + &quot;,&quot;; &#125; &#125; res = res.Substring(0,res.Length - 1) + &quot; ]&quot;; return res; &#125; /// &lt;summary&gt; /// æ‰“å°åˆ°æŽ§åˆ¶å° /// &lt;/summary&gt; /// &lt;param name=&quot;objs&quot;&gt;&lt;/param&gt; public static void Log(params object[] objs) &#123; string str = string.Empty; bool isWrap = false; foreach (object obj in objs) &#123; if (obj == null) continue; Type type = obj.GetType(); string extra = string.Empty; if (type.Name.IndexOf(&quot;[]&quot;) != -1) &#123; extra = &quot;,\\r\\n[ &quot;; Array objArray = (Array)obj; int i = 0; int len = objArray.Length; foreach (object data in objArray) &#123; extra += data.ToString() + (i == len - 1 ? string.Empty : &quot; , &quot;); i++; &#125; extra += &quot; ]&quot;; str += extra; isWrap = true; &#125; else if (type == typeof(JsonData)) &#123; string json = ((JsonData)obj).ToJson(); str += &quot;,\\r\\n&quot; + json; isWrap = true; &#125; else if (type.Name.IndexOf(&quot;Dictionary&quot;) != -1) &#123; string json = PrintDic(obj); str += &quot;,\\r\\n&quot; + json; isWrap = true; &#125; else if (type.Name.IndexOf(&quot;List&quot;) != -1) &#123; string json = PrintList(obj); str += &quot;,\\r\\n&quot; + json; isWrap = true; &#125; else &#123; if (isWrap) &#123; isWrap = false; str += &quot;,\\r\\n&quot;; &#125; str += obj.ToString() + &quot; &quot;; &#125; &#125; Debug.Log(str); &#125; public static void Warn(params object[] objs) &#123; string str = string.Empty; bool isWrap = false; foreach (object obj in objs) &#123; Type type = obj.GetType(); string extra = string.Empty; if (type.Name.IndexOf(&quot;[]&quot;) != -1) &#123; extra = &quot;,\\r\\n[ &quot;; Array objArray = (Array)obj; int i = 0; int len = objArray.Length; foreach (object data in objArray) &#123; extra += data.ToString() + (i == len - 1 ? string.Empty : &quot; , &quot;); i++; &#125; extra += &quot; ]&quot;; str += extra; isWrap = true; &#125; else if (type == typeof(JsonData)) &#123; string json = ((JsonData)obj).ToJson(); str += &quot;,\\r\\n&quot; + json; isWrap = true; &#125; else if (type.Name.IndexOf(&quot;Dictionary&quot;) != -1) &#123; string json = PrintDic(obj); str += &quot;,\\r\\n&quot; + json; isWrap = true; &#125; else if (type.Name.IndexOf(&quot;List&quot;) != -1) &#123; string json = PrintList(obj); str += &quot;,\\r\\n&quot; + json; isWrap = true; &#125; else &#123; if (isWrap) &#123; isWrap = false; str += &quot;\\r\\n&quot;; &#125; str += obj.ToString() + &quot; &quot;; &#125; &#125; Debug.LogWarning(str); &#125; public static void Error(params object[] objs) &#123; string str = string.Empty; bool isWrap = false; foreach (object obj in objs) &#123; Type type = obj.GetType(); string extra = string.Empty; if (type.Name.IndexOf(&quot;[]&quot;) != -1) &#123; extra = &quot;,\\r\\n[ &quot;; Array objArray = (Array)obj; int i = 0; int len = objArray.Length; foreach (object data in objArray) &#123; extra += data.ToString() + (i == len - 1 ? string.Empty : &quot; , &quot;); i++; &#125; extra += &quot; ]&quot;; str += extra; isWrap = true; &#125; else if (type == typeof(JsonData)) &#123; string json = ((JsonData)obj).ToJson(); str += &quot;,\\r\\n&quot; + json; isWrap = true; &#125; else if (type.Name.IndexOf(&quot;Dictionary&quot;) != -1) &#123; string json = PrintDic(obj); str += &quot;,\\r\\n&quot; + json; isWrap = true; &#125; else if (type.Name.IndexOf(&quot;List&quot;) != -1) &#123; string json = PrintList(obj); str += &quot;,\\r\\n&quot; + json; isWrap = true; &#125; else &#123; if (isWrap) &#123; isWrap = false; str += &quot;\\r\\n&quot;; &#125; str += obj.ToString() + &quot; &quot;; &#125; &#125; Debug.LogError(str); &#125; &#125;&#125;","categories":[{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/categories/Unity/"},{"name":"å·¥å…·","slug":"Unity/å·¥å…·","permalink":"https://busyogg.github.io/categories/Unity/%E5%B7%A5%E5%85%B7/"}],"tags":[{"name":"C#","slug":"C","permalink":"https://busyogg.github.io/tags/C/"},{"name":"å·¥å…·ç±»","slug":"å·¥å…·ç±»","permalink":"https://busyogg.github.io/tags/%E5%B7%A5%E5%85%B7%E7%B1%BB/"},{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/tags/Unity/"}]},{"title":"Js/Tsç¼“åŠ¨ç³»ç»Ÿ","slug":"Js-Tsç¼“åŠ¨ç³»ç»Ÿ","date":"2023-08-24T13:45:16.000Z","updated":"2024-05-18T15:37:51.956Z","comments":true,"path":"article/923369eacdd4/","link":"","permalink":"https://busyogg.github.io/article/923369eacdd4/","excerpt":"","text":"åŸºæœ¬åŽŸç†æ¦‚è¿°ç¼“åŠ¨çš„åŸºæœ¬åŽŸç†å¾ˆç®€å•ï¼Œå°±æ˜¯è®¾ç½®ä¸€ä¸ªåˆå€¼å’Œç»ˆå€¼ï¼Œåœ¨æ¯å¸§æ›´æ–°çš„æ—¶å€™æ ¹æ®ç‰¹å®šçš„ç¼“åŠ¨å‡½æ•°ç®—å‡ºå¯¹åº”çš„ä¸­é—´å€¼å¹¶æ’å€¼ã€‚ æœ¬å·¥å…·ç±»åˆ†ä¸º 4 ä¸ªéƒ¨åˆ†ï¼šç¼“åŠ¨å·¥å…·ç±»ã€ç¼“åŠ¨è¾…åŠ©ç±»ã€ç¼“åŠ¨æ ¸å¿ƒç±»ã€ç¼“åŠ¨æ—¶é—´ç±»ã€‚åŒæ—¶ï¼Œæœ¬å·¥å…·æä¾›é“¾å¼è°ƒç”¨ï¼Œæ–¹ä¾¿è¿›è¡Œå¤šä¸ªç¼“åŠ¨åŠ¨ä½œçš„è¿žç»­æ‰§è¡Œã€‚ ç¼“åŠ¨å·¥å…·ç±»è´Ÿè´£ç®¡ç†ç¼“åŠ¨çš„è°ƒç”¨ï¼Œä»¥åŠä¸€ä¸ªä½œç”¨åŸŸæ‰€æœ‰çš„ç¼“åŠ¨ã€‚ ç¼“åŠ¨è¾…åŠ©ç±»è´Ÿè´£ç®¡ç†å•ä¸ªç¼“åŠ¨çš„åˆå§‹åŒ–ï¼ŒåŒæ—¶ä¹Ÿæ˜¯é“¾å¼è°ƒç”¨çš„æ ¸å¿ƒç±»ã€‚ ç¼“åŠ¨æ ¸å¿ƒç±»è´Ÿè´£ç®¡ç†å…·ä½“çš„ç¼“åŠ¨é€»è¾‘ï¼Œæ‰€ä»¥ç¼“åŠ¨éƒ½æ˜¯é€šè¿‡è¯¥ç±»æ‰§è¡Œã€‚ ç¼“åŠ¨æ—¶é—´ç±»è´Ÿè´£ç®¡ç†ç¼“åŠ¨çš„æ›´æ–°è°ƒç”¨ï¼Œæœ¬é¡¹ç›®æ‰˜ç®¡åˆ° Laya çš„æ›´æ–°è„šæœ¬ä¸Šã€‚ ç”±äºŽæœ¬ç±»åœ¨è®¾è®¡ä¹‹åˆæ˜¯åœ¨ Laya å¼•æ“Žè¿è¡Œï¼Œå› æ­¤å°éƒ¨åˆ†ä»£ç ä¾æ‰˜ Laya å­˜åœ¨ï¼Œä½¿ç”¨çš„æ—¶å€™éœ€è¦æ ¹æ®å…·ä½“é¡¹ç›®è¿›è¡Œä¿®æ”¹ã€‚ ä½¿ç”¨æ–¹æ³•æ‰€æœ‰çš„æ“ä½œå‡ä»Žç¼“åŠ¨å·¥å…·ç±»è°ƒç”¨ï¼Œä½†é¦–å…ˆåœ¨è¿è¡Œä¹‹å‰è¦æ‰§è¡Œ TweenUtil.start()æ–¹æ³•æ¥åˆå§‹åŒ–æ•´ä¸ªç¼“åŠ¨å·¥å…·çš„æ›´æ–°é€»è¾‘ã€‚ to å’Œ from æ–¹æ³•è¡¨ç¤ºä¸¤ä¸ªä¸åŒçš„ç¼“åŠ¨ç±»åž‹ï¼Œto ä¸ºä»Žå½“å‰çŠ¶æ€åˆ°ç›®æ ‡çŠ¶æ€ï¼Œfrom ä¸ºä»Žç›®æ ‡çŠ¶æ€åˆ°å½“å‰çŠ¶æ€ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½ä¼šè¿”å›žä¸€ä¸ª subTween å¯¹è±¡ï¼Œæˆ‘ä»¬å¯ä»¥ä»¥è¿™ä¸ª subTween å¯¹è±¡è¿›è¡Œé“¾å¼è°ƒç”¨ï¼Œä»¥ç‚¹çš„æ–¹æ³•é‡å¤è°ƒç”¨ toã€from ç­‰æ–¹æ³•ã€‚ ä¾‹å¦‚ï¼š 1234567891011121314151617181920let obj = &#123; x: 0 &#125;;TweenUtil.to( obj, &#123; x: 1, &#125;, 100) .to( &#123; x: 2, &#125;, 100 ) .to( &#123; x: 3, &#125;, 200 ); æ­¤å¤„æ‰§è¡Œäº†ä¸‰ä¸ªç¼“åŠ¨ï¼Œobj çš„ x å€¼ä»Ž 0 åˆ° 1 åˆ° 2 å†åˆ° 3ã€‚ä¸‰ä¸ªç¼“åŠ¨æŒ‰ç…§é¡ºåºæ‰§è¡Œä¸€æ¬¡ã€‚ åŒæ—¶ï¼Œæœ¬é¡¹ç›®ä¹Ÿæä¾›äº†å¾ªçŽ¯æ‰§è¡Œç¼“åŠ¨çš„åŠŸèƒ½ï¼Œåªéœ€è¦åœ¨æœ€åŽè°ƒç”¨ loop() æ–¹æ³•ï¼Œå°±å¯ä»¥å¯¹ loop ä¹‹å‰çš„æ‰€æœ‰æ­¥éª¤é‡å¤æ‰§è¡Œã€‚å¦å¤–ï¼Œæœ¬é¡¹ç›®ä¹Ÿæ”¯æŒè®¾ç½®å¾ªçŽ¯æ¬¡æ•°ï¼Œåªéœ€è¦å¦‚ä¸‹è°ƒç”¨å³å¯ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243let obj = &#123; x: 0 &#125;;TweenUtil.to( obj, &#123; x: 1, &#125;, 100) .to( &#123; x: 2, &#125;, 100 ) .to( &#123; x: 3, &#125;, 200 ) .loop();let obj2 = &#123; x: 0 &#125;;TweenUtil.to( obj2, &#123; x: 1, &#125;, 100) .to( &#123; x: 2, &#125;, 100 ) .to( &#123; x: 3, &#125;, 200 ) .loop(3); å¦‚æžœå­˜åœ¨ä¸¤ä¸ª loopï¼Œè‹¥å‰é¢çš„ loop ä¸ºæ— é™å¾ªçŽ¯ï¼Œåˆ™åŽé¢çš„ loop æ— æ³•æ‰§è¡Œï¼Œè‹¥ä¸æ˜¯æ— é™å¾ªçŽ¯ï¼Œåˆ™åŽé¢çš„ loop ä¼šæ‰§è¡Œç¬¬ä¸€ä¸ª loop åˆ°ç¬¬äºŒä¸ª loop ä¹‹é—´çš„ç¼“åŠ¨è¡Œä¸ºï¼Œç¬¬ä¸€ä¸ª loop ä¹‹å‰çš„ç¼“åŠ¨è¡Œä¸ºå…¨éƒ¨èˆå¼ƒã€‚å…¶ä»–æƒ…å†µåŒç†ã€‚ å¦‚æžœè¦æ¸…ç†ç¼“åŠ¨ï¼Œæœ‰ä¸¤ç§æ–¹æ³•ï¼Œä¸€ç§æ˜¯è°ƒç”¨ TweenUtil.clear() æ–¹æ³•ï¼Œä¼ å…¥ä¸€ä¸ªç¼“åŠ¨å¯¹è±¡ï¼Œåˆ™è¿™ä¸ªç¼“åŠ¨å¯¹è±¡ä¼šè¢«æ¸…ç†ï¼Œå¦ä¸€ç§æ˜¯æ¸…ç†ä½œç”¨åŸŸä¸Šçš„æ‰€æœ‰ç¼“åŠ¨å¯¹è±¡ï¼Œè°ƒç”¨ TweenUtil.clearAll() æ–¹æ³•ï¼Œä¼ å…¥ä½œç”¨åŸŸï¼Œåˆ™è¯¥ä½œç”¨åŸŸä¸Šçš„æ‰€æœ‰ç¼“åŠ¨å¯¹è±¡éƒ½ä¼šè¢«æ¸…ç†ã€‚ ç‰¹åˆ«æ³¨æ„ï¼Œæœ¬é¡¹ç›®ç›®å‰ä¸æ”¯æŒç¼“åŠ¨å¯¹è±¡æ± ï¼Œå› ä¸ºæœ‰å¯èƒ½ä¼šå‡ºçŽ°å¼•ç”¨ bugï¼Œå› æ­¤éœ€è¦ç¼“åŠ¨å¯¹è±¡æ± çš„è¯è¯·è‡ªè¡Œå®žçŽ°ã€‚ ç¼“åŠ¨å·¥å…·ç±»åŽŸç†æœ¬ç±»å†…ç½® 3 ä¸ªå˜é‡ _tweenId ï¼Œ_tweenDic ï¼Œ _tweenClock _tweenId å˜é‡ç”¨äºŽè‡ªå¢žç¼“åŠ¨ idï¼Œä¹Ÿæ˜¯ç¼“åŠ¨å¯¹è±¡å­—å…¸ä¸­çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œæ¯ä¸ªä½œç”¨åŸŸå¯¹åº”ä¸€ä¸ªç¼“åŠ¨ idã€‚ _tweenDic å˜é‡ä¸ºç¼“åŠ¨å¯¹è±¡å­—å…¸ï¼Œç”¨äºŽå­˜å‚¨ç¼“åŠ¨å¯¹è±¡ï¼Œç»“æž„ä¸º { tweenId : SubTween[] } , key ä¸ºç¼“åŠ¨ idï¼Œvalue ä¸ºç¼“åŠ¨è¾…åŠ©ç±»æ•°ç»„ï¼Œä¿å­˜è¯¥ä½œç”¨åŸŸä¸Šçš„æ‰€æœ‰ç¼“åŠ¨å¯¹è±¡ã€‚ _tweenClock å˜é‡ä¸ºç¼“åŠ¨æ ¸å¿ƒç±»å¯¹è±¡ï¼Œåœ¨ç¼“åŠ¨æ ¸å¿ƒç±»ä¸­ä¼šè°ƒç”¨å®ƒæ¥èŽ·å–ç¼“åŠ¨æ—¶é—´ç±» æœ¬ç±»çš„æ ¸å¿ƒæ–¹æ³• to å’Œ from çš„åŽŸç†ç›¸åŒï¼Œæ–¹æ³•åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š åˆ›å»ºä¸€ä¸ªç¼“åŠ¨è¾…åŠ©ç±»å¯¹è±¡ï¼Œè®¾ç½®å¯¹è±¡çš„ç›®æ ‡å¹¶ä¸”è°ƒç”¨å¯¹åº” to&#x2F;from æ–¹æ³•ã€‚ æ£€æŸ¥ä½œç”¨åŸŸçš„ç¼“åŠ¨ idï¼Œå¦‚æžœä¸å­˜åœ¨ï¼Œåˆ™åˆå§‹åŒ–ç¼“åŠ¨ idï¼Œç„¶åŽæ£€æŸ¥å­—å…¸ä¸­æ˜¯å¦å­˜åœ¨å¯¹åº” id å¹¶æŠŠåˆ›å»ºçš„å¯¹è±¡ä¿å­˜åˆ°æ•°ç»„ä¸­ï¼Œæœ€åŽå†è¿”å›žè¿™ä¸ªå¯¹è±¡ã€‚ æ¸…é™¤ç¼“åŠ¨çš„åŽŸç†åˆ™å¦‚ä¸‹æ–¹è¯¦ç»†ä»£ç æ‰€ç¤ºã€‚ ç¼“åŠ¨è¾…åŠ©ç±»åŽŸç†æœ¬ç±»å†…ç½® 8 ä¸ªå˜é‡ target ï¼Œ _listIndex ï¼Œ _tweenList ï¼Œ _tweening ï¼Œ _tweenObj ï¼Œ _tweenIndex ï¼Œ _loop ï¼Œ _limit target å˜é‡å¦‚åå­—æ‰€ç¤ºï¼Œå°±æ˜¯ç¼“åŠ¨çš„ç›®æ ‡å¯¹è±¡ã€‚ _listIndex å˜é‡ç”¨äºŽç¼“åŠ¨åˆ—è¡¨çš„ç´¢å¼•ï¼Œä¸»è¦æ˜¯åŒºåˆ«å„ä¸ª loop ç¼“åŠ¨åŠ¨ä½œç»„ï¼Œåªæœ‰è°ƒç”¨ loop çš„æƒ…å†µä¸‹ä¼šå¢žåŠ ã€‚ _tweenList å˜é‡ç”¨äºŽä¿å­˜ç¼“åŠ¨åŠ¨ä½œï¼Œæ˜¯ä¸€ä¸ªäºŒç»´æ•°ç»„ï¼Œç¬¬ä¸€ç»´ä¿å­˜ç¼“åŠ¨åŠ¨ä½œç»„ï¼Œç¬¬äºŒç»´ä¿å­˜ç¼“åŠ¨åŠ¨ä½œåºåˆ—ã€‚ _tweening å˜é‡ç”¨äºŽåˆ¤æ–­å½“å‰æ˜¯å¦æ­£åœ¨ç¼“åŠ¨ _tweenObj å˜é‡ä¿å­˜æœ¬ç±»å½“å‰å®žä¾‹åŒ–çš„ç¼“åŠ¨æ ¸å¿ƒç±»å¯¹è±¡ _tweenIndex å˜é‡ç”¨äºŽç¼“åŠ¨åºåˆ—çš„ç´¢å¼• _loop å˜é‡ç”¨äºŽåˆ¤æ–­æ˜¯å¦å¼€å¯å¾ªçŽ¯ _limit å˜é‡ç”¨äºŽä¿å­˜ç¼“åŠ¨å¾ªçŽ¯æ¬¡æ•°é™åˆ¶ï¼Œæ˜¯ä¸ªä¸€ç»´æ•°ç»„ æœ¬ç±»çš„æ ¸å¿ƒæ–¹æ³• to å’Œ from çš„åŽŸç†ç›¸åŒï¼Œæ–¹æ³•åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š ä¿å­˜ç¼“åŠ¨å‚æ•°åˆ° _tweenList[ _listIndex ] æ•°ç»„ä¸­ å¦‚æžœç¼“åŠ¨æœªå¯åŠ¨ï¼Œåˆ™å¯åŠ¨ç¼“åŠ¨ æœ¬ç±»æœ€å…³é”®çš„ï¼Œå°±æ˜¯å¯åŠ¨ç¼“åŠ¨çš„é€»è¾‘ï¼Œå…·ä½“é€»è¾‘å¦‚ä¸‹å›¾æ‰€ç¤º æœ¬ç±»çš„å¯åŠ¨ç¼“åŠ¨ï¼Œå®žé™…ä¸Šå°±æ˜¯ä¸Šä¸€ä¸ªç¼“åŠ¨åŠ¨ä½œå’Œä¸‹ä¸€ä¸ªç¼“åŠ¨åŠ¨ä½œçš„è¿žæŽ¥ï¼Œå…·ä½“çš„ç¼“åŠ¨æ‰§è¡Œå’Œç»“æŸï¼Œè¿˜å¾—çœ‹ç¼“åŠ¨æ ¸å¿ƒç±»ã€‚ ç¼“åŠ¨æ ¸å¿ƒç±»åŽŸç†æœ¬ç±»å†…ç½® 11 ä¸ªå˜é‡ _target ï¼Œ _prop ï¼Œ _duration ï¼Œ _ease ï¼Œ _complete ï¼Œ _delay ï¼Œ _direction ï¼Œ _isDone ï¼Œ _time ï¼Œ _def ï¼Œ _isDelay _target å˜é‡å¦‚åå­—æ‰€ç¤ºæ˜¯ç¼“åŠ¨çš„å¯¹è±¡ _prop å˜é‡ä¿å­˜éœ€è¦ç¼“åŠ¨çš„æ‰€æœ‰å±žæ€§ _duration å˜é‡æ˜¯ç¼“åŠ¨çš„æŒç»­æ—¶é—´ _ease å˜é‡ä¸ºç¼“åŠ¨å‡½æ•°ï¼Œæ‰€æœ‰ç¼“åŠ¨å±žæ€§éƒ½éœ€è¦é€šè¿‡è¯¥å‡½æ•°è¿›è¡Œæ’å€¼ _complete å˜é‡ä¸ºå›žè°ƒå‡½æ•°ï¼Œåœ¨ç¼“åŠ¨ç»“æŸåŽæ‰§è¡Œï¼Œä¸»è¦æ˜¯æ‰§è¡Œç¼“åŠ¨è¾…åŠ©ç±»ä¸­çš„ doTween _delay å˜é‡æ˜¯ç¼“åŠ¨å»¶è¿Ÿæ—¶é—´ï¼Œåœ¨å»¶è¿Ÿæ—¶é—´ç»“æŸåŽæ‰ä¼šå¼€å§‹æ‰§è¡Œç¼“åŠ¨ _direction å˜é‡ç”¨äºŽåŒºåˆ† to å’Œ from _isDone å˜é‡ç”¨äºŽæ ‡è®°æ˜¯å¦å®Œæˆç¼“åŠ¨ _time å˜é‡ç”¨äºŽè®°å½•å½“å‰ç¼“åŠ¨æ‰§è¡Œæ—¶é—´ _def å˜é‡ç”¨äºŽä¿å­˜ç¼“åŠ¨å¯¹è±¡çš„åŽŸå§‹å±žæ€§ _isDelay å˜é‡ç”¨äºŽæ ‡è®°æ˜¯å¦å»¶è¿Ÿæ‰§è¡Œç¼“åŠ¨ æœ¬ç±»çš„ to å’Œ from æ–¹æ³•ä¹Ÿæ˜¯åˆå§‹åŒ–ä¼ å…¥çš„ç¼“åŠ¨å‚æ•°ï¼Œå¹¶ä¸”æŠŠæœ¬ç±»å¯¹è±¡æŽ¨åˆ°ç¼“åŠ¨æ—¶é—´ç±»çš„éåŽ†åˆ—è¡¨ä¸­ã€‚ æœ¬ç±»æœ€å…³é”®çš„å°±æ˜¯ç¼“åŠ¨æ¯ä¸€å¸§æ›´æ–°çš„é€»è¾‘ï¼Œå…·ä½“é€»è¾‘å¦‚ä¸‹å›¾æ‰€ç¤º æ³¨æ„ï¼Œç¼“åŠ¨å‡½æ•°çš„ä¼ å‚æ ¼å¼ä¸ºï¼š ç»è¿‡æ—¶é—´ï¼Œèµ·å§‹å€¼ï¼Œç»“æŸå€¼ï¼Œæ€»æ—¶é•¿ï¼Œè¿”å›žå€¼ä¸º 0 åˆ° 1 çš„ä¹‹é—´çš„æ•°å€¼ ç¼“åŠ¨æ—¶é—´ç±»åŽŸç†æœ¬ç±»åœ¨å½“å‰ç¤ºä¾‹ä¸­ä¾æ‰˜ Laya æ›´æ–°ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰å®šæ—¶å™¨æ¥æ›´æ–°ã€‚æ ¸å¿ƒé€»è¾‘ä¸»è¦å°±æ˜¯ updateï¼ŒéåŽ† _tweens ï¼Œå…ˆåˆ¤æ–­ç¼“åŠ¨æ ¸å¿ƒå¯¹è±¡æ˜¯å¦ç»“æŸç¼“åŠ¨ï¼Œç»“æŸç¼“åŠ¨å°±ç§»é™¤ï¼Œå¦åˆ™å°±æ‰§è¡Œ update å‡½æ•° ï¼Œä¼ å…¥ deltaTime å³ dtï¼Œå•ä½ä¸ºæ¯«ç§’ã€‚ æ³¨æ„æœ¬ç±»ä¸€èˆ¬éœ€è¦åœ¨æ•´ä¸ªé¡¹ç›®ä¸­æˆä¸ºå•ä¾‹ï¼Œä¸è¿‡æœ¬ç±»å¹¶æ²¡æœ‰å®žçŽ°å•ä¾‹ç±»ï¼Œå¦‚æžœéœ€è¦çš„è¯å¯è‡ªè¡Œå®žçŽ°ã€‚è®°å¾—é…åˆä¿®æ”¹ TweenUtil.start çš„å†…å®¹ã€‚ ä»£ç ç¼“åŠ¨å·¥å…·ç±»12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394export default class TweenUtil &#123; public static _tweenId = 1; public static _tweenDic = &#123;&#125;; private static _tweenClock: TweenClock; /** * å¯åŠ¨ç¼“åŠ¨å·¥å…·ç±» æœ¬å‡½æ•°è´Ÿè´£å¯åŠ¨ç¼“åŠ¨æ—¶é—´ç±»ï¼Œå‡½æ•°ä½“å¯æ ¹æ®éœ€æ±‚è‡ªå®šä¹‰ä¿®æ”¹ */ public static start() &#123; let scriptScene = new Laya.Scene3D(); Laya.stage.addChild(scriptScene); this._tweenClock = scriptScene.addComponent(TweenClock); &#125; public static getTweenClock() &#123; return this._tweenClock; &#125; /** * toç¼“åŠ¨ åŒLaya.Tween.to * @param target * @param prop * @param time * @param ease * @param delay * @param callback * @returns */ public static to(caller, target, prop, time, ease?, delay?, callback?) &#123; // console.log(&quot;ç¼“åŠ¨&quot;,target); let subTween = new SubTween(); subTween.target = target; subTween.to(prop, time, ease, delay, callback); if (!caller.tweenId) &#123; caller.tweenId = this._tweenId++; &#125; if (!this._tweenDic[caller.tweenId]) &#123; this._tweenDic[caller.tweenId] = []; &#125; this._tweenDic[caller.tweenId].push(subTween); return subTween; &#125; /** * fromç¼“åŠ¨ åŒLaya.Tween.to * @param target * @param prop * @param time * @param ease * @param delay * @param callback * @returns */ public static from(caller, target, prop, time, ease?, delay?, callback?) &#123; let subTween = new SubTween(); subTween.target = target; subTween.to(prop, time, ease, delay, callback); if (!caller.tweenId) &#123; caller.tweenId = this._tweenId++; &#125; if (!this.caller[caller.tweenId]) &#123; this.caller[caller.tweenId] = []; &#125; this._tweenDic[caller.tweenId].push(subTween); return subTween; &#125; /** * æ¸…é™¤ç›®æ ‡ç¼“åŠ¨ * @param tweenObj */ public static clear(tweenObj: SubTween) &#123; tweenObj.clear(); &#125; /** * æ¸…é™¤ç›®æ ‡èŠ‚ç‚¹æ‰€æœ‰ç¼“åŠ¨ * @param target */ public static clearAll(caller) &#123; // console.log(&quot;æ¸…é™¤&quot;, caller) if (!this._tweenDic[caller.tweenId]) return; let len = this._tweenDic[caller.tweenId].length; for (let i = 0; i &lt; len; i++) &#123; (this._tweenDic[caller.tweenId][i] as SubTween).clear(); &#125; this._tweenDic[caller.tweenId] = []; &#125;&#125; ç¼“åŠ¨è¾…åŠ©ç±»123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166export class SubTween &#123; /** ç›®æ ‡èŠ‚ç‚¹ */ public target; /** ç¼“åŠ¨åˆ—è¡¨ç´¢å¼• */ private _listIndex = 0; /** ç¼“åŠ¨åˆ—è¡¨ */ private _tweenList; /** æ˜¯å¦æ­£åœ¨ç¼“åŠ¨ */ private _tweening = false; /** ç¼“åŠ¨å¯¹è±¡ */ private _tweenObj: TweenCore; /** ç¼“åŠ¨ç´¢å¼• */ private _tweenIndex = 0; /** æ˜¯å¦å¾ªçŽ¯ */ private _loop = false; /** ç¼“åŠ¨å¾ªçŽ¯æ¬¡æ•°é™åˆ¶åˆ—è¡¨ */ private _limit: number[] = []; /** * ç¼“åŠ¨ ä»ŽçŽ°åœ¨å±žæ€§åˆ°ç›®æ ‡å±žæ€§ * @param prop * @param time * @param ease * @param delay * @param callback * @returns */ public to(prop, time, ease?, delay?, callback?) &#123; if (!this._tweenList) &#123; this._tweenList = []; &#125; if (!this._tweenList[this._listIndex]) &#123; this._tweenList[this._listIndex] = []; &#125; this._tweenList[this._listIndex].push(&#123; prop: prop, time: time, ease: ease, delay: delay, callback: callback, type: 0, &#125;); this.startTween(); return this; &#125; /** * ç¼“åŠ¨ ä»Žç›®æ ‡å±žæ€§åˆ°çŽ°åœ¨å±žæ€§ * @param prop * @param time * @param ease * @param delay * @param callback * @returns */ public from(prop, time, ease?, delay?, callback?) &#123; if (!this._tweenList) &#123; this._tweenList = []; &#125; if (!this._tweenList[this._listIndex]) &#123; this._tweenList[this._listIndex] = []; &#125; this._tweenList[this._listIndex].push(&#123; prop: prop, time: time, ease: ease, delay: delay, callback: callback, type: 1, &#125;); this.startTween(); return this; &#125; /** * å¾ªçŽ¯å‰é¢æ‰€æœ‰çš„åŠ¨ä½œ * @param å¾ªçŽ¯æ¬¡æ•° ä¸å¡«æˆ–è€…0ä¸ºæ— é™å¾ªçŽ¯ åªæœ‰åœ¨éžæ— é™å¾ªçŽ¯çš„æƒ…å†µä¸‹å¯ä»¥æ‰§è¡Œæœ¬æ¬¡loopåŽé¢çš„ç¼“åŠ¨ */ public loop(limit = 0) &#123; this._loop = true; this._limit[this._listIndex] = limit - 1; this._listIndex++; return this; &#125; /** * æ¸…é™¤ç¼“åŠ¨ */ public clear() &#123; if (this._tweenObj) &#123; this._tweenObj.clear(); &#125; this._tweenList = null; return this; &#125; /** * å¼€å§‹ç¼“åŠ¨ */ private startTween() &#123; if (!this._tweening) &#123; this._tweening = true; this.doTween(); &#125; &#125; /** * æ‰§è¡Œç¼“åŠ¨ */ private doTween() &#123; let self = this; if (!this._tweenList) return; let param = this._tweenList[0][this._tweenIndex++]; if (param) &#123; if (param.type == 0) &#123; this._tweenObj = new TweenCore(); this._tweenObj.to( this.target, param.prop, param.time, param.ease, () =&gt; &#123; param.callback &amp;&amp; param.callback(); self.doTween(); &#125;, param.delay ); &#125; else &#123; this._tweenObj = new TweenCore(); this._tweenObj.from( this.target, param.prop, param.time, param.ease, () =&gt; &#123; param.callback &amp;&amp; param.callback(); self.doTween(); &#125;, param.delay ); &#125; &#125; else &#123; if (this._loop) &#123; this._tweenIndex = 0; if (this._limit[0] == -1) &#123; this.doTween(); &#125; else &#123; if (this._limit[0] &gt; 0) &#123; this._limit[0]--; &#125; else &#123; this._tweenList.shift(); this._limit.shift(); this._listIndex--; if (this._tweenList.length == 0) &#123; this._tweenList = null; &#125; &#125; this.doTween(); &#125; &#125; else &#123; this._tweenList = null; this._limit = []; &#125; &#125; &#125;&#125; ç¼“åŠ¨æ ¸å¿ƒç±»123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115export class TweenCore &#123; private _target; private _prop; private _duration; private _ease; private _complete; private _delay; private _direction; private _isDone; private _time = 0; private _def = &#123;&#125;; private _isDelay = false; public to( target: any, props: any, duration: number, ease?: Function | null, complete?, delay?: number ) &#123; this._target = target; this._prop = props; this._duration = duration; this._ease = ease || Laya.Ease.linearInOut; this._complete = complete; this._delay = delay ? delay : 0; this._delay &amp;&amp; (this._isDelay = true); this._direction = 1; this._isDone = false; for (let key in this._prop) &#123; this._def[key] = this._target[key]; &#125; TweenUtil.getTweenClock().push(this); return this; &#125; public from( target: any, props: any, duration: number, ease?: Function | null, complete?, delay?: number ) &#123; this._target = target; this._prop = props; this._duration = duration; this._ease = ease || Laya.Ease.linearInOut; this._complete = complete; this._delay = delay ? delay : 0; this._delay &amp;&amp; (this._isDelay = true); this._direction = 0; this._isDone = false; for (let key in this._prop) &#123; this._def[key] = this._target[key]; &#125; TweenUtil.getTweenClock().push(this); return this; &#125; public update(dt) &#123; if (this._target &amp;&amp; !this._isDone) &#123; //è®¡ç®—è¿›åº¦ this._time += dt; if (this._isDelay) &#123; if (this._time &gt;= this._delay) &#123; this._isDelay = false; this._time = 0; &#125; &#125; else &#123; if (this._time &gt; this._duration) &#123; this._time = this._duration; this._isDone = true; &#125; //æ›´æ–° let ease = this._ease(this._time, 0, 1, this._duration); for (let key in this._prop) &#123; if (key == &quot;update&quot;) &#123; this._prop[key](); &#125; else &#123; this._target[key] = this._def[key] + (this._prop[key] - this._def[key]) * (this._direction ? ease : 1 - ease); &#125; &#125; //ç»“æŸå›žè°ƒ if (this._isDone) &#123; this.clear(); this._complete &amp;&amp; this._complete(); this._complete = null; &#125; &#125; &#125; &#125; public clear() &#123; TweenUtil.getTweenClock().sub(this); this._target = null; this._prop = null; this._duration = null; this._ease = null; this._delay = null; this._direction = null; this._isDone = null; this._time = 0; this._def = &#123;&#125;; this._isDelay = false; &#125; public getDone() &#123; return this._isDone; &#125;&#125; ç¼“åŠ¨æ—¶é’Ÿç±»æ­¤å¤„æŒ‚è½½åˆ° Laya ä¸Šï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰æ›´æ–°é€»è¾‘ 12345678910111213141516171819202122232425262728293031export class TweenClock extends Laya.Script3D &#123; private _tweens: TweenCore[] = []; onAwake() &#123; console.log(&quot;TweenClockå¯åŠ¨&quot;); &#125; public push(tween) &#123; this._tweens.push(tween); &#125; public sub(tween) &#123; let index = this._tweens.indexOf(tween); index != -1 &amp;&amp; this._tweens.splice(index, 1); &#125; public onUpdate() &#123; let time = Laya.timer.delta; let tween: TweenCore; for (let i = this._tweens.length - 1; i &gt;= 0; i--) &#123; tween = this._tweens[i]; if (tween) &#123; if (tween.getDone()) &#123; this._tweens.splice(i, 1); continue; &#125; tween.update(time); &#125; &#125; &#125;&#125; Laya ç¼“åŠ¨å‡½æ•°å‚è€ƒ123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179class Ease &#123; static linearNone(t, b, c, d) &#123; return (c * t) / d + b; &#125; static linearIn(t, b, c, d) &#123; return (c * t) / d + b; &#125; static linearInOut(t, b, c, d) &#123; return (c * t) / d + b; &#125; static linearOut(t, b, c, d) &#123; return (c * t) / d + b; &#125; static bounceIn(t, b, c, d) &#123; return c - Ease.bounceOut(d - t, 0, c, d) + b; &#125; static bounceInOut(t, b, c, d) &#123; if (t &lt; d * 0.5) return Ease.bounceIn(t * 2, 0, c, d) * 0.5 + b; else return Ease.bounceOut(t * 2 - d, 0, c, d) * 0.5 + c * 0.5 + b; &#125; static bounceOut(t, b, c, d) &#123; if ((t /= d) &lt; 1 / 2.75) return c * (7.5625 * t * t) + b; else if (t &lt; 2 / 2.75) return c * (7.5625 * (t -= 1.5 / 2.75) * t + 0.75) + b; else if (t &lt; 2.5 / 2.75) return c * (7.5625 * (t -= 2.25 / 2.75) * t + 0.9375) + b; else return c * (7.5625 * (t -= 2.625 / 2.75) * t + 0.984375) + b; &#125; static backIn(t, b, c, d, s = 1.70158) &#123; return c * (t /= d) * t * ((s + 1) * t - s) + b; &#125; static backInOut(t, b, c, d, s = 1.70158) &#123; if ((t /= d * 0.5) &lt; 1) return c * 0.5 * (t * t * (((s *= 1.525) + 1) * t - s)) + b; return (c / 2) * ((t -= 2) * t * (((s *= 1.525) + 1) * t + s) + 2) + b; &#125; static backOut(t, b, c, d, s = 1.70158) &#123; return c * ((t = t / d - 1) * t * ((s + 1) * t + s) + 1) + b; &#125; static elasticIn(t, b, c, d, a = 0, p = 0) &#123; var s; if (t == 0) return b; if ((t /= d) == 1) return b + c; if (!p) p = d * 0.3; if (!a || (c &gt; 0 &amp;&amp; a &lt; c) || (c &lt; 0 &amp;&amp; a &lt; -c)) &#123; a = c; s = p / 4; &#125; else s = (p / Ease.PI2) * Math.asin(c / a); return ( -( a * Math.pow(2, 10 * (t -= 1)) * Math.sin(((t * d - s) * Ease.PI2) / p) ) + b ); &#125; static elasticInOut(t, b, c, d, a = 0, p = 0) &#123; var s; if (t == 0) return b; if ((t /= d * 0.5) == 2) return b + c; if (!p) p = d * (0.3 * 1.5); if (!a || (c &gt; 0 &amp;&amp; a &lt; c) || (c &lt; 0 &amp;&amp; a &lt; -c)) &#123; a = c; s = p / 4; &#125; else s = (p / Ease.PI2) * Math.asin(c / a); if (t &lt; 1) return ( -0.5 * (a * Math.pow(2, 10 * (t -= 1)) * Math.sin(((t * d - s) * Ease.PI2) / p)) + b ); return ( a * Math.pow(2, -10 * (t -= 1)) * Math.sin(((t * d - s) * Ease.PI2) / p) * 0.5 + c + b ); &#125; static elasticOut(t, b, c, d, a = 0, p = 0) &#123; var s; if (t == 0) return b; if ((t /= d) == 1) return b + c; if (!p) p = d * 0.3; if (!a || (c &gt; 0 &amp;&amp; a &lt; c) || (c &lt; 0 &amp;&amp; a &lt; -c)) &#123; a = c; s = p / 4; &#125; else s = (p / Ease.PI2) * Math.asin(c / a); return ( a * Math.pow(2, -10 * t) * Math.sin(((t * d - s) * Ease.PI2) / p) + c + b ); &#125; static strongIn(t, b, c, d) &#123; return c * (t /= d) * t * t * t * t + b; &#125; static strongInOut(t, b, c, d) &#123; if ((t /= d * 0.5) &lt; 1) return c * 0.5 * t * t * t * t * t + b; return c * 0.5 * ((t -= 2) * t * t * t * t + 2) + b; &#125; static strongOut(t, b, c, d) &#123; return c * ((t = t / d - 1) * t * t * t * t + 1) + b; &#125; static sineInOut(t, b, c, d) &#123; return -c * 0.5 * (Math.cos((Math.PI * t) / d) - 1) + b; &#125; static sineIn(t, b, c, d) &#123; return -c * Math.cos((t / d) * Ease.HALF_PI) + c + b; &#125; static sineOut(t, b, c, d) &#123; return c * Math.sin((t / d) * Ease.HALF_PI) + b; &#125; static quintIn(t, b, c, d) &#123; return c * (t /= d) * t * t * t * t + b; &#125; static quintInOut(t, b, c, d) &#123; if ((t /= d * 0.5) &lt; 1) return c * 0.5 * t * t * t * t * t + b; return c * 0.5 * ((t -= 2) * t * t * t * t + 2) + b; &#125; static quintOut(t, b, c, d) &#123; return c * ((t = t / d - 1) * t * t * t * t + 1) + b; &#125; static quartIn(t, b, c, d) &#123; return c * (t /= d) * t * t * t + b; &#125; static quartInOut(t, b, c, d) &#123; if ((t /= d * 0.5) &lt; 1) return c * 0.5 * t * t * t * t + b; return -c * 0.5 * ((t -= 2) * t * t * t - 2) + b; &#125; static quartOut(t, b, c, d) &#123; return -c * ((t = t / d - 1) * t * t * t - 1) + b; &#125; static cubicIn(t, b, c, d) &#123; return c * (t /= d) * t * t + b; &#125; static cubicInOut(t, b, c, d) &#123; if ((t /= d * 0.5) &lt; 1) return c * 0.5 * t * t * t + b; return c * 0.5 * ((t -= 2) * t * t + 2) + b; &#125; static cubicOut(t, b, c, d) &#123; return c * ((t = t / d - 1) * t * t + 1) + b; &#125; static quadIn(t, b, c, d) &#123; return c * (t /= d) * t + b; &#125; static quadInOut(t, b, c, d) &#123; if ((t /= d * 0.5) &lt; 1) return c * 0.5 * t * t + b; return -c * 0.5 * (--t * (t - 2) - 1) + b; &#125; static quadOut(t, b, c, d) &#123; return -c * (t /= d) * (t - 2) + b; &#125; static expoIn(t, b, c, d) &#123; return t == 0 ? b : c * Math.pow(2, 10 * (t / d - 1)) + b - c * 0.001; &#125; static expoInOut(t, b, c, d) &#123; if (t == 0) return b; if (t == d) return b + c; if ((t /= d * 0.5) &lt; 1) return c * 0.5 * Math.pow(2, 10 * (t - 1)) + b; return c * 0.5 * (-Math.pow(2, -10 * --t) + 2) + b; &#125; static expoOut(t, b, c, d) &#123; return t == d ? b + c : c * (-Math.pow(2, (-10 * t) / d) + 1) + b; &#125; static circIn(t, b, c, d) &#123; return -c * (Math.sqrt(1 - (t /= d) * t) - 1) + b; &#125; static circInOut(t, b, c, d) &#123; if ((t /= d * 0.5) &lt; 1) return -c * 0.5 * (Math.sqrt(1 - t * t) - 1) + b; return c * 0.5 * (Math.sqrt(1 - (t -= 2) * t) + 1) + b; &#125; static circOut(t, b, c, d) &#123; return c * Math.sqrt(1 - (t = t / d - 1) * t) + b; &#125;&#125;Ease.HALF_PI = Math.PI * 0.5;Ease.PI2 = Math.PI * 2;","categories":[{"name":"Laya","slug":"Laya","permalink":"https://busyogg.github.io/categories/Laya/"},{"name":"å·¥å…·","slug":"Laya/å·¥å…·","permalink":"https://busyogg.github.io/categories/Laya/%E5%B7%A5%E5%85%B7/"}],"tags":[{"name":"Laya","slug":"Laya","permalink":"https://busyogg.github.io/tags/Laya/"},{"name":"å·¥å…·ç±»","slug":"å·¥å…·ç±»","permalink":"https://busyogg.github.io/tags/%E5%B7%A5%E5%85%B7%E7%B1%BB/"},{"name":"ç³»ç»Ÿæž¶æž„","slug":"ç³»ç»Ÿæž¶æž„","permalink":"https://busyogg.github.io/tags/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/"},{"name":"Typescript","slug":"Typescript","permalink":"https://busyogg.github.io/tags/Typescript/"}]},{"title":"Unityè‡ªå®šä¹‰äº‹ä»¶ç³»ç»Ÿ","slug":"Unityè‡ªå®šä¹‰äº‹ä»¶ç³»ç»Ÿ","date":"2023-08-24T09:03:15.000Z","updated":"2024-05-30T12:20:37.468Z","comments":true,"path":"article/2474251272a9/","link":"","permalink":"https://busyogg.github.io/article/2474251272a9/","excerpt":"","text":"åŸºæœ¬åŽŸç†åœ¨äº‹ä»¶ä¼ é€’çš„è¿‡ç¨‹ä¸­è®¾ç½®ä¸€ä¸ªä¸­é—´å¯¹è±¡ï¼Œè´Ÿè´£ç®¡ç†ç›‘å¬è€…å’Œå‘é€è€…ï¼Œä»¥è¾¾åˆ°è§£è€¦åˆçš„ç›®çš„ã€‚ é¦–å…ˆæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæ–¹æ³•æ¥æ³¨å†Œç›‘å¬å¯¹è±¡ï¼Œè¯¥å¯¹è±¡åŒ…å«èŠ‚ç‚¹ï¼ˆå³ä½œç”¨åŸŸï¼‰ã€äº‹ä»¶åå’Œäº‹ä»¶å‡½æ•°ï¼Œç„¶åŽæˆ‘ä»¬åœ¨äº‹ä»¶è§¦å‘çš„æ—¶å€™è°ƒç”¨è§¦å‘å‡½æ•°ï¼Œæ¥è§¦å‘æ‰€æœ‰ç›‘å¬è¯¥äº‹ä»¶çš„å¯¹è±¡ã€‚è§¦å‘å‡½æ•°åŒ…å«äº‹ä»¶åå’Œå‚æ•°ã€‚ æ­¤å¤„æˆ‘ä»¬ä»¥å­—å…¸ _eventDictionary æ¥å­˜å‚¨ç›‘å¬å¯¹è±¡ï¼Œä»¥äº‹ä»¶åä½œä¸ºå­—å…¸çš„ keyï¼Œåœ¨å­—å…¸é‡Œæˆ‘ä»¬ä»¥ä½œç”¨åŸŸä¸º key å®šä¹‰å¦ä¸€ä¸ªå­—å…¸ï¼Œé˜²æ­¢åŒåäº‹ä»¶å†²çªä»¥åŠåŒä½œç”¨åŸŸäº‹ä»¶é‡å¤æ·»åŠ ã€‚ åŒæ—¶ï¼Œç”±äºŽæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ¸…é™¤èŠ‚ç‚¹ä¸Šæ‰€æœ‰äº‹ä»¶çš„æ–¹æ³•ï¼Œå› æ­¤æˆ‘ä»¬å•ç‹¬è®¾ç½®ä¸€ä¸ªå­—å…¸ _eventNode ç”¨æ¥ä¿å­˜èŠ‚ç‚¹å’Œäº‹ä»¶çš„å…³ç³»ã€‚åœ¨æ¸…é™¤èŠ‚ç‚¹ä¸Šæ‰€æœ‰äº‹ä»¶çš„æ—¶å€™åªéœ€è¦éåŽ†è¯¥å­—å…¸ _eventNode ä¸­å¯¹åº”ä½œç”¨åŸŸï¼ˆä¼ å…¥çš„ nodeï¼‰çš„äº‹ä»¶å¹¶ä¸”ä»Žäº‹ä»¶å­—å…¸ _eventDictionary ä¸­æŸ¥æ‰¾å¯¹åº”çš„äº‹ä»¶å¯¹è±¡åŠå…¶ä½œç”¨åŸŸå³å¯ã€‚ å…·ä½“çš„è°ƒç”¨è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š è¿™å°±æ˜¯æœ€åŸºæœ¬çš„äº‹ä»¶ç³»ç»Ÿã€‚ ç²˜æ€§é€šçŸ¥ä¸ºäº†é˜²æ­¢éƒ¨åˆ†æƒ…å†µä¸­å‡ºçŽ°é€šçŸ¥ä¸åˆ°ä½çš„æƒ…å†µï¼ˆå³å…ˆé€šçŸ¥åŽç›‘å¬ï¼‰ï¼Œè¿™é‡Œæˆ‘ä»¬å¼•å…¥äº†ç²˜æ€§é€šçŸ¥çš„åŠŸèƒ½ã€‚ æ­¤å¤„æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå­—å…¸ _stickyDic æ¥ä¿å­˜é€šçŸ¥çš„å†…å®¹ï¼Œè¿™é‡Œæˆ‘ä»¬åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼Œä¸€ç§æƒ…å†µæ˜¯è¯¥ç²˜æ€§é€šçŸ¥åªéœ€è¦é€šçŸ¥ä¸€æ¬¡ï¼Œåˆ™æˆ‘ä»¬åªéœ€è¦è®©æ–°çš„é€šçŸ¥è¦†ç›–æ—§çš„é€šçŸ¥ï¼›å¦ä¸€ç§æ˜¯éœ€è¦å¤šæ¬¡é€šçŸ¥ï¼Œåˆ™æˆ‘ä»¬è®¾ç½®ä¸€ä¸ªæ•°ç»„æ¥ä¿å­˜å¤šæ¬¡é€šçŸ¥çš„å†…å®¹ï¼Œæ‰€ä»¥æˆ‘ä»¬å¢žè®¾ä¸€ä¸ªå­—å…¸ _stickyArrayFlag ç”¨äºŽä¿å­˜ç²˜æ€§é€šçŸ¥ç±»åž‹ã€‚ ç²˜æ€§é€šçŸ¥å’Œæ™®é€šé€šçŸ¥çš„è§¦å‘äº‹ä»¶é€»è¾‘ç›¸ä¼¼ï¼Œå¯ä»¥è¯´å‰åŠéƒ¨åˆ†çš„ä»£ç å’Œæ™®é€šé€šçŸ¥ä¸€æ ·ï¼Œåªä¸è¿‡æˆ‘ä»¬å¢žè®¾ä¸€ä¸ªé€šçŸ¥æ ‡è¯†ç¬¦ï¼Œç”¨äºŽåˆ¤æ–­æ˜¯å¦é€šçŸ¥åˆ°ä½ï¼Œè‹¥æ²¡æœ‰é€šçŸ¥åˆ°ä½ï¼Œåˆ™è¿›å…¥ç²˜æ€§é€šçŸ¥å†…å®¹ä¿å­˜çš„æµç¨‹ã€‚ æ³¨å†Œç›‘å¬è€…çš„éƒ¨åˆ†ä»£ç ä¹Ÿæœ‰æ”¹åŠ¨ï¼Œåœ¨æ³¨å†Œå®ŒæˆåŽï¼Œè‹¥ä»Žç²˜æ€§é€šçŸ¥å­—å…¸ _stickyDic å–åˆ°å¯¹åº”äº‹ä»¶åçš„å†…å®¹ï¼Œåˆ™ç«‹åˆ»è¿›è¡Œä¸€æ¬¡é€šçŸ¥ï¼Œé€šçŸ¥ç»“æŸåŽåˆ é™¤å¯¹åº”çš„å†…å®¹ã€‚ ç®€å•æ¥è¯´ï¼Œç²˜æ€§é€šçŸ¥å°±æ˜¯åœ¨ç›‘å¬å’Œé€šçŸ¥è¿™ä¸¤ä¸ªè¿‡ç¨‹ä¹‹åŽå¢žåŠ ä¸€ä¸ªåˆ¤æ–­ï¼Œå¯¹äºŽç›‘å¬è€…æ¥è¯´ï¼Œå°±æ˜¯è¦åˆ¤æ–­æœ‰æ— é€šçŸ¥çš„å†…å®¹ï¼Œè€Œå¯¹äºŽé€šçŸ¥æ¥è¯´ï¼Œå°±æ˜¯åˆ¤æ–­æ˜¯å¦æœ‰ç›‘å¬è€…ç›‘å¬è¿‡è¯¥é€šçŸ¥å†…å®¹ã€‚ ä»£ç äº‹ä»¶æ•°æ®ç±»1234567891011121314151617181920212223242526272829303132333435using System;using System.Collections;namespace Game&#123; public class EventData &#123; private Action&lt;ArrayList&gt; _event = null; private string _eventName = string.Empty; public EventData(string eventName, Action&lt;ArrayList&gt; eventCallback) &#123; _eventName = eventName; _event = eventCallback; &#125; public void SetEventCallBack(Action&lt;ArrayList&gt; eventCallback) &#123; _event = eventCallback; &#125; public void RemoveEvent() &#123; _event = null; &#125; public void Triggered(ArrayList obj) &#123; if (_event != null) &#123; _event.Invoke(obj); &#125; &#125; &#125;&#125; äº‹ä»¶ç®¡ç†ç±»123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270using System;using System.Collections;using System.Collections.Generic;using UnityEngine;namespace Game&#123; public class EventManager &#123; /// &lt;summary&gt; /// äº‹ä»¶å­—å…¸ /// &lt;/summary&gt; private static Dictionary&lt;string, Dictionary&lt;string, EventData&gt;&gt; _eventDictionary = new Dictionary&lt;string, Dictionary&lt;string, EventData&gt;&gt;(); /// &lt;summary&gt; /// èŠ‚ç‚¹å­—å…¸ /// &lt;/summary&gt; private static Dictionary&lt;string, Dictionary&lt;string, bool&gt;&gt; _eventNode = new Dictionary&lt;string, Dictionary&lt;string, bool&gt;&gt;(); /// &lt;summary&gt; /// ç²˜æ€§é€šçŸ¥å­—å…¸ /// &lt;/summary&gt; private static Dictionary&lt;string, ArrayList&gt; _stickyDic = new Dictionary&lt;string, ArrayList&gt;(); /// &lt;summary&gt; /// å­˜å‚¨å½“å‰äº‹ä»¶çš„ç²˜æ€§é€šçŸ¥æ˜¯å¦ä¸ºé˜Ÿåˆ—é€šçŸ¥ /// &lt;/summary&gt; private static Dictionary&lt;string, bool&gt; _stickyArrayFlag = new Dictionary&lt;string, bool&gt;(); /// &lt;summary&gt; /// åœ¨éœ€è¦ç›‘å¬æŸä¸ªäº‹ä»¶çš„è„šæœ¬ä¸­ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•æ¥ç›‘å¬è¿™ä¸ªäº‹ä»¶ /// &lt;/summary&gt; /// &lt;param name = &quot;id&quot;&gt;å½“å‰èŠ‚ç‚¹id&lt;/param&gt; /// &lt;param name=&quot;eventName&quot;&gt;äº‹ä»¶å&lt;/param&gt; /// &lt;param name&quot;Action&quot;&gt;æ³¨å†Œç›‘å¬çš„å‡½æ•°&lt;/param&gt; public static void AddListening(string id, string eventName, Action&lt;ArrayList&gt; action) &#123; EventData eventData = null; if (!_eventDictionary.ContainsKey(eventName)) &#123; _eventDictionary.Add(eventName, new Dictionary&lt;string, EventData&gt;()); &#125; Dictionary&lt;string, EventData&gt; eventDic = _eventDictionary[eventName]; eventDic.TryGetValue(id, out eventData); if (eventData != null) &#123; eventData.SetEventCallBack(action); &#125; else &#123; eventData = new EventData(eventName, action); eventDic.Add(id, eventData); &#125; if (_eventNode.ContainsKey(id)) &#123; // _eventNode[id][eventName] = true; &#125; else &#123; Dictionary&lt;string, bool&gt; dicNode = new Dictionary&lt;string, bool&gt; &#123; &#123; id, true &#125; &#125;; _eventNode.Add(id, dicNode); &#125; //è§¦å‘ç²˜æ€§é€šçŸ¥ ArrayList stickyArray; _stickyDic.TryGetValue(eventName, out stickyArray); if (stickyArray != null) &#123; //æœ‰ç²˜æ€§é€šçŸ¥çš„æƒ…å†µä¸‹ä¸€å®šèƒ½èŽ·å–åˆ°æ˜¯å¦ä¸ºé€šçŸ¥é˜Ÿåˆ— bool isArray = _stickyArrayFlag[eventName]; if (isArray) &#123; for (int i = 0, len = stickyArray.Count; i &lt; len; i++) &#123; TriggerEvent(eventName, stickyArray[i] as ArrayList); &#125; &#125; else &#123; TriggerEvent(eventName, stickyArray); &#125; //å®Œæˆé€šçŸ¥ï¼Œç§»é™¤æ•°æ® _stickyArrayFlag.Remove(eventName); _stickyDic.Remove(eventName); &#125; &#125; /// &lt;summary&gt; /// åœ¨ä¸éœ€è¦ç›‘å¬çš„æ—¶å€™åœæ­¢ç›‘å¬ /// &lt;/summary&gt; /// &lt;param name = &quot;id&quot;&gt;å½“å‰èŠ‚ç‚¹id&lt;/param&gt; /// &lt;param name=&quot;eventName&quot;&gt;äº‹ä»¶å&lt;/param&gt; public static void RemoveListening(string id, string eventName) &#123; EventData eventData = null; Dictionary&lt;string, EventData&gt; eventDic = null; _eventDictionary.TryGetValue(eventName, out eventDic); if (eventDic != null) &#123; eventDic.TryGetValue(id, out eventData); if (eventData != null) &#123; eventData.RemoveEvent(); //ç§»é™¤äº‹ä»¶å­—å…¸ä¸­çš„äº‹ä»¶å¯¹åº”çš„ä½œç”¨åŸŸ eventDic.Remove(id); //å¦‚æžœäº‹ä»¶å­—å…¸ä¸­äº‹ä»¶çš„ä½œç”¨åŸŸä¸º0 åˆ™ç§»é™¤è¯¥äº‹ä»¶ if (eventDic.Count &lt;= 0) &#123; _eventDictionary.Remove(eventName); &#125; //å¦‚æžœæœ‰äº‹ä»¶å­˜åœ¨ï¼Œåˆ™ä¸€å®šåœ¨å¯¹åº”çš„nodeå­—å…¸ä¸­å­˜åœ¨ _eventNode[id].Remove(eventName); Debug.Log(&quot;ç§»é™¤äº‹ä»¶&quot; + id + eventName); &#125; &#125; &#125; /// &lt;summary&gt; /// ç§»é™¤èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰äº‹ä»¶ /// &lt;/summary&gt; /// &lt;param name=&quot;id&quot;&gt;èŠ‚ç‚¹&lt;/param&gt; public static void RemoveAll(string id) &#123; if (_eventNode.ContainsKey(id)) &#123; foreach (var data in _eventNode[id]) &#123; Dictionary&lt;string, EventData&gt; eventDic = null; _eventDictionary.TryGetValue(data.Key, out eventDic); if (eventDic != null) &#123; EventData eventData = null; eventDic.TryGetValue(id, out eventData); if (eventData != null) &#123; //ç§»é™¤äº‹ä»¶ eventData.RemoveEvent(); //ç§»é™¤äº‹ä»¶å­—å…¸ä¸­çš„äº‹ä»¶å¯¹åº”çš„ä½œç”¨åŸŸ eventDic.Remove(id); //å¦‚æžœäº‹ä»¶å­—å…¸ä¸­äº‹ä»¶çš„ä½œç”¨åŸŸä¸º0 åˆ™ç§»é™¤è¯¥äº‹ä»¶ if (eventDic.Count &lt;= 0) &#123; _eventDictionary.Remove(data.Key); &#125; &#125; &#125; &#125; //ç§»é™¤èŠ‚ç‚¹å­—å…¸ä¸­çš„å¯¹åº”èŠ‚ç‚¹æ•°æ® _eventNode.Remove(id); &#125; &#125; /// &lt;summary&gt; /// è§¦å‘æŸä¸ªäº‹ä»¶ /// &lt;/summary&gt; /// &lt;param name=&quot;eventName&quot;&gt;äº‹ä»¶å&lt;/param&gt; /// &lt;param name=&quot;obj&quot;&gt;å‚æ•°åˆ—è¡¨ï¼Œå¯ä»¥ä¸ºç©ºï¼Œä½†æ˜¯è®°å¾—åœ¨å›žè°ƒå‡½æ•°é‡Œé¢å¯¹è¯¥å‚æ•°è¿›è¡Œåˆ¤ç©ºå¤„ç†&lt;/param&gt; public static void TriggerEvent(string eventName, ArrayList obj) &#123; if (_eventDictionary.ContainsKey(eventName)) &#123; Dictionary&lt;string, EventData&gt; eventDic = null; _eventDictionary.TryGetValue(eventName, out eventDic); if (eventDic != null) &#123; EventData triggerEvent = null; foreach (var data in eventDic) &#123; triggerEvent = data.Value; triggerEvent.Triggered(obj); &#125; &#125; &#125; &#125; /// &lt;summary&gt; /// ç²˜æ€§é€šçŸ¥ /// &lt;/summary&gt; /// &lt;param name=&quot;eventName&quot;&gt;é€šçŸ¥å&lt;/param&gt; /// &lt;param name=&quot;obj&quot;&gt;æ•°æ®&lt;/param&gt; /// &lt;param name=&quot;isArray&quot;&gt;æ˜¯å¦é˜Ÿåˆ—&lt;/param&gt; public static void TriggerEventSticky(string eventName, ArrayList obj, bool isArray = false) &#123; if (_eventDictionary.ContainsKey(eventName)) &#123; Dictionary&lt;string, EventData&gt; eventDic = null; _eventDictionary.TryGetValue(eventName, out eventDic); if (eventDic != null) &#123; EventData triggerEvent = null; foreach (var data in eventDic) &#123; triggerEvent = data.Value; triggerEvent.Triggered(obj); &#125; &#125; &#125; else &#123; //ä¿å­˜é€šçŸ¥å†…å®¹ bool arrayFlag; _stickyArrayFlag.TryGetValue(eventName, out arrayFlag); if (isArray) &#123; arrayFlag = true; ArrayList res; _stickyDic.TryGetValue(eventName, out res); if (res == null) &#123; res = new ArrayList(); _stickyDic.Add(eventName, res); _stickyArrayFlag.Add(eventName, arrayFlag); &#125; //else //&#123; // _stickyDic[eventName] = res; // _stickyArrayFlag[eventName] = arrayFlag; //&#125; res.Add(obj); &#125; else &#123; arrayFlag = false; if (_stickyDic.ContainsKey(eventName)) &#123; _stickyDic[eventName] = obj; &#125; else &#123; _stickyDic.Add(eventName, obj); &#125; if (arrayFlag) &#123; _stickyArrayFlag[eventName] = arrayFlag; &#125; else &#123; if (!_stickyArrayFlag.ContainsKey(eventName)) &#123; _stickyArrayFlag.Add(eventName, arrayFlag); &#125; &#125; &#125; &#125; &#125; &#125;&#125; ## å…¶ä»–ç‰ˆæœ¬ Laya ç‰ˆæœ¬","categories":[{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/categories/Unity/"},{"name":"å·¥å…·","slug":"Unity/å·¥å…·","permalink":"https://busyogg.github.io/categories/Unity/%E5%B7%A5%E5%85%B7/"}],"tags":[{"name":"C#","slug":"C","permalink":"https://busyogg.github.io/tags/C/"},{"name":"å·¥å…·ç±»","slug":"å·¥å…·ç±»","permalink":"https://busyogg.github.io/tags/%E5%B7%A5%E5%85%B7%E7%B1%BB/"},{"name":"ç³»ç»Ÿæž¶æž„","slug":"ç³»ç»Ÿæž¶æž„","permalink":"https://busyogg.github.io/tags/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/"},{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/tags/Unity/"}]},{"title":"Layaè‡ªå®šä¹‰äº‹ä»¶ç³»ç»Ÿ","slug":"Layaè‡ªå®šä¹‰äº‹ä»¶ç³»ç»Ÿ","date":"2023-08-23T15:18:02.000Z","updated":"2024-05-18T15:37:40.642Z","comments":true,"path":"article/1099d6589f61/","link":"","permalink":"https://busyogg.github.io/article/1099d6589f61/","excerpt":"","text":"åŸºæœ¬åŽŸç†åœ¨äº‹ä»¶ä¼ é€’çš„è¿‡ç¨‹ä¸­è®¾ç½®ä¸€ä¸ªä¸­é—´å¯¹è±¡ï¼Œè´Ÿè´£ç®¡ç†ç›‘å¬è€…å’Œå‘é€è€…ï¼Œä»¥è¾¾åˆ°è§£è€¦åˆçš„ç›®çš„ã€‚ é¦–å…ˆæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªæ–¹æ³•æ¥æ³¨å†Œç›‘å¬å¯¹è±¡ï¼Œè¯¥å¯¹è±¡åŒ…å«èŠ‚ç‚¹ï¼ˆå³ä½œç”¨åŸŸï¼‰ã€äº‹ä»¶åå’Œäº‹ä»¶å‡½æ•°ï¼Œç„¶åŽæˆ‘ä»¬åœ¨äº‹ä»¶è§¦å‘çš„æ—¶å€™è°ƒç”¨è§¦å‘å‡½æ•°ï¼Œæ¥è§¦å‘æ‰€æœ‰ç›‘å¬è¯¥äº‹ä»¶çš„å¯¹è±¡ã€‚è§¦å‘å‡½æ•°åŒ…å«äº‹ä»¶åå’Œå‚æ•°ã€‚ æ­¤å¤„æˆ‘ä»¬ä»¥å­—å…¸ _eventDic æ¥å­˜å‚¨ç›‘å¬å¯¹è±¡ï¼Œä»¥äº‹ä»¶åä½œä¸ºå­—å…¸çš„ keyï¼Œåœ¨å­—å…¸é‡Œæˆ‘ä»¬ä»¥ä½œç”¨åŸŸä¸º key å®šä¹‰å¦ä¸€ä¸ªå­—å…¸ï¼Œé˜²æ­¢åŒåäº‹ä»¶å†²çªä»¥åŠåŒä½œç”¨åŸŸäº‹ä»¶é‡å¤æ·»åŠ ã€‚ åŒæ—¶ï¼Œç”±äºŽæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ¸…é™¤èŠ‚ç‚¹ä¸Šæ‰€æœ‰äº‹ä»¶çš„æ–¹æ³•ï¼Œå› æ­¤æˆ‘ä»¬å•ç‹¬è®¾ç½®ä¸€ä¸ªå­—å…¸ _nodeEventDic ç”¨æ¥ä¿å­˜èŠ‚ç‚¹å’Œäº‹ä»¶çš„å…³ç³»ã€‚åœ¨æ¸…é™¤èŠ‚ç‚¹ä¸Šæ‰€æœ‰äº‹ä»¶çš„æ—¶å€™åªéœ€è¦éåŽ†è¯¥å­—å…¸ _nodeEventDic ä¸­å¯¹åº”ä½œç”¨åŸŸï¼ˆä¼ å…¥çš„ nodeï¼‰çš„äº‹ä»¶å¹¶ä¸”ä»Žäº‹ä»¶å­—å…¸ _eventDic ä¸­æŸ¥æ‰¾å¯¹åº”çš„äº‹ä»¶å¯¹è±¡åŠå…¶ä½œç”¨åŸŸå³å¯ã€‚ å…·ä½“çš„è°ƒç”¨è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š è¿™å°±æ˜¯æœ€åŸºæœ¬çš„äº‹ä»¶ç³»ç»Ÿã€‚ ç²˜æ€§é€šçŸ¥ä¸ºäº†é˜²æ­¢éƒ¨åˆ†æƒ…å†µä¸­å‡ºçŽ°é€šçŸ¥ä¸åˆ°ä½çš„æƒ…å†µï¼ˆå³å…ˆé€šçŸ¥åŽç›‘å¬ï¼‰ï¼Œè¿™é‡Œæˆ‘ä»¬å¼•å…¥äº†ç²˜æ€§é€šçŸ¥çš„åŠŸèƒ½ã€‚ æ­¤å¤„æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå­—å…¸ _stickyArr æ¥ä¿å­˜é€šçŸ¥çš„å†…å®¹ï¼Œè¿™é‡Œæˆ‘ä»¬åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼Œä¸€ç§æƒ…å†µæ˜¯è¯¥ç²˜æ€§é€šçŸ¥åªéœ€è¦é€šçŸ¥ä¸€æ¬¡ï¼Œåˆ™æˆ‘ä»¬åªéœ€è¦è®©æ–°çš„é€šçŸ¥è¦†ç›–æ—§çš„é€šçŸ¥ï¼›å¦ä¸€ç§æ˜¯éœ€è¦å¤šæ¬¡é€šçŸ¥ï¼Œåˆ™æˆ‘ä»¬è®¾ç½®ä¸€ä¸ªæ•°ç»„æ¥ä¿å­˜å¤šæ¬¡é€šçŸ¥çš„å†…å®¹ã€‚ ç²˜æ€§é€šçŸ¥å’Œæ™®é€šé€šçŸ¥çš„è§¦å‘äº‹ä»¶é€»è¾‘ç›¸ä¼¼ï¼Œå¯ä»¥è¯´å‰åŠéƒ¨åˆ†çš„ä»£ç å’Œæ™®é€šé€šçŸ¥ä¸€æ ·ï¼Œåªä¸è¿‡æˆ‘ä»¬å¢žè®¾ä¸€ä¸ªé€šçŸ¥æ ‡è¯†ç¬¦ï¼Œç”¨äºŽåˆ¤æ–­æ˜¯å¦é€šçŸ¥åˆ°ä½ï¼Œè‹¥æ²¡æœ‰é€šçŸ¥åˆ°ä½ï¼Œåˆ™è¿›å…¥ç²˜æ€§é€šçŸ¥å†…å®¹ä¿å­˜çš„æµç¨‹ã€‚ æ³¨å†Œç›‘å¬è€…çš„éƒ¨åˆ†ä»£ç ä¹Ÿæœ‰æ”¹åŠ¨ï¼Œåœ¨æ³¨å†Œå®ŒæˆåŽï¼Œè‹¥ä»Žç²˜æ€§é€šçŸ¥å­—å…¸ _stickyArr å–åˆ°å¯¹åº”äº‹ä»¶åçš„å†…å®¹ï¼Œåˆ™ç«‹åˆ»è¿›è¡Œä¸€æ¬¡é€šçŸ¥ï¼Œé€šçŸ¥ç»“æŸåŽåˆ é™¤å¯¹åº”çš„å†…å®¹ã€‚ ç®€å•æ¥è¯´ï¼Œç²˜æ€§é€šçŸ¥å°±æ˜¯åœ¨ç›‘å¬å’Œé€šçŸ¥è¿™ä¸¤ä¸ªè¿‡ç¨‹ä¹‹åŽå¢žåŠ ä¸€ä¸ªåˆ¤æ–­ï¼Œå¯¹äºŽç›‘å¬è€…æ¥è¯´ï¼Œå°±æ˜¯è¦åˆ¤æ–­æœ‰æ— é€šçŸ¥çš„å†…å®¹ï¼Œè€Œå¯¹äºŽé€šçŸ¥æ¥è¯´ï¼Œå°±æ˜¯åˆ¤æ–­æ˜¯å¦æœ‰ç›‘å¬è€…ç›‘å¬è¿‡è¯¥é€šçŸ¥å†…å®¹ã€‚ ä»£ç äº‹ä»¶æ•°æ®ç±»1234567891011export default class EventInfo &#123; public node; public event: Function; public type: string; constructor(node, type: string, event: Function) &#123; this.node = node; this.event = event; this.type = type; &#125;&#125; äº‹ä»¶ç®¡ç†ç±»123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108import EventInfo from &quot;../bean/EventInfo&quot;;export default class EventManager &#123; /** äº‹ä»¶id */ private static _eventId = 1; /** äº‹ä»¶å­—å…¸ ç±»åž‹-èŠ‚ç‚¹-äº‹ä»¶ */ private static _eventDic = &#123;&#125;; /** èŠ‚ç‚¹å¯¹åº”äº‹ä»¶ èŠ‚ç‚¹-äº‹ä»¶ */ private static _nodeEventDic = &#123;&#125;; /** ç²˜æ€§é€šçŸ¥å­—å…¸ */ private static _stickyArr = &#123;&#125;; /** * å‘é€ç›‘å¬ * @param type ç›‘å¬ç±»åž‹ * @param data å‘é€çš„æ•°æ® */ public static dispatchEvent(type, data): void &#123; for (let key in this._eventDic[type]) &#123; let event = this._eventDic[type][key] as EventInfo; event.event.call(event.node, data); &#125; &#125; /** * ç²˜æ€§é€šçŸ¥ * @param type * @param data */ public static dispatchEventSticky(type, data, isArr?) &#123; let eventOk = false; //æ™®é€šé€šçŸ¥éƒ¨åˆ† for (let key in this._eventDic[type]) &#123; let event = this._eventDic[type][key] as EventInfo; event.event.call(event.node, data); eventOk = true; &#125; //å¦‚æžœæ²¡æœ‰æ‰§è¡Œæ™®é€šé€šçŸ¥ï¼Œåˆ™ä¿å­˜é€šçŸ¥å†…å®¹ if (!eventOk) &#123; if (isArr) &#123; if (!this._stickyArr[type]) &#123; this._stickyArr[type] = []; &#125; this._stickyArr[type].push(data); &#125; else &#123; this._stickyArr[type] = data; &#125; &#125; &#125; /** * æ³¨å†Œç›‘å¬ * @param node ç›‘å¬çš„èŠ‚ç‚¹ * @param type ç›‘å¬ç±»åž‹ * @param event ç›‘å¬äº‹ä»¶ */ public static onEvent(node, type: string, event: Function) &#123; var obj = new EventInfo(node, type, event); if (!this._eventDic[type]) &#123; this._eventDic[type] = &#123;&#125;; &#125; //å¦‚æžœèŠ‚ç‚¹ä¸Šæ²¡æœ‰äº‹ä»¶idï¼Œåˆ™æ·»åŠ  if (node.eventId == undefined) &#123; node.eventId = &quot;event_&quot; + this._eventId++; &#125; //æ·»åŠ äº‹ä»¶ this._eventDic[type][node.eventId] = obj; //èŽ·å–ç²˜æ€§é€šçŸ¥æ•°æ® let data = this._stickyArr[type]; if (data) &#123; //æ ¹æ®æ˜¯å¦æ•°ç»„å†³å®šæ˜¯å¦å¤šæ¬¡æ‰§è¡Œäº‹ä»¶ if (data.length) &#123; let event = this._eventDic[type][node.eventId] as EventInfo; for (let i = 0, len = data.length; i &lt; len; i++) &#123; event.event.call(event.node, data[i]); &#125; delete this._stickyArr[type]; &#125; else &#123; let event = this._eventDic[type][node.eventId] as EventInfo; event.event.call(event.node, data); delete this._stickyArr[type]; &#125; &#125; //æ±‡æ€»èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰äº‹ä»¶ if (!this._nodeEventDic[node.eventId]) &#123; this._nodeEventDic[node.eventId] = &#123;&#125;; &#125; this._nodeEventDic[node.eventId][type] = true; &#125; /** * æ¸…é™¤æŸä¸€èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰ç›‘å¬ * @param node */ public static offAllEventByNode(node) &#123; if (!node || !this._nodeEventDic[node.eventId]) return; for (let key in this._nodeEventDic[node.eventId]) &#123; delete this._eventDic[key][node.eventId]; if (Object.keys(this._eventDic[key]).length == 0) &#123; delete this._eventDic[key]; &#125; &#125; delete this._nodeEventDic[node.eventId]; &#125;&#125; å…¶ä»–ç‰ˆæœ¬Unity ç‰ˆæœ¬","categories":[{"name":"Laya","slug":"Laya","permalink":"https://busyogg.github.io/categories/Laya/"},{"name":"å·¥å…·","slug":"Laya/å·¥å…·","permalink":"https://busyogg.github.io/categories/Laya/%E5%B7%A5%E5%85%B7/"}],"tags":[{"name":"Laya","slug":"Laya","permalink":"https://busyogg.github.io/tags/Laya/"},{"name":"å·¥å…·ç±»","slug":"å·¥å…·ç±»","permalink":"https://busyogg.github.io/tags/%E5%B7%A5%E5%85%B7%E7%B1%BB/"},{"name":"ç³»ç»Ÿæž¶æž„","slug":"ç³»ç»Ÿæž¶æž„","permalink":"https://busyogg.github.io/tags/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/"},{"name":"Typescript","slug":"Typescript","permalink":"https://busyogg.github.io/tags/Typescript/"}]},{"title":"å…³äºŽLayaå¯¹æŽ¥å¾®ä¿¡å¼€æ”¾åŸŸçš„é—®é¢˜","slug":"å…³äºŽLayaå¯¹æŽ¥å¾®ä¿¡å¼€æ”¾åŸŸçš„é—®é¢˜","date":"2023-08-23T15:09:11.000Z","updated":"2024-05-30T12:24:44.916Z","comments":true,"path":"article/fcfc4d29d0e4/","link":"","permalink":"https://busyogg.github.io/article/fcfc4d29d0e4/","excerpt":"","text":"Laya å¯¹æŽ¥å¾®ä¿¡å¼€æ”¾åŸŸå¯ä»¥æ–°å»ºå¼€æ”¾åŸŸé¡¹ç›®æ¥åˆ›å»ºä¸€ä¸ªèŒƒä¾‹ï¼Œå¼€æ”¾åŸŸé¡¹ç›®æ‰“åŒ…çš„æ—¶å€™ä¸ä¼šæ‰“åŒ…èµ„æºæ–‡ä»¶ï¼Œå› æ­¤è¦åœ¨ä¸»åŸŸæå‰åŠ è½½å¯¹åº”çš„èµ„æºæ–‡ä»¶å¹¶ä¼ é€’ç»™å¼€æ”¾åŸŸï¼Œèƒ½ä¼ é€’çš„æœ‰ä¸¤ç§ç±»åž‹ï¼Œä¸€æ˜¯ ui å›¾é›†ï¼ŒäºŒæ˜¯ jsonï¼Œäº®ç€è°ƒç”¨ä¸åŒæŽ¥å£ä¾‹ï¼š 12345678Laya.loader.load( &quot;res/atlas/rank.atlas&quot;, Laya.Handler.create(this, (res) =&gt; &#123; Laya.MiniAdpter.sendAtlasToOpenDataContext(&quot;res/atlas/rank.atlas&quot;); //json //Laya.MiniAdpter.sendJsonDataToDataContext() &#125;)); å±•ç¤ºå­åŸŸçš„æ—¶å€™ laya ä¼šè‡ªåŠ¨è®¾ç½® canvasï¼Œä½†æ˜¯å­åŸŸä¸€æ—¦æœ‰åµŒå¥—å±‚çº§ï¼Œè¯¥æ–¹æ³•å°±ä¼šäº§ç”Ÿåç§»ï¼Œè§£å†³æ–¹æ³•ä¸ºï¼š è°ƒæ•´å­åŸŸå¯¹è±¡å±‚çº§åˆ°æ ¹å±‚çº§ æ‰‹åŠ¨è§¦å‘changeMatrixäº‹ä»¶ã€‚æ³¨æ„ï¼Œå¦‚æžœæ‰‹åŠ¨è§¦å‘è¯¥äº‹ä»¶ï¼Œåˆ™éœ€è¦æŒ‰ç…§æºç å¯¹åº”çš„æ ¼å¼æž„é€ ä¼ é€’çš„å‚æ•°ã€‚ä¾‹ï¼š 123456789101112//æ­¤å¤„canvasDataä¸ºè‡ªå®šä¹‰å¯¹è±¡ï¼ŒåŒ…å«matrixï¼Œwidthï¼Œheightä¸‰ä¸ªå±žæ€§ï¼Œå¯ä»¥ä¸éœ€è¦æŒ‰ç…§æ­¤å¤„ä»£ç æž„å»ºå¯¹è±¡ï¼Œä½†ä¸€å®šè¦ä¼ å…¥å¯¹åº”å±žæ€§çš„å‚æ•°this.openData.postMsg(&#123; type: &quot;changeMatrix&quot;, a: canvasData.matrix.a, b: canvasData.matrix.b, c: canvasData.matrix.c, d: canvasData.matrix.d, tx: canvasData.matrix.tx, ty: canvasData.matrix.ty, w: canvasData.width, h: canvasData.height,&#125;); æ³¨æ„ï¼Œå¦‚æžœè¦æ‰‹åŠ¨è§¦å‘è¯¥äº‹ä»¶ï¼Œåˆ™éœ€è¦å»¶è¿Ÿä¸€å¸§çš„æ—¶é—´ï¼Œé˜²æ­¢ UI ç•Œé¢è¿˜æ²¡æœ‰è‡ªåŠ¨é€‚é…å¥½å®½é«˜å¯¼è‡´ä¼ å…¥çš„ canvas åæ ‡åç§»","categories":[{"name":"Laya","slug":"Laya","permalink":"https://busyogg.github.io/categories/Laya/"},{"name":"è§£å†³æ–¹æ¡ˆ","slug":"Laya/è§£å†³æ–¹æ¡ˆ","permalink":"https://busyogg.github.io/categories/Laya/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"}],"tags":[{"name":"Laya","slug":"Laya","permalink":"https://busyogg.github.io/tags/Laya/"},{"name":"å¾®ä¿¡å¼€æ”¾åŸŸ","slug":"å¾®ä¿¡å¼€æ”¾åŸŸ","permalink":"https://busyogg.github.io/tags/%E5%BE%AE%E4%BF%A1%E5%BC%80%E6%94%BE%E5%9F%9F/"},{"name":"è§£å†³æ–¹æ¡ˆ","slug":"è§£å†³æ–¹æ¡ˆ","permalink":"https://busyogg.github.io/tags/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"}]},{"title":"å…³äºŽLAYAç¼–è¯‘await/asyncè¯­æ³•æŠ¥é”™çš„é—®é¢˜","slug":"å…³äºŽLAYAç¼–è¯‘await-asyncè¯­æ³•æŠ¥é”™çš„é—®é¢˜","date":"2023-08-23T14:52:19.000Z","updated":"2024-05-18T15:40:12.187Z","comments":true,"path":"article/810371225f39/","link":"","permalink":"https://busyogg.github.io/article/810371225f39/","excerpt":"","text":"åœ¨é¡¹ç›®ä¸­å®‰è£… tslib å³å¯ï¼Œå¯ä»¥åœ¨ vscode ç»ˆç«¯ä¸­è¾“å…¥ npm install tslib æˆ–è€…åœ¨ tsconfig.js ä¸­é…ç½®æ·»åŠ  libï¼Œpromiseï¼ˆæœªæµ‹è¯•ï¼‰","categories":[{"name":"Laya","slug":"Laya","permalink":"https://busyogg.github.io/categories/Laya/"},{"name":"Bug","slug":"Laya/Bug","permalink":"https://busyogg.github.io/categories/Laya/Bug/"}],"tags":[{"name":"Laya","slug":"Laya","permalink":"https://busyogg.github.io/tags/Laya/"},{"name":"Bug","slug":"Bug","permalink":"https://busyogg.github.io/tags/Bug/"}]},{"title":"Jszipåœ¨Layaå¼•æ“Žä¸Šçš„åº”ç”¨","slug":"Jszipåœ¨Layaå¼•æ“Žä¸Šçš„åº”ç”¨","date":"2023-08-23T13:17:56.000Z","updated":"2024-05-18T15:37:55.728Z","comments":true,"path":"article/47f96467aabe/","link":"","permalink":"https://busyogg.github.io/article/47f96467aabe/","excerpt":"","text":"å°æ¸¸æˆå¹³å°å¯¹äºŽèµ„æºçš„å¤§å°é™åˆ¶å¾ˆä¸¥æ ¼ï¼Œ åœ¨ OV å¹³å°ä¸Šï¼Œç”±äºŽå¿«æ¸¸æˆæœ¬èº«è‡ªå¸¦åŽ‹ç¼©æœºåˆ¶ï¼Œæ‰€ä»¥åŒ…ä½“å¤§å°çš„é—®é¢˜ç›¸å¯¹ä¸æ˜¯é‚£ä¹ˆä¸¥é‡ã€‚åœ¨å¾®ä¿¡å¹³å°ä¸Šï¼ŒåŒ…ä½“æ˜¯æ²¡æœ‰åŽ‹ç¼©çš„ã€‚ä¸€èˆ¬æ¥è¯´æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼Œ ä¸€ä¸ªæ˜¯æŠŠèµ„æºæ”¾åœ¨äº‘ç«¯ï¼Œè¿˜æœ‰ä¸€ä¸ªå°±æ˜¯åŽ‹ç¼©æœ¬åœ°èµ„æºã€‚ åœ¨èµ„æºå¾ˆå¤šä½†åˆä¸æ˜¯é‚£ä¹ˆå¤šçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨åŽ‹ç¼©åŒ…çš„æ–¹å¼å­˜å‚¨èµ„æºã€‚æœ‰çš„å¹³å°æœ‰æ–‡ä»¶è¯»å†™çš„æŽ¥å£ï¼Œæœ‰çš„æ²¡æœ‰ã€‚ä¸ºäº†é€šç”¨æ€§ï¼Œæˆ‘ä»¬é‡‡å–è§£åŽ‹åˆ°å†…å­˜ä¸­çš„æ–¹å¼ã€‚é€šè¿‡ jszipï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå¥½çš„åŽ‹ç¼©å’Œè§£åŽ‹æ–‡ä»¶ã€‚ Laya å¼•æ“Žä¸­æœ‰å¤šé‡ä¸åŒçš„æ–‡ä»¶æ ¼å¼ï¼Œè§£åŽ‹åŽ‹ç¼©æ–‡ä»¶åˆ°å†…å­˜ä¸­çš„æ—¶å€™å…¶å®žå°±æ˜¯è¯»å–æ–‡ä»¶å¹¶æ ¼å¼åŒ–ï¼Œç„¶åŽä¿å­˜åˆ° Laya çš„ç¼“å­˜ç³»ç»Ÿä¸­ï¼Œé€šè¿‡ç¼“å­˜è¯»å–æ–‡ä»¶çš„æ—¶å€™å°±èƒ½å¤Ÿç›´æŽ¥è¯»å–åˆ°æˆ‘ä»¬è§£åŽ‹åˆ°å†…å­˜ä¸­çš„å†…å®¹ã€‚ä¸è¿‡ï¼Œç”±äºŽæœºåˆ¶é—®é¢˜ï¼Œæš‚æ—¶è¿˜ä¸æ”¯æŒå¤©ç©ºç›’çš„æ ¼å¼åŒ–ï¼Œå› æ­¤å¤©ç©ºç›’ç›®å‰è¿˜åªèƒ½æ”¾åœ¨æœ¬åœ°ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337export default class ZipManager &#123; private static instance: ZipManager; public static getInstance(): ZipManager &#123; if (!this.instance) &#123; return new ZipManager(); &#125; return this.instance; &#125; public loadZip(resurl: string, cacheUrl: string, callback: Function): void &#123; var zip = Laya.loader.getRes(resurl); if (!zip) &#123; Laya.loader.load( [&#123; type: Laya.Loader.BUFFER, url: resurl &#125;], Laya.Handler.create(this, function (data) &#123; Laya.loader.cacheRes(cacheUrl, Laya.loader.getRes(resurl)); Laya.loader.clearRes(resurl); if (callback) &#123; callback(); &#125; &#125;) ); &#125; else &#123; callback(); &#125; &#125; public loadZipFiles( resUrl: string, cacheUrl: string, callback: Function ): void &#123; // console.log(&quot;0----------&quot;,Laya.Browser.window); var self = this; let skyBox; let jsZip = new JSZip(); let zipBuff = Laya.loader.getRes(resUrl); let resources = &#123;&#125;; // console.log(&quot;æµ‹è¯•åŽ‹ç¼©åŒ…&quot;); var loadZipComplete = function () &#123; Laya.loader.clearRes(resUrl); callback(); &#125;; //èŽ·å–ZIPåŒ…å†…å®¹ä¼ å…¥JSZipä¸­è§£æž jsZip.loadAsync(zipBuff).then((data) =&gt; &#123; //ä¿å­˜æ–‡ä»¶è·¯å¾„åˆ°æ•°ç»„ for (let file in data.files) &#123; // console.log(&quot;------------file&quot;, data.files[file]); if (!data.files[file].dir) &#123; if (file.indexOf(&quot;.lh&quot;) != -1) &#123; //å­˜å…¥æ¨¡åž‹æ–‡ä»¶ if (!resources[&quot;other&quot;]) &#123; resources[&quot;other&quot;] = []; &#125; resources[&quot;other&quot;].push(file); &#125; else if (file.indexOf(&quot;.png&quot;) != -1 || file.indexOf(&quot;.jpg&quot;) != -1) &#123; //å­˜å…¥å›¾ç‰‡ if (!resources[&quot;image&quot;]) &#123; resources[&quot;image&quot;] = []; &#125; resources[&quot;image&quot;].push(file); &#125; else if (file.indexOf(&quot;.json&quot;) != -1) &#123; //å­˜å…¥json if (!resources[&quot;other&quot;]) &#123; resources[&quot;other&quot;] = []; &#125; resources[&quot;other&quot;].push(file); &#125; else if (file.indexOf(&quot;.csv&quot;) != -1) &#123; //å­˜å…¥csv if (!resources[&quot;other&quot;]) &#123; resources[&quot;other&quot;] = []; &#125; resources[&quot;other&quot;].push(file); &#125; else if ( file.indexOf(&quot;.lm&quot;) != -1 || file.indexOf(&quot;.ltc&quot;) != -1 || file.indexOf(&quot;.lmat&quot;) != -1 || //å­˜å…¥ç½‘æ ¼ å¤©ç©ºç›’æè´¨è§£æžæ–‡ä»¶ æè´¨ file.indexOf(&quot;.lani&quot;) != -1 ) &#123; if (!resources[&quot;mat&quot;]) &#123; resources[&quot;mat&quot;] = []; &#125; if (file.indexOf(&quot;.ltc&quot;) != -1) &#123; let fileParts = file.split(&quot;/&quot;); let name = fileParts[fileParts.length - 1].replace(&quot;.ltc&quot;, &quot;&quot;); skyBox = name; &#125; resources[&quot;mat&quot;].push(file); &#125; else &#123; //å­˜å…¥å…¶ä»– if (!resources[&quot;other&quot;]) &#123; resources[&quot;other&quot;] = []; &#125; resources[&quot;other&quot;].push(file); &#125; &#125; &#125; loadImage(); &#125;); //æ ¼å¼åŒ–æ–‡ä»¶å¹¶å­˜å…¥ç¼“å­˜ let subCount = 0; let subTotal = 0; let loadImage = () =&gt; &#123; if (resources[&quot;image&quot;]) &#123; for (let key in resources[&quot;image&quot;]) &#123; subTotal++; let file = resources[&quot;image&quot;][key]; jsZip .file(file) .async(&quot;base64&quot;) .then((content: any) =&gt; &#123; let func = Laya.Loader.prototype[&quot;parsePLFData&quot;]; let data = &#123; json: &#123;&#125;, text: &#123;&#125; &#125;; let imgBase64; if (file.indexOf(&quot;.png&quot;) != -1) &#123; imgBase64 = &quot;data:image/png;base64,&quot; + content; &#125; else &#123; imgBase64 = &quot;data:image/jpg;base64,&quot; + content; &#125; let image: HTMLImageElement = document.createElement(&quot;img&quot;); let onImageLoaded: EventListenerOrEventListenerObject = () =&gt; &#123; image.removeEventListener(&quot;load&quot;, onImageLoaded); //æŽ¥ä¸‹æ¥å°±å¯ä»¥æŠŠè´´å›¾å¯¹è±¡èµ‹å€¼ç»™æè´¨äº† if (skyBox &amp;&amp; file.indexOf(skyBox) != -1) &#123; // skyBox = null; Laya.loader.cacheRes(cacheUrl + &quot;/&quot; + file, image); &#125; else &#123; let texture: Laya.Texture2D = new Laya.Texture2D(); texture.loadImageSource(image); Laya.loader.cacheRes(cacheUrl + &quot;/&quot; + file, texture); // console.log(&quot;å›¾ç‰‡çº¹ç†&quot;, Laya.loader.getRes(cacheUrl + &quot;/&quot; + file)); &#125; subCount++; if (subCount == subTotal) &#123; subCount = 0; subTotal = 0; loadLm(); &#125; &#125;; image.addEventListener(&quot;load&quot;, onImageLoaded); image.src = imgBase64; &#125;); &#125; &#125; else &#123; loadLm(); &#125; &#125;; let loadLm = () =&gt; &#123; if (resources[&quot;mat&quot;]) &#123; for (let key in resources[&quot;mat&quot;]) &#123; subTotal++; let file = resources[&quot;mat&quot;][key]; if (file.indexOf(&quot;.ltc&quot;) != -1) &#123; jsZip .file(file) .async(&quot;text&quot;) .then((content: any) =&gt; &#123; let contJson = JSON.parse(content); let func = Laya.Loader.prototype[&quot;parsePLFData&quot;]; let data = &#123; json: &#123;&#125;, text: &#123;&#125; &#125;; data.json[cacheUrl + &quot;/&quot; + file] = contJson; func.call(Laya.Loader, data); Laya.loader.create( cacheUrl + &quot;/&quot; + file, Laya.Handler.create(this, (res) =&gt; &#123; // console.log(&quot;é¢„åŠ è½½&quot;, res); subCount++; if (subCount == subTotal) &#123; subCount = 0; subTotal = 0; loadOther(); &#125; &#125;) ); &#125;); &#125; else if (file.indexOf(&quot;.lmat&quot;) != -1) &#123; jsZip .file(file) .async(&quot;text&quot;) .then((content: any) =&gt; &#123; let contJson = JSON.parse(content); let func = Laya.Loader.prototype[&quot;parsePLFData&quot;]; let data = &#123; json: &#123;&#125;, text: &#123;&#125; &#125;; data.json[cacheUrl + &quot;/&quot; + file] = contJson; func.call(Laya.Loader, data); Laya.loader.create( cacheUrl + &quot;/&quot; + file, Laya.Handler.create(this, (res) =&gt; &#123; // console.log(&quot;é¢„åŠ è½½&quot;,file, rses); subCount++; if (subCount == subTotal) &#123; subCount = 0; subTotal = 0; loadOther(); &#125; &#125;) ); &#125;); &#125; else &#123; jsZip .file(file) .async(&quot;uint8array&quot;) .then((content: any) =&gt; &#123; let func = Laya.Loader.prototype[&quot;parsePLFData&quot;]; let data = &#123; json: &#123;&#125;, text: &#123;&#125; &#125;; data.json[cacheUrl + &quot;/&quot; + file] = content; func.call(Laya.Loader, data); Laya.loader.create( cacheUrl + &quot;/&quot; + file, Laya.Handler.create(this, (res) =&gt; &#123; // console.log(&quot;é¢„åŠ è½½&quot;, res); subCount++; if (subCount == subTotal) &#123; subCount = 0; subTotal = 0; loadOther(); &#125; &#125;) ); &#125;); &#125; &#125; &#125; else &#123; loadOther(); &#125; &#125;; let loadOther = () =&gt; &#123; for (let key in resources[&quot;other&quot;]) &#123; subTotal++; let file = resources[&quot;other&quot;][key]; if (file.indexOf(&quot;.lh&quot;) != -1) &#123; jsZip .file(file) .async(&quot;text&quot;) .then((content: any) =&gt; &#123; let contJson = JSON.parse(content); let func = Laya.Loader.prototype[&quot;parsePLFData&quot;]; let data = &#123; json: &#123;&#125;, text: &#123;&#125; &#125;; data.json[cacheUrl + &quot;/&quot; + file] = contJson; func.call(Laya.Loader, data); Laya.loader.create( cacheUrl + &quot;/&quot; + file, Laya.Handler.create(this, (res) =&gt; &#123; // console.log(&quot;é¢„åŠ è½½&quot;,file, res); subCount++; if (subCount == subTotal) &#123; loadZipComplete(); &#125; &#125;) ); &#125;); &#125; else if (file.indexOf(&quot;.json&quot;) != -1) &#123; jsZip .file(file) .async(&quot;text&quot;) .then((content: any) =&gt; &#123; let contJson = JSON.parse(content); let func = Laya.Loader.prototype[&quot;parsePLFData&quot;]; let data = &#123; json: &#123;&#125;, text: &#123;&#125; &#125;; data.json[cacheUrl + &quot;/&quot; + file] = contJson; func.call(Laya.Loader, data); Laya.loader.create( cacheUrl + &quot;/&quot; + file, Laya.Handler.create(this, (res) =&gt; &#123; // console.log(&quot;é¢„åŠ è½½&quot;, res); subCount++; if (subCount == subTotal) &#123; loadZipComplete(); &#125; &#125;) ); &#125;); &#125; else if (file.indexOf(&quot;.csv&quot;) != -1) &#123; jsZip .file(file) .async(&quot;text&quot;) .then((content: any) =&gt; &#123; Laya.loader.cacheRes(cacheUrl + &quot;/&quot; + file, content); subCount++; if (subCount == subTotal) &#123; loadZipComplete(); &#125; &#125;); &#125; else &#123; jsZip .file(file) .async(&quot;uint8array&quot;) .then((content: any) =&gt; &#123; let func = Laya.Loader.prototype[&quot;parsePLFData&quot;]; let data = &#123; json: &#123;&#125;, text: &#123;&#125; &#125;; data.json[cacheUrl + &quot;/&quot; + file] = content; func.call(Laya.Loader, data); Laya.loader.create( cacheUrl + &quot;/&quot; + file, Laya.Handler.create(this, (res) =&gt; &#123; // console.log(&quot;é¢„åŠ è½½&quot;, res); subCount++; if (subCount == subTotal) &#123; loadZipComplete(); &#125; &#125;) ); &#125;); &#125; &#125; &#125;; &#125;&#125;","categories":[{"name":"Laya","slug":"Laya","permalink":"https://busyogg.github.io/categories/Laya/"},{"name":"å·¥å…·","slug":"Laya/å·¥å…·","permalink":"https://busyogg.github.io/categories/Laya/%E5%B7%A5%E5%85%B7/"}],"tags":[{"name":"Laya","slug":"Laya","permalink":"https://busyogg.github.io/tags/Laya/"},{"name":"å·¥å…·ç±»","slug":"å·¥å…·ç±»","permalink":"https://busyogg.github.io/tags/%E5%B7%A5%E5%85%B7%E7%B1%BB/"},{"name":"Typescript","slug":"Typescript","permalink":"https://busyogg.github.io/tags/Typescript/"},{"name":"Jszip","slug":"Jszip","permalink":"https://busyogg.github.io/tags/Jszip/"}]},{"title":"Layaè¿›åº¦æ¡shader","slug":"Layaè¿›åº¦æ¡shader","date":"2023-08-23T13:17:56.000Z","updated":"2024-05-18T15:37:46.314Z","comments":true,"path":"article/23513e7655b5/","link":"","permalink":"https://busyogg.github.io/article/23513e7655b5/","excerpt":"","text":"åŽŸç† æ ¹æ®ä¼ å…¥çš„è¿›åº¦[0,1]å‰”é™¤å¯¹åº”é¢œè‰²å€¼ RGB ä¹‹ä¸€çš„åƒç´ ï¼Œä¸Šå›¾ä¸ºè¿›åº¦æ¡æ‰€éœ€çš„ä»Žé¢œè‰²å€¼ 0 åˆ°é¢œè‰²å€¼ 1 çš„è´´å›¾ï¼ˆé€æ˜Žåº•å›¾ï¼Œè¿›åº¦æ¡çš„åœˆä¸ºä»Žç™½åˆ°é»‘çš„ä¸é€æ˜Žåœ†çŽ¯ï¼‰ã€‚ æ­¤ä»£ç è´Ÿè´£å‰”é™¤ä¸€å®šé¢œè‰²å€¼çš„åƒç´ ï¼Œåˆ©ç”¨ step å‡½æ•°çš„åŽŸç†ï¼ˆstep(a,b)ï¼Œå½“ b&gt;&#x3D;a æ—¶è¿”å›ž 1ï¼Œå¦åˆ™è¿”å›ž 0ï¼‰ï¼Œå…¶ä¸­ 1.0-col.r å†³å®šè¿›åº¦æ¡åŠ¨ç”»çš„æ–¹å‘ï¼Œä»£è¡¨ä»Žç™½å‘é»‘ï¼Œä¹Ÿå¯ä»¥ç›´æŽ¥ä½¿ç”¨ col.r ä»Žé»‘å‘ç™½ã€‚ 1float colorMinus = step(1.0-col.r,u_progress); è¿™æ®µä»£ç åŒ…æ‹¬ä¸¤ä¸ªéƒ¨åˆ†ï¼Œå‰é¢çš„éƒ¨åˆ†å†³å®šè¿›åº¦æ¡çš„é¢œè‰²ï¼ŒåŽé¢çš„éƒ¨åˆ†å†³å®šèƒŒæ™¯çš„é¢œè‰²ï¼Œæˆ‘ä»¬å¯ä»¥ä»ŽåŠ å·çš„åœ°æ–¹æ‹†å¼€æ¥çœ‹ã€‚å‰é¢çš„éƒ¨åˆ†æž„é€ äº†ä¸€ä¸ªä¸‰ç»´å‘é‡ï¼Œå‡å¦‚ colorMinus ä¸º 1ï¼Œåˆ™å‰é¢çš„å‘é‡å°±æ˜¯å…¨ 1ï¼Œæ­¤æ—¶å’Œä¼ å…¥çš„è¿›åº¦æ¡é¢œè‰²å€¼ç›¸ä¹˜å¯å¾—è¿›åº¦æ¡çš„é¢œè‰²ã€‚åŽé¢æž„é€ äº†ä¸€ä¸ªå’Œå‰é¢ç›¸åçš„ä¸‰ç»´å‘é‡ï¼Œæ­¤æ—¶åŽé¢çš„å‘é‡ä¸ºå…¨ 0ï¼Œå’Œä¼ å…¥çš„èƒŒæ™¯é¢œè‰²ç›¸ä¹˜ä¾ç„¶æ˜¯ 0ã€‚ ç”±æ­¤å¯å¾—ï¼Œå½“æ­¤å¤„çš„åƒç´ ç­›é€‰ä¸ºè¿›åº¦æ¡çš„æ—¶å€™ï¼Œè¿›åº¦æ¡çš„é¢œè‰²å€¼å‘æŒ¥ä½œç”¨ï¼Œè€ŒèƒŒæ™¯é¢œè‰²å€¼ä¸å‘æŒ¥ä½œç”¨ï¼›ç›¸åï¼Œæ­¤å¤„åƒç´ ç­›é€‰ä¸ºèƒŒæ™¯æ—¶ï¼Œè¿›åº¦æ¡é¢œè‰²å€¼ä¸å‘æŒ¥ä½œç”¨è€ŒèƒŒæ™¯é¢œè‰²å€¼å‘æŒ¥ä½œç”¨ã€‚ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢ï¼Œå› ä¸º GPU è¿ç®—çš„æ—¶å€™æ˜¯å¤§é‡å¹¶è¡Œçš„ï¼Œæ¡ä»¶åˆ¤æ–­è¯­å¥å¯¹äºŽ GPU æ¥è¯´æ¯ä¸ªåˆ†æ”¯éƒ½è¦æ‰§è¡Œï¼Œæ€§èƒ½ä¼šæœ‰æŸå¤±ã€‚ 12vec4 final = vec4(colorMinus);final.xyz = vec3(colorMinus) * u_edgeColor.xyz + vec3(1.0-colorMinus) * u_bgColor.xyz; åªæœ‰ä¸Šè¿°ä»£ç çš„è¯ï¼Œè¿è¡Œæ—¶çš„æ•ˆæžœå¹¶ä¸èƒ½ç¬¦åˆæˆ‘ä»¬çš„éœ€è¦ï¼Œè¿›åº¦æ¡ä¹‹å¤–çš„åƒç´ ä¹Ÿä¼šæœ‰å¡«å……ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦å¯¹é€æ˜Žåº¦è¿›è¡Œå‰”é™¤ã€‚ 1final.a = (step(1.0-col.a,0.0) * colorMinus * u_edgeColor.a) + step(colorMinus,0.0) * u_bgColor.a; ç”±äºŽæˆ‘ä»¬æ”¯æŒè‡ªå®šä¹‰è¿›åº¦æ¡å’Œè¿›åº¦æ¡èƒŒæ™¯çš„é€æ˜Žåº¦ï¼Œå› æ­¤è¿™ä¸¤ä¸ªéƒ¨åˆ†ä¹Ÿéœ€è¦è¿›è¡Œå¤„ç†ã€‚ å…³äºŽè¿›åº¦æ¡çš„é€æ˜Žåº¦ï¼Œèµ·åˆ¤æ–­çš„éƒ¨åˆ†åªæœ‰ colorMinus * u_edgeColor.aã€‚ä¸ºä»€ä¹ˆè¦ä¹˜ä¸Š step(1.0-col.a,0.0)å‘¢ï¼Œä¸»è¦æ˜¯ä¸ºäº†ç­›åŽ»é€æ˜Žçš„éƒ¨åˆ†ï¼Œcol.a æ˜¯åŽŸæè´¨è´´å›¾çš„é€æ˜Žåº¦ï¼Œå½“å…¶ä¸º 1 çš„æ—¶å€™ï¼ˆä¸é€æ˜Žï¼‰æ‰€å¾—å€¼ä¸º 0ï¼Œstep(1.0-col.a,0.0)çš„å€¼æ‰ä¸º 1ï¼Œè¿›åº¦æ¡çš„é¢œè‰²æ‰ç”Ÿæ•ˆã€‚å½“ç„¶è¿™é‡Œå¯ä»¥è®¾ç½®ä¸ºä½ æ‰€éœ€è¦çš„ä»»æ„å€¼ã€‚ å…³äºŽèƒŒæ™¯çš„é€æ˜Žåº¦ï¼Œå’Œè¿›åº¦æ¡åŒç†å¯å¾— step(colorMinus,0.0) * u_bgColor.aã€‚ è¿›åº¦æ¡ shader ä»£ç ç‰‡å…ƒç€è‰²å™¨12345678910111213141516171819202122#ifdef FSHIGHPRECISION precision highp float;#else precision mediump float;#endifuniform sampler2D u_DiffuseTexture;uniform float u_progress;uniform vec4 u_edgeColor;uniform vec4 u_bgColor;varying vec2 v_Texcoord0;void main()&#123; vec4 col = texture2D(u_DiffuseTexture, v_Texcoord0); float colorMinus = step(1.0-col.r,u_progress); vec4 final = vec4(colorMinus); final.xyz = vec3(colorMinus) * u_edgeColor.xyz + vec3(1.0-colorMinus) * u_bgColor.xyz; final.a = (step(1.0-col.a,0.0) * colorMinus * u_edgeColor.a) + step(colorMinus,0.0) * u_bgColor.a; gl_FragColor = final;&#125; é¡¶ç‚¹ç€è‰²å™¨1234567891011121314#include &quot;Lighting.glsl&quot;;attribute vec4 a_Position;attribute vec2 a_Texcoord0;varying vec2 v_Texcoord0;uniform mat4 u_MvpMatrix;uniform vec4 u_TilingOffset;void main()&#123; v_Texcoord0=TransformUV(a_Texcoord0,u_TilingOffset); gl_Position=remapGLPositionZ(gl_Position);&#125;","categories":[{"name":"Laya","slug":"Laya","permalink":"https://busyogg.github.io/categories/Laya/"},{"name":"Shader","slug":"Laya/Shader","permalink":"https://busyogg.github.io/categories/Laya/Shader/"}],"tags":[{"name":"Laya","slug":"Laya","permalink":"https://busyogg.github.io/tags/Laya/"},{"name":"Shader","slug":"Shader","permalink":"https://busyogg.github.io/tags/Shader/"},{"name":"Opengl","slug":"Opengl","permalink":"https://busyogg.github.io/tags/Opengl/"}]},{"title":"å…³äºŽLaya 2.13ç‰ˆæœ¬ ç²’å­ç‰¹æ•ˆå†…å­˜æ³„æ¼é—®é¢˜","slug":"å…³äºŽLaya-2-13ç‰ˆæœ¬-ç²’å­ç‰¹æ•ˆå†…å­˜æ³„æ¼é—®é¢˜","date":"2023-08-23T13:17:56.000Z","updated":"2024-05-18T15:40:13.707Z","comments":true,"path":"article/07675fbaf5d8/","link":"","permalink":"https://busyogg.github.io/article/07675fbaf5d8/","excerpt":"","text":"è¯¥ç‰ˆæœ¬çš„ç²’å­æœ‰ä¸¤ç±»ï¼Œæ”¯æŒ GPUInstance çš„ ShurikenParticleInstance å’Œ ShurikenParticleï¼Œå‰è€…åœ¨ä¸åœåˆ›å»ºé”€æ¯çš„è¿‡ç¨‹ä¸­åœ¨ç»Ÿè®¡é¢æ¿ä¸Šä¼šç´¯è®¡å†…å­˜å¢žé•¿ï¼Œçœ‹ä¸ŠåŽ»å’Œå†…å­˜æ³„æ¼ä¸€æ ·ã€‚å…¶åŽŸå› ä¸ºé”€æ¯å¯¹è±¡çš„æ—¶å€™æ²¡æœ‰å¯¹_instanceParticleVertexBuffer å¯¹è±¡è¿›è¡Œå†…å­˜ç»Ÿè®¡ã€‚ è§£å†³æ–¹æ¡ˆ åœ¨ destroy()æ–¹æ³•ä¸­é’ˆå¯¹_instanceParticleVertexBuffer æ”¹ä¸ºå¦‚ä¸‹å†…å®¹ 123456if (this._instanceParticleVertexBuffer) &#123; var memorySize = this._instanceParticleVertexBuffer._byteLength; Laya.Resource._addMemory(-memorySize, -memorySize); this._instanceParticleVertexBuffer.destroy(); this._instanceParticleVertexBuffer = null;&#125;","categories":[{"name":"Laya","slug":"Laya","permalink":"https://busyogg.github.io/categories/Laya/"},{"name":"Bug","slug":"Laya/Bug","permalink":"https://busyogg.github.io/categories/Laya/Bug/"}],"tags":[{"name":"Laya","slug":"Laya","permalink":"https://busyogg.github.io/tags/Laya/"},{"name":"Bug","slug":"Bug","permalink":"https://busyogg.github.io/tags/Bug/"}]}],"categories":[{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/categories/Unity/"},{"name":"ç¼–è¾‘å™¨","slug":"Unity/ç¼–è¾‘å™¨","permalink":"https://busyogg.github.io/categories/Unity/%E7%BC%96%E8%BE%91%E5%99%A8/"},{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://busyogg.github.io/categories/%E7%AE%97%E6%B3%95/"},{"name":"ç¢°æ’žæ£€æµ‹","slug":"ç®—æ³•/ç¢°æ’žæ£€æµ‹","permalink":"https://busyogg.github.io/categories/%E7%AE%97%E6%B3%95/%E7%A2%B0%E6%92%9E%E6%A3%80%E6%B5%8B/"},{"name":"åˆ†äº«","slug":"åˆ†äº«","permalink":"https://busyogg.github.io/categories/%E5%88%86%E4%BA%AB/"},{"name":"Shader","slug":"Unity/Shader","permalink":"https://busyogg.github.io/categories/Unity/Shader/"},{"name":"æ•™ç¨‹","slug":"æ•™ç¨‹","permalink":"https://busyogg.github.io/categories/%E6%95%99%E7%A8%8B/"},{"name":"è§£å†³æ–¹æ¡ˆ","slug":"Unity/è§£å†³æ–¹æ¡ˆ","permalink":"https://busyogg.github.io/categories/Unity/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"},{"name":"å·¥å…·","slug":"Unity/å·¥å…·","permalink":"https://busyogg.github.io/categories/Unity/%E5%B7%A5%E5%85%B7/"},{"name":"è®¾è®¡æ€è·¯","slug":"è®¾è®¡æ€è·¯","permalink":"https://busyogg.github.io/categories/%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF/"},{"name":"Laya","slug":"Laya","permalink":"https://busyogg.github.io/categories/Laya/"},{"name":"å·¥å…·","slug":"Laya/å·¥å…·","permalink":"https://busyogg.github.io/categories/Laya/%E5%B7%A5%E5%85%B7/"},{"name":"é€†å‘è¿åŠ¨å­¦","slug":"ç®—æ³•/é€†å‘è¿åŠ¨å­¦","permalink":"https://busyogg.github.io/categories/%E7%AE%97%E6%B3%95/%E9%80%86%E5%90%91%E8%BF%90%E5%8A%A8%E5%AD%A6/"},{"name":"Hexo","slug":"æ•™ç¨‹/Hexo","permalink":"https://busyogg.github.io/categories/%E6%95%99%E7%A8%8B/Hexo/"},{"name":"è§£å†³æ–¹æ¡ˆ","slug":"Laya/è§£å†³æ–¹æ¡ˆ","permalink":"https://busyogg.github.io/categories/Laya/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"},{"name":"Bug","slug":"Laya/Bug","permalink":"https://busyogg.github.io/categories/Laya/Bug/"},{"name":"Shader","slug":"Laya/Shader","permalink":"https://busyogg.github.io/categories/Laya/Shader/"}],"tags":[{"name":"C#","slug":"C","permalink":"https://busyogg.github.io/tags/C/"},{"name":"Unity","slug":"Unity","permalink":"https://busyogg.github.io/tags/Unity/"},{"name":"ç¼–è¾‘å™¨","slug":"ç¼–è¾‘å™¨","permalink":"https://busyogg.github.io/tags/%E7%BC%96%E8%BE%91%E5%99%A8/"},{"name":"æ¡†æž¶","slug":"æ¡†æž¶","permalink":"https://busyogg.github.io/tags/%E6%A1%86%E6%9E%B6/"},{"name":"VisualElement","slug":"VisualElement","permalink":"https://busyogg.github.io/tags/VisualElement/"},{"name":"ç®—æ³•","slug":"ç®—æ³•","permalink":"https://busyogg.github.io/tags/%E7%AE%97%E6%B3%95/"},{"name":"ç¢°æ’žæ£€æµ‹","slug":"ç¢°æ’žæ£€æµ‹","permalink":"https://busyogg.github.io/tags/%E7%A2%B0%E6%92%9E%E6%A3%80%E6%B5%8B/"},{"name":"çº¿æ®µ","slug":"çº¿æ®µ","permalink":"https://busyogg.github.io/tags/%E7%BA%BF%E6%AE%B5/"},{"name":"GraphView","slug":"GraphView","permalink":"https://busyogg.github.io/tags/GraphView/"},{"name":"è„šæœ¬","slug":"è„šæœ¬","permalink":"https://busyogg.github.io/tags/%E8%84%9A%E6%9C%AC/"},{"name":"ffmpeg","slug":"ffmpeg","permalink":"https://busyogg.github.io/tags/ffmpeg/"},{"name":"Shader","slug":"Shader","permalink":"https://busyogg.github.io/tags/Shader/"},{"name":"æ•™ç¨‹","slug":"æ•™ç¨‹","permalink":"https://busyogg.github.io/tags/%E6%95%99%E7%A8%8B/"},{"name":"Cloudflare","slug":"Cloudflare","permalink":"https://busyogg.github.io/tags/Cloudflare/"},{"name":"IMGUI","slug":"IMGUI","permalink":"https://busyogg.github.io/tags/IMGUI/"},{"name":"Untiy","slug":"Untiy","permalink":"https://busyogg.github.io/tags/Untiy/"},{"name":"åºåˆ—åŒ–","slug":"åºåˆ—åŒ–","permalink":"https://busyogg.github.io/tags/%E5%BA%8F%E5%88%97%E5%8C%96/"},{"name":"å­—å…¸","slug":"å­—å…¸","permalink":"https://busyogg.github.io/tags/%E5%AD%97%E5%85%B8/"},{"name":"å·¥å…·ç±»","slug":"å·¥å…·ç±»","permalink":"https://busyogg.github.io/tags/%E5%B7%A5%E5%85%B7%E7%B1%BB/"},{"name":"ç³»ç»Ÿæž¶æž„","slug":"ç³»ç»Ÿæž¶æž„","permalink":"https://busyogg.github.io/tags/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/"},{"name":"èƒ¶å›Šä½“","slug":"èƒ¶å›Šä½“","permalink":"https://busyogg.github.io/tags/%E8%83%B6%E5%9B%8A%E4%BD%93/"},{"name":"UI","slug":"UI","permalink":"https://busyogg.github.io/tags/UI/"},{"name":"åå°„","slug":"åå°„","permalink":"https://busyogg.github.io/tags/%E5%8F%8D%E5%B0%84/"},{"name":"ç‰¹æ€§","slug":"ç‰¹æ€§","permalink":"https://busyogg.github.io/tags/%E7%89%B9%E6%80%A7/"},{"name":"Attribute","slug":"Attribute","permalink":"https://busyogg.github.io/tags/Attribute/"},{"name":"å¯¹è±¡å­˜å‚¨","slug":"å¯¹è±¡å­˜å‚¨","permalink":"https://busyogg.github.io/tags/%E5%AF%B9%E8%B1%A1%E5%AD%98%E5%82%A8/"},{"name":"OSS","slug":"OSS","permalink":"https://busyogg.github.io/tags/OSS/"},{"name":"å®šç‚¹æ•°","slug":"å®šç‚¹æ•°","permalink":"https://busyogg.github.io/tags/%E5%AE%9A%E7%82%B9%E6%95%B0/"},{"name":"ç¡®å®šæ€§","slug":"ç¡®å®šæ€§","permalink":"https://busyogg.github.io/tags/%E7%A1%AE%E5%AE%9A%E6%80%A7/"},{"name":"è§£å†³æ–¹æ¡ˆ","slug":"è§£å†³æ–¹æ¡ˆ","permalink":"https://busyogg.github.io/tags/%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"},{"name":"æ¸²æŸ“","slug":"æ¸²æŸ“","permalink":"https://busyogg.github.io/tags/%E6%B8%B2%E6%9F%93/"},{"name":"ç‰©ç†","slug":"ç‰©ç†","permalink":"https://busyogg.github.io/tags/%E7%89%A9%E7%90%86/"},{"name":"å†…ç½‘ç©¿é€","slug":"å†…ç½‘ç©¿é€","permalink":"https://busyogg.github.io/tags/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/"},{"name":"æœåŠ¡å™¨","slug":"æœåŠ¡å™¨","permalink":"https://busyogg.github.io/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8/"},{"name":"FRP","slug":"FRP","permalink":"https://busyogg.github.io/tags/FRP/"},{"name":"ChatGPT","slug":"ChatGPT","permalink":"https://busyogg.github.io/tags/ChatGPT/"},{"name":"Laya","slug":"Laya","permalink":"https://busyogg.github.io/tags/Laya/"},{"name":"Typescript","slug":"Typescript","permalink":"https://busyogg.github.io/tags/Typescript/"},{"name":"IK","slug":"IK","permalink":"https://busyogg.github.io/tags/IK/"},{"name":"Fabrik","slug":"Fabrik","permalink":"https://busyogg.github.io/tags/Fabrik/"},{"name":"OBB","slug":"OBB","permalink":"https://busyogg.github.io/tags/OBB/"},{"name":"AABB","slug":"AABB","permalink":"https://busyogg.github.io/tags/AABB/"},{"name":"å°„çº¿","slug":"å°„çº¿","permalink":"https://busyogg.github.io/tags/%E5%B0%84%E7%BA%BF/"},{"name":"åœ†","slug":"åœ†","permalink":"https://busyogg.github.io/tags/%E5%9C%86/"},{"name":"SATåˆ†ç¦»è½´","slug":"SATåˆ†ç¦»è½´","permalink":"https://busyogg.github.io/tags/SAT%E5%88%86%E7%A6%BB%E8%BD%B4/"},{"name":"å·¥å…·","slug":"å·¥å…·","permalink":"https://busyogg.github.io/tags/%E5%B7%A5%E5%85%B7/"},{"name":"ECS","slug":"ECS","permalink":"https://busyogg.github.io/tags/ECS/"},{"name":"å››å‰æ ‘","slug":"å››å‰æ ‘","permalink":"https://busyogg.github.io/tags/%E5%9B%9B%E5%8F%89%E6%A0%91/"},{"name":"ç©ºé—´ç®¡ç†","slug":"ç©ºé—´ç®¡ç†","permalink":"https://busyogg.github.io/tags/%E7%A9%BA%E9%97%B4%E7%AE%A1%E7%90%86/"},{"name":"SSLè¯ä¹¦","slug":"SSLè¯ä¹¦","permalink":"https://busyogg.github.io/tags/SSL%E8%AF%81%E4%B9%A6/"},{"name":"GitHub","slug":"GitHub","permalink":"https://busyogg.github.io/tags/GitHub/"},{"name":"ç½‘ç»œåŠ é€Ÿ","slug":"ç½‘ç»œåŠ é€Ÿ","permalink":"https://busyogg.github.io/tags/%E7%BD%91%E7%BB%9C%E5%8A%A0%E9%80%9F/"},{"name":"Hexo","slug":"Hexo","permalink":"https://busyogg.github.io/tags/Hexo/"},{"name":"å¾®ä¿¡å¼€æ”¾åŸŸ","slug":"å¾®ä¿¡å¼€æ”¾åŸŸ","permalink":"https://busyogg.github.io/tags/%E5%BE%AE%E4%BF%A1%E5%BC%80%E6%94%BE%E5%9F%9F/"},{"name":"Bug","slug":"Bug","permalink":"https://busyogg.github.io/tags/Bug/"},{"name":"Jszip","slug":"Jszip","permalink":"https://busyogg.github.io/tags/Jszip/"},{"name":"Opengl","slug":"Opengl","permalink":"https://busyogg.github.io/tags/Opengl/"}]}